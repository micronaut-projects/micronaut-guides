<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'/>
    <title>Kubernetes service discovery and distributed configuration</title>
    <link rel='stylesheet' id='wp-block-library-css' href='https://micronaut.io/wp-includes/css/dist/block-library/style.min.css' type='text/css' media='all'/>
    <link rel='stylesheet' id='fonts-fira-sans-css' href='https://fonts.googleapis.com/css2?family=Fira+Sans%3Awght%40300%3B500&#038;display=swap&#038;ver=5.7' type='text/css' media='all'/>
    <link rel='stylesheet' id='micronaut-style-css' href='https://micronaut.io/wp-content/themes/micronaut/style.min.css' type='text/css' media='all'/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link rel="shortcut icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link href="coderay.css" rel="stylesheet" />
    <link href="guide.css" rel="stylesheet" />
    <script src="guide.js"></script>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://guides.micronaut.io/latest/images/cards/micronaut-k8s.png"/>
    <meta name="twitter:creator" content="@micronautfw"/>
    <meta name="twitter:site" content="@micronautfw"/>
    <meta name="twitter:title" content="Kubernetes service discovery and distributed configuration"/>
    <meta name="twitter:description" content="How to use Kubernetes service discovery and distributed configuration in a Micronaut application"/>
</head>
<body class="page-template page-template-page-sidebar page-template-page-sidebar-php page page-parent guide">

<header id="header">

    <div class="container">

        <nav class="navbar navbar-expand-lg navbar-dark">

            <button class="collapsed" type="button" data-toggle="collapse" data-target="#nav" aria-expanded="false">
                <span></span>
            </button>

            <a class="navbar-brand" href="https://micronaut.io">
                <img src="https://micronaut.io/wp-content/uploads/2020/11/MIcronautLogo_Horizontal.svg" alt="Micronaut framework"/>
            </a>

            <div class="collapse navbar-collapse" id="nav">

                <ul class="navbar-nav ml-auto">

                    <li id="menu-item-2865" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2865 nav-item">
                        <a href="https://micronaut.io/download/" class="nav-link">Download</a>
                    </li>
                    <li id="menu-item-2868" class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-22 current_page_item current-menu-ancestor current-menu-parent current_page_parent current_page_ancestor menu-item-has-children menu-item-2872 active dropdown nav-item">
                        <a href="./index.html" class="nav-link dropdown-toggle" data-toggle="dropdown">Learn</a>
                        <ul class="dropdown-menu">
                            <li id="menu-item-2869" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2869">
                                <a href="https://micronaut.io/docs/" class="dropdown-item">User Documentation</a>
                            </li>
                            <li id="menu-item-2870" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2870">
                                <a href="./index.html" class="dropdown-item">Guides</a>
                            </li>
                            <li id="menu-item-2896" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2896">
                                <a href="https://micronaut.io/category/microcast/" class="dropdown-item">Microcasts</a>
                            </li>
                            <li id="menu-item-2897" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2897">
                                <a href="https://micronaut.io/category/webinar/" class="dropdown-item">Webinars</a>
                            </li>
                            <li id="menu-item-2871" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2871">
                                <a href="https://micronaut.io/professional-training/" class="dropdown-item">Professional Training</a>
                            </li>
                        </ul>
                    </li>
                    <li id="menu-item-2878" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2878 dropdown nav-item">
                        <a href="https://micronaut.io/blog/" class="nav-link dropdown-toggle" data-toggle="dropdown">Resources</a>
                        <ul class="dropdown-menu">
                            <li id="menu-item-2879" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2879">
                                <a href="https://micronaut.io/blog/" class="dropdown-item">Blog</a>
                            </li>
                            <li id="menu-item-2881" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2881">
                                <a href="https://micronaut.io/events/" class="dropdown-item">Upcoming Events</a>
                            </li>
                            <li id="menu-item-2880" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2880">
                                <a href="https://micronaut.io/commercial-support/" class="dropdown-item">Commercial Support</a>
                            </li>
                            <li id="menu-item-2882" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2882">
                                <a href="https://micronaut.io/faq/" class="dropdown-item">FAQ</a>
                            </li>
                            <li id="menu-item-2883" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2883">
                                <a href="https://micronaut.io/contact/" class="dropdown-item">Contact</a>
                            </li>
                        </ul>
                    </li>
                    <li id="menu-item-2872" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2878 dropdown nav-item">
                        <a href="https://micronaut.io/foundation/" aria-current="page" class="nav-link dropdown-toggle" data-toggle="dropdown">Foundation</a>
                        <ul class="dropdown-menu">
                            <li id="menu-item-2877" class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-22 current_page_item menu-item-2877 active">
                                <a href="https://micronaut.io/foundation/" aria-current="page" class="dropdown-item">Overview</a>
                            </li>
                            <li id="menu-item-2874" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2874">
                                <a href="https://micronaut.io/foundation/corporate-sponsorship/" class="dropdown-item">Corporate Sponsorship</a>
                            </li>
                            <li id="menu-item-2873" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2873">
                                <a href="https://micronaut.io/foundation/community-sponsorship/" class="dropdown-item">Community Sponsorship</a>
                            </li>
                            <li id="menu-item-2876" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2876">
                                <a href="https://micronaut.io/foundation/sponsors/" class="dropdown-item">Sponsors</a>
                            </li>
                        </ul>
                    </li>
                    <li id="menu-item-2884" class="action menu-item menu-item-type-custom menu-item-object-custom menu-item-2884 nav-item">
                        <a target="_blank" rel="noopener" href="https://micronaut.io/launch/" class="nav-link">Launch</a>
                    </li>
                </ul>
            </div>

        </nav>

    </div>
</header>
<div id="breadcrumbs"><div class="container"><a href="https://micronaut.io/">Home</a> » <a href="./index.html">Guides</a> » <a href="micronaut-k8s.html">Kubernetes service discovery and distributed configuration</a> » <span class="breadcrumb_last" aria-current="page">gradle | java</span></div></div><!-- .breadcrumbs -->
<main id="main">
    <div class="container">
        <div class="row">
            <div class="col-md-4">

                <div class="toc">
                    <div class="inner">
                        <h1 class="title title_large first-word-bold first-word-break">Table of Contents</h1>
                        <div class="underline"></div>
                        
<ul class="sectlevel1">
<li><a href="#getting-started">1. Getting Started</a></li>
<li><a href="#what-you-will-need">2. What you will need</a></li>
<li><a href="#solution">3. Solution</a></li>
<li><a href="#writing-the-apps">4. Writing the Apps</a>
<ul class="sectlevel2">
<li><a href="#users-microservice">4.1. Users Microservice</a></li>
<li><a href="#orders-microservice">4.2. Orders Microservice</a></li>
<li><a href="#api-gateway-microservice">4.3. API (Gateway) Microservice</a></li>
<li><a href="#test-integration-between-applications">4.4. Test integration between applications</a></li>
</ul>
</li>
<li><a href="#kubernetes-and-the-micronaut-framework">5. Kubernetes and the Micronaut framework</a>
<ul class="sectlevel2">
<li><a href="#users-microservice-2">5.1. Users Microservice</a></li>
<li><a href="#orders-microservice-2">5.2. Orders Microservice</a></li>
<li><a href="#api-gateway-microservice-2">5.3. API (Gateway) Microservice</a></li>
<li><a href="#test-integration-between-applications-deployed-on-kubernetes">5.4. Test integration between applications deployed on Kubernetes</a></li>
</ul>
</li>
<li><a href="#cleaning-up">6. Cleaning Up</a></li>
<li><a href="#next-steps">7. Next steps</a></li>
</ul>

                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <h1>Kubernetes service discovery and distributed configuration</h1>
                <div class="underline"></div>
<div class="sect1">
<div class="sectionbody">

<div class="paragraph">
<p>How to use Kubernetes service discovery and distributed configuration in a Micronaut application</p>
</div>
<div class="paragraph">
<p>Authors: Nemanja Mikic</p>
</div>
<div class="paragraph">
<p>Micronaut Version: 3.9.2</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started">1. Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this guide, we will create three microservices, build containerized versions and deploy them with <a href="https://kubernetes.io/">Kubernetes</a>. We will use Kubernetes Service discovery and Distributed configuration to wire up our microservices.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Kubernetes is a portable, extensible, open source platform for managing containerized workloads and services, that facilitates both declarative configuration and automation. It has a large, rapidly growing ecosystem. Kubernetes services, support, and tools are widely available.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>You will discover how the Micronaut framework eases Kubernetes integration.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-you-will-need">2. What you will need</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 17 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
<li>
<p><a href="https://www.docker.io/gettingstarted/#h_installation">Docker</a>.</p>
</li>
<li>
<p>Local Kubernetes cluster. We will use <a href="https://minikube.sigs.k8s.io/docs/">Minikube</a> in this guide.</p>
</li>
</ul>
</div>
</div>
</div>
</div></div><div class="row"><div class="col-md-12"><div class="sect1">
<h2 id="solution">3. Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create the application step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="micronaut-k8s-gradle-java.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-the-apps">4. Writing the Apps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s describe the microservices you will build through the guide.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>users</code> - This microservice contains customers data that can place orders on items, also a new customer can be created. Microservice requires Basic authentication to access it.</p>
</li>
<li>
<p><code>orders</code> - This microservice contains all orders that customers have created as well as available items that customers can order. Also this microservice enables the creation of new orders. Microservice requires Basic authentication to access it.</p>
</li>
<li>
<p><code>api</code> - This microservice acts as a gateway to the <code>orders</code> and <code>users</code> services. It combines results from both services and checks data when customers create a new order.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Initially we will hard-code the URLs of the <code>orders</code> and <code>users</code> services in the <code>api</code> service. Additionally, we will hard-code credentials (username and password) into every microservice configuration that are required for Basic authentication.</p>
</div>
<div class="paragraph">
<p>In the second part of this guide we will use a Kubernetes discovery service and Kubernetes configuration maps to dynamically resolve the URLs of the <code>orders</code> and <code>users</code> microservices  and get authentication credentials. The microservices call the Kubernetes API to register when they start up and then resolve placeholders inside the microservices' configurations.</p>
</div>
<div class="sect2">
<h3 id="users-microservice">4.1. Users Microservice</h3>
<div class="paragraph">
<p>Create the <code>users</code> microservice using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mn create-app          \
    --features=discovery-kubernetes,management,security,kubernetes,serialization-jackson,graalvm \
    --build=gradle             \
    --lang=java               \
    --jdk=17              \
    example.micronaut.users</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add the <code>discovery-kubernetes</code>, <code>management</code>, <code>security</code>, <code>serialization-jackson</code>, <code>kubernetes</code> and <code>graalvm</code> features.</p>
</div>
<div class="paragraph">
<p>The previous command creates a directory named <em>users</em> containing Micronaut application with a package named <code>example.micronaut</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have an existing Micronaut application and want to add the functionality described here, you can <a href="https://micronaut.io/launch?features=discovery-kubernetes&amp;features=management&amp;features=security&amp;features=kubernetes&amp;features=serialization-jackson&amp;features=graalvm&amp;lang=JAVA&amp;build=GRADLE&amp;test=JUNIT&amp;name=users&amp;type=DEFAULT&amp;package=example.micronaut&amp;activity=diff" target="_blank" rel="noopener">view the dependency and configuration changes from the specified features</a> and apply those changes to your application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a package named <code>controllers</code> and create a <code>UsersController</code> class to handle incoming HTTP requests for the <code>users</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/java/example/micronaut/controllers/UsersController.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.controllers</span>;

<span class="keyword">import</span> <span class="include">example.micronaut.models.User</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpStatus</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Body</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Controller</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Post</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.exceptions.HttpStatusException</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.security.annotation.Secured</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.security.rules.SecurityRule</span>;

<span class="keyword">import</span> <span class="include">javax.validation.Valid</span>;
<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotNull</span>;
<span class="keyword">import</span> <span class="include">java.util.ArrayList</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;
<span class="keyword">import</span> <span class="include">java.util.Optional</span>;

<span class="annotation">@Controller</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/users</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Secured</span>(SecurityRule.IS_AUTHENTICATED) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="type">class</span> <span class="class">UsersController</span> {
    <span class="predefined-type">List</span>&lt;User&gt; persons = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="annotation">@Post</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="directive">public</span> User add(<span class="annotation">@Body</span> <span class="annotation">@Valid</span> User user) {
        Optional&lt;User&gt; existingUser = findByUsername(user.username());

        <span class="keyword">if</span> (existingUser.isPresent()) {
            <span class="keyword">throw</span> <span class="keyword">new</span> HttpStatusException(HttpStatus.CONFLICT, <span class="string"><span class="delimiter">&quot;</span><span class="content">User with provided username already exists</span><span class="delimiter">&quot;</span></span>);
        }

        User newUser = <span class="keyword">new</span> User(persons.size() + <span class="integer">1</span>, user.firstName(), user.lastName(), user.username());
        persons.add(newUser);
        <span class="keyword">return</span> newUser;
    }

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="directive">public</span> User findById(<span class="type">int</span> id) {
        <span class="keyword">return</span> persons.stream()
                .filter(it -&gt; it.id().equals(id))
                .findFirst().orElse(<span class="predefined-constant">null</span>);
    }

    <span class="annotation">@Get</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;User&gt; getUsers() {
        <span class="keyword">return</span> persons;
    }

     Optional&lt;User&gt; findByUsername(<span class="annotation">@NotNull</span> <span class="predefined-type">String</span> username) {
        <span class="keyword">return</span> persons.stream()
                .filter(it -&gt; it.username().equals(username))
                .findFirst();
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/users</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>io.micronaut.security.Secured</code> to configure secured access. The <code>isAuthenticated()</code> expression will allow access only to authenticated users.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation maps the <code>add</code> method to an HTTP POST request on <code>/users</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>findById</code> method to an HTTP GET request on <code>/users/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getUsers</code> method to an HTTP GET request on <code>/users</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>models</code> where we will put our data beans.</p>
</div>
<div class="paragraph">
<p>The previous <code>UsersController</code> controller uses a <code>User</code> object to represent the customer. Create the <code>User</code> record</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/java/example/micronaut/models/User.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.models</span>;

<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.annotation.JsonProperty</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.Nullable</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.serde.annotation.Serdeable</span>;

<span class="keyword">import</span> <span class="include">javax.validation.constraints.Max</span>;
<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotBlank</span>;

<span class="annotation">@Serdeable</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record User(
        <span class="annotation">@Nullable</span> <span class="annotation">@Max</span>(<span class="integer">10000</span>) <span class="predefined-type">Integer</span> id, <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="annotation">@NotBlank</span> <span class="annotation">@JsonProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> firstName,
        <span class="annotation">@NotBlank</span> <span class="annotation">@JsonProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> lastName,
        <span class="predefined-type">String</span> username
) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ID will be generated by application.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>auth</code> where you will check basic authentication credentials.</p>
</div>
<div class="paragraph">
<p>The <code>Credentials</code> class will load and store credentials (username and password) from a configuration file.</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/java/example/micronaut/auth/Credentials.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.auth</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.context.annotation.ConfigurationProperties</span>;

<span class="annotation">@ConfigurationProperties</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">authentication-credentials</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record Credentials (<span class="predefined-type">String</span> username, <span class="predefined-type">String</span> password) {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@ConfigurationProperties</code> annotation takes the configuration prefix.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>CredentialsChecker</code> class, as the name suggests, will check if the provided credentials inside the HTTP request&#8217;s <code>Authorization</code> header are the same as those that are stored inside the <code>Credentials</code> class that we created above.</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/java/example/micronaut/auth/CredentialsChecker.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.auth</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.Nullable</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpRequest</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.security.authentication.AuthenticationProvider</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.security.authentication.AuthenticationRequest</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.security.authentication.AuthenticationResponse</span>;
<span class="keyword">import</span> <span class="include">jakarta.inject.Singleton</span>;
<span class="keyword">import</span> <span class="include">org.reactivestreams.Publisher</span>;
<span class="keyword">import</span> <span class="include">reactor.core.publisher.Mono</span>;

<span class="annotation">@Singleton</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">class</span> <span class="class">CredentialsChecker</span> <span class="directive">implements</span> AuthenticationProvider {

    <span class="directive">private</span> <span class="directive">final</span> Credentials credentials;

    CredentialsChecker(Credentials credentials) {
        <span class="local-variable">this</span>.credentials = credentials;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Publisher&lt;AuthenticationResponse&gt; authenticate(<span class="annotation">@Nullable</span> HttpRequest&lt;?&gt; httpRequest,
                                                          AuthenticationRequest&lt;?, ?&gt; authenticationRequest) {
        <span class="keyword">return</span> Mono.&lt;AuthenticationResponse&gt;create(emitter -&gt; {
            <span class="keyword">if</span> ( authenticationRequest.getIdentity().equals(credentials.username()) &amp;&amp;
                    authenticationRequest.getSecret().equals(credentials.password()) ) {
                emitter.success(AuthenticationResponse.success((<span class="predefined-type">String</span>) authenticationRequest.getIdentity()));
            } <span class="keyword">else</span> {
                emitter.error(AuthenticationResponse.exception());
            }
        });
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><br></p>
</div>
<div class="sect3">
<h4 id="write-tests-to-verify-application-logic">4.1.1. Write tests to verify application logic</h4>
<div class="paragraph">
<p>Create the <code>UsersClient</code>, a declarative Micronaut HTTP Client for testing:</p>
</div>
<div class="listingblock">
<div class="title">users/src/test/java/example/micronaut/UsersClient.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut</span>;

<span class="keyword">import</span> <span class="include">example.micronaut.models.User</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Body</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Header</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Post</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.annotation.Client</span>;

<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="annotation">@Client</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">UsersClient</span> {

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/users/{id}</span><span class="delimiter">&quot;</span></span>)
    User getById(<span class="annotation">@Header</span> <span class="predefined-type">String</span> authorization, <span class="type">int</span> id);

    <span class="annotation">@Post</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/users</span><span class="delimiter">&quot;</span></span>)
    User createUser(<span class="annotation">@Header</span> <span class="predefined-type">String</span> authorization, <span class="annotation">@Body</span> User user);

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/users</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">List</span>&lt;User&gt; getUsers(<span class="annotation">@Header</span> <span class="predefined-type">String</span> authorization);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>HealthTest</code> checks that there is <code>/health</code> endpoint that is required for service discovery.</p>
</div>
<div class="listingblock">
<div class="title">users/src/test/java/example/micronaut/HealthTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpRequest</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpStatus</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.HttpClient</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.annotation.Client</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;

<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertEquals</span>;

<span class="annotation">@MicronautTest</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">class</span> <span class="class">HealthTest</span> {

    <span class="annotation">@Inject</span>
    <span class="annotation">@Client</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>)
    HttpClient client; <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> healthEndpointExposed() {
        HttpStatus status = client.toBlocking().retrieve(HttpRequest.GET(<span class="string"><span class="delimiter">&quot;</span><span class="content">/health</span><span class="delimiter">&quot;</span></span>), HttpStatus.class);
        assertEquals(HttpStatus.OK, status);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject the <code>HttpClient</code> bean and point it to the embedded server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>UsersControllerTest</code> tests endpoints inside the <code>UserController</code>.</p>
</div>
<div class="listingblock">
<div class="title">users/src/test/java/example/micronaut/UsersControllerTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut</span>;

<span class="keyword">import</span> <span class="include">example.micronaut.auth.Credentials</span>;
<span class="keyword">import</span> <span class="include">example.micronaut.models.User</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpStatus</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.exceptions.HttpClientResponseException</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span>;
<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;

<span class="keyword">import</span> <span class="include">java.util.Base64</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertEquals</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertNotEquals</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertNotNull</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertNull</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertThrows</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertTrue</span>;

<span class="annotation">@MicronautTest</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">class</span> <span class="class">UsersControllerTest</span> {

    <span class="annotation">@Inject</span>
    UsersClient usersClient;

    <span class="annotation">@Inject</span>
    Credentials credentials;

    <span class="annotation">@Test</span>
    <span class="type">void</span> testUnauthorized() {
        HttpClientResponseException exception = assertThrows(HttpClientResponseException.class, () -&gt; usersClient.getUsers(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>));
        assertEquals(HttpStatus.UNAUTHORIZED, exception.getStatus());
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> getUserThatDoesntExists() {
        <span class="predefined-type">String</span> authHeader = basicAuth(credentials);
        User retriedUser = usersClient.getById(authHeader, <span class="integer">100</span>);
        assertNull(retriedUser);
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> multipleUserInteraction() {
        <span class="predefined-type">String</span> authHeader = basicAuth(credentials);

        <span class="predefined-type">String</span> firstName = <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>;
        <span class="predefined-type">String</span> lastName = <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span>;
        <span class="predefined-type">String</span> username = <span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>;

        User user = <span class="keyword">new</span> User(<span class="integer">0</span> ,firstName, lastName, username);

        User createdUser = usersClient.createUser(authHeader, user);

        assertEquals(firstName, createdUser.firstName());
        assertEquals(lastName, createdUser.lastName());
        assertEquals(username, createdUser.username());
        assertNotNull(createdUser.id());

        User retriedUser = usersClient.getById(authHeader, createdUser.id());

        assertEquals(firstName, retriedUser.firstName());
        assertEquals(lastName, retriedUser.lastName());
        assertEquals(username, retriedUser.username());

        <span class="predefined-type">List</span>&lt;User&gt; users = usersClient.getUsers(authHeader);
        assertNotNull(users);
        assertTrue(users.stream()
                .map(User::username)
                .anyMatch(name -&gt; name.equals(username)));

    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> createSameUserTwice() {
        <span class="predefined-type">String</span> authHeader = basicAuth(credentials);

        <span class="predefined-type">String</span> firstName = <span class="string"><span class="delimiter">&quot;</span><span class="content">SameUserFirstName</span><span class="delimiter">&quot;</span></span>;
        <span class="predefined-type">String</span> lastName = <span class="string"><span class="delimiter">&quot;</span><span class="content">SameUserLastName</span><span class="delimiter">&quot;</span></span>;
        <span class="predefined-type">String</span> username = <span class="string"><span class="delimiter">&quot;</span><span class="content">SameUserUsername</span><span class="delimiter">&quot;</span></span>;

        User user = <span class="keyword">new</span> User(<span class="integer">0</span> ,firstName, lastName, username);

        User createdUser = usersClient.createUser(authHeader, user);

        assertEquals(firstName, createdUser.firstName());
        assertEquals(lastName, createdUser.lastName());
        assertEquals(username, createdUser.username());
        assertNotNull(createdUser.id());
        assertNotEquals(createdUser.id(), <span class="integer">0</span>);

        HttpClientResponseException exception = assertThrows(HttpClientResponseException.class, () -&gt; usersClient.createUser(authHeader, user));
        assertEquals(HttpStatus.CONFLICT, exception.getStatus());
        assertTrue(exception.getResponse().getBody(<span class="predefined-type">String</span>.class).orElse(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>).contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">User with provided username already exists</span><span class="delimiter">&quot;</span></span>));

    }
    <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">String</span> basicAuth(Credentials credentials) {
        <span class="keyword">return</span> basicAuth(credentials.username(), credentials.password());
    }
    <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">String</span> basicAuth(<span class="predefined-type">String</span> username, <span class="predefined-type">String</span> password) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Basic </span><span class="delimiter">&quot;</span></span> + Base64.getEncoder().encodeToString((username + <span class="string"><span class="delimiter">&quot;</span><span class="content">:</span><span class="delimiter">&quot;</span></span> + password).getBytes());
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit <em>application.yml</em></p>
</div>
<div class="listingblock">
<div class="title">users/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">users</span></span>
<span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="content">${username} </span></span><i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">password</span>: <span class="string"><span class="content">${password} </span></span><i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Placeholder for username that will be populated by Kubernetes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Placeholder for password that will be populated by Kubernetes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit the <em>bootstrap.yml</em> file in the <em>resources</em> directory to <a href="https://docs.micronaut.io/latest/guide/#bootstrap">enable distributed configuration</a>.
Change the default contents to the following:</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/resources/bootstrap.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">users</span></span>
  <span class="key">config-client</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="key">kubernetes</span>:
  <span class="key">client</span>:
    <span class="key">secrets</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="2"></i><b>(2)</b>
      <span class="key">use-api</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>microanut.config-client.enabled: true</code>  to read and resolve configuration from distributed sources.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set <code>kubernetes.client.secrets.enabled: true</code> to enable Kubernetes secrets as distributed source.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set <code>kubernetes.client.secrets.use-api: true</code> to use the Kubernetes API to fetch the configuration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/application-dev.yml</code>. The Micronaut framework applies this configuration file only for the <code>dev</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/resources/application-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">server</span>:
    <span class="key">port</span>: <span class="string"><span class="content">8081 </span></span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_username</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_password</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the application to listen on port 8081.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded username for the development environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Hardcoded password for the development environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>bootstrap-dev.yml</em> to disable distributed configuration in the dev environment:</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/resources/bootstrap-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">kubernetes</span>:
  <span class="key">client</span>:
    <span class="key">secrets</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">false </span></span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Disable the Kubernetes secrets client.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>application-test.yml</em> for use in the test environment:</p>
</div>
<div class="listingblock">
<div class="title">users/src/test/resources/application-test.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_username</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_password</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hardcoded username for the test environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded password for the test environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the unit test:</p>
</div>
<div class="listingblock">
<div class="title">users</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./gradlew test</code></pre>
</div>
</div>
<div class="paragraph">
<p><br></p>
</div>
</div>
<div class="sect3">
<h4 id="running-the-application">4.1.2. Running the application</h4>
<div class="paragraph">
<p>Run the <code>users</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">users</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"> MICRONAUT_ENVIRONMENTS=dev ./gradlew run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8081</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="orders-microservice">4.2. Orders Microservice</h3>
<div class="paragraph">
<p>Create the <code>orders</code> microservice using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mn create-app        \
  --features=discovery-kubernetes,management,security,kubernetes,serialization-jackson,graalvm \
  --build=gradle              \
  --lang=java                \
  --jdk=17               \
example.micronaut.orders</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add the <code>discovery-kubernetes</code>, <code>management</code>, <code>security</code>, <code>serialization-jackson</code>, <code>kubernetes</code> and <code>graalvm</code> features.</p>
</div>
<div class="paragraph">
<p>The previous command creates a directory named <em>orders</em> containing a Micronaut application with a package named <code>example.micronaut</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have an existing Micronaut application and want to add the functionality described here, you can <a href="https://micronaut.io/launch?features=discovery-kubernetes&amp;features=management&amp;features=security&amp;features=kubernetes&amp;features=serialization-jackson&amp;features=graalvm&amp;lang=JAVA&amp;build=GRADLE&amp;test=JUNIT&amp;name=orders&amp;type=DEFAULT&amp;package=example.micronaut&amp;activity=diff" target="_blank" rel="noopener">view the dependency and configuration changes from the specified features</a> and apply those changes to your application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>controllers</code> and create the <code>OrdersController</code> and <code>ItemsController</code> classes to handle incoming HTTP requests to the <code>orders</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/java/example/micronaut/controllers/OrdersController.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.controllers</span>;

<span class="keyword">import</span> <span class="include">example.micronaut.models.Item</span>;
<span class="keyword">import</span> <span class="include">example.micronaut.models.Order</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.core.util.CollectionUtils</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpStatus</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Body</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Controller</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Post</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.exceptions.HttpStatusException</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.security.annotation.Secured</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.security.rules.SecurityRule</span>;

<span class="keyword">import</span> <span class="include">javax.validation.Valid</span>;
<span class="keyword">import</span> <span class="include">java.math.BigDecimal</span>;
<span class="keyword">import</span> <span class="include">java.util.ArrayList</span>;
<span class="keyword">import</span> <span class="include">java.util.Optional</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="annotation">@Controller</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/orders</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Secured</span>(SecurityRule.IS_AUTHENTICATED)  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="type">class</span> <span class="class">OrdersController</span> {

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">List</span>&lt;Order&gt; orders = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;();

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="directive">public</span> Optional&lt;Order&gt; findById(<span class="type">int</span> id) {
        <span class="keyword">return</span> orders.stream()
                .filter(it -&gt; it.id().equals(id))
                .findFirst();
    }

    <span class="annotation">@Get</span>  <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;Order&gt; getOrders() {
        <span class="keyword">return</span> orders;
    }

    <span class="annotation">@Post</span>  <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="directive">public</span> Order createOrder(<span class="annotation">@Body</span> <span class="annotation">@Valid</span> Order order) {
        <span class="keyword">if</span> (CollectionUtils.isEmpty(order.itemIds())) {
            <span class="keyword">throw</span> <span class="keyword">new</span> HttpStatusException(HttpStatus.BAD_REQUEST, <span class="string"><span class="delimiter">&quot;</span><span class="content">Items must be supplied</span><span class="delimiter">&quot;</span></span>);
        }

        <span class="predefined-type">List</span>&lt;Item&gt; items = order.itemIds().stream().map(
                x -&gt; Item.items.stream().filter(
                        y -&gt; y.id().equals(x)
                ).findFirst().orElseThrow(
                        () -&gt; <span class="keyword">new</span> HttpStatusException(HttpStatus.BAD_REQUEST, <span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">Item with id %s doesn't exist</span><span class="delimiter">&quot;</span></span>, x))
                )

        ).toList();


        <span class="predefined-type">BigDecimal</span> total = items.stream().map(Item::price).reduce(<span class="predefined-type">BigDecimal</span>::add).orElse(<span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>));
        Order newOrder = <span class="keyword">new</span> Order(orders.size() + <span class="integer">1</span>, order.userId(), items, <span class="predefined-constant">null</span>, total);

        orders.add(newOrder);
        <span class="keyword">return</span> newOrder;
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/orders</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>io.micronaut.security.Secured</code> to configure secured access. The <code>isAuthenticated()</code> expression will allow access only to authenticated users.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>findById</code> method to an HTTP GET request on <code>/orders/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getOrders</code> method to an HTTP GET request on <code>/orders</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation maps the <code>createOrder</code> method to an HTTP POST request on <code>/orders</code>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">orders/src/main/java/example/micronaut/controllers/ItemsController.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.controllers</span>;

<span class="keyword">import</span> <span class="include">example.micronaut.models.Item</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Controller</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.security.annotation.Secured</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.security.rules.SecurityRule</span>;

<span class="keyword">import</span> <span class="include">java.util.Optional</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="annotation">@Controller</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/items</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Secured</span>(SecurityRule.IS_AUTHENTICATED)  <i class="conum" data-value="2"></i><b>(2)</b>
<span class="type">class</span> <span class="class">ItemsController</span> {

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/{id}</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="directive">public</span> Optional&lt;Item&gt; findById(<span class="type">int</span> id) {
        <span class="keyword">return</span> Item.items.stream()
                .filter(it -&gt; it.id().equals(id))
                .findFirst();
    }

    <span class="annotation">@Get</span>  <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;Item&gt; getItems() {
        <span class="keyword">return</span> Item.items;
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/items</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>io.micronaut.security.Secured</code> to configure secured access. The <code>isAuthenticated()</code> expression will allow access only to authenticated users.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>findById</code> method to an HTTP GET request on <code>/items/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getItems</code> method to an HTTP GET request on <code>/items</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>models</code> where you will put your data beans.</p>
</div>
<div class="paragraph">
<p>The <code>OrdersController</code> and <code>ItemsController</code> classes uses <code>Order</code> and <code>Item</code>  objects to represent customer orders. Create the <code>Order</code> record:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/java/example/micronaut/models/Order.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.models</span>;

<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.annotation.JsonProperty</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.Nullable</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.serde.annotation.Serdeable</span>;

<span class="keyword">import</span> <span class="include">javax.validation.constraints.Max</span>;
<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotBlank</span>;
<span class="keyword">import</span> <span class="include">java.math.BigDecimal</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="annotation">@Serdeable</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record Order(
        <span class="annotation">@Max</span>(<span class="integer">10000</span>) <span class="annotation">@Nullable</span> <span class="predefined-type">Integer</span> id, <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="annotation">@NotBlank</span> <span class="annotation">@JsonProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">user_id</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">Integer</span> userId,
        <span class="annotation">@Nullable</span> <span class="predefined-type">List</span>&lt;Item&gt; items, <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="annotation">@NotBlank</span> <span class="annotation">@JsonProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">item_ids</span><span class="delimiter">&quot;</span></span>) <span class="annotation">@Nullable</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt; itemIds, <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="annotation">@Nullable</span> <span class="predefined-type">BigDecimal</span> total
) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ID will be generated by application.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>List</code> of <code>Item</code> class will be populated by the server and will be only visible in sever responses.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>List of item_ids will be provided by client requests.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the <code>Item</code> record:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/java/example/micronaut/models/Item.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.models</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.serde.annotation.Serdeable</span>;

<span class="keyword">import</span> <span class="include">java.math.BigDecimal</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="annotation">@Serdeable</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record Item(
        <span class="predefined-type">Integer</span> id,
        <span class="predefined-type">String</span> name,
        <span class="predefined-type">BigDecimal</span> price
) {
    <span class="directive">public</span> <span class="directive">static</span> <span class="predefined-type">List</span>&lt;Item&gt; items = <span class="predefined-type">List</span>.of(
            <span class="keyword">new</span> Item(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Banana</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1.5</span><span class="delimiter">&quot;</span></span>)),
            <span class="keyword">new</span> Item(<span class="integer">2</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Kiwi</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">2.5</span><span class="delimiter">&quot;</span></span>)),
            <span class="keyword">new</span> Item(<span class="integer">3</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Grape</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1.25</span><span class="delimiter">&quot;</span></span>))
        );
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>auth</code> where you will check basic authentication credentials.</p>
</div>
<div class="paragraph">
<p>The <code>Credentials</code> class will load and store credentials (username and password) from configuration files.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/java/example/micronaut/auth/Credentials.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.auth</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.context.annotation.ConfigurationProperties</span>;

<span class="annotation">@ConfigurationProperties</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">authentication-credentials</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record Credentials (<span class="predefined-type">String</span> username, <span class="predefined-type">String</span> password) {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@ConfigurationProperties</code> annotation takes the configuration prefix.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>CredentialsChecker</code> class, as name suggests, will check if provided credentials inside an HTTP request&#8217;s <code>Authorization</code> header are the same as those that are stored inside <code>Credentials</code> class that we created above.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/java/example/micronaut/auth/CredentialsChecker.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.auth</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.Nullable</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpRequest</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.security.authentication.AuthenticationProvider</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.security.authentication.AuthenticationRequest</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.security.authentication.AuthenticationResponse</span>;
<span class="keyword">import</span> <span class="include">jakarta.inject.Singleton</span>;
<span class="keyword">import</span> <span class="include">org.reactivestreams.Publisher</span>;
<span class="keyword">import</span> <span class="include">reactor.core.publisher.Mono</span>;

<span class="annotation">@Singleton</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">class</span> <span class="class">CredentialsChecker</span> <span class="directive">implements</span> AuthenticationProvider {

    <span class="directive">private</span> <span class="directive">final</span> Credentials credentials;

    CredentialsChecker(Credentials credentials) {
        <span class="local-variable">this</span>.credentials = credentials;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Publisher&lt;AuthenticationResponse&gt; authenticate(<span class="annotation">@Nullable</span> HttpRequest&lt;?&gt; httpRequest,
                                                          AuthenticationRequest&lt;?, ?&gt; authenticationRequest) {
        <span class="keyword">return</span> Mono.&lt;AuthenticationResponse&gt;create(emitter -&gt; {
            <span class="keyword">if</span> ( authenticationRequest.getIdentity().equals(credentials.username()) &amp;&amp;
                    authenticationRequest.getSecret().equals(credentials.password()) ) {
                emitter.success(AuthenticationResponse.success((<span class="predefined-type">String</span>) authenticationRequest.getIdentity()));
            } <span class="keyword">else</span> {
                emitter.error(AuthenticationResponse.exception());
            }
        });
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><br></p>
</div>
<div class="sect3">
<h4 id="write-tests-to-verify-application-logic-2">4.2.1. Write tests to verify application logic</h4>
<div class="paragraph">
<p>Create the <code>OrderItemClient</code>, a declarative Micronaut HTTP Client for testing:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/test/java/example/micronaut/OrderItemClient.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut</span>;

<span class="keyword">import</span> <span class="include">example.micronaut.models.Item</span>;
<span class="keyword">import</span> <span class="include">example.micronaut.models.Order</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Body</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Header</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Post</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.annotation.Client</span>;

<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="annotation">@Client</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">interface</span> <span class="class">OrderItemClient</span> {

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/orders/{id}</span><span class="delimiter">&quot;</span></span>)
    Order getOrderById(<span class="annotation">@Header</span> <span class="predefined-type">String</span> authorization, <span class="type">int</span> id);

    <span class="annotation">@Post</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/orders</span><span class="delimiter">&quot;</span></span>)
    Order createOrder(<span class="annotation">@Header</span> <span class="predefined-type">String</span> authorization, <span class="annotation">@Body</span> Order order);

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/orders</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">List</span>&lt;Order&gt; getOrders(<span class="annotation">@Header</span> <span class="predefined-type">String</span> authorization);

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/items</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">List</span>&lt;Item&gt; getItems(<span class="annotation">@Header</span> <span class="predefined-type">String</span> authorization);

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/items/{id}</span><span class="delimiter">&quot;</span></span>)
    Item getItemsById(<span class="annotation">@Header</span> <span class="predefined-type">String</span> authorization, <span class="type">int</span> id);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>HealthTest</code> checks that there is <code>/health</code> endpoint that is required for service discovery.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/test/java/example/micronaut/HealthTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpRequest</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpStatus</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.HttpClient</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.annotation.Client</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;

<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertEquals</span>;

<span class="annotation">@MicronautTest</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">class</span> <span class="class">HealthTest</span> {

    <span class="annotation">@Inject</span>
    <span class="annotation">@Client</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>)
    HttpClient client; <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> healthEndpointExposed() {
        HttpStatus status = client.toBlocking().retrieve(HttpRequest.GET(<span class="string"><span class="delimiter">&quot;</span><span class="content">/health</span><span class="delimiter">&quot;</span></span>), HttpStatus.class);
        assertEquals(HttpStatus.OK, status);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject the <code>HttpClient</code> bean and point it to the embedded server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>ItemsControllerTest</code> tests endpoints inside the <code>ItemController</code>.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/test/java/example/micronaut/ItemsControllerTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut</span>;

<span class="keyword">import</span> <span class="include">example.micronaut.auth.Credentials</span>;
<span class="keyword">import</span> <span class="include">example.micronaut.models.Item</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpStatus</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.exceptions.HttpClientResponseException</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span>;
<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;

<span class="keyword">import</span> <span class="include">java.math.BigDecimal</span>;
<span class="keyword">import</span> <span class="include">java.util.Base64</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertEquals</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertNotNull</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertThrows</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertTrue</span>;

<span class="annotation">@MicronautTest</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">class</span> <span class="class">ItemsControllerTest</span> {

    <span class="annotation">@Inject</span>
    OrderItemClient orderItemClient;

    <span class="annotation">@Inject</span>
    Credentials credentials;

    <span class="annotation">@Test</span>
    <span class="type">void</span> testUnauthorized() {
        HttpClientResponseException exception = assertThrows(HttpClientResponseException.class, () -&gt; orderItemClient.getItems(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>));
        assertEquals(HttpStatus.UNAUTHORIZED, exception.getStatus());
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> getItem() {

        <span class="type">int</span> itemId = <span class="integer">1</span>;


        <span class="predefined-type">String</span> authHeader = basicAuth(credentials);

        Item item = orderItemClient.getItemsById(authHeader, itemId);

        assertEquals(itemId, item.id());
        assertEquals(<span class="string"><span class="delimiter">&quot;</span><span class="content">Banana</span><span class="delimiter">&quot;</span></span>, item.name());
        assertEquals(<span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1.5</span><span class="delimiter">&quot;</span></span>), item.price());
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> getItems() {
        <span class="predefined-type">String</span> authHeader = basicAuth(credentials);

        <span class="predefined-type">List</span>&lt;Item&gt; items = orderItemClient.getItems(authHeader);

        assertNotNull(items);
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; existingItemNames = <span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">Kiwi</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Banana</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Grape</span><span class="delimiter">&quot;</span></span>);
        assertEquals(<span class="integer">3</span>, items.size());
        assertTrue(items.stream()
                .map(Item::name)
                .allMatch(name -&gt; existingItemNames.stream().anyMatch(x -&gt; x.equals(name))));
    }
    <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">String</span> basicAuth(Credentials credentials) {
        <span class="keyword">return</span> basicAuth(credentials.username(), credentials.password());
    }
    <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">String</span> basicAuth(<span class="predefined-type">String</span> username, <span class="predefined-type">String</span> password) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Basic </span><span class="delimiter">&quot;</span></span> + Base64.getEncoder().encodeToString((username + <span class="string"><span class="delimiter">&quot;</span><span class="content">:</span><span class="delimiter">&quot;</span></span> + password).getBytes());
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>OrdersControllerTest</code> tests endpoints inside the <code>OrdersController</code>.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/test/java/example/micronaut/OrdersControllerTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut</span>;

<span class="keyword">import</span> <span class="include">example.micronaut.auth.Credentials</span>;
<span class="keyword">import</span> <span class="include">example.micronaut.models.Order</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpStatus</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.exceptions.HttpClientResponseException</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span>;
<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;

<span class="keyword">import</span> <span class="include">java.math.BigDecimal</span>;
<span class="keyword">import</span> <span class="include">java.util.Base64</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertEquals</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertNotNull</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertThrows</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertTrue</span>;

<span class="annotation">@MicronautTest</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">class</span> <span class="class">OrdersControllerTest</span> {

    <span class="annotation">@Inject</span>
    OrderItemClient orderItemClient;

    <span class="annotation">@Inject</span>
    Credentials credentials;

    <span class="annotation">@Test</span>
    <span class="type">void</span> testUnauthorized() {
        HttpClientResponseException exception = assertThrows(HttpClientResponseException.class, () -&gt; orderItemClient.getOrders(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>));
        assertEquals(HttpStatus.UNAUTHORIZED, exception.getStatus());
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> multipleOrderInteraction() {
        <span class="predefined-type">String</span> authHeader = basicAuth(credentials);

        <span class="type">int</span> userId = <span class="integer">1</span>;
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt; itemIds = <span class="predefined-type">List</span>.of(<span class="integer">1</span>, <span class="integer">1</span>, <span class="integer">2</span>, <span class="integer">3</span>);

        Order order = <span class="keyword">new</span> Order(<span class="integer">0</span>, userId, <span class="predefined-constant">null</span>, itemIds, <span class="predefined-constant">null</span>);

        Order createdOrder = orderItemClient.createOrder(authHeader, order);

        assertNotNull(createdOrder.items());

        assertEquals(<span class="integer">4</span>, createdOrder.items().size());
        assertEquals(<span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">6.75</span><span class="delimiter">&quot;</span></span>), createdOrder.total());
        assertEquals(userId, createdOrder.userId());

        Order retrievedOrder = orderItemClient.getOrderById(authHeader, createdOrder.id());

        assertNotNull(retrievedOrder.items());

        assertEquals(<span class="integer">4</span>, retrievedOrder.items().size());
        assertEquals(<span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">6.75</span><span class="delimiter">&quot;</span></span>), retrievedOrder.total());
        assertEquals(userId, retrievedOrder.userId());

        <span class="predefined-type">List</span>&lt;Order&gt; orders = orderItemClient.getOrders(authHeader);

        assertNotNull(orders);
        assertTrue(orders.stream()
                .map(Order::userId)
                .anyMatch(id -&gt; id.equals(userId)));

    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> itemDoesntExists() {
        <span class="predefined-type">String</span> authHeader = basicAuth(credentials);

        <span class="type">int</span> userId = <span class="integer">1</span>;
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt; itemIds = <span class="predefined-type">List</span>.of(<span class="integer">5</span>);

        Order order = <span class="keyword">new</span> Order(<span class="integer">0</span>, userId, <span class="predefined-constant">null</span>, itemIds, <span class="predefined-constant">null</span>);

        HttpClientResponseException exception = assertThrows(HttpClientResponseException.class, () -&gt; orderItemClient.createOrder(authHeader, order));

        assertEquals(HttpStatus.BAD_REQUEST,exception.getStatus());

        assertTrue(exception.getResponse().getBody(<span class="predefined-type">String</span>.class).orElse(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>).contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Item with id 5 doesn't exist</span><span class="delimiter">&quot;</span></span>));
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> orderEmptyItems() {
        <span class="predefined-type">String</span> authHeader = basicAuth(credentials);

        <span class="type">int</span> userId = <span class="integer">1</span>;
        Order order = <span class="keyword">new</span> Order(<span class="integer">0</span>, userId, <span class="predefined-constant">null</span>, <span class="predefined-constant">null</span>, <span class="predefined-constant">null</span>);
        HttpClientResponseException exception = assertThrows(HttpClientResponseException.class, () -&gt; orderItemClient.createOrder(authHeader, order));

        assertEquals(HttpStatus.BAD_REQUEST,exception.getStatus());
        assertTrue(exception.getResponse().getBody(<span class="predefined-type">String</span>.class).orElse(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>).contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Items must be supplied</span><span class="delimiter">&quot;</span></span>));
    }


    <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">String</span> basicAuth(Credentials credentials) {
        <span class="keyword">return</span> basicAuth(credentials.username(), credentials.password());
    }
    <span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">String</span> basicAuth(<span class="predefined-type">String</span> username, <span class="predefined-type">String</span> password) {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Basic </span><span class="delimiter">&quot;</span></span> + Base64.getEncoder().encodeToString((username + <span class="string"><span class="delimiter">&quot;</span><span class="content">:</span><span class="delimiter">&quot;</span></span> + password).getBytes());
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit <em>application.yml</em> so it contains:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">orders</span></span>
<span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="content">${username} </span></span><i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">password</span>: <span class="string"><span class="content">${password} </span></span><i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Placeholder for username that will be populated by Kubernetes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Placeholder for password that will be populated by Kubernetes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit <em>bootstrap.yml</em> file in
the <em>resources</em> directory to <a href="https://docs.micronaut.io/latest/guide/#bootstrap">enable distributed configuration</a>.
Change it to the following:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/resources/bootstrap.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">orders</span></span>
  <span class="key">config-client</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="key">kubernetes</span>:
  <span class="key">client</span>:
    <span class="key">secrets</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="2"></i><b>(2)</b>
      <span class="key">use-api</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>microanut.config-client.enabled: true</code> to read and resolve configuration from distributed sources.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set <code>kubernetes.client.secrets.enabled: true</code> to enable Kubernetes secrets as distributed source.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set <code>kubernetes.client.secrets.use-api: true</code> to use Kubernetes API to fetch configuration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/application-dev.yml</code>. The Micronaut framework applies this configuration file only for the <code>dev</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/resources/application-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">server</span>:
    <span class="key">port</span>: <span class="string"><span class="content">8082 </span></span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_username</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_password</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the application to listen on port 8082.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded username for development environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Hardcoded password for development environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>bootstrap-dev.yml</em> to disable distributed configuration in the dev environment:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/resources/bootstrap-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">kubernetes</span>:
  <span class="key">client</span>:
    <span class="key">secrets</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">false </span></span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Disable Kubernetes secrets client.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>application-test.yml</em> to be used in the test environment:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/test/resources/application-test.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">orders</span></span>
<span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_username</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_password</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hardcoded username for development environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded password for development environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the unit test:</p>
</div>
<div class="listingblock">
<div class="title">orders</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./gradlew test</code></pre>
</div>
</div>
<div class="paragraph">
<p><br></p>
</div>
</div>
<div class="sect3">
<h4 id="running-the-application-2">4.2.2. Running the application</h4>
<div class="paragraph">
<p>Run the <code>orders</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">orders</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">MICRONAUT_ENVIRONMENTS=dev ./gradlew run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8082</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="api-gateway-microservice">4.3. API (Gateway) Microservice</h3>
<div class="paragraph">
<p>Create the <code>api</code> microservice using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mn create-app         \
   --features=discovery-kubernetes,management,kubernetes,serialization-jackson,graalvm,mockito \
   --build=gradle           \
   --lang=java             \
   --jdk=17            \
    example.micronaut.api</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add the <code>discovery-kubernetes</code>, <code>management</code>, <code>kubernetes</code>, <code>serialization-jackson</code>, <code>mockito</code> and <code>graalvm</code> features.</p>
</div>
<div class="paragraph">
<p>The previous command creates a directory named <em>api</em> containing a Micronaut application with a package named <code>example.micronaut</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have an existing Micronaut application and want to add the functionality described here, you can <a href="https://micronaut.io/launch?features=discovery-kubernetes&amp;features=management&amp;features=kubernetes&amp;features=serialization-jackson&amp;features=graalvm&amp;features=mockito&amp;lang=JAVA&amp;build=GRADLE&amp;test=JUNIT&amp;name=api&amp;type=DEFAULT&amp;package=example.micronaut&amp;activity=diff" target="_blank" rel="noopener">view the dependency and configuration changes from the specified features</a> and apply those changes to your application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a package named <code>controllers</code> and create a <code>GatewayController</code> class to handle incoming HTTP requests to the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/java/example/micronaut/controllers/GatewayController.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.controllers</span>;

<span class="keyword">import</span> <span class="include">example.micronaut.clients.OrdersClient</span>;
<span class="keyword">import</span> <span class="include">example.micronaut.clients.UsersClient</span>;
<span class="keyword">import</span> <span class="include">example.micronaut.models.Item</span>;
<span class="keyword">import</span> <span class="include">example.micronaut.models.Order</span>;
<span class="keyword">import</span> <span class="include">example.micronaut.models.User</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.NonNull</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpStatus</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Body</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Controller</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Post</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.exceptions.HttpStatusException</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.scheduling.TaskExecutors</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.scheduling.annotation.ExecuteOn</span>;
<span class="keyword">import</span> <span class="include">javax.validation.Valid</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="annotation">@Controller</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@ExecuteOn</span>(TaskExecutors.IO) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="type">class</span> <span class="class">GatewayController</span> {

    <span class="directive">private</span> <span class="directive">final</span> OrdersClient orderClient;
    <span class="directive">private</span> <span class="directive">final</span> UsersClient userClient;

    GatewayController(OrdersClient orderClient, UsersClient userClient) {
        <span class="local-variable">this</span>.orderClient = orderClient;
        <span class="local-variable">this</span>.userClient = userClient;
    }

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/users/{id}</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="3"></i><b>(3)</b>
    User getUserById(<span class="type">int</span> id) {
        <span class="keyword">return</span> userClient.getById(id);
    }

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/orders/{id}</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="4"></i><b>(4)</b>
    Order getOrdersById(<span class="type">int</span> id) {
        Order order = orderClient.getOrderById(id);
        <span class="keyword">return</span> <span class="keyword">new</span> Order(order.id(), <span class="predefined-constant">null</span>, getUserById(order.userId()), order.items(), order.itemIds(), order.total());
    }

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/items/{id}</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="5"></i><b>(5)</b>
    Item getItemsById(<span class="type">int</span> id) {
        <span class="keyword">return</span> orderClient.getItemsById(id);
    }

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/users</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="predefined-type">List</span>&lt;User&gt; getUsers() {
        <span class="keyword">return</span> userClient.getUsers();
    }

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/items</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="7"></i><b>(7)</b>
    <span class="predefined-type">List</span>&lt;Item&gt; getItems() {
        <span class="keyword">return</span> orderClient.getItems();
    }

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/orders</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="8"></i><b>(8)</b>
    <span class="predefined-type">List</span>&lt;Order&gt; getOrders() {
        <span class="keyword">return</span> orderClient.getOrders()
                .stream()
                .map(x -&gt; <span class="keyword">new</span> Order(x.id(), <span class="predefined-constant">null</span>, getUserById(x.userId()), x.items(), x.itemIds(), x.total()))
                .toList();
    }

    <span class="annotation">@Post</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/orders</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="9"></i><b>(9)</b>
    Order createOrder(<span class="annotation">@Body</span> <span class="annotation">@Valid</span> Order order) {
        User user = getUserById(order.userId());
        <span class="keyword">if</span> (user == <span class="predefined-constant">null</span>) {
            <span class="keyword">throw</span> <span class="keyword">new</span> HttpStatusException(HttpStatus.BAD_REQUEST, <span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">User with id %s doesn't exist</span><span class="delimiter">&quot;</span></span>, order.userId()));
        }
        Order createdOrder = orderClient.createOrder(order);
        <span class="keyword">return</span> <span class="keyword">new</span> Order(createdOrder.id(), <span class="predefined-constant">null</span>, user, createdOrder.items(), createdOrder.itemIds(), createdOrder.total());
    }

    <span class="annotation">@Post</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/users</span><span class="delimiter">&quot;</span></span>)  <i class="conum" data-value="10"></i><b>(10)</b>
    User createUser(<span class="annotation">@Body</span> <span class="annotation">@NonNull</span> User user) {
        <span class="keyword">return</span> userClient.createUser(user);
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/api</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It is critical that any blocking I/O operations (such as fetching the data from the database) are offloaded to a separate thread pool that does not block the Event loop.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getUserById</code> method to an HTTP GET request on <code>/users/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getOrdersById</code> method to an HTTP GET request on <code>/orders/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getItemsById</code> method to an HTTP GET request on <code>/items/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getUsers</code> method to an HTTP GET request on <code>/users</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getItems</code> method to an HTTP GET request on <code>/items</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getOrders</code> method to an HTTP GET request on <code>/orders</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation maps the <code>createUser</code> method to an HTTP POST request on <code>/users</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation maps the <code>createOrder</code> method to an HTTP POST request on <code>/orders</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>models</code> where you will put your data beans.</p>
</div>
<div class="paragraph">
<p>The <code>GatewayController</code> and <code>ItemsController</code> classes use <code>User</code>, <code>Order</code>, and <code>Item</code> to represent customer orders. Create the <code>User</code> record:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/java/example/micronaut/models/User.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.models</span>;

<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.annotation.JsonProperty</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.Nullable</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.serde.annotation.Serdeable</span>;

<span class="keyword">import</span> <span class="include">javax.validation.constraints.Max</span>;
<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotBlank</span>;

<span class="annotation">@Serdeable</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record User(
        <span class="annotation">@Nullable</span> <span class="annotation">@Max</span>(<span class="integer">10000</span>) <span class="predefined-type">Integer</span> id,
        <span class="annotation">@NotBlank</span> <span class="annotation">@JsonProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> firstName,
        <span class="annotation">@NotBlank</span> <span class="annotation">@JsonProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">String</span> lastName,
        <span class="predefined-type">String</span> username
) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the <code>Order</code> record:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/java/example/micronaut/models/Order.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.models</span>;

<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.annotation.JsonProperty</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.Nullable</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.serde.annotation.Serdeable</span>;

<span class="keyword">import</span> <span class="include">javax.validation.constraints.Max</span>;
<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotBlank</span>;
<span class="keyword">import</span> <span class="include">java.math.BigDecimal</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="annotation">@Serdeable</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record Order(
        <span class="annotation">@Nullable</span> <span class="annotation">@Max</span>(<span class="integer">10000</span>) <span class="predefined-type">Integer</span> id,
        <span class="annotation">@NotBlank</span> <span class="annotation">@Nullable</span> <span class="annotation">@JsonProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">user_id</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">Integer</span> userId,
        <span class="annotation">@Nullable</span> User user,
        <span class="annotation">@Nullable</span> <span class="predefined-type">List</span>&lt;Item&gt; items,
        <span class="annotation">@NotBlank</span> <span class="annotation">@Nullable</span> <span class="annotation">@JsonProperty</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">item_ids</span><span class="delimiter">&quot;</span></span>) <span class="predefined-type">List</span>&lt;<span class="predefined-type">Integer</span>&gt; itemIds,
        <span class="annotation">@Nullable</span> <span class="predefined-type">BigDecimal</span> total
) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the <code>Item</code> record:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/java/example/micronaut/models/Item.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.models</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.serde.annotation.Serdeable</span>;

<span class="keyword">import</span> <span class="include">java.math.BigDecimal</span>;

<span class="annotation">@Serdeable</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record Item(
        <span class="predefined-type">Integer</span> id,
        <span class="predefined-type">String</span> name,
        <span class="predefined-type">BigDecimal</span> price
) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a package named <code>clients</code> where you will put the HTTP Clients to call the <code>users</code> and <code>orders</code> microservices.</p>
</div>
<div class="paragraph">
<p>Create a <code>UserClient</code> for the <code>users</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/java/example/micronaut/clients/UsersClient.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.clients</span>;

<span class="keyword">import</span> <span class="include">example.micronaut.models.User</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Body</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Post</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.annotation.Client</span>;

<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="annotation">@Client</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">UsersClient</span> {
    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/users/{id}</span><span class="delimiter">&quot;</span></span>)
    User getById(<span class="type">int</span> id);

    <span class="annotation">@Post</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/users</span><span class="delimiter">&quot;</span></span>)
    User createUser(<span class="annotation">@Body</span> User user);

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/users</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">List</span>&lt;User&gt; getUsers();
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create an <code>OrdersClient</code> for the <code>orders</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/java/example/micronaut/clients/OrdersClient.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.clients</span>;

<span class="keyword">import</span> <span class="include">example.micronaut.models.Item</span>;
<span class="keyword">import</span> <span class="include">example.micronaut.models.Order</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Body</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Post</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.annotation.Client</span>;

<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="annotation">@Client</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">orders</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">OrdersClient</span> {
    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/orders/{id}</span><span class="delimiter">&quot;</span></span>)
    Order getOrderById(<span class="type">int</span> id);

    <span class="annotation">@Post</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/orders</span><span class="delimiter">&quot;</span></span>)
    Order createOrder(<span class="annotation">@Body</span> Order order);

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/orders</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">List</span>&lt;Order&gt; getOrders();

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/items</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">List</span>&lt;Item&gt; getItems();

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/items/{id}</span><span class="delimiter">&quot;</span></span>)
    Item getItemsById(<span class="type">int</span> id);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a package named <code>auth</code> where we will check basic authentication credentials.</p>
</div>
<div class="paragraph">
<p>Create a <code>Credentials</code> class that will load the username and password from configuration that will be needed for comparison.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/java/example/micronaut/auth/Credentials.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.auth</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.context.annotation.ConfigurationProperties</span>;

<span class="annotation">@ConfigurationProperties</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">authentication-credentials</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> record Credentials (<span class="predefined-type">String</span> username, <span class="predefined-type">String</span> password) {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@ConfigurationProperties</code> annotation takes the configuration prefix.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create an <code>AuthClientFilter</code> class that is a client filter applied to every client. It adds basic authentication header with credentials that are stored in the <code>Credentials</code> class.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/java/example/micronaut/auth/AuthClientFilter.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut.auth</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpResponse</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.MutableHttpRequest</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Filter</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.filter.ClientFilterChain</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.filter.HttpClientFilter</span>;
<span class="keyword">import</span> <span class="include">org.reactivestreams.Publisher</span>;

<span class="annotation">@Filter</span>(<span class="predefined-type">Filter</span>.MATCH_ALL_PATTERN)
<span class="type">class</span> <span class="class">AuthClientFilter</span> <span class="directive">implements</span> HttpClientFilter {

    <span class="directive">private</span> <span class="directive">final</span> Credentials credentials;

    AuthClientFilter(Credentials credentials) {
        <span class="local-variable">this</span>.credentials = credentials;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> Publisher&lt;? <span class="directive">extends</span> HttpResponse&lt;?&gt;&gt; doFilter(MutableHttpRequest&lt;?&gt; request, ClientFilterChain chain) {
        <span class="keyword">return</span> chain.proceed(request.basicAuth(credentials.username(), credentials.password()));
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a class named <code>ErrorExceptionHandler</code> in the <code>example.micronaut</code> package. <code>ErrorExceptionHandler</code> will propagate errors from the <code>orders</code> and <code>users</code> microservices.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/java/example/micronaut/ErrorExceptionHandler.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpRequest</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpResponse</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.exceptions.HttpClientResponseException</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.server.exceptions.ExceptionHandler</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.server.exceptions.response.ErrorContext</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.server.exceptions.response.ErrorResponseProcessor</span>;
<span class="keyword">import</span> <span class="include">jakarta.inject.Singleton</span>;

<span class="annotation">@Singleton</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">class</span> <span class="class">ErrorExceptionHandler</span> <span class="directive">implements</span> ExceptionHandler&lt;HttpClientResponseException, HttpResponse&lt;?&gt;&gt; {
    <span class="directive">private</span> <span class="directive">final</span> ErrorResponseProcessor&lt;?&gt; errorResponseProcessor;

    <span class="directive">public</span> ErrorExceptionHandler(ErrorResponseProcessor&lt;?&gt; errorResponseProcessor) {
        <span class="local-variable">this</span>.errorResponseProcessor = errorResponseProcessor;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> HttpResponse handle(HttpRequest request, HttpClientResponseException e) {
        <span class="keyword">return</span> errorResponseProcessor.processResponse(ErrorContext.builder(request)
                .cause(e)
                .errorMessage(e.getResponse().getBody(<span class="predefined-type">String</span>.class).orElse(<span class="predefined-constant">null</span>))
                .build(), HttpResponse.status(e.getStatus()));
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><br></p>
</div>
<div class="sect3">
<h4 id="write-tests-to-verify-application-logic-3">4.3.1. Write tests to verify application logic</h4>
<div class="paragraph">
<p>Create a <code>GatewayClient</code>, a declarative Micronaut HTTP Client for testing:</p>
</div>
<div class="listingblock">
<div class="title">api/src/test/java/example/micronaut/GatewayClient.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut</span>;

<span class="keyword">import</span> <span class="include">example.micronaut.models.Item</span>;
<span class="keyword">import</span> <span class="include">example.micronaut.models.Order</span>;
<span class="keyword">import</span> <span class="include">example.micronaut.models.User</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Body</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Post</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.annotation.Client</span>;

<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="annotation">@Client</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">interface</span> <span class="class">GatewayClient</span> {

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/items/{id}</span><span class="delimiter">&quot;</span></span>)
    Item getItemById(<span class="type">int</span> id);

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/orders/{id}</span><span class="delimiter">&quot;</span></span>)
    Order getOrderById(<span class="type">int</span> id);

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/users/{id}</span><span class="delimiter">&quot;</span></span>)
    User getUsersById(<span class="type">int</span> id);

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/users</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">List</span>&lt;User&gt; getUsers();

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/items</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">List</span>&lt;Item&gt; getItems();

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/orders</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">List</span>&lt;Order&gt; getOrders();

    <span class="annotation">@Post</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/orders</span><span class="delimiter">&quot;</span></span>)
    Order createOrder(<span class="annotation">@Body</span> Order order);

    <span class="annotation">@Post</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/users</span><span class="delimiter">&quot;</span></span>)
    User createUser(<span class="annotation">@Body</span> User user);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>HealthTest</code> checks that there is <code>/health</code> endpoint that is required for service discovery.</p>
</div>
<div class="listingblock">
<div class="title">api/src/test/java/example/micronaut/HealthTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut</span>;

<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpRequest</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpStatus</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.HttpClient</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.annotation.Client</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;

<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertEquals</span>;

<span class="annotation">@MicronautTest</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">class</span> <span class="class">HealthTest</span> {

    <span class="annotation">@Inject</span>
    <span class="annotation">@Client</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>)
    HttpClient client; <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> healthEndpointExposed() {
        HttpStatus status = client.toBlocking().retrieve(HttpRequest.GET(<span class="string"><span class="delimiter">&quot;</span><span class="content">/health</span><span class="delimiter">&quot;</span></span>), HttpStatus.class);
        assertEquals(HttpStatus.OK, status);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject the <code>HttpClient</code> bean and point it to the embedded server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>GatewayControllerTest</code> tests endpoints inside the <code>GatewayController</code>.</p>
</div>
<div class="listingblock">
<div class="title">api/src/test/java/example/micronaut/GatewayControllerTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">example.micronaut</span>;

<span class="keyword">import</span> <span class="include">example.micronaut.clients.OrdersClient</span>;
<span class="keyword">import</span> <span class="include">example.micronaut.clients.UsersClient</span>;
<span class="keyword">import</span> <span class="include">example.micronaut.models.Item</span>;
<span class="keyword">import</span> <span class="include">example.micronaut.models.Order</span>;
<span class="keyword">import</span> <span class="include">example.micronaut.models.User</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpResponse</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpStatus</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.exceptions.HttpClientResponseException</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.test.annotation.MockBean</span>;
<span class="keyword">import</span> <span class="include">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span>;
<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>;
<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;
<span class="keyword">import</span> <span class="include">reactor.core.publisher.Flux</span>;
<span class="keyword">import</span> <span class="include">reactor.core.publisher.Mono</span>;

<span class="keyword">import</span> <span class="include">java.math.BigDecimal</span>;
<span class="keyword">import</span> <span class="include">java.util.ArrayList</span>;
<span class="keyword">import</span> <span class="include">java.util.Arrays</span>;
<span class="keyword">import</span> <span class="include">java.util.List</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertEquals</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertNotNull</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertNull</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertThrows</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.junit.jupiter.api.Assertions.assertTrue</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.mockito.ArgumentMatchers.any</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.mockito.Mockito.mock</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.mockito.Mockito.when</span>;

<span class="annotation">@MicronautTest</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">class</span> <span class="class">GatewayControllerTest</span> {

    <span class="annotation">@Inject</span>
    OrdersClient ordersClient;

    <span class="annotation">@Inject</span>
    UsersClient usersClient;

    <span class="annotation">@Inject</span>
    GatewayClient gatewayClient;

    <span class="annotation">@MockBean</span>(OrdersClient.class)
    OrdersClient ordersClient() {
        <span class="keyword">return</span> mock(OrdersClient.class);
    }

    <span class="annotation">@MockBean</span>(UsersClient.class)
    UsersClient usersClient() {
        <span class="keyword">return</span> mock(UsersClient.class);
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> getItemById() {
        <span class="type">int</span> itemId = <span class="integer">1</span>;
        Item item = <span class="keyword">new</span> Item(itemId, <span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">BigDecimal</span>.ONE);

        when(ordersClient.getItemsById(<span class="integer">1</span>)).thenReturn(item);

        Item retrievedItem = gatewayClient.getItemById(item.id());

        assertEquals(item.id(), retrievedItem.id());
        assertEquals(item.name(), retrievedItem. name());
        assertEquals(item.price(), retrievedItem.price());

    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> getOrderById() {

        Order order = <span class="keyword">new</span> Order(<span class="integer">1</span>, <span class="integer">2</span>, <span class="predefined-constant">null</span>, <span class="predefined-constant">null</span>, <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(), <span class="predefined-constant">null</span>);
        User user = <span class="keyword">new</span> User(order.userId(), <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>);

        when(ordersClient.getOrderById(<span class="integer">1</span>)).thenReturn(order);
        when(usersClient.getById(user.id())).thenReturn(user);

        Order retrievedOrder = gatewayClient.getOrderById(order.id());

        assertEquals(order.id(), retrievedOrder.id());
        assertEquals(order.userId(), retrievedOrder.user().id());
        assertNull(retrievedOrder.userId());
        assertEquals(user.username(), retrievedOrder.user().username());
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> getUserById() {
        User user = <span class="keyword">new</span> User(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>);

        when(usersClient.getById(<span class="integer">1</span>)).thenReturn(user);

        User retrievedUser = gatewayClient.getUsersById(user.id());

        assertEquals(user.id(), retrievedUser.id());
        assertEquals(user.username(), retrievedUser.username());
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> getUsers() {
        User user = <span class="keyword">new</span> User(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>);

        when(usersClient.getUsers()).thenReturn(<span class="predefined-type">List</span>.of(user));

        <span class="predefined-type">List</span>&lt;User&gt; users = gatewayClient.getUsers();

        assertNotNull(users);
        assertEquals(<span class="integer">1</span>, users.size());
        assertEquals(user.id(), users.get(<span class="integer">0</span>).id());
        assertEquals(user.username(), users.get(<span class="integer">0</span>).username());
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> getItems() {

        Item item = <span class="keyword">new</span> Item(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">BigDecimal</span>.ONE);

        when(ordersClient.getItems()).thenReturn(<span class="predefined-type">List</span>.of(item));

        <span class="predefined-type">List</span>&lt;Item&gt; items = gatewayClient.getItems();

        assertNotNull(items);
        assertEquals(<span class="integer">1</span>, items.size());
        assertEquals(item.name(), items.get(<span class="integer">0</span>).name());
        assertEquals(item.price(), items.get(<span class="integer">0</span>).price());
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> getOrders() {
        Order order = <span class="keyword">new</span> Order(<span class="integer">1</span>, <span class="integer">2</span>, <span class="predefined-constant">null</span>, <span class="predefined-constant">null</span>, <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(), <span class="predefined-constant">null</span>);
        User user = <span class="keyword">new</span> User(order.userId(), <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>);

        when(ordersClient.getOrders()).thenReturn(<span class="predefined-type">List</span>.of(order));
        when(usersClient.getById(order.userId())).thenReturn(user);

        <span class="predefined-type">List</span>&lt;Order&gt; orders = gatewayClient.getOrders();

        assertNotNull(orders);
        assertEquals(<span class="integer">1</span>, orders.size());
        assertNull(orders.get(<span class="integer">0</span>).userId());
        assertEquals(user.id(), orders.get(<span class="integer">0</span>).user().id());

        assertEquals(order.id(), orders.get(<span class="integer">0</span>).id());
        assertEquals(user.username(), orders.get(<span class="integer">0</span>).user().username());
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> createUser() {
        <span class="predefined-type">String</span> firstName = <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>;
        <span class="predefined-type">String</span> lastName = <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span>;
        <span class="predefined-type">String</span> username = <span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>;

        User user = <span class="keyword">new</span> User(<span class="integer">0</span>, firstName, lastName, username);

        when(usersClient.createUser(any())).thenReturn(user);

        User createdUser = gatewayClient.createUser(user);

        assertEquals(firstName, createdUser.firstName());
        assertEquals(lastName, createdUser.lastName());
        assertEquals(username, createdUser.username());
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> createOrder() {
        Order order = <span class="keyword">new</span> Order(<span class="integer">1</span>, <span class="integer">2</span>, <span class="predefined-constant">null</span>, <span class="predefined-constant">null</span>, <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(), <span class="predefined-constant">null</span>);
        User user = <span class="keyword">new</span> User(order.userId(), <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>);

        when(usersClient.getById(user.id())).thenReturn(user);

        when(ordersClient.createOrder(any())).thenReturn(order);

        Order createdOrder = gatewayClient.createOrder(order);

        assertEquals(order.id(), createdOrder.id());
        assertNull(createdOrder.userId());
        assertEquals(order.userId(), createdOrder.user().id());
        assertEquals(user.username(), createdOrder.user().username());
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> createOrderUserDoesntExists() {
        Order order = <span class="keyword">new</span> Order(<span class="integer">1</span>, <span class="integer">2</span>, <span class="predefined-constant">null</span>, <span class="predefined-constant">null</span>, <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(), <span class="keyword">new</span> <span class="predefined-type">BigDecimal</span>(<span class="integer">0</span>));;

        when(ordersClient.createOrder(any())).thenReturn(order);

        when(usersClient.getById(order.userId())).thenReturn(<span class="predefined-constant">null</span>);

        HttpClientResponseException exception = assertThrows(HttpClientResponseException.class, () -&gt; gatewayClient.createOrder(order));

        assertEquals(HttpStatus.BAD_REQUEST,exception.getStatus());

        assertTrue(exception.getResponse().getBody(<span class="predefined-type">String</span>.class).orElse(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>).contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">User with id 2 doesn't exist</span><span class="delimiter">&quot;</span></span>));
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> exceptionHandler() {
        User user = <span class="keyword">new</span> User(<span class="integer">1</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">firstname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">lastname</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>);

        <span class="predefined-type">String</span> message = <span class="string"><span class="delimiter">&quot;</span><span class="content">Test error message</span><span class="delimiter">&quot;</span></span>;

        when(usersClient.createUser(any())).thenThrow(<span class="keyword">new</span> HttpClientResponseException(<span class="string"><span class="delimiter">&quot;</span><span class="content">Test</span><span class="delimiter">&quot;</span></span>, HttpResponse.badRequest(message)));

        HttpClientResponseException exception = assertThrows(HttpClientResponseException.class, () -&gt; gatewayClient.createUser(user));

        assertEquals(HttpStatus.BAD_REQUEST,exception.getStatus());

        assertTrue(exception.getResponse().getBody(<span class="predefined-type">String</span>.class).orElse(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>).contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">Test error message</span><span class="delimiter">&quot;</span></span>));
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit <em>application.yml</em></p>
</div>
<div class="listingblock">
<div class="title">api/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">api</span></span>
<span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="content">${username} </span></span><i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">password</span>: <span class="string"><span class="content">${password} </span></span><i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Placeholder for username that will be populated by Kubernetes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Placeholder for password that will be populated by Kubernetes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit the <em>bootstrap.yml</em> file in the <em>resources</em> directory to <a href="https://docs.micronaut.io/latest/guide/#bootstrap">enable distributed configuration</a> so it looks like the following:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/resources/bootstrap.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">api</span></span>
  <span class="key">config-client</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="key">kubernetes</span>:
  <span class="key">client</span>:
    <span class="key">secrets</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="2"></i><b>(2)</b>
      <span class="key">use-api</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>microanut.config-client.enabled: true</code> to read and resolve configuration from distributed sources.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set <code>kubernetes.client.secrets.enabled: true</code> to enable Kubernetes secrets as a distributed source.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set <code>kubernetes.client.secrets.use-api: true</code> to use the  Kubernetes API to fetch configuration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/application-dev.yml</code>. The Micronaut framework applies this configuration file only for the <code>dev</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/resources/application-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_username</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_password</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hardcoded username for development environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded password for development environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>bootstrap-dev.yml</em> to disable distributed configuration in the dev environment:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/resources/bootstrap-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">http</span>:
    <span class="key">services</span>:
      <span class="key">users</span>:
        <span class="key">urls</span>:
          - <span class="string"><span class="content">http://localhost:8081 </span></span><i class="conum" data-value="1"></i><b>(1)</b>
      <span class="key">orders</span>:
        <span class="key">urls</span>:
          - <span class="string"><span class="content">http://localhost:8082 </span></span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="key">kubernetes</span>:
  <span class="key">client</span>:
    <span class="key">secrets</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">false </span></span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>URL of the <code>users</code> microservice</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>URL of the <code>orders</code> microservice</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Disable Kubernetes secrets client.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>application-test.yml</em> to be used in the test environment:</p>
</div>
<div class="listingblock">
<div class="title">api/src/test/resources/application-test.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_username</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_password</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hardcoded username for development environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded password for development environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the unit test:</p>
</div>
<div class="listingblock">
<div class="title">api</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./gradlew test</code></pre>
</div>
</div>
<div class="paragraph">
<p><br></p>
</div>
</div>
<div class="sect3">
<h4 id="running-the-application-3">4.3.2. Running the application</h4>
<div class="paragraph">
<p>Run <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">api</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">MICRONAUT_ENVIRONMENTS=dev ./gradlew run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="test-integration-between-applications">4.4. Test integration between applications</h3>
<div class="paragraph">
<p>Store the URL of the <code>api</code> microservice in the <code>API_URL</code> environment variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">export API_URL=http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run a cURL command to create a new user via the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X &quot;POST&quot; &quot;$API_URL/api/users&quot; -H 'Content-Type: application/json; charset=utf-8' -d '{ &quot;first_name&quot;: &quot;Nemanja&quot;, &quot;last_name&quot;: &quot;Mikic&quot;, &quot;username&quot;: &quot;nmikic&quot; }'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">nmikic</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Nemanja</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Mikic</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run a cURL command to a new order via the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X &quot;POST&quot; &quot;$API_URL/api/orders&quot; -H 'Content-Type: application/json; charset=utf-8' -d '{ &quot;user_id&quot;: 1, &quot;item_ids&quot;: [1,2] }'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Nemanja</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Mikic</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">nmikic</span><span class="delimiter">&quot;</span></span>},<span class="key"><span class="delimiter">&quot;</span><span class="content">items</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Banana</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>:<span class="float">1.5</span>},{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">2</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Kiwi</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>:<span class="float">2.5</span>}],<span class="key"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>:<span class="float">4.0</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run a cURL command to list created orders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl &quot;$API_URL/api/orders&quot; -H 'Content-Type: application/json; charset=utf-8'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">[{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Nemanja</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Mikic</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">nmikic</span><span class="delimiter">&quot;</span></span>},<span class="key"><span class="delimiter">&quot;</span><span class="content">items</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Banana</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>:<span class="float">1.5</span>},{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">2</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Kiwi</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>:<span class="float">2.5</span>}],<span class="key"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>:<span class="float">4.0</span>}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can try to place an order for a user who doesn&#8217;t exist (with id 100). Run a cURL command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X &quot;POST&quot; &quot;$API_URL/api/orders&quot; -H 'Content-Type: application/json; charset=utf-8' -d '{ &quot;user_id&quot;: 100, &quot;item_ids&quot;: [1,2] }'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Bad Request</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">_links</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">self</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">href</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/orders</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">templated</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>}]},<span class="key"><span class="delimiter">&quot;</span><span class="content">_embedded</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">errors</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">User with id 100 doesn't exist</span><span class="delimiter">&quot;</span></span>}]}}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kubernetes-and-the-micronaut-framework">5. Kubernetes and the Micronaut framework</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we will first create the necessary Kubernetes resources for our microservices that will make them work properly then we will configure, build container images and deploy each of the microservices that we created on the local Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>Create a filed named <em>auth.yml</em>  that will service role for microservices that have secret configurations.</p>
</div>
<div class="listingblock">
<div class="title">auth.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Namespace </span></span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
<span class="head"><span class="head">---</span></span>
<span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">ServiceAccount </span></span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="content">micronaut-service</span></span>
<span class="head"><span class="head">---</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Role </span></span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="key">apiVersion</span>: <span class="string"><span class="content">rbac.authorization.k8s.io/v1</span></span>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="content">micronaut_service_role</span></span>
<span class="key">rules</span>:
  - <span class="string"><span class="content">apiGroups: [&quot;&quot;]</span></span>
    <span class="key">resources</span>: <span class="string"><span class="content">[&quot;services&quot;, &quot;endpoints&quot;, &quot;configmaps&quot;, &quot;secrets&quot;, &quot;pods&quot;]</span></span>
    <span class="key">verbs</span>: <span class="string"><span class="content">[&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]</span></span>
<span class="head"><span class="head">---</span></span>
<span class="key">apiVersion</span>: <span class="string"><span class="content">rbac.authorization.k8s.io/v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">RoleBinding </span></span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="content">micronaut_service_role_bind</span></span>
<span class="key">subjects</span>:
  - <span class="string"><span class="content">kind: ServiceAccount</span></span>
    <span class="key">name</span>: <span class="string"><span class="content">micronaut-service</span></span>
<span class="key">roleRef</span>:
  <span class="key">kind</span>: <span class="string"><span class="content">Role</span></span>
  <span class="key">name</span>: <span class="string"><span class="content">micronaut_service_role</span></span>
  <span class="key">apiGroup</span>: <span class="string"><span class="content">rbac.authorization.k8s.io</span></span>
<span class="head"><span class="head">---</span></span>
<span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Secret </span></span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="content">mysecret</span></span>
<span class="key">type</span>: <span class="string"><span class="content">Opaque</span></span>
<span class="key">data</span>:
  <span class="key">username</span>: <span class="string"><span class="content">YWRtaW4= </span></span><i class="conum" data-value="6"></i><b>(6)</b>
  <span class="key">password</span>: <span class="string"><span class="content">bWljcm9uYXV0aXNhd2Vzb21l </span></span><i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We create a namespace named <code>micronaut-k8s</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We create a service account named <code>micronaut-service</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We create a role named <code>micronaut_service_role</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We bind  the <code>micronaut_service_role</code> role to the <code>micronaut-service</code> service account.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We create a secret named <code>mysecret</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Base64 value of the username secret that will be used by the microservices.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Base64 value of the password secret that will be used by the microservices.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the next command to create the resources described above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -f auth.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before we start deploying each service, ensure that Docker daemon is configured to use Kubernetes.
If you are using <a href="https://minikube.sigs.k8s.io/">Minikube</a> run the next command to switch the docker daemon to use Minikube.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">eval $(minikube docker-env)</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="users-microservice-2">5.1. Users Microservice</h3>
<div class="paragraph">
<p><a href="https://guides.micronaut.io/latest/micronaut-docker-image.html">Build a docker image</a> of the <code>users</code> service with the name <code>users</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to build a docker Native image with <code>dockerBuildNative</code> and you are using <a href="https://minikube.sigs.k8s.io/">Minikube</a> make sure that it is configured with enough memory. If you keep getting "Read timeout error" try to build image using <code>docker build . -t users -f DockerfileNative</code> inside <code>users/build/docker/native-main</code> directory.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit the file named <em>k8s.yml</em> inside the <code>users</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">/users/k8s.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">apps/v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Deployment</span></span>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span>
<span class="key">spec</span>:
  <span class="key">selector</span>:
    <span class="key">matchLabels</span>:
      <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span>
  <span class="key">template</span>:
    <span class="key">metadata</span>:
      <span class="key">labels</span>:
        <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span>
    <span class="key">spec</span>:
      <span class="key">serviceAccountName</span>: <span class="string"><span class="content">micronaut-service </span></span><i class="conum" data-value="1"></i><b>(1)</b>
      <span class="key">containers</span>:
        - <span class="string"><span class="content">name: &quot;users&quot;</span></span>
          <span class="key">image</span>: <span class="string"><span class="content">users </span></span><i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">imagePullPolicy</span>: <span class="string"><span class="content">Never </span></span><i class="conum" data-value="3"></i><b>(3)</b>
          <span class="key">ports</span>:
            - <span class="string"><span class="content">name: http</span></span>
              <span class="key">containerPort</span>: <span class="string"><span class="content">8080</span></span>
          <span class="key">readinessProbe</span>:
            <span class="key">httpGet</span>:
              <span class="key">path</span>: <span class="string"><span class="content">/health/readiness</span></span>
              <span class="key">port</span>: <span class="string"><span class="content">8080</span></span>
            <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">5</span></span>
            <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">3</span></span>
          <span class="key">livenessProbe</span>:
            <span class="key">httpGet</span>:
              <span class="key">path</span>: <span class="string"><span class="content">/health/liveness</span></span>
              <span class="key">port</span>: <span class="string"><span class="content">8080</span></span>
            <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">5</span></span>
            <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">3</span></span>
            <span class="key">failureThreshold</span>: <span class="string"><span class="content">10</span></span>
<span class="head"><span class="head">---</span></span>
<span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Service</span></span>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="key">spec</span>:
  <span class="key">selector</span>:
    <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span>
  <span class="key">type</span>: <span class="string"><span class="content">NodePort</span></span>
  <span class="key">ports</span>:
    - <span class="string"><span class="content">protocol: &quot;TCP&quot;</span></span>
      <span class="key">port</span>: <span class="string"><span class="content">8080  </span></span><i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The service name that we created in the <em>auth.yaml</em> file.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The name of the container image for deployment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The imagePullPolicy is set to Never. We will always use local one that we built in previous step.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Name of a service, required for service discovery.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Micronaut default port on which application is running.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the next command to create the resources described above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -f users/k8s.yml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">deployment.apps/users created
service/users created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="orders-microservice-2">5.2. Orders Microservice</h3>
<div class="paragraph">
<p><a href="https://guides.micronaut.io/latest/micronaut-docker-image.html">Build a docker image</a> of the <code>orders</code> service with the name <code>orders</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to build a docker Native image with <code>dockerBuildNative</code> and you are using <a href="https://minikube.sigs.k8s.io/">Minikube</a> make sure that it is configured with enough memory. If you keep getting "Read timeout error" try to build image using <code>docker build . -t orders -f DockerfileNative</code> inside <code>orders/build/docker/native-main</code> directory.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit the file named <em>k8s.yml</em> inside the <code>orders</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">/orders/k8s.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">apps/v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Deployment</span></span>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">orders</span><span class="delimiter">&quot;</span></span>
<span class="key">spec</span>:
  <span class="key">selector</span>:
    <span class="key">matchLabels</span>:
      <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">orders</span><span class="delimiter">&quot;</span></span>
  <span class="key">template</span>:
    <span class="key">metadata</span>:
      <span class="key">labels</span>:
        <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">orders</span><span class="delimiter">&quot;</span></span>
    <span class="key">spec</span>:
      <span class="key">serviceAccountName</span>: <span class="string"><span class="content">micronaut-service  </span></span><i class="conum" data-value="1"></i><b>(1)</b>
      <span class="key">containers</span>:
        - <span class="string"><span class="content">name: &quot;orders&quot;</span></span>
          <span class="key">image</span>: <span class="string"><span class="content">orders  </span></span><i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">imagePullPolicy</span>: <span class="string"><span class="content">Never  </span></span><i class="conum" data-value="3"></i><b>(3)</b>
          <span class="key">ports</span>:
            - <span class="string"><span class="content">name: http</span></span>
              <span class="key">containerPort</span>: <span class="string"><span class="content">8080</span></span>
          <span class="key">readinessProbe</span>:
            <span class="key">httpGet</span>:
              <span class="key">path</span>: <span class="string"><span class="content">/health/readiness</span></span>
              <span class="key">port</span>: <span class="string"><span class="content">8080</span></span>
            <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">5</span></span>
            <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">3</span></span>
          <span class="key">livenessProbe</span>:
            <span class="key">httpGet</span>:
              <span class="key">path</span>: <span class="string"><span class="content">/health/liveness</span></span>
              <span class="key">port</span>: <span class="string"><span class="content">8080</span></span>
            <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">5</span></span>
            <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">3</span></span>
            <span class="key">failureThreshold</span>: <span class="string"><span class="content">10</span></span>
<span class="head"><span class="head">---</span></span>
<span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Service</span></span>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">orders</span><span class="delimiter">&quot;</span></span>  <i class="conum" data-value="4"></i><b>(4)</b>
<span class="key">spec</span>:
  <span class="key">selector</span>:
    <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">orders</span><span class="delimiter">&quot;</span></span>
  <span class="key">type</span>: <span class="string"><span class="content">NodePort</span></span>
  <span class="key">ports</span>:
    - <span class="string"><span class="content">protocol: &quot;TCP&quot;</span></span>
      <span class="key">port</span>: <span class="string"><span class="content">8080  </span></span><i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The service name that we created in the <em>auth.yaml</em> file.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The name of the container image for deployment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The imagePullPolicy is set to Never. We will always use local one that we built in previous step.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Name of a service, required for service discovery.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Micronaut default port on which application is running.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the next command to create the resources described above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -f orders/k8s.yml</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="api-gateway-microservice-2">5.3. API (Gateway) Microservice</h3>
<div class="paragraph">
<p><a href="https://guides.micronaut.io/latest/micronaut-docker-image.html">Build a docker image</a> of the <code>api</code> service with the name <code>api</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to build a docker Native image with <code>dockerBuildNative</code> and you are using <a href="https://minikube.sigs.k8s.io/">Minikube</a> make sure that it is configured with enough memory. If you keep getting "Read timeout error" try to build image using <code>docker build . -t api -f DockerfileNative</code> inside <code>api/build/docker/native-main</code> directory.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit the file named <em>k8s.yml</em> inside the <code>api</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">/api/k8s.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">apps/v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Deployment</span></span>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">api</span><span class="delimiter">&quot;</span></span>
<span class="key">spec</span>:
  <span class="key">selector</span>:
    <span class="key">matchLabels</span>:
      <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">api</span><span class="delimiter">&quot;</span></span>
  <span class="key">template</span>:
    <span class="key">metadata</span>:
      <span class="key">labels</span>:
        <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">api</span><span class="delimiter">&quot;</span></span>
    <span class="key">spec</span>:
      <span class="key">serviceAccountName</span>: <span class="string"><span class="content">micronaut-service </span></span><i class="conum" data-value="1"></i><b>(1)</b>
      <span class="key">containers</span>:
        - <span class="string"><span class="content">name: &quot;api&quot;</span></span>
          <span class="key">image</span>: <span class="string"><span class="content">api  </span></span><i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">imagePullPolicy</span>: <span class="string"><span class="content">Never  </span></span><i class="conum" data-value="3"></i><b>(3)</b>
          <span class="key">ports</span>:
            - <span class="string"><span class="content">name: http</span></span>
              <span class="key">containerPort</span>: <span class="string"><span class="content">8080</span></span>
          <span class="key">readinessProbe</span>:
            <span class="key">httpGet</span>:
              <span class="key">path</span>: <span class="string"><span class="content">/health/readiness</span></span>
              <span class="key">port</span>: <span class="string"><span class="content">8080</span></span>
            <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">5</span></span>
            <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">3</span></span>
          <span class="key">livenessProbe</span>:
            <span class="key">httpGet</span>:
              <span class="key">path</span>: <span class="string"><span class="content">/health/liveness</span></span>
              <span class="key">port</span>: <span class="string"><span class="content">8080</span></span>
            <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">5</span></span>
            <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">3</span></span>
            <span class="key">failureThreshold</span>: <span class="string"><span class="content">10</span></span>
<span class="head"><span class="head">---</span></span>
<span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Service</span></span>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">api</span><span class="delimiter">&quot;</span></span>  <i class="conum" data-value="4"></i><b>(4)</b>
<span class="key">spec</span>:
  <span class="key">selector</span>:
    <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">api</span><span class="delimiter">&quot;</span></span>
  <span class="key">type</span>: <span class="string"><span class="content">LoadBalancer</span></span>
  <span class="key">ports</span>:
    - <span class="string"><span class="content">protocol: &quot;TCP&quot;</span></span>
      <span class="key">port</span>: <span class="string"><span class="content">8080  </span></span><i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The service name that we created in the <em>auth.yaml</em> file.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The name of the container image for deployment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The imagePullPolicy is set to Never. We will always use local one that we built in previous step.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Name of a service, required for service discovery.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Micronaut default port on which application is running.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the next command to create the resources described above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -f api/k8s.yml</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="test-integration-between-applications-deployed-on-kubernetes">5.4. Test integration between applications deployed on Kubernetes</h3>
<div class="paragraph">
<p>Run the next command to check status of the pods and make sure that all of them have the status "Running":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl get pods -n=micronaut-k8s</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">NAME                      READY   STATUS    RESTARTS   AGE
api-774fd667b9-dmws4      1/1     Running   0          24s
orders-74ff4fcbc4-dnfbw   1/1     Running   0          19s
users-9f46dd7c6-vs8z7     1/1     Running   0          13s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the next command to check the status of the microservices:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl get services -n=micronaut-k8s</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="minikube">5.4.1. Minikube</h4>
<div class="paragraph">
<p>For Minikube the output should be similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">NAME     TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
api      LoadBalancer   10.110.42.201    &lt;pending&gt;     8080:32601/TCP   18s
orders   NodePort       10.105.43.19     &lt;none&gt;        8080:31033/TCP   21s
users    NodePort       10.104.130.114   &lt;none&gt;        8080:31482/TCP   26s</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, the EXTERNAL-IP address  of the LoadBalancer service inside Minikube will be in the &lt;pending&gt; state. If you want to assign an external ip you have to run the <code>minikube tunnel</code> command.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the next command to retrieve the URL of the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">export API_URL=$(minikube service api -n=micronaut-k8s --url)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="docker-desktop">5.4.2. Docker Desktop</h4>
<div class="paragraph">
<p>For Docker Desktop&#8217;s Kubernetes integration the output should be similar to the following.  Notice the external-ip is <code>localhost</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">NAME     TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
api      LoadBalancer   10.108.205.248   localhost     8080:31516/TCP   9m23s
orders   NodePort       10.98.120.224    &lt;none&gt;        8080:31566/TCP   9m39s
users    NodePort       10.109.155.86    &lt;none&gt;        8080:30545/TCP   10m</code></pre>
</div>
</div>
<div class="paragraph">
<p>So for Docker Desktop the <code>API_URL</code> should be set to <code><a href="http://localhost:8080" class="bare">http://localhost:8080</a></code>.</p>
</div>
<div class="paragraph">
<p>Run a cURL command to create a new user via the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X &quot;POST&quot; &quot;$API_URL/api/users&quot; -H 'Content-Type: application/json; charset=utf-8' -d '{ &quot;first_name&quot;: &quot;Nemanja&quot;, &quot;last_name&quot;: &quot;Mikic&quot;, &quot;username&quot;: &quot;nmikic&quot; }'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">nmikic</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Nemanja</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Mikic</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run a cURL command to a new order via the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X &quot;POST&quot; &quot;$API_URL/api/orders&quot; -H 'Content-Type: application/json; charset=utf-8' -d '{ &quot;user_id&quot;: 1, &quot;item_ids&quot;: [1,2] }'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Nemanja</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Mikic</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">nmikic</span><span class="delimiter">&quot;</span></span>},<span class="key"><span class="delimiter">&quot;</span><span class="content">items</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Banana</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>:<span class="float">1.5</span>},{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">2</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Kiwi</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>:<span class="float">2.5</span>}],<span class="key"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>:<span class="float">4.0</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run a cURL command to list created orders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl &quot;$API_URL/api/orders&quot; -H 'Content-Type: application/json; charset=utf-8'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">[{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Nemanja</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Mikic</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">nmikic</span><span class="delimiter">&quot;</span></span>},<span class="key"><span class="delimiter">&quot;</span><span class="content">items</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Banana</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>:<span class="float">1.5</span>},{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">2</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Kiwi</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>:<span class="float">2.5</span>}],<span class="key"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>:<span class="float">4.0</span>}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can try to place an order for a user who doesn&#8217;t exist (with id 100). Run a cURL command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X &quot;POST&quot; &quot;$API_URL/api/orders&quot; -H 'Content-Type: application/json; charset=utf-8' -d '{ &quot;user_id&quot;: 100, &quot;item_ids&quot;: [1,2] }'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Bad Request</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">_links</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">self</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">href</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/orders</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">templated</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>}]},<span class="key"><span class="delimiter">&quot;</span><span class="content">_embedded</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">errors</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">User with id 100 doesn't exist</span><span class="delimiter">&quot;</span></span>}]}}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cleaning-up">6. Cleaning Up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To delete all resources that were created in this guide run next command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl delete namespaces micronaut-k8s</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="next-steps">7. Next steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Read more about <a href="https://kubernetes.io/docs/home/">Kubernetes</a>.</p>
</div>
<div class="paragraph">
<p>Read more about <a href="https://micronaut-projects.github.io/micronaut-kubernetes/snapshot/guide/">Micronaut Kubernetes</a> module.</p>
</div>

            </div>
        </div>
    </div>
</main>

<footer id="footer">
    <div class="container">

        <div class="row">
            <div class="col-sm-5 footer-left">

                <div id="text-14" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <img class="alignnone size-medium wp-image-3736" src="./images/micronaut_foundation_horizontal_white.svg" alt="Micronaut Foundation"/>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-sm-7 footer-right">

                <ul class="meta">

                    <li id="menu-item-2895" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2895">
                        <a href="https://micronaut.io/brand-guidelines/">Brand Guidelines</a>
                    </li>
                    <li id="menu-item-2894" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2894">
                        <a href="https://micronaut.io/community-guidelines/">Community Guidelines</a>
                    </li>
                    <li id="menu-item-3377" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-privacy-policy menu-item-3377">
                        <a href="https://micronaut.io/privacy-policy/">Privacy Policy</a>
                    </li>

                </ul>

                <div id="nav_menu-2" class="widget widget_nav_menu">
                    <div class="menu-links-container">
                        <ul id="menu-links" class="menu">
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronautpodcast.com"><i class="fa fa-podcast"><span class="sr-only">Podcast</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronaut.io/feed/rss/"><i class="fa fa-feed"><span class="sr-only">Feed</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="mailto:info@micronaut.io"><i class="fas fa-envelope"><span class="sr-only">Mail</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://twitter.com/micronautfw"><i class="fab fa-twitter"><span class="sr-only">Twitter</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://matrix.to/#/#micronautfw_questions:gitter.im"><i class="fab fa-gitter"><span class="sr-only">Gitter</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://github.com/micronaut-projects/"><i class="fab fa-github"><span class="sr-only">GitHub</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.youtube.com/@MicronautFramework"><i class="fab fa-youtube"><span class="sr-only">YouTube</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.linkedin.com/showcase/micronaut"><i class="fab fa-linkedin"><span class="sr-only">LinkedIn</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.twitch.tv/micronautfw"><i class="fab fa-twitch"><span class="sr-only">Twitch</span></i></a></li>
                        </ul>
                    </div>
                </div>
                <div id="text-5" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <small>© 2023 MICRONAUT FOUNDATION. ALL RIGHTS RESERVED</small>
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</footer>
</body>
</html>
