<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'/>
    <title>Oracle Cloud Streaming and the Micronaut Framework - Event-Driven Applications at Scale</title>
    <link rel='stylesheet' id='wp-block-library-css' href='https://micronaut.io/wp-includes/css/dist/block-library/style.min.css' type='text/css' media='all'/>
    <link rel='stylesheet' id='fonts-fira-sans-css' href='https://fonts.googleapis.com/css2?family=Fira+Sans%3Awght%40300%3B500&#038;display=swap&#038;ver=5.7' type='text/css' media='all'/>
    <link rel='stylesheet' id='micronaut-style-css' href='https://micronaut.io/wp-content/themes/micronaut/style.min.css' type='text/css' media='all'/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link rel="shortcut icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link rel="alternate" type="application/rss+xml" title="Micronaut Guides RSS Feed" href="https://guides.micronaut.io/latest/rss.xml" />
    <link rel="alternate" type="application/json" title="Micronaut Guides JSON Feed" href="https://guides.micronaut.io/latest/feed.json" />
    <link href="coderay.css" rel="stylesheet" />
    <link href="rouge-github.css" rel="stylesheet" />
    <link href="guide.css" rel="stylesheet" />
    <script src="lunr.js"></script>
    <script src="guide.js"></script>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://guides.micronaut.io/latest/images/cards/micronaut-oracle-cloud-streaming.png"/>
    <meta name="twitter:creator" content="@micronautfw"/>
    <meta name="twitter:site" content="@micronautfw"/>
    <meta name="twitter:title" content="Oracle Cloud Streaming and the Micronaut Framework - Event-Driven Applications at Scale"/>
    <meta name="twitter:description" content="Use Oracle Cloud Streaming to communicate between your Micronaut applications."/>
</head>
<body class="page-template page-template-page-sidebar page-template-page-sidebar-php page page-parent guide">

<header id="header">

    <div class="container">

        <nav class="navbar navbar-expand-lg navbar-dark">

            <button class="collapsed" type="button" data-toggle="collapse" data-target="#nav" aria-expanded="false">
                <span></span>
            </button>

            <a class="navbar-brand" href="https://micronaut.io">
                <img src="https://micronaut.io/wp-content/uploads/2020/11/MIcronautLogo_Horizontal.svg" alt="Micronaut framework"/>
            </a>

            <div class="collapse navbar-collapse" id="nav">

                <ul class="navbar-nav ml-auto">

                    <li id="menu-item-2865" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2865 nav-item"><a href="https://micronaut.io/download/" class="nav-link">Download</a></li>
                    <li id="menu-item-2868" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-2868 dropdown nav-item"><a href="https://micronaut.io/learn/" class="nav-link dropdown-toggle" data-toggle="dropdown">Learn</a><ul class="dropdown-menu">
                        <li id="menu-item-4943" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4943"><a href="https://micronaut.io/learn/" class="dropdown-item">Overview</a></li>
                        <li id="menu-item-5111" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-5111"><a href="https://docs.micronaut.io/index.html" class="dropdown-item">User Documentaton</a></li>
                        <li id="menu-item-4510" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4510"><a href="https://micronaut.io/guides/" class="dropdown-item">Guides</a></li>
                        <li id="menu-item-2896" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2896"><a href="https://micronaut.io/category/microcast/" class="dropdown-item">Microcasts</a></li>
                        <li id="menu-item-2897" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2897"><a href="https://micronaut.io/category/webinar/" class="dropdown-item">Webinars</a></li>
                        <li id="menu-item-2871" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2871"><a href="https://micronaut.io/professional-training/" class="dropdown-item">Professional Training</a></li>
                        <li id="menu-item-6526" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-6526"><a href="https://micronaut-projects.github.io/micronaut-guides-mn3/latest/" class="dropdown-item">Guides for Micronaut Framework 3</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2878" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2878 dropdown nav-item"><a href="https://micronaut.io/resources/" class="nav-link dropdown-toggle" data-toggle="dropdown">Resources</a><ul class="dropdown-menu">
                        <li id="menu-item-4999" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4999"><a href="https://micronaut.io/upcoming-events/" class="dropdown-item">Upcoming Events</a></li>
                        <li id="menu-item-2879" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2879"><a href="https://micronaut.io/blog/" class="dropdown-item">Blog</a></li>
                        <li id="menu-item-6478" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6478"><a href="https://micronaut.io/category/release-announcements/" class="dropdown-item">Releases</a></li>
                        <li id="menu-item-6715" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6715"><a href="https://micronaut.io/category/security-announcements/" class="dropdown-item">Security Announcements</a></li>
                        <li id="menu-item-4499" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-4499"><a href="https://micronautpodcast.com/" class="dropdown-item">Podcast</a></li>
                        <li id="menu-item-5798" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5798"><a href="https://micronaut.io/support/" class="dropdown-item">Commercial Support</a></li>
                        <li id="menu-item-4186" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4186"><a href="https://micronaut.io/resources/community-support/" class="dropdown-item">Community Support</a></li>
                        <li id="menu-item-2882" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2882"><a href="https://micronaut.io/faq/" class="dropdown-item">FAQ</a></li>
                        <li id="menu-item-2883" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2883"><a href="https://micronaut.io/contact/" class="dropdown-item">Contact</a></li>
                        <li id="menu-item-6479" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6479"><a href="https://micronaut.io/micronaut-success-stories/" class="dropdown-item">Micronaut Success Stories</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2872" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2872 dropdown nav-item"><a href="https://micronaut.io/foundation/" class="nav-link dropdown-toggle" data-toggle="dropdown">Foundation</a><ul class="dropdown-menu">
                        <li id="menu-item-2877" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2877"><a href="https://micronaut.io/foundation/" class="dropdown-item">Overview</a></li>
                        <li id="menu-item-2874" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2874"><a href="https://micronaut.io/foundation/corporate-sponsorship/" class="dropdown-item">Corporate Sponsorship</a></li>
                        <li id="menu-item-2873" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2873"><a href="https://micronaut.io/foundation/community-sponsorship/" class="dropdown-item">Community Sponsorship</a></li>
                        <li id="menu-item-2876" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2876"><a href="https://micronaut.io/foundation/sponsors/" class="dropdown-item">Sponsors</a></li>
                        <li id="menu-item-3838" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-3838"><a href="https://micronaut.io/meeting-minutes/" class="dropdown-item">Meeting Minutes</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2884" class="action menu-item menu-item-type-custom menu-item-object-custom menu-item-2884 nav-item"><a target="_blank" rel="noopener" href="https://micronaut.io/launch/" class="nav-link">Launch</a></li>

                </ul>

            </div>

        </nav>

    </div>
</header>

<div style="background: #fff;padding-top: 20px;padding-bottom: 20px;">
    <div class="container" style="clear: both;">
        <fieldset style="float: right;">
            <input type="search" id="search-form-query"/>
            <input type="submit" onclick="search()" value="Search">
            <input type="submit" onclick="resetSearch()" value="Reset">
        </fieldset>
    </div>
    <div class="container" style="clear: both;margin-top: -20px;">
        <div class="guide-list" id="searchResults">
        </div>
    </div>
</div>
<div id="breadcrumbs"><div class="container"><a href="https://micronaut.io/">Home</a> » <a href="./index.html">Guides</a> » <a href="micronaut-oracle-cloud-streaming.html">Oracle Cloud Streaming and the Micronaut Framework - Event-Driven Applications at Scale</a> » <span class="breadcrumb_last" aria-current="page">maven | kotlin</span></div></div><!-- .breadcrumbs -->
<main id="main">
    <div class="container">
        <div class="row">
            <div class="col-md-4">

                <div class="toc">
                    <div class="inner">
                        <h1 class="title title_large first-word-bold first-word-break">Table of Contents</h1>
                        <div class="underline"></div>
                        
<ul class="sectlevel1">
<li><a href="#getting-started">1. Getting Started</a></li>
<li><a href="#what-you-will-need">2. What You Will Need</a></li>
<li><a href="#solution">3. Solution</a></li>
<li><a href="#writing-the-application">4. Writing the Application</a>
<ul class="sectlevel2">
<li><a href="#chess-game-microservice">4.1. chess-game Microservice</a></li>
<li><a href="#chess-listener-microservice">4.2. chess-listener Microservice</a></li>
</ul>
</li>
<li><a href="#kafka">5. Kafka</a>
<ul class="sectlevel2">
<li><a href="#install-kafka">5.1. Install Kafka</a></li>
</ul>
</li>
<li><a href="#running-the-application">6. Running the application</a></li>
<li><a href="#moving-to-oracle-cloud">7. Moving to Oracle Cloud</a>
<ul class="sectlevel2">
<li><a href="#oracle-autonomous-database-atp">7.1. Oracle Autonomous Database (ATP)</a></li>
<li><a href="#oracle-cloud-streaming">7.2. Oracle Cloud Streaming</a></li>
</ul>
</li>
<li><a href="#local-testing-with-cloud-resources">8. Local Testing with Cloud Resources</a></li>
<li><a href="#writing-tests">9. Writing Tests</a>
<ul class="sectlevel2">
<li><a href="#chess-game-tests">9.1. chess-game tests</a></li>
<li><a href="#chess-listener-tests">9.2. chess-listener tests</a></li>
<li><a href="#running-the-tests">9.3. Running the tests</a></li>
</ul>
</li>
<li><a href="#deploy-to-oci">10. Deploy to OCI</a>
<ul class="sectlevel2">
<li><a href="#instance-principal-authentication">10.1. Instance Principal authentication</a></li>
</ul>
</li>
<li><a href="#generate-micronaut-application-native-executables-with-graalvm">11. Generate Micronaut Application Native Executables with GraalVM</a>
<ul class="sectlevel2">
<li><a href="#native-executable-generation">11.1. Native Executable Generation</a></li>
<li><a href="#deployable-native-executables">11.2. Deployable Native Executables</a></li>
</ul>
</li>
<li><a href="#next-steps">12. Next Steps</a></li>
<li><a href="#license">13. License</a></li>
</ul>

                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <h1>Oracle Cloud Streaming and the Micronaut Framework - Event-Driven Applications at Scale</h1>
                <div class="underline"></div>
<div class="sect1">
<div class="sectionbody">

<div class="paragraph">
<p>Use Oracle Cloud Streaming to communicate between your Micronaut applications.</p>
</div>
<div class="paragraph">
<p>Authors: Burt Beckwith</p>
</div>
<div class="paragraph">
<p>Micronaut Version: 4.9.1</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started">1. Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this guide, we will create two Micronaut microservices written in Kotlin that will use <a href="https://docs.oracle.com/en-us/iaas/Content/Streaming/Concepts/streamingoverview.htm">Oracle Cloud Streaming</a> to communicate with each other in an asynchronous and decoupled way.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-you-will-need">2. What You Will Need</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 11 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
<li>
<p>An Oracle Cloud account (create a free trial account at <a href="https://signup.oraclecloud.com">signup.oraclecloud.com</a>)</p>
</li>
<li>
<p><a href="https://docs.cloud.oracle.com/en-us/iaas/Content/API/SDKDocs/cliinstall.htm">Oracle Cloud CLI</a> installed with local access to Oracle Cloud configured by running <code>oci setup config</code></p>
</li>
<li>
<p><a href="https://www.docker.io/gettingstarted/#h_installation">Docker</a> and <a href="https://docs.docker.com/compose/install/">Docker Compose</a> installed if you will be running Kafka in Docker and for running tests.</p>
</li>
</ul>
</div>
</div>
</div>
</div></div><div class="row"><div class="col-md-12"><div class="sect1">
<h2 id="solution">3. Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create the application step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="micronaut-oracle-cloud-streaming-maven-kotlin.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-the-application">4. Writing the Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The microservices will use Oracle Cloud Streaming and the Kafka API to send and receive messages. The messages will represent chess gameplay events, including game start and end and each move.</p>
</div>
<div class="paragraph">
<p>The microservices are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>chess-game</code> - Has a simple JavaScript and Ajax UI that renders a variable number of chess games that will be auto-played to generate many events</p>
</li>
<li>
<p><code>chess-listener</code> - Receives the chess event messages and persists them to a database</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://guides.micronaut.io/latest/micronaut-intellij-idea-ide-setup.html">Setup IntelliJ IDEA to develop Micronaut Applications</a>.</p>
</div>
<div class="sect2">
<h3 id="chess-game-microservice">4.1. chess-game Microservice</h3>
<div class="paragraph">
<p>Create the <code>chess-game</code> microservice using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">mn create-app <span class="nt">--features</span><span class="o">=</span>kafka,graalvm,reactor,testcontainers example.micronaut.chess-game <span class="nt">--build</span><span class="o">=</span>maven <span class="nt">--lang</span><span class="o">=</span>kotlin</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle with the <a href="https://docs.gradle.org/current/userguide/kotlin_dsl.html">Kotlin DSL</a> is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.<br/> If you don&#8217;t specify the <code>--test</code> argument, JUnit is used for Java and Kotlin, and Spock is used for Groovy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add the <code>kafka</code>, <code>graalvm</code>, <code>reactor</code>, and <code>testcontainers</code> features.</p>
</div>
<div class="paragraph">
<p>The previous command creates a directory named <code>chess-game</code> and a Micronaut application inside it with default package <code>example.micronaut</code>.</p>
</div>
<div class="paragraph">
<p>In addition to the dependencies added by the <code>testcontainers</code> feature, we also need a test dependency for <a href="https://www.testcontainers.org/modules/kafka/">Kafka in Testcontainers</a>, along with one for the <a href="http://www.awaitility.org/">Awaitility</a> library:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.testcontainers<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>kafka<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.awaitility<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>awaitility<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>4.2.2<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="dtos">4.1.1. DTOs</h4>
<div class="paragraph">
<p>Create a <code>GameDTO</code> data-transfer object to represent game data:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/kotlin/example/micronaut/chess/dto/GameDTO.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.chess.dto</span>

<span class="k">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonTypeInfo</span>
<span class="k">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonTypeInfo.Id.NAME</span>
<span class="k">import</span> <span class="nn">io.micronaut.core.annotation.Creator</span>
<span class="k">import</span> <span class="nn">io.micronaut.core.annotation.Introspected</span>
<span class="k">import</span> <span class="nn">jakarta.validation.constraints.Size</span>

<span class="nd">@Introspected</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@JsonTypeInfo</span><span class="p">(</span><span class="n">use</span> <span class="p">=</span> <span class="nc">NAME</span><span class="p">,</span> <span class="n">property</span> <span class="p">=</span> <span class="s">"_className"</span><span class="p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="kd">class</span> <span class="nc">GameDTO</span>

    <span class="nd">@Creator</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="k">constructor</span><span class="p">(</span><span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Size</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="mi">36</span><span class="p">)</span> <span class="kd">val</span> <span class="py">id</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
                <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Size</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="mi">255</span><span class="p">)</span> <span class="kd">val</span> <span class="py">blackName</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span>
                <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Size</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="mi">255</span><span class="p">)</span> <span class="kd">val</span> <span class="py">whiteName</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span>
                <span class="kd">val</span> <span class="py">draw</span><span class="p">:</span> <span class="nc">Boolean</span><span class="p">,</span>
                <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Size</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="mi">1</span><span class="p">)</span> <span class="kd">val</span> <span class="py">winner</span><span class="p">:</span> <span class="nc">String</span><span class="p">?)</span> <span class="p">{</span>

    <span class="k">constructor</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">blackName</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">whiteName</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">this</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">blackName</span><span class="p">,</span> <span class="n">whiteName</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>

    <span class="k">constructor</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">draw</span><span class="p">:</span> <span class="nc">Boolean</span><span class="p">,</span> <span class="n">winner</span><span class="p">:</span> <span class="nc">String</span><span class="p">?)</span> <span class="p">:</span>
            <span class="k">this</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">draw</span><span class="p">,</span> <span class="n">winner</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>@JsonTypeInfo</code> to include the class name without package in the <code>"_className"</code> property</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Annotate with <code>@Creator</code> to indicate the constructor to use when deserializing from JSON</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a <code>GameStateDTO</code> data-transfer object to represent game move data:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/kotlin/example/micronaut/chess/dto/GameStateDTO.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.chess.dto</span>

<span class="k">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonTypeInfo</span>
<span class="k">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonTypeInfo.Id.NAME</span>
<span class="k">import</span> <span class="nn">io.micronaut.core.annotation.Introspected</span>
<span class="k">import</span> <span class="nn">jakarta.validation.constraints.Size</span>

<span class="nd">@Introspected</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@JsonTypeInfo</span><span class="p">(</span><span class="n">use</span> <span class="p">=</span> <span class="nc">NAME</span><span class="p">,</span> <span class="n">property</span> <span class="p">=</span> <span class="s">"_className"</span><span class="p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="kd">data class</span> <span class="nc">GameStateDTO</span><span class="p">(</span><span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Size</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="mi">36</span><span class="p">)</span> <span class="kd">val</span> <span class="py">id</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
                        <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Size</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="mi">36</span><span class="p">)</span> <span class="kd">val</span> <span class="py">gameId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
                        <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Size</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="mi">1</span><span class="p">)</span> <span class="kd">val</span> <span class="py">player</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
                        <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Size</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="mi">100</span><span class="p">)</span> <span class="kd">val</span> <span class="py">move</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
                        <span class="kd">val</span> <span class="py">fen</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
                        <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Size</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="mi">10</span><span class="p">)</span> <span class="kd">val</span> <span class="py">pgn</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>@JsonTypeInfo</code> to include the class name without package in the <code>"_className"</code> property</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="gamereporter">4.1.2. GameReporter</h4>
<div class="paragraph">
<p>Create a <code>GameReporter</code> Kafka client to send chess-related messages:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/kotlin/example/micronaut/chess/GameReporter.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.chess</span>

<span class="k">import</span> <span class="nn">example.micronaut.chess.dto.GameDTO</span>
<span class="k">import</span> <span class="nn">example.micronaut.chess.dto.GameStateDTO</span>
<span class="k">import</span> <span class="nn">io.micronaut.configuration.kafka.annotation.KafkaClient</span>
<span class="k">import</span> <span class="nn">io.micronaut.configuration.kafka.annotation.KafkaKey</span>
<span class="k">import</span> <span class="nn">io.micronaut.configuration.kafka.annotation.Topic</span>
<span class="k">import</span> <span class="nn">io.micronaut.core.annotation.NonNull</span>
<span class="k">import</span> <span class="nn">reactor.core.publisher.Mono</span>

<span class="nd">@KafkaClient</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">interface</span> <span class="nc">GameReporter</span> <span class="p">{</span>

    <span class="nd">@Topic</span><span class="p">(</span><span class="s">"chessGame"</span><span class="p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nd">@NonNull</span>
    <span class="k">fun</span> <span class="nf">game</span><span class="p">(</span><span class="nd">@NonNull</span> <span class="nd">@KafkaKey</span> <span class="n">gameId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <i class="conum" data-value="4"></i><b>(4)</b>
             <span class="nd">@NonNull</span> <span class="n">game</span><span class="p">:</span> <span class="nc">GameDTO</span><span class="p">):</span> <span class="nc">Mono</span><span class="p">&lt;</span><span class="nc">GameDTO</span><span class="p">&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="nd">@Topic</span><span class="p">(</span><span class="s">"chessGameState"</span><span class="p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nd">@NonNull</span>
    <span class="k">fun</span> <span class="nf">gameState</span><span class="p">(</span><span class="nd">@NonNull</span> <span class="nd">@KafkaKey</span> <span class="n">gameId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <i class="conum" data-value="4"></i><b>(4)</b>
                  <span class="nd">@NonNull</span> <span class="n">gameState</span><span class="p">:</span> <span class="nc">GameStateDTO</span><span class="p">):</span> <span class="nc">Mono</span><span class="p">&lt;</span><span class="nc">GameStateDTO</span><span class="p">&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@KafkaClient</code> to declare it as a Kafka message producer; the Micronaut framework will generate the sending code at compile time</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate the method with <code>@Topic</code> and specify the topic name</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>By returning a reactive type, the Micronaut framework will use non-blocking code to send the message</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use the <code>Game</code> primary key as the Kafka partition key</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="gamecontroller">4.1.3. GameController</h4>
<div class="paragraph">
<p>Create a <code>GameController</code> class to contain Ajax endpoints for the front end:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/kotlin/example/micronaut/chess/GameController.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.chess</span>

<span class="k">import</span> <span class="nn">example.micronaut.chess.dto.GameDTO</span>
<span class="k">import</span> <span class="nn">example.micronaut.chess.dto.GameStateDTO</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.HttpStatus.CREATED</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.HttpStatus.NO_CONTENT</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.MediaType.APPLICATION_FORM_URLENCODED</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.MediaType.TEXT_PLAIN</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.PathVariable</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Post</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Status</span>
<span class="k">import</span> <span class="nn">io.micronaut.scheduling.TaskExecutors</span>
<span class="k">import</span> <span class="nn">io.micronaut.scheduling.annotation.ExecuteOn</span>
<span class="k">import</span> <span class="nn">reactor.core.publisher.Mono</span>
<span class="k">import</span> <span class="nn">java.util.UUID</span>

<span class="nd">@Controller</span><span class="p">(</span><span class="s">"/game"</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@ExecuteOn</span><span class="p">(</span><span class="nc">TaskExecutors</span><span class="p">.</span><span class="nc">BLOCKING</span><span class="p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="kd">class</span> <span class="nc">GameController</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">gameReporter</span><span class="p">:</span> <span class="nc">GameReporter</span><span class="p">)</span> <span class="p">{</span>

    <span class="nd">@Post</span><span class="p">(</span><span class="n">value</span> <span class="p">=</span> <span class="s">"/start"</span><span class="p">,</span> <i class="conum" data-value="3"></i><b>(3)</b>
          <span class="n">consumes</span> <span class="p">=</span> <span class="p">[</span><span class="nc">APPLICATION_FORM_URLENCODED</span><span class="p">],</span> <i class="conum" data-value="4"></i><b>(4)</b>
          <span class="n">produces</span> <span class="p">=</span> <span class="p">[</span><span class="nc">TEXT_PLAIN</span><span class="p">])</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="nd">@Status</span><span class="p">(</span><span class="nc">CREATED</span><span class="p">)</span> <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="k">fun</span> <span class="nf">start</span><span class="p">(</span><span class="n">b</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
              <span class="n">w</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Mono</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;</span> <span class="p">{</span> <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="kd">val</span> <span class="py">game</span> <span class="p">=</span> <span class="nc">GameDTO</span><span class="p">(</span><span class="nc">UUID</span><span class="p">.</span><span class="nf">randomUUID</span><span class="p">().</span><span class="nf">toString</span><span class="p">(),</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <i class="conum" data-value="8"></i><b>(8)</b>
        <span class="k">return</span> <span class="n">gameReporter</span><span class="p">.</span><span class="nf">game</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">game</span><span class="p">).</span><span class="nf">map</span> <span class="p">{</span> <span class="n">game</span><span class="p">.</span><span class="n">id</span> <span class="p">}</span> <i class="conum" data-value="9"></i><b>(9)</b>
    <span class="p">}</span>

    <span class="nd">@Post</span><span class="p">(</span><span class="n">value</span> <span class="p">=</span> <span class="s">"/move/{gameId}"</span><span class="p">,</span> <i class="conum" data-value="10"></i><b>(10)</b>
          <span class="n">consumes</span> <span class="p">=</span> <span class="p">[</span><span class="nc">APPLICATION_FORM_URLENCODED</span><span class="p">])</span> <i class="conum" data-value="11"></i><b>(11)</b>
    <span class="nd">@Status</span><span class="p">(</span><span class="nc">CREATED</span><span class="p">)</span> <i class="conum" data-value="12"></i><b>(12)</b>
    <span class="k">fun</span> <span class="nf">move</span><span class="p">(</span><span class="nd">@PathVariable</span> <span class="n">gameId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
             <span class="n">player</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
             <span class="n">move</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
             <span class="n">fen</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
             <span class="n">pgn</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">gameState</span> <span class="p">=</span> <span class="nc">GameStateDTO</span><span class="p">(</span><span class="nc">UUID</span><span class="p">.</span><span class="nf">randomUUID</span><span class="p">().</span><span class="nf">toString</span><span class="p">(),</span>
                <span class="n">gameId</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">move</span><span class="p">,</span> <span class="n">fen</span><span class="p">,</span> <span class="n">pgn</span><span class="p">)</span>
        <span class="n">gameReporter</span><span class="p">.</span><span class="nf">gameState</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="n">gameState</span><span class="p">).</span><span class="nf">subscribe</span><span class="p">()</span> <i class="conum" data-value="13"></i><b>(13)</b>
    <span class="p">}</span>

    <span class="nd">@Post</span><span class="p">(</span><span class="s">"/checkmate/{gameId}/{player}"</span><span class="p">)</span> <i class="conum" data-value="14"></i><b>(14)</b>
    <span class="nd">@Status</span><span class="p">(</span><span class="nc">NO_CONTENT</span><span class="p">)</span> <i class="conum" data-value="15"></i><b>(15)</b>
    <span class="k">fun</span> <span class="nf">checkmate</span><span class="p">(</span><span class="nd">@PathVariable</span> <span class="n">gameId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
                  <span class="nd">@PathVariable</span> <span class="n">player</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">game</span> <span class="p">=</span> <span class="nc">GameDTO</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="n">player</span><span class="p">)</span>
        <span class="n">gameReporter</span><span class="p">.</span><span class="nf">game</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="n">game</span><span class="p">).</span><span class="nf">subscribe</span><span class="p">()</span> <i class="conum" data-value="16"></i><b>(16)</b>
    <span class="p">}</span>

    <span class="nd">@Post</span><span class="p">(</span><span class="s">"/draw/{gameId}"</span><span class="p">)</span> <i class="conum" data-value="17"></i><b>(17)</b>
    <span class="nd">@Status</span><span class="p">(</span><span class="nc">NO_CONTENT</span><span class="p">)</span> <i class="conum" data-value="18"></i><b>(18)</b>
    <span class="k">fun</span> <span class="nf">draw</span><span class="p">(</span><span class="nd">@PathVariable</span> <span class="n">gameId</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">game</span> <span class="p">=</span> <span class="nc">GameDTO</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
        <span class="n">gameReporter</span><span class="p">.</span><span class="nf">game</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="n">game</span><span class="p">).</span><span class="nf">subscribe</span><span class="p">()</span> <i class="conum" data-value="19"></i><b>(19)</b>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/game</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It is critical that any blocking I/O operations (such as fetching the data from the database) are offloaded to a separate thread pool that does not block the Event loop.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The method accepts HTTP POST requests to indicate a new game has started</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The method accepts encoded form data (the two players' names)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The response will be plain text and contain the ID of the persisted <code>Game</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Send a <code>"Created"</code> (201) status to indicate a <code>Game</code> was persisted</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Return a reactive type to configure a reactive response</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Assign the game&#8217;s primary key as a UUID</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Use the <code>GameReporter</code> to send a Kafka message with new game data</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The method accepts HTTP POST requests to indicate a move has occurred</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>The method accepts encoded form data (the move information)</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Send a <code>"Created"</code> (201) status to indicate a <code>GameState</code> was persisted</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>Use the <code>GameReporter</code> to send a Kafka message with game move data</td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td>The method accepts HTTP POST requests to indicate the game ended with a checkmate</td>
</tr>
<tr>
<td><i class="conum" data-value="15"></i><b>15</b></td>
<td>Send a <code>"No Content"</code> (204) status to indicate success and no response body</td>
</tr>
<tr>
<td><i class="conum" data-value="16"></i><b>16</b></td>
<td>Use the <code>GameReporter</code> to send a Kafka message that the game ended in a checkmate</td>
</tr>
<tr>
<td><i class="conum" data-value="17"></i><b>17</b></td>
<td>The method accepts HTTP POST requests to indicate the game ended with a draw</td>
</tr>
<tr>
<td><i class="conum" data-value="18"></i><b>18</b></td>
<td>Send a <code>"No Content"</code> (204) status to indicate success and no response body</td>
</tr>
<tr>
<td><i class="conum" data-value="19"></i><b>19</b></td>
<td>Use the <code>GameReporter</code> to send a Kafka message that the game ended in a draw</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="development-environment">4.1.4. Development environment</h4>
<div class="paragraph">
<p>Modify the <code>Application</code> class to use <code>dev</code> as a default environment:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The Micronaut framework supports the concept of one or many default environments. A default environment is one that is only applied if no other environments are explicitly specified or deduced.</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/kotlin/example/micronaut/Application.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut</span>

<span class="k">import</span> <span class="nn">io.micronaut.context.env.Environment.DEVELOPMENT</span>
<span class="k">import</span> <span class="nn">io.micronaut.runtime.Micronaut.build</span>

<span class="k">fun</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nc">Array</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;)</span> <span class="p">{</span>
    <span class="nf">build</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">args</span><span class="p">(*</span><span class="n">args</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">packages</span><span class="p">(</span><span class="s">"example.micronaut"</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">defaultEnvironments</span><span class="p">(</span><span class="nc">DEVELOPMENT</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">start</span><span class="p">()</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Delete the <code>kafka.bootstrap.servers</code> config option from <code>application.properties</code> and move it to <code>application-dev.properties</code>.</p>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/application-dev.properties</code>. The Micronaut framework applies this configuration file only for the <code>dev</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/resources/application-dev.properties</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><i class="conum" data-value="1"></i><b>(1)</b>
<span class="py">kafka.bootstrap.servers</span><span class="p">=</span><span class="s">localhost:9092</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use local Kafka in the development environment</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="static-resources">4.1.5. Static Resources</h4>
<div class="paragraph">
<p>Update <code>application.properties</code> to add static resource configuration:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/resources/application.properties</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><i class="conum" data-value="1"></i><b>(1)</b>
<span class="py">micronaut.router.static-resources.default.paths</span><span class="p">=</span><span class="s">classpath:public</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the Framework to look for static resources in <code>src/main/resources/public</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ui-resources">4.1.6. UI Resources</h4>
<div class="paragraph">
<p>Create <code>index.html</code> with the simple chess game UI:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/resources/public/index.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"IE=edge"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;title&gt;</span>Micronaut Chess Multi<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"shortcut icon"</span> <span class="na">type=</span><span class="s">"image/png"</span> <span class="na">href=</span><span class="s">"favicon-32x32.png"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span>
          <span class="na">href=</span><span class="s">"https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"</span>
          <span class="na">integrity=</span><span class="s">"sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU"</span>
          <span class="na">crossorigin=</span><span class="s">"anonymous"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;style&gt;</span>
        <span class="nc">.gamesRow</span> <span class="p">{</span>
            <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
            <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span> <span class="nb">auto</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nc">.gameContainer</span> <span class="p">{</span>
            <span class="nl">display</span><span class="p">:</span> <span class="n">inline-block</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"counts"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"rowCount"</span><span class="nt">&gt;</span>Rows:<span class="ni">&amp;nbsp;</span><span class="nt">&lt;/label&gt;&lt;input</span> <span class="na">type=</span><span class="s">"number"</span> <span class="na">value=</span><span class="s">"1"</span> <span class="na">min=</span><span class="s">"1"</span> <span class="na">max=</span><span class="s">"10"</span> <span class="na">id=</span><span class="s">"rowCount"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"gamesPerRow"</span><span class="nt">&gt;</span>Games per row:<span class="ni">&amp;nbsp;</span><span class="nt">&lt;/label&gt;&lt;input</span> <span class="na">type=</span><span class="s">"number"</span> <span class="na">value=</span><span class="s">"1"</span> <span class="na">min=</span><span class="s">"1"</span> <span class="na">max=</span><span class="s">"10"</span> <span class="na">id=</span><span class="s">"gamesPerRow"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"playDelay"</span><span class="nt">&gt;</span>Play delay milliseconds:<span class="ni">&amp;nbsp;</span><span class="nt">&lt;/label&gt;&lt;input</span> <span class="na">type=</span><span class="s">"number"</span> <span class="na">value=</span><span class="s">"5"</span> <span class="na">min=</span><span class="s">"1"</span> <span class="na">id=</span><span class="s">"playDelay"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"startButton"</span><span class="nt">&gt;</span>START<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"gamesContainer"</span><span class="nt">&gt;&lt;/div&gt;</span>

<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://code.jquery.com/jquery-3.5.1.min.js"</span>
        <span class="na">integrity=</span><span class="s">"sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"</span>
        <span class="na">crossorigin=</span><span class="s">"anonymous"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"</span>
        <span class="na">integrity=</span><span class="s">"sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"</span>
        <span class="na">crossorigin=</span><span class="s">"anonymous"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"</span>
        <span class="na">integrity=</span><span class="s">"sha512-ujGsB4vTyNcSuViwM2DJ0+G2BIViQJl2rVBZBekStznA9Hq96+Wd9+jwu9zlttp0U2/9CYhgR7pOt2j+E6yewg=="</span>
        <span class="na">crossorigin=</span><span class="s">"anonymous"</span> <span class="na">referrerpolicy=</span><span class="s">"no-referrer"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"micronaut-chess.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The HTML page includes the <a href="https://chessboardjs.com/">chessboard.js</a> JavaScript library to create a chess board and the <a href="https://github.com/jhlywa/chess.js">chess.js</a> JavaScript library for chess game logic.</p>
</div>
<div class="paragraph">
<p>Create <code>micronaut-chess.js</code> used by <code>index.html</code> with the JavaScript code:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/resources/public/micronaut-chess.js</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="js"><span class="kd">function</span> <span class="nx">updateStatus</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">started</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">started</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">onMove</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">game</span> <span class="o">=</span> <span class="nx">GAMES</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">in_checkmate</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">onCheckmate</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">in_draw</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">onDraw</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">onGameStart</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/game/start</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">b</span><span class="p">:</span> <span class="nx">BLACK_NAMES</span><span class="p">[</span><span class="nx">n</span><span class="p">],</span> <span class="na">w</span><span class="p">:</span> <span class="nx">WHITE_NAMES</span><span class="p">[</span><span class="nx">n</span><span class="p">]},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">gameId</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="nx">GAME_IDS</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">gameId</span><span class="p">;</span>
        <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#gameId</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">n</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="dl">'</span><span class="s1">Game ID: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">gameId</span><span class="p">);</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="nx">makeRandomMove</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
        <span class="p">},</span> <span class="mi">2000</span><span class="p">);</span> <span class="c1">// delay a bit so the Game is persisted</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">onMove</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">game</span> <span class="o">=</span> <span class="nx">GAMES</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>
    <span class="kd">const</span> <span class="nx">history</span> <span class="o">=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">history</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">move</span> <span class="o">=</span> <span class="nx">history</span><span class="p">[</span><span class="nx">history</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

    <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/game/move/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">GAME_IDS</span><span class="p">[</span><span class="nx">n</span><span class="p">],</span> <span class="p">{</span>
        <span class="na">player</span><span class="p">:</span> <span class="nx">other</span><span class="p">(</span><span class="nx">n</span><span class="p">),</span>
        <span class="na">fen</span><span class="p">:</span> <span class="nx">game</span><span class="p">.</span><span class="nx">fen</span><span class="p">(),</span>
        <span class="na">pgn</span><span class="p">:</span> <span class="nx">game</span><span class="p">.</span><span class="nx">pgn</span><span class="p">(),</span>
        <span class="na">move</span><span class="p">:</span> <span class="nx">move</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">onCheckmate</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">winner</span> <span class="o">=</span> <span class="nx">other</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/game/checkmate/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">GAME_IDS</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">winner</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">onDraw</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/game/draw/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">GAME_IDS</span><span class="p">[</span><span class="nx">n</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">other</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">GAMES</span><span class="p">[</span><span class="nx">n</span><span class="p">].</span><span class="nx">turn</span><span class="p">()</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">b</span><span class="dl">'</span> <span class="p">?</span> <span class="dl">'</span><span class="s1">w</span><span class="dl">'</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">b</span><span class="dl">'</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">makeRandomMove</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">const</span> <span class="nx">game</span> <span class="o">=</span> <span class="nx">GAMES</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">game_over</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">restart</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">possibleMoves</span> <span class="o">=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">moves</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">moveIndex</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">possibleMoves</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="nx">game</span><span class="p">.</span><span class="nx">move</span><span class="p">(</span><span class="nx">possibleMoves</span><span class="p">[</span><span class="nx">moveIndex</span><span class="p">]);</span>
    <span class="nx">BOARDS</span><span class="p">[</span><span class="nx">n</span><span class="p">].</span><span class="nx">position</span><span class="p">(</span><span class="nx">game</span><span class="p">.</span><span class="nx">fen</span><span class="p">());</span>
    <span class="nx">updateStatus</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

    <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">makeRandomMove</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">playDelay</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">restart</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">BOARDS</span><span class="p">[</span><span class="nx">n</span><span class="p">].</span><span class="nx">position</span><span class="p">(</span><span class="nx">FEN_INITIAL</span><span class="p">);</span>
    <span class="nx">GAMES</span><span class="p">[</span><span class="nx">n</span><span class="p">].</span><span class="nx">load</span><span class="p">(</span><span class="nx">FEN_INITIAL</span><span class="p">);</span>
    <span class="nx">updateStatus</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
    <span class="nx">onGameStart</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">startGames</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#counts</span><span class="dl">'</span><span class="p">).</span><span class="nx">toggle</span><span class="p">();</span>

    <span class="nx">playDelay</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#playDelay</span><span class="dl">'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span> <span class="mi">10</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">rowCount</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#rowCount</span><span class="dl">'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span> <span class="mi">10</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">gamesPerRow</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#gamesPerRow</span><span class="dl">'</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span> <span class="mi">10</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">hWidth</span> <span class="o">=</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">innerWidth</span> <span class="o">-</span> <span class="mi">50</span><span class="p">)</span> <span class="o">/</span> <span class="nx">gamesPerRow</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">vWidth</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span> <span class="o">/</span> <span class="nx">rowCount</span> <span class="o">-</span> <span class="mi">50</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">gameWidth</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="nx">hWidth</span><span class="p">,</span> <span class="nx">vWidth</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">r</span> <span class="o">&lt;</span> <span class="nx">rowCount</span><span class="p">;</span> <span class="nx">r</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">const</span> <span class="nx">gamesContainer</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#gamesContainer</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">gamesContainer</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span>
            <span class="dl">'</span><span class="s1">&lt;div id="gamesRow</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">r</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">" class="gamesRow"&gt;&lt;/div&gt;</span><span class="dl">'</span>
        <span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">c</span> <span class="o">&lt;</span> <span class="nx">gamesPerRow</span><span class="p">;</span> <span class="nx">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

            <span class="kd">const</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">r</span> <span class="o">*</span> <span class="nx">gamesPerRow</span> <span class="o">+</span> <span class="nx">c</span><span class="p">;</span>

            <span class="kd">const</span> <span class="nx">gamesRow</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#gamesRow</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">r</span><span class="p">);</span>
            <span class="nx">gamesRow</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span>
                <span class="dl">'</span><span class="s1">&lt;div class="gameContainer" style="width: </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">gameWidth</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">px"&gt;</span><span class="dl">'</span> <span class="o">+</span>
                <span class="dl">'</span><span class="s1">&lt;div id="chessboard</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">n</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">"&gt;&lt;/div&gt;</span><span class="dl">'</span> <span class="o">+</span>
                <span class="dl">'</span><span class="s1">&lt;div&gt;&lt;span id="gameId</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">n</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">"&gt;&lt;/span&gt;&lt;/div&gt;</span><span class="dl">'</span> <span class="o">+</span>
                <span class="dl">'</span><span class="s1">&lt;/div&gt;</span><span class="dl">'</span>
            <span class="p">);</span>

            <span class="nx">GAMES</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Chess</span><span class="p">();</span>
            <span class="nx">BLACK_NAMES</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">b</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">n</span><span class="p">;</span>
            <span class="nx">WHITE_NAMES</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">w</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">n</span><span class="p">;</span>

            <span class="nx">BOARDS</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Chessboard</span><span class="p">(</span><span class="dl">'</span><span class="s1">chessboard</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">n</span><span class="p">,</span> <span class="p">{</span>
                <span class="na">position</span><span class="p">:</span> <span class="dl">'</span><span class="s1">start</span><span class="dl">'</span><span class="p">,</span>
                <span class="na">appearSpeed</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="na">moveSpeed</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">});</span>

            <span class="nx">updateStatus</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
            <span class="nx">onGameStart</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">FEN_INITIAL</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">GAME_IDS</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">const</span> <span class="nx">BOARDS</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">const</span> <span class="nx">BLACK_NAMES</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">const</span> <span class="nx">WHITE_NAMES</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">const</span> <span class="nx">GAMES</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">let</span> <span class="nx">playDelay</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

<span class="nx">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#startButton</span><span class="dl">'</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">click</span><span class="dl">'</span><span class="p">,</span> <span class="nx">startGames</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy these chess piece images to <code>src/main/resources/public/img/chesspieces/wikipedia</code> (the path must be correct because it is hard-coded in <code>chessboard.js</code>):</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/oraclecloudstream/bB.png" alt="bB"></span> <span class="image"><img src="images/oraclecloudstream/bK.png" alt="bK"></span> <span class="image"><img src="images/oraclecloudstream/bN.png" alt="bN"></span> <span class="image"><img src="images/oraclecloudstream/bP.png" alt="bP"></span> <span class="image"><img src="images/oraclecloudstream/bQ.png" alt="bQ"></span> <span class="image"><img src="images/oraclecloudstream/bR.png" alt="bR"></span></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/oraclecloudstream/wB.png" alt="wB"></span> <span class="image"><img src="images/oraclecloudstream/wK.png" alt="wK"></span> <span class="image"><img src="images/oraclecloudstream/wN.png" alt="wN"></span> <span class="image"><img src="images/oraclecloudstream/wP.png" alt="wP"></span> <span class="image"><img src="images/oraclecloudstream/wQ.png" alt="wQ"></span> <span class="image"><img src="images/oraclecloudstream/wR.png" alt="wR"></span></p>
</div>
<div class="paragraph">
<p>Right-click each image and save to your local file system, or extract the completed example zip file linked above and get them from there.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="chess-listener-microservice">4.2. chess-listener Microservice</h3>
<div class="paragraph">
<p>Create the <code>chess-listener</code> microservice using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">mn create-app <span class="nt">--features</span><span class="o">=</span>kafka,graalvm,data-jdbc,flyway,reactor,testcontainers example.micronaut.chess-listener <span class="nt">--build</span><span class="o">=</span>maven <span class="nt">--lang</span><span class="o">=</span>kotlin</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle with the <a href="https://docs.gradle.org/current/userguide/kotlin_dsl.html">Kotlin DSL</a> is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.<br/> If you don&#8217;t specify the <code>--test</code> argument, JUnit is used for Java and Kotlin, and Spock is used for Groovy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add the <code>kafka</code>, <code>graalvm</code>, <code>data-jdbc</code>, <code>flyway</code>, <code>reactor</code>, and <code>testcontainers</code> features.</p>
</div>
<div class="paragraph">
<p>The previous command creates a directory named <code>chess-listener</code> and a Micronaut application inside it with default package <code>example.micronaut</code>.</p>
</div>
<div class="paragraph">
<p>In addition to the dependencies added by the <code>testcontainers</code> feature, we also need a test dependency for Kafka and Oracle in Testcontainers, along with one for the <a href="http://www.awaitility.org/">Awaitility</a> library:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.testcontainers<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>kafka<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.testcontainers<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>oracle-xe<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.awaitility<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>awaitility<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>4.2.2<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="flyway">4.2.1. Flyway</h4>
<div class="paragraph">
<p>Enable Flyway database migrations for all environments by adding this configuration to <code>application.properties</code>:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/resources/application.properties</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">flyway.datasources.default.enabled</span><span class="p">=</span><span class="s">true</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dtos-2">4.2.2. DTOs</h4>
<div class="paragraph">
<p>The same data transfer objects (<code>GameDTO</code> and <code>GameStateDTO</code>&#8230;&#8203;) as above in the <code>chess-game</code> microservice. In a real application, these would be in a shared library, but to keep things simple, we&#8217;ll just duplicate them.</p>
</div>
</div>
<div class="sect3">
<h4 id="entity-classes">4.2.3. Entity Classes</h4>
<div class="paragraph">
<p>Create a <code>Game</code> entity to represent persistent game data:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/kotlin/example/micronaut/chess/entity/Game.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.chess.entity</span>

<span class="k">import</span> <span class="nn">example.micronaut.chess.dto.GameDTO</span>
<span class="k">import</span> <span class="nn">io.micronaut.core.annotation.Nullable</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.annotation.DateCreated</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.annotation.DateUpdated</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.annotation.Id</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.annotation.MappedEntity</span>
<span class="k">import</span> <span class="nn">java.time.LocalDateTime</span>
<span class="k">import</span> <span class="nn">java.util.UUID</span>
<span class="k">import</span> <span class="nn">jakarta.validation.constraints.Size</span>

<span class="nd">@MappedEntity</span><span class="p">(</span><span class="s">"GAME"</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">Game</span><span class="p">(</span>

    <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Id</span>
    <span class="kd">val</span> <span class="py">id</span><span class="p">:</span> <span class="nc">UUID</span><span class="p">,</span>

    <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Size</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="mi">255</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">blackName</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>

    <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Size</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="mi">255</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">whiteName</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>

    <span class="nd">@DateCreated</span>
    <span class="kd">var</span> <span class="py">dateCreated</span><span class="p">:</span> <span class="nc">LocalDateTime</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="nd">@DateUpdated</span>
    <span class="kd">var</span> <span class="py">dateUpdated</span><span class="p">:</span> <span class="nc">LocalDateTime</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="kd">var</span> <span class="py">draw</span> <span class="p">=</span> <span class="k">false</span>

    <span class="nd">@Nullable</span>
    <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Size</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="mi">1</span><span class="p">)</span> <span class="kd">var</span> <span class="py">winner</span><span class="p">:</span> <span class="nc">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="k">fun</span> <span class="nf">toDto</span><span class="p">()</span> <span class="p">=</span> <span class="nc">GameDTO</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="nf">toString</span><span class="p">(),</span> <span class="n">blackName</span><span class="p">,</span> <span class="n">whiteName</span><span class="p">,</span> <span class="n">draw</span><span class="p">,</span> <span class="n">winner</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a <code>GameState</code> entity to represent persistent game move data:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/kotlin/example/micronaut/chess/entity/GameState.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.chess.entity</span>

<span class="k">import</span> <span class="nn">example.micronaut.chess.dto.GameStateDTO</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.annotation.DateCreated</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.annotation.Id</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.annotation.MappedEntity</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.annotation.Relation</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.annotation.Relation.Kind.MANY_TO_ONE</span>
<span class="k">import</span> <span class="nn">java.time.LocalDateTime</span>
<span class="k">import</span> <span class="nn">java.util.UUID</span>
<span class="k">import</span> <span class="nn">jakarta.validation.constraints.Size</span>

<span class="nd">@MappedEntity</span><span class="p">(</span><span class="s">"GAME_STATE"</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">GameState</span><span class="p">(</span>

    <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Id</span>
    <span class="kd">val</span> <span class="py">id</span><span class="p">:</span> <span class="nc">UUID</span><span class="p">,</span>

    <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Relation</span><span class="p">(</span><span class="nc">MANY_TO_ONE</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">game</span><span class="p">:</span> <span class="nc">Game</span><span class="p">,</span>

    <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Size</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">player</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>

    <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Size</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="mi">10</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">move</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>

    <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Size</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="mi">100</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">fen</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>

    <span class="kd">val</span> <span class="py">pgn</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>

    <span class="nd">@DateCreated</span>
    <span class="kd">var</span> <span class="py">dateCreated</span><span class="p">:</span> <span class="nc">LocalDateTime</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="k">fun</span> <span class="nf">toDto</span><span class="p">()</span> <span class="p">=</span> <span class="nc">GameStateDTO</span><span class="p">(</span><span class="n">id</span><span class="p">.</span><span class="nf">toString</span><span class="p">(),</span> <span class="n">game</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="nf">toString</span><span class="p">(),</span> <span class="n">player</span><span class="p">,</span> <span class="n">move</span><span class="p">,</span> <span class="n">fen</span><span class="p">,</span> <span class="n">pgn</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositories">4.2.4. Repositories</h4>
<div class="paragraph">
<p>Create a "base" <code>GameRepository</code> interface to have access to methods for <code>Game</code> entity persistence:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/kotlin/example/micronaut/chess/repository/GameRepository.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.chess.repository</span>

<span class="k">import</span> <span class="nn">example.micronaut.chess.entity.Game</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.repository.CrudRepository</span>
<span class="k">import</span> <span class="nn">java.util.UUID</span>

<span class="kd">interface</span> <span class="nc">GameRepository</span> <span class="p">:</span> <span class="nc">CrudRepository</span><span class="p">&lt;</span><span class="nc">Game</span><span class="p">,</span> <span class="nc">UUID</span><span class="p">&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and a <code>H2GameRepository</code> interface that extends <code>GameRepository</code> and specifies the <code>H2</code> dialect to use an in-memory H2 database in the development environment (we&#8217;ll also be creating an Oracle repository):</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/kotlin/example/micronaut/chess/repository/H2GameRepository.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.chess.repository</span>

<span class="k">import</span> <span class="nn">io.micronaut.context.annotation.Primary</span>
<span class="k">import</span> <span class="nn">io.micronaut.context.annotation.Requires</span>
<span class="k">import</span> <span class="nn">io.micronaut.context.env.Environment.DEVELOPMENT</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.jdbc.annotation.JdbcRepository</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.model.query.builder.sql.Dialect.H2</span>

<span class="nd">@Primary</span>
<span class="nd">@JdbcRepository</span><span class="p">(</span><span class="n">dialect</span> <span class="p">=</span> <span class="nc">H2</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@Requires</span><span class="p">(</span><span class="n">env</span> <span class="p">=</span> <span class="p">[</span><span class="nc">DEVELOPMENT</span><span class="p">])</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="kd">interface</span> <span class="nc">H2GameRepository</span> <span class="p">:</span> <span class="nc">GameRepository</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate with <code>@JdbcRepository</code> to make this a Micronaut Data JDBC repository, and specify the <code>H2</code> dialect. The Micronaut framework will generate persistence logic at compile time and use H2-specific SQL.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Restrict the bean to be available only in the development environment</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a "base" <code>GameStateRepository</code> interface to have access to methods for <code>GameState</code> entity persistence:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/kotlin/example/micronaut/chess/repository/GameStateRepository.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.chess.repository</span>

<span class="k">import</span> <span class="nn">example.micronaut.chess.entity.GameState</span>
<span class="k">import</span> <span class="nn">io.micronaut.core.annotation.NonNull</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.annotation.Join</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.annotation.Join.Type.FETCH</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.repository.CrudRepository</span>
<span class="k">import</span> <span class="nn">java.util.Optional</span>
<span class="k">import</span> <span class="nn">java.util.UUID</span>
<span class="k">import</span> <span class="nn">jakarta.validation.constraints.NotNull</span>

<span class="kd">interface</span> <span class="nc">GameStateRepository</span> <span class="p">:</span> <span class="nc">CrudRepository</span><span class="p">&lt;</span><span class="nc">GameState</span><span class="p">,</span> <span class="nc">UUID</span><span class="p">&gt;</span> <span class="p">{</span>

    <span class="nd">@NonNull</span>
    <span class="nd">@Join</span><span class="p">(</span><span class="n">value</span> <span class="p">=</span> <span class="s">"game"</span><span class="p">,</span> <span class="n">type</span> <span class="p">=</span> <span class="nc">FETCH</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">findById</span><span class="p">(</span><span class="nd">@NotNull</span> <span class="nd">@NonNull</span> <span class="n">id</span><span class="p">:</span> <span class="nc">UUID</span><span class="p">):</span> <span class="nc">Optional</span><span class="p">&lt;</span><span class="nc">GameState</span><span class="p">?&gt;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Override the <code>findById</code> method from <code>CrudRepository</code> to add a <code>@Join</code> annotation. This will configure the SQL query to load <code>Game</code> data when retrieving a <code>GameState</code> to resolve the <code>game</code> property.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Also create a <code>H2GameStateRepository</code> interface that extends <code>GameStateRepository</code>:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/kotlin/example/micronaut/chess/repository/H2GameStateRepository.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.chess.repository</span>

<span class="k">import</span> <span class="nn">io.micronaut.context.annotation.Primary</span>
<span class="k">import</span> <span class="nn">io.micronaut.context.annotation.Requires</span>
<span class="k">import</span> <span class="nn">io.micronaut.context.env.Environment.DEVELOPMENT</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.jdbc.annotation.JdbcRepository</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.model.query.builder.sql.Dialect.H2</span>

<span class="nd">@Primary</span>
<span class="nd">@JdbcRepository</span><span class="p">(</span><span class="n">dialect</span> <span class="p">=</span> <span class="nc">H2</span><span class="p">)</span>
<span class="nd">@Requires</span><span class="p">(</span><span class="n">env</span> <span class="p">=</span> <span class="p">[</span><span class="nc">DEVELOPMENT</span><span class="p">])</span>
<span class="kd">interface</span> <span class="nc">H2GameStateRepository</span> <span class="p">:</span> <span class="nc">GameStateRepository</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="gameservice">4.2.5. GameService</h4>
<div class="paragraph">
<p>Create <code>GameService</code> to coordinate transactional persistence using <code>GameRepository</code> and <code>GameStateRepository</code>:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/kotlin/example/micronaut/chess/GameService.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.chess</span>

<span class="k">import</span> <span class="nn">example.micronaut.chess.dto.GameDTO</span>
<span class="k">import</span> <span class="nn">example.micronaut.chess.dto.GameStateDTO</span>
<span class="k">import</span> <span class="nn">example.micronaut.chess.entity.Game</span>
<span class="k">import</span> <span class="nn">example.micronaut.chess.entity.GameState</span>
<span class="k">import</span> <span class="nn">example.micronaut.chess.repository.GameRepository</span>
<span class="k">import</span> <span class="nn">example.micronaut.chess.repository.GameStateRepository</span>
<span class="k">import</span> <span class="nn">org.slf4j.LoggerFactory</span>
<span class="k">import</span> <span class="nn">java.util.UUID</span>
<span class="k">import</span> <span class="nn">jakarta.inject.Singleton</span>
<span class="k">import</span> <span class="nn">jakarta.transaction.Transactional</span>

<span class="nd">@Singleton</span>
<span class="nd">@Transactional</span>
<span class="k">open</span> <span class="kd">class</span> <span class="nc">GameService</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">gameRepository</span><span class="p">:</span> <span class="nc">GameRepository</span><span class="p">,</span>
                       <span class="k">private</span> <span class="kd">val</span> <span class="py">gameStateRepository</span><span class="p">:</span> <span class="nc">GameStateRepository</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">log</span> <span class="p">=</span> <span class="nc">LoggerFactory</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="nc">GameService</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">open</span> <span class="k">fun</span> <span class="nf">newGame</span><span class="p">(</span><span class="n">gameDTO</span><span class="p">:</span> <span class="nc">GameDTO</span><span class="p">):</span> <span class="nc">Game</span> <span class="p">{</span>
        <span class="n">log</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="s">"New game {}, black: {}, white: {}"</span><span class="p">,</span>
                <span class="n">gameDTO</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gameDTO</span><span class="p">.</span><span class="n">blackName</span><span class="p">,</span> <span class="n">gameDTO</span><span class="p">.</span><span class="n">whiteName</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">game</span> <span class="p">=</span> <span class="nc">Game</span><span class="p">(</span><span class="nc">UUID</span><span class="p">.</span><span class="nf">fromString</span><span class="p">(</span><span class="n">gameDTO</span><span class="p">.</span><span class="n">id</span><span class="p">),</span> <span class="n">gameDTO</span><span class="p">.</span><span class="n">blackName</span><span class="o">!!</span><span class="p">,</span> <span class="n">gameDTO</span><span class="p">.</span><span class="n">whiteName</span><span class="o">!!</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gameRepository</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">open</span> <span class="k">fun</span> <span class="nf">newGameState</span><span class="p">(</span><span class="n">gameStateDTO</span><span class="p">:</span> <span class="nc">GameStateDTO</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">game</span> <span class="p">=</span> <span class="nf">findGame</span><span class="p">(</span><span class="n">gameStateDTO</span><span class="p">.</span><span class="n">gameId</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">gameState</span> <span class="p">=</span> <span class="nc">GameState</span><span class="p">(</span>
                <span class="nc">UUID</span><span class="p">.</span><span class="nf">fromString</span><span class="p">(</span><span class="n">gameStateDTO</span><span class="p">.</span><span class="n">id</span><span class="p">),</span> <span class="n">game</span><span class="p">,</span>
                <span class="n">gameStateDTO</span><span class="p">.</span><span class="n">player</span><span class="p">,</span> <span class="n">gameStateDTO</span><span class="p">.</span><span class="n">move</span><span class="p">,</span>
                <span class="n">gameStateDTO</span><span class="p">.</span><span class="n">fen</span><span class="p">,</span> <span class="n">gameStateDTO</span><span class="p">.</span><span class="n">pgn</span><span class="p">)</span>
        <span class="n">gameStateRepository</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="n">gameState</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">open</span> <span class="k">fun</span> <span class="nf">checkmate</span><span class="p">(</span><span class="n">gameDTO</span><span class="p">:</span> <span class="nc">GameDTO</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">log</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="s">"Game {} ended with winner: {}"</span><span class="p">,</span> <span class="n">gameDTO</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gameDTO</span><span class="p">.</span><span class="n">winner</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">game</span> <span class="p">=</span> <span class="nf">findGame</span><span class="p">(</span><span class="n">gameDTO</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">game</span><span class="p">.</span><span class="n">winner</span> <span class="p">=</span> <span class="n">gameDTO</span><span class="p">.</span><span class="n">winner</span>
        <span class="n">gameRepository</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">open</span> <span class="k">fun</span> <span class="nf">draw</span><span class="p">(</span><span class="n">gameDTO</span><span class="p">:</span> <span class="nc">GameDTO</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">log</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="s">"Game {} ended in a draw"</span><span class="p">,</span> <span class="n">gameDTO</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">game</span> <span class="p">=</span> <span class="nf">findGame</span><span class="p">(</span><span class="n">gameDTO</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">game</span><span class="p">.</span><span class="n">draw</span> <span class="p">=</span> <span class="k">true</span>
        <span class="n">gameRepository</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">findGame</span><span class="p">(</span><span class="n">gameId</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">=</span>
            <span class="n">gameRepository</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="nc">UUID</span><span class="p">.</span><span class="nf">fromString</span><span class="p">(</span><span class="n">gameId</span><span class="p">))</span>
                    <span class="p">.</span><span class="nf">orElseThrow</span> <span class="p">{</span> <span class="nc">IllegalArgumentException</span><span class="p">(</span><span class="s">"Game with id '$gameId' not found"</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="chesslistener">4.2.6. ChessListener</h4>
<div class="paragraph">
<p>Create <code>ChessListener</code> Kafka listener to receive messages sent from the <code>chess-game</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/kotlin/example/micronaut/chess/ChessListener.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.chess</span>

<span class="k">import</span> <span class="nn">example.micronaut.chess.dto.GameDTO</span>
<span class="k">import</span> <span class="nn">example.micronaut.chess.dto.GameStateDTO</span>
<span class="k">import</span> <span class="nn">io.micronaut.configuration.kafka.annotation.KafkaListener</span>
<span class="k">import</span> <span class="nn">io.micronaut.configuration.kafka.annotation.OffsetReset.EARLIEST</span>
<span class="k">import</span> <span class="nn">io.micronaut.configuration.kafka.annotation.Topic</span>

<span class="nd">@KafkaListener</span><span class="p">(</span><span class="n">offsetReset</span> <span class="p">=</span> <span class="nc">EARLIEST</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">ChessListener</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">gameService</span><span class="p">:</span> <span class="nc">GameService</span><span class="p">)</span> <span class="p">{</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="nd">@Topic</span><span class="p">(</span><span class="s">"chessGame"</span><span class="p">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="k">fun</span> <span class="nf">onGame</span><span class="p">(</span><span class="n">gameDTO</span><span class="p">:</span> <span class="nc">GameDTO</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">gameDTO</span><span class="p">.</span><span class="n">draw</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">gameService</span><span class="p">.</span><span class="nf">draw</span><span class="p">(</span><span class="n">gameDTO</span><span class="p">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gameDTO</span><span class="p">.</span><span class="n">winner</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">gameService</span><span class="p">.</span><span class="nf">checkmate</span><span class="p">(</span><span class="n">gameDTO</span><span class="p">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">gameService</span><span class="p">.</span><span class="nf">newGame</span><span class="p">(</span><span class="n">gameDTO</span><span class="p">)</span> <i class="conum" data-value="6"></i><b>(6)</b>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@Topic</span><span class="p">(</span><span class="s">"chessGameState"</span><span class="p">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="k">fun</span> <span class="nf">onGameState</span><span class="p">(</span><span class="n">gameState</span><span class="p">:</span> <span class="nc">GameStateDTO</span><span class="p">)</span> <span class="p">=</span> <span class="n">gameService</span><span class="p">.</span><span class="nf">newGameState</span><span class="p">(</span><span class="n">gameState</span><span class="p">)</span> <i class="conum" data-value="7"></i><b>(7)</b>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@KafkaListener</code> to declare it as a Kafka message listener; the Micronaut framework will generate the receiving code at compile time</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Dependency injection for <code>GameService</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Annotate the method with <code>@Topic</code> and specify the topic name</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use <code>GameService</code> to record that the game ended in a draw</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Use <code>GameService</code> to record that the game ended in checkmate</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Use <code>GameService</code> to record that a new game has started</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Use <code>GameService</code> to record that a new game move occurred</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="development-environment-2">4.2.7. Development environment</h4>
<div class="paragraph">
<p>Modify the <code>Application</code> class to use <code>dev</code> as a default environment:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The Micronaut framework supports the concept of one or many default environments. A default environment is one that is only applied if no other environments are explicitly specified or deduced.</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/kotlin/example/micronaut/Application.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut</span>

<span class="k">import</span> <span class="nn">io.micronaut.context.env.Environment.DEVELOPMENT</span>
<span class="k">import</span> <span class="nn">io.micronaut.runtime.Micronaut.build</span>

<span class="k">fun</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="nc">Array</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;)</span> <span class="p">{</span>
    <span class="nf">build</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">args</span><span class="p">(*</span><span class="n">args</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">packages</span><span class="p">(</span><span class="s">"example.micronaut"</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">defaultEnvironments</span><span class="p">(</span><span class="nc">DEVELOPMENT</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">start</span><span class="p">()</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/application-dev.properties</code>. The Micronaut framework applies this configuration file only for the <code>dev</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/resources/application-dev.properties</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><i class="conum" data-value="1"></i><b>(1)</b>
<span class="py">micronaut.server.port</span><span class="p">=</span><span class="s">8081</span>
<i class="conum" data-value="2"></i><b>(2)</b>
<span class="py">datasources.default.url</span><span class="p">=</span><span class="s">jdbc:h2:mem:devDb;MVCC=TRUE;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE</span>
<span class="py">datasources.default.driverClassName</span><span class="p">=</span><span class="s">org.h2.Driver</span>
<span class="py">datasources.default.username</span><span class="p">=</span><span class="s">sa</span>
<span class="py">datasources.default.password</span><span class="p">=</span>
<span class="py">datasources.default.schema-generate</span><span class="p">=</span><span class="s">none</span>
<span class="py">datasources.default.dialect</span><span class="p">=</span><span class="s">H2</span>
<i class="conum" data-value="3"></i><b>(3)</b>
<span class="py">kafka.bootstrap.servers</span><span class="p">=</span><span class="s">localhost:9092</span>
<i class="conum" data-value="4"></i><b>(4)</b>
<span class="err">flyway.datasources.default.locations[0]=</span><span class="py">classpath</span><span class="p">:</span><span class="s">db/migration/h2</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Run this microservice on port 8081; <code>chess-game</code> will run on the default port 8080</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use an in-memory H2 database. Delete the <code>datasources</code> block so it&#8217;s only in <code>application-dev.properties</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use local Kafka. Delete the <code>kafka.bootstrap.servers</code> property so it&#8217;s only in <code>application-dev.properties</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configure Flyway to look for migration scripts in <code>src/main/resources/db/migration/h2</code></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="h2-flyway-migration-script">4.2.8. H2 Flyway Migration Script</h4>
<div class="paragraph">
<p>Create a database migration script to create the database tables:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/resources/db/migration/h2/V1__create-schema.sql</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">game</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">black_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">white_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">date_created</span> <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">date_updated</span> <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">draw</span> <span class="nb">BOOLEAN</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">winner</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">game_state</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">game_id</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">date_created</span> <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">player</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">fen</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">pgn</span> <span class="k">CLOB</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">move</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">fk_game_state_game</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">game_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">game</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kafka">5. Kafka</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ll use Oracle Cloud Streaming in the "real" application, but for local development, we can use a local Kafka instance.</p>
</div>
<div class="sect2">
<h3 id="install-kafka">5.1. Install Kafka</h3>
<div class="paragraph">
<p>A fast way to start using Kafka is <a href="https://hub.docker.com/r/confluentinc/cp-kafka/">via Docker</a>. Create this <code>docker-compose.yml</code> file:</p>
</div>
<div class="listingblock">
<div class="title">docker/docker-compose.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2'</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">zookeeper</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">confluentinc/cp-zookeeper</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">2181:2181</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">ZOOKEEPER_CLIENT_PORT</span><span class="pi">:</span> <span class="m">2181</span>
      <span class="na">ZOOKEEPER_TICK_TIME</span><span class="pi">:</span> <span class="m">2000</span>
  <span class="na">kafka</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">confluentinc/cp-kafka</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">zookeeper</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">9092:9092</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">KAFKA_ZOOKEEPER_CONNECT</span><span class="pi">:</span> <span class="s">zookeeper:2181</span>
      <span class="na">KAFKA_ADVERTISED_LISTENERS</span><span class="pi">:</span> <span class="s">PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092</span>
      <span class="na">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span><span class="pi">:</span> <span class="s">PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT</span>
      <span class="na">KAFKA_INTER_BROKER_LISTENER_NAME</span><span class="pi">:</span> <span class="s">PLAINTEXT</span>
      <span class="na">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR</span><span class="pi">:</span> <span class="s">1</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ZooKeeper uses port 2181 by default, but change the value if needed</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Kafka uses port 9092 by default, but change the value if needed</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Start Zookeeper and Kafka (use CTRL-C to stop both):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker-compose up</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively you can <a href="https://kafka.apache.org/quickstart">install and run a local Kafka instance</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="running-the-application">6. Running the application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Start the <code>chess-game</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">chess-game</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">./mvnw mn:run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>16:35:55.614 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 576ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Start the <code>chess-listener</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">./mvnw mn:run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>16:35:55.614 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 623ms. Server Running: http://localhost:8081</code></pre>
</div>
</div>
<div class="paragraph">
<p>Test the app functionality by opening <a href="http://localhost:8080/" class="bare">http://localhost:8080/</a> in a browser. The UI lets you choose one or more chess games that will auto-play with the specified delay between plays. Events (game start and end, player moves) are sent to the server via Ajax and then sent to the <code>chess-listener</code> microservice for processing, analysis, etc.</p>
</div>
<div class="paragraph">
<p>You can, for example, start a single game with a moderately large delay between plays:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/ui1.png" alt="ui1">
</div>
</div>
<div class="paragraph">
<p>A single board is displayed:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/ui2.png" alt="ui2">
</div>
</div>
<div class="paragraph">
<p>Or you can start multiple games with a short delay (or any combination you want):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/ui3.png" alt="ui3">
</div>
</div>
<div class="paragraph">
<p>Multiple simultaneous boards are displayed:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/ui4.png" alt="ui4">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="moving-to-oracle-cloud">7. Moving to Oracle Cloud</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="oracle-autonomous-database-atp">7.1. Oracle Autonomous Database (ATP)</h3>
<div class="paragraph">
<p>Update the <code>chess-listener</code> microservice to support Oracle in addition to the in-memory H2 database.</p>
</div>
<div class="paragraph">
<p>Use the <a href="micronaut-oracle-autonomous-db.html">Oracle Autonomous Database guide</a> to provision an Oracle database at OCI.</p>
</div>
<div class="sect3">
<h4 id="dependencies">7.1.1. Dependencies</h4>
<div class="paragraph">
<p>Add the <code>micronaut-oraclecloud-atp</code> dependency to the <code>chess-listener</code> microservice to support using ATP:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.micronaut.oraclecloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>micronaut-oraclecloud-atp<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration">7.1.2. Configuration</h4>
<div class="paragraph">
<p>Create <code>src/main/resources/application-oraclecloud.properties</code>. The Micronaut framework applies this configuration file only for the <code>oraclecloud</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/resources/application-oraclecloud.properties</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><i class="conum" data-value="1"></i><b>(1)</b>
<span class="py">datasources.default.ocid</span><span class="p">=</span>
<i class="conum" data-value="2"></i><b>(2)</b>
<span class="py">datasources.default.walletPassword</span><span class="p">=</span>
<span class="py">datasources.default.username</span><span class="p">=</span><span class="s">micronautdemo</span>
<i class="conum" data-value="3"></i><b>(3)</b>
<span class="py">datasources.default.password</span><span class="p">=</span>
<i class="conum" data-value="4"></i><b>(4)</b>
<span class="py">oci.config.profile</span><span class="p">=</span><span class="s">DEFAULT</span>
<i class="conum" data-value="5"></i><b>(5)</b>
<span class="err">flyway.datasources.default.locations[0]=</span><span class="py">classpath</span><span class="p">:</span><span class="s">db/migration/oracle</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the value of the <code>ocid</code> property with the database OCID unique identifier you saved when creating the database</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the <code>walletPassword</code> property with a password to encrypt the wallet keys (must be at least 8 characters and include at least 1 letter and either 1 numeric or special character)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the <code>password</code> property with the <code>micronautdemo</code> schema user password you created</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Change the profile name if you&#8217;re not using the default, and optionally add a value for the path to the config file if necessary as described in the <a href="https://micronaut-projects.github.io/micronaut-oracle-cloud/latest/guide/#config-auth">Authentication section</a> of the Micronaut Oracle Cloud docs</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Configure Flyway to look for migration scripts in <code>src/main/resources/db/migration/oracle</code></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="repositories-2">7.1.3. Repositories</h4>
<div class="paragraph">
<p>Create the <code>OracleGameRepository</code> interface that extends <code>GameRepository</code> and specifies the <code>ORACLE</code> dialect in the <code>oraclecloud</code> environment:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/kotlin/example/micronaut/chess/repository/OracleGameRepository.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.chess.repository</span>

<span class="k">import</span> <span class="nn">io.micronaut.context.annotation.Primary</span>
<span class="k">import</span> <span class="nn">io.micronaut.context.annotation.Requires</span>
<span class="k">import</span> <span class="nn">io.micronaut.context.env.Environment.ORACLE_CLOUD</span>
<span class="k">import</span> <span class="nn">io.micronaut.context.env.Environment.TEST</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.jdbc.annotation.JdbcRepository</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.model.query.builder.sql.Dialect.ORACLE</span>

<span class="nd">@Primary</span>
<span class="nd">@JdbcRepository</span><span class="p">(</span><span class="n">dialect</span> <span class="p">=</span> <span class="nc">ORACLE</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@Requires</span><span class="p">(</span><span class="n">env</span> <span class="p">=</span> <span class="p">[</span><span class="nc">ORACLE_CLOUD</span><span class="p">,</span> <span class="nc">TEST</span><span class="p">])</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="kd">interface</span> <span class="nc">OracleGameRepository</span> <span class="p">:</span> <span class="nc">GameRepository</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate with <code>@JdbcRepository</code> to make this a Micronaut Data JDBC repository, and specify the <code>ORACLE</code> dialect. The Micronaut framework will generate persistence logic at compile time and use Oracle-specific SQL.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Restrict the bean to be available only in the <code>oraclecloud</code> environment</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the <code>OracleGameStateRepository</code> interface that extends <code>GameStateRepository</code>:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/kotlin/example/micronaut/chess/repository/OracleGameStateRepository.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.chess.repository</span>

<span class="k">import</span> <span class="nn">io.micronaut.context.annotation.Primary</span>
<span class="k">import</span> <span class="nn">io.micronaut.context.annotation.Requires</span>
<span class="k">import</span> <span class="nn">io.micronaut.context.env.Environment.ORACLE_CLOUD</span>
<span class="k">import</span> <span class="nn">io.micronaut.context.env.Environment.TEST</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.jdbc.annotation.JdbcRepository</span>
<span class="k">import</span> <span class="nn">io.micronaut.data.model.query.builder.sql.Dialect.ORACLE</span>

<span class="nd">@Primary</span>
<span class="nd">@JdbcRepository</span><span class="p">(</span><span class="n">dialect</span> <span class="p">=</span> <span class="nc">ORACLE</span><span class="p">)</span>
<span class="nd">@Requires</span><span class="p">(</span><span class="n">env</span> <span class="p">=</span> <span class="p">[</span><span class="nc">ORACLE_CLOUD</span><span class="p">,</span> <span class="nc">TEST</span><span class="p">])</span>
<span class="kd">interface</span> <span class="nc">OracleGameStateRepository</span> <span class="p">:</span> <span class="nc">GameStateRepository</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="flyway-2">7.1.4. Flyway</h4>
<div class="paragraph">
<p>Create a database migration script to create the Oracle database tables:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/resources/db/migration/oracle/V1__create-schema.sql</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">game</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">black_name</span> <span class="n">VARCHAR2</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">white_name</span> <span class="n">VARCHAR2</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">date_created</span> <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">date_updated</span> <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">draw</span> <span class="n">NUMBER</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">winner</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">game_state</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">game_id</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">36</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">date_created</span> <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">player</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">fen</span> <span class="n">VARCHAR2</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">pgn</span> <span class="k">CLOB</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">move</span> <span class="n">VARCHAR2</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">CONSTRAINT</span> <span class="n">fk_game_state_game</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">game_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">game</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="oracle-cloud-streaming">7.2. Oracle Cloud Streaming</h3>
<div class="paragraph">
<p>Up to now, we&#8217;ve been using a local Kafka, but let&#8217;s configure the equivalent infrastructure in OCI. This will involve minimal application changes thanks to the ability to send and receive Cloud Streaming messages using Kafka APIs, and <a href="https://micronaut-projects.github.io/micronaut-kafka/latest/guide/">Micronaut support for Kafka</a>.</p>
</div>
<div class="sect3">
<h4 id="stream-pool-and-streams">7.2.1. Stream Pool and Streams</h4>
<div class="paragraph">
<p>Log in to your Oracle Cloud tenancy and from the Oracle Cloud Menu, select "Analytics &amp; AI" and then "Streaming":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/create.stream.1.png" alt="create.stream.1">
</div>
</div>
<div class="paragraph">
<p>Choose the compartment to create the streams in, then click "Create Stream Pool":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/create.stream.2.png" alt="create.stream.2">
</div>
</div>
<div class="paragraph">
<p>Enter a name for the pool, e.g., "mn-guide-pool", and click "Create":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/create.stream.3.png" alt="create.stream.3">
</div>
</div>
<div class="paragraph">
<p>Click the "Copy" link in the <code>OCID</code> row and save the value for later. Also save the "FQDN" URL. Click "Create Stream":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/create.stream.4.png" alt="create.stream.4">
</div>
</div>
<div class="paragraph">
<p>Create two streams within the pool you created with the Topic names used in the microservices. First create "chessGame":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/create.stream.5.png" alt="create.stream.5">
</div>
</div>
<div class="paragraph">
<p>and then create "chessGameState":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/create.stream.6.png" alt="create.stream.6">
</div>
</div>
</div>
<div class="sect3">
<h4 id="user-and-group">7.2.2. User and Group</h4>
<div class="paragraph">
<p>Create a group for the streams by clicking the Oracle Cloud menu and selecting "Identity &amp; Security" and then click "Groups":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user1.png" alt="user1">
</div>
</div>
<div class="paragraph">
<p>Click "Create Group":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user2.png" alt="user2">
</div>
</div>
<div class="paragraph">
<p>Choose a name and a description, e.g., "mn-guide-streaming-group", and click "Create":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user3.png" alt="user3">
</div>
</div>
<div class="paragraph">
<p>Create a user by clicking the Oracle Cloud menu and selecting "Identity &amp; Security" and then click "Users":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user4.png" alt="user4">
</div>
</div>
<div class="paragraph">
<p>Click "Create User":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user5.png" alt="user5">
</div>
</div>
<div class="paragraph">
<p>Choose a name and a description, e.g., "mn-guide-streaming-user", and click "Create":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user6.png" alt="user6">
</div>
</div>
<div class="paragraph">
<p>Scroll down and click "Add User to Group":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user7.png" alt="user7">
</div>
</div>
<div class="paragraph">
<p>Select the group you created and click "Add":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user8.png" alt="user8">
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll need an auth token to use as the password in the Micronaut Kafka configuration. Click "Auth Tokens" and then "Generate Token":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user9.png" alt="user9">
</div>
</div>
<div class="paragraph">
<p>Enter a name for the token, e.g., "mn-guide-streaming", and click "Generate Token":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user10.png" alt="user10">
</div>
</div>
<div class="paragraph">
<p>Copy the token to the clipboard and save it for later:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user11.png" alt="user11">
</div>
</div>
<div class="paragraph">
<p>See the <a href="https://docs.oracle.com/en-us/iaas/Content/Functions/Tasks/functionscreatinggroupsusers.htm">Groups and Users docs</a> for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="policy">7.2.3. Policy</h4>
<div class="paragraph">
<p>Create a policy to grant various Streams access to the user and group you created.</p>
</div>
<div class="paragraph">
<p>Open the Oracle Cloud Menu and click "Identity &amp; Security" and then "Policies":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/policy1.png" alt="policy1">
</div>
</div>
<div class="paragraph">
<p>Select the compartment where you created the streams from the dropdown and click "Create Policy":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/policy2.png" alt="policy2">
</div>
</div>
<div class="paragraph">
<p>Choose a name and description, e.g., "mn-guide-streaming-policy", and click "Show Manual Editor". Copy the following and paste it into the "Policy Builder" field, replacing "micronaut-guides" with the name of the compartment you&#8217;re using, and click "Create":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/policy3.png" alt="policy3">
</div>
</div>
</div>
<div class="sect3">
<h4 id="application-configuration">7.2.4. Application configuration</h4>
<div class="paragraph">
<p>Create <code>src/main/resources/application-oraclecloud.properties</code> in the <code>chess-game</code> microservice. Add the following there, and also add it to the <code>application-oraclecloud.properties</code> you already created in the <code>chess-listener</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/resources/application-oraclecloud.properties</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><i class="conum" data-value="1"></i><b>(1)</b>
<span class="py">kafka.bootstrap.servers</span><span class="p">=</span>

<span class="py">kafka.security.protocol</span><span class="p">=</span><span class="s">SASL_SSL</span>
<span class="py">kafka.sasl.mechanism</span><span class="p">=</span><span class="s">PLAIN</span>
<i class="conum" data-value="2"></i><b>(2)</b>
<span class="py">kafka.sasl.jaas.config</span><span class="p">=</span>

<span class="py">kafka.retries</span><span class="p">=</span><span class="s">3</span>
<i class="conum" data-value="3"></i><b>(3)</b>
<span class="py">kafka.max.request.size</span><span class="p">=</span><span class="s">1048576</span>
<i class="conum" data-value="4"></i><b>(4)</b>
<span class="py">kafka.max.partition.fetch.bytes</span><span class="p">=</span><span class="s">1048576</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the "FQDN" URL value you saved earlier here, along with the Kafka port (9092), e.g., <code>cell-1.streaming.us-ashburn-1.oci.oraclecloud.com:9092</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use the value <code>config: org.apache.kafka.common.security.plain.PlainLoginModule required username="&lt;tenancy-name&gt;/&lt;username&gt;/&lt;stream-pool-ocid&gt;" password="&lt;auth-token&gt;";</code>, replacing <code>&lt;tenancy-name&gt;</code> with the name of your tenancy, <code>&lt;username&gt;</code> with the username created above, <code>&lt;stream-pool-ocid&gt;</code> with the OCID of the stream pool you saved earlier, and <code>&lt;auth-token&gt;</code> with the auth token value you saved earlier.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Limit request size to 1MB</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Limit request size to 1MB per partition</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="local-testing-with-cloud-resources">8. Local Testing with Cloud Resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can now start both microservices in the <code>oraclecloud</code> environment to use Cloud Streaming and the ATP database you created:</p>
</div>
<div class="paragraph">
<p>To run each application use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">MICRONAUT_ENVIRONMENTS</span><span class="o">=</span>oraclecloud ./mvnw mn:run</code></pre>
</div>
</div>
<div class="paragraph">
<p>or if you use Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">cmd /C <span class="s2">"set MICRONAUT_ENVIRONMENTS=oraclecloud &amp;&amp; mvnw mn:run"</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-tests">9. Writing Tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ll run Kafka inside a Docker container using <a href="https://www.testcontainers.org/">Testcontainers</a> for both application tests and also run Oracle database inside a Docker container for testing persistence in the <code>chess-listener</code> tests.</p>
</div>
<div class="sect2">
<h3 id="chess-game-tests">9.1. chess-game tests</h3>
<div class="paragraph">
<p>Create a test in the <code>chess-game</code> microservice to verify that Kafka message processing works:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/test/kotlin/example/micronaut/GameReporterTest.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut</span>

<span class="k">import</span> <span class="nn">example.micronaut.chess.dto.GameDTO</span>
<span class="k">import</span> <span class="nn">example.micronaut.chess.dto.GameStateDTO</span>
<span class="k">import</span> <span class="nn">io.micronaut.configuration.kafka.annotation.KafkaListener</span>
<span class="k">import</span> <span class="nn">io.micronaut.configuration.kafka.annotation.OffsetReset.EARLIEST</span>
<span class="k">import</span> <span class="nn">io.micronaut.configuration.kafka.annotation.Topic</span>
<span class="k">import</span> <span class="nn">io.micronaut.core.type.Argument</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.HttpRequest</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.MediaType.APPLICATION_FORM_URLENCODED_TYPE</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.HttpClient</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.annotation.Client</span>
<span class="k">import</span> <span class="nn">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span>
<span class="k">import</span> <span class="nn">io.micronaut.test.support.TestPropertyProvider</span>
<span class="k">import</span> <span class="nn">org.awaitility.Awaitility.await</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.AfterEach</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertEquals</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertFalse</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertNull</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertTrue</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Test</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.TestInstance</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.TestInstance.Lifecycle.PER_CLASS</span>
<span class="k">import</span> <span class="nn">org.testcontainers.kafka.KafkaContainer</span>
<span class="k">import</span> <span class="nn">org.testcontainers.junit.jupiter.Container</span>
<span class="k">import</span> <span class="nn">org.testcontainers.junit.jupiter.Testcontainers</span>
<span class="k">import</span> <span class="nn">org.testcontainers.utility.DockerImageName</span>
<span class="k">import</span> <span class="nn">java.util.Optional</span>
<span class="k">import</span> <span class="nn">java.util.concurrent.ConcurrentLinkedDeque</span>
<span class="k">import</span> <span class="nn">java.util.concurrent.TimeUnit.SECONDS</span>
<span class="k">import</span> <span class="nn">jakarta.inject.Inject</span>

<span class="nd">@Testcontainers</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@MicronautTest</span>
<span class="nd">@TestInstance</span><span class="p">(</span><span class="nc">PER_CLASS</span><span class="p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="kd">class</span> <span class="nc">GameReporterTest</span> <span class="p">:</span> <span class="nc">TestPropertyProvider</span> <span class="p">{</span> <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">receivedGames</span><span class="p">:</span> <span class="nc">MutableCollection</span><span class="p">&lt;</span><span class="nc">GameDTO</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nc">ConcurrentLinkedDeque</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">receivedMoves</span><span class="p">:</span> <span class="nc">MutableCollection</span><span class="p">&lt;</span><span class="nc">GameStateDTO</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nc">ConcurrentLinkedDeque</span><span class="p">()</span>

        <span class="nd">@Container</span>
        <span class="kd">val</span> <span class="py">kafka</span> <span class="p">=</span> <span class="nc">KafkaContainer</span><span class="p">(</span><span class="nc">DockerImageName</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s">"apache/kafka:latest"</span><span class="p">))</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="p">}</span>

    <span class="nd">@Inject</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">chessListener</span><span class="p">:</span> <span class="nc">ChessListener</span> <i class="conum" data-value="5"></i><b>(5)</b>

    <span class="nd">@Inject</span> <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Client</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span> <i class="conum" data-value="7"></i><b>(7)</b>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">client</span><span class="p">:</span> <span class="nc">HttpClient</span> <i class="conum" data-value="8"></i><b>(8)</b>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">testGameEndingInCheckmate</span><span class="p">()</span> <span class="p">{</span>

        <span class="kd">val</span> <span class="py">blackName</span> <span class="p">=</span> <span class="s">"b_name"</span>
        <span class="kd">val</span> <span class="py">whiteName</span> <span class="p">=</span> <span class="s">"w_name"</span>

        <span class="c1">// start game</span>

        <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="nf">startGame</span><span class="p">(</span><span class="n">blackName</span><span class="p">,</span> <span class="n">whiteName</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">gameId</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="nf">orElseThrow</span> <span class="p">{</span> <span class="nc">RuntimeException</span><span class="p">(</span><span class="s">"Expected GameDTO id"</span><span class="p">)</span> <span class="p">}</span>

        <span class="nf">await</span><span class="p">().</span><span class="nf">atMost</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nc">SECONDS</span><span class="p">).</span><span class="nf">until</span> <span class="p">{</span> <span class="p">!</span><span class="n">receivedGames</span><span class="p">.</span><span class="nf">isEmpty</span><span class="p">()</span> <span class="p">}</span> <i class="conum" data-value="9"></i><b>(9)</b>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">receivedGames</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">receivedMoves</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>

        <span class="kd">var</span> <span class="py">game</span> <span class="p">=</span> <span class="n">receivedGames</span><span class="p">.</span><span class="nf">iterator</span><span class="p">().</span><span class="nf">next</span><span class="p">()</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">blackName</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">blackName</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">whiteName</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">whiteName</span><span class="p">)</span>
        <span class="nf">assertFalse</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">draw</span><span class="p">)</span>
        <span class="nf">assertNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">winner</span><span class="p">)</span>

        <span class="c1">// make moves</span>
        <span class="n">receivedGames</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="nf">makeMove</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="s">"f3"</span><span class="p">,</span> <span class="s">"rnbqkbnr/pppppppp/8/8/8/5P2/PPPPP1PP/RNBQKBNR b KQkq - 0 1"</span><span class="p">,</span> <span class="s">"1. f3"</span><span class="p">)</span>
        <span class="nf">makeMove</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">"e6"</span><span class="p">,</span> <span class="s">"rnbqkbnr/pppp1ppp/4p3/8/8/5P2/PPPPP1PP/RNBQKBNR w KQkq - 0 2"</span><span class="p">,</span> <span class="s">"1. f3 e6"</span><span class="p">)</span>
        <span class="nf">makeMove</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="s">"g4"</span><span class="p">,</span> <span class="s">"rnbqkbnr/pppp1ppp/4p3/8/6P1/5P2/PPPPP2P/RNBQKBNR b KQkq g3 0 2"</span><span class="p">,</span> <span class="s">"1. f3 e6 2. g4"</span><span class="p">)</span>
        <span class="nf">makeMove</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">"Qh4#"</span><span class="p">,</span> <span class="s">"rnb1kbnr/pppp1ppp/4p3/8/6Pq/5P2/PPPPP2P/RNBQKBNR w KQkq - 1 3"</span><span class="p">,</span> <span class="s">"1. f3 e6 2. g4 Qh4#"</span><span class="p">)</span>

        <span class="nf">await</span><span class="p">().</span><span class="nf">atMost</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nc">SECONDS</span><span class="p">).</span><span class="nf">until</span> <span class="p">{</span> <span class="n">receivedMoves</span><span class="p">.</span><span class="n">size</span> <span class="p">&gt;</span> <span class="mi">3</span> <span class="p">}</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">receivedGames</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">receivedMoves</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>

        <span class="kd">val</span> <span class="py">moves</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">GameStateDTO</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nc">ArrayList</span><span class="p">(</span><span class="n">receivedMoves</span><span class="p">)</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"w"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">player</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"f3"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">move</span><span class="p">)</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"b"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">player</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"e6"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">move</span><span class="p">)</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"w"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">player</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"g4"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">move</span><span class="p">)</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"b"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">player</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"Qh4#"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">move</span><span class="p">)</span>

        <span class="c1">// end game</span>

        <span class="n">receivedMoves</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="nf">endGame</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="s">"b"</span><span class="p">)</span>

        <span class="nf">await</span><span class="p">().</span><span class="nf">atMost</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nc">SECONDS</span><span class="p">).</span><span class="nf">until</span> <span class="p">{</span> <span class="p">!</span><span class="n">receivedGames</span><span class="p">.</span><span class="nf">isEmpty</span><span class="p">()</span> <span class="p">}</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">receivedGames</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">receivedMoves</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>

        <span class="n">game</span> <span class="p">=</span> <span class="n">receivedGames</span><span class="p">.</span><span class="nf">iterator</span><span class="p">().</span><span class="nf">next</span><span class="p">()</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">blackName</span><span class="p">)</span>
        <span class="nf">assertNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">whiteName</span><span class="p">)</span>
        <span class="nf">assertFalse</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">draw</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"b"</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">winner</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">testGameEndingInDraw</span><span class="p">()</span> <span class="p">{</span>

        <span class="kd">val</span> <span class="py">blackName</span> <span class="p">=</span> <span class="s">"b_name"</span>
        <span class="kd">val</span> <span class="py">whiteName</span> <span class="p">=</span> <span class="s">"w_name"</span>

        <span class="c1">// start game</span>
        <span class="kd">val</span> <span class="py">result</span> <span class="p">=</span> <span class="nf">startGame</span><span class="p">(</span><span class="n">blackName</span><span class="p">,</span> <span class="n">whiteName</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">gameId</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="nf">orElseThrow</span> <span class="p">{</span> <span class="nc">RuntimeException</span><span class="p">(</span><span class="s">"Expected GameDTO id"</span><span class="p">)</span> <span class="p">}</span>

        <span class="nf">await</span><span class="p">().</span><span class="nf">atMost</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nc">SECONDS</span><span class="p">).</span><span class="nf">until</span> <span class="p">{</span> <span class="p">!</span><span class="n">receivedGames</span><span class="p">.</span><span class="nf">isEmpty</span><span class="p">()</span> <span class="p">}</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">receivedGames</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">receivedMoves</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>

        <span class="kd">var</span> <span class="py">game</span> <span class="p">=</span> <span class="n">receivedGames</span><span class="p">.</span><span class="nf">iterator</span><span class="p">().</span><span class="nf">next</span><span class="p">()</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">blackName</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">blackName</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">whiteName</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">whiteName</span><span class="p">)</span>
        <span class="nf">assertFalse</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">draw</span><span class="p">)</span>
        <span class="nf">assertNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">winner</span><span class="p">)</span>

        <span class="c1">// make moves</span>

        <span class="n">receivedGames</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="nf">makeMove</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="s">"f3"</span><span class="p">,</span> <span class="s">"rnbqkbnr/pppppppp/8/8/8/5P2/PPPPP1PP/RNBQKBNR b KQkq - 0 1"</span><span class="p">,</span> <span class="s">"1. f3"</span><span class="p">)</span>
        <span class="nf">makeMove</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">"e6"</span><span class="p">,</span> <span class="s">"rnbqkbnr/pppp1ppp/4p3/8/8/5P2/PPPPP1PP/RNBQKBNR w KQkq - 0 2"</span><span class="p">,</span> <span class="s">"1. f3 e6"</span><span class="p">)</span>

        <span class="nf">await</span><span class="p">().</span><span class="nf">atMost</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nc">SECONDS</span><span class="p">).</span><span class="nf">until</span> <span class="p">{</span> <span class="n">receivedMoves</span><span class="p">.</span><span class="n">size</span> <span class="p">&gt;</span> <span class="mi">1</span> <span class="p">}</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">receivedGames</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">receivedMoves</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>

        <span class="c1">// end game</span>

        <span class="n">receivedMoves</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>

        <span class="nf">endGame</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>

        <span class="nf">await</span><span class="p">().</span><span class="nf">atMost</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nc">SECONDS</span><span class="p">).</span><span class="nf">until</span> <span class="p">{</span> <span class="p">!</span><span class="n">receivedGames</span><span class="p">.</span><span class="nf">isEmpty</span><span class="p">()</span> <span class="p">}</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">receivedGames</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">receivedMoves</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>

        <span class="n">game</span> <span class="p">=</span> <span class="n">receivedGames</span><span class="p">.</span><span class="nf">iterator</span><span class="p">().</span><span class="nf">next</span><span class="p">()</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">blackName</span><span class="p">)</span>
        <span class="nf">assertNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">whiteName</span><span class="p">)</span>
        <span class="nf">assertTrue</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">draw</span><span class="p">)</span>
        <span class="nf">assertNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">winner</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getProperties</span><span class="p">():</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="n">kafka</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">mapOf</span><span class="p">(</span><span class="s">"kafka.bootstrap.servers"</span> <span class="n">to</span> <span class="n">kafka</span><span class="p">.</span><span class="n">bootstrapServers</span><span class="p">)</span> <i class="conum" data-value="10"></i><b>(10)</b>
    <span class="p">}</span>

    <span class="nd">@AfterEach</span>
    <span class="k">fun</span> <span class="nf">cleanup</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">receivedGames</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
        <span class="n">receivedMoves</span><span class="p">.</span><span class="nf">clear</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nd">@KafkaListener</span><span class="p">(</span><span class="n">offsetReset</span> <span class="p">=</span> <span class="nc">EARLIEST</span><span class="p">)</span>
    <span class="kd">class</span> <span class="nc">ChessListener</span> <span class="p">{</span>
        <span class="nd">@Topic</span><span class="p">(</span><span class="s">"chessGame"</span><span class="p">)</span>
        <span class="k">fun</span> <span class="nf">onGame</span><span class="p">(</span><span class="n">game</span><span class="p">:</span> <span class="nc">GameDTO</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">receivedGames</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">game</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nd">@Topic</span><span class="p">(</span><span class="s">"chessGameState"</span><span class="p">)</span>
        <span class="k">fun</span> <span class="nf">onGameState</span><span class="p">(</span><span class="n">gameState</span><span class="p">:</span> <span class="nc">GameStateDTO</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">receivedMoves</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">gameState</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">startGame</span><span class="p">(</span><span class="n">blackName</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">whiteName</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">Optional</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">body</span> <span class="p">=</span> <span class="nf">mapOf</span><span class="p">(</span><span class="s">"b"</span> <span class="n">to</span> <span class="n">blackName</span><span class="p">,</span> <span class="s">"w"</span> <span class="n">to</span> <span class="n">whiteName</span><span class="p">)</span> <i class="conum" data-value="11"></i><b>(11)</b>
        <span class="kd">val</span> <span class="py">request</span><span class="p">:</span> <span class="nc">HttpRequest</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nc">HttpRequest</span><span class="p">.</span><span class="nc">POST</span><span class="p">(</span><span class="s">"/game/start"</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">contentType</span><span class="p">(</span><span class="nc">APPLICATION_FORM_URLENCODED_TYPE</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">client</span><span class="p">.</span><span class="nf">toBlocking</span><span class="p">().</span><span class="nf">retrieve</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                <span class="nc">Argument</span><span class="p">.</span><span class="nf">of</span><span class="p">(</span><span class="nc">Optional</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">,</span> <span class="nc">String</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">))</span> <span class="k">as</span> <span class="nc">Optional</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;</span> <i class="conum" data-value="12"></i><b>(12)</b>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">makeMove</span><span class="p">(</span><span class="n">gameId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">player</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">move</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
                         <span class="n">fen</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">pgn</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">val</span> <span class="py">body</span> <span class="p">=</span> <span class="nf">mapOf</span><span class="p">(</span><span class="s">"player"</span> <span class="n">to</span> <span class="n">player</span><span class="p">,</span> <span class="s">"move"</span> <span class="n">to</span> <span class="n">move</span><span class="p">,</span> <span class="s">"fen"</span> <span class="n">to</span> <span class="n">fen</span><span class="p">,</span> <span class="s">"pgn"</span> <span class="n">to</span> <span class="n">pgn</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">request</span> <span class="p">=</span> <span class="nc">HttpRequest</span><span class="p">.</span><span class="nc">POST</span><span class="p">(</span><span class="s">"/game/move/$gameId"</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">contentType</span><span class="p">(</span><span class="nc">APPLICATION_FORM_URLENCODED_TYPE</span><span class="p">)</span>
        <span class="n">client</span><span class="p">.</span><span class="nf">toBlocking</span><span class="p">().</span><span class="n">exchange</span><span class="p">&lt;</span><span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;,</span> <span class="nc">Any</span><span class="p">&gt;(</span><span class="n">request</span><span class="p">)</span> <i class="conum" data-value="13"></i><b>(13)</b>

    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">endGame</span><span class="p">(</span><span class="n">gameId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">winner</span><span class="p">:</span> <span class="nc">String</span><span class="p">?)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">uri</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">winner</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="s">"/game/draw/$gameId"</span> <span class="k">else</span> <span class="s">"/game/checkmate/$gameId/$winner"</span>
        <span class="kd">val</span> <span class="py">request</span><span class="p">:</span> <span class="nc">HttpRequest</span><span class="p">&lt;</span><span class="nc">Any</span><span class="p">?&gt;</span> <span class="p">=</span> <span class="nc">HttpRequest</span><span class="p">.</span><span class="nc">POST</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
        <span class="n">client</span><span class="p">.</span><span class="nf">toBlocking</span><span class="p">().</span><span class="n">exchange</span><span class="p">&lt;</span><span class="nc">Any</span><span class="p">?,</span> <span class="nc">Any</span><span class="p">&gt;(</span><span class="n">request</span><span class="p">)</span> <i class="conum" data-value="14"></i><b>(14)</b>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <code>@Testcontainers</code> annotation to configure automatic container management (not necessary in Spock tests)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Classes that implement <code>TestPropertyProvider</code> must use this annotation to create a single class instance for all tests (not necessary in Spock tests).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Implementing <code>TestPropertyProvider</code> allows the test class to provide application configuration properties, in this case the dynamically allocated Kafka broker port</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The Testcontainers instance for Kafka</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Dependency injection for the <code>ChessListener</code> class declared below, a Kafka listener class that replicates the functionality of the class of the same name in the <code>chess-listener</code> microservice</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Dependency injection for an HTTP client that the Micronaut framework will implement at compile time to make calls to <code>GameController</code></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>When annotating a property or a primary constructor parameter, multiple Java elements are generated from the corresponding Kotlin element, and therefore multiple locations for the annotation in the generated Java bytecode. <code>@field:</code> specifies that it should annotate a Java field.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>By using <code>lateinit</code>, you tell Kotlin that you have not forgotten to initialize the variable and plan to get to that momentarily. Without <code>lateinit</code>, the Kotlin compiler will give an error for the unassigned variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Wait a few seconds for the message to arrive; it should happen very quickly, but the message will be sent on a separate thread</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Configure the Kafka broker port (it will be different unused port each time) so Micronaut Kafka clients and listeners connect to the test broker</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Use a Map to hold form parameter names and values</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Use the <code>HttpClient</code> to send a POST request that indicates a game has started, which will trigger sending a message with Kafka</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>Use the <code>HttpClient</code> to send a POST request that indicates a game move has occurred, which will trigger sending a message with Kafka</td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td>Use the <code>HttpClient</code> to send a POST request that indicates a game has ended (in either a draw or checkmate), which will trigger sending a message with Kafka</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="chess-listener-tests">9.2. chess-listener tests</h3>
<div class="paragraph">
<p>Create a test in the <code>chess-listener</code> microservice to verify that Kafka message processing and database persistence works:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/test/kotlin/example/micronaut/GameServiceTest.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut</span>

<span class="k">import</span> <span class="nn">example.micronaut.chess.dto.GameDTO</span>
<span class="k">import</span> <span class="nn">example.micronaut.chess.dto.GameStateDTO</span>
<span class="k">import</span> <span class="nn">example.micronaut.chess.entity.GameState</span>
<span class="k">import</span> <span class="nn">example.micronaut.chess.repository.GameRepository</span>
<span class="k">import</span> <span class="nn">example.micronaut.chess.repository.GameStateRepository</span>
<span class="k">import</span> <span class="nn">io.micronaut.configuration.kafka.annotation.KafkaClient</span>
<span class="k">import</span> <span class="nn">io.micronaut.configuration.kafka.annotation.KafkaKey</span>
<span class="k">import</span> <span class="nn">io.micronaut.configuration.kafka.annotation.Topic</span>
<span class="k">import</span> <span class="nn">io.micronaut.core.annotation.NonNull</span>
<span class="k">import</span> <span class="nn">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span>
<span class="k">import</span> <span class="nn">io.micronaut.test.support.TestPropertyProvider</span>
<span class="k">import</span> <span class="nn">org.awaitility.Awaitility.await</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.AfterEach</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertEquals</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertFalse</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertNull</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertTrue</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Test</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.TestInstance</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.TestInstance.Lifecycle.PER_CLASS</span>
<span class="k">import</span> <span class="nn">org.testcontainers.kafka.KafkaContainer</span>
<span class="k">import</span> <span class="nn">org.testcontainers.junit.jupiter.Container</span>
<span class="k">import</span> <span class="nn">org.testcontainers.junit.jupiter.Testcontainers</span>
<span class="k">import</span> <span class="nn">org.testcontainers.utility.DockerImageName</span>
<span class="k">import</span> <span class="nn">reactor.core.publisher.Mono</span>
<span class="k">import</span> <span class="nn">java.util.UUID</span>
<span class="k">import</span> <span class="nn">java.util.concurrent.TimeUnit.SECONDS</span>
<span class="k">import</span> <span class="nn">jakarta.inject.Inject</span>

<span class="nd">@Testcontainers</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@MicronautTest</span>
<span class="nd">@TestInstance</span><span class="p">(</span><span class="nc">PER_CLASS</span><span class="p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="kd">class</span> <span class="nc">GameServiceTest</span> <span class="p">:</span> <span class="nc">TestPropertyProvider</span> <span class="p">{</span> <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="nd">@Container</span>
        <span class="kd">var</span> <span class="py">kafka</span> <span class="p">=</span> <span class="nc">KafkaContainer</span><span class="p">(</span>
                <span class="nc">DockerImageName</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s">"apache/kafka:latest"</span><span class="p">))</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="p">}</span>

    <span class="nd">@Inject</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">gameReporter</span><span class="p">:</span> <span class="nc">GameReporter</span> <i class="conum" data-value="5"></i><b>(5)</b>

    <span class="nd">@Inject</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">gameRepository</span><span class="p">:</span> <span class="nc">GameRepository</span>

    <span class="nd">@Inject</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">gameStateRepository</span><span class="p">:</span> <span class="nc">GameStateRepository</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">testGameEndingInCheckmate</span><span class="p">()</span> <span class="p">{</span>

        <span class="kd">val</span> <span class="py">blackName</span> <span class="p">=</span> <span class="s">"b_name"</span>
        <span class="kd">val</span> <span class="py">whiteName</span> <span class="p">=</span> <span class="s">"w_name"</span>

        <span class="c1">// start game</span>
        <span class="kd">val</span> <span class="py">gameId</span> <span class="p">=</span> <span class="nc">UUID</span><span class="p">.</span><span class="nf">randomUUID</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">gameIdString</span> <span class="p">=</span> <span class="n">gameId</span><span class="p">.</span><span class="nf">toString</span><span class="p">()</span>
        <span class="kd">var</span> <span class="py">gameDto</span> <span class="p">=</span> <span class="nc">GameDTO</span><span class="p">(</span><span class="n">gameIdString</span><span class="p">,</span> <span class="n">blackName</span><span class="p">,</span> <span class="n">whiteName</span><span class="p">)</span>

        <span class="n">gameReporter</span><span class="p">.</span><span class="nf">game</span><span class="p">(</span><span class="n">gameIdString</span><span class="p">,</span> <span class="n">gameDto</span><span class="p">).</span><span class="nf">subscribe</span><span class="p">()</span>

        <span class="nf">await</span><span class="p">().</span><span class="nf">atMost</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nc">SECONDS</span><span class="p">).</span><span class="nf">until</span> <span class="p">{</span> <span class="n">gameRepository</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">}</span> <i class="conum" data-value="6"></i><b>(6)</b>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">gameRepository</span><span class="p">.</span><span class="nf">count</span><span class="p">())</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gameStateRepository</span><span class="p">.</span><span class="nf">count</span><span class="p">())</span>

        <span class="kd">var</span> <span class="py">game</span> <span class="p">=</span> <span class="n">gameRepository</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="n">gameId</span><span class="p">).</span><span class="nf">orElseThrow</span> <span class="p">{</span> <span class="nc">IllegalStateException</span><span class="p">(</span><span class="s">"Unable to find expected Game"</span><span class="p">)</span> <span class="p">}</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">blackName</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">blackName</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">whiteName</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">whiteName</span><span class="p">)</span>
        <span class="nf">assertFalse</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">draw</span><span class="p">)</span>
        <span class="nf">assertNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">winner</span><span class="p">)</span>

        <span class="c1">// make moves</span>
        <span class="kd">val</span> <span class="py">gameStateIds</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="nc">UUID</span><span class="p">&gt;()</span>

        <span class="kd">var</span> <span class="py">gameStateId</span> <span class="p">=</span> <span class="nf">makeMove</span><span class="p">(</span><span class="n">gameIdString</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="s">"f3"</span><span class="p">,</span> <span class="s">"rnbqkbnr/pppppppp/8/8/8/5P2/PPPPP1PP/RNBQKBNR b KQkq - 0 1"</span><span class="p">,</span> <span class="s">"1. f3"</span><span class="p">)</span>
        <span class="n">gameStateIds</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">gameStateId</span><span class="p">)</span>

        <span class="n">gameStateId</span> <span class="p">=</span> <span class="nf">makeMove</span><span class="p">(</span><span class="n">gameIdString</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">"e6"</span><span class="p">,</span> <span class="s">"rnbqkbnr/pppp1ppp/4p3/8/8/5P2/PPPPP1PP/RNBQKBNR w KQkq - 0 2"</span><span class="p">,</span> <span class="s">"1. f3 e6"</span><span class="p">)</span>
        <span class="n">gameStateIds</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">gameStateId</span><span class="p">)</span>

        <span class="n">gameStateId</span> <span class="p">=</span> <span class="nf">makeMove</span><span class="p">(</span><span class="n">gameIdString</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="s">"g4"</span><span class="p">,</span> <span class="s">"rnbqkbnr/pppp1ppp/4p3/8/6P1/5P2/PPPPP2P/RNBQKBNR b KQkq g3 0 2"</span><span class="p">,</span> <span class="s">"1. f3 e6 2. g4"</span><span class="p">)</span>
        <span class="n">gameStateIds</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">gameStateId</span><span class="p">)</span>

        <span class="n">gameStateId</span> <span class="p">=</span> <span class="nf">makeMove</span><span class="p">(</span><span class="n">gameIdString</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">"Qh4#"</span><span class="p">,</span> <span class="s">"rnb1kbnr/pppp1ppp/4p3/8/6Pq/5P2/PPPPP2P/RNBQKBNR w KQkq - 1 3"</span><span class="p">,</span> <span class="s">"1. f3 e6 2. g4 Qh4#"</span><span class="p">)</span>
        <span class="n">gameStateIds</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">gameStateId</span><span class="p">)</span>

        <span class="nf">await</span><span class="p">().</span><span class="nf">atMost</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nc">SECONDS</span><span class="p">).</span><span class="nf">until</span> <span class="p">{</span> <span class="n">gameStateRepository</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span> <span class="p">&gt;</span> <span class="mi">3</span> <span class="p">}</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">gameRepository</span><span class="p">.</span><span class="nf">count</span><span class="p">())</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">gameStateRepository</span><span class="p">.</span><span class="nf">count</span><span class="p">())</span>

        <span class="kd">val</span> <span class="py">moves</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="nc">GameState</span><span class="p">&gt;()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="k">in</span> <span class="n">gameStateIds</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">moves</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">gameStateRepository</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="n">id</span><span class="p">).</span><span class="nf">orElseThrow</span> <span class="p">{</span> <span class="nc">IllegalStateException</span><span class="p">(</span><span class="s">"Unable to find expected GameState"</span><span class="p">)</span> <span class="p">}</span><span class="o">!!</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"w"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">player</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"f3"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">move</span><span class="p">)</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"b"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">player</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"e6"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">move</span><span class="p">)</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"w"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">player</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"g4"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">move</span><span class="p">)</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"b"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">player</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"Qh4#"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">move</span><span class="p">)</span>

        <span class="c1">// end game</span>
        <span class="n">gameDto</span> <span class="p">=</span> <span class="nc">GameDTO</span><span class="p">(</span><span class="n">gameIdString</span><span class="p">,</span> <span class="k">false</span><span class="p">,</span> <span class="s">"b"</span><span class="p">)</span>
        <span class="n">gameReporter</span><span class="p">.</span><span class="nf">game</span><span class="p">(</span><span class="n">gameIdString</span><span class="p">,</span> <span class="n">gameDto</span><span class="p">).</span><span class="nf">subscribe</span><span class="p">()</span>

        <span class="nf">await</span><span class="p">().</span><span class="nf">atMost</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nc">SECONDS</span><span class="p">).</span><span class="nf">until</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">g</span> <span class="p">=</span> <span class="n">gameRepository</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="n">gameId</span><span class="p">).</span><span class="nf">orElse</span><span class="p">(</span><span class="k">null</span><span class="p">)</span> <span class="o">?:</span> <span class="k">return</span><span class="nd">@until</span> <span class="k">false</span>
            <span class="n">g</span><span class="p">.</span><span class="n">winner</span> <span class="p">!=</span> <span class="k">null</span>
        <span class="p">}</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">gameRepository</span><span class="p">.</span><span class="nf">count</span><span class="p">())</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">gameStateRepository</span><span class="p">.</span><span class="nf">count</span><span class="p">())</span>

        <span class="n">game</span> <span class="p">=</span> <span class="n">gameRepository</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="n">gameId</span><span class="p">).</span><span class="nf">orElseThrow</span> <span class="p">{</span> <span class="nc">IllegalStateException</span><span class="p">(</span><span class="s">"Unable to find expected Game"</span><span class="p">)</span> <span class="p">}</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">blackName</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">blackName</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">whiteName</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">whiteName</span><span class="p">)</span>
        <span class="nf">assertFalse</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">draw</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"b"</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">winner</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">testGameEndingInDraw</span><span class="p">()</span> <span class="p">{</span>

        <span class="kd">val</span> <span class="py">blackName</span> <span class="p">=</span> <span class="s">"b_name"</span>
        <span class="kd">val</span> <span class="py">whiteName</span> <span class="p">=</span> <span class="s">"w_name"</span>

        <span class="c1">// start game</span>
        <span class="kd">val</span> <span class="py">gameId</span> <span class="p">=</span> <span class="nc">UUID</span><span class="p">.</span><span class="nf">randomUUID</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">gameIdString</span> <span class="p">=</span> <span class="n">gameId</span><span class="p">.</span><span class="nf">toString</span><span class="p">()</span>
        <span class="kd">var</span> <span class="py">gameDto</span> <span class="p">=</span> <span class="nc">GameDTO</span><span class="p">(</span><span class="n">gameIdString</span><span class="p">,</span> <span class="n">blackName</span><span class="p">,</span> <span class="n">whiteName</span><span class="p">)</span>

        <span class="n">gameReporter</span><span class="p">.</span><span class="nf">game</span><span class="p">(</span><span class="n">gameIdString</span><span class="p">,</span> <span class="n">gameDto</span><span class="p">).</span><span class="nf">subscribe</span><span class="p">()</span>

        <span class="nf">await</span><span class="p">().</span><span class="nf">atMost</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nc">SECONDS</span><span class="p">).</span><span class="nf">until</span> <span class="p">{</span> <span class="n">gameRepository</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">}</span> <i class="conum" data-value="6"></i><b>(6)</b>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">gameRepository</span><span class="p">.</span><span class="nf">count</span><span class="p">())</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gameStateRepository</span><span class="p">.</span><span class="nf">count</span><span class="p">())</span>

        <span class="kd">var</span> <span class="py">game</span> <span class="p">=</span> <span class="n">gameRepository</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="n">gameId</span><span class="p">).</span><span class="nf">orElseThrow</span> <span class="p">{</span>
            <span class="nc">IllegalStateException</span><span class="p">(</span><span class="s">"Unable to find expected Game"</span><span class="p">)</span> <span class="p">}</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">blackName</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">blackName</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">whiteName</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">whiteName</span><span class="p">)</span>
        <span class="nf">assertFalse</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">draw</span><span class="p">)</span>
        <span class="nf">assertNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">winner</span><span class="p">)</span>

        <span class="c1">// make moves</span>
        <span class="kd">val</span> <span class="py">gameStateIds</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="nc">UUID</span><span class="p">&gt;()</span>

        <span class="kd">var</span> <span class="py">gameStateId</span> <span class="p">=</span> <span class="nf">makeMove</span><span class="p">(</span><span class="n">gameIdString</span><span class="p">,</span> <span class="s">"w"</span><span class="p">,</span> <span class="s">"f3"</span><span class="p">,</span> <span class="s">"rnbqkbnr/pppppppp/8/8/8/5P2/PPPPP1PP/RNBQKBNR b KQkq - 0 1"</span><span class="p">,</span> <span class="s">"1. f3"</span><span class="p">)</span>
        <span class="n">gameStateIds</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">gameStateId</span><span class="p">)</span>

        <span class="n">gameStateId</span> <span class="p">=</span> <span class="nf">makeMove</span><span class="p">(</span><span class="n">gameIdString</span><span class="p">,</span> <span class="s">"b"</span><span class="p">,</span> <span class="s">"e6"</span><span class="p">,</span> <span class="s">"rnbqkbnr/pppp1ppp/4p3/8/8/5P2/PPPPP1PP/RNBQKBNR w KQkq - 0 2"</span><span class="p">,</span> <span class="s">"1. f3 e6"</span><span class="p">)</span>
        <span class="n">gameStateIds</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">gameStateId</span><span class="p">)</span>

        <span class="nf">await</span><span class="p">().</span><span class="nf">atMost</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nc">SECONDS</span><span class="p">).</span><span class="nf">until</span> <span class="p">{</span> <span class="n">gameStateRepository</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span> <span class="p">&gt;</span> <span class="mi">1</span> <span class="p">}</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">gameRepository</span><span class="p">.</span><span class="nf">count</span><span class="p">())</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">gameStateRepository</span><span class="p">.</span><span class="nf">count</span><span class="p">())</span>

        <span class="kd">val</span> <span class="py">moves</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="nc">GameState</span><span class="p">&gt;()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="k">in</span> <span class="n">gameStateIds</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">moves</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">gameStateRepository</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="n">id</span><span class="p">).</span><span class="nf">orElseThrow</span> <span class="p">{</span> <span class="nc">IllegalStateException</span><span class="p">(</span><span class="s">"Unable to find expected GameState"</span><span class="p">)</span> <span class="p">}</span><span class="o">!!</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"w"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">player</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"f3"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">move</span><span class="p">)</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"b"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">player</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"e6"</span><span class="p">,</span> <span class="n">moves</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">move</span><span class="p">)</span>

        <span class="c1">// end game</span>
        <span class="n">gameDto</span> <span class="p">=</span> <span class="nc">GameDTO</span><span class="p">(</span><span class="n">gameIdString</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
        <span class="n">gameReporter</span><span class="p">.</span><span class="nf">game</span><span class="p">(</span><span class="n">gameIdString</span><span class="p">,</span> <span class="n">gameDto</span><span class="p">).</span><span class="nf">subscribe</span><span class="p">()</span>

        <span class="nf">await</span><span class="p">().</span><span class="nf">atMost</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nc">SECONDS</span><span class="p">).</span><span class="nf">until</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">g</span> <span class="p">=</span> <span class="n">gameRepository</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="n">gameId</span><span class="p">).</span><span class="nf">orElse</span><span class="p">(</span><span class="k">null</span><span class="p">)</span> <span class="o">?:</span> <span class="k">return</span><span class="nd">@until</span> <span class="k">false</span>
            <span class="n">g</span><span class="p">.</span><span class="n">draw</span>
        <span class="p">}</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">gameRepository</span><span class="p">.</span><span class="nf">count</span><span class="p">())</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">gameStateRepository</span><span class="p">.</span><span class="nf">count</span><span class="p">())</span>

        <span class="n">game</span> <span class="p">=</span> <span class="n">gameRepository</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="n">gameId</span><span class="p">).</span><span class="nf">orElseThrow</span> <span class="p">{</span> <span class="nc">IllegalStateException</span><span class="p">(</span><span class="s">"Unable to find expected Game"</span><span class="p">)</span> <span class="p">}</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">blackName</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">blackName</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">whiteName</span><span class="p">,</span> <span class="n">game</span><span class="p">.</span><span class="n">whiteName</span><span class="p">)</span>
        <span class="nf">assertTrue</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">draw</span><span class="p">)</span>
        <span class="nf">assertNull</span><span class="p">(</span><span class="n">game</span><span class="p">.</span><span class="n">winner</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@NonNull</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getProperties</span><span class="p">():</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;</span> <span class="p">=</span>
            <span class="nf">mapOf</span><span class="p">(</span><span class="s">"kafka.bootstrap.servers"</span> <span class="n">to</span> <span class="n">kafka</span><span class="p">.</span><span class="n">bootstrapServers</span><span class="p">)</span> <i class="conum" data-value="7"></i><b>(7)</b>

    <span class="nd">@AfterEach</span>
    <span class="k">fun</span> <span class="nf">cleanup</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">gameStateRepository</span><span class="p">.</span><span class="nf">deleteAll</span><span class="p">()</span>
        <span class="n">gameRepository</span><span class="p">.</span><span class="nf">deleteAll</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nd">@KafkaClient</span>
    <span class="kd">interface</span> <span class="nc">GameReporter</span> <span class="p">{</span>
        <span class="nd">@Topic</span><span class="p">(</span><span class="s">"chessGame"</span><span class="p">)</span>
        <span class="k">fun</span> <span class="nf">game</span><span class="p">(</span><span class="nd">@KafkaKey</span> <span class="n">gameId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">game</span><span class="p">:</span> <span class="nc">GameDTO</span><span class="p">):</span> <span class="nc">Mono</span><span class="p">&lt;</span><span class="nc">GameDTO</span><span class="p">&gt;</span>

        <span class="nd">@Topic</span><span class="p">(</span><span class="s">"chessGameState"</span><span class="p">)</span>
        <span class="k">fun</span> <span class="nf">gameState</span><span class="p">(</span><span class="nd">@KafkaKey</span> <span class="n">gameId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">gameState</span><span class="p">:</span> <span class="nc">GameStateDTO</span><span class="p">):</span> <span class="nc">Mono</span><span class="p">&lt;</span><span class="nc">GameStateDTO</span><span class="p">&gt;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">makeMove</span><span class="p">(</span><span class="n">gameId</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">player</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">move</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span>
                         <span class="n">fen</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="n">pgn</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">UUID</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">gameStateId</span> <span class="p">=</span> <span class="nc">UUID</span><span class="p">.</span><span class="nf">randomUUID</span><span class="p">()</span>
        <span class="n">gameReporter</span><span class="p">.</span><span class="nf">gameState</span><span class="p">(</span><span class="n">gameId</span><span class="p">,</span> <span class="nc">GameStateDTO</span><span class="p">(</span><span class="n">gameStateId</span><span class="p">.</span><span class="nf">toString</span><span class="p">(),</span>
                <span class="n">gameId</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">move</span><span class="p">,</span> <span class="n">fen</span><span class="p">,</span> <span class="n">pgn</span><span class="p">)).</span><span class="nf">subscribe</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">gameStateId</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <code>@Testcontainers</code> annotation to configure automatic container management (not necessary in Spock tests)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Classes that implement <code>TestPropertyProvider</code> must use this annotation to create a single class instance for all tests (not necessary in Spock tests).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Implementing <code>TestPropertyProvider</code> allows the test class to provide application configuration properties, in this case the dynamically allocated Kafka broker port</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The Testcontainers instance for Kafka</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Dependency injection for the <code>GameReporter</code> interface declared below, a Kafka producer interface that replicates the functionality of the class of the same name in the <code>chess-game</code> microservice</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Wait a few seconds for the message to arrive; it should happen very quickly, but the message will be sent on a separate thread</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Configure the Kafka broker port (it will be different unused port each time) so Micronaut Kafka clients and listeners connect to the test broker</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create <code>application-test.properties</code> file in <code>src/test/resources</code> with this content:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/test/resources/application-test.properties</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">datasources.default.url</span><span class="p">=</span><span class="s">jdbc:tc:oracle:thin:@/xe</span>
<span class="py">datasources.default.driverClassName</span><span class="p">=</span><span class="s">org.testcontainers.jdbc.ContainerDatabaseDriver</span>
<span class="py">datasources.default.username</span><span class="p">=</span><span class="s">system</span>
<span class="py">datasources.default.password</span><span class="p">=</span><span class="s">oracle</span>

<span class="py">flyway.datasources.default.locations</span><span class="p">=</span><span class="s">classpath:db/migration/oracle</span>
<span class="py">flyway.datasources.default.baseline-version</span><span class="p">=</span><span class="s">0</span>
<span class="py">flyway.datasources.default.baseline-on-migrate</span><span class="p">=</span><span class="s">true</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="running-the-tests">9.3. Running the tests</h3>
<div class="paragraph">
<p>To run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">./mvnw <span class="nb">test</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-to-oci">10. Deploy to OCI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you&#8217;ve verified that the microservices work with the configured cloud resources, you can deploy the microservices to Compute instances and run everything in Oracle Cloud.</p>
</div>
<div class="paragraph">
<p>Follow the steps in <a href="micronaut-oracle-cloud.html">this guide</a> for each service.</p>
</div>
<div class="sect2">
<h3 id="instance-principal-authentication">10.1. Instance Principal authentication</h3>
<div class="paragraph">
<p>The current configuration in <code>application-oraclecloud.properties</code> works when running locally using OCI resources (ATP database and Cloud Streams) but won&#8217;t work when deploying the application because it doesn&#8217;t make sense to install the Oracle Cloud CLI in Compute instances. Instead, we&#8217;ll use <a href="https://micronaut-projects.github.io/micronaut-oracle-cloud/latest/guide/#instance-principals">Instance Principal authentication</a>.</p>
</div>
<div class="paragraph">
<p>To use this, we need to update the config, create a dynamic group, and add policy statements granting permissions.</p>
</div>
<div class="sect3">
<h4 id="dynamic-group">10.1.1. Dynamic Group</h4>
<div class="paragraph">
<p>Create a Dynamic Group by clicking the Oracle Cloud menu and selecting "Identity &amp; Security" and then click "Dynamic Groups":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/dynamicgroup1.png" alt="dynamicgroup1">
</div>
</div>
<div class="paragraph">
<p>Click "Create Dynamic Group":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/dynamicgroup2.png" alt="dynamicgroup2">
</div>
</div>
<div class="paragraph">
<p>Then enter a name and description for the group, e.g., "mn-streaming-guide-dg", and a matching rule, i.e., the logic that will be used to determine group membership. We&#8217;ll make the rule fairly broad - enter <code>ALL {instance.compartment.id = 'ocid1.compartment.oc1..aaaaaxxxxx'}</code> replacing <code>ocid1.compartment.oc1..aaaaaxxxxx</code> with the compartment OCID where you&#8217;re creating your Compute instances and click "Create":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/dynamicgroup3.png" alt="dynamicgroup3">
</div>
</div>
<div class="paragraph">
<p>See the <a href="https://docs.oracle.com/en-us/iaas/Content/Identity/Tasks/managingdynamicgroups.htm">Dynamic Group docs</a> for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="dynamic-group-policy-statements">10.1.2. Dynamic Group Policy Statements</h4>
<div class="paragraph">
<p>Edit the policy you created earlier and add three new policies: one to grant access to Autonomous Database, one to allow sending stream messages, and one to allow receiving stream messages:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/policy4.png" alt="policy4">
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-2">10.1.3. Configuration</h4>
<div class="paragraph">
<p>Edit <code>application-oraclecloud.properties</code> in the <code>chess-listener</code> microservice and replace</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">oci</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span>
    <span class="na">profile</span><span class="pi">:</span> <span class="s">DEFAULT</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">oci</span><span class="pi">:</span>
  <span class="na">config</span><span class="pi">:</span>
    <span class="na">instance-principal</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="generate-micronaut-application-native-executables-with-graalvm">11. Generate Micronaut Application Native Executables with GraalVM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will use <a href="https://www.graalvm.org/">GraalVM</a>, an advanced JDK with ahead-of-time Native Image compilation, to generate a native executable of this Micronaut application.</p>
</div>
<div class="paragraph">
<p>Compiling Micronaut applications ahead of time with GraalVM significantly improves startup time and reduces the memory footprint of JVM-based applications.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Only Java and Kotlin projects support using GraalVM&#8217;s <code>native-image</code> tool. Groovy relies heavily on reflection, which is only partially supported by GraalVM.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="native-executable-generation">11.1. Native Executable Generation</h3>
<div class="paragraph">
<p>The easiest way to install <a href="https://www.graalvm.org">GraalVM</a> on Linux or Mac is to use <a href="https://sdkman.io/">SDKMan.io</a>.</p>
</div>
<div class="listingblock">
<div class="title">Java 21</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">sdk <span class="nb">install </span>java 21.0.5-graal</code></pre>
</div>
</div>
<div class="paragraph">
<p>For installation on Windows, or for a manual installation on Linux or Mac, see the <a href="https://www.graalvm.org/latest/docs/getting-started/">GraalVM Getting Started</a> documentation.</p>
</div>
<div class="paragraph">
<p>The previous command installs Oracle GraalVM, which is free to use in production and free to redistribute, at no cost, under the <a href="https://www.oracle.com/downloads/licenses/graal-free-license.html">GraalVM Free Terms and Conditions</a>.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can use the <a href="https://github.com/graalvm/graalvm-ce-builds/releases/">GraalVM Community Edition</a>:</p>
</div>
<div class="listingblock">
<div class="title">Java 21</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">sdk <span class="nb">install </span>java 21.0.2-graalce</code></pre>
</div>
</div>
<div class="paragraph">
<p>To generate native executables for each application using Maven, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">./mvnw package <span class="nt">-Dpackaging</span><span class="o">=</span>native-image</code></pre>
</div>
</div>
<div class="paragraph">
<p>The native executable is created in the <code>target</code> directory and can be run with <code>target/micronautguide</code>.</p>
</div>
<div class="paragraph">
<p>It is possible to customize the name of the native executable or pass additional build arguments using the <a href="https://graalvm.github.io/native-build-tools/latest/maven-plugin.html">Maven plugin for GraalVM Native Image building</a>. Declare the plugin as following:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;plugin&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.graalvm.buildtools<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>native-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>0.10.3<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;configuration&gt;</span>
        <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="nt">&lt;imageName&gt;</span>mn-graalvm-application<span class="nt">&lt;/imageName&gt;</span>
        <span class="nt">&lt;buildArgs&gt;</span>
          <i class="conum" data-value="2"></i><b>(2)</b>
          <span class="nt">&lt;buildArg&gt;</span>-Ob<span class="nt">&lt;/buildArg&gt;</span>
        <span class="nt">&lt;/buildArgs&gt;</span>
    <span class="nt">&lt;/configuration&gt;</span>
<span class="nt">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The native executable name will now be <code>mn-graalvm-application</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It is possible to pass extra build arguments to <code>native-image</code>. For example, <code>-Ob</code> enables the quick build mode.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Native executable building will fail if the H2 driver is in the classpath, so comment out that dependency in your build script before building. No other changes are needed since there are no compile dependencies on the library, so you can keep the H2 versions of the repository interfaces for use in dev mode.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="deployable-native-executables">11.2. Deployable Native Executables</h3>
<div class="paragraph">
<p>The native executables you built probably won&#8217;t be deployable to OCI even if you build on the same Linux distro your Compute instances use. To create deployable native executables, change the build process a bit.</p>
</div>
<div class="paragraph">
<p>To generate deployable native executables for each application using Maven, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">./mvnw package <span class="nt">-Dpackaging</span><span class="o">=</span>docker-native</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you just need to extract the native executable applications from the Docker images you built.</p>
</div>
<div class="paragraph">
<p>You&#8217;ll need the Docker image IDs, so run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker image <span class="nb">ls</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">REPOSITORY                   TAG             IMAGE ID       CREATED          SIZE
chess-listener               latest          0e262e1754a7   32 seconds ago   246MB
chess-game                   latest          43f567f2fed6   39 minutes ago   86.1MB
confluentinc/cp-kafka        latest          ca0dbcd0244c   2 weeks ago      771MB
confluentinc/cp-zookeeper    latest          04999d93068f   2 weeks ago      771MB
ghcr.io/graalvm/graalvm-ce   java11-21.1.0   9762c6e631f0   2 months ago     1.29GB
ghcr.io/graalvm/graalvm-ce   java8-21.1.0    aef3649e379d   2 months ago     1.12GB
frolvlad/alpine-glibc        alpine-3.12     39c4d33bd807   2 months ago     17.9MB
portainer/portainer          latest          cd645f5a4769   13 months ago    79.1MB</code></pre>
</div>
</div>
<div class="paragraph">
<p>The IDs should be at the top since they&#8217;re the most recent.</p>
</div>
<div class="paragraph">
<p>Then run this for each image, replacing <code>image_id</code> with the Docker image ID, e.g., <code>0e262e1754a7</code> and <code>43f567f2fed6</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">docker create <span class="nt">--name</span> container_temp &lt;image_id&gt;
docker <span class="nb">cp </span>container_temp:/app/application <span class="nb">.</span>
docker <span class="nb">rm </span>container_temp</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can scp each native executable to a Compute instance with no Java installed and see the startup time and resource usage reduction you expect when running applications as native executables.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="next-steps">12. Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Read more about <a href="https://micronaut-projects.github.io/micronaut-kafka/latest/guide/">Kafka support</a> in the Micronaut framework.</p>
</div>
<div class="paragraph">
<p>Also see <a href="micronaut-kafka.html">this guide on the Micronaut framework + Kafka</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="license">13. License</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All guides are released with an <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache license 2.0 license</a> for the code and a <a href="https://creativecommons.org/licenses/by/4.0/deed.en">Creative Commons Attribution 4.0</a> license for the writing and media (images&#8230;&#8203;).
</td>
</tr>
</table>
</div>

            </div>
        </div>
    </div>
</main>

<footer id="footer">
    <div class="container">

        <div class="row">
            <div class="col-sm-5 footer-left">

                <div id="text-14" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <a href="https://micronaut.io/foundation/"><img class="alignnone size-medium wp-image-3736" src="./images/micronaut_foundation_horizontal_white.svg" alt="Micronaut Foundation"/></a>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-sm-7 footer-right">

                <ul class="meta">

                    <li id="menu-item-2895" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2895">
                        <a href="https://micronaut.io/brand-guidelines/">Brand Guidelines</a>
                    </li>
                    <li id="menu-item-2894" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2894">
                        <a href="https://micronaut.io/community-guidelines/">Community Guidelines</a>
                    </li>
                    <li id="menu-item-3377" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-privacy-policy menu-item-3377">
                        <a href="https://micronaut.io/privacy-policy/">Privacy Policy</a>
                    </li>

                </ul>

                <div id="nav_menu-2" class="widget widget_nav_menu">
                    <div class="menu-links-container">
                        <ul id="menu-links" class="menu">
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronautpodcast.com"><i class="fa fa-podcast"><span class="sr-only">Podcast</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronaut.io/feed/rss/"><i class="fa fa-feed"><span class="sr-only">Feed</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="mailto:info@micronaut.io"><i class="fas fa-envelope"><span class="sr-only">Mail</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://twitter.com/micronautfw"><i class="fab fa-twitter"><span class="sr-only">Twitter</span></i></a></li>
                            <li id="menu-item-6740" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-6740"><a href="https://fosstodon.org/@micronaut"><i class="fab fa-mastodon"><span class="sr-only">Mastodon</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://discord.gg/9xRFsHv98T"><i class="fab fa-discord"><span class="sr-only">Discord</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://github.com/micronaut-projects/"><i class="fab fa-github"><span class="sr-only">GitHub</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.youtube.com/@MicronautFramework"><i class="fab fa-youtube"><span class="sr-only">YouTube</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.linkedin.com/showcase/micronaut"><i class="fab fa-linkedin"><span class="sr-only">LinkedIn</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.twitch.tv/micronautfw"><i class="fab fa-twitch"><span class="sr-only">Twitch</span></i></a></li>
                        </ul>
                    </div>
                </div>
                <div id="text-5" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <small>Guides are licensed under <a href="https://creativecommons.org/licenses/by/4.0/deed.en">CC BY 4.0</a> for the writing/media and <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache.2.0</a> for the code</small>
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</footer>
</body>
</html>
