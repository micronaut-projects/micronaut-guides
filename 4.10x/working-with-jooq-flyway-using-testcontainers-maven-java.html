<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'/>
    <title>Working with jOOQ and Flyway using Testcontainers</title>
    <link rel='stylesheet' id='wp-block-library-css' href='https://micronaut.io/wp-includes/css/dist/block-library/style.min.css' type='text/css' media='all'/>
    <link rel='stylesheet' id='fonts-fira-sans-css' href='https://fonts.googleapis.com/css2?family=Fira+Sans%3Awght%40300%3B500&#038;display=swap&#038;ver=5.7' type='text/css' media='all'/>
    <link rel='stylesheet' id='micronaut-style-css' href='https://micronaut.io/wp-content/themes/micronaut/style.min.css' type='text/css' media='all'/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link rel="shortcut icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link rel="alternate" type="application/rss+xml" title="Micronaut Guides RSS Feed" href="https://guides.micronaut.io/latest/rss.xml" />
    <link rel="alternate" type="application/json" title="Micronaut Guides JSON Feed" href="https://guides.micronaut.io/latest/feed.json" />
    <link href="coderay.css" rel="stylesheet" />
    <link href="rouge-github.css" rel="stylesheet" />
    <link href="guide.css" rel="stylesheet" />
    <script src="lunr.js"></script>
    <script src="guide.js"></script>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://guides.micronaut.io/latest/images/cards/micronauttwittercard.png"/>
    <meta name="twitter:creator" content="@micronautfw"/>
    <meta name="twitter:site" content="@micronautfw"/>
    <meta name="twitter:title" content="Working with jOOQ and Flyway using Testcontainers"/>
    <meta name="twitter:description" content="This guide shows how to create a Micronaut application with jOOQ support"/>
</head>
<body class="page-template page-template-page-sidebar page-template-page-sidebar-php page page-parent guide">

<header id="header">

    <div class="container">

        <nav class="navbar navbar-expand-lg navbar-dark">

            <button class="collapsed" type="button" data-toggle="collapse" data-target="#nav" aria-expanded="false">
                <span></span>
            </button>

            <a class="navbar-brand" href="https://micronaut.io">
                <img src="https://micronaut.io/wp-content/uploads/2020/11/MIcronautLogo_Horizontal.svg" alt="Micronaut framework"/>
            </a>

            <div class="collapse navbar-collapse" id="nav">

                <ul class="navbar-nav ml-auto">

                    <li id="menu-item-2865" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2865 nav-item"><a href="https://micronaut.io/download/" class="nav-link">Download</a></li>
                    <li id="menu-item-2868" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-2868 dropdown nav-item"><a href="https://micronaut.io/learn/" class="nav-link dropdown-toggle" data-toggle="dropdown">Learn</a><ul class="dropdown-menu">
                        <li id="menu-item-4943" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4943"><a href="https://micronaut.io/learn/" class="dropdown-item">Overview</a></li>
                        <li id="menu-item-5111" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-5111"><a href="https://docs.micronaut.io/index.html" class="dropdown-item">User Documentaton</a></li>
                        <li id="menu-item-4510" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4510"><a href="https://micronaut.io/guides/" class="dropdown-item">Guides</a></li>
                        <li id="menu-item-2896" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2896"><a href="https://micronaut.io/category/microcast/" class="dropdown-item">Microcasts</a></li>
                        <li id="menu-item-2897" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2897"><a href="https://micronaut.io/category/webinar/" class="dropdown-item">Webinars</a></li>
                        <li id="menu-item-2871" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2871"><a href="https://micronaut.io/professional-training/" class="dropdown-item">Professional Training</a></li>
                        <li id="menu-item-6526" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-6526"><a href="https://micronaut-projects.github.io/micronaut-guides-mn3/latest/" class="dropdown-item">Guides for Micronaut Framework 3</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2878" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2878 dropdown nav-item"><a href="https://micronaut.io/resources/" class="nav-link dropdown-toggle" data-toggle="dropdown">Resources</a><ul class="dropdown-menu">
                        <li id="menu-item-4999" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4999"><a href="https://micronaut.io/upcoming-events/" class="dropdown-item">Upcoming Events</a></li>
                        <li id="menu-item-2879" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2879"><a href="https://micronaut.io/blog/" class="dropdown-item">Blog</a></li>
                        <li id="menu-item-6478" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6478"><a href="https://micronaut.io/category/release-announcements/" class="dropdown-item">Releases</a></li>
                        <li id="menu-item-6715" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6715"><a href="https://micronaut.io/category/security-announcements/" class="dropdown-item">Security Announcements</a></li>
                        <li id="menu-item-4499" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-4499"><a href="https://micronautpodcast.com/" class="dropdown-item">Podcast</a></li>
                        <li id="menu-item-5798" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5798"><a href="https://micronaut.io/support/" class="dropdown-item">Commercial Support</a></li>
                        <li id="menu-item-4186" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4186"><a href="https://micronaut.io/resources/community-support/" class="dropdown-item">Community Support</a></li>
                        <li id="menu-item-2882" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2882"><a href="https://micronaut.io/faq/" class="dropdown-item">FAQ</a></li>
                        <li id="menu-item-2883" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2883"><a href="https://micronaut.io/contact/" class="dropdown-item">Contact</a></li>
                        <li id="menu-item-6479" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6479"><a href="https://micronaut.io/micronaut-success-stories/" class="dropdown-item">Micronaut Success Stories</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2872" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2872 dropdown nav-item"><a href="https://micronaut.io/foundation/" class="nav-link dropdown-toggle" data-toggle="dropdown">Foundation</a><ul class="dropdown-menu">
                        <li id="menu-item-2877" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2877"><a href="https://micronaut.io/foundation/" class="dropdown-item">Overview</a></li>
                        <li id="menu-item-2874" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2874"><a href="https://micronaut.io/foundation/corporate-sponsorship/" class="dropdown-item">Corporate Sponsorship</a></li>
                        <li id="menu-item-2873" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2873"><a href="https://micronaut.io/foundation/community-sponsorship/" class="dropdown-item">Community Sponsorship</a></li>
                        <li id="menu-item-2876" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2876"><a href="https://micronaut.io/foundation/sponsors/" class="dropdown-item">Sponsors</a></li>
                        <li id="menu-item-3838" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-3838"><a href="https://micronaut.io/meeting-minutes/" class="dropdown-item">Meeting Minutes</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2884" class="action menu-item menu-item-type-custom menu-item-object-custom menu-item-2884 nav-item"><a target="_blank" rel="noopener" href="https://micronaut.io/launch/" class="nav-link">Launch</a></li>

                </ul>

            </div>

        </nav>

    </div>
</header>

<div style="background: #fff;padding-top: 20px;padding-bottom: 20px;">
    <div class="container" style="clear: both;">
        <fieldset style="float: right;">
            <input type="search" id="search-form-query"/>
            <input type="submit" onclick="search()" value="Search">
            <input type="submit" onclick="resetSearch()" value="Reset">
        </fieldset>
    </div>
    <div class="container" style="clear: both;margin-top: -20px;">
        <div class="guide-list" id="searchResults">
        </div>
    </div>
</div>
<div id="breadcrumbs"><div class="container"><a href="https://micronaut.io/">Home</a> » <a href="./index.html">Guides</a> » <a href="working-with-jooq-flyway-using-testcontainers.html">Working with jOOQ and Flyway using Testcontainers</a> » <span class="breadcrumb_last" aria-current="page">maven | java</span></div></div><!-- .breadcrumbs -->
<main id="main">
    <div class="container">
        <div class="row">
            <div class="col-md-4">

                <div class="toc">
                    <div class="inner">
                        <h1 class="title title_large first-word-bold first-word-break">Table of Contents</h1>
                        <div class="underline"></div>
                        
<ul class="sectlevel1">
<li><a href="#about-this-guide">1. About this Guide</a></li>
<li><a href="#what-you-will-need">2. What you will need</a></li>
<li><a href="#solution">3. Solution</a></li>
<li><a href="#what-we-are-going-to-achieve-in-this-guide">4. What we are going to achieve in this guide</a></li>
<li><a href="#writing-the-application">5. Writing the Application</a></li>
<li><a href="#getting-started">6. Getting Started</a></li>
<li><a href="#configuration">7. Configuration</a>
<ul class="sectlevel2">
<li><a href="#data-source-configuration">7.1. Data Source Configuration</a></li>
<li><a href="#flyway-configuration">7.2. Flyway Configuration</a></li>
</ul>
</li>
<li><a href="#create-flyway-database-migration-scripts">8. Create Flyway database migration scripts</a></li>
<li><a href="#configure-jooq-code-generation-using-maven-plugin">9. Configure jOOQ code generation using Maven plugin</a></li>
<li><a href="#create-model-classes">10. Create model classes</a></li>
<li><a href="#implementing-basic-database-operations-using-jooq">11. Implementing basic database operations using jOOQ</a></li>
<li><a href="#tests">12. Tests</a></li>
<li><a href="#testcontainers-dependencies">13. Testcontainers Dependencies</a>
<ul class="sectlevel2">
<li><a href="#test-seed-data">13.1. Test Seed Data</a></li>
<li><a href="#abstracttest-class">13.2. AbstractTest class</a></li>
<li><a href="#write-repository-test">13.3. Write repository test</a></li>
</ul>
</li>
<li><a href="#fetching-complex-object-trees-using-jooq">14. Fetching complex object trees using jOOQ</a></li>
<li><a href="#testing-the-application">15. Testing the Application</a></li>
<li><a href="#testing-with-test-resources">16. Testing with Test Resources</a>
<ul class="sectlevel2">
<li><a href="#removing-testcontainers-dependencies">16.1. Removing Testcontainers Dependencies</a></li>
<li><a href="#configure-test-resources">16.2. Configure Test Resources</a></li>
<li><a href="#test-resources-postgresql">16.3. Test Resources PostgreSQL</a></li>
<li><a href="#simpler-test-with-test-resources">16.4. Simpler Test with Test Resources</a></li>
<li><a href="#micronaut-test-resources-goals">16.5. Micronaut Test Resources Goals</a></li>
</ul>
</li>
<li><a href="#summary">17. Summary</a></li>
<li><a href="#next-steps">18. Next Steps</a></li>
<li><a href="#help-with-the-micronaut-framework">19. Help with the Micronaut Framework</a></li>
<li><a href="#license">20. License</a></li>
</ul>

                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <h1>Working with jOOQ and Flyway using Testcontainers</h1>
                <div class="underline"></div>
<div class="sect1">
<div class="sectionbody">

<div class="paragraph">
<p>This guide shows how to create a Micronaut application with jOOQ support</p>
</div>
<div class="paragraph">
<p>Authors: Sergio del Amo</p>
</div>
<div class="paragraph">
<p>Micronaut Version: 4.9.1</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="about-this-guide">1. About this Guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this guide, you will learn how to</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a Micronaut application with <a href="https://www.jooq.org/">jOOQ</a> support</p>
</li>
<li>
<p>Generate jOOQ code using <a href="https://testcontainers.com">Testcontainers</a>, <a href="https://flywaydb.org/">Flyway</a> and Maven Plugin</p>
</li>
<li>
<p>Implement basic database operations using jOOQ</p>
</li>
<li>
<p>Implement logic to load complex object graph using jOOQ</p>
</li>
<li>
<p>Test the jOOQ persistence layer using Testcontainers</p>
</li>
<li>
<p>Simplify testing with <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/#modules-kafka">Micronaut Test Resources</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-you-will-need">2. What you will need</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE (e.g. <a href="https://guides.micronaut.io/latest/micronaut-intellij-idea-ide-setup.html">IntelliJ IDEA</a>)</p>
</li>
<li>
<p>JDK 21 or greater installed with <code>JAVA_HOME</code> <a href="https://www.baeldung.com/java-home-on-windows-7-8-10-mac-os-x-linux">configured appropriately</a></p>
</li>
</ul>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.testcontainers.org/supported_docker_environment/">A Docker environment supported by Testcontainers</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div></div><div class="row"><div class="col-md-12"><div class="sect1">
<h2 id="solution">3. Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create the application step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="working-with-jooq-flyway-using-testcontainers-maven-java.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-we-are-going-to-achieve-in-this-guide">4. What we are going to achieve in this guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are going to create a Micronaut project using <a href="https://www.jooq.org/">jOOQ</a> together with <a href="https://www.postgresql.org/">PostgreSQL</a>.
We will create our database tables by using <a href="https://flywaydb.org/">Flyway</a> Database migrations.
We will configure <a href="https://github.com/testcontainers/testcontainers-jooq-codegen-maven-plugin">testcontainers-jooq-codegen-maven-plugin</a> to generate jOOQ code using Testcontainers and Flyway
migration scripts.</p>
</div>
<div class="paragraph">
<p>We will implement our persistence layer repositories using jOOQ to manage Users, Posts, and Comments.
Then we will test the repositories using Micronaut testing support and Testcontainers PostgreSQL module.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-the-application">5. Writing the Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create an application using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">mn create-app example.micronaut.micronautguide <span class="se">\</span>
    <span class="nt">--features</span><span class="o">=</span>flyway,jooq,postgres,testcontainers,assertj <span class="se">\</span>
    <span class="nt">--build</span><span class="o">=</span>maven <span class="se">\</span>
    <span class="nt">--lang</span><span class="o">=</span>java</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle with the <a href="https://docs.gradle.org/current/userguide/kotlin_dsl.html">Kotlin DSL</a> is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.<br/> If you don&#8217;t specify the <code>--test</code> argument, JUnit is used for Java and Kotlin, and Spock is used for Groovy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous command creates a Micronaut application with the default package <code>example.micronaut</code> in a directory named <code>micronautguide</code>.</p>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add <code>flyway</code>, <code>jooq</code>, <code>postgres</code>, <code>testcontainers</code>, and <code>assertj</code> features.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have an existing Micronaut application and want to add the functionality described here, you can view the dependency and configuration changes from the specified features, and apply those changes to your application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://micronaut.io/launch?features=flyway&amp;features=jooq&amp;features=postgres&amp;features=testcontainers&amp;features=assertj&amp;lang=JAVA&amp;build=MAVEN&amp;test=JUNIT&amp;name=testcontainers&amp;type=DEFAULT&amp;package=example.micronaut&amp;activity=diff" target="_blank" rel="noopener">Diff</a></p>
</div>
<div class="paragraph">
<p><a href="https://guides.micronaut.io/latest/micronaut-intellij-idea-ide-setup.html">Setup IntelliJ IDEA to develop Micronaut Applications</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started">6. Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://www.jooq.org"><strong>jOOQ (jOOQ Object Oriented Querying)</strong></a> is a popular open-source library that provides a fluent API for building typesafe SQL queries.</p>
</div>
<div class="paragraph">
<p>In order to leverage the benefits of TypeSafe DSL provided by jOOQ, we need to generate Java code from our database tables, views, and other objects, which will allow us to interact with the database using a fluent and intuitive API.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To learn more about how jOOQ code-generator will help you, please read
<a href="https://blog.jooq.org/why-you-should-use-jooq-with-code-generation/">Why You Should Use jOOQ With Code Generation</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In production-grade applications, it is highly recommended to use a database migration tool such as
<strong>Flyway</strong> or <strong>Liquibase</strong> to apply any changes to the database.</p>
</div>
<div class="paragraph">
<p>So, the usual process of building and testing the application by generating jOOQ java code from the database is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create an instance of database using Testcontainers</p>
</li>
<li>
<p>Apply Flyway or Liquibase database migrations</p>
</li>
<li>
<p>Run jOOQ code-generator to generate Java code from the database objects.</p>
</li>
<li>
<p>Run integration tests</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The jOOQ code generation can be automated as part of the Maven build process using the
<a href="https://github.com/testcontainers/testcontainers-jooq-codegen-maven-plugin">testcontainers-jooq-codegen-maven-plugin</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can also use the official jOOQ code generator maven plugin by using <strong>jooq-codegen-maven</strong>, <strong>groovy-maven-plugin</strong> and <strong>flyway-maven-plugin</strong>
together as described in <a href="https://blog.jooq.org/using-testcontainers-to-generate-jooq-code/" class="bare">https://blog.jooq.org/using-testcontainers-to-generate-jooq-code/</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With jOOQ, <a href="https://www.jooq.org/doc/latest/manual/coming-from-jpa/from-jpa-database-first/">the database comes first</a>.
So, let&#8217;s start with creating our database structure using Flyway migration scripts.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration">7. Configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="data-source-configuration">7.1. Data Source Configuration</h3>
<div class="listingblock">
<div class="title">testcontainers/src/main/resources/application.properties</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">datasources.default.db-type</span><span class="p">=</span><span class="s">postgres</span>
<span class="py">datasources.default.driver-class-name</span><span class="p">=</span><span class="s">org.postgresql.Driver</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that the configuration does not specify the JDBC URL, username, or password. We will supply them dynamically in our tests or via Test Resources.</p>
</div>
</div>
<div class="sect2">
<h3 id="flyway-configuration">7.2. Flyway Configuration</h3>
<div class="paragraph">
<p>We need a way to create the database schema. For that, we use <a href="https://micronaut-projects.github.io/micronaut-flyway/latest/guide/">Micronaut integration with Flyway</a>.</p>
</div>
<div class="paragraph">
<p><a href="https://www.flywaydb.org">Flyway</a> automates schema changes, significantly simplifying schema management tasks, such as migrating, rolling back, and reproducing in multiple environments.</p>
</div>
<div class="listingblock">
<div class="title">testcontainers/src/main/resources/application.properties</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">flyway.datasources.default.enabled</span><span class="p">=</span><span class="s">true</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enable Flyway for the <code>default</code> datasource.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Configuring multiple data sources is as simple as enabling Flyway for each one. You can also specify directories that will be used for migrating each data source. Review the <a href="https://micronaut-projects.github.io/micronaut-flyway/latest/guide/">Micronaut Flyway documentation</a> for additional details.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Flyway migration will be automatically triggered before your Micronaut application starts. Flyway will read migration commands in the <code>resources/db/migration/</code> directory, execute them if necessary, and verify that the configured data source is consistent with them.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-flyway-database-migration-scripts">8. Create Flyway database migration scripts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In our sample application, we have users, posts and comments tables.
Let&#8217;s create our first migration script following the Flyway naming convention.</p>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/db/migration/V1__create_tables.sql</code> file as follows:</p>
</div>
<div class="listingblock">
<div class="title">testcontainers/src/main/resources/db/migration/V1__create_tables.sql</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">create</span> <span class="k">table</span> <span class="n">users</span>
<span class="p">(</span>
    <span class="n">id</span>         <span class="n">bigserial</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">name</span>       <span class="nb">varchar</span>   <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">email</span>      <span class="nb">varchar</span>   <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">created_at</span> <span class="nb">timestamp</span><span class="p">,</span>
    <span class="n">updated_at</span> <span class="nb">timestamp</span><span class="p">,</span>
    <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">id</span><span class="p">),</span>
    <span class="k">constraint</span> <span class="n">user_email_unique</span> <span class="k">unique</span> <span class="p">(</span><span class="n">email</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">posts</span>
<span class="p">(</span>
    <span class="n">id</span>         <span class="n">bigserial</span>                    <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">title</span>      <span class="nb">varchar</span>                      <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">content</span>    <span class="nb">varchar</span>                      <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">created_by</span> <span class="nb">bigint</span> <span class="k">references</span> <span class="n">users</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">created_at</span> <span class="nb">timestamp</span><span class="p">,</span>
    <span class="n">updated_at</span> <span class="nb">timestamp</span><span class="p">,</span>
    <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">comments</span>
<span class="p">(</span>
    <span class="n">id</span>         <span class="n">bigserial</span>                    <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">name</span>       <span class="nb">varchar</span>                      <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">content</span>    <span class="nb">varchar</span>                      <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">post_id</span>    <span class="nb">bigint</span> <span class="k">references</span> <span class="n">posts</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">created_at</span> <span class="nb">timestamp</span><span class="p">,</span>
    <span class="n">updated_at</span> <span class="nb">timestamp</span><span class="p">,</span>
    <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">ALTER</span> <span class="n">SEQUENCE</span> <span class="n">users_id_seq</span> <span class="k">RESTART</span> <span class="k">WITH</span> <span class="mi">101</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="n">SEQUENCE</span> <span class="n">posts_id_seq</span> <span class="k">RESTART</span> <span class="k">WITH</span> <span class="mi">101</span><span class="p">;</span>
<span class="k">ALTER</span> <span class="n">SEQUENCE</span> <span class="n">comments_id_seq</span> <span class="k">RESTART</span> <span class="k">WITH</span> <span class="mi">101</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that at the end of the SQL script, we have set our database sequence values to start with 101
so that we can insert some sample data along with primary key values for testing.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-jooq-code-generation-using-maven-plugin">9. Configure jOOQ code generation using Maven plugin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Configure the <a href="https://github.com/testcontainers/testcontainers-jooq-codegen-maven-plugin"><strong>testcontainers-jooq-codegen-maven-plugin</strong></a> in <code>pom.xml</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
 ...
    <span class="nt">&lt;properties&gt;</span>
...
        <span class="nt">&lt;testcontainers-jooq-codegen-maven-plugin.version&gt;</span>0.0.2<span class="nt">&lt;/testcontainers-jooq-codegen-maven-plugin.version&gt;</span>
    <span class="nt">&lt;/properties&gt;</span>
...
    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;plugins&gt;</span>
...
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.testcontainers<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>testcontainers-jooq-codegen-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>${testcontainers-jooq-codegen-maven-plugin.version}<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;dependencies&gt;</span>
                    <span class="nt">&lt;dependency&gt;</span>
                        <span class="nt">&lt;groupId&gt;</span>org.testcontainers<span class="nt">&lt;/groupId&gt;</span>
                        <span class="nt">&lt;artifactId&gt;</span>postgresql<span class="nt">&lt;/artifactId&gt;</span>
                        <span class="nt">&lt;version&gt;</span>${testcontainers.version}<span class="nt">&lt;/version&gt;</span>
                    <span class="nt">&lt;/dependency&gt;</span>
                    <span class="nt">&lt;dependency&gt;</span>
                        <span class="nt">&lt;groupId&gt;</span>org.postgresql<span class="nt">&lt;/groupId&gt;</span>
                        <span class="nt">&lt;artifactId&gt;</span>postgresql<span class="nt">&lt;/artifactId&gt;</span>
                        <span class="nt">&lt;version&gt;</span>42.6.0<span class="nt">&lt;/version&gt;</span>
                    <span class="nt">&lt;/dependency&gt;</span>
                <span class="nt">&lt;/dependencies&gt;</span>
                <span class="nt">&lt;executions&gt;</span>
                    <span class="nt">&lt;execution&gt;</span>
                        <span class="nt">&lt;id&gt;</span>generate-jooq-sources<span class="nt">&lt;/id&gt;</span>
                        <span class="nt">&lt;goals&gt;</span>
                            <span class="nt">&lt;goal&gt;</span>generate<span class="nt">&lt;/goal&gt;</span>
                        <span class="nt">&lt;/goals&gt;</span>
                        <span class="nt">&lt;phase&gt;</span>generate-sources<span class="nt">&lt;/phase&gt;</span>
                        <span class="nt">&lt;configuration&gt;</span>
                            <span class="nt">&lt;database&gt;</span>
                                <span class="nt">&lt;type&gt;</span>POSTGRES<span class="nt">&lt;/type&gt;</span>
                                <span class="nt">&lt;containerImage&gt;</span>postgres:15.3-alpine<span class="nt">&lt;/containerImage&gt;</span>
                            <span class="nt">&lt;/database&gt;</span>
                            <span class="nt">&lt;flyway&gt;</span>
                                <span class="nt">&lt;locations&gt;</span>
                                    filesystem:src/main/resources/db/migration
                                <span class="nt">&lt;/locations&gt;</span>
                            <span class="nt">&lt;/flyway&gt;</span>
                            <span class="nt">&lt;jooq&gt;</span>
                                <span class="nt">&lt;generator&gt;</span>
                                    <span class="nt">&lt;database&gt;</span>
                                        <span class="nt">&lt;includes&gt;</span>.*<span class="nt">&lt;/includes&gt;</span>
                                        <span class="nt">&lt;excludes&gt;</span>flyway_schema_history<span class="nt">&lt;/excludes&gt;</span>
                                        <span class="nt">&lt;inputSchema&gt;</span>public<span class="nt">&lt;/inputSchema&gt;</span>
                                    <span class="nt">&lt;/database&gt;</span>
                                    <span class="nt">&lt;target&gt;</span>
                                        <span class="nt">&lt;packageName&gt;</span>example.micronaut.jooq<span class="nt">&lt;/packageName&gt;</span>
                                        <span class="nt">&lt;directory&gt;</span>target/generated-sources/jooq<span class="nt">&lt;/directory&gt;</span>
                                    <span class="nt">&lt;/target&gt;</span>
                                <span class="nt">&lt;/generator&gt;</span>
                            <span class="nt">&lt;/jooq&gt;</span>
                        <span class="nt">&lt;/configuration&gt;</span>
                    <span class="nt">&lt;/execution&gt;</span>
                <span class="nt">&lt;/executions&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
            ...
        <span class="nt">&lt;/plugins&gt;</span>
    <span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/project&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s understand the plugin configuration.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>As we are using PostgreSQL database, we have configured the postgres JDBC driver and Testcontainers postgresql libraries as dependencies of the plugin.</p>
</li>
<li>
<p>Under <code>&lt;configuration&gt;/&lt;database&gt;</code> section, we have configured the type of the database, POSTGRES, that we want to use it for our code generation, and specified the Docker image name, <code>postgres:15.3-alpine</code>, which will be used to create the database instance.</p>
</li>
<li>
<p>Under <code>&lt;configuration&gt;/&lt;flyway&gt;</code> section we have specified the location of Flyway migration scripts path.</p>
</li>
<li>
<p>We have also configured the <strong>packageName</strong> and <strong>target</strong> location for the generated code. You can configure all the configuration options supported by the official <strong>jooq-code-generator</strong> plugin.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The plugin uses Testcontainers to spin up an instance of PostgreSQL container, apply Flyway migrations
and then generate the java code using jOOQ code generation tool.</p>
</div>
<div class="paragraph">
<p>With this configuration in place, now if you run <code>./mvnw package</code> then you can find
the generated code under the <code>target/generated-sources/jooq</code> directory.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-model-classes">10. Create model classes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We may want to create our own model classes to represent the data structures that
we want to return for various use-cases. Imagine we are building a REST API,
and we may want to return responses with only a subset of column values from our tables.</p>
</div>
<div class="paragraph">
<p>So, let&#8217;s create User, Post and Comment classes as follows:</p>
</div>
<div class="listingblock">
<div class="title">testcontainers/src/main/java/example/micronaut/domain/User.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.domain</span><span class="o">;</span>

<span class="kd">public</span> <span class="n">record</span> <span class="nf">User</span><span class="o">(</span>
        <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span>
        <span class="nc">String</span> <span class="n">name</span><span class="o">,</span>
        <span class="nc">String</span> <span class="n">email</span>
<span class="o">)</span> <span class="o">{}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">testcontainers/src/main/java/example/micronaut/domain/Post.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.domain</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="n">record</span> <span class="nf">Post</span><span class="o">(</span>
        <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span>
        <span class="nc">String</span> <span class="n">title</span><span class="o">,</span>
        <span class="nc">String</span> <span class="n">content</span><span class="o">,</span>
        <span class="nc">User</span> <span class="n">createdBy</span><span class="o">,</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Comment</span><span class="o">&gt;</span> <span class="n">comments</span><span class="o">,</span>
        <span class="nc">LocalDateTime</span> <span class="n">createdAt</span><span class="o">,</span>
        <span class="nc">LocalDateTime</span> <span class="n">updatedAt</span>
<span class="o">)</span> <span class="o">{}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">testcontainers/src/main/java/example/micronaut/domain/Comment.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.domain</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>

<span class="kd">public</span> <span class="n">record</span> <span class="nf">Comment</span><span class="o">(</span>
        <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span>
        <span class="nc">String</span> <span class="n">name</span><span class="o">,</span>
        <span class="nc">String</span> <span class="n">content</span><span class="o">,</span>
        <span class="nc">LocalDateTime</span> <span class="n">createdAt</span><span class="o">,</span>
        <span class="nc">LocalDateTime</span> <span class="n">updatedAt</span>
<span class="o">)</span> <span class="o">{}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="implementing-basic-database-operations-using-jooq">11. Implementing basic database operations using jOOQ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s implement methods to create a new user and get user by email using jOOQ as follows:</p>
</div>
<div class="listingblock">
<div class="title">testcontainers/src/main/java/example/micronaut/domain/UserRepository.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.domain</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">example</span><span class="o">.</span><span class="na">micronaut</span><span class="o">.</span><span class="na">jooq</span><span class="o">.</span><span class="na">tables</span><span class="o">.</span><span class="na">Users</span><span class="o">.</span><span class="na">USERS</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">jooq</span><span class="o">.</span><span class="na">Records</span><span class="o">.</span><span class="na">mapping</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.inject.Singleton</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jooq.DSLContext</span><span class="o">;</span>

<span class="nd">@Singleton</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">UserRepository</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">DSLContext</span> <span class="n">dsl</span><span class="o">;</span>

    <span class="nc">UserRepository</span><span class="o">(</span><span class="nc">DSLContext</span> <span class="n">dsl</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="k">this</span><span class="o">.</span><span class="na">dsl</span> <span class="o">=</span> <span class="n">dsl</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">createUser</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">dsl</span>
                <span class="o">.</span><span class="na">insertInto</span><span class="o">(</span><span class="no">USERS</span><span class="o">)</span>
                <span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="no">USERS</span><span class="o">.</span><span class="na">NAME</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">())</span>
                <span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="no">USERS</span><span class="o">.</span><span class="na">EMAIL</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">email</span><span class="o">())</span>
                <span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="no">USERS</span><span class="o">.</span><span class="na">CREATED_AT</span><span class="o">,</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">())</span>
                <span class="o">.</span><span class="na">returningResult</span><span class="o">(</span><span class="no">USERS</span><span class="o">.</span><span class="na">ID</span><span class="o">,</span> <span class="no">USERS</span><span class="o">.</span><span class="na">NAME</span><span class="o">,</span> <span class="no">USERS</span><span class="o">.</span><span class="na">EMAIL</span><span class="o">)</span>
                <span class="o">.</span><span class="na">fetchOne</span><span class="o">(</span><span class="n">mapping</span><span class="o">(</span><span class="nl">User:</span><span class="o">:</span><span class="k">new</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">getUserByEmail</span><span class="o">(</span><span class="nc">String</span> <span class="n">email</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">dsl</span>
                <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="no">USERS</span><span class="o">.</span><span class="na">ID</span><span class="o">,</span> <span class="no">USERS</span><span class="o">.</span><span class="na">NAME</span><span class="o">,</span> <span class="no">USERS</span><span class="o">.</span><span class="na">EMAIL</span><span class="o">)</span>
                <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="no">USERS</span><span class="o">)</span>
                <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="no">USERS</span><span class="o">.</span><span class="na">EMAIL</span><span class="o">.</span><span class="na">equalIgnoreCase</span><span class="o">(</span><span class="n">email</span><span class="o">))</span>
                <span class="o">.</span><span class="na">fetchOptional</span><span class="o">(</span><span class="n">mapping</span><span class="o">(</span><span class="nl">User:</span><span class="o">:</span><span class="k">new</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">dsl</span><span class="o">.</span><span class="na">deleteFrom</span><span class="o">(</span><span class="no">USERS</span><span class="o">).</span><span class="na">where</span><span class="o">(</span><span class="no">USERS</span><span class="o">.</span><span class="na">ID</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="n">id</span><span class="o">)).</span><span class="na">execute</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use constructor injection to inject a bean of type <code>org.jooq.DSLContext</code>. <a href="https://micronaut-projects.github.io/micronaut-sql/latest/guide/#jooq">Micronaut SQL jOOQ</a> integration registers <code>DSLContext</code> singletons so that you can inject them into your application.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can see jOOQ DSL looks very similar to SQL but written in Java. By using jOOQ generated code,
we can keep our code in-sync with the database structure and also benefit from the type safety.</p>
</div>
<div class="paragraph">
<p>For example, the where condition <code>where(USERS.EMAIL.equalIgnoreCase(email))</code> expects a String for
the email value. If you try to pass any non-string value like <code>where(USERS.EMAIL.equalIgnoreCase(123))</code>
then it will give you a compiler error preventing you from making mistakes at the compilation time itself rather than at runtime.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tests">12. Tests</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="testcontainers-dependencies">13. Testcontainers Dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The generated application contains the following Testcontainers dependencies:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.testcontainers<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>testcontainers<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.testcontainers<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>postgresql<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="test-seed-data">13.1. Test Seed Data</h3>
<div class="paragraph">
<p>Before writing the tests, let&#8217;s create an SQL script to set up the test data by
creating <code>src/test/resources/db/testmigration/V99__test_data.sql</code> file as follows:</p>
</div>
<div class="listingblock">
<div class="title">testcontainers/src/test/resources/db/testmigration/V99__test_data.sql</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">comments</span><span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">posts</span><span class="p">;</span>
<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">users</span><span class="p">;</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">users</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span> <span class="k">VALUES</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'Siva'</span><span class="p">,</span> <span class="s1">'siva@gmail.com'</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'Oleg'</span><span class="p">,</span> <span class="s1">'oleg@gmail.com'</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">posts</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">created_by</span><span class="p">,</span> <span class="n">created_at</span><span class="p">)</span> <span class="k">VALUES</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'Post 1 Title'</span><span class="p">,</span> <span class="s1">'Post 1 content'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'Post 2 Title'</span><span class="p">,</span> <span class="s1">'Post 2 content'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">);</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">comments</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">post_id</span><span class="p">,</span> <span class="n">created_at</span><span class="p">)</span> <span class="k">VALUES</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'Ron'</span><span class="p">,</span> <span class="s1">'Comment 1'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'James'</span><span class="p">,</span> <span class="s1">'Comment 2'</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">),</span>
<span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">'Robert'</span><span class="p">,</span> <span class="s1">'Comment 3'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Load the test seed data by adding the following configuration in <code>src/test/resources/application-test.properties</code>.</p>
</div>
<div class="listingblock">
<div class="title">testcontainers/src/test/resources/application-test.properties</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="err">flyway.datasources.default.locations[0]=</span><span class="py">classpath</span><span class="p">:</span><span class="s">db/migration</span>
<span class="err">flyway.datasources.default.locations[1]=</span><span class="py">classpath</span><span class="p">:</span><span class="s">db/testmigration</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="abstracttest-class">13.2. AbstractTest class</h3>
<div class="paragraph">
<p>Create an abstract class to simplify the dynamic configuration of the database connection</p>
</div>
<div class="listingblock">
<div class="title">testcontainers/src/test/java/example/micronaut/domain/AbstractTest.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.domain</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.core.annotation.NonNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.test.support.TestPropertyProvider</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.testcontainers.containers.PostgreSQLContainer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.testcontainers.junit.jupiter.Container</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractTest</span> <span class="kd">implements</span> <span class="nc">TestPropertyProvider</span> <span class="o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="nd">@Container</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="kd">static</span> <span class="nc">PostgreSQLContainer</span><span class="o">&lt;?&gt;</span> <span class="n">postgres</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PostgreSQLContainer</span><span class="o">&lt;&gt;(</span><span class="s">"postgres:15.3-alpine"</span><span class="o">);</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nd">@NonNull</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getProperties</span><span class="o">()</span> <span class="o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="k">if</span> <span class="o">(!</span><span class="n">postgres</span><span class="o">.</span><span class="na">isRunning</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">postgres</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"datasources.default.url"</span><span class="o">,</span> <span class="n">postgres</span><span class="o">.</span><span class="na">getJdbcUrl</span><span class="o">(),</span>
                <span class="s">"datasources.default.username"</span><span class="o">,</span> <span class="n">postgres</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span>
                <span class="s">"datasources.default.password"</span><span class="o">,</span> <span class="n">postgres</span><span class="o">.</span><span class="na">getPassword</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When you need dynamic properties definition, implement the <code>TestPropertyProvider</code> interface. Override the method <code>.getProperties()</code> and return the properties you want to expose to the application.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Shared containers are defined as static fields in a top level test class and have to be annotated with <code>@Container</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="write-repository-test">13.3. Write repository test</h3>
<div class="paragraph">
<p>In order to test the repository, we need to have a running Postgres database instance.
We will extend from <code>AbstractTest</code> to easily start a Postgres database and write the tests
as follows:</p>
</div>
<div class="listingblock">
<div class="title">testcontainers/src/test/java/example/micronaut/domain/UserRepositoryTest.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.domain</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.TestInstance</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.testcontainers.junit.jupiter.Testcontainers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">assertj</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">;</span>

<span class="nd">@MicronautTest</span><span class="o">(</span><span class="n">startApplication</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@TestInstance</span><span class="o">(</span><span class="nc">TestInstance</span><span class="o">.</span><span class="na">Lifecycle</span><span class="o">.</span><span class="na">PER_CLASS</span><span class="o">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="nd">@Testcontainers</span><span class="o">(</span><span class="n">disabledWithoutDocker</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="kd">class</span> <span class="nc">UserRepositoryTest</span> <span class="kd">extends</span> <span class="nc">AbstractTest</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="nc">UserRepository</span> <span class="n">repository</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">shouldCreateUserSuccessfully</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="s">"John"</span><span class="o">,</span> <span class="s">"john@gmail.com"</span><span class="o">);</span>

        <span class="nc">User</span> <span class="n">savedUser</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">savedUser</span><span class="o">.</span><span class="na">id</span><span class="o">()).</span><span class="na">isNotNull</span><span class="o">();</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">savedUser</span><span class="o">.</span><span class="na">name</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"John"</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">savedUser</span><span class="o">.</span><span class="na">email</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"john@gmail.com"</span><span class="o">);</span>

        <span class="n">repository</span><span class="o">.</span><span class="na">deleteUser</span><span class="o">(</span><span class="n">savedUser</span><span class="o">.</span><span class="na">id</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">shouldGetUserByEmail</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">getUserByEmail</span><span class="o">(</span><span class="s">"siva@gmail.com"</span><span class="o">).</span><span class="na">orElseThrow</span><span class="o">();</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">id</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"Siva"</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">email</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"siva@gmail.com"</span><span class="o">);</span>
    <span class="o">}</span>


<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context. This test does not need the embedded server. Set <code>startApplication</code> to <code>false</code> to avoid starting it.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Classes that implement <code>TestPropertyProvider</code> must use this annotation to create a single class instance for all tests (not necessary in Spock tests).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Disable test if Docker not present.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The tests invoke the UserRepository methods and verified the expected return values.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fetching-complex-object-trees-using-jooq">14. Fetching complex object trees using jOOQ</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far we have seen using jOOQ to perform very basic database operations.
But jOOQ shines when it comes to querying the database with complex queries, stored procedures, etc.</p>
</div>
<div class="paragraph">
<p>In our database model, we have Many-To-One relationship from Post-to-User, One-To-Many relationship from Post-to-Comment.</p>
</div>
<div class="paragraph">
<p>Let us see how we can get a <code>Post</code> for a given <code>postId</code> along with the created user and its comments
using jOOQ powerful <strong>MULTISET</strong> feature using a single query.</p>
</div>
<div class="listingblock">
<div class="title">testcontainers/src/main/java/example/micronaut/domain/PostRepository.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.domain</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">example</span><span class="o">.</span><span class="na">micronaut</span><span class="o">.</span><span class="na">jooq</span><span class="o">.</span><span class="na">Tables</span><span class="o">.</span><span class="na">COMMENTS</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">example</span><span class="o">.</span><span class="na">micronaut</span><span class="o">.</span><span class="na">jooq</span><span class="o">.</span><span class="na">tables</span><span class="o">.</span><span class="na">Posts</span><span class="o">.</span><span class="na">POSTS</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">jooq</span><span class="o">.</span><span class="na">Records</span><span class="o">.</span><span class="na">mapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">jooq</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">DSL</span><span class="o">.</span><span class="na">multiset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">jooq</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">DSL</span><span class="o">.</span><span class="na">row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">jooq</span><span class="o">.</span><span class="na">impl</span><span class="o">.</span><span class="na">DSL</span><span class="o">.</span><span class="na">select</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.inject.Singleton</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.jooq.DSLContext</span><span class="o">;</span>

<span class="nd">@Singleton</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">PostRepository</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">DSLContext</span> <span class="n">dsl</span><span class="o">;</span>

    <span class="nc">PostRepository</span><span class="o">(</span><span class="nc">DSLContext</span> <span class="n">dsl</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dsl</span> <span class="o">=</span> <span class="n">dsl</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="nf">getPostById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">dsl</span>
                <span class="o">.</span><span class="na">select</span><span class="o">(</span>
                        <span class="no">POSTS</span><span class="o">.</span><span class="na">ID</span><span class="o">,</span>
                        <span class="no">POSTS</span><span class="o">.</span><span class="na">TITLE</span><span class="o">,</span>
                        <span class="no">POSTS</span><span class="o">.</span><span class="na">CONTENT</span><span class="o">,</span>
                        <span class="n">row</span><span class="o">(</span><span class="no">POSTS</span><span class="o">.</span><span class="na">users</span><span class="o">().</span><span class="na">ID</span><span class="o">,</span> <span class="no">POSTS</span><span class="o">.</span><span class="na">users</span><span class="o">().</span><span class="na">NAME</span><span class="o">,</span> <span class="no">POSTS</span><span class="o">.</span><span class="na">users</span><span class="o">().</span><span class="na">EMAIL</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">mapping</span><span class="o">(</span><span class="nl">User:</span><span class="o">:</span><span class="k">new</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">as</span><span class="o">(</span><span class="s">"createdBy"</span><span class="o">),</span>
                        <span class="n">multiset</span><span class="o">(</span>
                                <span class="n">select</span><span class="o">(</span>
                                        <span class="no">COMMENTS</span><span class="o">.</span><span class="na">ID</span><span class="o">,</span>
                                        <span class="no">COMMENTS</span><span class="o">.</span><span class="na">NAME</span><span class="o">,</span>
                                        <span class="no">COMMENTS</span><span class="o">.</span><span class="na">CONTENT</span><span class="o">,</span>
                                        <span class="no">COMMENTS</span><span class="o">.</span><span class="na">CREATED_AT</span><span class="o">,</span>
                                        <span class="no">COMMENTS</span><span class="o">.</span><span class="na">UPDATED_AT</span>
                                <span class="o">)</span>
                                        <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="no">COMMENTS</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="no">POSTS</span><span class="o">.</span><span class="na">ID</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="no">COMMENTS</span><span class="o">.</span><span class="na">POST_ID</span><span class="o">))</span>
                        <span class="o">)</span>
                                <span class="o">.</span><span class="na">as</span><span class="o">(</span><span class="s">"comments"</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">convertFrom</span><span class="o">(</span><span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">mapping</span><span class="o">(</span><span class="nl">Comment:</span><span class="o">:</span><span class="k">new</span><span class="o">))),</span>
                        <span class="no">POSTS</span><span class="o">.</span><span class="na">CREATED_AT</span><span class="o">,</span>
                        <span class="no">POSTS</span><span class="o">.</span><span class="na">UPDATED_AT</span><span class="o">)</span>
                <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="no">POSTS</span><span class="o">)</span>
                <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="no">POSTS</span><span class="o">.</span><span class="na">ID</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="n">id</span><span class="o">))</span>
                <span class="o">.</span><span class="na">fetchOptional</span><span class="o">(</span><span class="n">mapping</span><span class="o">(</span><span class="nl">Post:</span><span class="o">:</span><span class="k">new</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have used jOOQ&#8217;s <a href="https://www.jooq.org/doc/latest/manual/sql-building/column-expressions/nested-records/">Nested records support</a> for
loading the ManyToOne association of Post-to-User and <a href="https://www.jooq.org/doc/latest/manual/sql-building/column-expressions/multiset-value-constructor/">MULTISET</a> feature for loading OneToMany association of Post-to-Comments.</p>
</div>
<div class="paragraph">
<p>To learn more about <a href="https://blog.jooq.org/jooq-3-15s-new-multiset-operator-will-change-how-you-think-about-sql/">jOOQ&#8217;s MULTISET feature</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
From jOOQ 3.19, fetching the associations using MULTISET is further simplified using <a href="https://www.jooq.org/doc/dev/manual/sql-building/sql-statements/select-statement/implicit-path-correlation/">implicit path correlations feature</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can write integration test for <code>PostRepository</code> as follows:</p>
</div>
<div class="listingblock">
<div class="title">testcontainers/src/test/java/example/micronaut/domain/PostRepositoryTest.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.domain</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.TestInstance</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.testcontainers.junit.jupiter.Testcontainers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">assertj</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">jupiter</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">;</span>

<span class="nd">@MicronautTest</span><span class="o">(</span><span class="n">startApplication</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@TestInstance</span><span class="o">(</span><span class="nc">TestInstance</span><span class="o">.</span><span class="na">Lifecycle</span><span class="o">.</span><span class="na">PER_CLASS</span><span class="o">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="nd">@Testcontainers</span><span class="o">(</span><span class="n">disabledWithoutDocker</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="kd">class</span> <span class="nc">PostRepositoryTest</span> <span class="kd">extends</span> <span class="nc">AbstractTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">shouldGetPostById</span><span class="o">(</span><span class="nc">PostRepository</span> <span class="n">repository</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Post</span><span class="o">&gt;</span> <span class="n">postOptional</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">getPostById</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
        <span class="n">assertTrue</span><span class="o">(</span><span class="n">postOptional</span><span class="o">.</span><span class="na">isPresent</span><span class="o">());</span>
        <span class="nc">Post</span> <span class="n">post</span> <span class="o">=</span> <span class="n">postOptional</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">id</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">title</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"Post 1 Title"</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">content</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"Post 1 content"</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">createdBy</span><span class="o">().</span><span class="na">id</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">createdBy</span><span class="o">().</span><span class="na">name</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"Siva"</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">createdBy</span><span class="o">().</span><span class="na">email</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"siva@gmail.com"</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">post</span><span class="o">.</span><span class="na">comments</span><span class="o">()).</span><span class="na">hasSize</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context. This test does not need the embedded server. Set <code>startApplication</code> to <code>false</code> to avoid starting it.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Classes that implement <code>TestPropertyProvider</code> must use this annotation to create a single class instance for all tests (not necessary in Spock tests).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Disable test if Docker not present.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing-the-application">15. Testing the Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">./mvnw <span class="nb">test</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see all tests PASS. You can also notice that after tests are executed, the containers are stopped and removed automatically.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing-with-test-resources">16. Testing with Test Resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We are going to simplify testing with <a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Micronaut Test Resources adds support for managing external resources which are required during development or testing.</p>
</div>
</blockquote>
</div>
<div class="sect2">
<h3 id="removing-testcontainers-dependencies">16.1. Removing Testcontainers Dependencies</h3>
<div class="paragraph">
<p>Remove the <a href="#testcontainers-dependencies">Testcontainers dependencies</a> from your build files.</p>
</div>
</div>
<div class="sect2">
<h3 id="configure-test-resources">16.2. Configure Test Resources</h3>
<div class="paragraph">
<p><a href="https://micronaut-projects.github.io/micronaut-maven-plugin/latest/examples/test-resources.html">Integerate your Maven Build with Test Resources</a></p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>You can enable test resources support simply by setting the property micronaut.test.resources.enabled (either in your POM or via the command-line).</p>
</div>
</blockquote>
</div>
</div>
<div class="sect2">
<h3 id="test-resources-postgresql">16.3. Test Resources PostgreSQL</h3>
<div class="paragraph">
<p>When the application is started locally&#8201;&#8212;&#8201;either under test or by running the application&#8201;&#8212;&#8201;the resolution of the
properties <code>datasources.default.url</code>, <code>datasources.default.username</code>, and <code>datasources.default.password</code> is detected. The Test Resources service starts a local PostgreSQL docker container and injects the required properties.</p>
</div>
</div>
<div class="sect2">
<h3 id="simpler-test-with-test-resources">16.4. Simpler Test with Test Resources</h3>
<div class="paragraph">
<p>Thanks to Test Resources, we can simplify the test, no need for an abstract class, as follows:</p>
</div>
<div class="listingblock">
<div class="title">testresources/src/test/java/example/micronaut/domain/UserRepositoryTest.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.domain</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.inject.Inject</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">assertj</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertThat</span><span class="o">;</span>

<span class="nd">@MicronautTest</span><span class="o">(</span><span class="n">startApplication</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">UserRepositoryTest</span> <span class="o">{</span>

    <span class="nd">@Inject</span>
    <span class="nc">UserRepository</span> <span class="n">repository</span><span class="o">;</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">shouldCreateUserSuccessfully</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="s">"John"</span><span class="o">,</span> <span class="s">"john@gmail.com"</span><span class="o">);</span>

        <span class="nc">User</span> <span class="n">savedUser</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">savedUser</span><span class="o">.</span><span class="na">id</span><span class="o">()).</span><span class="na">isNotNull</span><span class="o">();</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">savedUser</span><span class="o">.</span><span class="na">name</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"John"</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">savedUser</span><span class="o">.</span><span class="na">email</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"john@gmail.com"</span><span class="o">);</span>

        <span class="n">repository</span><span class="o">.</span><span class="na">deleteUser</span><span class="o">(</span><span class="n">savedUser</span><span class="o">.</span><span class="na">id</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">shouldGetUserByEmail</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">repository</span><span class="o">.</span><span class="na">getUserByEmail</span><span class="o">(</span><span class="s">"siva@gmail.com"</span><span class="o">).</span><span class="na">orElseThrow</span><span class="o">();</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">id</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"Siva"</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">email</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="s">"siva@gmail.com"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. By default, each <code>@Test</code> method will be wrapped in a transaction that will be rolled back when the test finishes. This behaviour is is changed by setting <code>transaction</code> to <code>false</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you run the test, you will see a PostgreSQL container being started by Test Resources through integration with Testcontainers to provide throwaway containers for testing.</p>
</div>
</div>
<div class="sect2">
<h3 id="micronaut-test-resources-goals">16.5. Micronaut Test Resources Goals</h3>
<div class="paragraph">
<p><a href="https://melix.github.io/blog/2022/08/micronaut-test-resources.html">Micronaut Test Resources aims to achieve the following goals</a>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="ulist">
<ul>
<li>
<p><strong>zero-configuration</strong>: without adding any configuration, test resources should be spawned and the application configured to use them. Configuration is only required for advanced use cases.</p>
</li>
<li>
<p><strong>classpath isolation</strong>: use of test resources shouldn’t leak into your application classpath, nor your test classpath</p>
</li>
<li>
<p><strong>compatible with GraalVM native</strong>: if you build a native binary, or run tests in native mode, test resources should be available</p>
</li>
<li>
<p><strong>easy to use</strong>: the Micronaut build plugins for Gradle and Maven should handle the complexity of figuring out the dependencies for you</p>
</li>
<li>
<p><strong>extensible</strong>: you can implement your own test resources, in case the built-in ones do not cover your use case</p>
</li>
<li>
<p><strong>technology agnostic</strong>: while lots of test resources use Testcontainers under the hood, you can use any other technology to create resources</p>
</li>
</ul>
</div>
</blockquote>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary">17. Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Testcontainers library helped us to generate java code from the database using
jOOQ code generator tool, and we are able to write tests by using the same type of database,
PostgreSQL, that we use in production as opposed to using mocks or in-memory databases.</p>
</div>
<div class="paragraph">
<p>As we are always generating the code from the current state of the database,
we can ensure that our code is in sync with the database changes, and we are free to do
any code refactoring and still ensure that the application is working as expected.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="next-steps">18. Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Learn more about:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://micronaut-projects.github.io/micronaut-sql/latest/guide/">Micronaut SQL</a></p>
</li>
<li>
<p><a href="https://micronaut-projects.github.io/micronaut-test-resources/latest/guide/">Micronaut Test Resources</a></p>
</li>
<li>
<p><a href="http://testcontainers.com">Testcontainers</a>.</p>
</li>
<li>
<p><a href="https://www.jooq.org/">jOOQ</a></p>
</li>
<li>
<p><a href="https://www.jooq.org/doc/latest/manual/code-generation/">jOOQ Code Generation</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="help-with-the-micronaut-framework">19. Help with the Micronaut Framework</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://micronaut.io/foundation/">Micronaut Foundation</a> sponsored the creation of this Guide. A variety of <a href="https://micronaut.io/commercial-support/">consulting and support services</a> are available.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="license">20. License</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All guides are released with an <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache license 2.0 license</a> for the code and a <a href="https://creativecommons.org/licenses/by/4.0/deed.en">Creative Commons Attribution 4.0</a> license for the writing and media (images&#8230;&#8203;).
</td>
</tr>
</table>
</div>

            </div>
        </div>
    </div>
</main>

<footer id="footer">
    <div class="container">

        <div class="row">
            <div class="col-sm-5 footer-left">

                <div id="text-14" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <a href="https://micronaut.io/foundation/"><img class="alignnone size-medium wp-image-3736" src="./images/micronaut_foundation_horizontal_white.svg" alt="Micronaut Foundation"/></a>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-sm-7 footer-right">

                <ul class="meta">

                    <li id="menu-item-2895" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2895">
                        <a href="https://micronaut.io/brand-guidelines/">Brand Guidelines</a>
                    </li>
                    <li id="menu-item-2894" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2894">
                        <a href="https://micronaut.io/community-guidelines/">Community Guidelines</a>
                    </li>
                    <li id="menu-item-3377" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-privacy-policy menu-item-3377">
                        <a href="https://micronaut.io/privacy-policy/">Privacy Policy</a>
                    </li>

                </ul>

                <div id="nav_menu-2" class="widget widget_nav_menu">
                    <div class="menu-links-container">
                        <ul id="menu-links" class="menu">
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronautpodcast.com"><i class="fa fa-podcast"><span class="sr-only">Podcast</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronaut.io/feed/rss/"><i class="fa fa-feed"><span class="sr-only">Feed</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="mailto:info@micronaut.io"><i class="fas fa-envelope"><span class="sr-only">Mail</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://twitter.com/micronautfw"><i class="fab fa-twitter"><span class="sr-only">Twitter</span></i></a></li>
                            <li id="menu-item-6740" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-6740"><a href="https://fosstodon.org/@micronaut"><i class="fab fa-mastodon"><span class="sr-only">Mastodon</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://discord.gg/9xRFsHv98T"><i class="fab fa-discord"><span class="sr-only">Discord</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://github.com/micronaut-projects/"><i class="fab fa-github"><span class="sr-only">GitHub</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.youtube.com/@MicronautFramework"><i class="fab fa-youtube"><span class="sr-only">YouTube</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.linkedin.com/showcase/micronaut"><i class="fab fa-linkedin"><span class="sr-only">LinkedIn</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.twitch.tv/micronautfw"><i class="fab fa-twitch"><span class="sr-only">Twitch</span></i></a></li>
                        </ul>
                    </div>
                </div>
                <div id="text-5" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <small>Guides are licensed under <a href="https://creativecommons.org/licenses/by/4.0/deed.en">CC BY 4.0</a> for the writing/media and <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache.2.0</a> for the code</small>
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</footer>
</body>
</html>
