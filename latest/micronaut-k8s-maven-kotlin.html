<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'/>
    <title>Kubernetes service discovery and distributed configuration</title>
    <link rel='stylesheet' id='wp-block-library-css' href='https://micronaut.io/wp-includes/css/dist/block-library/style.min.css' type='text/css' media='all'/>
    <link rel='stylesheet' id='fonts-fira-sans-css' href='https://fonts.googleapis.com/css2?family=Fira+Sans%3Awght%40300%3B500&#038;display=swap&#038;ver=5.7' type='text/css' media='all'/>
    <link rel='stylesheet' id='micronaut-style-css' href='https://micronaut.io/wp-content/themes/micronaut/style.min.css' type='text/css' media='all'/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link rel="shortcut icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link rel="alternate" type="application/rss+xml" title="Micronaut Guides RSS Feed" href="https://guides.micronaut.io/latest/rss.xml" />
    <link rel="alternate" type="application/json" title="Micronaut Guides JSON Feed" href="https://guides.micronaut.io/latest/feed.json" />
    <link href="coderay.css" rel="stylesheet" />
    <link href="rouge-github.css" rel="stylesheet" />
    <link href="guide.css" rel="stylesheet" />
    <script src="lunr.js"></script>
    <script src="guide.js"></script>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://guides.micronaut.io/latest/images/cards/micronaut-k8s.png"/>
    <meta name="twitter:creator" content="@micronautfw"/>
    <meta name="twitter:site" content="@micronautfw"/>
    <meta name="twitter:title" content="Kubernetes service discovery and distributed configuration"/>
    <meta name="twitter:description" content="How to use Kubernetes service discovery and distributed configuration in a Micronaut application"/>
</head>
<body class="page-template page-template-page-sidebar page-template-page-sidebar-php page page-parent guide">

<header id="header">

    <div class="container">

        <nav class="navbar navbar-expand-lg navbar-dark">

            <button class="collapsed" type="button" data-toggle="collapse" data-target="#nav" aria-expanded="false">
                <span></span>
            </button>

            <a class="navbar-brand" href="https://micronaut.io">
                <img src="https://micronaut.io/wp-content/uploads/2020/11/MIcronautLogo_Horizontal.svg" alt="Micronaut framework"/>
            </a>

            <div class="collapse navbar-collapse" id="nav">

                <ul class="navbar-nav ml-auto">

                    <li id="menu-item-2865" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2865 nav-item"><a href="https://micronaut.io/download/" class="nav-link">Download</a></li>
                    <li id="menu-item-2868" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-2868 dropdown nav-item"><a href="https://micronaut.io/learn/" class="nav-link dropdown-toggle" data-toggle="dropdown">Learn</a><ul class="dropdown-menu">
                        <li id="menu-item-4943" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4943"><a href="https://micronaut.io/learn/" class="dropdown-item">Overview</a></li>
                        <li id="menu-item-5111" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-5111"><a href="https://docs.micronaut.io/index.html" class="dropdown-item">User Documentaton</a></li>
                        <li id="menu-item-4510" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4510"><a href="https://micronaut.io/guides/" class="dropdown-item">Guides</a></li>
                        <li id="menu-item-2896" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2896"><a href="https://micronaut.io/category/microcast/" class="dropdown-item">Microcasts</a></li>
                        <li id="menu-item-2897" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2897"><a href="https://micronaut.io/category/webinar/" class="dropdown-item">Webinars</a></li>
                        <li id="menu-item-2871" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2871"><a href="https://micronaut.io/professional-training/" class="dropdown-item">Professional Training</a></li>
                        <li id="menu-item-6526" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-6526"><a href="https://micronaut-projects.github.io/micronaut-guides-mn3/latest/" class="dropdown-item">Guides for Micronaut Framework 3</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2878" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2878 dropdown nav-item"><a href="https://micronaut.io/resources/" class="nav-link dropdown-toggle" data-toggle="dropdown">Resources</a><ul class="dropdown-menu">
                        <li id="menu-item-4999" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4999"><a href="https://micronaut.io/upcoming-events/" class="dropdown-item">Upcoming Events</a></li>
                        <li id="menu-item-2879" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2879"><a href="https://micronaut.io/blog/" class="dropdown-item">Blog</a></li>
                        <li id="menu-item-6478" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6478"><a href="https://micronaut.io/category/release-announcements/" class="dropdown-item">Releases</a></li>
                        <li id="menu-item-6715" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6715"><a href="https://micronaut.io/category/security-announcements/" class="dropdown-item">Security Announcements</a></li>
                        <li id="menu-item-4499" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-4499"><a href="https://micronautpodcast.com/" class="dropdown-item">Podcast</a></li>
                        <li id="menu-item-5798" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5798"><a href="https://micronaut.io/support/" class="dropdown-item">Commercial Support</a></li>
                        <li id="menu-item-4186" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4186"><a href="https://micronaut.io/resources/community-support/" class="dropdown-item">Community Support</a></li>
                        <li id="menu-item-2882" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2882"><a href="https://micronaut.io/faq/" class="dropdown-item">FAQ</a></li>
                        <li id="menu-item-2883" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2883"><a href="https://micronaut.io/contact/" class="dropdown-item">Contact</a></li>
                        <li id="menu-item-6479" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6479"><a href="https://micronaut.io/micronaut-success-stories/" class="dropdown-item">Micronaut Success Stories</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2872" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2872 dropdown nav-item"><a href="https://micronaut.io/foundation/" class="nav-link dropdown-toggle" data-toggle="dropdown">Foundation</a><ul class="dropdown-menu">
                        <li id="menu-item-2877" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2877"><a href="https://micronaut.io/foundation/" class="dropdown-item">Overview</a></li>
                        <li id="menu-item-2874" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2874"><a href="https://micronaut.io/foundation/corporate-sponsorship/" class="dropdown-item">Corporate Sponsorship</a></li>
                        <li id="menu-item-2873" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2873"><a href="https://micronaut.io/foundation/community-sponsorship/" class="dropdown-item">Community Sponsorship</a></li>
                        <li id="menu-item-2876" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2876"><a href="https://micronaut.io/foundation/sponsors/" class="dropdown-item">Sponsors</a></li>
                        <li id="menu-item-3838" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-3838"><a href="https://micronaut.io/meeting-minutes/" class="dropdown-item">Meeting Minutes</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2884" class="action menu-item menu-item-type-custom menu-item-object-custom menu-item-2884 nav-item"><a target="_blank" rel="noopener" href="https://micronaut.io/launch/" class="nav-link">Launch</a></li>

                </ul>

            </div>

        </nav>

    </div>
</header>

<div style="background: #fff;padding-top: 20px;padding-bottom: 20px;">
    <div class="container" style="clear: both;">
        <fieldset style="float: right;">
            <input type="search" id="search-form-query"/>
            <input type="submit" onclick="search()" value="Search">
            <input type="submit" onclick="resetSearch()" value="Reset">
        </fieldset>
    </div>
    <div class="container" style="clear: both;margin-top: -20px;">
        <div class="guide-list" id="searchResults">
        </div>
    </div>
</div>
<div id="breadcrumbs"><div class="container"><a href="https://micronaut.io/">Home</a> » <a href="./index.html">Guides</a> » <a href="micronaut-k8s.html">Kubernetes service discovery and distributed configuration</a> » <span class="breadcrumb_last" aria-current="page">maven | kotlin</span></div></div><!-- .breadcrumbs -->
<main id="main">
    <div class="container">
        <div class="row">
            <div class="col-md-4">

                <div class="toc">
                    <div class="inner">
                        <h1 class="title title_large first-word-bold first-word-break">Table of Contents</h1>
                        <div class="underline"></div>
                        
<ul class="sectlevel1">
<li><a href="#getting-started">1. Getting Started</a></li>
<li><a href="#what-you-will-need">2. What you will need</a></li>
<li><a href="#solution">3. Solution</a></li>
<li><a href="#writing-the-apps">4. Writing the Apps</a>
<ul class="sectlevel2">
<li><a href="#users-microservice">4.1. Users Microservice</a></li>
<li><a href="#orders-microservice">4.2. Orders Microservice</a></li>
<li><a href="#api-gateway-microservice">4.3. API (Gateway) Microservice</a></li>
<li><a href="#test-integration-between-applications">4.4. Test integration between applications</a></li>
</ul>
</li>
<li><a href="#kubernetes-and-the-micronaut-framework">5. Kubernetes and the Micronaut framework</a>
<ul class="sectlevel2">
<li><a href="#users-microservice-2">5.1. Users Microservice</a></li>
<li><a href="#orders-microservice-2">5.2. Orders Microservice</a></li>
<li><a href="#api-gateway-microservice-2">5.3. API (Gateway) Microservice</a></li>
<li><a href="#test-integration-between-applications-deployed-on-kubernetes">5.4. Test integration between applications deployed on Kubernetes</a></li>
</ul>
</li>
<li><a href="#cleaning-up">6. Cleaning Up</a></li>
<li><a href="#next-steps">7. Next Steps</a></li>
<li><a href="#license">8. License</a></li>
</ul>

                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <h1>Kubernetes service discovery and distributed configuration</h1>
                <div class="underline"></div>
<div class="sect1">
<div class="sectionbody">

<div class="paragraph">
<p>How to use Kubernetes service discovery and distributed configuration in a Micronaut application</p>
</div>
<div class="paragraph">
<p>Authors: Nemanja Mikic</p>
</div>
<div class="paragraph">
<p>Micronaut Version: 4.9.1</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started">1. Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this guide, we will create three microservices, build containerized versions and deploy them with <a href="https://kubernetes.io/">Kubernetes</a>. We will use Kubernetes Service discovery and Distributed configuration to wire up our microservices.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Kubernetes is a portable, extensible, open source platform for managing containerized workloads and services, that facilitates both declarative configuration and automation. It has a large, rapidly growing ecosystem. Kubernetes services, support, and tools are widely available.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>You will discover how the Micronaut framework eases Kubernetes integration.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-you-will-need">2. What you will need</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE (e.g. <a href="https://guides.micronaut.io/latest/micronaut-intellij-idea-ide-setup.html">IntelliJ IDEA</a>)</p>
</li>
<li>
<p>JDK 17 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
<li>
<p><a href="https://www.docker.io/gettingstarted/#h_installation">Docker</a>.</p>
</li>
<li>
<p>Local Kubernetes cluster. We will use <a href="https://minikube.sigs.k8s.io/docs/">Minikube</a> in this guide.</p>
</li>
</ul>
</div>
</div>
</div>
</div></div><div class="row"><div class="col-md-12"><div class="sect1">
<h2 id="solution">3. Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create the application step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="micronaut-k8s-maven-kotlin.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-the-apps">4. Writing the Apps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s describe the microservices you will build through the guide.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>users</code> - This microservice contains customers data that can place orders on items, also a new customer can be created. Microservice requires Basic authentication to access it.</p>
</li>
<li>
<p><code>orders</code> - This microservice contains all orders that customers have created as well as available items that customers can order. Also this microservice enables the creation of new orders. Microservice requires Basic authentication to access it.</p>
</li>
<li>
<p><code>api</code> - This microservice acts as a gateway to the <code>orders</code> and <code>users</code> services. It combines results from both services and checks data when customers create a new order.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Initially we will hard-code the URLs of the <code>orders</code> and <code>users</code> services in the <code>api</code> service. Additionally, we will hard-code credentials (username and password) into every microservice configuration that are required for Basic authentication.</p>
</div>
<div class="paragraph">
<p>In the second part of this guide we will use a Kubernetes discovery service and Kubernetes configuration maps to dynamically resolve the URLs of the <code>orders</code> and <code>users</code> microservices  and get authentication credentials. The microservices call the Kubernetes API to register when they start up and then resolve placeholders inside the microservices' configurations.</p>
</div>
<div class="sect2">
<h3 id="users-microservice">4.1. Users Microservice</h3>
<div class="paragraph">
<p>Create the <code>users</code> microservice using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">mn create-app          <span class="se">\</span>
    <span class="nt">--features</span><span class="o">=</span>yaml,discovery-kubernetes,management,security,kubernetes,serialization-jackson,validation,graalvm <span class="se">\</span>
    <span class="nt">--build</span><span class="o">=</span>maven             <span class="se">\</span>
    <span class="nt">--lang</span><span class="o">=</span>kotlin               <span class="se">\</span>
    <span class="nt">--jdk</span><span class="o">=</span>21              <span class="se">\</span>
    example.micronaut.users</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle with the <a href="https://docs.gradle.org/current/userguide/kotlin_dsl.html">Kotlin DSL</a> is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.<br/> If you don&#8217;t specify the <code>--test</code> argument, JUnit is used for Java and Kotlin, and Spock is used for Groovy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add the <code>yaml</code>, <code>discovery-kubernetes</code>, <code>management</code>, <code>security</code>, <code>serialization-jackson</code>, <code>kubernetes</code> and <code>graalvm</code> features.</p>
</div>
<div class="paragraph">
<p>The previous command creates a directory named <em>users</em> containing Micronaut application with a package named <code>example.micronaut</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have an existing Micronaut application and want to add the functionality described here, you can view the dependency and configuration changes from the specified features, and apply those changes to your application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://micronaut.io/launch?features=yaml&amp;features=discovery-kubernetes&amp;features=management&amp;features=security&amp;features=kubernetes&amp;features=serialization-jackson&amp;features=validation&amp;features=graalvm&amp;lang=KOTLIN&amp;build=MAVEN&amp;test=JUNIT&amp;name=users&amp;type=DEFAULT&amp;package=example.micronaut&amp;activity=diff" target="_blank" rel="noopener">Diff</a></p>
</div>
<div class="paragraph">
<p>Create a package named <code>controllers</code> and create a <code>UsersController</code> class to handle incoming HTTP requests for the <code>users</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/kotlin/example/micronaut/controllers/UsersController.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.controllers</span>

<span class="k">import</span> <span class="nn">example.micronaut.models.User</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.HttpStatus</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Body</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Get</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Post</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.exceptions.HttpStatusException</span>
<span class="k">import</span> <span class="nn">io.micronaut.security.annotation.Secured</span>
<span class="k">import</span> <span class="nn">io.micronaut.security.rules.SecurityRule</span>
<span class="k">import</span> <span class="nn">jakarta.validation.Valid</span>
<span class="k">import</span> <span class="nn">jakarta.validation.constraints.NotNull</span>
<span class="k">import</span> <span class="nn">kotlin.collections.ArrayList</span>

<span class="nd">@Controller</span><span class="p">(</span><span class="s">"/users"</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@Secured</span><span class="p">(</span><span class="nc">SecurityRule</span><span class="p">.</span><span class="nc">IS_AUTHENTICATED</span><span class="p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="k">open</span> <span class="kd">class</span> <span class="nc">UsersController</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="py">persons</span><span class="p">:</span> <span class="nc">MutableList</span><span class="p">&lt;</span><span class="nc">User</span><span class="p">?&gt;</span> <span class="p">=</span> <span class="nc">ArrayList</span><span class="p">()</span>

    <span class="nd">@Post</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="k">open</span> <span class="k">fun</span> <span class="nf">add</span><span class="p">(</span><span class="nd">@Body</span> <span class="n">user</span><span class="p">:</span> <span class="nd">@Valid</span> <span class="nc">User</span><span class="p">?):</span> <span class="nc">User</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">foundUser</span> <span class="p">=</span> <span class="nf">findByUsername</span><span class="p">(</span><span class="n">user</span><span class="o">!!</span><span class="p">.</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">foundUser</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nc">HttpStatusException</span><span class="p">(</span><span class="nc">HttpStatus</span><span class="p">.</span><span class="nc">CONFLICT</span><span class="p">,</span> <span class="s">"User with provided username already exists"</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="kd">val</span> <span class="py">newUser</span> <span class="p">=</span> <span class="nc">User</span><span class="p">(</span><span class="n">persons</span><span class="p">.</span><span class="n">size</span> <span class="p">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">firstName</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">lastName</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">username</span><span class="p">)</span>
        <span class="n">persons</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">newUser</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newUser</span>
    <span class="p">}</span>

    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/{id}"</span><span class="p">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="k">open</span> <span class="k">fun</span> <span class="nf">findById</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nd">@NotNull</span> <span class="nc">Int</span><span class="p">?):</span> <span class="nc">User</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">persons</span>
            <span class="p">.</span><span class="nf">firstOrNull</span> <span class="p">{</span> <span class="n">it</span><span class="p">:</span> <span class="nc">User</span><span class="p">?</span> <span class="p">-&gt;</span>
                <span class="n">it</span><span class="o">!!</span><span class="p">.</span><span class="n">id</span> <span class="p">==</span> <span class="n">id</span>
            <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@Get</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="k">open</span> <span class="k">fun</span> <span class="nf">getUsers</span><span class="p">():</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">User</span><span class="p">?&gt;?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">persons</span>
    <span class="p">}</span>

    <span class="k">open</span> <span class="k">fun</span> <span class="nf">findByUsername</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="nd">@NotNull</span> <span class="nc">String</span><span class="p">?):</span> <span class="nc">User</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">persons</span><span class="p">.</span><span class="nf">firstOrNull</span> <span class="p">{</span> <span class="n">it</span><span class="p">:</span> <span class="nc">User</span><span class="p">?</span> <span class="p">-&gt;</span>
            <span class="n">it</span><span class="o">!!</span><span class="p">.</span><span class="n">username</span> <span class="p">==</span> <span class="n">username</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/users</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>io.micronaut.security.Secured</code> to configure secured access. The <code>isAuthenticated()</code> expression will allow access only to authenticated users.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation maps the <code>add</code> method to an HTTP POST request on <code>/users</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>findById</code> method to an HTTP GET request on <code>/users/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getUsers</code> method to an HTTP GET request on <code>/users</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>models</code> where we will put our data beans.</p>
</div>
<div class="paragraph">
<p>The <code>UsersController</code> class uses a <code>User</code> object to represent customer. Create the <code>User</code> class</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/kotlin/example/micronaut/models/User.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.models</span>

<span class="k">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonProperty</span>
<span class="k">import</span> <span class="nn">io.micronaut.core.annotation.Nullable</span>
<span class="k">import</span> <span class="nn">io.micronaut.serde.annotation.Serdeable</span>
<span class="k">import</span> <span class="nn">jakarta.validation.constraints.Max</span>
<span class="k">import</span> <span class="nn">jakarta.validation.constraints.NotBlank</span>

<span class="nd">@Serdeable</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">data class</span> <span class="nc">User</span><span class="p">(</span><span class="nd">@Nullable</span> <span class="nd">@Max</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span> <span class="kd">val</span> <span class="py">id</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <i class="conum" data-value="2"></i><b>(2)</b>
                <span class="nd">@NotBlank</span> <span class="nd">@JsonProperty</span><span class="p">(</span><span class="s">"first_name"</span><span class="p">)</span> <span class="kd">val</span> <span class="py">firstName</span><span class="p">:</span><span class="nc">String</span><span class="p">,</span>
                <span class="nd">@NotBlank</span> <span class="nd">@JsonProperty</span><span class="p">(</span><span class="s">"last_name"</span><span class="p">)</span>  <span class="kd">val</span> <span class="py">lastName</span><span class="p">:</span><span class="nc">String</span><span class="p">,</span>
                <span class="kd">val</span> <span class="py">username</span><span class="p">:</span><span class="nc">String</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ID will be generated by application.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>auth</code> where you will check basic authentication credentials.</p>
</div>
<div class="paragraph">
<p>The <code>Credentials</code> class will load and store credentials (username and password) from a configuration file.</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/kotlin/example/micronaut/auth/Credentials.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.auth</span>

<span class="k">import</span> <span class="nn">io.micronaut.context.annotation.ConfigurationProperties</span>

<span class="nd">@ConfigurationProperties</span><span class="p">(</span><span class="s">"authentication-credentials"</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">Credentials</span><span class="p">{</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">username</span><span class="p">:</span> <span class="nc">String</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">password</span><span class="p">:</span> <span class="nc">String</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@ConfigurationProperties</code> annotation takes the configuration prefix.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>CredentialsChecker</code> class, as the name suggests, will check if the provided credentials inside the HTTP request&#8217;s <code>Authorization</code> header are the same as those that are stored inside the <code>Credentials</code> class that we created above.</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/kotlin/example/micronaut/auth/CredentialsChecker.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.auth</span>

<span class="k">import</span> <span class="nn">io.micronaut.http.HttpRequest</span>
<span class="k">import</span> <span class="nn">io.micronaut.security.authentication.AuthenticationFailureReason</span>
<span class="k">import</span> <span class="nn">io.micronaut.security.authentication.AuthenticationRequest</span>
<span class="k">import</span> <span class="nn">io.micronaut.security.authentication.AuthenticationResponse</span>
<span class="k">import</span> <span class="nn">io.micronaut.security.authentication.provider.HttpRequestAuthenticationProvider</span>
<span class="k">import</span> <span class="nn">jakarta.inject.Singleton</span>

<span class="nd">@Singleton</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">AuthenticationProviderUserPassword</span><span class="p">&lt;</span><span class="nc">B</span><span class="p">&gt;(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">credentials</span><span class="p">:</span> <span class="nc">Credentials</span><span class="p">)</span> <span class="p">:</span> <span class="nc">HttpRequestAuthenticationProvider</span><span class="p">&lt;</span><span class="nc">B</span><span class="p">&gt;</span> <span class="p">{</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">authenticate</span><span class="p">(</span>
        <span class="n">httpRequest</span><span class="p">:</span> <span class="nc">HttpRequest</span><span class="p">&lt;</span><span class="nc">B</span><span class="p">&gt;?,</span>
        <span class="n">authenticationRequest</span><span class="p">:</span> <span class="nc">AuthenticationRequest</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;</span>
    <span class="p">):</span> <span class="nc">AuthenticationResponse</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">authenticationRequest</span><span class="p">.</span><span class="n">identity</span> <span class="p">==</span> <span class="n">credentials</span><span class="p">.</span><span class="n">username</span> <span class="p">&amp;&amp;</span> <span class="n">authenticationRequest</span><span class="p">.</span><span class="n">secret</span> <span class="p">==</span> <span class="n">credentials</span><span class="p">.</span><span class="n">password</span><span class="p">)</span>
            <span class="nc">AuthenticationResponse</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="n">authenticationRequest</span><span class="p">.</span><span class="n">identity</span><span class="p">)</span> <span class="k">else</span>
            <span class="nc">AuthenticationResponse</span><span class="p">.</span><span class="nf">failure</span><span class="p">(</span><span class="nc">AuthenticationFailureReason</span><span class="p">.</span><span class="nc">CREDENTIALS_DO_NOT_MATCH</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><br></p>
</div>
<div class="sect3">
<h4 id="write-tests-to-verify-application-logic">4.1.1. Write tests to verify application logic</h4>
<div class="paragraph">
<p>Create the <code>UsersClient</code>, a declarative Micronaut HTTP Client for testing:</p>
</div>
<div class="listingblock">
<div class="title">users/src/test/kotlin/example/micronaut/UsersClient.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut</span>

<span class="k">import</span> <span class="nn">example.micronaut.models.User</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Body</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Get</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Header</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Post</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.annotation.Client</span>

<span class="nd">@Client</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">interface</span> <span class="nc">UsersClient</span> <span class="p">{</span>
    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/users/{id}"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">getById</span><span class="p">(</span><span class="nd">@Header</span> <span class="n">authorization</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span> <span class="n">id</span><span class="p">:</span> <span class="nc">Int</span><span class="p">?):</span> <span class="nc">User</span><span class="p">?</span>

    <span class="nd">@Post</span><span class="p">(</span><span class="s">"/users"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">createUser</span><span class="p">(</span><span class="nd">@Header</span> <span class="n">authorization</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span> <span class="nd">@Body</span> <span class="n">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">?):</span> <span class="nc">User</span>

    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/users"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">getUsers</span><span class="p">(</span><span class="nd">@Header</span> <span class="n">authorization</span><span class="p">:</span> <span class="nc">String</span><span class="p">?):</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">User</span><span class="p">?&gt;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>HealthTest</code> checks that there is <code>/health</code> endpoint that is required for service discovery.</p>
</div>
<div class="listingblock">
<div class="title">users/src/test/kotlin/example/micronaut/HealthTest.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut</span>

<span class="k">import</span> <span class="nn">io.micronaut.http.HttpRequest</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.HttpStatus</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.HttpClient</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.annotation.Client</span>
<span class="k">import</span> <span class="nn">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span>
<span class="k">import</span> <span class="nn">jakarta.inject.Inject</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertEquals</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Test</span>

<span class="nd">@MicronautTest</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">HealthTest</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Client</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">client</span><span class="p">:</span> <span class="nc">HttpClient</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">healthEndpointExposed</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">status</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">toBlocking</span><span class="p">().</span><span class="nf">retrieve</span><span class="p">(</span>
            <span class="nc">HttpRequest</span><span class="p">.</span><span class="nc">GET</span><span class="p">&lt;</span><span class="nc">Any</span><span class="p">&gt;(</span><span class="s">"/health"</span><span class="p">),</span>
            <span class="nc">HttpStatus</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span>
        <span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">HttpStatus</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject the <code>HttpClient</code> bean and point it to the embedded server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>UsersControllerTest</code> tests endpoints inside the <code>UserController</code>.</p>
</div>
<div class="listingblock">
<div class="title">users/src/test/kotlin/example/micronaut/UsersControllerTest.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut</span>

<span class="k">import</span> <span class="nn">example.micronaut.auth.Credentials</span>
<span class="k">import</span> <span class="nn">example.micronaut.models.User</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.HttpStatus</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.exceptions.HttpClientException</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.exceptions.HttpClientResponseException</span>
<span class="k">import</span> <span class="nn">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span>
<span class="k">import</span> <span class="nn">jakarta.inject.Inject</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertEquals</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertNotEquals</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertNotNull</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertNull</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertThrows</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertTrue</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Test</span>
<span class="k">import</span> <span class="nn">java.util.Base64</span>


<span class="nd">@MicronautTest</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">UsersControllerTest</span> <span class="p">{</span>
    <span class="nd">@Inject</span>
    <span class="kd">var</span> <span class="py">usersClient</span><span class="p">:</span> <span class="nc">UsersClient</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="nd">@Inject</span>
    <span class="kd">var</span> <span class="py">credentials</span><span class="p">:</span> <span class="nc">Credentials</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">testUnauthorized</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">exception</span> <span class="p">=</span> <span class="nf">assertThrows</span><span class="p">(</span>
            <span class="nc">HttpClientException</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span>
        <span class="p">)</span> <span class="p">{</span> <span class="n">usersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getUsers</span><span class="p">(</span><span class="s">""</span><span class="p">)</span> <span class="p">}</span>
        <span class="nf">assertTrue</span><span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">message</span><span class="o">!!</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="s">"Unauthorized"</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">userThatDoesntExists</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">authHeader</span> <span class="p">=</span> <span class="s">"Basic "</span> <span class="p">+</span> <span class="nc">Base64</span><span class="p">.</span><span class="nf">getEncoder</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">encodeToString</span><span class="p">((</span><span class="n">credentials</span><span class="o">!!</span><span class="p">.</span><span class="n">username</span> <span class="p">+</span> <span class="s">":"</span> <span class="p">+</span> <span class="n">credentials</span><span class="o">!!</span><span class="p">.</span><span class="n">password</span><span class="p">).</span><span class="nf">toByteArray</span><span class="p">())</span>
        <span class="kd">val</span> <span class="py">retriedUser</span> <span class="p">=</span> <span class="n">usersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getById</span><span class="p">(</span><span class="n">authHeader</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="nf">assertNull</span><span class="p">(</span><span class="n">retriedUser</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">multipleUserInteraction</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">authHeader</span> <span class="p">=</span> <span class="s">"Basic "</span> <span class="p">+</span> <span class="nc">Base64</span><span class="p">.</span><span class="nf">getEncoder</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">encodeToString</span><span class="p">((</span><span class="n">credentials</span><span class="o">!!</span><span class="p">.</span><span class="n">username</span> <span class="p">+</span> <span class="s">":"</span> <span class="p">+</span> <span class="n">credentials</span><span class="o">!!</span><span class="p">.</span><span class="n">password</span><span class="p">).</span><span class="nf">toByteArray</span><span class="p">())</span>
        <span class="kd">val</span> <span class="py">firstName</span> <span class="p">=</span> <span class="s">"firstName"</span>
        <span class="kd">val</span> <span class="py">lastName</span> <span class="p">=</span> <span class="s">"lastName"</span>
        <span class="kd">val</span> <span class="py">username</span> <span class="p">=</span> <span class="s">"username"</span>
        <span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="nc">User</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">firstName</span><span class="p">,</span> <span class="n">lastName</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">createdUser</span> <span class="p">=</span> <span class="n">usersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">createUser</span><span class="p">(</span><span class="n">authHeader</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">firstName</span><span class="p">,</span> <span class="n">createdUser</span><span class="p">.</span><span class="n">firstName</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">lastName</span><span class="p">,</span> <span class="n">createdUser</span><span class="p">.</span><span class="n">lastName</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">createdUser</span><span class="p">.</span><span class="n">username</span><span class="p">)</span>
        <span class="nf">assertNotNull</span><span class="p">(</span><span class="n">createdUser</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">retriedUser</span> <span class="p">=</span> <span class="n">usersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getById</span><span class="p">(</span><span class="n">authHeader</span><span class="p">,</span> <span class="n">createdUser</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">firstName</span><span class="p">,</span> <span class="n">retriedUser</span><span class="o">!!</span><span class="p">.</span><span class="n">firstName</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">lastName</span><span class="p">,</span> <span class="n">retriedUser</span><span class="p">.</span><span class="n">lastName</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">retriedUser</span><span class="p">.</span><span class="n">username</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">users</span> <span class="p">=</span> <span class="n">usersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getUsers</span><span class="p">(</span><span class="n">authHeader</span><span class="p">)</span>
        <span class="nf">assertNotNull</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
        <span class="nf">assertNotNull</span><span class="p">(</span><span class="n">users</span><span class="p">.</span><span class="nf">any</span> <span class="p">{</span>
            <span class="n">it</span><span class="o">!!</span><span class="p">.</span><span class="n">username</span> <span class="p">==</span> <span class="n">username</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">createSameUserTwice</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">authHeader</span> <span class="p">=</span> <span class="s">"Basic "</span> <span class="p">+</span> <span class="nc">Base64</span><span class="p">.</span><span class="nf">getEncoder</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">encodeToString</span><span class="p">((</span><span class="n">credentials</span><span class="o">!!</span><span class="p">.</span><span class="n">username</span> <span class="p">+</span> <span class="s">":"</span> <span class="p">+</span> <span class="n">credentials</span><span class="o">!!</span><span class="p">.</span><span class="n">password</span><span class="p">).</span><span class="nf">toByteArray</span><span class="p">())</span>
        <span class="kd">val</span> <span class="py">firstName</span> <span class="p">=</span> <span class="s">"SameUserFirstName"</span>
        <span class="kd">val</span> <span class="py">lastName</span> <span class="p">=</span> <span class="s">"SameUserLastName"</span>
        <span class="kd">val</span> <span class="py">username</span> <span class="p">=</span> <span class="s">"SameUserUsername"</span>
        <span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="nc">User</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">firstName</span><span class="p">,</span> <span class="n">lastName</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">createdUser</span> <span class="p">=</span> <span class="n">usersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">createUser</span><span class="p">(</span><span class="n">authHeader</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">firstName</span><span class="p">,</span> <span class="n">createdUser</span><span class="p">.</span><span class="n">firstName</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">lastName</span><span class="p">,</span> <span class="n">createdUser</span><span class="p">.</span><span class="n">lastName</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">createdUser</span><span class="p">.</span><span class="n">username</span><span class="p">)</span>
        <span class="nf">assertNotNull</span><span class="p">(</span><span class="n">createdUser</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertNotEquals</span><span class="p">(</span><span class="n">createdUser</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">exception</span> <span class="p">=</span> <span class="nf">assertThrows</span><span class="p">(</span>
            <span class="nc">HttpClientResponseException</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span>
        <span class="p">)</span> <span class="p">{</span> <span class="n">usersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">createUser</span><span class="p">(</span><span class="n">authHeader</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span> <span class="p">}</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">HttpStatus</span><span class="p">.</span><span class="nc">CONFLICT</span><span class="p">,</span> <span class="n">exception</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
        <span class="nf">assertTrue</span><span class="p">(</span>
            <span class="n">exception</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="nf">getBody</span><span class="p">(</span><span class="nc">String</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">).</span><span class="nf">orElse</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="s">"User with provided username already exists"</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit <em>application.yml</em></p>
</div>
<div class="listingblock">
<div class="title">users/src/main/resources/application.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">micronaut</span><span class="pi">:</span>
  <span class="na">application</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">users</span>
<span class="na">authentication-credentials</span><span class="pi">:</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s">${username}</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="na">password</span><span class="pi">:</span> <span class="s">${password}</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Placeholder for username that will be populated by Kubernetes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Placeholder for password that will be populated by Kubernetes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit the <em>bootstrap.yml</em> file in the <em>resources</em> directory to <a href="https://docs.micronaut.io/latest/guide/#bootstrap">enable distributed configuration</a>.
Change the default contents to the following:</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/resources/bootstrap.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">micronaut</span><span class="pi">:</span>
  <span class="na">application</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">users</span>
  <span class="na">config-client</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="na">kubernetes</span><span class="pi">:</span>
  <span class="na">client</span><span class="pi">:</span>
    <span class="na">secrets</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="na">use-api</span><span class="pi">:</span> <span class="no">true</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>microanut.config-client.enabled: true</code>  to read and resolve configuration from distributed sources.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set <code>kubernetes.client.secrets.enabled: true</code> to enable Kubernetes secrets as distributed source.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set <code>kubernetes.client.secrets.use-api: true</code> to use the Kubernetes API to fetch the configuration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/application-dev.yml</code>. The Micronaut framework applies this configuration file only for the <code>dev</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/resources/application-dev.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">micronaut</span><span class="pi">:</span>
  <span class="na">server</span><span class="pi">:</span>
    <span class="na">port</span><span class="pi">:</span> <span class="s">8081</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="na">authentication-credentials</span><span class="pi">:</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s2">"</span><span class="s">test_username"</span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">test_password"</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the application to listen on port 8081.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded username for the development environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Hardcoded password for the development environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>bootstrap-dev.yml</em> to disable distributed configuration in the dev environment:</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/resources/bootstrap-dev.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">kubernetes</span><span class="pi">:</span>
  <span class="na">client</span><span class="pi">:</span>
    <span class="na">secrets</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Disable the Kubernetes secrets client.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>application-test.yml</em> for use in the test environment:</p>
</div>
<div class="listingblock">
<div class="title">users/src/test/resources/application-test.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">authentication-credentials</span><span class="pi">:</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s2">"</span><span class="s">test_username"</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">test_password"</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hardcoded username for the test environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded password for the test environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the unit test:</p>
</div>
<div class="listingblock">
<div class="title">users</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">./mvnw <span class="nb">test</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><br></p>
</div>
</div>
<div class="sect3">
<h4 id="running-the-application">4.1.2. Running the application</h4>
<div class="paragraph">
<p>Run the <code>users</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">users</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"> <span class="nv">MICRONAUT_ENVIRONMENTS</span><span class="o">=</span>dev ./mvnw mn:run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8081</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="orders-microservice">4.2. Orders Microservice</h3>
<div class="paragraph">
<p>Create the <code>orders</code> microservice using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">mn create-app        <span class="se">\</span>
  <span class="nt">--features</span><span class="o">=</span>yaml,discovery-kubernetes,management,security,kubernetes,serialization-jackson,validation,graalvm <span class="se">\</span>
  <span class="nt">--build</span><span class="o">=</span>maven              <span class="se">\</span>
  <span class="nt">--lang</span><span class="o">=</span>kotlin                <span class="se">\</span>
  <span class="nt">--jdk</span><span class="o">=</span>21               <span class="se">\</span>
example.micronaut.orders</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle with the <a href="https://docs.gradle.org/current/userguide/kotlin_dsl.html">Kotlin DSL</a> is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.<br/> If you don&#8217;t specify the <code>--test</code> argument, JUnit is used for Java and Kotlin, and Spock is used for Groovy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add the <code>yaml</code>, <code>discovery-kubernetes</code>, <code>management</code>, <code>security</code>, <code>serialization-jackson</code>, <code>kubernetes</code> and <code>graalvm</code> features.</p>
</div>
<div class="paragraph">
<p>The previous command creates a directory named <em>orders</em> containing a Micronaut application with a package named <code>example.micronaut</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have an existing Micronaut application and want to add the functionality described here, you can view the dependency and configuration changes from the specified features, and apply those changes to your application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://micronaut.io/launch?features=yaml&amp;features=discovery-kubernetes&amp;features=management&amp;features=security&amp;features=kubernetes&amp;features=serialization-jackson&amp;features=validation&amp;features=graalvm&amp;lang=KOTLIN&amp;build=MAVEN&amp;test=JUNIT&amp;name=orders&amp;type=DEFAULT&amp;package=example.micronaut&amp;activity=diff" target="_blank" rel="noopener">Diff</a></p>
</div>
<div class="paragraph">
<p>Create package named <code>controllers</code> and create the <code>OrdersController</code> and <code>ItemsController</code> classes to handle incoming HTTP requests to the <code>orders</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/kotlin/example/micronaut/controllers/OrdersController.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.controllers</span>

<span class="k">import</span> <span class="nn">example.micronaut.models.Item</span>
<span class="k">import</span> <span class="nn">example.micronaut.models.Item.Companion.items</span>
<span class="k">import</span> <span class="nn">example.micronaut.models.Order</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.HttpStatus</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Body</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Get</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Post</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.exceptions.HttpStatusException</span>
<span class="k">import</span> <span class="nn">io.micronaut.security.annotation.Secured</span>
<span class="k">import</span> <span class="nn">io.micronaut.security.rules.SecurityRule</span>
<span class="k">import</span> <span class="nn">java.math.BigDecimal</span>
<span class="k">import</span> <span class="nn">jakarta.validation.Valid</span>
<span class="k">import</span> <span class="nn">jakarta.validation.constraints.NotNull</span>

<span class="nd">@Controller</span><span class="p">(</span><span class="s">"/orders"</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@Secured</span><span class="p">(</span><span class="nc">SecurityRule</span><span class="p">.</span><span class="nc">IS_AUTHENTICATED</span><span class="p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="k">open</span> <span class="kd">class</span> <span class="nc">OrdersController</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">orders</span><span class="p">:</span> <span class="nc">MutableList</span><span class="p">&lt;</span><span class="nc">Order</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nc">ArrayList</span><span class="p">()</span>

    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/{id}"</span><span class="p">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="k">open</span> <span class="k">fun</span> <span class="nf">findById</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nd">@NotNull</span> <span class="nc">Int</span><span class="p">?):</span> <span class="nc">Order</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">orders</span><span class="p">.</span><span class="nf">firstOrNull</span><span class="p">{</span> <span class="n">it</span><span class="p">:</span> <span class="nc">Order</span> <span class="p">-&gt;</span>
            <span class="n">it</span><span class="p">.</span><span class="n">id</span> <span class="p">==</span> <span class="n">id</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@Get</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="k">fun</span> <span class="nf">getOrders</span><span class="p">():</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Order</span><span class="p">?&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">orders</span>
    <span class="p">}</span>

    <span class="nd">@Post</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="k">open</span> <span class="k">fun</span> <span class="nf">createOrder</span><span class="p">(</span><span class="nd">@Body</span> <span class="n">order</span><span class="p">:</span> <span class="nd">@Valid</span> <span class="nc">Order</span><span class="p">):</span> <span class="nc">Order</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">itemIds</span><span class="p">.</span><span class="nf">isNullOrEmpty</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nc">HttpStatusException</span><span class="p">(</span><span class="nc">HttpStatus</span><span class="p">.</span><span class="nc">BAD_REQUEST</span><span class="p">,</span> <span class="s">"Items must be supplied"</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="kd">val</span> <span class="py">items</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Item</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">order</span><span class="p">.</span><span class="n">itemIds</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">x</span> <span class="p">-&gt;</span>
            <span class="n">items</span><span class="p">.</span><span class="nf">firstOrNull</span> <span class="p">{</span> <span class="n">y</span><span class="p">:</span> <span class="nc">Item</span> <span class="p">-&gt;</span>
                <span class="n">y</span><span class="p">.</span><span class="n">id</span> <span class="p">==</span> <span class="n">x</span>
            <span class="p">}</span><span class="o">?:</span> <span class="k">throw</span> <span class="nc">HttpStatusException</span><span class="p">(</span><span class="nc">HttpStatus</span><span class="p">.</span><span class="nc">BAD_REQUEST</span><span class="p">,</span> <span class="nc">String</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="s">"Item with id %s doesn't exist"</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="kd">val</span> <span class="py">total</span><span class="p">:</span> <span class="nc">BigDecimal</span> <span class="p">=</span> <span class="n">items</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nc">Item</span><span class="o">::</span><span class="n">price</span><span class="p">).</span><span class="nf">reduce</span><span class="p">(</span><span class="nc">BigDecimal</span><span class="o">::</span><span class="n">add</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">newOrder</span> <span class="p">=</span> <span class="nc">Order</span><span class="p">(</span><span class="n">orders</span><span class="p">.</span><span class="n">size</span> <span class="p">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">order</span><span class="p">.</span><span class="n">userId</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
        <span class="n">orders</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">newOrder</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newOrder</span>
    <span class="p">}</span>

<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/orders</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>io.micronaut.security.Secured</code> to configure secured access. The <code>isAuthenticated()</code> expression will allow access only to authenticated users.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>findById</code> method to an HTTP GET request on <code>/orders/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getOrders</code> method to an HTTP GET request on <code>/orders</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation maps the <code>createOrder</code> method to an HTTP POST request on <code>/orders</code>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">orders/src/main/kotlin/example/micronaut/controllers/ItemsController.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.controllers</span>

<span class="k">import</span> <span class="nn">example.micronaut.models.Item</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Get</span>
<span class="k">import</span> <span class="nn">io.micronaut.security.annotation.Secured</span>
<span class="k">import</span> <span class="nn">io.micronaut.security.rules.SecurityRule</span>
<span class="k">import</span> <span class="nn">jakarta.validation.constraints.NotNull</span>

<span class="nd">@Controller</span><span class="p">(</span><span class="s">"/items"</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@Secured</span><span class="p">(</span><span class="nc">SecurityRule</span><span class="p">.</span><span class="nc">IS_AUTHENTICATED</span><span class="p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="k">open</span> <span class="kd">class</span> <span class="nc">ItemsController</span> <span class="p">{</span>

    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/{id}"</span><span class="p">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="k">open</span> <span class="k">fun</span> <span class="nf">findById</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nd">@NotNull</span> <span class="nc">Int</span><span class="p">?):</span> <span class="nc">Item</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">Item</span><span class="p">.</span><span class="n">items</span>
            <span class="p">.</span><span class="nf">firstOrNull</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">id</span> <span class="p">==</span> <span class="n">id</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@Get</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="k">fun</span> <span class="nf">getItems</span><span class="p">():</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Item</span><span class="p">?&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">Item</span><span class="p">.</span><span class="n">items</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/items</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>io.micronaut.security.Secured</code> to configure secured access. The <code>isAuthenticated()</code> expression will allow access only to authenticated users.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>findById</code> method to an HTTP GET request on <code>/items/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getItems</code> method to an HTTP GET request on <code>/items</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>models</code> where you will put your data beans.</p>
</div>
<div class="paragraph">
<p>The previous <code>OrdersController</code> and <code>ItemsController</code> controller uses <code>Order</code> and <code>Item</code>  objects to represent customer orders. Create the <code>Order</code> class:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/kotlin/example/micronaut/models/Order.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.models</span>

<span class="k">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonProperty</span>
<span class="k">import</span> <span class="nn">io.micronaut.core.annotation.Nullable</span>
<span class="k">import</span> <span class="nn">io.micronaut.serde.annotation.Serdeable</span>
<span class="k">import</span> <span class="nn">java.math.BigDecimal</span>
<span class="k">import</span> <span class="nn">jakarta.validation.constraints.Max</span>

<span class="nd">@Serdeable</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">data class</span> <span class="nc">Order</span> <span class="p">(</span>
    <span class="nd">@Nullable</span> <span class="nd">@Max</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span> <span class="kd">val</span> <span class="py">id</span><span class="p">:</span><span class="nc">Int</span><span class="p">,</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nd">@JsonProperty</span><span class="p">(</span><span class="s">"user_id"</span><span class="p">)</span> <span class="kd">val</span> <span class="py">userId</span><span class="p">:</span><span class="nc">Int</span><span class="p">,</span>
    <span class="nd">@Nullable</span> <span class="kd">val</span> <span class="py">items</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Item</span><span class="p">&gt;?,</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nd">@JsonProperty</span><span class="p">(</span><span class="s">"item_ids"</span><span class="p">)</span> <span class="kd">val</span> <span class="py">itemIds</span><span class="p">:</span><span class="nc">List</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;?,</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="nd">@Nullable</span> <span class="kd">val</span> <span class="py">total</span><span class="p">:</span> <span class="nc">BigDecimal</span><span class="p">?)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ID will be generated by application.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>List</code> of <code>Item</code> class will be populated by the server and will be only visible in sever responses.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>List of item_ids will be provided by client requests.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the <code>Item</code> class:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/kotlin/example/micronaut/models/Item.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.models</span>

<span class="k">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonProperty</span>
<span class="k">import</span> <span class="nn">io.micronaut.serde.annotation.Serdeable</span>
<span class="k">import</span> <span class="nn">java.math.BigDecimal</span>

<span class="nd">@Serdeable</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">data class</span> <span class="nc">Item</span> <span class="p">(</span>
    <span class="kd">val</span> <span class="py">id</span><span class="p">:</span><span class="nc">Int</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">name</span><span class="p">:</span><span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">price</span><span class="p">:</span> <span class="nc">BigDecimal</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="py">items</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Item</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span>
            <span class="nc">Item</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"Banana"</span><span class="p">,</span> <span class="nc">BigDecimal</span><span class="p">(</span><span class="s">"1.5"</span><span class="p">)),</span>
            <span class="nc">Item</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">"Kiwi"</span><span class="p">,</span> <span class="nc">BigDecimal</span><span class="p">(</span><span class="s">"2.5"</span><span class="p">)),</span>
            <span class="nc">Item</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">"Grape"</span><span class="p">,</span> <span class="nc">BigDecimal</span><span class="p">(</span><span class="s">"1.25"</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>auth</code> where you will check basic authentication credentials.</p>
</div>
<div class="paragraph">
<p>The <code>Credentials</code> class will load and store credentials (username and password) from configuration files.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/kotlin/example/micronaut/auth/Credentials.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.auth</span>

<span class="k">import</span> <span class="nn">io.micronaut.context.annotation.ConfigurationProperties</span>

<span class="nd">@ConfigurationProperties</span><span class="p">(</span><span class="s">"authentication-credentials"</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">Credentials</span><span class="p">{</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">username</span><span class="p">:</span> <span class="nc">String</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">password</span><span class="p">:</span> <span class="nc">String</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@ConfigurationProperties</code> annotation takes the configuration prefix.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>CredentialsChecker</code> class, as name suggests, will check if provided credentials inside an HTTP request&#8217;s <code>Authorization</code> header are the same as those that are stored inside <code>Credentials</code> class that we created above.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/kotlin/example/micronaut/auth/CredentialsChecker.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.auth</span>

<span class="k">import</span> <span class="nn">io.micronaut.http.HttpRequest</span>
<span class="k">import</span> <span class="nn">io.micronaut.security.authentication.AuthenticationFailureReason</span>
<span class="k">import</span> <span class="nn">io.micronaut.security.authentication.AuthenticationRequest</span>
<span class="k">import</span> <span class="nn">io.micronaut.security.authentication.AuthenticationResponse</span>
<span class="k">import</span> <span class="nn">io.micronaut.security.authentication.provider.HttpRequestAuthenticationProvider</span>
<span class="k">import</span> <span class="nn">jakarta.inject.Singleton</span>

<span class="nd">@Singleton</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">AuthenticationProviderUserPassword</span><span class="p">&lt;</span><span class="nc">B</span><span class="p">&gt;(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">credentials</span><span class="p">:</span> <span class="nc">Credentials</span><span class="p">)</span> <span class="p">:</span> <span class="nc">HttpRequestAuthenticationProvider</span><span class="p">&lt;</span><span class="nc">B</span><span class="p">&gt;</span> <span class="p">{</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">authenticate</span><span class="p">(</span>
        <span class="n">httpRequest</span><span class="p">:</span> <span class="nc">HttpRequest</span><span class="p">&lt;</span><span class="nc">B</span><span class="p">&gt;?,</span>
        <span class="n">authenticationRequest</span><span class="p">:</span> <span class="nc">AuthenticationRequest</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;</span>
    <span class="p">):</span> <span class="nc">AuthenticationResponse</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">authenticationRequest</span><span class="p">.</span><span class="n">identity</span> <span class="p">==</span> <span class="n">credentials</span><span class="p">.</span><span class="n">username</span> <span class="p">&amp;&amp;</span> <span class="n">authenticationRequest</span><span class="p">.</span><span class="n">secret</span> <span class="p">==</span> <span class="n">credentials</span><span class="p">.</span><span class="n">password</span><span class="p">)</span>
            <span class="nc">AuthenticationResponse</span><span class="p">.</span><span class="nf">success</span><span class="p">(</span><span class="n">authenticationRequest</span><span class="p">.</span><span class="n">identity</span><span class="p">)</span> <span class="k">else</span>
            <span class="nc">AuthenticationResponse</span><span class="p">.</span><span class="nf">failure</span><span class="p">(</span><span class="nc">AuthenticationFailureReason</span><span class="p">.</span><span class="nc">CREDENTIALS_DO_NOT_MATCH</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><br></p>
</div>
<div class="sect3">
<h4 id="write-tests-to-verify-application-logic-2">4.2.1. Write tests to verify application logic</h4>
<div class="paragraph">
<p>Create the <code>OrderItemClient</code>, a declarative Micronaut HTTP Client for testing:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/test/kotlin/example/micronaut/OrderItemClient.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut</span>

<span class="k">import</span> <span class="nn">example.micronaut.models.Item</span>
<span class="k">import</span> <span class="nn">example.micronaut.models.Order</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Body</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Get</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Header</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Post</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.annotation.Client</span>

<span class="nd">@Client</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">interface</span> <span class="nc">OrderItemClient</span> <span class="p">{</span>
    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/orders/{id}"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">getOrderById</span><span class="p">(</span><span class="nd">@Header</span> <span class="n">authorization</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span> <span class="n">id</span><span class="p">:</span> <span class="nc">Int</span><span class="p">?):</span> <span class="nc">Order</span><span class="p">?</span>

    <span class="nd">@Post</span><span class="p">(</span><span class="s">"/orders"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">createOrder</span><span class="p">(</span><span class="nd">@Header</span> <span class="n">authorization</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span> <span class="nd">@Body</span> <span class="n">order</span><span class="p">:</span> <span class="nc">Order</span><span class="p">?):</span> <span class="nc">Order</span>

    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/orders"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">getOrders</span><span class="p">(</span><span class="nd">@Header</span> <span class="n">authorization</span><span class="p">:</span> <span class="nc">String</span><span class="p">?):</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Order</span><span class="p">&gt;</span>

    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/items"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">getItems</span><span class="p">(</span><span class="nd">@Header</span> <span class="n">authorization</span><span class="p">:</span> <span class="nc">String</span><span class="p">?):</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Item</span><span class="p">&gt;</span>

    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/items/{id}"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">getItemsById</span><span class="p">(</span><span class="nd">@Header</span> <span class="n">authorization</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span> <span class="n">id</span><span class="p">:</span> <span class="nc">Int</span><span class="p">?):</span> <span class="nc">Item</span><span class="p">?</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>HealthTest</code> checks that there is <code>/health</code> endpoint that is required for service discovery.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/test/kotlin/example/micronaut/HealthTest.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut</span>

<span class="k">import</span> <span class="nn">io.micronaut.http.HttpRequest</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.HttpStatus</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.HttpClient</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.annotation.Client</span>
<span class="k">import</span> <span class="nn">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span>
<span class="k">import</span> <span class="nn">jakarta.inject.Inject</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertEquals</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Test</span>

<span class="nd">@MicronautTest</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">HealthTest</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Client</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">client</span><span class="p">:</span> <span class="nc">HttpClient</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">healthEndpointExposed</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">status</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">toBlocking</span><span class="p">().</span><span class="nf">retrieve</span><span class="p">(</span>
            <span class="nc">HttpRequest</span><span class="p">.</span><span class="nc">GET</span><span class="p">&lt;</span><span class="nc">Any</span><span class="p">&gt;(</span><span class="s">"/health"</span><span class="p">),</span>
            <span class="nc">HttpStatus</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span>
        <span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">HttpStatus</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject the <code>HttpClient</code> bean and point it to the embedded server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>ItemsControllerTest</code> tests endpoints inside the <code>ItemController</code>.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/test/kotlin/example/micronaut/ItemsControllerTest.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut</span>

<span class="k">import</span> <span class="nn">example.micronaut.auth.Credentials</span>
<span class="k">import</span> <span class="nn">example.micronaut.models.Item</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.exceptions.HttpClientException</span>
<span class="k">import</span> <span class="nn">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span>
<span class="k">import</span> <span class="nn">jakarta.inject.Inject</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertEquals</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertNotNull</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertThrows</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertTrue</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Test</span>
<span class="k">import</span> <span class="nn">java.math.BigDecimal</span>
<span class="k">import</span> <span class="nn">java.util.Base64</span>

<span class="nd">@MicronautTest</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">ItemsControllerTest</span> <span class="p">{</span>
    <span class="nd">@Inject</span>
    <span class="kd">var</span> <span class="py">orderItemClient</span><span class="p">:</span> <span class="nc">OrderItemClient</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="nd">@Inject</span>
    <span class="kd">var</span> <span class="py">credentials</span><span class="p">:</span> <span class="nc">Credentials</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">testUnauthorized</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">exception</span> <span class="p">=</span> <span class="nf">assertThrows</span><span class="p">(</span>
            <span class="nc">HttpClientException</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span>
        <span class="p">)</span> <span class="p">{</span> <span class="n">orderItemClient</span><span class="o">?.</span><span class="nf">getItems</span><span class="p">(</span><span class="s">""</span><span class="p">)</span> <span class="p">}</span>
        <span class="nf">assertTrue</span><span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">message</span><span class="o">!!</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="s">"Unauthorized"</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">getItem</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">itemId</span> <span class="p">=</span> <span class="mi">1</span>
        <span class="kd">val</span> <span class="py">authHeader</span> <span class="p">=</span> <span class="s">"Basic "</span> <span class="p">+</span> <span class="nc">Base64</span><span class="p">.</span><span class="nf">getEncoder</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">encodeToString</span><span class="p">((</span><span class="n">credentials</span><span class="o">!!</span><span class="p">.</span><span class="n">username</span> <span class="p">+</span> <span class="s">":"</span> <span class="p">+</span> <span class="n">credentials</span><span class="o">!!</span><span class="p">.</span><span class="n">password</span><span class="p">).</span><span class="nf">toByteArray</span><span class="p">())</span>
        <span class="kd">val</span> <span class="py">item</span><span class="p">:</span> <span class="nc">Item</span><span class="p">?</span> <span class="p">=</span> <span class="n">orderItemClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getItemsById</span><span class="p">(</span><span class="n">authHeader</span><span class="p">,</span> <span class="n">itemId</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">itemId</span><span class="p">,</span> <span class="n">item</span><span class="o">!!</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"Banana"</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">BigDecimal</span><span class="p">(</span><span class="s">"1.5"</span><span class="p">),</span> <span class="n">item</span><span class="p">.</span><span class="n">price</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">getItems</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">authHeader</span> <span class="p">=</span> <span class="s">"Basic "</span> <span class="p">+</span> <span class="nc">Base64</span><span class="p">.</span><span class="nf">getEncoder</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">encodeToString</span><span class="p">((</span><span class="n">credentials</span><span class="o">!!</span><span class="p">.</span><span class="n">username</span> <span class="p">+</span> <span class="s">":"</span> <span class="p">+</span> <span class="n">credentials</span><span class="o">!!</span><span class="p">.</span><span class="n">password</span><span class="p">).</span><span class="nf">toByteArray</span><span class="p">())</span>
        <span class="kd">val</span> <span class="py">items</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Item</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">orderItemClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getItems</span><span class="p">(</span><span class="n">authHeader</span><span class="p">)</span>
        <span class="nf">assertNotNull</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">existingItemNames</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span><span class="s">"Kiwi"</span><span class="p">,</span> <span class="s">"Banana"</span><span class="p">,</span> <span class="s">"Grape"</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">items</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
        <span class="nf">assertTrue</span><span class="p">(</span><span class="n">items</span><span class="p">.</span><span class="nf">stream</span><span class="p">()</span>
            <span class="p">.</span><span class="n">map</span><span class="p">&lt;</span><span class="nc">Any</span><span class="p">&gt;(</span><span class="nc">Item</span><span class="o">::</span><span class="n">name</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">allMatch</span> <span class="p">{</span> <span class="n">name</span><span class="p">:</span> <span class="nc">Any</span> <span class="p">-&gt;</span>
                <span class="n">existingItemNames</span><span class="p">.</span><span class="nf">stream</span><span class="p">().</span><span class="nf">anyMatch</span> <span class="p">{</span> <span class="n">x</span><span class="p">:</span> <span class="nc">String</span> <span class="p">-&gt;</span> <span class="n">x</span> <span class="p">==</span> <span class="n">name</span> <span class="p">}</span>
            <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>OrdersControllerTest</code> tests endpoints inside the <code>OrdersController</code>.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/test/kotlin/example/micronaut/OrdersControllerTest.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut</span>

<span class="k">import</span> <span class="nn">example.micronaut.auth.Credentials</span>
<span class="k">import</span> <span class="nn">example.micronaut.models.Order</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.HttpStatus</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.exceptions.HttpClientException</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.exceptions.HttpClientResponseException</span>
<span class="k">import</span> <span class="nn">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span>
<span class="k">import</span> <span class="nn">jakarta.inject.Inject</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertEquals</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertNotNull</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertTrue</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Test</span>
<span class="k">import</span> <span class="nn">java.math.BigDecimal</span>
<span class="k">import</span> <span class="nn">java.util.Base64</span>

<span class="nd">@MicronautTest</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">OrdersControllerTest</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="kd">var</span> <span class="py">orderItemClient</span><span class="p">:</span> <span class="nc">OrderItemClient</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="nd">@Inject</span>
    <span class="kd">var</span> <span class="py">credentials</span><span class="p">:</span> <span class="nc">Credentials</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">testUnauthorized</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">exception</span> <span class="p">=</span> <span class="nc">Assertions</span><span class="p">.</span><span class="nf">assertThrows</span><span class="p">(</span>
            <span class="nc">HttpClientException</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span>
        <span class="p">)</span> <span class="p">{</span> <span class="n">orderItemClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getOrders</span><span class="p">(</span><span class="s">""</span><span class="p">)</span> <span class="p">}</span>
        <span class="nf">assertTrue</span><span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">message</span><span class="o">!!</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="s">"Unauthorized"</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">multipleOrderInteraction</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">authHeader</span> <span class="p">=</span> <span class="s">"Basic "</span> <span class="p">+</span> <span class="nc">Base64</span><span class="p">.</span><span class="nf">getEncoder</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">encodeToString</span><span class="p">((</span><span class="n">credentials</span><span class="o">!!</span><span class="p">.</span><span class="n">username</span> <span class="p">+</span> <span class="s">":"</span> <span class="p">+</span> <span class="n">credentials</span><span class="o">!!</span><span class="p">.</span><span class="n">password</span><span class="p">).</span><span class="nf">toByteArray</span><span class="p">())</span>
        <span class="kd">val</span> <span class="py">userId</span> <span class="p">=</span> <span class="mi">1</span>
        <span class="kd">val</span> <span class="py">itemIds</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">order</span> <span class="p">=</span> <span class="nc">Order</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">userId</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">itemIds</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">createdOrder</span> <span class="p">=</span> <span class="n">orderItemClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">createOrder</span><span class="p">(</span><span class="n">authHeader</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="nf">assertNotNull</span><span class="p">(</span><span class="n">createdOrder</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">createdOrder</span><span class="p">.</span><span class="n">items</span><span class="o">!!</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">BigDecimal</span><span class="p">(</span><span class="s">"6.75"</span><span class="p">),</span> <span class="n">createdOrder</span><span class="p">.</span><span class="n">total</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">createdOrder</span><span class="p">.</span><span class="n">userId</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">retrievedOrder</span> <span class="p">=</span> <span class="n">orderItemClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getOrderById</span><span class="p">(</span><span class="n">authHeader</span><span class="p">,</span> <span class="n">createdOrder</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertNotNull</span><span class="p">(</span><span class="n">retrievedOrder</span><span class="o">!!</span><span class="p">.</span><span class="n">items</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">retrievedOrder</span><span class="p">.</span><span class="n">items</span><span class="o">!!</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">BigDecimal</span><span class="p">(</span><span class="s">"6.75"</span><span class="p">),</span> <span class="n">retrievedOrder</span><span class="p">.</span><span class="n">total</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">userId</span><span class="p">,</span> <span class="n">retrievedOrder</span><span class="p">.</span><span class="n">userId</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">orders</span> <span class="p">=</span> <span class="n">orderItemClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getOrders</span><span class="p">(</span><span class="n">authHeader</span><span class="p">)</span>
        <span class="nf">assertNotNull</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span>
        <span class="nf">assertTrue</span><span class="p">(</span><span class="n">orders</span><span class="p">.</span><span class="nf">stream</span><span class="p">()</span>
            <span class="p">.</span><span class="n">map</span><span class="p">&lt;</span><span class="nc">Any</span><span class="p">&gt;(</span><span class="nc">Order</span><span class="o">::</span><span class="n">userId</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">anyMatch</span> <span class="p">{</span> <span class="n">id</span><span class="p">:</span> <span class="nc">Any</span> <span class="p">-&gt;</span> <span class="n">id</span> <span class="p">==</span> <span class="n">userId</span> <span class="p">})</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">itemDoesntExists</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">authHeader</span> <span class="p">=</span> <span class="s">"Basic "</span> <span class="p">+</span> <span class="nc">Base64</span><span class="p">.</span><span class="nf">getEncoder</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">encodeToString</span><span class="p">((</span><span class="n">credentials</span><span class="o">!!</span><span class="p">.</span><span class="n">username</span> <span class="p">+</span> <span class="s">":"</span> <span class="p">+</span> <span class="n">credentials</span><span class="o">!!</span><span class="p">.</span><span class="n">password</span><span class="p">).</span><span class="nf">toByteArray</span><span class="p">())</span>
        <span class="kd">val</span> <span class="py">userId</span> <span class="p">=</span> <span class="mi">1</span>
        <span class="kd">val</span> <span class="py">itemIds</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">order</span> <span class="p">=</span> <span class="nc">Order</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">userId</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">itemIds</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">exception</span> <span class="p">=</span> <span class="nc">Assertions</span><span class="p">.</span><span class="nf">assertThrows</span><span class="p">(</span>
            <span class="nc">HttpClientResponseException</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span>
        <span class="p">)</span> <span class="p">{</span> <span class="n">orderItemClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">createOrder</span><span class="p">(</span><span class="n">authHeader</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="p">}</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="nc">HttpStatus</span><span class="p">.</span><span class="nc">BAD_REQUEST</span><span class="p">)</span>
        <span class="nf">assertTrue</span><span class="p">(</span>
            <span class="n">exception</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="nf">getBody</span><span class="p">(</span><span class="nc">String</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">).</span><span class="nf">orElse</span><span class="p">(</span><span class="s">""</span><span class="p">).</span><span class="nf">contains</span><span class="p">(</span><span class="s">"Item with id 5 doesn't exist"</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">orderEmptyItems</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">authHeader</span> <span class="p">=</span> <span class="s">"Basic "</span> <span class="p">+</span> <span class="nc">Base64</span><span class="p">.</span><span class="nf">getEncoder</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">encodeToString</span><span class="p">((</span><span class="n">credentials</span><span class="o">!!</span><span class="p">.</span><span class="n">username</span> <span class="p">+</span> <span class="s">":"</span> <span class="p">+</span> <span class="n">credentials</span><span class="o">!!</span><span class="p">.</span><span class="n">password</span><span class="p">).</span><span class="nf">toByteArray</span><span class="p">())</span>
        <span class="kd">val</span> <span class="py">userId</span> <span class="p">=</span> <span class="mi">1</span>
        <span class="kd">val</span> <span class="py">order</span> <span class="p">=</span> <span class="nc">Order</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">userId</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">exception</span> <span class="p">=</span> <span class="nc">Assertions</span><span class="p">.</span><span class="nf">assertThrows</span><span class="p">(</span>
            <span class="nc">HttpClientResponseException</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span>
        <span class="p">)</span> <span class="p">{</span> <span class="n">orderItemClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">createOrder</span><span class="p">(</span><span class="n">authHeader</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> <span class="p">}</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="nc">HttpStatus</span><span class="p">.</span><span class="nc">BAD_REQUEST</span><span class="p">)</span>
        <span class="nf">assertTrue</span><span class="p">(</span>
            <span class="n">exception</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="nf">getBody</span><span class="p">(</span><span class="nc">String</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">).</span><span class="nf">orElse</span><span class="p">(</span><span class="s">""</span><span class="p">).</span><span class="nf">contains</span><span class="p">(</span><span class="s">"Items must be supplied"</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit <em>application.yml</em> so it contains:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/resources/application.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">micronaut</span><span class="pi">:</span>
  <span class="na">application</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">orders</span>
<span class="na">authentication-credentials</span><span class="pi">:</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s">${username}</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="na">password</span><span class="pi">:</span> <span class="s">${password}</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Placeholder for username that will be populated by Kubernetes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Placeholder for password that will be populated by Kubernetes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit <em>bootstrap.yml</em> file in
the <em>resources</em> directory to <a href="https://docs.micronaut.io/latest/guide/#bootstrap">enable distributed configuration</a>.
Change it to the following:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/resources/bootstrap.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">micronaut</span><span class="pi">:</span>
  <span class="na">application</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">orders</span>
  <span class="na">config-client</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="na">kubernetes</span><span class="pi">:</span>
  <span class="na">client</span><span class="pi">:</span>
    <span class="na">secrets</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="na">use-api</span><span class="pi">:</span> <span class="no">true</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>microanut.config-client.enabled: true</code> to read and resolve configuration from distributed sources.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set <code>kubernetes.client.secrets.enabled: true</code> to enable Kubernetes secrets as distributed source.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set <code>kubernetes.client.secrets.use-api: true</code> to use Kubernetes API to fetch configuration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/application-dev.yml</code>. The Micronaut framework applies this configuration file only for the <code>dev</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/resources/application-dev.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">micronaut</span><span class="pi">:</span>
  <span class="na">server</span><span class="pi">:</span>
    <span class="na">port</span><span class="pi">:</span> <span class="s">8082</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="na">authentication-credentials</span><span class="pi">:</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s2">"</span><span class="s">test_username"</span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">test_password"</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the application to listen on port 8082.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded username for development environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Hardcoded password for development environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>bootstrap-dev.yml</em> to disable distributed configuration in the dev environment:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/resources/bootstrap-dev.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">kubernetes</span><span class="pi">:</span>
  <span class="na">client</span><span class="pi">:</span>
    <span class="na">secrets</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Disable Kubernetes secrets client.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>application-test.yml</em> to be used in the test environment:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/test/resources/application-test.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">micronaut</span><span class="pi">:</span>
  <span class="na">application</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">orders</span>
<span class="na">authentication-credentials</span><span class="pi">:</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s2">"</span><span class="s">test_username"</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">test_password"</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hardcoded username for development environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded password for development environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the unit test:</p>
</div>
<div class="listingblock">
<div class="title">orders</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">./mvnw <span class="nb">test</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><br></p>
</div>
</div>
<div class="sect3">
<h4 id="running-the-application-2">4.2.2. Running the application</h4>
<div class="paragraph">
<p>Run the <code>orders</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">orders</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">MICRONAUT_ENVIRONMENTS</span><span class="o">=</span>dev ./mvnw mn:run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8082</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="api-gateway-microservice">4.3. API (Gateway) Microservice</h3>
<div class="paragraph">
<p>Create the <code>api</code> microservice using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">mn create-app         <span class="se">\</span>
   <span class="nt">--features</span><span class="o">=</span>yaml,discovery-kubernetes,management,kubernetes,serialization-jackson,http-client,mockito,kapt,graalvm <span class="se">\</span>
   <span class="nt">--build</span><span class="o">=</span>maven           <span class="se">\</span>
   <span class="nt">--lang</span><span class="o">=</span>kotlin             <span class="se">\</span>
   <span class="nt">--jdk</span><span class="o">=</span>21            <span class="se">\</span>
    example.micronaut.api</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle with the <a href="https://docs.gradle.org/current/userguide/kotlin_dsl.html">Kotlin DSL</a> is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.<br/> If you don&#8217;t specify the <code>--test</code> argument, JUnit is used for Java and Kotlin, and Spock is used for Groovy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add the <code>yaml</code>, <code>discovery-kubernetes</code>, <code>management</code>, <code>kubernetes</code>, <code>serialization-jackson</code>, <code>mockito</code>, <code>graalvm</code> and <code>http-client</code> features.</p>
</div>
<div class="paragraph">
<p>The previous command creates a directory named <em>api</em> containing a Micronaut application with a package named <code>example.micronaut</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have an existing Micronaut application and want to add the functionality described here, you can view the dependency and configuration changes from the specified features, and apply those changes to your application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://micronaut.io/launch?features=yaml&amp;features=discovery-kubernetes&amp;features=management&amp;features=kubernetes&amp;features=serialization-jackson&amp;features=http-client&amp;features=mockito&amp;features=kapt&amp;features=graalvm&amp;lang=KOTLIN&amp;build=MAVEN&amp;test=JUNIT&amp;name=api&amp;type=DEFAULT&amp;package=example.micronaut&amp;activity=diff" target="_blank" rel="noopener">Diff</a></p>
</div>
<div class="paragraph">
<p>Create a package named <code>controllers</code> and create a <code>GatewayController</code> class to handle incoming HTTP requests to the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/controllers/GatewayController.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.controllers</span>

<span class="k">import</span> <span class="nn">example.micronaut.clients.OrdersClient</span>
<span class="k">import</span> <span class="nn">example.micronaut.clients.UsersClient</span>
<span class="k">import</span> <span class="nn">example.micronaut.models.Item</span>
<span class="k">import</span> <span class="nn">example.micronaut.models.Order</span>
<span class="k">import</span> <span class="nn">example.micronaut.models.User</span>
<span class="k">import</span> <span class="nn">io.micronaut.core.annotation.NonNull</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.HttpStatus</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Body</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Get</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Post</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.exceptions.HttpStatusException</span>
<span class="k">import</span> <span class="nn">io.micronaut.scheduling.TaskExecutors</span>
<span class="k">import</span> <span class="nn">io.micronaut.scheduling.annotation.ExecuteOn</span>
<span class="k">import</span> <span class="nn">reactor.core.publisher.Flux</span>
<span class="k">import</span> <span class="nn">reactor.core.publisher.Mono</span>
<span class="k">import</span> <span class="nn">reactor.core.scheduler.Schedulers</span>
<span class="k">import</span> <span class="nn">jakarta.validation.Valid</span>

<span class="nd">@Controller</span><span class="p">(</span><span class="s">"/api"</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@ExecuteOn</span><span class="p">(</span><span class="nc">TaskExecutors</span><span class="p">.</span><span class="nc">BLOCKING</span><span class="p">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="kd">class</span> <span class="nc">GatewayController</span><span class="p">(</span><span class="n">ordersClient</span><span class="p">:</span> <span class="nc">OrdersClient</span><span class="p">,</span> <span class="n">usersClient</span><span class="p">:</span> <span class="nc">UsersClient</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">ordersClient</span><span class="p">:</span> <span class="nc">OrdersClient</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">userClient</span><span class="p">:</span> <span class="nc">UsersClient</span>

    <span class="nf">init</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">ordersClient</span> <span class="p">=</span> <span class="n">ordersClient</span>
        <span class="k">this</span><span class="p">.</span><span class="n">userClient</span> <span class="p">=</span> <span class="n">usersClient</span>
    <span class="p">}</span>


    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/users/{id}"</span><span class="p">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="k">fun</span> <span class="nf">getUserById</span><span class="p">(</span><span class="nd">@NonNull</span> <span class="n">id</span><span class="p">:</span> <span class="nc">Int</span><span class="p">):</span> <span class="nc">User</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">userClient</span><span class="p">.</span><span class="nf">getById</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/orders/{id}"</span><span class="p">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="k">fun</span> <span class="nf">getOrdersById</span><span class="p">(</span><span class="nd">@NonNull</span> <span class="n">id</span><span class="p">:</span> <span class="nc">Int</span><span class="p">):</span> <span class="nc">Order</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">order</span> <span class="p">=</span> <span class="n">ordersClient</span><span class="p">.</span><span class="nf">getOrderById</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>

        <span class="k">return</span> <span class="nc">Order</span><span class="p">(</span>
            <span class="n">order</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
            <span class="k">null</span><span class="p">,</span>
            <span class="nf">getUserById</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">userId</span><span class="o">!!</span><span class="p">),</span>
            <span class="n">order</span><span class="p">.</span><span class="n">items</span><span class="p">,</span>
            <span class="n">order</span><span class="p">.</span><span class="n">itemIds</span><span class="p">,</span>
            <span class="n">order</span><span class="p">.</span><span class="n">total</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/items/{id}"</span><span class="p">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="k">fun</span> <span class="nf">getItemsById</span><span class="p">(</span><span class="nd">@NonNull</span> <span class="n">id</span><span class="p">:</span> <span class="nc">Int</span><span class="p">):</span> <span class="nc">Item</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">ordersClient</span><span class="p">.</span><span class="nf">getItemsById</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/users"</span><span class="p">)</span> <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="k">fun</span> <span class="nf">getUsers</span><span class="p">():</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">User</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">userClient</span><span class="p">.</span><span class="n">users</span>
    <span class="p">}</span>

    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/items"</span><span class="p">)</span> <i class="conum" data-value="7"></i><b>(7)</b>
    <span class="k">fun</span> <span class="nf">getItems</span><span class="p">():</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Item</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">ordersClient</span><span class="p">.</span><span class="n">items</span>
    <span class="p">}</span>

    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/orders"</span><span class="p">)</span> <i class="conum" data-value="8"></i><b>(8)</b>
    <span class="k">fun</span> <span class="nf">getOrders</span><span class="p">():</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Order</span><span class="p">&gt;?</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">orders</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="nc">Order</span><span class="p">&gt;()</span>
        <span class="n">ordersClient</span><span class="p">.</span><span class="n">orders</span><span class="p">.</span><span class="nf">forEach</span><span class="p">{</span><span class="n">orders</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nc">Order</span><span class="p">(</span>
            <span class="n">it</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
            <span class="k">null</span><span class="p">,</span>
            <span class="nf">getUserById</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">userId</span><span class="o">!!</span><span class="p">),</span>
            <span class="n">it</span><span class="p">.</span><span class="n">items</span><span class="p">,</span>
            <span class="n">it</span><span class="p">.</span><span class="n">itemIds</span><span class="p">,</span>
            <span class="n">it</span><span class="p">.</span><span class="n">total</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">orders</span>
    <span class="p">}</span>

    <span class="nd">@Post</span><span class="p">(</span><span class="s">"/orders"</span><span class="p">)</span> <i class="conum" data-value="9"></i><b>(9)</b>
    <span class="k">fun</span> <span class="nf">createOrder</span><span class="p">(</span><span class="nd">@Body</span> <span class="n">order</span><span class="p">:</span> <span class="nd">@Valid</span> <span class="nc">Order</span><span class="p">):</span> <span class="nc">Order</span><span class="p">?</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="nf">getUserById</span><span class="p">(</span><span class="n">order</span><span class="o">!!</span><span class="p">.</span><span class="n">userId</span><span class="o">!!</span><span class="p">)</span>
            <span class="o">?:</span> <span class="k">throw</span>  <span class="nc">HttpStatusException</span><span class="p">(</span>
                <span class="nc">HttpStatus</span><span class="p">.</span><span class="nc">BAD_REQUEST</span><span class="p">,</span>
                <span class="nc">String</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="s">"User with id %s doesn't exist"</span><span class="p">,</span> <span class="n">order</span><span class="p">.</span><span class="n">userId</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="kd">val</span> <span class="py">createdOrder</span> <span class="p">=</span> <span class="n">ordersClient</span><span class="p">.</span><span class="nf">createOrder</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>

        <span class="k">return</span> <span class="nc">Order</span><span class="p">(</span>
            <span class="n">createdOrder</span><span class="o">!!</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
            <span class="k">null</span><span class="p">,</span>
            <span class="n">user</span><span class="p">,</span>
            <span class="n">createdOrder</span><span class="p">.</span><span class="n">items</span><span class="p">,</span>
            <span class="n">createdOrder</span><span class="p">.</span><span class="n">itemIds</span><span class="p">,</span>
            <span class="n">createdOrder</span><span class="p">.</span><span class="n">total</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Post</span><span class="p">(</span><span class="s">"/users"</span><span class="p">)</span> <i class="conum" data-value="10"></i><b>(10)</b>
    <span class="k">fun</span> <span class="nf">createUser</span><span class="p">(</span><span class="nd">@Body</span> <span class="nd">@NonNull</span> <span class="n">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">):</span> <span class="nc">User</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">userClient</span><span class="p">.</span><span class="nf">createUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/api</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It is critical that any blocking I/O operations (such as fetching the data from the database) are offloaded to a separate thread pool that does not block the Event loop.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getUserById</code> method to an HTTP GET request on <code>/users/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getOrdersById</code> method to an HTTP GET request on <code>/orders/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getItemsById</code> method to an HTTP GET request on <code>/items/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getUsers</code> method to an HTTP GET request on <code>/users</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getItems</code> method to an HTTP GET request on <code>/items</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getOrders</code> method to an HTTP GET request on <code>/orders</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation maps the <code>createUser</code> method to an HTTP POST request on <code>/users</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation maps the <code>createOrder</code> method to an HTTP POST request on <code>/orders</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>models</code> where you will put your data beans.</p>
</div>
<div class="paragraph">
<p>The previous <code>GatewayController</code> and <code>ItemsController</code> controller uses <code>User</code>, <code>Order</code> and <code>Item</code> to represent customer orders. Create the <code>User</code> class:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/models/User.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.models</span>

<span class="k">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonProperty</span>
<span class="k">import</span> <span class="nn">io.micronaut.core.annotation.Nullable</span>
<span class="k">import</span> <span class="nn">io.micronaut.serde.annotation.Serdeable</span>
<span class="k">import</span> <span class="nn">jakarta.validation.constraints.Max</span>
<span class="k">import</span> <span class="nn">jakarta.validation.constraints.NotBlank</span>

<span class="nd">@Serdeable</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">data class</span> <span class="nc">User</span><span class="p">(</span><span class="nd">@Nullable</span> <span class="nd">@Max</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span> <span class="kd">val</span> <span class="py">id</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <i class="conum" data-value="1"></i><b>(1)</b>
                <span class="nd">@NotBlank</span> <span class="nd">@JsonProperty</span><span class="p">(</span><span class="s">"first_name"</span><span class="p">)</span> <span class="kd">val</span> <span class="py">firstName</span><span class="p">:</span><span class="nc">String</span><span class="p">,</span>
                <span class="nd">@NotBlank</span> <span class="nd">@JsonProperty</span><span class="p">(</span><span class="s">"last_name"</span><span class="p">)</span>  <span class="kd">val</span> <span class="py">lastName</span><span class="p">:</span><span class="nc">String</span><span class="p">,</span>
                <span class="kd">val</span> <span class="py">username</span><span class="p">:</span><span class="nc">String</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the <code>Order</code> class:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/models/Order.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.models</span>

<span class="k">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonProperty</span>
<span class="k">import</span> <span class="nn">io.micronaut.core.annotation.Nullable</span>
<span class="k">import</span> <span class="nn">io.micronaut.serde.annotation.Serdeable</span>
<span class="k">import</span> <span class="nn">java.math.BigDecimal</span>
<span class="k">import</span> <span class="nn">jakarta.validation.constraints.Max</span>
<span class="k">import</span> <span class="nn">jakarta.validation.constraints.NotBlank</span>

<span class="nd">@Serdeable</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">data class</span> <span class="nc">Order</span> <span class="p">(</span>
    <span class="nd">@Nullable</span> <span class="nd">@Max</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span> <span class="kd">val</span> <span class="py">id</span><span class="p">:</span><span class="nc">Int</span><span class="p">,</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nd">@NotBlank</span> <span class="nd">@Nullable</span> <span class="nd">@JsonProperty</span><span class="p">(</span><span class="s">"user_id"</span><span class="p">)</span> <span class="kd">val</span> <span class="py">userId</span><span class="p">:</span><span class="nc">Int</span><span class="p">?,</span>
    <span class="nd">@Nullable</span> <span class="kd">val</span> <span class="py">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">?,</span>
    <span class="kd">val</span> <span class="py">items</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Item</span><span class="p">&gt;?,</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nd">@NotBlank</span> <span class="nd">@JsonProperty</span><span class="p">(</span><span class="s">"item_ids"</span><span class="p">)</span> <span class="kd">val</span> <span class="py">itemIds</span><span class="p">:</span><span class="nc">List</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;?,</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="kd">val</span> <span class="py">total</span><span class="p">:</span> <span class="nc">BigDecimal</span><span class="p">?)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the <code>Item</code> class:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/models/Item.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.models</span>

<span class="k">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonProperty</span>
<span class="k">import</span> <span class="nn">io.micronaut.serde.annotation.Serdeable</span>
<span class="k">import</span> <span class="nn">java.math.BigDecimal</span>

<span class="nd">@Serdeable</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">data class</span> <span class="nc">Item</span> <span class="p">(</span>
    <span class="kd">val</span> <span class="py">id</span><span class="p">:</span><span class="nc">Int</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">name</span><span class="p">:</span><span class="nc">String</span><span class="p">,</span>
    <span class="kd">val</span> <span class="py">price</span><span class="p">:</span> <span class="nc">BigDecimal</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="py">items</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Item</span><span class="p">&gt;</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span>
            <span class="nc">Item</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"Banana"</span><span class="p">,</span> <span class="nc">BigDecimal</span><span class="p">(</span><span class="s">"1.5"</span><span class="p">)),</span>
            <span class="nc">Item</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">"Kiwi"</span><span class="p">,</span> <span class="nc">BigDecimal</span><span class="p">(</span><span class="s">"2.5"</span><span class="p">)),</span>
            <span class="nc">Item</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">"Grape"</span><span class="p">,</span> <span class="nc">BigDecimal</span><span class="p">(</span><span class="s">"1.25"</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a package named <code>clients</code> where you will put the HTTP Clients to call the <code>users</code> and <code>orders</code> microservices.</p>
</div>
<div class="paragraph">
<p>Create a <code>UsersClient</code> for the <code>users</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/clients/UsersClient.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.clients</span>

<span class="k">import</span> <span class="nn">example.micronaut.models.User</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Body</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Get</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Post</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.annotation.Client</span>
<span class="k">import</span> <span class="nn">reactor.core.publisher.Flux</span>
<span class="k">import</span> <span class="nn">reactor.core.publisher.Mono</span>

<span class="nd">@Client</span><span class="p">(</span><span class="s">"users"</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">interface</span> <span class="nc">UsersClient</span> <span class="p">{</span>
    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/users/{id}"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">getById</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nc">Int</span><span class="p">):</span> <span class="nc">User</span>

    <span class="nd">@Post</span><span class="p">(</span><span class="s">"/users"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">createUser</span><span class="p">(</span><span class="nd">@Body</span> <span class="n">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">?):</span> <span class="nc">User</span>

    <span class="err">@</span><span class="k">get</span><span class="p">:</span><span class="nc">Get</span><span class="p">(</span><span class="s">"/users"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">users</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">User</span><span class="p">&gt;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create an <code>OrdersClient</code> for the <code>orders</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/clients/OrdersClient.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.clients</span>

<span class="k">import</span> <span class="nn">example.micronaut.models.Item</span>
<span class="k">import</span> <span class="nn">example.micronaut.models.Order</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Body</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Get</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Post</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.annotation.Client</span>
<span class="k">import</span> <span class="nn">reactor.core.publisher.Flux</span>
<span class="k">import</span> <span class="nn">reactor.core.publisher.Mono</span>

<span class="nd">@Client</span><span class="p">(</span><span class="s">"orders"</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">interface</span> <span class="nc">OrdersClient</span> <span class="p">{</span>
    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/orders/{id}"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">getOrderById</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nc">Int</span><span class="p">):</span> <span class="nc">Order</span>

    <span class="nd">@Post</span><span class="p">(</span><span class="s">"/orders"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">createOrder</span><span class="p">(</span><span class="nd">@Body</span> <span class="n">order</span><span class="p">:</span> <span class="nc">Order</span><span class="p">?):</span> <span class="nc">Order</span>

    <span class="err">@</span><span class="k">get</span><span class="p">:</span><span class="nc">Get</span><span class="p">(</span><span class="s">"/orders"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">orders</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Order</span><span class="p">&gt;</span>

    <span class="err">@</span><span class="k">get</span><span class="p">:</span><span class="nc">Get</span><span class="p">(</span><span class="s">"/items"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">items</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Item</span><span class="p">&gt;</span>

    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/items/{id}"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">getItemsById</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nc">Int</span><span class="p">):</span> <span class="nc">Item</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a package named <code>auth</code> where we will check basic authentication credentials.</p>
</div>
<div class="paragraph">
<p>Create a <code>Credentials</code> class that will load the username and password from configuration that will be needed for comparison.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/auth/Credentials.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.auth</span>

<span class="k">import</span> <span class="nn">io.micronaut.context.annotation.ConfigurationProperties</span>

<span class="nd">@ConfigurationProperties</span><span class="p">(</span><span class="s">"authentication-credentials"</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">Credentials</span><span class="p">{</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">username</span><span class="p">:</span> <span class="nc">String</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">password</span><span class="p">:</span> <span class="nc">String</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@ConfigurationProperties</code> annotation takes the configuration prefix.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create an <code>AuthClientFilter</code> class that is a client filter applied to every client. It adds basic authentication header with credentials that are stored in the <code>Credentials</code> class.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/auth/AuthClientFilter.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut.auth</span>

<span class="k">import</span> <span class="nn">io.micronaut.http.HttpResponse</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.MutableHttpRequest</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Filter</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.filter.ClientFilterChain</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.filter.HttpClientFilter</span>
<span class="k">import</span> <span class="nn">org.reactivestreams.Publisher</span>

<span class="nd">@Filter</span><span class="p">(</span><span class="nc">Filter</span><span class="p">.</span><span class="nc">MATCH_ALL_PATTERN</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">AuthClientFilter</span><span class="p">(</span><span class="n">credentials</span><span class="p">:</span> <span class="nc">Credentials</span><span class="p">)</span> <span class="p">:</span> <span class="nc">HttpClientFilter</span> <span class="p">{</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">credentials</span><span class="p">:</span> <span class="nc">Credentials</span>

    <span class="nf">init</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">credentials</span> <span class="p">=</span> <span class="n">credentials</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">doFilter</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="nc">MutableHttpRequest</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;,</span> <span class="n">chain</span><span class="p">:</span> <span class="nc">ClientFilterChain</span><span class="p">):</span> <span class="nc">Publisher</span><span class="p">&lt;</span><span class="k">out</span> <span class="nc">HttpResponse</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;?&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">chain</span><span class="p">.</span><span class="nf">proceed</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="nf">basicAuth</span><span class="p">(</span><span class="n">credentials</span><span class="p">.</span><span class="n">username</span><span class="p">,</span> <span class="n">credentials</span><span class="p">.</span><span class="n">password</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a class named <code>ErrorExceptionHandler</code> in the <code>example.micronaut</code> package. <code>ErrorExceptionHandler</code> will propagate errors from the <code>orders</code> and <code>users</code> microservices.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/ErrorExceptionHandler.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut</span>

<span class="k">import</span> <span class="nn">io.micronaut.http.HttpRequest</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.HttpResponse</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.exceptions.HttpClientResponseException</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.server.exceptions.ExceptionHandler</span>
<span class="k">import</span> <span class="nn">jakarta.inject.Singleton</span>

<span class="nd">@Singleton</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">ErrorExceptionHandler</span> <span class="p">:</span>
    <span class="nc">ExceptionHandler</span><span class="p">&lt;</span><span class="nc">HttpClientResponseException</span><span class="p">,</span> <span class="nc">HttpResponse</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">handle</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="nc">HttpRequest</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;?,</span> <span class="n">exception</span><span class="p">:</span> <span class="nc">HttpClientResponseException</span><span class="p">):</span> <span class="nc">HttpResponse</span><span class="p">&lt;</span><span class="err">*</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">HttpResponse</span><span class="p">.</span><span class="n">status</span><span class="p">&lt;</span><span class="nc">Any</span><span class="p">&gt;(</span><span class="n">exception</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="nf">status</span><span class="p">()).</span><span class="nf">body</span><span class="p">(</span>
            <span class="n">exception</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="nf">getBody</span><span class="p">(</span>
                <span class="nc">String</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span>
            <span class="p">).</span><span class="nf">orElse</span><span class="p">(</span><span class="k">null</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><br></p>
</div>
<div class="sect3">
<h4 id="write-tests-to-verify-application-logic-3">4.3.1. Write tests to verify application logic</h4>
<div class="paragraph">
<p>Create a <code>GatewayClient</code>, a declarative Micronaut HTTP Client for testing:</p>
</div>
<div class="listingblock">
<div class="title">api/src/test/kotlin/example/micronaut/GatewayClient.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut</span>

<span class="k">import</span> <span class="nn">example.micronaut.models.Item</span>
<span class="k">import</span> <span class="nn">example.micronaut.models.Order</span>
<span class="k">import</span> <span class="nn">example.micronaut.models.User</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Body</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Get</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.annotation.Post</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.annotation.Client</span>

<span class="nd">@Client</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">interface</span> <span class="nc">GatewayClient</span> <span class="p">{</span>
    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/api/items/{id}"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">getItemById</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nc">Int</span><span class="p">?):</span> <span class="nc">Item</span><span class="p">?</span>

    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/api/orders/{id}"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">getOrderById</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nc">Int</span><span class="p">?):</span> <span class="nc">Order</span><span class="p">?</span>

    <span class="nd">@Get</span><span class="p">(</span><span class="s">"/api/users/{id}"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">getUsersById</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="nc">Int</span><span class="p">?):</span> <span class="nc">User</span><span class="p">?</span>

    <span class="err">@</span><span class="k">get</span><span class="p">:</span><span class="nc">Get</span><span class="p">(</span><span class="s">"/api/users"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">users</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">User</span><span class="p">&gt;</span>

    <span class="err">@</span><span class="k">get</span><span class="p">:</span><span class="nc">Get</span><span class="p">(</span><span class="s">"/api/items"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">items</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Item</span><span class="p">&gt;</span>

    <span class="err">@</span><span class="k">get</span><span class="p">:</span><span class="nc">Get</span><span class="p">(</span><span class="s">"/api/orders"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">orders</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Order</span><span class="p">&gt;</span>

    <span class="nd">@Post</span><span class="p">(</span><span class="s">"/api/orders"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">createOrder</span><span class="p">(</span><span class="nd">@Body</span> <span class="n">order</span><span class="p">:</span> <span class="nc">Order</span><span class="p">):</span> <span class="nc">Order</span>

    <span class="nd">@Post</span><span class="p">(</span><span class="s">"/api/users"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">createUser</span><span class="p">(</span><span class="nd">@Body</span> <span class="n">user</span><span class="p">:</span> <span class="nc">User</span><span class="p">):</span> <span class="nc">User</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>HealthTest</code> checks that there is <code>/health</code> endpoint that is required for service discovery.</p>
</div>
<div class="listingblock">
<div class="title">api/src/test/kotlin/example/micronaut/HealthTest.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut</span>

<span class="k">import</span> <span class="nn">io.micronaut.http.HttpRequest</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.HttpStatus</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.HttpClient</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.annotation.Client</span>
<span class="k">import</span> <span class="nn">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span>
<span class="k">import</span> <span class="nn">jakarta.inject.Inject</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertEquals</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Test</span>

<span class="nd">@MicronautTest</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">HealthTest</span> <span class="p">{</span>

    <span class="nd">@Inject</span>
    <span class="err">@</span><span class="n">field</span><span class="p">:</span><span class="nc">Client</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">client</span><span class="p">:</span> <span class="nc">HttpClient</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">healthEndpointExposed</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">status</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">toBlocking</span><span class="p">().</span><span class="nf">retrieve</span><span class="p">(</span>
            <span class="nc">HttpRequest</span><span class="p">.</span><span class="nc">GET</span><span class="p">&lt;</span><span class="nc">Any</span><span class="p">&gt;(</span><span class="s">"/health"</span><span class="p">),</span>
            <span class="nc">HttpStatus</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span>
        <span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">HttpStatus</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject the <code>HttpClient</code> bean and point it to the embedded server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>GatewayControllerTest</code> tests endpoints inside the <code>GatewayController</code>.</p>
</div>
<div class="listingblock">
<div class="title">api/src/test/kotlin/example/micronaut/GatewayControllerTest.kt</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">package</span> <span class="nn">example.micronaut</span>

<span class="k">import</span> <span class="nn">example.micronaut.clients.OrdersClient</span>
<span class="k">import</span> <span class="nn">example.micronaut.clients.UsersClient</span>
<span class="k">import</span> <span class="nn">example.micronaut.models.Item</span>
<span class="k">import</span> <span class="nn">example.micronaut.models.Order</span>
<span class="k">import</span> <span class="nn">example.micronaut.models.User</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.HttpResponse</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.HttpStatus</span>
<span class="k">import</span> <span class="nn">io.micronaut.http.client.exceptions.HttpClientResponseException</span>
<span class="k">import</span> <span class="nn">io.micronaut.test.annotation.MockBean</span>
<span class="k">import</span> <span class="nn">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span>
<span class="k">import</span> <span class="nn">jakarta.inject.Inject</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertEquals</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertNotNull</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertNull</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertThrows</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Assertions.assertTrue</span>
<span class="k">import</span> <span class="nn">org.junit.jupiter.api.Test</span>
<span class="k">import</span> <span class="nn">org.mockito.ArgumentMatchers.any</span>
<span class="k">import</span> <span class="nn">org.mockito.Mockito.mock</span>
<span class="k">import</span> <span class="nn">org.mockito.Mockito.`when`</span>
<span class="k">import</span> <span class="nn">java.math.BigDecimal</span>

<span class="nd">@MicronautTest</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">GatewayControllerTest</span> <span class="p">{</span>
    <span class="nd">@Inject</span>
    <span class="kd">var</span> <span class="py">ordersClient</span><span class="p">:</span> <span class="nc">OrdersClient</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="nd">@Inject</span>
    <span class="kd">var</span> <span class="py">usersClient</span><span class="p">:</span> <span class="nc">UsersClient</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="nd">@Inject</span>
    <span class="kd">var</span> <span class="py">gatewayClient</span><span class="p">:</span> <span class="nc">GatewayClient</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="nd">@MockBean</span><span class="p">(</span><span class="nc">OrdersClient</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">ordersClient</span><span class="p">():</span> <span class="nc">OrdersClient</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">mock</span><span class="p">(</span><span class="nc">OrdersClient</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@MockBean</span><span class="p">(</span><span class="nc">UsersClient</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">usersClient</span><span class="p">():</span> <span class="nc">UsersClient</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">mock</span><span class="p">(</span><span class="nc">UsersClient</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">itemById</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">itemId</span> <span class="p">=</span> <span class="mi">1</span>
        <span class="kd">val</span> <span class="py">item</span> <span class="p">=</span> <span class="nc">Item</span><span class="p">(</span><span class="n">itemId</span><span class="p">,</span> <span class="s">"test"</span><span class="p">,</span> <span class="nc">BigDecimal</span><span class="p">.</span><span class="nc">ONE</span><span class="p">)</span>
        <span class="nf">`when`</span><span class="p">(</span><span class="n">ordersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getItemsById</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nf">thenReturn</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">retrievedItem</span> <span class="p">=</span> <span class="n">gatewayClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getItemById</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">retrievedItem</span><span class="o">!!</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">retrievedItem</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">price</span><span class="p">,</span> <span class="n">retrievedItem</span><span class="p">.</span><span class="n">price</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">orderById</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">order</span> <span class="p">=</span> <span class="nc">Order</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nc">ArrayList</span><span class="p">(),</span> <span class="k">null</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="nc">User</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">userId</span><span class="o">!!</span><span class="p">,</span> <span class="s">"firstName"</span><span class="p">,</span> <span class="s">"lastName"</span><span class="p">,</span> <span class="s">"test"</span><span class="p">)</span>
        <span class="nf">`when`</span><span class="p">(</span><span class="n">ordersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getOrderById</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nf">thenReturn</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="nf">`when`</span><span class="p">(</span><span class="n">usersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getById</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">)).</span><span class="nf">thenReturn</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">retrievedOrder</span> <span class="p">=</span> <span class="n">gatewayClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getOrderById</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">retrievedOrder</span><span class="o">!!</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">userId</span><span class="p">,</span> <span class="n">retrievedOrder</span><span class="p">.</span><span class="n">user</span><span class="o">!!</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertNull</span><span class="p">(</span><span class="n">retrievedOrder</span><span class="p">.</span><span class="n">userId</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">username</span><span class="p">,</span> <span class="n">retrievedOrder</span><span class="p">.</span><span class="n">user</span><span class="o">!!</span><span class="p">.</span><span class="n">username</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">userById</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="nc">User</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"firstName"</span><span class="p">,</span> <span class="s">"lastName"</span><span class="p">,</span> <span class="s">"test"</span><span class="p">)</span>
        <span class="nf">`when`</span><span class="p">(</span><span class="n">usersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getById</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="nf">thenReturn</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">retrievedUser</span> <span class="p">=</span> <span class="n">gatewayClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getUsersById</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">retrievedUser</span><span class="o">!!</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">username</span><span class="p">,</span> <span class="n">retrievedUser</span><span class="p">.</span><span class="n">username</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">users</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="nc">User</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"firstName"</span><span class="p">,</span> <span class="s">"lastName"</span><span class="p">,</span> <span class="s">"test"</span><span class="p">)</span>
        <span class="nf">`when`</span><span class="p">(</span><span class="n">usersClient</span><span class="o">!!</span><span class="p">.</span><span class="n">users</span><span class="p">).</span><span class="nf">thenReturn</span><span class="p">(</span><span class="nf">listOf</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
        <span class="kd">val</span> <span class="py">users</span> <span class="p">=</span> <span class="n">gatewayClient</span><span class="o">!!</span><span class="p">.</span><span class="n">users</span>
        <span class="nf">assertNotNull</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">users</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">username</span><span class="p">,</span> <span class="n">users</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">username</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">items</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">item</span> <span class="p">=</span> <span class="nc">Item</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"test"</span><span class="p">,</span> <span class="nc">BigDecimal</span><span class="p">.</span><span class="nc">ONE</span><span class="p">)</span>
        <span class="nf">`when`</span><span class="p">(</span><span class="n">ordersClient</span><span class="o">!!</span><span class="p">.</span><span class="n">items</span><span class="p">).</span><span class="nf">thenReturn</span><span class="p">(</span><span class="nf">listOf</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="kd">val</span> <span class="py">items</span> <span class="p">=</span> <span class="n">gatewayClient</span><span class="o">!!</span><span class="p">.</span><span class="n">items</span>
        <span class="nf">assertNotNull</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">items</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">price</span><span class="p">,</span> <span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">price</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">orders</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">order</span> <span class="p">=</span> <span class="nc">Order</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nc">ArrayList</span><span class="p">(),</span> <span class="k">null</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="nc">User</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">userId</span><span class="o">!!</span><span class="p">,</span> <span class="s">"firstName"</span><span class="p">,</span> <span class="s">"lastName"</span><span class="p">,</span> <span class="s">"test"</span><span class="p">)</span>
        <span class="nf">`when`</span><span class="p">(</span><span class="n">ordersClient</span><span class="o">!!</span><span class="p">.</span><span class="n">orders</span><span class="p">).</span><span class="nf">thenReturn</span><span class="p">(</span><span class="nf">listOf</span><span class="p">(</span><span class="n">order</span><span class="p">))</span>
        <span class="nf">`when`</span><span class="p">(</span><span class="n">usersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getById</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">userId</span><span class="o">!!</span><span class="p">)).</span><span class="nf">thenReturn</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">orders</span> <span class="p">=</span> <span class="n">gatewayClient</span><span class="o">!!</span><span class="p">.</span><span class="n">orders</span>
        <span class="nf">assertNotNull</span><span class="p">(</span><span class="n">orders</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">orders</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
        <span class="nf">assertNull</span><span class="p">(</span><span class="n">orders</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">userId</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">orders</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">user</span><span class="o">!!</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">orders</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">username</span><span class="p">,</span> <span class="n">orders</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">user</span><span class="o">!!</span><span class="p">.</span><span class="n">username</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">createUser</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">firstName</span> <span class="p">=</span> <span class="s">"firstName"</span>
        <span class="kd">val</span> <span class="py">lastName</span> <span class="p">=</span> <span class="s">"lastName"</span>
        <span class="kd">val</span> <span class="py">username</span> <span class="p">=</span> <span class="s">"username"</span>
        <span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="nc">User</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">firstName</span><span class="p">,</span> <span class="n">lastName</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
        <span class="nf">`when`</span><span class="p">(</span><span class="n">usersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">createUser</span><span class="p">(</span><span class="n">user</span><span class="p">)).</span><span class="nf">thenReturn</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">createdUser</span> <span class="p">=</span> <span class="n">gatewayClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">createUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">firstName</span><span class="p">,</span> <span class="n">createdUser</span><span class="p">.</span><span class="n">firstName</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">lastName</span><span class="p">,</span> <span class="n">createdUser</span><span class="p">.</span><span class="n">lastName</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">createdUser</span><span class="p">.</span><span class="n">username</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">createOrder</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">order</span> <span class="p">=</span> <span class="nc">Order</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="nc">User</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">userId</span><span class="o">!!</span><span class="p">,</span> <span class="s">"firstName"</span><span class="p">,</span> <span class="s">"lastName"</span><span class="p">,</span> <span class="s">"test"</span><span class="p">)</span>
        <span class="nf">`when`</span><span class="p">(</span><span class="n">usersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getById</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">)).</span><span class="nf">thenReturn</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="nf">`when`</span><span class="p">(</span><span class="n">ordersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">createOrder</span><span class="p">(</span><span class="n">order</span><span class="p">)).</span><span class="nf">thenReturn</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">createdOrder</span> <span class="p">=</span> <span class="n">gatewayClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">createOrder</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">createdOrder</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertNull</span><span class="p">(</span><span class="n">createdOrder</span><span class="p">.</span><span class="n">userId</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">userId</span><span class="p">,</span> <span class="n">createdOrder</span><span class="p">.</span><span class="n">user</span><span class="o">!!</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">username</span><span class="p">,</span> <span class="n">createdOrder</span><span class="p">.</span><span class="n">user</span><span class="o">!!</span><span class="p">.</span><span class="n">username</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">createOrderUserDoesntExists</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">order</span> <span class="p">=</span> <span class="nc">Order</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="nc">BigDecimal</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="nf">`when`</span><span class="p">(</span><span class="n">ordersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">createOrder</span><span class="p">(</span><span class="n">order</span><span class="p">)).</span><span class="nf">thenReturn</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="nf">`when`</span><span class="p">(</span><span class="n">usersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">getById</span><span class="p">(</span><span class="n">order</span><span class="p">.</span><span class="n">userId</span><span class="o">!!</span><span class="p">)).</span><span class="nf">thenReturn</span><span class="p">(</span><span class="k">null</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">exception</span> <span class="p">=</span> <span class="nf">assertThrows</span><span class="p">(</span>
            <span class="nc">HttpClientResponseException</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span>
        <span class="p">)</span> <span class="p">{</span> <span class="n">gatewayClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">createOrder</span><span class="p">(</span><span class="n">order</span><span class="p">)</span> <span class="p">}</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="nc">HttpStatus</span><span class="p">.</span><span class="nc">BAD_REQUEST</span><span class="p">)</span>
        <span class="nf">assertTrue</span><span class="p">(</span>
            <span class="n">exception</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="nf">getBody</span><span class="p">(</span><span class="nc">String</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">).</span><span class="nf">orElse</span><span class="p">(</span><span class="s">""</span><span class="p">).</span><span class="nf">contains</span><span class="p">(</span><span class="s">"User with id 2 doesn't exist"</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">exceptionHandler</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="nc">User</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">"firstname"</span><span class="p">,</span> <span class="s">"lastname"</span><span class="p">,</span> <span class="s">"username"</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">message</span> <span class="p">=</span> <span class="s">"Test error message"</span>
        <span class="nf">`when`</span><span class="p">(</span><span class="n">usersClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">createUser</span><span class="p">(</span><span class="n">user</span><span class="p">)).</span><span class="nf">thenThrow</span><span class="p">(</span>
            <span class="nc">HttpClientResponseException</span><span class="p">(</span>
                <span class="s">"Test"</span><span class="p">,</span>
                <span class="nc">HttpResponse</span><span class="p">.</span><span class="nf">badRequest</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="kd">val</span> <span class="py">exception</span> <span class="p">=</span> <span class="nf">assertThrows</span><span class="p">(</span>
            <span class="nc">HttpClientResponseException</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span>
        <span class="p">)</span> <span class="p">{</span> <span class="n">gatewayClient</span><span class="o">!!</span><span class="p">.</span><span class="nf">createUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="nc">HttpStatus</span><span class="p">.</span><span class="nc">BAD_REQUEST</span><span class="p">)</span>
        <span class="nf">assertTrue</span><span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="nf">getBody</span><span class="p">(</span><span class="nc">String</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">).</span><span class="nf">orElse</span><span class="p">(</span><span class="s">""</span><span class="p">).</span><span class="nf">contains</span><span class="p">(</span><span class="s">"Test error message"</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit <em>application.yml</em></p>
</div>
<div class="listingblock">
<div class="title">api/src/main/resources/application.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">micronaut</span><span class="pi">:</span>
  <span class="na">application</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">api</span>
<span class="na">authentication-credentials</span><span class="pi">:</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s">${username}</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="na">password</span><span class="pi">:</span> <span class="s">${password}</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Placeholder for username that will be populated by Kubernetes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Placeholder for password that will be populated by Kubernetes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit the <em>bootstrap.yml</em> file in the <em>resources</em> directory to <a href="https://docs.micronaut.io/latest/guide/#bootstrap">enable distributed configuration</a> so it looks like the following:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/resources/bootstrap.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">micronaut</span><span class="pi">:</span>
  <span class="na">application</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">api</span>
  <span class="na">config-client</span><span class="pi">:</span>
    <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="na">kubernetes</span><span class="pi">:</span>
  <span class="na">client</span><span class="pi">:</span>
    <span class="na">secrets</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span> <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="na">use-api</span><span class="pi">:</span> <span class="no">true</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>microanut.config-client.enabled: true</code> to read and resolve configuration from distributed sources.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set <code>kubernetes.client.secrets.enabled: true</code> to enable Kubernetes secrets as a distributed source.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set <code>kubernetes.client.secrets.use-api: true</code> to use the  Kubernetes API to fetch configuration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/application-dev.yml</code>. The Micronaut framework applies this configuration file only for the <code>dev</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/resources/application-dev.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">authentication-credentials</span><span class="pi">:</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s2">"</span><span class="s">test_username"</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">test_password"</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hardcoded username for development environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded password for development environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>bootstrap-dev.yml</em> to disable distributed configuration in the dev environment:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/resources/bootstrap-dev.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">micronaut</span><span class="pi">:</span>
  <span class="na">http</span><span class="pi">:</span>
    <span class="na">services</span><span class="pi">:</span>
      <span class="na">users</span><span class="pi">:</span>
        <span class="na">urls</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">http://localhost:8081</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="na">orders</span><span class="pi">:</span>
        <span class="na">urls</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">http://localhost:8082</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="na">kubernetes</span><span class="pi">:</span>
  <span class="na">client</span><span class="pi">:</span>
    <span class="na">secrets</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="no">false</span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>URL of the <code>users</code> microservice</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>URL of the <code>orders</code> microservice</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Disable Kubernetes secrets client.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>application-test.yml</em> to be used in the test environment:</p>
</div>
<div class="listingblock">
<div class="title">api/src/test/resources/application-test.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">authentication-credentials</span><span class="pi">:</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s2">"</span><span class="s">test_username"</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">test_password"</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hardcoded username for development environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded password for development environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the unit test:</p>
</div>
<div class="listingblock">
<div class="title">api</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">./mvnw <span class="nb">test</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><br></p>
</div>
</div>
<div class="sect3">
<h4 id="running-the-application-3">4.3.2. Running the application</h4>
<div class="paragraph">
<p>Run <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">api</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">MICRONAUT_ENVIRONMENTS</span><span class="o">=</span>dev ./mvnw mn:run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code>14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="test-integration-between-applications">4.4. Test integration between applications</h3>
<div class="paragraph">
<p>Store the URL of the <code>api</code> microservice in the <code>API_URL</code> environment variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">export </span><span class="nv">API_URL</span><span class="o">=</span>http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run a cURL command to create a new user via the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl <span class="nt">-X</span> <span class="s2">"POST"</span> <span class="s2">"</span><span class="nv">$API_URL</span><span class="s2">/api/users"</span> <span class="nt">-H</span> <span class="s1">'Content-Type: application/json; charset=utf-8'</span> <span class="nt">-d</span> <span class="s1">'{ "first_name": "Nemanja", "last_name": "Mikic", "username": "nmikic" }'</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"username"</span><span class="p">:</span><span class="s2">"nmikic"</span><span class="p">,</span><span class="nl">"first_name"</span><span class="p">:</span><span class="s2">"Nemanja"</span><span class="p">,</span><span class="nl">"last_name"</span><span class="p">:</span><span class="s2">"Mikic"</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Run a cURL command to a new order via the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl <span class="nt">-X</span> <span class="s2">"POST"</span> <span class="s2">"</span><span class="nv">$API_URL</span><span class="s2">/api/orders"</span> <span class="nt">-H</span> <span class="s1">'Content-Type: application/json; charset=utf-8'</span> <span class="nt">-d</span> <span class="s1">'{ "user_id": 1, "item_ids": [1,2] }'</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"user"</span><span class="p">:{</span><span class="nl">"first_name"</span><span class="p">:</span><span class="s2">"Nemanja"</span><span class="p">,</span><span class="nl">"last_name"</span><span class="p">:</span><span class="s2">"Mikic"</span><span class="p">,</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"username"</span><span class="p">:</span><span class="s2">"nmikic"</span><span class="p">},</span><span class="nl">"items"</span><span class="p">:[{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Banana"</span><span class="p">,</span><span class="nl">"price"</span><span class="p">:</span><span class="mf">1.5</span><span class="p">},{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Kiwi"</span><span class="p">,</span><span class="nl">"price"</span><span class="p">:</span><span class="mf">2.5</span><span class="p">}],</span><span class="nl">"total"</span><span class="p">:</span><span class="mf">4.0</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Run a cURL command to list created orders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl <span class="s2">"</span><span class="nv">$API_URL</span><span class="s2">/api/orders"</span> <span class="nt">-H</span> <span class="s1">'Content-Type: application/json; charset=utf-8'</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">[{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"user"</span><span class="p">:{</span><span class="nl">"first_name"</span><span class="p">:</span><span class="s2">"Nemanja"</span><span class="p">,</span><span class="nl">"last_name"</span><span class="p">:</span><span class="s2">"Mikic"</span><span class="p">,</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"username"</span><span class="p">:</span><span class="s2">"nmikic"</span><span class="p">},</span><span class="nl">"items"</span><span class="p">:[{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Banana"</span><span class="p">,</span><span class="nl">"price"</span><span class="p">:</span><span class="mf">1.5</span><span class="p">},{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Kiwi"</span><span class="p">,</span><span class="nl">"price"</span><span class="p">:</span><span class="mf">2.5</span><span class="p">}],</span><span class="nl">"total"</span><span class="p">:</span><span class="mf">4.0</span><span class="p">}]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can try to place an order for a user who doesn&#8217;t exist (with id 100). Run a cURL command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl <span class="nt">-X</span> <span class="s2">"POST"</span> <span class="s2">"</span><span class="nv">$API_URL</span><span class="s2">/api/orders"</span> <span class="nt">-H</span> <span class="s1">'Content-Type: application/json; charset=utf-8'</span> <span class="nt">-d</span> <span class="s1">'{ "user_id": 100, "item_ids": [1,2] }'</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="nl">"message"</span><span class="p">:</span><span class="s2">"Bad Request"</span><span class="p">,</span><span class="nl">"_links"</span><span class="p">:{</span><span class="nl">"self"</span><span class="p">:[{</span><span class="nl">"href"</span><span class="p">:</span><span class="s2">"/api/orders"</span><span class="p">,</span><span class="nl">"templated"</span><span class="p">:</span><span class="kc">false</span><span class="p">}]},</span><span class="nl">"_embedded"</span><span class="p">:{</span><span class="nl">"errors"</span><span class="p">:[{</span><span class="nl">"message"</span><span class="p">:</span><span class="s2">"User with id 100 doesn't exist"</span><span class="p">}]}}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kubernetes-and-the-micronaut-framework">5. Kubernetes and the Micronaut framework</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we will first create the necessary Kubernetes resources for our microservices that will make them work properly then we will configure build container images and deploy each of the microservices that we created on the local Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>Create a file named <em>auth.yml</em>  that will service role for microservices that have secret configurations.</p>
</div>
<div class="listingblock">
<div class="title">auth.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Namespace</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">micronaut-k8s</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">micronaut-k8s</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">micronaut-service</span>
<span class="nn">---</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">micronaut-k8s</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">micronaut_service_role</span>
<span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">services"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">endpoints"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">configmaps"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">secrets"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">pods"</span><span class="pi">]</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">]</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">RoleBinding</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">micronaut-k8s</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">micronaut_service_role_bind</span>
<span class="na">subjects</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">micronaut-service</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">Role</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">micronaut_service_role</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Secret</span> <i class="conum" data-value="5"></i><b>(5)</b>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">micronaut-k8s</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">mysecret</span>
<span class="na">type</span><span class="pi">:</span> <span class="s">Opaque</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s">YWRtaW4=</span> <i class="conum" data-value="6"></i><b>(6)</b>
  <span class="na">password</span><span class="pi">:</span> <span class="s">bWljcm9uYXV0aXNhd2Vzb21l</span> <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We create a namespace named <code>micronaut-k8s</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We create a service account named <code>micronaut-service</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We create a role named <code>micronaut_service_role</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We bind  the <code>micronaut_service_role</code> role to the <code>micronaut-service</code> service account.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We create a secret named <code>mysecret</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Base64 value of the username secret that will be used by the microservices.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Base64 value of the password secret that will be used by the microservices.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the next command to create the resources described above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl apply <span class="nt">-f</span> auth.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before we start deploying each service, ensure that Docker daemon is configured to use Kubernetes.
If you are using <a href="https://minikube.sigs.k8s.io/">Minikube</a> run the next command to switch the docker daemon to use Minikube.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">eval</span> <span class="si">$(</span>minikube docker-env<span class="si">)</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="users-microservice-2">5.1. Users Microservice</h3>
<div class="paragraph">
<p><a href="https://guides.micronaut.io/latest/micronaut-docker-image.html">Build a docker image</a> of the <code>users</code> service with the name <code>users</code>.</p>
</div>
<div class="paragraph">
<p>Edit the file named <em>k8s.yml</em> inside the <code>users</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">/users/k8s.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">micronaut-k8s</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">users"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s2">"</span><span class="s">users"</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s2">"</span><span class="s">users"</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">micronaut-service</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">users"</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">users</span> <i class="conum" data-value="2"></i><b>(2)</b>
          <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">Never</span> <i class="conum" data-value="3"></i><b>(3)</b>
          <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
              <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
          <span class="na">readinessProbe</span><span class="pi">:</span>
            <span class="na">httpGet</span><span class="pi">:</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">/health/readiness</span>
              <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
            <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">5</span>
            <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">3</span>
          <span class="na">livenessProbe</span><span class="pi">:</span>
            <span class="na">httpGet</span><span class="pi">:</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">/health/liveness</span>
              <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
            <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">5</span>
            <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">3</span>
            <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">10</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">micronaut-k8s</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">users"</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s2">"</span><span class="s">users"</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s2">"</span><span class="s">TCP"</span>
      <span class="na">port</span><span class="pi">:</span> <span class="s">8080</span>  <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The service name that we created in the <em>auth.yml</em> file.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The name of the container image for deployment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The imagePullPolicy is set to Never. We will always use local one that we built in previous step.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Name of a service, required for service discovery.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Micronaut default port on which application is running.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the next command to create the resources described above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl apply <span class="nt">-f</span> <span class="nb">users</span>/k8s.yml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">deployment.apps/users created
service/users created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="orders-microservice-2">5.2. Orders Microservice</h3>
<div class="paragraph">
<p><a href="https://guides.micronaut.io/latest/micronaut-docker-image.html">Build a docker image</a> of the <code>orders</code> service with the name <code>orders</code>.</p>
</div>
<div class="paragraph">
<p>Edit the file named <em>k8s.yml</em> inside the <code>orders</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">/orders/k8s.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">micronaut-k8s</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">orders"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s2">"</span><span class="s">orders"</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s2">"</span><span class="s">orders"</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">micronaut-service</span>  <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">orders"</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">orders</span>  <i class="conum" data-value="2"></i><b>(2)</b>
          <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">Never</span>  <i class="conum" data-value="3"></i><b>(3)</b>
          <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
              <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
          <span class="na">readinessProbe</span><span class="pi">:</span>
            <span class="na">httpGet</span><span class="pi">:</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">/health/readiness</span>
              <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
            <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">5</span>
            <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">3</span>
          <span class="na">livenessProbe</span><span class="pi">:</span>
            <span class="na">httpGet</span><span class="pi">:</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">/health/liveness</span>
              <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
            <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">5</span>
            <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">3</span>
            <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">10</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">micronaut-k8s</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">orders"</span>  <i class="conum" data-value="4"></i><b>(4)</b>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s2">"</span><span class="s">orders"</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">NodePort</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s2">"</span><span class="s">TCP"</span>
      <span class="na">port</span><span class="pi">:</span> <span class="s">8080</span>  <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The service name that we created in the <em>auth.yml</em> file.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The name of the container image for deployment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The imagePullPolicy is set to Never. We will always use local one that we built in previous step.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Name of a service, required for service discovery.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Micronaut default port on which application is running.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the next command to create the resources described above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl apply <span class="nt">-f</span> orders/k8s.yml</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="api-gateway-microservice-2">5.3. API (Gateway) Microservice</h3>
<div class="paragraph">
<p><a href="https://guides.micronaut.io/latest/micronaut-docker-image.html">Build a docker image</a> of the <code>api</code> service with the name <code>api</code>.</p>
</div>
<div class="paragraph">
<p>Edit the file named <em>k8s.yml</em> inside the <code>api</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">/api/k8s.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">micronaut-k8s</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">api"</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s2">"</span><span class="s">api"</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s2">"</span><span class="s">api"</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">serviceAccountName</span><span class="pi">:</span> <span class="s">micronaut-service</span> <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="na">containers</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">api"</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">api</span>  <i class="conum" data-value="2"></i><b>(2)</b>
          <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">Never</span>  <i class="conum" data-value="3"></i><b>(3)</b>
          <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">http</span>
              <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
          <span class="na">readinessProbe</span><span class="pi">:</span>
            <span class="na">httpGet</span><span class="pi">:</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">/health/readiness</span>
              <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
            <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">5</span>
            <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">3</span>
          <span class="na">livenessProbe</span><span class="pi">:</span>
            <span class="na">httpGet</span><span class="pi">:</span>
              <span class="na">path</span><span class="pi">:</span> <span class="s">/health/liveness</span>
              <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
            <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">5</span>
            <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">3</span>
            <span class="na">failureThreshold</span><span class="pi">:</span> <span class="m">10</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">micronaut-k8s</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">api"</span>  <i class="conum" data-value="4"></i><b>(4)</b>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s2">"</span><span class="s">api"</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
  <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">protocol</span><span class="pi">:</span> <span class="s2">"</span><span class="s">TCP"</span>
      <span class="na">port</span><span class="pi">:</span> <span class="s">8080</span>  <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The service name that we created in the <em>auth.yml</em> file.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The name of the container image for deployment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The imagePullPolicy is set to Never. We will always use local one that we built in previous step.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Name of a service, required for service discovery.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Micronaut default port on which application is running.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the next command to create the resources described above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl apply <span class="nt">-f</span> api/k8s.yml</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="test-integration-between-applications-deployed-on-kubernetes">5.4. Test integration between applications deployed on Kubernetes</h3>
<div class="paragraph">
<p>Run the next command to check status of the pods and make sure that all of them have the status "Running":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl get pods <span class="nt">-n</span><span class="o">=</span>micronaut-k8s</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">NAME                      READY   STATUS    RESTARTS   AGE
api-774fd667b9-dmws4      1/1     Running   0          24s
orders-74ff4fcbc4-dnfbw   1/1     Running   0          19s
users-9f46dd7c6-vs8z7     1/1     Running   0          13s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the next command to check the status of the microservices:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl get services <span class="nt">-n</span><span class="o">=</span>micronaut-k8s</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="minikube">5.4.1. Minikube</h4>
<div class="paragraph">
<p>For Minikube the output should be similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">NAME     TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
api      LoadBalancer   10.110.42.201    &lt;pending&gt;     8080:32601/TCP   18s
orders   NodePort       10.105.43.19     &lt;none&gt;        8080:31033/TCP   21s
users    NodePort       10.104.130.114   &lt;none&gt;        8080:31482/TCP   26s</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, the EXTERNAL-IP address  of the LoadBalancer service inside Minikube will be in the &lt;pending&gt; state. If you want to assign an external ip you have to run the <code>minikube tunnel</code> command.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the next command to retrieve the URL of the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">export </span><span class="nv">API_URL</span><span class="o">=</span><span class="si">$(</span>minikube service api <span class="nt">-n</span><span class="o">=</span>micronaut-k8s <span class="nt">--url</span><span class="si">)</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="docker-desktop">5.4.2. Docker Desktop</h4>
<div class="paragraph">
<p>For Docker Desktop&#8217;s Kubernetes integration the output should be similar to the following.  Notice the external-ip is <code>localhost</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">NAME     TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
api      LoadBalancer   10.108.205.248   localhost     8080:31516/TCP   9m23s
orders   NodePort       10.98.120.224    &lt;none&gt;        8080:31566/TCP   9m39s
users    NodePort       10.109.155.86    &lt;none&gt;        8080:30545/TCP   10m</code></pre>
</div>
</div>
<div class="paragraph">
<p>So for Docker Desktop the <code>API_URL</code> should be set to <code><a href="http://localhost:8080" class="bare">http://localhost:8080</a></code>.</p>
</div>
<div class="paragraph">
<p>Run a cURL command to create a new user via the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl <span class="nt">-X</span> <span class="s2">"POST"</span> <span class="s2">"</span><span class="nv">$API_URL</span><span class="s2">/api/users"</span> <span class="nt">-H</span> <span class="s1">'Content-Type: application/json; charset=utf-8'</span> <span class="nt">-d</span> <span class="s1">'{ "first_name": "Nemanja", "last_name": "Mikic", "username": "nmikic" }'</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"username"</span><span class="p">:</span><span class="s2">"nmikic"</span><span class="p">,</span><span class="nl">"first_name"</span><span class="p">:</span><span class="s2">"Nemanja"</span><span class="p">,</span><span class="nl">"last_name"</span><span class="p">:</span><span class="s2">"Mikic"</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Run a cURL command to a new order via the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl <span class="nt">-X</span> <span class="s2">"POST"</span> <span class="s2">"</span><span class="nv">$API_URL</span><span class="s2">/api/orders"</span> <span class="nt">-H</span> <span class="s1">'Content-Type: application/json; charset=utf-8'</span> <span class="nt">-d</span> <span class="s1">'{ "user_id": 1, "item_ids": [1,2] }'</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"user"</span><span class="p">:{</span><span class="nl">"first_name"</span><span class="p">:</span><span class="s2">"Nemanja"</span><span class="p">,</span><span class="nl">"last_name"</span><span class="p">:</span><span class="s2">"Mikic"</span><span class="p">,</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"username"</span><span class="p">:</span><span class="s2">"nmikic"</span><span class="p">},</span><span class="nl">"items"</span><span class="p">:[{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Banana"</span><span class="p">,</span><span class="nl">"price"</span><span class="p">:</span><span class="mf">1.5</span><span class="p">},{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Kiwi"</span><span class="p">,</span><span class="nl">"price"</span><span class="p">:</span><span class="mf">2.5</span><span class="p">}],</span><span class="nl">"total"</span><span class="p">:</span><span class="mf">4.0</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Run a cURL command to list created orders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl <span class="s2">"</span><span class="nv">$API_URL</span><span class="s2">/api/orders"</span> <span class="nt">-H</span> <span class="s1">'Content-Type: application/json; charset=utf-8'</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">[{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"user"</span><span class="p">:{</span><span class="nl">"first_name"</span><span class="p">:</span><span class="s2">"Nemanja"</span><span class="p">,</span><span class="nl">"last_name"</span><span class="p">:</span><span class="s2">"Mikic"</span><span class="p">,</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"username"</span><span class="p">:</span><span class="s2">"nmikic"</span><span class="p">},</span><span class="nl">"items"</span><span class="p">:[{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Banana"</span><span class="p">,</span><span class="nl">"price"</span><span class="p">:</span><span class="mf">1.5</span><span class="p">},{</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Kiwi"</span><span class="p">,</span><span class="nl">"price"</span><span class="p">:</span><span class="mf">2.5</span><span class="p">}],</span><span class="nl">"total"</span><span class="p">:</span><span class="mf">4.0</span><span class="p">}]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can try to place an order for a user who doesn&#8217;t exist (with id 100). Run a cURL command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">curl <span class="nt">-X</span> <span class="s2">"POST"</span> <span class="s2">"</span><span class="nv">$API_URL</span><span class="s2">/api/orders"</span> <span class="nt">-H</span> <span class="s1">'Content-Type: application/json; charset=utf-8'</span> <span class="nt">-d</span> <span class="s1">'{ "user_id": 100, "item_ids": [1,2] }'</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="nl">"message"</span><span class="p">:</span><span class="s2">"Bad Request"</span><span class="p">,</span><span class="nl">"_links"</span><span class="p">:{</span><span class="nl">"self"</span><span class="p">:[{</span><span class="nl">"href"</span><span class="p">:</span><span class="s2">"/api/orders"</span><span class="p">,</span><span class="nl">"templated"</span><span class="p">:</span><span class="kc">false</span><span class="p">}]},</span><span class="nl">"_embedded"</span><span class="p">:{</span><span class="nl">"errors"</span><span class="p">:[{</span><span class="nl">"message"</span><span class="p">:</span><span class="s2">"User with id 100 doesn't exist"</span><span class="p">}]}}</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cleaning-up">6. Cleaning Up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To delete all resources that were created in this guide run next command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">kubectl delete namespaces micronaut-k8s</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="next-steps">7. Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Read more about <a href="https://kubernetes.io/docs/home/">Kubernetes</a>.</p>
</div>
<div class="paragraph">
<p>Read more about <a href="https://micronaut-projects.github.io/micronaut-kubernetes/snapshot/guide/">Micronaut Kubernetes</a> module.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="license">8. License</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All guides are released with an <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache license 2.0 license</a> for the code and a <a href="https://creativecommons.org/licenses/by/4.0/deed.en">Creative Commons Attribution 4.0</a> license for the writing and media (images&#8230;&#8203;).
</td>
</tr>
</table>
</div>

            </div>
        </div>
    </div>
</main>

<footer id="footer">
    <div class="container">

        <div class="row">
            <div class="col-sm-5 footer-left">

                <div id="text-14" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <a href="https://micronaut.io/foundation/"><img class="alignnone size-medium wp-image-3736" src="./images/micronaut_foundation_horizontal_white.svg" alt="Micronaut Foundation"/></a>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-sm-7 footer-right">

                <ul class="meta">

                    <li id="menu-item-2895" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2895">
                        <a href="https://micronaut.io/brand-guidelines/">Brand Guidelines</a>
                    </li>
                    <li id="menu-item-2894" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2894">
                        <a href="https://micronaut.io/community-guidelines/">Community Guidelines</a>
                    </li>
                    <li id="menu-item-3377" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-privacy-policy menu-item-3377">
                        <a href="https://micronaut.io/privacy-policy/">Privacy Policy</a>
                    </li>

                </ul>

                <div id="nav_menu-2" class="widget widget_nav_menu">
                    <div class="menu-links-container">
                        <ul id="menu-links" class="menu">
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronautpodcast.com"><i class="fa fa-podcast"><span class="sr-only">Podcast</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronaut.io/feed/rss/"><i class="fa fa-feed"><span class="sr-only">Feed</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="mailto:info@micronaut.io"><i class="fas fa-envelope"><span class="sr-only">Mail</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://twitter.com/micronautfw"><i class="fab fa-twitter"><span class="sr-only">Twitter</span></i></a></li>
                            <li id="menu-item-6740" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-6740"><a href="https://fosstodon.org/@micronaut"><i class="fab fa-mastodon"><span class="sr-only">Mastodon</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://discord.gg/9xRFsHv98T"><i class="fab fa-discord"><span class="sr-only">Discord</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://github.com/micronaut-projects/"><i class="fab fa-github"><span class="sr-only">GitHub</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.youtube.com/@MicronautFramework"><i class="fab fa-youtube"><span class="sr-only">YouTube</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.linkedin.com/showcase/micronaut"><i class="fab fa-linkedin"><span class="sr-only">LinkedIn</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.twitch.tv/micronautfw"><i class="fab fa-twitch"><span class="sr-only">Twitch</span></i></a></li>
                        </ul>
                    </div>
                </div>
                <div id="text-5" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <small>Guides are licensed under <a href="https://creativecommons.org/licenses/by/4.0/deed.en">CC BY 4.0</a> for the writing/media and <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache.2.0</a> for the code</small>
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</footer>
</body>
</html>
