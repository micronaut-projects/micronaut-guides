<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'/>
    <title>Hotwire Turbo Chat with Micronaut Views</title>
    <link rel='stylesheet' id='wp-block-library-css' href='https://micronaut.io/wp-includes/css/dist/block-library/style.min.css' type='text/css' media='all'/>
    <link rel='stylesheet' id='fonts-fira-sans-css' href='https://fonts.googleapis.com/css2?family=Fira+Sans%3Awght%40300%3B500&#038;display=swap&#038;ver=5.7' type='text/css' media='all'/>
    <link rel='stylesheet' id='micronaut-style-css' href='https://micronaut.io/wp-content/themes/micronaut/style.min.css' type='text/css' media='all'/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link rel="shortcut icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link rel="alternate" type="application/rss+xml" title="Micronaut Guides RSS Feed" href="https://guides.micronaut.io/latest/rss.xml" />
    <link rel="alternate" type="application/json" title="Micronaut Guides JSON Feed" href="https://guides.micronaut.io/latest/feed.json" />
    <link href="coderay.css" rel="stylesheet" />
    <link href="rouge-github.css" rel="stylesheet" />
    <link href="guide.css" rel="stylesheet" />
    <script src="lunr.js"></script>
    <script src="guide.js"></script>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://guides.micronaut.io/latest/images/cards/hotwire-turbo-micronaut-chat.png"/>
    <meta name="twitter:creator" content="@micronautfw"/>
    <meta name="twitter:site" content="@micronautfw"/>
    <meta name="twitter:title" content="Hotwire Turbo Chat with Micronaut Views"/>
    <meta name="twitter:description" content="This guide shows how to build with the Micronaut Framework a chat application such as the Rails application demonstrated in the Hotwire announcement screencast."/>
</head>
<body class="page-template page-template-page-sidebar page-template-page-sidebar-php page page-parent guide">

<header id="header">

    <div class="container">

        <nav class="navbar navbar-expand-lg navbar-dark">

            <button class="collapsed" type="button" data-toggle="collapse" data-target="#nav" aria-expanded="false">
                <span></span>
            </button>

            <a class="navbar-brand" href="https://micronaut.io">
                <img src="https://micronaut.io/wp-content/uploads/2020/11/MIcronautLogo_Horizontal.svg" alt="Micronaut framework"/>
            </a>

            <div class="collapse navbar-collapse" id="nav">

                <ul class="navbar-nav ml-auto">

                    <li id="menu-item-2865" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2865 nav-item"><a href="https://micronaut.io/download/" class="nav-link">Download</a></li>
                    <li id="menu-item-2868" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-2868 dropdown nav-item"><a href="https://micronaut.io/learn/" class="nav-link dropdown-toggle" data-toggle="dropdown">Learn</a><ul class="dropdown-menu">
                        <li id="menu-item-4943" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4943"><a href="https://micronaut.io/learn/" class="dropdown-item">Overview</a></li>
                        <li id="menu-item-5111" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-5111"><a href="https://docs.micronaut.io/index.html" class="dropdown-item">User Documentaton</a></li>
                        <li id="menu-item-4510" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4510"><a href="https://micronaut.io/guides/" class="dropdown-item">Guides</a></li>
                        <li id="menu-item-2896" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2896"><a href="https://micronaut.io/category/microcast/" class="dropdown-item">Microcasts</a></li>
                        <li id="menu-item-2897" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2897"><a href="https://micronaut.io/category/webinar/" class="dropdown-item">Webinars</a></li>
                        <li id="menu-item-2871" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2871"><a href="https://micronaut.io/professional-training/" class="dropdown-item">Professional Training</a></li>
                        <li id="menu-item-6526" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-6526"><a href="https://micronaut-projects.github.io/micronaut-guides-mn3/latest/" class="dropdown-item">Guides for Micronaut Framework 3</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2878" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2878 dropdown nav-item"><a href="https://micronaut.io/resources/" class="nav-link dropdown-toggle" data-toggle="dropdown">Resources</a><ul class="dropdown-menu">
                        <li id="menu-item-4999" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4999"><a href="https://micronaut.io/upcoming-events/" class="dropdown-item">Upcoming Events</a></li>
                        <li id="menu-item-2879" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2879"><a href="https://micronaut.io/blog/" class="dropdown-item">Blog</a></li>
                        <li id="menu-item-6478" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6478"><a href="https://micronaut.io/category/release-announcements/" class="dropdown-item">Releases</a></li>
                        <li id="menu-item-6715" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6715"><a href="https://micronaut.io/category/security-announcements/" class="dropdown-item">Security Announcements</a></li>
                        <li id="menu-item-4499" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-4499"><a href="https://micronautpodcast.com/" class="dropdown-item">Podcast</a></li>
                        <li id="menu-item-5798" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5798"><a href="https://micronaut.io/support/" class="dropdown-item">Commercial Support</a></li>
                        <li id="menu-item-4186" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4186"><a href="https://micronaut.io/resources/community-support/" class="dropdown-item">Community Support</a></li>
                        <li id="menu-item-2882" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2882"><a href="https://micronaut.io/faq/" class="dropdown-item">FAQ</a></li>
                        <li id="menu-item-2883" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2883"><a href="https://micronaut.io/contact/" class="dropdown-item">Contact</a></li>
                        <li id="menu-item-6479" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6479"><a href="https://micronaut.io/micronaut-success-stories/" class="dropdown-item">Micronaut Success Stories</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2872" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2872 dropdown nav-item"><a href="https://micronaut.io/foundation/" class="nav-link dropdown-toggle" data-toggle="dropdown">Foundation</a><ul class="dropdown-menu">
                        <li id="menu-item-2877" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2877"><a href="https://micronaut.io/foundation/" class="dropdown-item">Overview</a></li>
                        <li id="menu-item-2874" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2874"><a href="https://micronaut.io/foundation/corporate-sponsorship/" class="dropdown-item">Corporate Sponsorship</a></li>
                        <li id="menu-item-2873" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2873"><a href="https://micronaut.io/foundation/community-sponsorship/" class="dropdown-item">Community Sponsorship</a></li>
                        <li id="menu-item-2876" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2876"><a href="https://micronaut.io/foundation/sponsors/" class="dropdown-item">Sponsors</a></li>
                        <li id="menu-item-3838" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-3838"><a href="https://micronaut.io/meeting-minutes/" class="dropdown-item">Meeting Minutes</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2884" class="action menu-item menu-item-type-custom menu-item-object-custom menu-item-2884 nav-item"><a target="_blank" rel="noopener" href="https://micronaut.io/launch/" class="nav-link">Launch</a></li>

                </ul>

            </div>

        </nav>

    </div>
</header>

<div style="background: #fff;padding-top: 20px;padding-bottom: 20px;">
    <div class="container" style="clear: both;">
        <fieldset style="float: right;">
            <input type="search" id="search-form-query"/>
            <input type="submit" onclick="search()" value="Search">
            <input type="submit" onclick="resetSearch()" value="Reset">
        </fieldset>
    </div>
    <div class="container" style="clear: both;margin-top: -20px;">
        <div class="guide-list" id="searchResults">
        </div>
    </div>
</div>
<div id="breadcrumbs"><div class="container"><a href="https://micronaut.io/">Home</a> » <a href="./index.html">Guides</a> » <a href="hotwire-turbo-micronaut-chat.html">Hotwire Turbo Chat with Micronaut Views</a> » <span class="breadcrumb_last" aria-current="page">gradle | java</span></div></div><!-- .breadcrumbs -->
<main id="main">
    <div class="container">
        <div class="row">
            <div class="col-md-4">

                <div class="toc">
                    <div class="inner">
                        <h1 class="title title_large first-word-bold first-word-break">Table of Contents</h1>
                        <div class="underline"></div>
                        
<ul class="sectlevel1">
<li><a href="#what-you-will-need">1. What you will need</a></li>
<li><a href="#getting-started">2. Getting started</a>
<ul class="sectlevel2">
<li><a href="#what-is-hotwire">2.1. What is Hotwire?</a></li>
</ul>
</li>
<li><a href="#screencast">3. Screencast</a></li>
<li><a href="#download-solution">4. Download Solution</a></li>
<li><a href="#initial-application-introduction">5. Initial application introduction</a></li>
<li><a href="#install-turbo">6. Install Turbo</a></li>
<li><a href="#turbo-frames">7. Turbo Frames</a>
<ul class="sectlevel2">
<li><a href="#highlight-frames">7.1. Highlight Frames</a></li>
<li><a href="#turbo-frame-show-view">7.2. Turbo Frame Show View</a></li>
<li><a href="#turbo-frame-edit-view">7.3. Turbo Frame Edit View</a></li>
<li><a href="#underscore-top">7.4. Underscore Top</a></li>
<li><a href="#lazy-loading-frames">7.5. Lazy Loading Frames</a></li>
<li><a href="#turboframeview-annotation">7.6. TurboFrameView Annotation</a></li>
<li><a href="#turbo-streams">7.7. Turbo Streams</a></li>
<li><a href="#stimulus-controller">7.8. Stimulus Controller</a></li>
</ul>
</li>
<li><a href="#turbo-streams-via-web-sockets">8. Turbo Streams via Web Sockets</a>
<ul class="sectlevel2">
<li><a href="#events">8.1. Events</a></li>
<li><a href="#websocket-server">8.2. WebSocket Server</a></li>
</ul>
</li>
<li><a href="#next">9. Next</a></li>
<li><a href="#appendix-a-initial-application">10. Appendix A: Initial application</a>
<ul class="sectlevel2">
<li><a href="#data-source-configuration">10.1. Data Source configuration</a></li>
<li><a href="#database-schema">10.2. Database Schema</a></li>
<li><a href="#database-migration-with-flyway">10.3. Database Migration with Flyway</a></li>
<li><a href="#entities">10.4. Entities</a></li>
<li><a href="#models">10.5. Models</a></li>
<li><a href="#repositories">10.6. Repositories</a></li>
<li><a href="#services">10.7. Services</a></li>
</ul>
</li>
<li><a href="#views">11. Views</a>
<ul class="sectlevel2">
<li><a href="#properties">11.1. Properties</a></li>
<li><a href="#message-source">11.2. Message Source</a></li>
<li><a href="#controllers">11.3. Controllers</a></li>
</ul>
</li>
<li><a href="#test-resources">12. Test Resources</a></li>
<li><a href="#running-the-application">13. Running the application</a></li>
<li><a href="#license">14. License</a></li>
</ul>

                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <h1>Hotwire Turbo Chat with Micronaut Views</h1>
                <div class="underline"></div>
<div class="sect1">
<div class="sectionbody">

<div class="paragraph">
<p>This guide shows how to build with the Micronaut Framework a chat application such as the Rails application demonstrated in the Hotwire announcement screencast.</p>
</div>
<div class="paragraph">
<p>Authors: Sergio del Amo</p>
</div>
<div class="paragraph">
<p>Micronaut Version: 4.9.1</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-you-will-need">1. What you will need</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE (e.g. <a href="https://guides.micronaut.io/latest/micronaut-intellij-idea-ide-setup.html">IntelliJ IDEA</a>)</p>
</li>
<li>
<p>JDK 21 or greater installed with <code>JAVA_HOME</code> <a href="https://www.baeldung.com/java-home-on-windows-7-8-10-mac-os-x-linux">configured appropriately</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started">2. Getting started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide shows a chat application such as the Rails application demonstrated in the  <a href="https://www.youtube.com/watch?v=eKY-QES1XQQ">Hotwire announcement screencast</a></p>
</div>
<div class="sect2">
<h3 id="what-is-hotwire">2.1. What is Hotwire?</h3>
<div class="paragraph">
<p><a href="https://hotwired.dev/">Hotwire: HTML Over the wire</a>:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Hotwire is an umbrella for trio frameworks that implement the HTML-over-the-wire approach to building modern web applications.
At its heart is Turbo, which gives you techniques for bringing the speed of a single-page application without writing a lick of JavaScript.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This guide primarily focuses on how <a href="https://turbo.hotwired.dev/">Turbo</a> works within a Micronaut application.</p>
</div>
</div>
</div>
</div>
</div></div><div class="row"><div class="col-md-12"><div class="sect1">
<h2 id="screencast">3. Screencast</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is a screencast here which shows this guide in action:</p>
</div>
<div class="videoblock">
<div class="content">
<iframe src="https://www.youtube.com/embed/KIh6AIKata4?rel=0" frameborder="0" allowfullscreen></iframe>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="download-solution">4. Download Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="hotwire-turbo-micronaut-chat-gradle-java.zip">Download</a> and unzip the source of the guide. You will find two folders:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>initial.</code> It contains a Micronaut application without any Turbo Integration.</p>
</li>
<li>
<p><code>complete</code>. The resulting Micronaut application if you follow the instructions in the next sections and apply these changes to the initial application.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="initial-application-introduction">5. Initial application introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The initial application uses two models, <code>Room</code> and <code>Message</code>. One <code>Room</code> has many <code>Message</code>s.</p>
</div>
<div class="paragraph">
<p>The <code>initial</code> application contains a basic editing interface for Chat <code>Room</code>s. It uses <a href="https://micronaut-projects.github.io/micronaut-views/latest/guide/#thymeleaf">Micronaut Views Thymeleaf</a> to render server-side HTML</p>
</div>
<div class="paragraph">
<p>Moreover, the application leverages <a href="https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#fragments">Thymeleaf Fragments</a> to encapsulate the rendering of parts of the screen.</p>
</div>
<div class="paragraph">
<p>For <code>Message</code>s, we will have just two actions. <code>create</code> to render the form to create a message and <code>save</code> to handle the form submission.</p>
</div>
<div class="paragraph">
<p>It gives us a foundation flow for an admittedly cumbersome chat application which we can then use to level up with <a href="https://hotwired.dev/">Hotwire</a> techniques one at a time.</p>
</div>
<div class="paragraph">
<p><a href="#appendix-a-initial-application">Appendix A: Initial application</a> describes the initial application if you want to learn more.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="install-turbo">6. Install Turbo</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://turbo.hotwired.dev/handbook/installing#in-compiled-form">Install Turbo</a> in compiled form by referencing the Turbo distributable script directly in the <code>&lt;head&gt;</code> of your application.</p>
</div>
<div class="paragraph">
<p>Modify the <code>initial</code> application, replace <code>src/main/resources/views/layout.html</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
...
    <span class="nt">&lt;head&gt;</span>
    ...
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"module"</span><span class="nt">&gt;</span>
        <span class="k">import</span> <span class="nx">hotwiredTurbo</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">https://cdn.skypack.dev/@hotwired/turbo</span><span class="dl">'</span><span class="p">;</span>
    <span class="nt">&lt;/script&gt;</span>
...
    <span class="nt">&lt;/head&gt;</span>
...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="turbo-frames">7. Turbo Frames</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So let&#8217;s introduce our first Turbo feature, Frames.</p>
</div>
<div class="paragraph">
<p>Turbo Frames decompose pages into independent contexts, which can be lazy-loaded and scope interaction.</p>
</div>
<div class="paragraph">
<p>So when you follow a link or submit a form, only the content of the Frame changes rather than the entire page.</p>
</div>
<div class="paragraph">
<p>This allows you to keep the state of the rest of the page from changing, making the app feel more responsive.</p>
</div>
<div class="sect2">
<h3 id="highlight-frames">7.1. Highlight Frames</h3>
<div class="paragraph">
<p>To see how the Frames work easily, we&#8217;ll call them out with a blue border.</p>
</div>
<div class="listingblock">
<div class="title">complete/src/main/resources/assets/stylesheets/application.css</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="css"><span class="nt">turbo-frame</span> <span class="p">{</span>
    <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
    <span class="nl">border</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="no">blue</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="turbo-frame-show-view">7.2. Turbo Frame Show View</h3>
<div class="paragraph">
<p>Now let&#8217;s wrap the Room name and the ability to edit it inside a Frame.</p>
</div>
<div class="paragraph">
<p>Replace this:</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/views/rooms/show.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span> <span class="na">th:replace=</span><span class="s">"~{layout :: layout(~{::script},~{::main})}"</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;script&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;main&gt;</span>
        <span class="nt">&lt;p</span> <span class="na">th:replace=</span><span class="s">"rooms/_room :: room(${room})"</span><span class="nt">&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{|/rooms/${room.id}/edit|}"</span> <span class="na">th:text=</span><span class="s">"#{action.edit}"</span><span class="nt">&gt;&lt;/a&gt;</span> |
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/rooms"</span> <span class="na">th:text=</span><span class="s">"#{action.back}"</span><span class="nt">&gt;&lt;/a&gt;</span>
        <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"messages"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">th:each=</span><span class="s">"message : ${room.messages}"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;p</span> <span class="na">th:replace=</span><span class="s">"messages/_message :: message(${message})"</span><span class="nt">&gt;&lt;/p&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{|/rooms/${room.id}/messages/create|}"</span> <span class="na">th:text=</span><span class="s">"#{message.new}"</span><span class="nt">&gt;&lt;/a&gt;</span>
    <span class="nt">&lt;/main&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>with:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/views/rooms/show.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span> <span class="na">th:replace=</span><span class="s">"~{layout :: layout(~{::script},~{::main})}"</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;script&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;main&gt;</span>
        <span class="nt">&lt;turbo-frame</span> <span class="na">id=</span><span class="s">"room"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;p</span> <span class="na">th:replace=</span><span class="s">"rooms/_room :: room(${room})"</span><span class="nt">&gt;&lt;/p&gt;</span>
            <span class="nt">&lt;p&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{|/rooms/${room.id}/edit|}"</span> <span class="na">th:text=</span><span class="s">"#{action.edit}"</span><span class="nt">&gt;&lt;/a&gt;</span> |
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/rooms"</span> <span class="na">th:text=</span><span class="s">"#{action.back}"</span><span class="nt">&gt;&lt;/a&gt;</span>
           <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;/turbo-frame&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"messages"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">th:each=</span><span class="s">"message : ${room.messages}"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;p</span> <span class="na">th:replace=</span><span class="s">"messages/_message :: message(${message})"</span><span class="nt">&gt;&lt;/p&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{|/rooms/${room.id}/messages/create|}"</span> <span class="na">th:text=</span><span class="s">"#{message.new}"</span><span class="nt">&gt;&lt;/a&gt;</span>
    <span class="nt">&lt;/main&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Please, note the usage of <code>&lt;turbo-frame id=" room"&gt;</code> in the previous code snippet.</p>
</div>
<div class="paragraph">
<p>The Turbo Frame tag goes around the initial display, including the edit link and the part of the edit page we want to appear within the frame.</p>
</div>
</div>
<div class="sect2">
<h3 id="turbo-frame-edit-view">7.3. Turbo Frame Edit View</h3>
<div class="paragraph">
<p>Replace this:</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/views/rooms/edit.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span> <span class="na">th:replace=</span><span class="s">"~{layout :: layout(~{::script},~{::main})}"</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;script&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;main&gt;</span>
        <span class="nt">&lt;h1</span> <span class="na">th:text=</span><span class="s">"#{room.edit}"</span><span class="nt">&gt;&lt;/h1&gt;</span>
<span class="nt">&lt;p</span> <span class="na">th:replace=</span><span class="s">"rooms/_edit :: edit(${room})"</span><span class="nt">&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{|/rooms/${room.id}|}"</span> <span class="na">th:text=</span><span class="s">"#{action.show}"</span><span class="nt">&gt;&lt;/a&gt;</span> |
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/rooms"</span> <span class="na">th:text=</span><span class="s">"#{action.back}"</span><span class="nt">&gt;&lt;/a&gt;</span>
    <span class="nt">&lt;/main&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>with this:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/views/rooms/edit.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span> <span class="na">th:replace=</span><span class="s">"~{layout :: layout(~{::script},~{::main})}"</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;script&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;main&gt;</span>
        <span class="nt">&lt;h1</span> <span class="na">th:text=</span><span class="s">"#{room.edit}"</span><span class="nt">&gt;&lt;/h1&gt;</span>
        <span class="nt">&lt;turbo-frame</span> <span class="na">id=</span><span class="s">"room"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;p</span> <span class="na">th:replace=</span><span class="s">"rooms/_edit :: edit(${room})"</span><span class="nt">&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;/turbo-frame&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{|/rooms/${room.id}|}"</span> <span class="na">th:text=</span><span class="s">"#{action.show}"</span><span class="nt">&gt;&lt;/a&gt;</span> |
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/rooms"</span> <span class="na">th:text=</span><span class="s">"#{action.back}"</span><span class="nt">&gt;&lt;/a&gt;</span>
    <span class="nt">&lt;/main&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We see our frame wrapped in blue.</p>
</div>
<div class="paragraph">
<p>And when clicking the Edit link, the form from the Edit screen is presented.</p>
</div>
<div class="paragraph">
<p>And upon submission, it&#8217;s replaced again with just a display.</p>
</div>
<div class="paragraph">
<p>If we go straight to the full page editing screen, we can see it has both a header and navigation links, parts we were omitting from the frame.</p>
</div>
</div>
<div class="sect2">
<h3 id="underscore-top">7.4. Underscore Top</h3>
<div class="paragraph">
<p>Note that if we try to click a link within the frame that goes somewhere without a matching Frame, nothing happens.</p>
</div>
<div class="paragraph">
<p>We can solve this by adding a Data Turbo Frame attribute that points to <code>_top</code> to break out of the frame, just like traditional HTML frames.</p>
</div>
<div class="paragraph">
<p>Replace:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/views/rooms/show.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html">....
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;main&gt;</span>
        ...
        <span class="nt">&lt;turbo-frame</span> <span class="na">id=</span><span class="s">"room"</span><span class="nt">&gt;</span>
            ...
                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/rooms"</span> <span class="na">th:text=</span><span class="s">"#{action.back}"</span><span class="nt">&gt;&lt;/a&gt;</span>
           <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;/turbo-frame&gt;</span>
....</code></pre>
</div>
</div>
<div class="paragraph">
<p>with:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/views/rooms/show.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html">....
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;main&gt;</span>
        ...
        <span class="nt">&lt;turbo-frame</span> <span class="na">id=</span><span class="s">"room"</span><span class="nt">&gt;</span>
            ...
               <span class="nt">&lt;a</span> <span class="na">data-turbo-frame=</span><span class="s">"_top"</span> <span class="na">href=</span><span class="s">"/rooms"</span> <span class="na">th:text=</span><span class="s">"#{action.back}"</span><span class="nt">&gt;&lt;/a&gt;</span>
           <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;/turbo-frame&gt;</span>
....</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the backlink works, and the frame scopes the edit display loop.</p>
</div>
</div>
<div class="sect2">
<h3 id="lazy-loading-frames">7.5. Lazy Loading Frames</h3>
<div class="paragraph">
<p>Then, let&#8217;s add the New Message link into an inline but lazy-loaded Turbo Frame tag that also, just for starters, acts on the whole page.</p>
</div>
<div class="paragraph">
<p>This frame will be loaded right after the page displays, hitting the New Message Controller action we made earlier.</p>
</div>
<div class="paragraph">
<p>Replace:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/views/rooms/show.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html">...
...
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/messages/create"</span> <span class="na">th:text=</span><span class="s">"#{message.new}"</span><span class="nt">&gt;&lt;/a&gt;</span>
    <span class="nt">&lt;/main&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>with:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/views/rooms/show.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html">....
        <span class="nt">&lt;turbo-frame</span> <span class="na">id=</span><span class="s">"new_message"</span>
                     <span class="na">th:src=</span><span class="s">"@{|/rooms/${room.id}/messages/create|}"</span>
                     <span class="na">target=</span><span class="s">"_top"</span><span class="nt">&gt;&lt;/turbo-frame&gt;</span>
    <span class="nt">&lt;/main&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="plug-out-the-frame">7.5.1. Plug out the Frame</h4>
<div class="paragraph">
<p>Like with edit, we wrap the relevant segment in a Frame tag with a matching ID, which is how Turbo knows how to plug out the right frame.</p>
</div>
<div class="paragraph">
<p>Replace:</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/views/messages/create.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span> <span class="na">th:replace=</span><span class="s">"~{layout :: layout(~{::script},~{::main})}"</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;script&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;main&gt;</span>
    <span class="nt">&lt;h1</span> <span class="na">th:text=</span><span class="s">"#{message.new}"</span><span class="nt">&gt;&lt;/h1&gt;</span>
<span class="nt">&lt;form</span> <span class="na">th:replace=</span><span class="s">"messages/_create :: create(${room})"</span><span class="nt">&gt;&lt;/form&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{|/rooms/${room.id}|}"</span> <span class="na">th:text=</span><span class="s">"#{action.back}"</span><span class="nt">&gt;&lt;/a&gt;</span>
    <span class="nt">&lt;/main&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>with:</p>
</div>
<div class="listingblock">
<div class="title">complete/src/main/resources/views/messages/create.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span> <span class="na">th:replace=</span><span class="s">"~{layout :: layout(~{::script},~{::main})}"</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;script&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;main&gt;</span>
    <span class="nt">&lt;h1</span> <span class="na">th:text=</span><span class="s">"#{message.new}"</span><span class="nt">&gt;&lt;/h1&gt;</span>
    <span class="nt">&lt;turbo-frame</span> <span class="na">id=</span><span class="s">"new_message"</span> <span class="na">target=</span><span class="s">"_top"</span><span class="nt">&gt;</span>
<span class="nt">&lt;form</span> <span class="na">th:replace=</span><span class="s">"messages/_create :: create(${room})"</span><span class="nt">&gt;&lt;/form&gt;</span>
    <span class="nt">&lt;/turbo-frame&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{|/rooms/${room.id}|}"</span> <span class="na">th:text=</span><span class="s">"#{action.back}"</span><span class="nt">&gt;&lt;/a&gt;</span>
    <span class="nt">&lt;/main&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now see two requests when we load the room: one for the page, and one for the lazy-loader frame.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try to add a message.</p>
</div>
<div class="paragraph">
<p>It works!</p>
</div>
<div class="paragraph">
<p>But this only demonstrates that the frame was lazy-loaded.</p>
</div>
<div class="paragraph">
<p>Right now, we&#8217;re resetting the whole page upon submission of the New Message form.</p>
</div>
<div class="paragraph">
<p>Whereas with the Room Name Frame, you can edit and submit without changing the rest of the page state,
a real independent context.</p>
</div>
<div class="paragraph">
<p>You can see how the Frame replacement happens by inspecting the response to edit.</p>
</div>
<div class="paragraph">
<p>Turbo will plug out just the matching frame from the server response. As you can see here, the header and links are ignored.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="turboframeview-annotation">7.6. TurboFrameView Annotation</h3>
<div class="paragraph">
<p>In a Micronaut application, we can optimize the response by using the <code>@TurboFrameView</code> annotation only to render the layout Turbo uses when parsing the response. A Request coming from a Frame includes the HTTP Header <code>Turbo-Frame</code>. Annotate <code>RoomsControllerEdit::edit</code> method with <code>@TurboFrameView("/rooms/_edit")</code></p>
</div>
<div class="listingblock">
<div class="title">complete/src/main/java/example/micronaut/controllers/RoomsControllerEdit.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.controllers</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">example.micronaut.repositories.RoomRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.MediaType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Get</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Produces</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.TaskExecutors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.annotation.ExecuteOn</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.views.View</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.views.turbo.TurboFrameView</span><span class="o">;</span>

<span class="nd">@Controller</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RoomsControllerEdit</span> <span class="kd">extends</span> <span class="nc">RoomsController</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">RoomsControllerEdit</span><span class="o">(</span><span class="nc">RoomRepository</span> <span class="n">roomRepository</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">roomRepository</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@ExecuteOn</span><span class="o">(</span><span class="nc">TaskExecutors</span><span class="o">.</span><span class="na">BLOCKING</span><span class="o">)</span>
    <span class="nd">@View</span><span class="o">(</span><span class="s">"/rooms/edit"</span><span class="o">)</span>
    <span class="nd">@Get</span><span class="o">(</span><span class="s">"/{id}/edit"</span><span class="o">)</span>
    <span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)</span>
    <span class="nd">@TurboFrameView</span><span class="o">(</span><span class="s">"/rooms/_edit"</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="nc">HttpResponse</span><span class="o">&lt;?&gt;</span> <span class="n">edit</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">modelResponse</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can render a Turbo Frame easily by annotating a controller route with <code>@TurboFrameView</code> and returning only the HTML used by Turbo. You can specify the view with the annotation value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The above controller returns the following HTML for a request without HTTP Header <code>Turbo-Frame</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;</span>Chat<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width,initial-scale=1"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">media=</span><span class="s">"all"</span> <span class="na">href=</span><span class="s">"/assets/stylesheets/application.css"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">media=</span><span class="s">"all"</span> <span class="na">href=</span><span class="s">"/assets/stylesheets/scaffolds.css"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"module"</span><span class="nt">&gt;</span>
            <span class="k">import</span> <span class="nx">hotwiredTurbo</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">https://cdn.skypack.dev/@hotwired/turbo</span><span class="dl">'</span><span class="p">;</span>
        <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;main&gt;</span>
            <span class="nt">&lt;h1&gt;</span>Editing Room<span class="nt">&lt;/h1&gt;</span>
            <span class="nt">&lt;turbo-frame</span> <span class="na">id=</span><span class="s">"room"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/rooms/update"</span>
                      <span class="na">accept-charset=</span><span class="s">"UTF-8"</span>
                      <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
                     <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"1"</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">&gt;</span>
                     <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
                         <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"room_name"</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
                         <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"Micronaut Questions"</span> <span class="na">name=</span><span class="s">"name"</span> <span class="na">id=</span><span class="s">"room_name"</span> <span class="nt">/&gt;</span>
                     <span class="nt">&lt;/div&gt;</span>
                     <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;</span>
                         <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">value=</span><span class="s">"Update Room"</span><span class="nt">/&gt;</span>
                     <span class="nt">&lt;/div&gt;</span>
                <span class="nt">&lt;/form&gt;</span>
            <span class="nt">&lt;/turbo-frame&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/rooms/1"</span><span class="nt">&gt;</span>Show<span class="nt">&lt;/a&gt;</span> |
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/rooms"</span><span class="nt">&gt;</span>Back<span class="nt">&lt;/a&gt;</span>
        <span class="nt">&lt;/main&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For a request including an HTTP Header <code>Turbo-Frame</code> with value <code>rooms</code>, the above controller returns the following HTML.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;turbo-frame</span> <span class="na">id=</span><span class="s">"room"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/rooms/update"</span>
          <span class="na">accept-charset=</span><span class="s">"UTF-8"</span>
          <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">value=</span><span class="s">"1"</span> <span class="na">name=</span><span class="s">"id"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"room_name"</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"Micronaut Questions"</span> <span class="na">name=</span><span class="s">"name"</span> <span class="na">id=</span><span class="s">"room_name"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">value=</span><span class="s">"Update Room"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/turbo-frame&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="turbo-streams">7.7. Turbo Streams</h3>
<div class="paragraph">
<p>Turbo Streams deliver page changes over WebSocket or in response to form submissions using just HTML and a set of CRUD-like action tags.</p>
</div>
<div class="paragraph">
<p>Turbo Streams let you append or prepend to replace and remove any target DOM element from the existing page.</p>
</div>
<div class="paragraph">
<p>They&#8217;re strictly limited to DOM changes, though. No direct JavaScript invocation.</p>
</div>
<div class="paragraph">
<p>If you need more than a DOM change, connect a Stimulus controller.</p>
</div>
<div class="paragraph">
<p>We will add a Turbo stream response to the message creation action such that we can add the new message to the Room page without replacing the whole page.</p>
</div>
<div class="paragraph">
<p>This template invokes the <code>append</code> action with the DOM ID of the target container and either a full set of partial rendering options or just a record we wish to render which conforms to the naming conventions for matching to a partial.</p>
</div>
<div class="listingblock">
<div class="title">complete/src/main/java/example/micronaut/controllers/MessagesControllerSave.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.controllers</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">example.micronaut.models.MessageForm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">example.micronaut.models.RoomMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">example.micronaut.services.MessageService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.MediaType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Body</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Consumes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Post</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Produces</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.TaskExecutors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.annotation.ExecuteOn</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.views.turbo.TurboStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.views.turbo.http.TurboMediaType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="nd">@ExecuteOn</span><span class="o">(</span><span class="nc">TaskExecutors</span><span class="o">.</span><span class="na">BLOCKING</span><span class="o">)</span>
<span class="nd">@Controller</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">)</span>
<span class="kd">class</span> <span class="nc">MessagesControllerSave</span> <span class="kd">extends</span> <span class="nc">ApplicationController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="no">LOG</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">MessagesControllerSave</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MessageService</span> <span class="n">messageService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MessagesControllerSave</span><span class="o">(</span><span class="nc">MessageService</span> <span class="n">messageService</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">messageService</span> <span class="o">=</span> <span class="n">messageService</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)</span>
    <span class="nd">@Consumes</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_FORM_URLENCODED</span><span class="o">)</span>
    <span class="nd">@Post</span><span class="o">(</span><span class="s">"/{id}/messages"</span><span class="o">)</span>
    <span class="nc">HttpResponse</span><span class="o">&lt;?&gt;</span> <span class="n">save</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span>
                         <span class="nd">@Body</span><span class="o">(</span><span class="s">"content"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">content</span><span class="o">,</span>
                         <span class="nc">HttpRequest</span><span class="o">&lt;?&gt;</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">RoomMessage</span><span class="o">&gt;</span> <span class="n">roomMessageOptional</span> <span class="o">=</span> <span class="n">messageService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">MessageForm</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">content</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">roomMessageOptional</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">roomMessage</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">TurboMediaType</span><span class="o">.</span><span class="na">acceptsTurboStream</span><span class="o">(</span><span class="n">request</span><span class="o">))</span> <span class="o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
                <span class="k">return</span> <span class="nc">HttpResponse</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="nc">TurboStream</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span> <i class="conum" data-value="2"></i><b>(2)</b>
                        <span class="o">.</span><span class="na">template</span><span class="o">(</span><span class="s">"/messages/_message.html"</span><span class="o">,</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span> <span class="n">roomMessage</span><span class="o">))</span>
                        <span class="o">.</span><span class="na">targetDomId</span><span class="o">(</span><span class="s">"messages"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">append</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="nf">redirectTo</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
        <span class="o">}).</span><span class="na">orElseGet</span><span class="o">(</span><span class="nl">HttpResponse:</span><span class="o">:</span><span class="n">notFound</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>TurboMediaType::acceptsTurboStream</code> is a convenient method to verify if the request accepts a turbo stream response.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can build a Turbo Stream with fluid API. Micronaut Views templates are supported.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we can add Messages to the page without resetting it completely.</p>
</div>
</div>
<div class="sect2">
<h3 id="stimulus-controller">7.8. Stimulus Controller</h3>
<div class="paragraph">
<p>The Edit Name form can stay open while we&#8217;re doing this because new Messages are added directly to the Messages div. The Turbo Stream HTML is rendered directly in response to the form submission, and Turbo knows from the MIME type to process it automatically. But notice the input field isn&#8217;t cleared. We can fix that by adding a <a href="https://stimulus.hotwired.dev">Stimulus</a> controller.</p>
</div>
<hr>
<div class="paragraph">
<p>Stimulus is a modest JavaScript framework for the HTML you already have.
<em>_</em></p>
</div>
<div class="paragraph">
<p>Add a <a href="https://stimulus.hotwired.dev/reference/controllers">Stimulus controller</a>:</p>
</div>
<div class="listingblock">
<div class="title">complete/src/main/resources/assets/javascripts/controllers/reset_form_controller.mjs</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="mjs">import { Controller } from "https://unpkg.com/@hotwired/stimulus/dist/stimulus.js"

export default class extends Controller {
    reset() {
        this.element.reset()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and register it:</p>
</div>
<div class="listingblock">
<div class="title">complete/src/main/resources/views/layout.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html">--&gt;
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"module"</span><span class="nt">&gt;</span>
        <span class="k">import</span> <span class="nx">hotwiredTurbo</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">https://cdn.skypack.dev/@hotwired/turbo</span><span class="dl">'</span><span class="p">;</span>
        <span class="k">import</span> <span class="p">{</span><span class="nx">Application</span><span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">https://unpkg.com/@hotwired/stimulus/dist/stimulus.js</span><span class="dl">"</span>
        <span class="k">import</span> <span class="nx">ResetFormController</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">/assets/javascripts/controllers/reset_form_controller.mjs</span><span class="dl">"</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">Stimulus</span> <span class="o">=</span> <span class="nx">Application</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>
        <span class="nx">Stimulus</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="dl">"</span><span class="s2">reset-form</span><span class="dl">"</span><span class="p">,</span> <span class="nx">ResetFormController</span><span class="p">)</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="c">&lt;!--
</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The Stimulus controller we&#8217;re going to add will be a dead-simple way to reset the form after creating a new Message.</p>
</div>
<div class="paragraph">
<p>It has just one method, Reset, which we will call when Turbo is done submitting the form via Fetch.</p>
</div>
<div class="paragraph">
<p>Add the <code>data-controller</code> and <code>data-action</code> attributes to the form:</p>
</div>
<div class="listingblock">
<div class="title">complete/src/main/resources/views/messages/_create.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;form</span> <span class="na">th:fragment=</span><span class="s">"create(room)"</span>
      <span class="na">th:action=</span><span class="s">"@{|/rooms/${room.id}/messages|}"</span>
      <span class="na">data-controller=</span><span class="s">"reset-form"</span>
      <span class="na">data-action=</span><span class="s">"turbo:submit-end-&gt;reset-form#reset"</span>
      <span class="na">accept-charset=</span><span class="s">"UTF-8"</span>
      <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"content"</span> <span class="na">id=</span><span class="s">"message_content"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">th:value=</span><span class="s">"#{message.send}"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The form is reset, and the <code>Message</code> is added dynamically.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="turbo-streams-via-web-sockets">8. Turbo Streams via Web Sockets</h2>
<div class="sectionbody">
<div class="paragraph">
<p>But how interesting is a chat app where you&#8217;re just talking to yourself?. Let&#8217;s start a conversation with another window.
You&#8217;ll see that new Messages are only added live to the originator&#8217;s window.
On the other side, we have to reload to see what&#8217;s been said.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s fix that.</p>
</div>
<div class="sect2">
<h3 id="events">8.1. Events</h3>
<div class="paragraph">
<p>When the message is saved, raise an event:</p>
</div>
<div class="listingblock">
<div class="title">complete/src/main/java/example/micronaut/services/DefaultMessageService.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.services</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.context.event.ApplicationEventPublisher</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.core.annotation.NonNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">example.micronaut.entities.Message</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">example.micronaut.models.MessageForm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">example.micronaut.models.RoomMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">example.micronaut.repositories.MessageRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">example.micronaut.repositories.RoomRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.inject.Singleton</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.validation.Valid</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="nd">@Singleton</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultMessageService</span> <span class="kd">implements</span> <span class="nc">MessageService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MessageRepository</span> <span class="n">messageRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RoomRepository</span> <span class="n">roomRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ApplicationEventPublisher</span><span class="o">&lt;</span><span class="nc">RoomMessage</span><span class="o">&gt;</span> <span class="n">eventPublisher</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">DefaultMessageService</span><span class="o">(</span><span class="nc">MessageRepository</span> <span class="n">messageRepository</span><span class="o">,</span>
                                 <span class="nc">RoomRepository</span> <span class="n">roomRepository</span><span class="o">,</span>
                                 <span class="nc">ApplicationEventPublisher</span><span class="o">&lt;</span><span class="nc">RoomMessage</span><span class="o">&gt;</span> <span class="n">eventPublisher</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="k">this</span><span class="o">.</span><span class="na">messageRepository</span> <span class="o">=</span> <span class="n">messageRepository</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">roomRepository</span> <span class="o">=</span> <span class="n">roomRepository</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">eventPublisher</span> <span class="o">=</span> <span class="n">eventPublisher</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@NonNull</span>
    <span class="kd">public</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">RoomMessage</span><span class="o">&gt;</span> <span class="nf">save</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nd">@NotNull</span> <span class="nd">@Valid</span> <span class="nc">MessageForm</span> <span class="n">form</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">roomRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getRoom</span><span class="o">())</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">room</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="nc">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="n">messageRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Message</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getContent</span><span class="o">(),</span> <span class="n">room</span><span class="o">));</span>
                    <span class="nc">RoomMessage</span> <span class="n">roomMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RoomMessage</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span>
                            <span class="n">form</span><span class="o">.</span><span class="na">getRoom</span><span class="o">(),</span>
                            <span class="n">form</span><span class="o">.</span><span class="na">getContent</span><span class="o">(),</span>
                            <span class="n">message</span><span class="o">.</span><span class="na">getDateCreated</span><span class="o">());</span>
                    <span class="n">eventPublisher</span><span class="o">.</span><span class="na">publishEvent</span><span class="o">(</span><span class="n">roomMessage</span><span class="o">);</span> <i class="conum" data-value="1"></i><b>(1)</b>
                    <span class="k">return</span> <span class="n">roomMessage</span><span class="o">;</span>
                <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>To publish an event, use dependency injection to obtain an instance of <code>ApplicationEventPublisher</code> where the generic type is the type of event and invoke the <code>publishEvent</code> method with your event object. For performance reasons, it’s advisable to inject an instance of <code>ApplicationEventPublisher</code> with a generic type parameter - <code>ApplicationEventPublisher&lt;RoomMessage&gt;</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="websocket-server">8.2. WebSocket Server</h3>
<div class="paragraph">
<p>Create a <a href="https://docs.micronaut.io/latest/guide/#websocketServer">WebSocket Server</a>, which publishes a Turbo Stream when a message event is received.</p>
</div>
<div class="listingblock">
<div class="title">complete/src/main/java/example/micronaut/ChatServerWebSocket.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.context.event.ApplicationEventListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.core.annotation.NonNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.core.io.Writable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">example.micronaut.models.RoomMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.views.turbo.TurboStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.views.turbo.TurboStreamAction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.views.turbo.TurboStreamRenderer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.views.turbo.http.TurboMediaType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.websocket.WebSocketBroadcaster</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.websocket.WebSocketSession</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.websocket.annotation.OnClose</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.websocket.annotation.OnMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.websocket.annotation.OnOpen</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.websocket.annotation.ServerWebSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.StringWriter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.function.BiFunction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.function.Function</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.function.Predicate</span><span class="o">;</span>

<span class="nd">@ServerWebSocket</span><span class="o">(</span><span class="s">"/chat/{room}"</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatServerWebSocket</span> <span class="kd">implements</span> <span class="nc">ApplicationEventListener</span><span class="o">&lt;</span><span class="nc">RoomMessage</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="no">LOG</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">ChatServerWebSocket</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">WebSocketBroadcaster</span> <span class="n">broadcaster</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TurboStreamRenderer</span> <span class="n">turboStreamRenderer</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">roomSessions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>

    <span class="nc">ChatServerWebSocket</span><span class="o">(</span><span class="nc">WebSocketBroadcaster</span> <span class="n">broadcaster</span><span class="o">,</span> <i class="conum" data-value="2"></i><b>(2)</b>
                        <span class="nc">TurboStreamRenderer</span> <span class="n">turboStreamRenderer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">broadcaster</span> <span class="o">=</span> <span class="n">broadcaster</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">turboStreamRenderer</span> <span class="o">=</span> <span class="n">turboStreamRenderer</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@OnOpen</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onOpen</span><span class="o">(</span><span class="nc">String</span> <span class="n">room</span><span class="o">,</span> <span class="nc">WebSocketSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
        <span class="no">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"onOpen room {}"</span><span class="o">,</span> <span class="n">room</span><span class="o">);</span>
        <span class="n">roomSessions</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="n">room</span><span class="o">,</span> <span class="n">k</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span>
            <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">});</span>
        <span class="n">roomSessions</span><span class="o">.</span><span class="na">computeIfPresent</span><span class="o">(</span><span class="n">room</span><span class="o">,</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">sessions</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">sessions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">sessions</span><span class="o">;</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="nd">@OnMessage</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="nc">String</span> <span class="n">room</span><span class="o">,</span> <span class="nc">String</span> <span class="n">message</span><span class="o">,</span> <span class="nc">WebSocketSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
        <span class="no">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"onMessage room {}"</span><span class="o">,</span> <span class="n">room</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@OnClose</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClose</span><span class="o">(</span><span class="nc">String</span> <span class="n">room</span><span class="o">,</span> <span class="nc">WebSocketSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
        <span class="no">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"onClose room {}"</span><span class="o">,</span> <span class="n">room</span><span class="o">);</span>
        <span class="n">roomSessions</span><span class="o">.</span><span class="na">computeIfPresent</span><span class="o">(</span><span class="n">room</span><span class="o">,</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">sessions</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">sessions</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">session</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
            <span class="k">return</span> <span class="n">sessions</span><span class="o">;</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="nc">RoomMessage</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">broadcast</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">broadcast</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">RoomMessage</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">turboStreamRenderer</span><span class="o">.</span><span class="na">render</span><span class="o">(</span><span class="n">turboStream</span><span class="o">(</span><span class="n">message</span><span class="o">),</span> <span class="kc">null</span><span class="o">)</span>
                <span class="o">.</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">writable</span> <span class="o">-&gt;</span> <span class="n">broadcast</span><span class="o">(</span><span class="n">writable</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getRoom</span><span class="o">())));</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">broadcast</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Writable</span> <span class="n">writable</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">String</span> <span class="n">room</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">writableToString</span><span class="o">(</span><span class="n">writable</span><span class="o">)</span>
                <span class="o">.</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">message</span> <span class="o">-&gt;</span> <span class="n">broadcaster</span><span class="o">.</span><span class="na">broadcastAsync</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="nc">TurboMediaType</span><span class="o">.</span><span class="na">TURBO_STREAM_TYPE</span><span class="o">,</span> <span class="n">inRoom</span><span class="o">(</span><span class="n">room</span><span class="o">)));</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Predicate</span><span class="o">&lt;</span><span class="nc">WebSocketSession</span><span class="o">&gt;</span> <span class="nf">inRoom</span><span class="o">(</span><span class="nc">String</span> <span class="n">room</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">websocketIds</span> <span class="o">=</span> <span class="n">roomSessions</span><span class="o">.</span><span class="na">getOrDefault</span><span class="o">(</span><span class="n">room</span><span class="o">,</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">emptySet</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">websocketIds</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">writableToString</span><span class="o">(</span><span class="nc">Writable</span> <span class="n">writable</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">StringWriter</span> <span class="n">stringWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringWriter</span><span class="o">();</span>
            <span class="n">writable</span><span class="o">.</span><span class="na">writeTo</span><span class="o">(</span><span class="n">stringWriter</span><span class="o">);</span>
            <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">stringWriter</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">TurboStream</span><span class="o">.</span><span class="na">Builder</span> <span class="nf">turboStream</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">RoomMessage</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">TurboStream</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">action</span><span class="o">(</span><span class="nc">TurboStreamAction</span><span class="o">.</span><span class="na">APPEND</span><span class="o">)</span>
                <span class="o">.</span><span class="na">template</span><span class="o">(</span><span class="s">"/messages/_message.html"</span><span class="o">,</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span> <span class="n">message</span><span class="o">))</span>
                <span class="o">.</span><span class="na">targetDomId</span><span class="o">(</span><span class="s">"messages"</span><span class="o">);</span> <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@ServerWebSocket</code> annotation defines the path the WebSocket is mapped under. The URI can be a URI template.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can use a <code>WebSocketBroadcaster</code> to broadcast messages to every WebSocket session.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>@OnOpen</code> annotation declares the method to invoke when the WebSocket is opened.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>@OnMessage</code> annotation declares the method to invoke when a message is received.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>@OnClose</code> annotation declares the method to invoke when the WebSocket is closed.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>You can build a Turbo Stream with fluid API. Micronaut Views templates are supported.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Establish a WebSocket connection to the WebSocket server identified by the <code>Room</code> we&#8217;re in.</p>
</div>
<div class="listingblock">
<div class="title">complete/src/main/resources/views/rooms/show.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span> <span class="na">th:replace=</span><span class="s">"~{layout :: layout(~{::script},~{::main})}"</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"module"</span><span class="nt">&gt;</span>
        <span class="kd">const</span> <span class="nx">wsUrl</span> <span class="o">=</span> <span class="p">((</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">https:</span><span class="dl">"</span><span class="p">)</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">wss://</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">ws://</span><span class="dl">"</span><span class="p">)</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">/chat/[[${room.id}]]</span><span class="dl">"</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">wsUrl</span><span class="p">);</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">open</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="k">import</span> <span class="nx">hotwiredTurbo</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">https://cdn.skypack.dev/@hotwired/turbo</span><span class="dl">'</span><span class="p">;</span>
        <span class="nx">Turbo</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">connectStreamSource</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;main&gt;</span>
        <span class="nt">&lt;turbo-frame</span> <span class="na">id=</span><span class="s">"room"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;p</span> <span class="na">th:replace=</span><span class="s">"rooms/_room :: room(${room})"</span><span class="nt">&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{|/rooms/${room.id}/edit|}"</span> <span class="na">th:text=</span><span class="s">"#{action.edit}"</span><span class="nt">&gt;&lt;/a&gt;</span> |
            <span class="nt">&lt;a</span> <span class="na">data-turbo-frame=</span><span class="s">"_top"</span> <span class="na">href=</span><span class="s">"/rooms"</span> <span class="na">th:text=</span><span class="s">"#{action.back}"</span><span class="nt">&gt;&lt;/a&gt;</span>
        <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;/turbo-frame&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"messages"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">th:each=</span><span class="s">"message : ${room.messages}"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;p</span> <span class="na">th:replace=</span><span class="s">"messages/_message :: message(${message})"</span><span class="nt">&gt;&lt;/p&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;turbo-frame</span> <span class="na">id=</span><span class="s">"new_message"</span>
                     <span class="na">th:src=</span><span class="s">"@{|/rooms/${room.id}/messages/create|}"</span>
                     <span class="na">target=</span><span class="s">"_top"</span><span class="nt">&gt;&lt;/turbo-frame&gt;</span>
    <span class="nt">&lt;/main&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can add a new message and see it appear in both windows.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="next">9. Next</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://hotwired.dev">Hotwire</a> is an alternative approach to building modern web applications without using much JavaScript by sending HTML instead of JSON over the wire.</p>
</div>
<div class="paragraph">
<p>We get to keep all our template rendering on the server, which means writing more of our applications in our favorite programming languages.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://micronaut-projects.github.io/micronaut-views/latest/guide/#turbo">Micronaut Turbo</a></p>
</li>
<li>
<p><a href="https://turbo.hotwired.dev/">Turbo</a></p>
</li>
<li>
<p><a href="https://stimulus.hotwired.dev/">Stimulus</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix-a-initial-application">10. Appendix A: Initial application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following sections introduce you to the initial application.</p>
</div>
<div class="sect2">
<h3 id="data-source-configuration">10.1. Data Source configuration</h3>
<div class="paragraph">
<p>Define the datasource in <code>src/main/resources/application.properties</code>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<a href="https://micronaut.io/2023/02/19/micronaut-framework-4-0-and-snakeyaml-transitive-dependency/">Since Micronaut Framework 4.0, to use YAML configuration, you have to add the YAML dependency</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/application.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">datasources</span><span class="pi">:</span>
  <span class="na">default</span><span class="pi">:</span>
    <span class="na">dialect</span><span class="pi">:</span> <span class="s">MYSQL</span>
    <span class="na">driverClassName</span><span class="pi">:</span> <span class="s">${JDBC_DRIVER:com.mysql.cj.jdbc.Driver}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This way of defining the datasource properties enables us to externalize the configuration, for example for production environment, and also provide a default value for development. If the environment variables are not defined, the Micronaut framework will use the default values.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="database-schema">10.2. Database Schema</h3>

</div>
<div class="sect2">
<h3 id="database-migration-with-flyway">10.3. Database Migration with Flyway</h3>
<div class="paragraph">
<p>We need a way to create the database schema. For that, we use <a href="https://micronaut-projects.github.io/micronaut-flyway/latest/guide/">Micronaut integration with Flyway</a>.</p>
</div>
<div class="paragraph">
<p><a href="https://www.flywaydb.org">Flyway</a> automates schema changes, significantly simplifying schema management tasks, such as migrating, rolling back, and reproducing in multiple environments.</p>
</div>
<div class="paragraph">
<p>Add the following snippet to include the necessary dependencies:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">implementation</span><span class="o">(</span><span class="s2">"io.micronaut.flyway:micronaut-flyway"</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will enable Flyway in the Micronaut configuration file and configure it to perform migrations on one of the defined data sources.</p>
</div>
<div class="paragraph">
<p>Since <a href="https://flywaydb.org/documentation/learnmore/releaseNotes#8.2.0">Flyway 8.2.0</a>, the Flyway distribution does not contain the MySQL driver.</p>
</div>
<div class="paragraph">
<p>Add the following dependency:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">implementation</span><span class="o">(</span><span class="s2">"org.flywaydb:flyway-mysql:@flyway-mysqlVersion@"</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<a href="https://micronaut.io/2023/02/19/micronaut-framework-4-0-and-snakeyaml-transitive-dependency/">Since Micronaut Framework 4.0, to use YAML configuration, you have to add the YAML dependency</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/application.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">flyway</span><span class="pi">:</span>
  <span class="na">datasources</span><span class="pi">:</span>
    <span class="na">default</span><span class="pi">:</span>
      <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enable Flyway for the <code>default</code> datasource.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Configuring multiple data sources is as simple as enabling Flyway for each one. You can also specify directories that will be used for migrating each data source. Review the <a href="https://micronaut-projects.github.io/micronaut-flyway/latest/guide/">Micronaut Flyway documentation</a> for additional details.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Flyway migration will be automatically triggered before your Micronaut application starts. Flyway will read migration commands in the <code>resources/db/migration/</code> directory, execute them if necessary, and verify that the configured data source is consistent with them.</p>
</div>
<div class="paragraph">
<p>Create the following migration files with the database schema creation:</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/db/migration/V1__schema.sql</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="sql"><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">room</span><span class="p">;</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">message</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">room</span> <span class="p">(</span>
    <span class="n">id</span>   <span class="nb">BIGINT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">UNIQUE</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">name</span>  <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">UNIQUE</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">message</span> <span class="p">(</span>
    <span class="n">id</span>   <span class="nb">BIGINT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="k">UNIQUE</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">content</span>  <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">room_id</span> <span class="nb">BIGINT</span><span class="p">,</span>
    <span class="n">date_created</span> <span class="nb">datetime</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">INDEX</span> <span class="n">r_id</span> <span class="p">(</span><span class="n">room_id</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">room_id</span><span class="p">)</span>
        <span class="k">REFERENCES</span> <span class="n">room</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
        <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span>
<span class="p">);</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="entities">10.4. Entities</h3>
<div class="paragraph">
<p>The application contains two entities with a one-to-many relationship.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/entities/Room.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.entities</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.core.annotation.Nullable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.annotation.GeneratedValue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.annotation.Id</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.annotation.MappedEntity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.annotation.Relation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@MappedEntity</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Room</span> <span class="o">{</span>
    <span class="nd">@Id</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="nc">GeneratedValue</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="nd">@Relation</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">Relation</span><span class="o">.</span><span class="na">Kind</span><span class="o">.</span><span class="na">ONE_TO_MANY</span><span class="o">,</span> <span class="n">mappedBy</span> <span class="o">=</span> <span class="s">"room"</span><span class="o">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="nd">@Nullable</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="n">messages</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Nullable</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="nf">getMessages</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">messages</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMessages</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">&gt;</span> <span class="n">messages</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">messages</span> <span class="o">=</span> <span class="n">messages</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"Room{"</span> <span class="o">+</span>
                <span class="s">"id="</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span>
                <span class="s">", name='"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
                <span class="sc">'}'</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MappedEntity</code> to map the class to the table defined in the schema.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies the ID of an entity</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specifies that the property value is generated by the database and not included in inserts</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can specify a relationship (one-to-one, one-to-many, etc.) with the <code>@Relation</code> annotation.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/entities/Message.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.entities</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.core.annotation.Creator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.core.annotation.NonNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.core.annotation.Nullable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.annotation.DateCreated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.annotation.GeneratedValue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.annotation.Id</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.annotation.MappedEntity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.annotation.Relation</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.validation.constraints.NotBlank</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.Instant</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.ZoneId</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.format.DateTimeFormatter</span><span class="o">;</span>

<span class="nd">@MappedEntity</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Message</span> <span class="o">{</span>
    <span class="nd">@Id</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="nc">GeneratedValue</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@NonNull</span>
    <span class="nd">@NotBlank</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">content</span><span class="o">;</span>

    <span class="nd">@Nullable</span>
    <span class="nd">@Relation</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">Relation</span><span class="o">.</span><span class="na">Kind</span><span class="o">.</span><span class="na">MANY_TO_ONE</span><span class="o">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="kd">private</span> <span class="nc">Room</span> <span class="n">room</span><span class="o">;</span>

    <span class="nd">@DateCreated</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="nd">@Nullable</span>
    <span class="kd">private</span> <span class="nc">Instant</span> <span class="n">dateCreated</span><span class="o">;</span>

    <span class="nd">@Creator</span> <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="kd">public</span> <span class="nf">Message</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">Message</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">String</span> <span class="n">content</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Room</span> <span class="n">room</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">room</span> <span class="o">=</span> <span class="n">room</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@NonNull</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getContent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">content</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContent</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Nullable</span>
    <span class="kd">public</span> <span class="nc">Instant</span> <span class="nf">getDateCreated</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">dateCreated</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDateCreated</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Instant</span> <span class="n">dateCreated</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dateCreated</span> <span class="o">=</span> <span class="n">dateCreated</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Nullable</span>
    <span class="kd">public</span> <span class="nc">Room</span> <span class="nf">getRoom</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">room</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRoom</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Room</span> <span class="n">room</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">room</span> <span class="o">=</span> <span class="n">room</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"Message{"</span> <span class="o">+</span>
                <span class="s">"id="</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span>
                <span class="s">", content='"</span> <span class="o">+</span> <span class="n">content</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
                <span class="sc">'}'</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PATTERN</span> <span class="o">=</span> <span class="s">"MMM:dd HH:mm:ss"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">formattedDateCreated</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">DateTimeFormatter</span> <span class="n">formatter</span> <span class="o">=</span> <span class="nc">DateTimeFormatter</span><span class="o">.</span><span class="na">ofPattern</span><span class="o">(</span><span class="no">PATTERN</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withZone</span><span class="o">(</span><span class="nc">ZoneId</span><span class="o">.</span><span class="na">systemDefault</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">dateCreated</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MappedEntity</code> to map the class to the table defined in the schema.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies the ID of an entity</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Specifies that the property value is generated by the database and not included in inserts</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You can specify a relationship (one-to-one, one-to-many, etc.) with the <code>@Relation</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Micronaut Data assigns a data created value (such as a <code>java.time.Instant</code>) prior to an insert.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Annotate with <code>@Creator</code> to provide a hint as to which constructor is the primary constructor.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="models">10.5. Models</h3>
<div class="paragraph">
<p>The application includes a POJO to map the form submission when the user submits a message to a room.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/models/MessageForm.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.models</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.core.annotation.NonNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.serde.annotation.Serdeable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.validation.constraints.NotBlank</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.validation.constraints.NotNull</span><span class="o">;</span>

<span class="nd">@Serdeable</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageForm</span> <span class="o">{</span>

    <span class="nd">@NonNull</span>
    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Long</span> <span class="n">room</span><span class="o">;</span>

    <span class="nd">@NonNull</span>
    <span class="nd">@NotBlank</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">content</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MessageForm</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Long</span> <span class="n">room</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nc">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">room</span> <span class="o">=</span> <span class="n">room</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@NonNull</span>
    <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">getRoom</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">room</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@NonNull</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getContent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">content</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The application includes a POJO which represents a room&#8217;s message.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/models/RoomMessage.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.models</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.core.annotation.NonNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.core.annotation.Nullable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.serde.annotation.Serdeable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.validation.constraints.NotBlank</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.Instant</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.ZoneId</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.format.DateTimeFormatter</span><span class="o">;</span>

<span class="nd">@Serdeable</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RoomMessage</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">PATTERN</span> <span class="o">=</span> <span class="s">"MMM:dd HH:mm:ss"</span><span class="o">;</span>

    <span class="nd">@NonNull</span>
    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@NonNull</span>
    <span class="nd">@NotNull</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Long</span> <span class="n">room</span><span class="o">;</span>

    <span class="nd">@NonNull</span>
    <span class="nd">@NotBlank</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">content</span><span class="o">;</span>

    <span class="nd">@Nullable</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Instant</span> <span class="n">dateCreated</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RoomMessage</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span>
                       <span class="nd">@NonNull</span> <span class="nc">Long</span> <span class="n">room</span><span class="o">,</span>
                       <span class="nd">@NonNull</span> <span class="nc">String</span> <span class="n">content</span><span class="o">,</span>
                       <span class="nd">@Nullable</span> <span class="nc">Instant</span> <span class="n">dateCreated</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">room</span> <span class="o">=</span> <span class="n">room</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">dateCreated</span> <span class="o">=</span> <span class="n">dateCreated</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@NonNull</span>
    <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@NonNull</span>
    <span class="kd">public</span> <span class="nc">Long</span> <span class="nf">getRoom</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">room</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@NonNull</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getContent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">content</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Nullable</span>
    <span class="kd">public</span> <span class="nc">Instant</span> <span class="nf">getDateCreated</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">dateCreated</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">formattedDateCreated</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">DateTimeFormatter</span> <span class="n">formatter</span> <span class="o">=</span> <span class="nc">DateTimeFormatter</span><span class="o">.</span><span class="na">ofPattern</span><span class="o">(</span><span class="no">PATTERN</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withZone</span><span class="o">(</span><span class="nc">ZoneId</span><span class="o">.</span><span class="na">systemDefault</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">formatter</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">dateCreated</span><span class="o">);</span>
    <span class="o">}</span>


<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="repositories">10.6. Repositories</h3>
<div class="paragraph">
<p>The application includes a repository per entity.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/repositories/MessageRepository.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.repositories</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">example.micronaut.entities.Message</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.jdbc.annotation.JdbcRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.model.query.builder.sql.Dialect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.repository.CrudRepository</span><span class="o">;</span>

<span class="nd">@JdbcRepository</span><span class="o">(</span><span class="n">dialect</span> <span class="o">=</span> <span class="nc">Dialect</span><span class="o">.</span><span class="na">MYSQL</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MessageRepository</span> <span class="kd">extends</span> <span class="nc">CrudRepository</span><span class="o">&lt;</span><span class="nc">Message</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@JdbcRepository</code> with a specific dialect.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>By extending <code>CrudRepository</code> you enable automatic generation of CRUD (Create, Read, Update, Delete) operations.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/repositories/RoomRepository.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.repositories</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.core.annotation.NonNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.annotation.Id</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.annotation.Join</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.jdbc.annotation.JdbcRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.model.query.builder.sql.Dialect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.data.repository.CrudRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">example.micronaut.entities.Room</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.validation.constraints.NotBlank</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="nd">@JdbcRepository</span><span class="o">(</span><span class="n">dialect</span> <span class="o">=</span> <span class="nc">Dialect</span><span class="o">.</span><span class="na">MYSQL</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">RoomRepository</span> <span class="kd">extends</span> <span class="nc">CrudRepository</span><span class="o">&lt;</span><span class="nc">Room</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="nd">@NonNull</span>
    <span class="nc">Room</span> <span class="nf">save</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nd">@NotBlank</span> <span class="nc">String</span> <span class="n">name</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="nd">@Id</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="nd">@NotBlank</span> <span class="nc">String</span> <span class="n">name</span><span class="o">);</span>

    <span class="nd">@Join</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"messages"</span><span class="o">,</span> <span class="n">type</span> <span class="o">=</span> <span class="nc">Join</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">LEFT_FETCH</span><span class="o">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Room</span><span class="o">&gt;</span> <span class="nf">getById</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nd">@NotNull</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@JdbcRepository</code> with a specific dialect.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>By extending <code>CrudRepository</code> you enable automatic generation of CRUD (Create, Read, Update, Delete) operations.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>You can use the <code>@Join</code> annotation on your repository interface to specify that a <code>JOIN LEFT FETCH</code> should be executed to retrieve the associated <code>messages</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="services">10.7. Services</h3>
<div class="paragraph">
<p>The application contains a service that publishes an event when a message is saved.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/services/MessageService.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.services</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">example.micronaut.models.MessageForm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">example.micronaut.models.RoomMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.context.annotation.DefaultImplementation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.core.annotation.NonNull</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.validation.Valid</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>
<span class="nd">@DefaultImplementation</span><span class="o">(</span><span class="nc">DefaultMessageService</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MessageService</span> <span class="o">{</span>
    <span class="nd">@NonNull</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">RoomMessage</span><span class="o">&gt;</span> <span class="nf">save</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nd">@NotNull</span> <span class="nd">@Valid</span> <span class="nc">MessageForm</span> <span class="n">form</span><span class="o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can annotate an interface with <code>DefaultImplementation</code> to indicate the default implementation of a particular type, and hence ease bean replacement.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add <code>@Valid</code> to any method parameter which requires validation.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/services/DefaultMessageService.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.services</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">example.micronaut.entities.Message</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">example.micronaut.models.MessageForm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">example.micronaut.models.RoomMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">example.micronaut.repositories.MessageRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">example.micronaut.repositories.RoomRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.context.event.ApplicationEventPublisher</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.core.annotation.NonNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.inject.Singleton</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.validation.Valid</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.validation.constraints.NotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="nd">@Singleton</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultMessageService</span> <span class="kd">implements</span> <span class="nc">MessageService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MessageRepository</span> <span class="n">messageRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RoomRepository</span> <span class="n">roomRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ApplicationEventPublisher</span><span class="o">&lt;</span><span class="nc">RoomMessage</span><span class="o">&gt;</span> <span class="n">eventPublisher</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">DefaultMessageService</span><span class="o">(</span><span class="nc">MessageRepository</span> <span class="n">messageRepository</span><span class="o">,</span>
                                 <span class="nc">RoomRepository</span> <span class="n">roomRepository</span><span class="o">,</span>
                                 <span class="nc">ApplicationEventPublisher</span><span class="o">&lt;</span><span class="nc">RoomMessage</span><span class="o">&gt;</span> <span class="n">eventPublisher</span><span class="o">)</span> <span class="o">{</span>  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="k">this</span><span class="o">.</span><span class="na">messageRepository</span> <span class="o">=</span> <span class="n">messageRepository</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">roomRepository</span> <span class="o">=</span> <span class="n">roomRepository</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">eventPublisher</span> <span class="o">=</span> <span class="n">eventPublisher</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@NonNull</span>
    <span class="kd">public</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">RoomMessage</span><span class="o">&gt;</span> <span class="nf">save</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nd">@NotNull</span> <span class="nd">@Valid</span> <span class="nc">MessageForm</span> <span class="n">form</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">roomRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getRoom</span><span class="o">())</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">room</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="nc">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="n">messageRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Message</span><span class="o">(</span><span class="n">form</span><span class="o">.</span><span class="na">getContent</span><span class="o">(),</span> <span class="n">room</span><span class="o">));</span>
                    <span class="nc">RoomMessage</span> <span class="n">roomMessage</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RoomMessage</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span>
                            <span class="n">form</span><span class="o">.</span><span class="na">getRoom</span><span class="o">(),</span>
                            <span class="n">form</span><span class="o">.</span><span class="na">getContent</span><span class="o">(),</span>
                            <span class="n">message</span><span class="o">.</span><span class="na">getDateCreated</span><span class="o">());</span>
                    <span class="n">eventPublisher</span><span class="o">.</span><span class="na">publishEvent</span><span class="o">(</span><span class="n">roomMessage</span><span class="o">);</span> <i class="conum" data-value="2"></i><b>(2)</b>
                    <span class="k">return</span> <span class="n">roomMessage</span><span class="o">;</span>
                <span class="o">});</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>To publish an event, use dependency injection to obtain an instance of <code>ApplicationEventPublisher</code> where the generic type is the type of event and invoke the <code>publishEvent</code> method with your event object. For performance reasons, it’s advisable to inject an instance of <code>ApplicationEventPublisher</code> with a generic type parameter - <code>ApplicationEventPublisher&lt;RoomMessage&gt;</code>.</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="static-resources">10.7.1. Static Resources</h4>
<div class="paragraph">
<p>Update <code>application.yml</code> to add static resource configuration:</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<a href="https://micronaut.io/2023/02/19/micronaut-framework-4-0-and-snakeyaml-transitive-dependency/">Since Micronaut Framework 4.0, to use YAML configuration, you have to add the YAML dependency</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/application.yml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="yaml"><span class="na">micronaut</span><span class="pi">:</span>
  <span class="na">router</span><span class="pi">:</span>
    <span class="na">static-resources</span><span class="pi">:</span>
      <span class="na">assets</span><span class="pi">:</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="na">paths</span><span class="pi">:</span> <span class="s1">'</span><span class="s">classpath:assets'</span>
        <span class="na">mapping</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/assets/**'</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the Framework to resolve static resources from the request path <code>/assets/**</code> in <code>src/main/resources/assets</code>.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="views">11. Views</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To use the <a href="https://www.thymeleaf.org/">Thymeleaf</a> Java template engine to render views in a Micronaut application, add the following dependency on your classpath.</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="groovy"><span class="n">implementation</span><span class="o">(</span><span class="s2">"io.micronaut.views:micronaut-views-thymeleaf"</span><span class="o">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The initial application uses Thymeleaf Fragments to organize the views.</p>
</div>
<div class="paragraph">
<p>It uses a root layout:</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/views/layout.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">th:fragment=</span><span class="s">"layout (script, content)"</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;title&gt;</span>Chat<span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width,initial-scale=1"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">media=</span><span class="s">"all"</span> <span class="na">href=</span><span class="s">"/assets/stylesheets/application.css"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">media=</span><span class="s">"all"</span> <span class="na">href=</span><span class="s">"/assets/stylesheets/scaffolds.css"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;script </span><span class="na">th:replace=</span><span class="s">"${script}"</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">th:replace=</span><span class="s">"${content}"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="properties">11.1. Properties</h3>
<div class="paragraph">
<p>Create a default <code>messages.properties</code> file:</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/i18n/messages.properties</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">chat</span><span class="p">=</span><span class="s">Chat</span>
<span class="py">message.send</span><span class="p">=</span><span class="s">Send</span>
<span class="py">message.new</span><span class="p">=</span><span class="s">New Message</span>
<span class="py">room.name</span><span class="p">=</span><span class="s">Name</span>
<span class="py">room.list</span><span class="p">=</span><span class="s">Rooms</span>
<span class="py">room.new</span><span class="p">=</span><span class="s">New Room</span>
<span class="py">room.edit</span><span class="p">=</span><span class="s">Editing Room</span>
<span class="py">room.update</span><span class="p">=</span><span class="s">Update Room</span>
<span class="py">room.create</span><span class="p">=</span><span class="s">Create Room</span>
<span class="py">action.back</span><span class="p">=</span><span class="s">Back</span>
<span class="py">action.show</span><span class="p">=</span><span class="s">Show</span>
<span class="py">action.edit</span><span class="p">=</span><span class="s">Edit</span>
<span class="py">action.destroy</span><span class="p">=</span><span class="s">Destroy</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a <code>messages_es.properties</code> file for the Spanish locale:</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/i18n/messages_es.properties</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="properties"><span class="py">chat</span><span class="p">=</span><span class="s">Chat</span>
<span class="py">message.send</span><span class="p">=</span><span class="s">Enviar</span>
<span class="py">message.new</span><span class="p">=</span><span class="s">Crear Mensaje</span>
<span class="py">room.name</span><span class="p">=</span><span class="s">Nombre</span>
<span class="py">room.list</span><span class="p">=</span><span class="s">Salas</span>
<span class="py">room.new</span><span class="p">=</span><span class="s">Nueva Sala</span>
<span class="py">room.edit</span><span class="p">=</span><span class="s">Editar Sala</span>
<span class="py">room.update</span><span class="p">=</span><span class="s">Actualizar Sala</span>
<span class="py">room.create</span><span class="p">=</span><span class="s">Crear Sala</span>
<span class="py">action.back</span><span class="p">=</span><span class="s">Volver</span>
<span class="py">action.show</span><span class="p">=</span><span class="s">Mostrar</span>
<span class="py">action.edit</span><span class="p">=</span><span class="s">Editar</span>
<span class="py">action.destroy</span><span class="p">=</span><span class="s">Eliminar</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="message-source">11.2. Message Source</h3>
<div class="paragraph">
<p>Create a <code>MessageSource</code> that uses the previous properties files:</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/i18n/MessageSourceFactory.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.i18n</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.context.MessageSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.context.annotation.Factory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.context.i18n.ResourceBundleMessageSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.inject.Singleton</span><span class="o">;</span>

<span class="nd">@Factory</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">MessageSourceFactory</span> <span class="o">{</span>

    <span class="nd">@Singleton</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nc">MessageSource</span> <span class="nf">createMessageSource</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ResourceBundleMessageSource</span><span class="o">(</span><span class="s">"i18n.messages"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A class annotated with the <code>@Factory</code> annotated is a factory. It provides one or more methods annotated with a bean scope annotation (e.g. <code>@Singleton</code>). Read more about <a href="https://docs.micronaut.io/latest/guide/#factories">Bean factories</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="controllers">11.3. Controllers</h3>
<div class="paragraph">
<p>The apex url is redirected to <code>/rooms</code>.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/controllers/HomeController.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.controllers</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Get</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.URI</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URISyntaxException</span><span class="o">;</span>

<span class="nd">@Controller</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeController</span> <span class="o">{</span>
    <span class="nd">@Get</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nc">HttpResponse</span><span class="o">&lt;?&gt;</span> <span class="n">index</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">URISyntaxException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">HttpResponse</span><span class="o">.</span><span class="na">seeOther</span><span class="o">(</span><span class="k">new</span> <span class="no">URI</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the method to an HTTP GET request.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have an abstract class to simplify redirection:</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/controllers/ApplicationController.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.controllers</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.core.annotation.NonNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.MediaType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.uri.UriBuilder</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ApplicationController</span> <span class="o">{</span>
    <span class="nd">@NonNull</span>
    <span class="kd">protected</span> <span class="nc">HttpResponse</span><span class="o">&lt;?&gt;</span> <span class="n">redirectTo</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">CharSequence</span> <span class="n">uri</span><span class="o">,</span>
                                         <span class="nd">@NonNull</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">HttpResponse</span><span class="o">.</span><span class="na">seeOther</span><span class="o">(</span><span class="nc">UriBuilder</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">uri</span><span class="o">)</span>
                <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">""</span> <span class="o">+</span> <span class="n">id</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Create CRUD controllers for <code>Room</code>.</p>
</div>
<div class="sect3">
<h4 id="rooms-index-controller">11.3.1. Rooms Index Controller</h4>
<div class="paragraph">
<p>Create a controller which displays a list of rooms.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/controllers/RoomsControllerIndex.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.controllers</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">example.micronaut.repositories.RoomRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.MediaType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Get</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Produces</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.TaskExecutors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.annotation.ExecuteOn</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.views.View</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="nd">@Controller</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RoomsControllerIndex</span> <span class="kd">extends</span> <span class="nc">RoomsController</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ROOMS</span> <span class="o">=</span> <span class="s">"rooms"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RoomsControllerIndex</span><span class="o">(</span><span class="nc">RoomRepository</span> <span class="n">roomRepository</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="kd">super</span><span class="o">(</span><span class="n">roomRepository</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@ExecuteOn</span><span class="o">(</span><span class="nc">TaskExecutors</span><span class="o">.</span><span class="na">BLOCKING</span><span class="o">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nd">@View</span><span class="o">(</span><span class="s">"/rooms/index"</span><span class="o">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="nd">@Get</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)</span> <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">index</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="no">ROOMS</span><span class="o">,</span> <span class="n">roomRepository</span><span class="o">.</span><span class="na">findAll</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/rooms</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use constructor injection to inject a bean of type <code>RoomRepository</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>It is critical that any blocking I/O operations (such as fetching the data from the database) are offloaded to a separate thread pool that does not block the Event loop.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use <a href="https://micronaut-projects.github.io/micronaut-views/latest/api/io/micronaut/views/View.html">View</a> annotation to specify which template to use to render the response.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the method to an HTTP GET request.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Set the response content-type to <code>HTML</code> with the <code>@Produces</code> annotation.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="rooms-index-views">Rooms Index Views</h5>
<div class="paragraph">
<p>The controller uses Thymeleaf to render server-side HTML.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/views/rooms/index.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span> <span class="na">th:replace=</span><span class="s">"~{layout :: layout(~{::script},~{::main})}"</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;script&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;main&gt;</span>
        <span class="nt">&lt;h1</span> <span class="na">th:text=</span><span class="s">"#{room.list}"</span><span class="nt">&gt;&lt;/h1&gt;</span>
<span class="nt">&lt;table</span> <span class="na">th:replace=</span><span class="s">"rooms/_table :: table(${rooms})"</span><span class="nt">&gt;&lt;/table&gt;</span>
        <span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/rooms/create"</span>
           <span class="na">th:text=</span><span class="s">"#{room.new}"</span><span class="nt">&gt;&lt;/a&gt;</span>
    <span class="nt">&lt;/main&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/views/rooms/_table.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;table</span> <span class="na">th:fragment=</span><span class="s">"table(rooms)"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;thead&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
        <span class="nt">&lt;th</span> <span class="na">th:text=</span><span class="s">"#{room.name}"</span><span class="nt">&gt;&lt;/th&gt;</span>
        <span class="nt">&lt;th</span> <span class="na">colspan=</span><span class="s">"3"</span><span class="nt">&gt;&lt;/th&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
    <span class="nt">&lt;/thead&gt;</span>
    <span class="nt">&lt;tbody&gt;</span>
<span class="nt">&lt;tr</span> <span class="na">th:each=</span><span class="s">"room : ${rooms}"</span> <span class="na">th:include=</span><span class="s">"rooms/_tr :: tr(${room})"</span><span class="nt">&gt;&lt;/tr&gt;</span>
    <span class="nt">&lt;/tbody&gt;</span>
<span class="nt">&lt;/table&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/views/rooms/_tr.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;tr</span> <span class="na">th:fragment=</span><span class="s">"tr(room)"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">th:text=</span><span class="s">"${room.name}"</span><span class="nt">&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;&lt;a</span> <span class="na">th:href=</span><span class="s">"@{|/rooms/${room.id}|}"</span> <span class="na">th:text=</span><span class="s">"#{action.show}"</span><span class="nt">&gt;&lt;/a&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;&lt;a</span> <span class="na">th:href=</span><span class="s">"@{|/rooms/${room.id}/edit|}"</span> <span class="na">th:text=</span><span class="s">"#{action.edit}"</span><span class="nt">&gt;&lt;/a&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>
        <span class="nt">&lt;form</span> <span class="na">th:action=</span><span class="s">"@{|/rooms/${room.id}/delete|}"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">onsubmit=</span><span class="s">"return confirm('Are you sure?');"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"id"</span> <span class="na">th:value=</span><span class="s">"${room.id}"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">th:value=</span><span class="s">"#{action.destroy}"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="rooms-show-controller">11.3.2. Rooms Show Controller</h4>
<div class="paragraph">
<p>Create a controller which displays room.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/controllers/RoomsControllerShow.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.controllers</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">example.micronaut.repositories.RoomRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.MediaType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Get</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Produces</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.TaskExecutors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.annotation.ExecuteOn</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.views.View</span><span class="o">;</span>

<span class="nd">@Controller</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RoomsControllerShow</span> <span class="kd">extends</span> <span class="nc">RoomsController</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">RoomsControllerShow</span><span class="o">(</span><span class="nc">RoomRepository</span> <span class="n">roomRepository</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="kd">super</span><span class="o">(</span><span class="n">roomRepository</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@ExecuteOn</span><span class="o">(</span><span class="nc">TaskExecutors</span><span class="o">.</span><span class="na">BLOCKING</span><span class="o">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nd">@View</span><span class="o">(</span><span class="s">"/rooms/show"</span><span class="o">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="nd">@Get</span><span class="o">(</span><span class="s">"/{id}"</span><span class="o">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)</span> <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="nc">HttpResponse</span><span class="o">&lt;?&gt;</span> <span class="n">show</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="k">return</span> <span class="nf">modelResponse</span><span class="o">(</span><span class="n">roomRepository</span><span class="o">.</span><span class="na">getById</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">orElse</span><span class="o">(</span><span class="kc">null</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/rooms</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use constructor injection to inject a bean of type <code>RoomRepository</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>It is critical that any blocking I/O operations (such as fetching the data from the database) are offloaded to a separate thread pool that does not block the Event loop.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use <a href="https://micronaut-projects.github.io/micronaut-views/latest/api/io/micronaut/views/View.html">View</a> annotation to specify which template to use to render the response.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the method to an HTTP GET request.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Set the response content-type to <code>HTML</code> with the <code>@Produces</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>You can define path variables with a RFC-6570 URI template in the HTTP Method annotation value. The method argument can optionally be annotated with <code>@PathVariable</code>.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="rooms-show-views">Rooms Show Views</h5>
<div class="paragraph">
<p>Add Thymeleaf templates to render server-side HTML.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/views/rooms/show.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span> <span class="na">th:replace=</span><span class="s">"~{layout :: layout(~{::script},~{::main})}"</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;script&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;main&gt;</span>
        <span class="nt">&lt;p</span> <span class="na">th:replace=</span><span class="s">"rooms/_room :: room(${room})"</span><span class="nt">&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;p&gt;</span>
            <span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{|/rooms/${room.id}/edit|}"</span> <span class="na">th:text=</span><span class="s">"#{action.edit}"</span><span class="nt">&gt;&lt;/a&gt;</span> |
            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/rooms"</span> <span class="na">th:text=</span><span class="s">"#{action.back}"</span><span class="nt">&gt;&lt;/a&gt;</span>
        <span class="nt">&lt;/p&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"messages"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">th:each=</span><span class="s">"message : ${room.messages}"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;p</span> <span class="na">th:replace=</span><span class="s">"messages/_message :: message(${message})"</span><span class="nt">&gt;&lt;/p&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{|/rooms/${room.id}/messages/create|}"</span> <span class="na">th:text=</span><span class="s">"#{message.new}"</span><span class="nt">&gt;&lt;/a&gt;</span>
    <span class="nt">&lt;/main&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/views/rooms/_room.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;p</span> <span class="na">th:fragment=</span><span class="s">"room(room)"</span> <span class="na">th:id=</span><span class="s">"@{|room_${room.id}|}"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;strong</span> <span class="na">th:text=</span><span class="s">"#{room.name}"</span><span class="nt">&gt;</span>:<span class="nt">&lt;/strong&gt;</span>
    [[${room.name}]]
<span class="nt">&lt;/p&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="rooms-create-controller">11.3.3. Rooms Create Controller</h4>
<div class="paragraph">
<p>Create a controller which displays a form to create a room.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/controllers/RoomsControllerCreate.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.controllers</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">example.micronaut.repositories.RoomRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.MediaType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Get</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Produces</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.views.View</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="nd">@Controller</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RoomsControllerCreate</span> <span class="kd">extends</span> <span class="nc">RoomsController</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">RoomsControllerCreate</span><span class="o">(</span><span class="nc">RoomRepository</span> <span class="n">roomRepository</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="kd">super</span><span class="o">(</span><span class="n">roomRepository</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@View</span><span class="o">(</span><span class="s">"/rooms/create"</span><span class="o">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nd">@Get</span><span class="o">(</span><span class="s">"/create"</span><span class="o">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">emptyMap</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/rooms</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use constructor injection to inject a bean of type <code>RoomRepository</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use <a href="https://micronaut-projects.github.io/micronaut-views/latest/api/io/micronaut/views/View.html">View</a> annotation to specify which template to use to render the response.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the method to an HTTP GET request.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set the response content-type to <code>HTML</code> with the <code>@Produces</code> annotation.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="rooms-create-views">Rooms Create Views</h5>
<div class="paragraph">
<p>Add Thymeleaf templates to render a form.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/views/rooms/create.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span> <span class="na">th:replace=</span><span class="s">"~{layout :: layout(~{::script},~{::main})}"</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;script&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;main&gt;</span>
        <span class="nt">&lt;h1</span> <span class="na">th:text=</span><span class="s">"#{room.new}"</span><span class="nt">&gt;&lt;/h1&gt;</span>
<span class="nt">&lt;form</span> <span class="na">th:replace=</span><span class="s">"rooms/_create :: create()"</span><span class="nt">&gt;&lt;/form&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/rooms"</span> <span class="na">th:text=</span><span class="s">"#{action.back}"</span><span class="nt">&gt;&lt;/a&gt;</span>
    <span class="nt">&lt;/main&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/views/rooms/_create.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;form</span> <span class="na">th:fragment=</span><span class="s">"create()"</span>
      <span class="na">action=</span><span class="s">"/rooms"</span>
      <span class="na">accept-charset=</span><span class="s">"UTF-8"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"room_name"</span> <span class="na">th:text=</span><span class="s">"#{room.name}"</span><span class="nt">&gt;&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"name"</span> <span class="na">id=</span><span class="s">"room_name"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">th:value=</span><span class="s">"#{room.create}"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="rooms-save-controller">11.3.4. Rooms Save Controller</h4>
<div class="paragraph">
<p>Create a controller which handles the room creation form submission.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/controllers/RoomsControllerSave.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.controllers</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">example.micronaut.repositories.RoomRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.MediaType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Body</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Consumes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Post</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Produces</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.TaskExecutors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.annotation.ExecuteOn</span><span class="o">;</span>

<span class="nd">@Controller</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RoomsControllerSave</span> <span class="kd">extends</span> <span class="nc">RoomsController</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">RoomsControllerSave</span><span class="o">(</span><span class="nc">RoomRepository</span> <span class="n">roomRepository</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="kd">super</span><span class="o">(</span><span class="n">roomRepository</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@ExecuteOn</span><span class="o">(</span><span class="nc">TaskExecutors</span><span class="o">.</span><span class="na">BLOCKING</span><span class="o">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="nd">@Consumes</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_FORM_URLENCODED</span><span class="o">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="nd">@Post</span> <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="nc">HttpResponse</span><span class="o">&lt;?&gt;</span> <span class="n">save</span><span class="o">(</span><span class="nd">@Body</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="k">return</span> <span class="nf">redirectTo</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">,</span> <span class="n">roomRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">getId</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/rooms</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use constructor injection to inject a bean of type <code>RoomRepository</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>It is critical that any blocking I/O operations (such as fetching the data from the database) are offloaded to a separate thread pool that does not block the Event loop.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the response content-type to <code>HTML</code> with the <code>@Produces</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>A Micronaut controller action consumes <code>application/json</code> by default. Consuming other content types is supported with the <code>@Consumes</code> annotation or the consumes member of any HTTP method annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation maps the method to an HTTP POST request.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>You can use a qualifier within the HTTP request body. For example, you can use a reference to a nested JSON attribute.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="rooms-edit-controller">11.3.5. Rooms Edit Controller</h4>
<div class="paragraph">
<p>Create a controller which shows a form to edit a room.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/controllers/RoomsControllerEdit.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.controllers</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">example.micronaut.repositories.RoomRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.MediaType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Get</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Produces</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.TaskExecutors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.annotation.ExecuteOn</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.views.View</span><span class="o">;</span>

<span class="nd">@Controller</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RoomsControllerEdit</span> <span class="kd">extends</span> <span class="nc">RoomsController</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">RoomsControllerEdit</span><span class="o">(</span><span class="nc">RoomRepository</span> <span class="n">roomRepository</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="kd">super</span><span class="o">(</span><span class="n">roomRepository</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@ExecuteOn</span><span class="o">(</span><span class="nc">TaskExecutors</span><span class="o">.</span><span class="na">BLOCKING</span><span class="o">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nd">@View</span><span class="o">(</span><span class="s">"/rooms/edit"</span><span class="o">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="nd">@Get</span><span class="o">(</span><span class="s">"/{id}/edit"</span><span class="o">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)</span> <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="nc">HttpResponse</span><span class="o">&lt;?&gt;</span> <span class="n">edit</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="k">return</span> <span class="nf">modelResponse</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/rooms</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use constructor injection to inject a bean of type <code>RoomRepository</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>It is critical that any blocking I/O operations (such as fetching the data from the database) are offloaded to a separate thread pool that does not block the Event loop.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use <a href="https://micronaut-projects.github.io/micronaut-views/latest/api/io/micronaut/views/View.html">View</a> annotation to specify which template to use to render the response.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the method to an HTTP GET request.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Set the response content-type to <code>HTML</code> with the <code>@Produces</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>You can define path variables with a RFC-6570 URI template in the HTTP Method annotation value. The method argument can optionally be annotated with <code>@PathVariable</code>.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="rooms-edit-views">Rooms Edit Views</h5>
<div class="paragraph">
<p>Add Thymeleaf templates to render an edit form.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/views/rooms/edit.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span> <span class="na">th:replace=</span><span class="s">"~{layout :: layout(~{::script},~{::main})}"</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;script&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;main&gt;</span>
        <span class="nt">&lt;h1</span> <span class="na">th:text=</span><span class="s">"#{room.edit}"</span><span class="nt">&gt;&lt;/h1&gt;</span>
<span class="nt">&lt;p</span> <span class="na">th:replace=</span><span class="s">"rooms/_edit :: edit(${room})"</span><span class="nt">&gt;&lt;/p&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{|/rooms/${room.id}|}"</span> <span class="na">th:text=</span><span class="s">"#{action.show}"</span><span class="nt">&gt;&lt;/a&gt;</span> |
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"/rooms"</span> <span class="na">th:text=</span><span class="s">"#{action.back}"</span><span class="nt">&gt;&lt;/a&gt;</span>
    <span class="nt">&lt;/main&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/views/rooms/_edit.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;form</span> <span class="na">th:fragment=</span><span class="s">"edit(room)"</span>
      <span class="na">action=</span><span class="s">"/rooms/update"</span>
      <span class="na">accept-charset=</span><span class="s">"UTF-8"</span>
      <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">th:value=</span><span class="s">"${room.id}"</span> <span class="na">name=</span><span class="s">"id"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"room_name"</span> <span class="na">th:text=</span><span class="s">"#{room.name}"</span><span class="nt">&gt;&lt;/label&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">th:value=</span><span class="s">"${room.name}"</span> <span class="na">name=</span><span class="s">"name"</span> <span class="na">id=</span><span class="s">"room_name"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">th:value=</span><span class="s">"#{room.update}"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="rooms-update-controller">11.3.6. Rooms Update Controller</h4>
<div class="paragraph">
<p>Create a controller which handles the room update form submission.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/controllers/RoomsControllerUpdate.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.controllers</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">example.micronaut.repositories.RoomRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.MediaType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Body</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Consumes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Post</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Produces</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.TaskExecutors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.annotation.ExecuteOn</span><span class="o">;</span>

<span class="nd">@Controller</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RoomsControllerUpdate</span> <span class="kd">extends</span> <span class="nc">RoomsController</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">RoomsControllerUpdate</span><span class="o">(</span><span class="nc">RoomRepository</span> <span class="n">roomRepository</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="kd">super</span><span class="o">(</span><span class="n">roomRepository</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@ExecuteOn</span><span class="o">(</span><span class="nc">TaskExecutors</span><span class="o">.</span><span class="na">BLOCKING</span><span class="o">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="nd">@Consumes</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_FORM_URLENCODED</span><span class="o">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="nd">@Post</span><span class="o">(</span><span class="s">"/update"</span><span class="o">)</span> <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="nc">HttpResponse</span><span class="o">&lt;?&gt;</span> <span class="n">update</span><span class="o">(</span><span class="nd">@Body</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span>  <i class="conum" data-value="7"></i><b>(7)</b>
                           <span class="nd">@Body</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="n">roomRepository</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
        <span class="k">return</span> <span class="nf">redirectTo</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">,</span> <span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/rooms</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use constructor injection to inject a bean of type <code>RoomRepository</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>It is critical that any blocking I/O operations (such as fetching the data from the database) are offloaded to a separate thread pool that does not block the Event loop.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the response content-type to <code>HTML</code> with the <code>@Produces</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>A Micronaut controller action consumes <code>application/json</code> by default. Consuming other content types is supported with the <code>@Consumes</code> annotation or the consumes member of any HTTP method annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation maps the method to an HTTP POST request.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>You can use a qualifier within the HTTP request body. For example, you can use a reference to a nested JSON attribute.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="rooms-delete-controller">11.3.7. Rooms Delete Controller</h4>
<div class="paragraph">
<p>Create a controller which handles the room deletion form submission.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/controllers/RoomsControllerDelete.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.controllers</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">example.micronaut.repositories.RoomRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.MediaType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Consumes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Post</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Produces</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.TaskExecutors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.annotation.ExecuteOn</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.URI</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URISyntaxException</span><span class="o">;</span>

<span class="nd">@Controller</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RoomsControllerDelete</span> <span class="kd">extends</span> <span class="nc">RoomsController</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">RoomsControllerDelete</span><span class="o">(</span><span class="nc">RoomRepository</span> <span class="n">roomRepository</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="kd">super</span><span class="o">(</span><span class="n">roomRepository</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@ExecuteOn</span><span class="o">(</span><span class="nc">TaskExecutors</span><span class="o">.</span><span class="na">BLOCKING</span><span class="o">)</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="nd">@Consumes</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_FORM_URLENCODED</span><span class="o">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="nd">@Post</span><span class="o">(</span><span class="s">"/{id}/delete"</span><span class="o">)</span> <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="nc">HttpResponse</span><span class="o">&lt;?&gt;</span> <span class="n">delete</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">URISyntaxException</span> <span class="o">{</span> <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="n">roomRepository</span><span class="o">.</span><span class="na">deleteById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">HttpResponse</span><span class="o">.</span><span class="na">seeOther</span><span class="o">(</span><span class="k">new</span> <span class="no">URI</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/rooms</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use constructor injection to inject a bean of type <code>RoomRepository</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>It is critical that any blocking I/O operations (such as fetching the data from the database) are offloaded to a separate thread pool that does not block the Event loop.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the response content-type to <code>HTML</code> with the <code>@Produces</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>A Micronaut controller action consumes <code>application/json</code> by default. Consuming other content types is supported with the <code>@Consumes</code> annotation or the consumes member of any HTTP method annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation maps the method to an HTTP POST request.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>You can define path variables with a RFC-6570 URI template in the HTTP Method annotation value. The method argument can optionally be annotated with <code>@PathVariable</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="message-create-controller">11.3.8. Message Create Controller</h4>
<div class="paragraph">
<p>Create a controller to display a form to create a message within a room.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/controllers/MessagesControllerCreate.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.controllers</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">example.micronaut.repositories.RoomRepository</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.core.annotation.NonNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.MediaType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Get</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Produces</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.TaskExecutors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.annotation.ExecuteOn</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.views.View</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="nd">@ExecuteOn</span><span class="o">(</span><span class="nc">TaskExecutors</span><span class="o">.</span><span class="na">BLOCKING</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@Controller</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="kd">class</span> <span class="nc">MessagesControllerCreate</span> <span class="kd">extends</span> <span class="nc">ApplicationController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">RoomRepository</span> <span class="n">roomRepository</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MessagesControllerCreate</span><span class="o">(</span><span class="nc">RoomRepository</span> <span class="n">roomRepository</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="k">this</span><span class="o">.</span><span class="na">roomRepository</span> <span class="o">=</span> <span class="n">roomRepository</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@View</span><span class="o">(</span><span class="s">"/messages/create"</span><span class="o">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="nd">@Get</span><span class="o">(</span><span class="s">"/{id}/messages/create"</span><span class="o">)</span> <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="nc">HttpResponse</span><span class="o">&lt;?&gt;</span> <span class="n">create</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="7"></i><b>(7)</b>
        <span class="k">return</span> <span class="nf">modelResponse</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">HttpResponse</span><span class="o">&lt;?&gt;</span> <span class="n">modelResponse</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">model</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="nl">HttpResponse:</span><span class="o">:</span><span class="n">ok</span><span class="o">).</span><span class="na">orElseGet</span><span class="o">(</span><span class="nl">HttpResponse:</span><span class="o">:</span><span class="n">notFound</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;&gt;</span> <span class="nf">model</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">roomRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">room</span> <span class="o">-&gt;</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="nc">RoomsController</span><span class="o">.</span><span class="na">ROOM</span><span class="o">,</span> <span class="n">room</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>It is critical that any blocking I/O operations (such as fetching the data from the database) are offloaded to a separate thread pool that does not block the Event loop.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/rooms</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use constructor injection to inject a bean of type <code>MessageService</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use <a href="https://micronaut-projects.github.io/micronaut-views/latest/api/io/micronaut/views/View.html">View</a> annotation to specify which template to use to render the response.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Set the response content-type to <code>HTML</code> with the <code>@Produces</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the method to an HTTP GET request.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>You can define path variables with a RFC-6570 URI template in the HTTP Method annotation value. The method argument can optionally be annotated with <code>@PathVariable</code>.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="message-create-views">Message Create Views</h5>
<div class="paragraph">
<p>The controller uses Thymeleaf views.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/views/messages/_create.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;form</span> <span class="na">th:fragment=</span><span class="s">"create(room)"</span>
      <span class="na">th:action=</span><span class="s">"@{|/rooms/${room.id}/messages|}"</span>
      <span class="na">accept-charset=</span><span class="s">"UTF-8"</span>
      <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"content"</span> <span class="na">id=</span><span class="s">"message_content"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">th:value=</span><span class="s">"#{message.send}"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/views/messages/_message.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="nt">&lt;p</span> <span class="na">th:fragment=</span><span class="s">"message(message)"</span> <span class="na">th:id=</span><span class="s">"@{|message_${message.id}|}"</span><span class="nt">&gt;</span>
    [[${message.formattedDateCreated()}]]: [[${message.content}]]
<span class="nt">&lt;/p&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">initial/src/main/resources/views/messages/create.html</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span> <span class="na">th:replace=</span><span class="s">"~{layout :: layout(~{::script},~{::main})}"</span> <span class="na">xmlns:th=</span><span class="s">"http://www.thymeleaf.org"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;script&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;main&gt;</span>
    <span class="nt">&lt;h1</span> <span class="na">th:text=</span><span class="s">"#{message.new}"</span><span class="nt">&gt;&lt;/h1&gt;</span>
<span class="nt">&lt;form</span> <span class="na">th:replace=</span><span class="s">"messages/_create :: create(${room})"</span><span class="nt">&gt;&lt;/form&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">th:href=</span><span class="s">"@{|/rooms/${room.id}|}"</span> <span class="na">th:text=</span><span class="s">"#{action.back}"</span><span class="nt">&gt;&lt;/a&gt;</span>
    <span class="nt">&lt;/main&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="message-save-controller">11.3.9. Message Save Controller</h4>
<div class="paragraph">
<p>Create a controller which handles the message creation form submission.</p>
</div>
<div class="listingblock">
<div class="title">initial/src/main/java/example/micronaut/controllers/MessagesControllerSave.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut.controllers</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">example.micronaut.models.MessageForm</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">example.micronaut.models.RoomMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">example.micronaut.services.MessageService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.MediaType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Body</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Consumes</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Post</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Produces</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.TaskExecutors</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.scheduling.annotation.ExecuteOn</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="nd">@ExecuteOn</span><span class="o">(</span><span class="nc">TaskExecutors</span><span class="o">.</span><span class="na">BLOCKING</span><span class="o">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@Controller</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="kd">class</span> <span class="nc">MessagesControllerSave</span> <span class="kd">extends</span> <span class="nc">ApplicationController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="no">LOG</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">MessagesControllerSave</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">MessageService</span> <span class="n">messageService</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MessagesControllerSave</span><span class="o">(</span><span class="nc">MessageService</span> <span class="n">messageService</span><span class="o">)</span> <span class="o">{</span>  <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="k">this</span><span class="o">.</span><span class="na">messageService</span> <span class="o">=</span> <span class="n">messageService</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Produces</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="nd">@Consumes</span><span class="o">(</span><span class="nc">MediaType</span><span class="o">.</span><span class="na">APPLICATION_FORM_URLENCODED</span><span class="o">)</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="nd">@Post</span><span class="o">(</span><span class="s">"/{id}/messages"</span><span class="o">)</span> <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="nc">HttpResponse</span><span class="o">&lt;?&gt;</span> <span class="n">save</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">,</span> <i class="conum" data-value="7"></i><b>(7)</b>
                         <span class="nd">@Body</span><span class="o">(</span><span class="s">"content"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span> <i class="conum" data-value="8"></i><b>(8)</b>
        <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">RoomMessage</span><span class="o">&gt;</span> <span class="n">roomMessageOptional</span> <span class="o">=</span> <span class="n">messageService</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">MessageForm</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">content</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">roomMessageOptional</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">roomMessage</span> <span class="o">-&gt;</span> <span class="n">redirectTo</span><span class="o">(</span><span class="s">"/rooms"</span><span class="o">,</span> <span class="n">id</span><span class="o">))</span>
                <span class="o">.</span><span class="na">orElseGet</span><span class="o">(</span><span class="nl">HttpResponse:</span><span class="o">:</span><span class="n">notFound</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>It is critical that any blocking I/O operations (such as fetching the data from the database) are offloaded to a separate thread pool that does not block the Event loop.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/rooms</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use constructor injection to inject a bean of type <code>MessageService</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Set the response content-type to <code>HTML</code> with the <code>@Produces</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>A Micronaut controller action consumes <code>application/json</code> by default. Consuming other content types is supported with the <code>@Consumes</code> annotation or the consumes member of any HTTP method annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation maps the method to an HTTP POST request.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>You can define path variables with a RFC-6570 URI template in the HTTP Method annotation value. The method argument can optionally be annotated with <code>@PathVariable</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>You can use a qualifier within the HTTP request body. For example, you can use a reference to a nested JSON attribute.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test-resources">12. Test Resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the application is started locally&#8201;&#8212;&#8201;either under test or by <a href="#running-the-application">running the application</a>&#8201;&#8212;&#8201;resolution of the datasource URL is detected and the Test Resources service will start a local MySQL docker container, and inject the properties required to use this as the datasource.</p>
</div>
<div class="paragraph">
<p>For more information, see the <a href="https://micronaut-projects.github.io/micronaut-test-resources/snapshot/guide/#modules-databases-jdbc">JDBC section</a> or <a href="https://micronaut-projects.github.io/micronaut-test-resources/snapshot/guide/#modules-databases-r2dbc">R2DBC section</a> of the Test Resources documentation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="running-the-application">13. Running the application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To run the application, use the <code>./gradlew run</code> command, which starts the application on port 8080.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="license">14. License</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All guides are released with an <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache license 2.0 license</a> for the code and a <a href="https://creativecommons.org/licenses/by/4.0/deed.en">Creative Commons Attribution 4.0</a> license for the writing and media (images&#8230;&#8203;).
</td>
</tr>
</table>
</div>

            </div>
        </div>
    </div>
</main>

<footer id="footer">
    <div class="container">

        <div class="row">
            <div class="col-sm-5 footer-left">

                <div id="text-14" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <a href="https://micronaut.io/foundation/"><img class="alignnone size-medium wp-image-3736" src="./images/micronaut_foundation_horizontal_white.svg" alt="Micronaut Foundation"/></a>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-sm-7 footer-right">

                <ul class="meta">

                    <li id="menu-item-2895" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2895">
                        <a href="https://micronaut.io/brand-guidelines/">Brand Guidelines</a>
                    </li>
                    <li id="menu-item-2894" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2894">
                        <a href="https://micronaut.io/community-guidelines/">Community Guidelines</a>
                    </li>
                    <li id="menu-item-3377" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-privacy-policy menu-item-3377">
                        <a href="https://micronaut.io/privacy-policy/">Privacy Policy</a>
                    </li>

                </ul>

                <div id="nav_menu-2" class="widget widget_nav_menu">
                    <div class="menu-links-container">
                        <ul id="menu-links" class="menu">
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronautpodcast.com"><i class="fa fa-podcast"><span class="sr-only">Podcast</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronaut.io/feed/rss/"><i class="fa fa-feed"><span class="sr-only">Feed</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="mailto:info@micronaut.io"><i class="fas fa-envelope"><span class="sr-only">Mail</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://twitter.com/micronautfw"><i class="fab fa-twitter"><span class="sr-only">Twitter</span></i></a></li>
                            <li id="menu-item-6740" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-6740"><a href="https://fosstodon.org/@micronaut"><i class="fab fa-mastodon"><span class="sr-only">Mastodon</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://discord.gg/9xRFsHv98T"><i class="fab fa-discord"><span class="sr-only">Discord</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://github.com/micronaut-projects/"><i class="fab fa-github"><span class="sr-only">GitHub</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.youtube.com/@MicronautFramework"><i class="fab fa-youtube"><span class="sr-only">YouTube</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.linkedin.com/showcase/micronaut"><i class="fab fa-linkedin"><span class="sr-only">LinkedIn</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.twitch.tv/micronautfw"><i class="fab fa-twitch"><span class="sr-only">Twitch</span></i></a></li>
                        </ul>
                    </div>
                </div>
                <div id="text-5" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <small>Guides are licensed under <a href="https://creativecommons.org/licenses/by/4.0/deed.en">CC BY 4.0</a> for the writing/media and <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache.2.0</a> for the code</small>
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</footer>
</body>
</html>
