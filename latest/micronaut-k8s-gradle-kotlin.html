<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'/>
    <title>Kubernetes service discovery and distributed configuration</title>
    <link rel='stylesheet' id='wp-block-library-css' href='https://micronaut.io/wp-includes/css/dist/block-library/style.min.css' type='text/css' media='all'/>
    <link rel='stylesheet' id='fonts-fira-sans-css' href='https://fonts.googleapis.com/css2?family=Fira+Sans%3Awght%40300%3B500&#038;display=swap&#038;ver=5.7' type='text/css' media='all'/>
    <link rel='stylesheet' id='micronaut-style-css' href='https://micronaut.io/wp-content/themes/micronaut/style.min.css' type='text/css' media='all'/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link rel="shortcut icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link href="coderay.css" rel="stylesheet" />
    <link href="guide.css" rel="stylesheet" />
    <script src="guide.js"></script>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://guides.micronaut.io/latest/images/cards/micronaut-k8s.png"/>
    <meta name="twitter:creator" content="@micronautfw"/>
    <meta name="twitter:site" content="@micronautfw"/>
    <meta name="twitter:title" content="Kubernetes service discovery and distributed configuration"/>
    <meta name="twitter:description" content="How to use Kubernetes service discovery and distributed configuration in a Micronaut application"/>
</head>
<body class="page-template page-template-page-sidebar page-template-page-sidebar-php page page-parent guide">

<header id="header">

    <div class="container">

        <nav class="navbar navbar-expand-lg navbar-dark">

            <button class="collapsed" type="button" data-toggle="collapse" data-target="#nav" aria-expanded="false">
                <span></span>
            </button>

            <a class="navbar-brand" href="https://micronaut.io">
                <img src="https://micronaut.io/wp-content/uploads/2020/11/MIcronautLogo_Horizontal.svg" alt="Micronaut framework"/>
            </a>

            <div class="collapse navbar-collapse" id="nav">

                <ul class="navbar-nav ml-auto">

                    <li id="menu-item-2865" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2865 nav-item">
                        <a href="https://micronaut.io/download/" class="nav-link">Download</a>
                    </li>
                    <li id="menu-item-2868" class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-22 current_page_item current-menu-ancestor current-menu-parent current_page_parent current_page_ancestor menu-item-has-children menu-item-2872 active dropdown nav-item">
                        <a href="./index.html" class="nav-link dropdown-toggle" data-toggle="dropdown">Learn</a>
                        <ul class="dropdown-menu">
                            <li id="menu-item-2869" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2869">
                                <a href="https://micronaut.io/docs/" class="dropdown-item">User Documentation</a>
                            </li>
                            <li id="menu-item-2870" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2870">
                                <a href="./index.html" class="dropdown-item">Guides</a>
                            </li>
                            <li id="menu-item-2896" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2896">
                                <a href="https://micronaut.io/category/microcast/" class="dropdown-item">Microcasts</a>
                            </li>
                            <li id="menu-item-2897" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2897">
                                <a href="https://micronaut.io/category/webinar/" class="dropdown-item">Webinars</a>
                            </li>
                            <li id="menu-item-2871" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2871">
                                <a href="https://micronaut.io/professional-training/" class="dropdown-item">Professional Training</a>
                            </li>
                        </ul>
                    </li>
                    <li id="menu-item-2878" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2878 dropdown nav-item">
                        <a href="https://micronaut.io/blog/" class="nav-link dropdown-toggle" data-toggle="dropdown">Resources</a>
                        <ul class="dropdown-menu">
                            <li id="menu-item-2879" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2879">
                                <a href="https://micronaut.io/blog/" class="dropdown-item">Blog</a>
                            </li>
                            <li id="menu-item-2881" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2881">
                                <a href="https://micronaut.io/events/" class="dropdown-item">Upcoming Events</a>
                            </li>
                            <li id="menu-item-2880" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2880">
                                <a href="https://micronaut.io/commercial-support/" class="dropdown-item">Commercial Support</a>
                            </li>
                            <li id="menu-item-2882" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2882">
                                <a href="https://micronaut.io/faq/" class="dropdown-item">FAQ</a>
                            </li>
                            <li id="menu-item-2883" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2883">
                                <a href="https://micronaut.io/contact/" class="dropdown-item">Contact</a>
                            </li>
                        </ul>
                    </li>
                    <li id="menu-item-2872" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2878 dropdown nav-item">
                        <a href="https://micronaut.io/foundation/" aria-current="page" class="nav-link dropdown-toggle" data-toggle="dropdown">Foundation</a>
                        <ul class="dropdown-menu">
                            <li id="menu-item-2877" class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-22 current_page_item menu-item-2877 active">
                                <a href="https://micronaut.io/foundation/" aria-current="page" class="dropdown-item">Overview</a>
                            </li>
                            <li id="menu-item-2874" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2874">
                                <a href="https://micronaut.io/foundation/corporate-sponsorship/" class="dropdown-item">Corporate Sponsorship</a>
                            </li>
                            <li id="menu-item-2873" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2873">
                                <a href="https://micronaut.io/foundation/community-sponsorship/" class="dropdown-item">Community Sponsorship</a>
                            </li>
                            <li id="menu-item-2876" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2876">
                                <a href="https://micronaut.io/foundation/sponsors/" class="dropdown-item">Sponsors</a>
                            </li>
                        </ul>
                    </li>
                    <li id="menu-item-2884" class="action menu-item menu-item-type-custom menu-item-object-custom menu-item-2884 nav-item">
                        <a target="_blank" rel="noopener" href="https://micronaut.io/launch/" class="nav-link">Launch</a>
                    </li>
                </ul>
            </div>

        </nav>

    </div>
</header>
<div id="breadcrumbs"><div class="container"><a href="https://micronaut.io/">Home</a> » <a href="./index.html">Guides</a> » <a href="micronaut-k8s.html">Kubernetes service discovery and distributed configuration</a> » <span class="breadcrumb_last" aria-current="page">gradle | kotlin</span></div></div><!-- .breadcrumbs -->
<main id="main">
    <div class="container">
        <div class="row">
            <div class="col-md-4">

                <div class="toc">
                    <div class="inner">
                        <h1 class="title title_large first-word-bold first-word-break">Table of Contents</h1>
                        <div class="underline"></div>
                        
<ul class="sectlevel1">
<li><a href="#getting-started">1. Getting Started</a></li>
<li><a href="#what-you-will-need">2. What you will need</a></li>
<li><a href="#solution">3. Solution</a></li>
<li><a href="#writing-the-apps">4. Writing the Apps</a>
<ul class="sectlevel2">
<li><a href="#users-microservice">4.1. Users Microservice</a></li>
<li><a href="#orders-microservice">4.2. Orders Microservice</a></li>
<li><a href="#api-gateway-microservice">4.3. API (Gateway) Microservice</a></li>
<li><a href="#test-integration-between-applications">4.4. Test integration between applications</a></li>
</ul>
</li>
<li><a href="#kubernetes-and-the-micronaut-framework">5. Kubernetes and the Micronaut framework</a>
<ul class="sectlevel2">
<li><a href="#users-microservice-2">5.1. Users Microservice</a></li>
<li><a href="#orders-microservice-2">5.2. Orders Microservice</a></li>
<li><a href="#api-gateway-microservice-2">5.3. API (Gateway) Microservice</a></li>
<li><a href="#test-integration-between-applications-deployed-on-kubernetes">5.4. Test integration between applications deployed on Kubernetes</a></li>
</ul>
</li>
<li><a href="#cleaning-up">6. Cleaning Up</a></li>
<li><a href="#next-steps">7. Next steps</a></li>
</ul>

                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <h1>Kubernetes service discovery and distributed configuration</h1>
                <div class="underline"></div>
<div class="sect1">
<div class="sectionbody">

<div class="paragraph">
<p>How to use Kubernetes service discovery and distributed configuration in a Micronaut application</p>
</div>
<div class="paragraph">
<p>Authors: Nemanja Mikic</p>
</div>
<div class="paragraph">
<p>Micronaut Version: 3.9.2</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started">1. Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this guide, we will create three microservices, build containerized versions and deploy them with <a href="https://kubernetes.io/">Kubernetes</a>. We will use Kubernetes Service discovery and Distributed configuration to wire up our microservices.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Kubernetes is a portable, extensible, open source platform for managing containerized workloads and services, that facilitates both declarative configuration and automation. It has a large, rapidly growing ecosystem. Kubernetes services, support, and tools are widely available.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>You will discover how the Micronaut framework eases Kubernetes integration.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-you-will-need">2. What you will need</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 17 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
<li>
<p><a href="https://www.docker.io/gettingstarted/#h_installation">Docker</a>.</p>
</li>
<li>
<p>Local Kubernetes cluster. We will use <a href="https://minikube.sigs.k8s.io/docs/">Minikube</a> in this guide.</p>
</li>
</ul>
</div>
</div>
</div>
</div></div><div class="row"><div class="col-md-12"><div class="sect1">
<h2 id="solution">3. Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create the application step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="micronaut-k8s-gradle-kotlin.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-the-apps">4. Writing the Apps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s describe the microservices you will build through the guide.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>users</code> - This microservice contains customers data that can place orders on items, also a new customer can be created. Microservice requires Basic authentication to access it.</p>
</li>
<li>
<p><code>orders</code> - This microservice contains all orders that customers have created as well as available items that customers can order. Also this microservice enables the creation of new orders. Microservice requires Basic authentication to access it.</p>
</li>
<li>
<p><code>api</code> - This microservice acts as a gateway to the <code>orders</code> and <code>users</code> services. It combines results from both services and checks data when customers create a new order.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Initially we will hard-code the URLs of the <code>orders</code> and <code>users</code> services in the <code>api</code> service. Additionally, we will hard-code credentials (username and password) into every microservice configuration that are required for Basic authentication.</p>
</div>
<div class="paragraph">
<p>In the second part of this guide we will use a Kubernetes discovery service and Kubernetes configuration maps to dynamically resolve the URLs of the <code>orders</code> and <code>users</code> microservices  and get authentication credentials. The microservices call the Kubernetes API to register when they start up and then resolve placeholders inside the microservices' configurations.</p>
</div>
<div class="sect2">
<h3 id="users-microservice">4.1. Users Microservice</h3>
<div class="paragraph">
<p>Create the <code>users</code> microservice using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mn create-app          \
    --features=discovery-kubernetes,management,security,kubernetes,serialization-jackson,graalvm \
    --build=gradle             \
    --lang=kotlin               \
    --jdk=17              \
    example.micronaut.users</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add the <code>discovery-kubernetes</code>, <code>management</code>, <code>security</code>, <code>serialization-jackson</code>, <code>kubernetes</code> and <code>graalvm</code> features.</p>
</div>
<div class="paragraph">
<p>The previous command creates a directory named <em>users</em> containing Micronaut application with a package named <code>example.micronaut</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have an existing Micronaut application and want to add the functionality described here, you can <a href="https://micronaut.io/launch?features=discovery-kubernetes&amp;features=management&amp;features=security&amp;features=kubernetes&amp;features=serialization-jackson&amp;features=graalvm&amp;lang=KOTLIN&amp;build=GRADLE&amp;test=JUNIT&amp;name=users&amp;type=DEFAULT&amp;package=example.micronaut&amp;activity=diff" target="_blank" rel="noopener">view the dependency and configuration changes from the specified features</a> and apply those changes to your application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a package named <code>controllers</code> and create a <code>UsersController</code> class to handle incoming HTTP requests for the <code>users</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/kotlin/example/micronaut/controllers/UsersController.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.controllers

import example.micronaut.models.User
import io.micronaut.http.HttpStatus
import io.micronaut.http.annotation.Body
import io.micronaut.http.annotation.Controller
import io.micronaut.http.annotation.Get
import io.micronaut.http.annotation.Post
import io.micronaut.http.exceptions.HttpStatusException
import io.micronaut.security.annotation.Secured
import io.micronaut.security.rules.SecurityRule
import javax.validation.Valid
import javax.validation.constraints.NotNull
import kotlin.collections.ArrayList

@Controller(&quot;/users&quot;) <i class="conum" data-value="1"></i><b>(1)</b>
@Secured(SecurityRule.IS_AUTHENTICATED) <i class="conum" data-value="2"></i><b>(2)</b>
class UsersController {
    var persons: MutableList&lt;User?&gt; = ArrayList()

    @Post <i class="conum" data-value="3"></i><b>(3)</b>
    fun add(@Body user: @Valid User?): User {
        val foundUser = findByUsername(user!!.username)
        if (foundUser != null) {
            throw HttpStatusException(HttpStatus.CONFLICT, &quot;User with provided username already exists&quot;)
        }
        val newUser = User(persons.size + 1, user.firstName, user.lastName, user.username)
        persons.add(newUser)
        return newUser
    }

    @Get(&quot;/{id}&quot;) <i class="conum" data-value="4"></i><b>(4)</b>
    fun findById(id: @NotNull Int?): User? {
        return persons
            .firstOrNull { it: User? -&gt;
                it!!.id == id
            }
    }

    @Get <i class="conum" data-value="5"></i><b>(5)</b>
    fun getUsers(): List&lt;User?&gt;? {
        return persons
    }

    fun findByUsername(username: @NotNull String?): User? {
        return persons.firstOrNull { it: User? -&gt;
            it!!.username == username
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/users</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>io.micronaut.security.Secured</code> to configure secured access. The <code>isAuthenticated()</code> expression will allow access only to authenticated users.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation maps the <code>add</code> method to an HTTP POST request on <code>/users</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>findById</code> method to an HTTP GET request on <code>/users/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getUsers</code> method to an HTTP GET request on <code>/users</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>models</code> where we will put our data beans.</p>
</div>
<div class="paragraph">
<p>The <code>UsersController</code> class uses a <code>User</code> object to represent customer. Create the <code>User</code> class</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/kotlin/example/micronaut/models/User.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.models

import com.fasterxml.jackson.annotation.JsonProperty
import io.micronaut.core.annotation.Nullable
import io.micronaut.serde.annotation.Serdeable
import javax.validation.constraints.Max
import javax.validation.constraints.NotBlank

@Serdeable <i class="conum" data-value="1"></i><b>(1)</b>
data class User(@Nullable @Max(10000) val id: Int, <i class="conum" data-value="2"></i><b>(2)</b>
                @NotBlank @JsonProperty(&quot;first_name&quot;) val firstName:String,
                @NotBlank @JsonProperty(&quot;last_name&quot;)  val lastName:String,
                val username:String)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ID will be generated by application.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>auth</code> where you will check basic authentication credentials.</p>
</div>
<div class="paragraph">
<p>The <code>Credentials</code> class will load and store credentials (username and password) from a configuration file.</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/kotlin/example/micronaut/auth/Credentials.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.auth

import io.micronaut.context.annotation.ConfigurationProperties

@ConfigurationProperties(&quot;authentication-credentials&quot;) <i class="conum" data-value="1"></i><b>(1)</b>
class Credentials{
    lateinit var username: String
    lateinit var password: String
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@ConfigurationProperties</code> annotation takes the configuration prefix.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>CredentialsChecker</code> class, as the name suggests, will check if the provided credentials inside the HTTP request&#8217;s <code>Authorization</code> header are the same as those that are stored inside the <code>Credentials</code> class that we created above.</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/kotlin/example/micronaut/auth/CredentialsChecker.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.auth

import io.micronaut.core.annotation.Nullable
import io.micronaut.http.HttpRequest
import io.micronaut.security.authentication.AuthenticationProvider
import io.micronaut.security.authentication.AuthenticationRequest
import io.micronaut.security.authentication.AuthenticationResponse
import jakarta.inject.Singleton
import org.reactivestreams.Publisher
import reactor.core.publisher.Mono
import reactor.core.publisher.MonoSink

@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
class CredentialsChecker(private val credentials: Credentials) : AuthenticationProvider {
    override fun authenticate(
        @Nullable httpRequest: HttpRequest&lt;*&gt;?,
        authenticationRequest: AuthenticationRequest&lt;*, *&gt;
    ): Publisher&lt;AuthenticationResponse&gt; {
        return Mono.create { emitter: MonoSink&lt;AuthenticationResponse&gt; -&gt;
            if (authenticationRequest.identity == credentials.username &amp;&amp; authenticationRequest.secret == credentials.password) {
                emitter.success(AuthenticationResponse.success(authenticationRequest.identity as String))
            } else {
                emitter.error(AuthenticationResponse.exception())
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><br></p>
</div>
<div class="sect3">
<h4 id="write-tests-to-verify-application-logic">4.1.1. Write tests to verify application logic</h4>
<div class="paragraph">
<p>Create the <code>UsersClient</code>, a declarative Micronaut HTTP Client for testing:</p>
</div>
<div class="listingblock">
<div class="title">users/src/test/kotlin/example/micronaut/UsersClient.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import example.micronaut.models.User
import io.micronaut.http.annotation.Body
import io.micronaut.http.annotation.Get
import io.micronaut.http.annotation.Header
import io.micronaut.http.annotation.Post
import io.micronaut.http.client.annotation.Client

@Client(&quot;/&quot;) <i class="conum" data-value="1"></i><b>(1)</b>
interface UsersClient {
    @Get(&quot;/users/{id}&quot;)
    fun getById(@Header authorization: String?, id: Int?): User?

    @Post(&quot;/users&quot;)
    fun createUser(@Header authorization: String?, @Body user: User?): User

    @Get(&quot;/users&quot;)
    fun getUsers(@Header authorization: String?): List&lt;User?&gt;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>HealthTest</code> checks that there is <code>/health</code> endpoint that is required for service discovery.</p>
</div>
<div class="listingblock">
<div class="title">users/src/test/kotlin/example/micronaut/HealthTest.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import io.micronaut.http.HttpRequest
import io.micronaut.http.HttpStatus
import io.micronaut.http.client.HttpClient
import io.micronaut.http.client.annotation.Client
import io.micronaut.test.extensions.junit5.annotation.MicronautTest
import jakarta.inject.Inject
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.api.Test

@MicronautTest <i class="conum" data-value="1"></i><b>(1)</b>
class HealthTest {

    @Inject
    @field:Client(&quot;/&quot;)
    lateinit var client: HttpClient <i class="conum" data-value="2"></i><b>(2)</b>

    @Test
    fun healthEndpointExposed() {
        val status = client.toBlocking().retrieve(
            HttpRequest.GET&lt;Any&gt;(&quot;/health&quot;),
            HttpStatus::class.java
        )
        assertEquals(HttpStatus.OK, status)
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject the <code>HttpClient</code> bean and point it to the embedded server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>UsersControllerTest</code> tests endpoints inside the <code>UserController</code>.</p>
</div>
<div class="listingblock">
<div class="title">users/src/test/kotlin/example/micronaut/UsersControllerTest.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import example.micronaut.auth.Credentials
import example.micronaut.models.User
import io.micronaut.http.HttpStatus
import io.micronaut.http.client.exceptions.HttpClientException
import io.micronaut.http.client.exceptions.HttpClientResponseException
import io.micronaut.test.extensions.junit5.annotation.MicronautTest
import jakarta.inject.Inject
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.api.Assertions.assertNotEquals
import org.junit.jupiter.api.Assertions.assertNotNull
import org.junit.jupiter.api.Assertions.assertNull
import org.junit.jupiter.api.Assertions.assertThrows
import org.junit.jupiter.api.Assertions.assertTrue
import org.junit.jupiter.api.Test
import java.util.Base64


@MicronautTest <i class="conum" data-value="1"></i><b>(1)</b>
class UsersControllerTest {
    @Inject
    var usersClient: UsersClient? = null

    @Inject
    var credentials: Credentials? = null

    @Test
    fun testUnauthorized() {
        val exception = assertThrows(
            HttpClientException::class.java
        ) { usersClient!!.getUsers(&quot;&quot;) }
        assertTrue(exception.message!!.contains(&quot;Unauthorized&quot;))
    }

    @Test
    fun userThatDoesntExists() {
        val authHeader = &quot;Basic &quot; + Base64.getEncoder()
            .encodeToString((credentials!!.username + &quot;:&quot; + credentials!!.password).toByteArray())
        val retriedUser = usersClient!!.getById(authHeader, 100)
        assertNull(retriedUser)
    }

    @Test
    fun multipleUserInteraction() {
        val authHeader = &quot;Basic &quot; + Base64.getEncoder()
            .encodeToString((credentials!!.username + &quot;:&quot; + credentials!!.password).toByteArray())
        val firstName = &quot;firstName&quot;
        val lastName = &quot;lastName&quot;
        val username = &quot;username&quot;
        val user = User(0, firstName, lastName, username)
        val createdUser = usersClient!!.createUser(authHeader, user)
        assertEquals(firstName, createdUser.firstName)
        assertEquals(lastName, createdUser.lastName)
        assertEquals(username, createdUser.username)
        assertNotNull(createdUser.id)
        val retriedUser = usersClient!!.getById(authHeader, createdUser.id)
        assertEquals(firstName, retriedUser!!.firstName)
        assertEquals(lastName, retriedUser.lastName)
        assertEquals(username, retriedUser.username)
        val users = usersClient!!.getUsers(authHeader)
        assertNotNull(users)
        assertNotNull(users.any {
            it!!.username == username
        })
    }

    @Test
    fun createSameUserTwice() {
        val authHeader = &quot;Basic &quot; + Base64.getEncoder()
            .encodeToString((credentials!!.username + &quot;:&quot; + credentials!!.password).toByteArray())
        val firstName = &quot;SameUserFirstName&quot;
        val lastName = &quot;SameUserLastName&quot;
        val username = &quot;SameUserUsername&quot;
        val user = User(0, firstName, lastName, username)
        val createdUser = usersClient!!.createUser(authHeader, user)
        assertEquals(firstName, createdUser.firstName)
        assertEquals(lastName, createdUser.lastName)
        assertEquals(username, createdUser.username)
        assertNotNull(createdUser.id)
        assertNotEquals(createdUser.id, 0)
        val exception = assertThrows(
            HttpClientResponseException::class.java
        ) { usersClient!!.createUser(authHeader, user) }
        assertEquals(HttpStatus.CONFLICT, exception.status)
        assertTrue(
            exception.response.getBody(String::class.java).orElse(&quot;&quot;)
                .contains(&quot;User with provided username already exists&quot;)
        )
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit <em>application.yml</em></p>
</div>
<div class="listingblock">
<div class="title">users/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">users</span></span>
<span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="content">${username} </span></span><i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">password</span>: <span class="string"><span class="content">${password} </span></span><i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Placeholder for username that will be populated by Kubernetes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Placeholder for password that will be populated by Kubernetes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit the <em>bootstrap.yml</em> file in the <em>resources</em> directory to <a href="https://docs.micronaut.io/latest/guide/#bootstrap">enable distributed configuration</a>.
Change the default contents to the following:</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/resources/bootstrap.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">users</span></span>
  <span class="key">config-client</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="key">kubernetes</span>:
  <span class="key">client</span>:
    <span class="key">secrets</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="2"></i><b>(2)</b>
      <span class="key">use-api</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>microanut.config-client.enabled: true</code>  to read and resolve configuration from distributed sources.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set <code>kubernetes.client.secrets.enabled: true</code> to enable Kubernetes secrets as distributed source.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set <code>kubernetes.client.secrets.use-api: true</code> to use the Kubernetes API to fetch the configuration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/application-dev.yml</code>. The Micronaut framework applies this configuration file only for the <code>dev</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/resources/application-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">server</span>:
    <span class="key">port</span>: <span class="string"><span class="content">8081 </span></span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_username</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_password</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the application to listen on port 8081.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded username for the development environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Hardcoded password for the development environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>bootstrap-dev.yml</em> to disable distributed configuration in the dev environment:</p>
</div>
<div class="listingblock">
<div class="title">users/src/main/resources/bootstrap-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">kubernetes</span>:
  <span class="key">client</span>:
    <span class="key">secrets</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">false </span></span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Disable the Kubernetes secrets client.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>application-test.yml</em> for use in the test environment:</p>
</div>
<div class="listingblock">
<div class="title">users/src/test/resources/application-test.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_username</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_password</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hardcoded username for the test environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded password for the test environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the unit test:</p>
</div>
<div class="listingblock">
<div class="title">users</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./gradlew test</code></pre>
</div>
</div>
<div class="paragraph">
<p><br></p>
</div>
</div>
<div class="sect3">
<h4 id="running-the-application">4.1.2. Running the application</h4>
<div class="paragraph">
<p>Run the <code>users</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">users</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"> MICRONAUT_ENVIRONMENTS=dev ./gradlew run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8081</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="orders-microservice">4.2. Orders Microservice</h3>
<div class="paragraph">
<p>Create the <code>orders</code> microservice using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mn create-app        \
  --features=discovery-kubernetes,management,security,kubernetes,serialization-jackson,graalvm \
  --build=gradle              \
  --lang=kotlin                \
  --jdk=17               \
example.micronaut.orders</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add the <code>discovery-kubernetes</code>, <code>management</code>, <code>security</code>, <code>serialization-jackson</code>, <code>kubernetes</code> and <code>graalvm</code> features.</p>
</div>
<div class="paragraph">
<p>The previous command creates a directory named <em>orders</em> containing a Micronaut application with a package named <code>example.micronaut</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have an existing Micronaut application and want to add the functionality described here, you can <a href="https://micronaut.io/launch?features=discovery-kubernetes&amp;features=management&amp;features=security&amp;features=kubernetes&amp;features=serialization-jackson&amp;features=graalvm&amp;lang=KOTLIN&amp;build=GRADLE&amp;test=JUNIT&amp;name=orders&amp;type=DEFAULT&amp;package=example.micronaut&amp;activity=diff" target="_blank" rel="noopener">view the dependency and configuration changes from the specified features</a> and apply those changes to your application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>controllers</code> and create the <code>OrdersController</code> and <code>ItemsController</code> classes to handle incoming HTTP requests to the <code>orders</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/kotlin/example/micronaut/controllers/OrdersController.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.controllers

import example.micronaut.models.Item
import example.micronaut.models.Item.Companion.items
import example.micronaut.models.Order
import io.micronaut.http.HttpStatus
import io.micronaut.http.annotation.Body
import io.micronaut.http.annotation.Controller
import io.micronaut.http.annotation.Get
import io.micronaut.http.annotation.Post
import io.micronaut.http.exceptions.HttpStatusException
import io.micronaut.security.annotation.Secured
import io.micronaut.security.rules.SecurityRule
import java.math.BigDecimal
import javax.validation.Valid
import javax.validation.constraints.NotNull

@Controller(&quot;/orders&quot;) <i class="conum" data-value="1"></i><b>(1)</b>
@Secured(SecurityRule.IS_AUTHENTICATED) <i class="conum" data-value="2"></i><b>(2)</b>
class OrdersController {

    private val orders: MutableList&lt;Order&gt; = ArrayList()

    @Get(&quot;/{id}&quot;) <i class="conum" data-value="3"></i><b>(3)</b>
    fun findById(id: @NotNull Int?): Order? {
        return orders.firstOrNull{ it: Order -&gt;
            it.id == id
        }
    }

    @Get <i class="conum" data-value="4"></i><b>(4)</b>
    fun getOrders(): List&lt;Order?&gt; {
        return orders
    }

    @Post <i class="conum" data-value="5"></i><b>(5)</b>
    fun createOrder(@Body order: @Valid Order): Order {
        if (order.itemIds.isNullOrEmpty()) {
            throw HttpStatusException(HttpStatus.BAD_REQUEST, &quot;Items must be supplied&quot;)
        }
        val items: List&lt;Item&gt; = order.itemIds.map { x -&gt;
            items.firstOrNull { y: Item -&gt;
                y.id == x
            }?: throw HttpStatusException(HttpStatus.BAD_REQUEST, String.format(&quot;Item with id %s doesn't exist&quot;, x))
        }
        val total: BigDecimal = items.map(Item::price).reduce(BigDecimal::add)
        val newOrder = Order(orders.size + 1, order.userId, items, null, total)
        orders.add(newOrder)
        return newOrder
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/orders</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>io.micronaut.security.Secured</code> to configure secured access. The <code>isAuthenticated()</code> expression will allow access only to authenticated users.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>findById</code> method to an HTTP GET request on <code>/orders/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getOrders</code> method to an HTTP GET request on <code>/orders</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation maps the <code>createOrder</code> method to an HTTP POST request on <code>/orders</code>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">orders/src/main/kotlin/example/micronaut/controllers/ItemsController.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.controllers

import example.micronaut.models.Item
import io.micronaut.http.annotation.Controller
import io.micronaut.http.annotation.Get
import io.micronaut.security.annotation.Secured
import io.micronaut.security.rules.SecurityRule
import javax.validation.constraints.NotNull

@Controller(&quot;/items&quot;) <i class="conum" data-value="1"></i><b>(1)</b>
@Secured(SecurityRule.IS_AUTHENTICATED) <i class="conum" data-value="2"></i><b>(2)</b>
class ItemsController {

    @Get(&quot;/{id}&quot;) <i class="conum" data-value="3"></i><b>(3)</b>
    fun findById(id: @NotNull Int?): Item? {
        return Item.items
            .firstOrNull { it.id == id }
    }

    @Get <i class="conum" data-value="4"></i><b>(4)</b>
    fun getItems(): List&lt;Item?&gt; {
        return Item.items
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/items</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>io.micronaut.security.Secured</code> to configure secured access. The <code>isAuthenticated()</code> expression will allow access only to authenticated users.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>findById</code> method to an HTTP GET request on <code>/items/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getItems</code> method to an HTTP GET request on <code>/items</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>models</code> where you will put your data beans.</p>
</div>
<div class="paragraph">
<p>The previous <code>OrdersController</code> and <code>ItemsController</code> controller uses <code>Order</code> and <code>Item</code>  objects to represent customer orders. Create the <code>Order</code> class:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/kotlin/example/micronaut/models/Order.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.models

import com.fasterxml.jackson.annotation.JsonProperty
import io.micronaut.core.annotation.Nullable
import io.micronaut.serde.annotation.Serdeable
import java.math.BigDecimal
import javax.validation.constraints.Max
import javax.validation.constraints.NotBlank

@Serdeable <i class="conum" data-value="1"></i><b>(1)</b>
data class Order (
    @Nullable @Max(10000) val id:Int, <i class="conum" data-value="2"></i><b>(2)</b>
    @NotBlank @JsonProperty(&quot;user_id&quot;) val userId:Int,
    @Nullable val items: List&lt;Item&gt;?, <i class="conum" data-value="3"></i><b>(3)</b>
    @NotBlank @JsonProperty(&quot;item_ids&quot;) val itemIds:List&lt;Int&gt;?, <i class="conum" data-value="4"></i><b>(4)</b>
    @Nullable val total: BigDecimal?)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ID will be generated by application.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>List</code> of <code>Item</code> class will be populated by the server and will be only visible in sever responses.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>List of item_ids will be provided by client requests.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the <code>Item</code> class:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/kotlin/example/micronaut/models/Item.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.models

import com.fasterxml.jackson.annotation.JsonProperty
import io.micronaut.serde.annotation.Serdeable
import java.math.BigDecimal

@Serdeable <i class="conum" data-value="1"></i><b>(1)</b>
data class Item (
    val id:Int,
    val name:String,
    val price: BigDecimal
) {
    companion object {
        var items: List&lt;Item&gt; = listOf(
            Item(1, &quot;Banana&quot;, BigDecimal(&quot;1.5&quot;)),
            Item(2, &quot;Kiwi&quot;, BigDecimal(&quot;2.5&quot;)),
            Item(3, &quot;Grape&quot;, BigDecimal(&quot;1.25&quot;))
        )
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>auth</code> where you will check basic authentication credentials.</p>
</div>
<div class="paragraph">
<p>The <code>Credentials</code> class will load and store credentials (username and password) from configuration files.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/kotlin/example/micronaut/auth/Credentials.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.auth

import io.micronaut.context.annotation.ConfigurationProperties

@ConfigurationProperties(&quot;authentication-credentials&quot;) <i class="conum" data-value="1"></i><b>(1)</b>
class Credentials{
    lateinit var username: String
    lateinit var password: String
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@ConfigurationProperties</code> annotation takes the configuration prefix.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>CredentialsChecker</code> class, as name suggests, will check if provided credentials inside an HTTP request&#8217;s <code>Authorization</code> header are the same as those that are stored inside <code>Credentials</code> class that we created above.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/kotlin/example/micronaut/auth/CredentialsChecker.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.auth

import io.micronaut.core.annotation.Nullable
import io.micronaut.http.HttpRequest
import io.micronaut.security.authentication.AuthenticationProvider
import io.micronaut.security.authentication.AuthenticationRequest
import io.micronaut.security.authentication.AuthenticationResponse
import jakarta.inject.Singleton
import org.reactivestreams.Publisher
import reactor.core.publisher.Mono
import reactor.core.publisher.MonoSink

@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
class CredentialsChecker(private val credentials: Credentials) : AuthenticationProvider {
    override fun authenticate(
        @Nullable httpRequest: HttpRequest&lt;*&gt;?,
        authenticationRequest: AuthenticationRequest&lt;*, *&gt;
    ): Publisher&lt;AuthenticationResponse&gt; {
        return Mono.create { emitter: MonoSink&lt;AuthenticationResponse&gt; -&gt;
            if (authenticationRequest.identity == credentials.username &amp;&amp; authenticationRequest.secret == credentials.password) {
                emitter.success(AuthenticationResponse.success(authenticationRequest.identity as String))
            } else {
                emitter.error(AuthenticationResponse.exception())
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><br></p>
</div>
<div class="sect3">
<h4 id="write-tests-to-verify-application-logic-2">4.2.1. Write tests to verify application logic</h4>
<div class="paragraph">
<p>Create the <code>OrderItemClient</code>, a declarative Micronaut HTTP Client for testing:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/test/kotlin/example/micronaut/OrderItemClient.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import example.micronaut.models.Item
import example.micronaut.models.Order
import io.micronaut.http.annotation.Body
import io.micronaut.http.annotation.Get
import io.micronaut.http.annotation.Header
import io.micronaut.http.annotation.Post
import io.micronaut.http.client.annotation.Client

@Client(&quot;/&quot;) <i class="conum" data-value="1"></i><b>(1)</b>
interface OrderItemClient {
    @Get(&quot;/orders/{id}&quot;)
    fun getOrderById(@Header authorization: String?, id: Int?): Order?

    @Post(&quot;/orders&quot;)
    fun createOrder(@Header authorization: String?, @Body order: Order?): Order

    @Get(&quot;/orders&quot;)
    fun getOrders(@Header authorization: String?): List&lt;Order&gt;

    @Get(&quot;/items&quot;)
    fun getItems(@Header authorization: String?): List&lt;Item&gt;

    @Get(&quot;/items/{id}&quot;)
    fun getItemsById(@Header authorization: String?, id: Int?): Item?
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>HealthTest</code> checks that there is <code>/health</code> endpoint that is required for service discovery.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/test/kotlin/example/micronaut/HealthTest.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import io.micronaut.http.HttpRequest
import io.micronaut.http.HttpStatus
import io.micronaut.http.client.HttpClient
import io.micronaut.http.client.annotation.Client
import io.micronaut.test.extensions.junit5.annotation.MicronautTest
import jakarta.inject.Inject
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.api.Test

@MicronautTest <i class="conum" data-value="1"></i><b>(1)</b>
class HealthTest {

    @Inject
    @field:Client(&quot;/&quot;)
    lateinit var client: HttpClient <i class="conum" data-value="2"></i><b>(2)</b>

    @Test
    fun healthEndpointExposed() {
        val status = client.toBlocking().retrieve(
            HttpRequest.GET&lt;Any&gt;(&quot;/health&quot;),
            HttpStatus::class.java
        )
        assertEquals(HttpStatus.OK, status)
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject the <code>HttpClient</code> bean and point it to the embedded server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>ItemsControllerTest</code> tests endpoints inside the <code>ItemController</code>.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/test/kotlin/example/micronaut/ItemsControllerTest.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import example.micronaut.auth.Credentials
import example.micronaut.models.Item
import io.micronaut.http.client.exceptions.HttpClientException
import io.micronaut.test.extensions.junit5.annotation.MicronautTest
import jakarta.inject.Inject
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.api.Assertions.assertNotNull
import org.junit.jupiter.api.Assertions.assertThrows
import org.junit.jupiter.api.Assertions.assertTrue
import org.junit.jupiter.api.Test
import java.math.BigDecimal
import java.util.Base64

@MicronautTest <i class="conum" data-value="1"></i><b>(1)</b>
class ItemsControllerTest {
    @Inject
    var orderItemClient: OrderItemClient? = null

    @Inject
    var credentials: Credentials? = null

    @Test
    fun testUnauthorized() {
        val exception = assertThrows(
            HttpClientException::class.java
        ) { orderItemClient?.getItems(&quot;&quot;) }
        assertTrue(exception.message!!.contains(&quot;Unauthorized&quot;))
    }

    @Test
    fun getItem() {
        val itemId = 1
        val authHeader = &quot;Basic &quot; + Base64.getEncoder()
            .encodeToString((credentials!!.username + &quot;:&quot; + credentials!!.password).toByteArray())
        val item: Item? = orderItemClient!!.getItemsById(authHeader, itemId)
        assertEquals(itemId, item!!.id)
        assertEquals(&quot;Banana&quot;, item.name)
        assertEquals(BigDecimal(&quot;1.5&quot;), item.price)
    }

    @Test
    fun getItems() {
        val authHeader = &quot;Basic &quot; + Base64.getEncoder()
            .encodeToString((credentials!!.username + &quot;:&quot; + credentials!!.password).toByteArray())
        val items: List&lt;Item&gt; = orderItemClient!!.getItems(authHeader)
        assertNotNull(items)
        val existingItemNames = listOf(&quot;Kiwi&quot;, &quot;Banana&quot;, &quot;Grape&quot;)
        assertEquals(3, items.size)
        assertTrue(items.stream()
            .map&lt;Any&gt;(Item::name)
            .allMatch { name: Any -&gt;
                existingItemNames.stream().anyMatch { x: String -&gt; x == name }
            })
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>OrdersControllerTest</code> tests endpoints inside the <code>OrdersController</code>.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/test/kotlin/example/micronaut/OrdersControllerTest.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import example.micronaut.auth.Credentials
import example.micronaut.models.Order
import io.micronaut.http.HttpStatus
import io.micronaut.http.client.exceptions.HttpClientException
import io.micronaut.http.client.exceptions.HttpClientResponseException
import io.micronaut.test.extensions.junit5.annotation.MicronautTest
import jakarta.inject.Inject
import org.junit.jupiter.api.Assertions
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.api.Assertions.assertNotNull
import org.junit.jupiter.api.Assertions.assertTrue
import org.junit.jupiter.api.Test
import java.math.BigDecimal
import java.util.Base64

@MicronautTest <i class="conum" data-value="1"></i><b>(1)</b>
class OrdersControllerTest {

    @Inject
    var orderItemClient: OrderItemClient? = null

    @Inject
    var credentials: Credentials? = null

    @Test
    fun testUnauthorized() {
        val exception = Assertions.assertThrows(
            HttpClientException::class.java
        ) { orderItemClient!!.getOrders(&quot;&quot;) }
        assertTrue(exception.message!!.contains(&quot;Unauthorized&quot;))
    }

    @Test
    fun multipleOrderInteraction() {
        val authHeader = &quot;Basic &quot; + Base64.getEncoder()
            .encodeToString((credentials!!.username + &quot;:&quot; + credentials!!.password).toByteArray())
        val userId = 1
        val itemIds = listOf(1, 1, 2, 3)
        val order = Order(0, userId, null, itemIds, null)
        val createdOrder = orderItemClient!!.createOrder(authHeader, order)
        assertNotNull(createdOrder.items)
        assertEquals(4, createdOrder.items!!.size)
        assertEquals(BigDecimal(&quot;6.75&quot;), createdOrder.total)
        assertEquals(userId, createdOrder.userId)
        val retrievedOrder = orderItemClient!!.getOrderById(authHeader, createdOrder.id)
        assertNotNull(retrievedOrder!!.items)
        assertEquals(4, retrievedOrder.items!!.size)
        assertEquals(BigDecimal(&quot;6.75&quot;), retrievedOrder.total)
        assertEquals(userId, retrievedOrder.userId)
        val orders = orderItemClient!!.getOrders(authHeader)
        assertNotNull(orders)
        assertTrue(orders.stream()
            .map&lt;Any&gt;(Order::userId)
            .anyMatch { id: Any -&gt; id == userId })
    }

    @Test
    fun itemDoesntExists() {
        val authHeader = &quot;Basic &quot; + Base64.getEncoder()
            .encodeToString((credentials!!.username + &quot;:&quot; + credentials!!.password).toByteArray())
        val userId = 1
        val itemIds = listOf(5)
        val order = Order(0, userId, null, itemIds, null)
        val exception = Assertions.assertThrows(
            HttpClientResponseException::class.java
        ) { orderItemClient!!.createOrder(authHeader, order) }
        assertEquals(exception.status, HttpStatus.BAD_REQUEST)
        assertTrue(
            exception.response.getBody(String::class.java).orElse(&quot;&quot;).contains(&quot;Item with id 5 doesn't exist&quot;)
        )
    }

    @Test
    fun orderEmptyItems() {
        val authHeader = &quot;Basic &quot; + Base64.getEncoder()
            .encodeToString((credentials!!.username + &quot;:&quot; + credentials!!.password).toByteArray())
        val userId = 1
        val order = Order(0, userId, null, null, null)
        val exception = Assertions.assertThrows(
            HttpClientResponseException::class.java
        ) { orderItemClient!!.createOrder(authHeader, order) }
        assertEquals(exception.status, HttpStatus.BAD_REQUEST)
        assertTrue(
            exception.response.getBody(String::class.java).orElse(&quot;&quot;).contains(&quot;Items must be supplied&quot;)
        )
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit <em>application.yml</em> so it contains:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">orders</span></span>
<span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="content">${username} </span></span><i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">password</span>: <span class="string"><span class="content">${password} </span></span><i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Placeholder for username that will be populated by Kubernetes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Placeholder for password that will be populated by Kubernetes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit <em>bootstrap.yml</em> file in
the <em>resources</em> directory to <a href="https://docs.micronaut.io/latest/guide/#bootstrap">enable distributed configuration</a>.
Change it to the following:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/resources/bootstrap.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">orders</span></span>
  <span class="key">config-client</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="key">kubernetes</span>:
  <span class="key">client</span>:
    <span class="key">secrets</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="2"></i><b>(2)</b>
      <span class="key">use-api</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>microanut.config-client.enabled: true</code> to read and resolve configuration from distributed sources.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set <code>kubernetes.client.secrets.enabled: true</code> to enable Kubernetes secrets as distributed source.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set <code>kubernetes.client.secrets.use-api: true</code> to use Kubernetes API to fetch configuration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/application-dev.yml</code>. The Micronaut framework applies this configuration file only for the <code>dev</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/resources/application-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">server</span>:
    <span class="key">port</span>: <span class="string"><span class="content">8082 </span></span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_username</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_password</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the application to listen on port 8082.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded username for development environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Hardcoded password for development environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>bootstrap-dev.yml</em> to disable distributed configuration in the dev environment:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/main/resources/bootstrap-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">kubernetes</span>:
  <span class="key">client</span>:
    <span class="key">secrets</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">false </span></span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Disable Kubernetes secrets client.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>application-test.yml</em> to be used in the test environment:</p>
</div>
<div class="listingblock">
<div class="title">orders/src/test/resources/application-test.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">orders</span></span>
<span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_username</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_password</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hardcoded username for development environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded password for development environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the unit test:</p>
</div>
<div class="listingblock">
<div class="title">orders</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./gradlew test</code></pre>
</div>
</div>
<div class="paragraph">
<p><br></p>
</div>
</div>
<div class="sect3">
<h4 id="running-the-application-2">4.2.2. Running the application</h4>
<div class="paragraph">
<p>Run the <code>orders</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">orders</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">MICRONAUT_ENVIRONMENTS=dev ./gradlew run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8082</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="api-gateway-microservice">4.3. API (Gateway) Microservice</h3>
<div class="paragraph">
<p>Create the <code>api</code> microservice using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mn create-app         \
   --features=discovery-kubernetes,management,kubernetes,serialization-jackson,graalvm,mockito \
   --build=gradle           \
   --lang=kotlin             \
   --jdk=17            \
    example.micronaut.api</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add the <code>discovery-kubernetes</code>, <code>management</code>, <code>kubernetes</code>, <code>serialization-jackson</code>, <code>mockito</code> and <code>graalvm</code> features.</p>
</div>
<div class="paragraph">
<p>The previous command creates a directory named <em>api</em> containing a Micronaut application with a package named <code>example.micronaut</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have an existing Micronaut application and want to add the functionality described here, you can <a href="https://micronaut.io/launch?features=discovery-kubernetes&amp;features=management&amp;features=kubernetes&amp;features=serialization-jackson&amp;features=graalvm&amp;features=mockito&amp;lang=KOTLIN&amp;build=GRADLE&amp;test=JUNIT&amp;name=api&amp;type=DEFAULT&amp;package=example.micronaut&amp;activity=diff" target="_blank" rel="noopener">view the dependency and configuration changes from the specified features</a> and apply those changes to your application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a package named <code>controllers</code> and create a <code>GatewayController</code> class to handle incoming HTTP requests to the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/controllers/GatewayController.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.controllers

import example.micronaut.clients.OrdersClient
import example.micronaut.clients.UsersClient
import example.micronaut.models.Item
import example.micronaut.models.Order
import example.micronaut.models.User
import io.micronaut.core.annotation.NonNull
import io.micronaut.http.HttpStatus
import io.micronaut.http.annotation.Body
import io.micronaut.http.annotation.Controller
import io.micronaut.http.annotation.Get
import io.micronaut.http.annotation.Post
import io.micronaut.http.exceptions.HttpStatusException
import io.micronaut.scheduling.TaskExecutors
import io.micronaut.scheduling.annotation.ExecuteOn
import reactor.core.publisher.Flux
import reactor.core.publisher.Mono
import reactor.core.scheduler.Schedulers
import javax.validation.Valid

@Controller(&quot;/api&quot;) <i class="conum" data-value="1"></i><b>(1)</b>
@ExecuteOn(TaskExecutors.IO) <i class="conum" data-value="2"></i><b>(2)</b>
class GatewayController(ordersClient: OrdersClient, usersClient: UsersClient) {

    private val ordersClient: OrdersClient
    private val userClient: UsersClient

    init {
        this.ordersClient = ordersClient
        this.userClient = usersClient
    }


    @Get(&quot;/users/{id}&quot;) <i class="conum" data-value="3"></i><b>(3)</b>
    fun getUserById(@NonNull id: Int): User? {
        return userClient.getById(id)
    }

    @Get(&quot;/orders/{id}&quot;) <i class="conum" data-value="4"></i><b>(4)</b>
    fun getOrdersById(@NonNull id: Int): Order {
        val order = ordersClient.getOrderById(id)

        return Order(
            order.id,
            null,
            getUserById(order.userId!!),
            order.items,
            order.itemIds,
            order.total
        )
    }

    @Get(&quot;/items/{id}&quot;) <i class="conum" data-value="5"></i><b>(5)</b>
    fun getItemsById(@NonNull id: Int): Item {
        return ordersClient.getItemsById(id)
    }

    @Get(&quot;/users&quot;) <i class="conum" data-value="6"></i><b>(6)</b>
    fun getUsers(): List&lt;User&gt; {
        return userClient.users
    }

    @Get(&quot;/items&quot;) <i class="conum" data-value="7"></i><b>(7)</b>
    fun getItems(): List&lt;Item&gt; {
        return ordersClient.items
    }

    @Get(&quot;/orders&quot;) <i class="conum" data-value="8"></i><b>(8)</b>
    fun getOrders(): List&lt;Order&gt;? {
        val orders = mutableListOf&lt;Order&gt;()
        ordersClient.orders.forEach{orders.add(Order(
            it.id,
            null,
            getUserById(it.userId!!),
            it.items,
            it.itemIds,
            it.total))
        }
        return orders
    }

    @Post(&quot;/orders&quot;) <i class="conum" data-value="9"></i><b>(9)</b>
    fun createOrder(@Body order: @Valid Order): Order? {
        val user = getUserById(order!!.userId!!)
            ?: throw  HttpStatusException(
                HttpStatus.BAD_REQUEST,
                String.format(&quot;User with id %s doesn't exist&quot;, order.userId)
            )

        val createdOrder = ordersClient.createOrder(order)

        return Order(
            createdOrder!!.id,
            null,
            user,
            createdOrder.items,
            createdOrder.itemIds,
            createdOrder.total
        )
    }

    @Post(&quot;/users&quot;) <i class="conum" data-value="10"></i><b>(10)</b>
    fun createUser(@Body @NonNull user: User): User {
        return userClient.createUser(user)
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/api</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It is critical that any blocking I/O operations (such as fetching the data from the database) are offloaded to a separate thread pool that does not block the Event loop.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getUserById</code> method to an HTTP GET request on <code>/users/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getOrdersById</code> method to an HTTP GET request on <code>/orders/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getItemsById</code> method to an HTTP GET request on <code>/items/{id}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getUsers</code> method to an HTTP GET request on <code>/users</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getItems</code> method to an HTTP GET request on <code>/items</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>getOrders</code> method to an HTTP GET request on <code>/orders</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation maps the <code>createUser</code> method to an HTTP POST request on <code>/users</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Post.html">@Post</a> annotation maps the <code>createOrder</code> method to an HTTP POST request on <code>/orders</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create package named <code>models</code> where you will put your data beans.</p>
</div>
<div class="paragraph">
<p>The previous <code>GatewayController</code> and <code>ItemsController</code> controller uses <code>User</code>, <code>Order</code> and <code>Item</code> to represent customer orders. Create the <code>User</code> class:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/models/User.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.models

import com.fasterxml.jackson.annotation.JsonProperty
import io.micronaut.core.annotation.Nullable
import io.micronaut.serde.annotation.Serdeable
import javax.validation.constraints.Max
import javax.validation.constraints.NotBlank

@Serdeable <i class="conum" data-value="1"></i><b>(1)</b>
data class User(@Nullable @Max(10000) val id: Int, <i class="conum" data-value="1"></i><b>(1)</b>
                @NotBlank @JsonProperty(&quot;first_name&quot;) val firstName:String,
                @NotBlank @JsonProperty(&quot;last_name&quot;)  val lastName:String,
                val username:String)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the <code>Order</code> class:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/models/Order.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.models

import com.fasterxml.jackson.annotation.JsonProperty
import io.micronaut.core.annotation.Nullable
import io.micronaut.serde.annotation.Serdeable
import java.math.BigDecimal
import javax.validation.constraints.Max
import javax.validation.constraints.NotBlank

@Serdeable <i class="conum" data-value="1"></i><b>(1)</b>
data class Order (
    @Nullable @Max(10000) val id:Int, <i class="conum" data-value="2"></i><b>(2)</b>
    @NotBlank @Nullable @JsonProperty(&quot;user_id&quot;) val userId:Int?,
    @Nullable val user: User?,
    val items: List&lt;Item&gt;?, <i class="conum" data-value="3"></i><b>(3)</b>
    @NotBlank @JsonProperty(&quot;item_ids&quot;) val itemIds:List&lt;Int&gt;?, <i class="conum" data-value="4"></i><b>(4)</b>
    val total: BigDecimal?)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the <code>Item</code> class:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/models/Item.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.models

import com.fasterxml.jackson.annotation.JsonProperty
import io.micronaut.serde.annotation.Serdeable
import java.math.BigDecimal

@Serdeable <i class="conum" data-value="1"></i><b>(1)</b>
data class Item (
    val id:Int,
    val name:String,
    val price: BigDecimal
) {
    companion object {
        var items: List&lt;Item&gt; = listOf(
            Item(1, &quot;Banana&quot;, BigDecimal(&quot;1.5&quot;)),
            Item(2, &quot;Kiwi&quot;, BigDecimal(&quot;2.5&quot;)),
            Item(3, &quot;Grape&quot;, BigDecimal(&quot;1.25&quot;))
        )
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare the <code>@Serdeable</code> annotation at the type level in your source code to allow the type to be serialized or deserialized.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a package named <code>clients</code> where you will put the HTTP Clients to call the <code>users</code> and <code>orders</code> microservices.</p>
</div>
<div class="paragraph">
<p>Create a <code>UserClient</code> for the <code>users</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/clients/UsersClient.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.clients

import example.micronaut.models.User
import io.micronaut.http.annotation.Body
import io.micronaut.http.annotation.Get
import io.micronaut.http.annotation.Post
import io.micronaut.http.client.annotation.Client
import reactor.core.publisher.Flux
import reactor.core.publisher.Mono

@Client(&quot;users&quot;) <i class="conum" data-value="1"></i><b>(1)</b>
interface UsersClient {
    @Get(&quot;/users/{id}&quot;)
    fun getById(id: Int): User

    @Post(&quot;/users&quot;)
    fun createUser(@Body user: User?): User

    @get:Get(&quot;/users&quot;)
    val users: List&lt;User&gt;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create an <code>OrdersClient</code> for the <code>orders</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/clients/OrdersClient.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.clients

import example.micronaut.models.Item
import example.micronaut.models.Order
import io.micronaut.http.annotation.Body
import io.micronaut.http.annotation.Get
import io.micronaut.http.annotation.Post
import io.micronaut.http.client.annotation.Client
import reactor.core.publisher.Flux
import reactor.core.publisher.Mono

@Client(&quot;orders&quot;) <i class="conum" data-value="1"></i><b>(1)</b>
interface OrdersClient {
    @Get(&quot;/orders/{id}&quot;)
    fun getOrderById(id: Int): Order

    @Post(&quot;/orders&quot;)
    fun createOrder(@Body order: Order?): Order

    @get:Get(&quot;/orders&quot;)
    val orders: List&lt;Order&gt;

    @get:Get(&quot;/items&quot;)
    val items: List&lt;Item&gt;

    @Get(&quot;/items/{id}&quot;)
    fun getItemsById(id: Int): Item
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a package named <code>auth</code> where we will check basic authentication credentials.</p>
</div>
<div class="paragraph">
<p>Create a <code>Credentials</code> class that will load the username and password from configuration that will be needed for comparison.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/auth/Credentials.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.auth

import io.micronaut.context.annotation.ConfigurationProperties

@ConfigurationProperties(&quot;authentication-credentials&quot;) <i class="conum" data-value="1"></i><b>(1)</b>
class Credentials{
    lateinit var username: String
    lateinit var password: String
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@ConfigurationProperties</code> annotation takes the configuration prefix.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create an <code>AuthClientFilter</code> class that is a client filter applied to every client. It adds basic authentication header with credentials that are stored in the <code>Credentials</code> class.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/auth/AuthClientFilter.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut.auth

import io.micronaut.http.HttpResponse
import io.micronaut.http.MutableHttpRequest
import io.micronaut.http.annotation.Filter
import io.micronaut.http.filter.ClientFilterChain
import io.micronaut.http.filter.HttpClientFilter
import org.reactivestreams.Publisher

@Filter(Filter.MATCH_ALL_PATTERN)
class AuthClientFilter(credentials: Credentials) : HttpClientFilter {
    private val credentials: Credentials

    init {
        this.credentials = credentials
    }

    override fun doFilter(request: MutableHttpRequest&lt;*&gt;, chain: ClientFilterChain): Publisher&lt;out HttpResponse&lt;*&gt;?&gt; {
        return chain.proceed(request.basicAuth(credentials.username, credentials.password))
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a class named <code>ErrorExceptionHandler</code> in the <code>example.micronaut</code> package. <code>ErrorExceptionHandler</code> will propagate errors from the <code>orders</code> and <code>users</code> microservices.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/kotlin/example/micronaut/ErrorExceptionHandler.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import io.micronaut.http.HttpRequest
import io.micronaut.http.HttpResponse
import io.micronaut.http.client.exceptions.HttpClientResponseException
import io.micronaut.http.server.exceptions.ExceptionHandler
import jakarta.inject.Singleton

@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
class ErrorExceptionHandler :
    ExceptionHandler&lt;HttpClientResponseException, HttpResponse&lt;*&gt;&gt; {
    override fun handle(request: HttpRequest&lt;*&gt;?, exception: HttpClientResponseException): HttpResponse&lt;*&gt; {
        return HttpResponse.status&lt;Any&gt;(exception.response.status()).body(
            exception.response.getBody(
                String::class.java
            ).orElse(null)
        )
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><br></p>
</div>
<div class="sect3">
<h4 id="write-tests-to-verify-application-logic-3">4.3.1. Write tests to verify application logic</h4>
<div class="paragraph">
<p>Create a <code>GatewayClient</code>, a declarative Micronaut HTTP Client for testing:</p>
</div>
<div class="listingblock">
<div class="title">api/src/test/kotlin/example/micronaut/GatewayClient.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import example.micronaut.models.Item
import example.micronaut.models.Order
import example.micronaut.models.User
import io.micronaut.http.annotation.Body
import io.micronaut.http.annotation.Get
import io.micronaut.http.annotation.Post
import io.micronaut.http.client.annotation.Client

@Client(&quot;/&quot;) <i class="conum" data-value="1"></i><b>(1)</b>
interface GatewayClient {
    @Get(&quot;/api/items/{id}&quot;)
    fun getItemById(id: Int?): Item?

    @Get(&quot;/api/orders/{id}&quot;)
    fun getOrderById(id: Int?): Order?

    @Get(&quot;/api/users/{id}&quot;)
    fun getUsersById(id: Int?): User?

    @get:Get(&quot;/api/users&quot;)
    val users: List&lt;User&gt;

    @get:Get(&quot;/api/items&quot;)
    val items: List&lt;Item&gt;

    @get:Get(&quot;/api/orders&quot;)
    val orders: List&lt;Order&gt;

    @Post(&quot;/api/orders&quot;)
    fun createOrder(@Body order: Order): Order

    @Post(&quot;/api/users&quot;)
    fun createUser(@Body user: User): User
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>HealthTest</code> checks that there is <code>/health</code> endpoint that is required for service discovery.</p>
</div>
<div class="listingblock">
<div class="title">api/src/test/kotlin/example/micronaut/HealthTest.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import io.micronaut.http.HttpRequest
import io.micronaut.http.HttpStatus
import io.micronaut.http.client.HttpClient
import io.micronaut.http.client.annotation.Client
import io.micronaut.test.extensions.junit5.annotation.MicronautTest
import jakarta.inject.Inject
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.api.Test

@MicronautTest <i class="conum" data-value="1"></i><b>(1)</b>
class HealthTest {

    @Inject
    @field:Client(&quot;/&quot;)
    lateinit var client: HttpClient <i class="conum" data-value="2"></i><b>(2)</b>

    @Test
    fun healthEndpointExposed() {
        val status = client.toBlocking().retrieve(
            HttpRequest.GET&lt;Any&gt;(&quot;/health&quot;),
            HttpStatus::class.java
        )
        assertEquals(HttpStatus.OK, status)
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject the <code>HttpClient</code> bean and point it to the embedded server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>GatewayControllerTest</code> tests endpoints inside the <code>GatewayController</code>.</p>
</div>
<div class="listingblock">
<div class="title">api/src/test/kotlin/example/micronaut/GatewayControllerTest.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import example.micronaut.clients.OrdersClient
import example.micronaut.clients.UsersClient
import example.micronaut.models.Item
import example.micronaut.models.Order
import example.micronaut.models.User
import io.micronaut.http.HttpResponse
import io.micronaut.http.HttpStatus
import io.micronaut.http.client.exceptions.HttpClientResponseException
import io.micronaut.test.annotation.MockBean
import io.micronaut.test.extensions.junit5.annotation.MicronautTest
import jakarta.inject.Inject
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.api.Assertions.assertNotNull
import org.junit.jupiter.api.Assertions.assertNull
import org.junit.jupiter.api.Assertions.assertThrows
import org.junit.jupiter.api.Assertions.assertTrue
import org.junit.jupiter.api.Test
import org.mockito.ArgumentMatchers.any
import org.mockito.Mockito.mock
import org.mockito.Mockito.`when`
import java.math.BigDecimal

@MicronautTest <i class="conum" data-value="1"></i><b>(1)</b>
class GatewayControllerTest {
    @Inject
    var ordersClient: OrdersClient? = null

    @Inject
    var usersClient: UsersClient? = null

    @Inject
    var gatewayClient: GatewayClient? = null

    @MockBean(OrdersClient::class)
    fun ordersClient(): OrdersClient {
        return mock(OrdersClient::class.java)
    }

    @MockBean(UsersClient::class)
    fun usersClient(): UsersClient {
        return mock(UsersClient::class.java)
    }

    @Test
    fun itemById() {
        val itemId = 1
        val item = Item(itemId, &quot;test&quot;, BigDecimal.ONE)
        `when`(ordersClient!!.getItemsById(1)).thenReturn(item)
        val retrievedItem = gatewayClient!!.getItemById(item.id)
        assertEquals(item.id, retrievedItem!!.id)
        assertEquals(item.name, retrievedItem.name)
        assertEquals(item.price, retrievedItem.price)
    }

    @Test
    fun orderById() {
        val order = Order(1, 2, null, null, ArrayList(), null)
        val user = User(order.userId!!, &quot;firstName&quot;, &quot;lastName&quot;, &quot;test&quot;)
        `when`(ordersClient!!.getOrderById(1)).thenReturn(order)
        `when`(usersClient!!.getById(user.id)).thenReturn(user)
        val retrievedOrder = gatewayClient!!.getOrderById(order.id)
        assertEquals(order.id, retrievedOrder!!.id)
        assertEquals(order.userId, retrievedOrder.user!!.id)
        assertNull(retrievedOrder.userId)
        assertEquals(user.username, retrievedOrder.user!!.username)
    }

    @Test
    fun userById() {
        val user = User(1, &quot;firstName&quot;, &quot;lastName&quot;, &quot;test&quot;)
        `when`(usersClient!!.getById(1)).thenReturn(user)
        val retrievedUser = gatewayClient!!.getUsersById(user.id)
        assertEquals(user.id, retrievedUser!!.id)
        assertEquals(user.username, retrievedUser.username)
    }

    @Test
    fun users() {
        val user = User(1, &quot;firstName&quot;, &quot;lastName&quot;, &quot;test&quot;)
        `when`(usersClient!!.users).thenReturn(listOf(user))
        val users = gatewayClient!!.users
        assertNotNull(users)
        assertEquals(1, users.size)
        assertEquals(user.id, users[0].id)
        assertEquals(user.username, users[0].username)
    }

    @Test
    fun items() {
        val item = Item(1, &quot;test&quot;, BigDecimal.ONE)
        `when`(ordersClient!!.items).thenReturn(listOf(item))
        val items = gatewayClient!!.items
        assertNotNull(items)
        assertEquals(1, items.size)
        assertEquals(item.name, items[0].name)
        assertEquals(item.price, items[0].price)
    }

    @Test
    fun orders() {
        val order = Order(1, 2, null, null, ArrayList(), null)
        val user = User(order.userId!!, &quot;firstName&quot;, &quot;lastName&quot;, &quot;test&quot;)
        `when`(ordersClient!!.orders).thenReturn(listOf(order))
        `when`(usersClient!!.getById(order.userId!!)).thenReturn(user)
        val orders = gatewayClient!!.orders
        assertNotNull(orders)
        assertEquals(1, orders.size)
        assertNull(orders[0].userId)
        assertEquals(user.id, orders[0].user!!.id)
        assertEquals(order.id, orders[0].id)
        assertEquals(user.username, orders[0].user!!.username)
    }

    @Test
    fun createUser() {
        val firstName = &quot;firstName&quot;
        val lastName = &quot;lastName&quot;
        val username = &quot;username&quot;
        val user = User(0, firstName, lastName, username)
        `when`(usersClient!!.createUser(any())).thenReturn(user)
        val createdUser = gatewayClient!!.createUser(user)
        assertEquals(firstName, createdUser.firstName)
        assertEquals(lastName, createdUser.lastName)
        assertEquals(username, createdUser.username)
    }

    @Test
    fun createOrder() {
        val order = Order(1, 2, null, null, ArrayList(), null)
        val user = User(order.userId!!, &quot;firstName&quot;, &quot;lastName&quot;, &quot;test&quot;)
        `when`(usersClient!!.getById(user.id)).thenReturn(user)
        `when`(ordersClient!!.createOrder(any())).thenReturn(order)
        val createdOrder = gatewayClient!!.createOrder(order)
        assertEquals(order.id, createdOrder.id)
        assertNull(createdOrder.userId)
        assertEquals(order.userId, createdOrder.user!!.id)
        assertEquals(user.username, createdOrder.user!!.username)
    }

    @Test
    fun createOrderUserDoesntExists() {
        val order = Order(1, 2, null, null, ArrayList(), BigDecimal(0))
        `when`(ordersClient!!.createOrder(any())).thenReturn(order)
        `when`(usersClient!!.getById(order.userId!!)).thenReturn(null)
        val exception = assertThrows(
            HttpClientResponseException::class.java
        ) { gatewayClient!!.createOrder(order) }
        assertEquals(exception.status, HttpStatus.BAD_REQUEST)
        assertTrue(
            exception.response.getBody(String::class.java).orElse(&quot;&quot;).contains(&quot;User with id 2 doesn't exist&quot;)
        )
    }

    @Test
    fun exceptionHandler() {
        val user = User(1, &quot;firstname&quot;, &quot;lastname&quot;, &quot;username&quot;)
        val message = &quot;Test error message&quot;
        `when`(usersClient!!.createUser(any())).thenThrow(
            HttpClientResponseException(
                &quot;Test&quot;,
                HttpResponse.badRequest(message)
            )
        )
        val exception = assertThrows(
            HttpClientResponseException::class.java
        ) { gatewayClient!!.createUser(user) }
        assertEquals(exception.status, HttpStatus.BAD_REQUEST)
        assertTrue(exception.response.getBody(String::class.java).orElse(&quot;&quot;).contains(&quot;Test error message&quot;))
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit <em>application.yml</em></p>
</div>
<div class="listingblock">
<div class="title">api/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">api</span></span>
<span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="content">${username} </span></span><i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">password</span>: <span class="string"><span class="content">${password} </span></span><i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Placeholder for username that will be populated by Kubernetes.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Placeholder for password that will be populated by Kubernetes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit the <em>bootstrap.yml</em> file in the <em>resources</em> directory to <a href="https://docs.micronaut.io/latest/guide/#bootstrap">enable distributed configuration</a> so it looks like the following:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/resources/bootstrap.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">api</span></span>
  <span class="key">config-client</span>:
    <span class="key">enabled</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="key">kubernetes</span>:
  <span class="key">client</span>:
    <span class="key">secrets</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="2"></i><b>(2)</b>
      <span class="key">use-api</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>microanut.config-client.enabled: true</code> to read and resolve configuration from distributed sources.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set <code>kubernetes.client.secrets.enabled: true</code> to enable Kubernetes secrets as a distributed source.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set <code>kubernetes.client.secrets.use-api: true</code> to use the  Kubernetes API to fetch configuration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/application-dev.yml</code>. The Micronaut framework applies this configuration file only for the <code>dev</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/resources/application-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_username</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_password</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hardcoded username for development environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded password for development environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>bootstrap-dev.yml</em> to disable distributed configuration in the dev environment:</p>
</div>
<div class="listingblock">
<div class="title">api/src/main/resources/bootstrap-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">http</span>:
    <span class="key">services</span>:
      <span class="key">users</span>:
        <span class="key">urls</span>:
          - <span class="string"><span class="content">http://localhost:8081 </span></span><i class="conum" data-value="1"></i><b>(1)</b>
      <span class="key">orders</span>:
        <span class="key">urls</span>:
          - <span class="string"><span class="content">http://localhost:8082 </span></span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="key">kubernetes</span>:
  <span class="key">client</span>:
    <span class="key">secrets</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">false </span></span><i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>URL of the <code>users</code> microservice</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>URL of the <code>orders</code> microservice</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Disable Kubernetes secrets client.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <em>application-test.yml</em> to be used in the test environment:</p>
</div>
<div class="listingblock">
<div class="title">api/src/test/resources/application-test.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">authentication-credentials</span>:
  <span class="key">username</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_username</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">test_password</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hardcoded username for development environment.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Hardcoded password for development environment.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the unit test:</p>
</div>
<div class="listingblock">
<div class="title">api</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./gradlew test</code></pre>
</div>
</div>
<div class="paragraph">
<p><br></p>
</div>
</div>
<div class="sect3">
<h4 id="running-the-application-3">4.3.2. Running the application</h4>
<div class="paragraph">
<p>Run <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">api</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">MICRONAUT_ENVIRONMENTS=dev ./gradlew run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="test-integration-between-applications">4.4. Test integration between applications</h3>
<div class="paragraph">
<p>Store the URL of the <code>api</code> microservice in the <code>API_URL</code> environment variable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">export API_URL=http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run a cURL command to create a new user via the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X &quot;POST&quot; &quot;$API_URL/api/users&quot; -H 'Content-Type: application/json; charset=utf-8' -d '{ &quot;first_name&quot;: &quot;Nemanja&quot;, &quot;last_name&quot;: &quot;Mikic&quot;, &quot;username&quot;: &quot;nmikic&quot; }'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">nmikic</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Nemanja</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Mikic</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run a cURL command to a new order via the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X &quot;POST&quot; &quot;$API_URL/api/orders&quot; -H 'Content-Type: application/json; charset=utf-8' -d '{ &quot;user_id&quot;: 1, &quot;item_ids&quot;: [1,2] }'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Nemanja</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Mikic</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">nmikic</span><span class="delimiter">&quot;</span></span>},<span class="key"><span class="delimiter">&quot;</span><span class="content">items</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Banana</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>:<span class="float">1.5</span>},{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">2</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Kiwi</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>:<span class="float">2.5</span>}],<span class="key"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>:<span class="float">4.0</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run a cURL command to list created orders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl &quot;$API_URL/api/orders&quot; -H 'Content-Type: application/json; charset=utf-8'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">[{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Nemanja</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Mikic</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">nmikic</span><span class="delimiter">&quot;</span></span>},<span class="key"><span class="delimiter">&quot;</span><span class="content">items</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Banana</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>:<span class="float">1.5</span>},{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">2</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Kiwi</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>:<span class="float">2.5</span>}],<span class="key"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>:<span class="float">4.0</span>}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can try to place an order for a user who doesn&#8217;t exist (with id 100). Run a cURL command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X &quot;POST&quot; &quot;$API_URL/api/orders&quot; -H 'Content-Type: application/json; charset=utf-8' -d '{ &quot;user_id&quot;: 100, &quot;item_ids&quot;: [1,2] }'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Bad Request</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">_links</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">self</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">href</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/orders</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">templated</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>}]},<span class="key"><span class="delimiter">&quot;</span><span class="content">_embedded</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">errors</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">User with id 100 doesn't exist</span><span class="delimiter">&quot;</span></span>}]}}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kubernetes-and-the-micronaut-framework">5. Kubernetes and the Micronaut framework</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we will first create the necessary Kubernetes resources for our microservices that will make them work properly then we will configure, build container images and deploy each of the microservices that we created on the local Kubernetes cluster.</p>
</div>
<div class="paragraph">
<p>Create a filed named <em>auth.yml</em>  that will service role for microservices that have secret configurations.</p>
</div>
<div class="listingblock">
<div class="title">auth.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Namespace </span></span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="key">metadata</span>:
  <span class="key">name</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
<span class="head"><span class="head">---</span></span>
<span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">ServiceAccount </span></span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="content">micronaut-service</span></span>
<span class="head"><span class="head">---</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Role </span></span><i class="conum" data-value="3"></i><b>(3)</b>
<span class="key">apiVersion</span>: <span class="string"><span class="content">rbac.authorization.k8s.io/v1</span></span>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="content">micronaut_service_role</span></span>
<span class="key">rules</span>:
  - <span class="string"><span class="content">apiGroups: [&quot;&quot;]</span></span>
    <span class="key">resources</span>: <span class="string"><span class="content">[&quot;services&quot;, &quot;endpoints&quot;, &quot;configmaps&quot;, &quot;secrets&quot;, &quot;pods&quot;]</span></span>
    <span class="key">verbs</span>: <span class="string"><span class="content">[&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]</span></span>
<span class="head"><span class="head">---</span></span>
<span class="key">apiVersion</span>: <span class="string"><span class="content">rbac.authorization.k8s.io/v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">RoleBinding </span></span><i class="conum" data-value="4"></i><b>(4)</b>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="content">micronaut_service_role_bind</span></span>
<span class="key">subjects</span>:
  - <span class="string"><span class="content">kind: ServiceAccount</span></span>
    <span class="key">name</span>: <span class="string"><span class="content">micronaut-service</span></span>
<span class="key">roleRef</span>:
  <span class="key">kind</span>: <span class="string"><span class="content">Role</span></span>
  <span class="key">name</span>: <span class="string"><span class="content">micronaut_service_role</span></span>
  <span class="key">apiGroup</span>: <span class="string"><span class="content">rbac.authorization.k8s.io</span></span>
<span class="head"><span class="head">---</span></span>
<span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Secret </span></span><i class="conum" data-value="5"></i><b>(5)</b>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="content">mysecret</span></span>
<span class="key">type</span>: <span class="string"><span class="content">Opaque</span></span>
<span class="key">data</span>:
  <span class="key">username</span>: <span class="string"><span class="content">YWRtaW4= </span></span><i class="conum" data-value="6"></i><b>(6)</b>
  <span class="key">password</span>: <span class="string"><span class="content">bWljcm9uYXV0aXNhd2Vzb21l </span></span><i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We create a namespace named <code>micronaut-k8s</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We create a service account named <code>micronaut-service</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We create a role named <code>micronaut_service_role</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We bind  the <code>micronaut_service_role</code> role to the <code>micronaut-service</code> service account.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We create a secret named <code>mysecret</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Base64 value of the username secret that will be used by the microservices.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Base64 value of the password secret that will be used by the microservices.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the next command to create the resources described above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -f auth.yml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before we start deploying each service, ensure that Docker daemon is configured to use Kubernetes.
If you are using <a href="https://minikube.sigs.k8s.io/">Minikube</a> run the next command to switch the docker daemon to use Minikube.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">eval $(minikube docker-env)</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="users-microservice-2">5.1. Users Microservice</h3>
<div class="paragraph">
<p><a href="https://guides.micronaut.io/latest/micronaut-docker-image.html">Build a docker image</a> of the <code>users</code> service with the name <code>users</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to build a docker Native image with <code>dockerBuildNative</code> and you are using <a href="https://minikube.sigs.k8s.io/">Minikube</a> make sure that it is configured with enough memory. If you keep getting "Read timeout error" try to build image using <code>docker build . -t users -f DockerfileNative</code> inside <code>users/build/docker/native-main</code> directory.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit the file named <em>k8s.yml</em> inside the <code>users</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">/users/k8s.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">apps/v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Deployment</span></span>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span>
<span class="key">spec</span>:
  <span class="key">selector</span>:
    <span class="key">matchLabels</span>:
      <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span>
  <span class="key">template</span>:
    <span class="key">metadata</span>:
      <span class="key">labels</span>:
        <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span>
    <span class="key">spec</span>:
      <span class="key">serviceAccountName</span>: <span class="string"><span class="content">micronaut-service </span></span><i class="conum" data-value="1"></i><b>(1)</b>
      <span class="key">containers</span>:
        - <span class="string"><span class="content">name: &quot;users&quot;</span></span>
          <span class="key">image</span>: <span class="string"><span class="content">users </span></span><i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">imagePullPolicy</span>: <span class="string"><span class="content">Never </span></span><i class="conum" data-value="3"></i><b>(3)</b>
          <span class="key">ports</span>:
            - <span class="string"><span class="content">name: http</span></span>
              <span class="key">containerPort</span>: <span class="string"><span class="content">8080</span></span>
          <span class="key">readinessProbe</span>:
            <span class="key">httpGet</span>:
              <span class="key">path</span>: <span class="string"><span class="content">/health/readiness</span></span>
              <span class="key">port</span>: <span class="string"><span class="content">8080</span></span>
            <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">5</span></span>
            <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">3</span></span>
          <span class="key">livenessProbe</span>:
            <span class="key">httpGet</span>:
              <span class="key">path</span>: <span class="string"><span class="content">/health/liveness</span></span>
              <span class="key">port</span>: <span class="string"><span class="content">8080</span></span>
            <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">5</span></span>
            <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">3</span></span>
            <span class="key">failureThreshold</span>: <span class="string"><span class="content">10</span></span>
<span class="head"><span class="head">---</span></span>
<span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Service</span></span>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="key">spec</span>:
  <span class="key">selector</span>:
    <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span>
  <span class="key">type</span>: <span class="string"><span class="content">NodePort</span></span>
  <span class="key">ports</span>:
    - <span class="string"><span class="content">protocol: &quot;TCP&quot;</span></span>
      <span class="key">port</span>: <span class="string"><span class="content">8080  </span></span><i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The service name that we created in the <em>auth.yaml</em> file.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The name of the container image for deployment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The imagePullPolicy is set to Never. We will always use local one that we built in previous step.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Name of a service, required for service discovery.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Micronaut default port on which application is running.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the next command to create the resources described above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -f users/k8s.yml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">deployment.apps/users created
service/users created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="orders-microservice-2">5.2. Orders Microservice</h3>
<div class="paragraph">
<p><a href="https://guides.micronaut.io/latest/micronaut-docker-image.html">Build a docker image</a> of the <code>orders</code> service with the name <code>orders</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to build a docker Native image with <code>dockerBuildNative</code> and you are using <a href="https://minikube.sigs.k8s.io/">Minikube</a> make sure that it is configured with enough memory. If you keep getting "Read timeout error" try to build image using <code>docker build . -t orders -f DockerfileNative</code> inside <code>orders/build/docker/native-main</code> directory.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit the file named <em>k8s.yml</em> inside the <code>orders</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">/orders/k8s.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">apps/v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Deployment</span></span>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">orders</span><span class="delimiter">&quot;</span></span>
<span class="key">spec</span>:
  <span class="key">selector</span>:
    <span class="key">matchLabels</span>:
      <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">orders</span><span class="delimiter">&quot;</span></span>
  <span class="key">template</span>:
    <span class="key">metadata</span>:
      <span class="key">labels</span>:
        <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">orders</span><span class="delimiter">&quot;</span></span>
    <span class="key">spec</span>:
      <span class="key">serviceAccountName</span>: <span class="string"><span class="content">micronaut-service  </span></span><i class="conum" data-value="1"></i><b>(1)</b>
      <span class="key">containers</span>:
        - <span class="string"><span class="content">name: &quot;orders&quot;</span></span>
          <span class="key">image</span>: <span class="string"><span class="content">orders  </span></span><i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">imagePullPolicy</span>: <span class="string"><span class="content">Never  </span></span><i class="conum" data-value="3"></i><b>(3)</b>
          <span class="key">ports</span>:
            - <span class="string"><span class="content">name: http</span></span>
              <span class="key">containerPort</span>: <span class="string"><span class="content">8080</span></span>
          <span class="key">readinessProbe</span>:
            <span class="key">httpGet</span>:
              <span class="key">path</span>: <span class="string"><span class="content">/health/readiness</span></span>
              <span class="key">port</span>: <span class="string"><span class="content">8080</span></span>
            <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">5</span></span>
            <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">3</span></span>
          <span class="key">livenessProbe</span>:
            <span class="key">httpGet</span>:
              <span class="key">path</span>: <span class="string"><span class="content">/health/liveness</span></span>
              <span class="key">port</span>: <span class="string"><span class="content">8080</span></span>
            <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">5</span></span>
            <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">3</span></span>
            <span class="key">failureThreshold</span>: <span class="string"><span class="content">10</span></span>
<span class="head"><span class="head">---</span></span>
<span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Service</span></span>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">orders</span><span class="delimiter">&quot;</span></span>  <i class="conum" data-value="4"></i><b>(4)</b>
<span class="key">spec</span>:
  <span class="key">selector</span>:
    <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">orders</span><span class="delimiter">&quot;</span></span>
  <span class="key">type</span>: <span class="string"><span class="content">NodePort</span></span>
  <span class="key">ports</span>:
    - <span class="string"><span class="content">protocol: &quot;TCP&quot;</span></span>
      <span class="key">port</span>: <span class="string"><span class="content">8080  </span></span><i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The service name that we created in the <em>auth.yaml</em> file.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The name of the container image for deployment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The imagePullPolicy is set to Never. We will always use local one that we built in previous step.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Name of a service, required for service discovery.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Micronaut default port on which application is running.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the next command to create the resources described above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -f orders/k8s.yml</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="api-gateway-microservice-2">5.3. API (Gateway) Microservice</h3>
<div class="paragraph">
<p><a href="https://guides.micronaut.io/latest/micronaut-docker-image.html">Build a docker image</a> of the <code>api</code> service with the name <code>api</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to build a docker Native image with <code>dockerBuildNative</code> and you are using <a href="https://minikube.sigs.k8s.io/">Minikube</a> make sure that it is configured with enough memory. If you keep getting "Read timeout error" try to build image using <code>docker build . -t api -f DockerfileNative</code> inside <code>api/build/docker/native-main</code> directory.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit the file named <em>k8s.yml</em> inside the <code>api</code> microservice.</p>
</div>
<div class="listingblock">
<div class="title">/api/k8s.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">apiVersion</span>: <span class="string"><span class="content">apps/v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Deployment</span></span>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">api</span><span class="delimiter">&quot;</span></span>
<span class="key">spec</span>:
  <span class="key">selector</span>:
    <span class="key">matchLabels</span>:
      <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">api</span><span class="delimiter">&quot;</span></span>
  <span class="key">template</span>:
    <span class="key">metadata</span>:
      <span class="key">labels</span>:
        <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">api</span><span class="delimiter">&quot;</span></span>
    <span class="key">spec</span>:
      <span class="key">serviceAccountName</span>: <span class="string"><span class="content">micronaut-service </span></span><i class="conum" data-value="1"></i><b>(1)</b>
      <span class="key">containers</span>:
        - <span class="string"><span class="content">name: &quot;api&quot;</span></span>
          <span class="key">image</span>: <span class="string"><span class="content">api  </span></span><i class="conum" data-value="2"></i><b>(2)</b>
          <span class="key">imagePullPolicy</span>: <span class="string"><span class="content">Never  </span></span><i class="conum" data-value="3"></i><b>(3)</b>
          <span class="key">ports</span>:
            - <span class="string"><span class="content">name: http</span></span>
              <span class="key">containerPort</span>: <span class="string"><span class="content">8080</span></span>
          <span class="key">readinessProbe</span>:
            <span class="key">httpGet</span>:
              <span class="key">path</span>: <span class="string"><span class="content">/health/readiness</span></span>
              <span class="key">port</span>: <span class="string"><span class="content">8080</span></span>
            <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">5</span></span>
            <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">3</span></span>
          <span class="key">livenessProbe</span>:
            <span class="key">httpGet</span>:
              <span class="key">path</span>: <span class="string"><span class="content">/health/liveness</span></span>
              <span class="key">port</span>: <span class="string"><span class="content">8080</span></span>
            <span class="key">initialDelaySeconds</span>: <span class="string"><span class="content">5</span></span>
            <span class="key">timeoutSeconds</span>: <span class="string"><span class="content">3</span></span>
            <span class="key">failureThreshold</span>: <span class="string"><span class="content">10</span></span>
<span class="head"><span class="head">---</span></span>
<span class="key">apiVersion</span>: <span class="string"><span class="content">v1</span></span>
<span class="key">kind</span>: <span class="string"><span class="content">Service</span></span>
<span class="key">metadata</span>:
  <span class="key">namespace</span>: <span class="string"><span class="content">micronaut-k8s</span></span>
  <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">api</span><span class="delimiter">&quot;</span></span>  <i class="conum" data-value="4"></i><b>(4)</b>
<span class="key">spec</span>:
  <span class="key">selector</span>:
    <span class="key">app</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">api</span><span class="delimiter">&quot;</span></span>
  <span class="key">type</span>: <span class="string"><span class="content">LoadBalancer</span></span>
  <span class="key">ports</span>:
    - <span class="string"><span class="content">protocol: &quot;TCP&quot;</span></span>
      <span class="key">port</span>: <span class="string"><span class="content">8080  </span></span><i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The service name that we created in the <em>auth.yaml</em> file.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The name of the container image for deployment.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The imagePullPolicy is set to Never. We will always use local one that we built in previous step.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Name of a service, required for service discovery.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Micronaut default port on which application is running.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the next command to create the resources described above:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl apply -f api/k8s.yml</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="test-integration-between-applications-deployed-on-kubernetes">5.4. Test integration between applications deployed on Kubernetes</h3>
<div class="paragraph">
<p>Run the next command to check status of the pods and make sure that all of them have the status "Running":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl get pods -n=micronaut-k8s</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">NAME                      READY   STATUS    RESTARTS   AGE
api-774fd667b9-dmws4      1/1     Running   0          24s
orders-74ff4fcbc4-dnfbw   1/1     Running   0          19s
users-9f46dd7c6-vs8z7     1/1     Running   0          13s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the next command to check the status of the microservices:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl get services -n=micronaut-k8s</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="minikube">5.4.1. Minikube</h4>
<div class="paragraph">
<p>For Minikube the output should be similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">NAME     TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
api      LoadBalancer   10.110.42.201    &lt;pending&gt;     8080:32601/TCP   18s
orders   NodePort       10.105.43.19     &lt;none&gt;        8080:31033/TCP   21s
users    NodePort       10.104.130.114   &lt;none&gt;        8080:31482/TCP   26s</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, the EXTERNAL-IP address  of the LoadBalancer service inside Minikube will be in the &lt;pending&gt; state. If you want to assign an external ip you have to run the <code>minikube tunnel</code> command.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Run the next command to retrieve the URL of the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">export API_URL=$(minikube service api -n=micronaut-k8s --url)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="docker-desktop">5.4.2. Docker Desktop</h4>
<div class="paragraph">
<p>For Docker Desktop&#8217;s Kubernetes integration the output should be similar to the following.  Notice the external-ip is <code>localhost</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">NAME     TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
api      LoadBalancer   10.108.205.248   localhost     8080:31516/TCP   9m23s
orders   NodePort       10.98.120.224    &lt;none&gt;        8080:31566/TCP   9m39s
users    NodePort       10.109.155.86    &lt;none&gt;        8080:30545/TCP   10m</code></pre>
</div>
</div>
<div class="paragraph">
<p>So for Docker Desktop the <code>API_URL</code> should be set to <code><a href="http://localhost:8080" class="bare">http://localhost:8080</a></code>.</p>
</div>
<div class="paragraph">
<p>Run a cURL command to create a new user via the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X &quot;POST&quot; &quot;$API_URL/api/users&quot; -H 'Content-Type: application/json; charset=utf-8' -d '{ &quot;first_name&quot;: &quot;Nemanja&quot;, &quot;last_name&quot;: &quot;Mikic&quot;, &quot;username&quot;: &quot;nmikic&quot; }'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">nmikic</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Nemanja</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Mikic</span><span class="delimiter">&quot;</span></span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run a cURL command to a new order via the <code>api</code> microservice:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X &quot;POST&quot; &quot;$API_URL/api/orders&quot; -H 'Content-Type: application/json; charset=utf-8' -d '{ &quot;user_id&quot;: 1, &quot;item_ids&quot;: [1,2] }'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Nemanja</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Mikic</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">nmikic</span><span class="delimiter">&quot;</span></span>},<span class="key"><span class="delimiter">&quot;</span><span class="content">items</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Banana</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>:<span class="float">1.5</span>},{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">2</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Kiwi</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>:<span class="float">2.5</span>}],<span class="key"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>:<span class="float">4.0</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run a cURL command to list created orders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl &quot;$API_URL/api/orders&quot; -H 'Content-Type: application/json; charset=utf-8'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">[{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Nemanja</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Mikic</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">nmikic</span><span class="delimiter">&quot;</span></span>},<span class="key"><span class="delimiter">&quot;</span><span class="content">items</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">1</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Banana</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>:<span class="float">1.5</span>},{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="integer">2</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Kiwi</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">price</span><span class="delimiter">&quot;</span></span>:<span class="float">2.5</span>}],<span class="key"><span class="delimiter">&quot;</span><span class="content">total</span><span class="delimiter">&quot;</span></span>:<span class="float">4.0</span>}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can try to place an order for a user who doesn&#8217;t exist (with id 100). Run a cURL command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X &quot;POST&quot; &quot;$API_URL/api/orders&quot; -H 'Content-Type: application/json; charset=utf-8' -d '{ &quot;user_id&quot;: 100, &quot;item_ids&quot;: [1,2] }'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Bad Request</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">_links</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">self</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">href</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">/api/orders</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">templated</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>}]},<span class="key"><span class="delimiter">&quot;</span><span class="content">_embedded</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">errors</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">User with id 100 doesn't exist</span><span class="delimiter">&quot;</span></span>}]}}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cleaning-up">6. Cleaning Up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To delete all resources that were created in this guide run next command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">kubectl delete namespaces micronaut-k8s</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="next-steps">7. Next steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Read more about <a href="https://kubernetes.io/docs/home/">Kubernetes</a>.</p>
</div>
<div class="paragraph">
<p>Read more about <a href="https://micronaut-projects.github.io/micronaut-kubernetes/snapshot/guide/">Micronaut Kubernetes</a> module.</p>
</div>

            </div>
        </div>
    </div>
</main>

<footer id="footer">
    <div class="container">

        <div class="row">
            <div class="col-sm-5 footer-left">

                <div id="text-14" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <img class="alignnone size-medium wp-image-3736" src="./images/micronaut_foundation_horizontal_white.svg" alt="Micronaut Foundation"/>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-sm-7 footer-right">

                <ul class="meta">

                    <li id="menu-item-2895" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2895">
                        <a href="https://micronaut.io/brand-guidelines/">Brand Guidelines</a>
                    </li>
                    <li id="menu-item-2894" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2894">
                        <a href="https://micronaut.io/community-guidelines/">Community Guidelines</a>
                    </li>
                    <li id="menu-item-3377" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-privacy-policy menu-item-3377">
                        <a href="https://micronaut.io/privacy-policy/">Privacy Policy</a>
                    </li>

                </ul>

                <div id="nav_menu-2" class="widget widget_nav_menu">
                    <div class="menu-links-container">
                        <ul id="menu-links" class="menu">
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronautpodcast.com"><i class="fa fa-podcast"><span class="sr-only">Podcast</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronaut.io/feed/rss/"><i class="fa fa-feed"><span class="sr-only">Feed</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="mailto:info@micronaut.io"><i class="fas fa-envelope"><span class="sr-only">Mail</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://twitter.com/micronautfw"><i class="fab fa-twitter"><span class="sr-only">Twitter</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://matrix.to/#/#micronautfw_questions:gitter.im"><i class="fab fa-gitter"><span class="sr-only">Gitter</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://github.com/micronaut-projects/"><i class="fab fa-github"><span class="sr-only">GitHub</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.youtube.com/@MicronautFramework"><i class="fab fa-youtube"><span class="sr-only">YouTube</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.linkedin.com/showcase/micronaut"><i class="fab fa-linkedin"><span class="sr-only">LinkedIn</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.twitch.tv/micronautfw"><i class="fab fa-twitch"><span class="sr-only">Twitch</span></i></a></li>
                        </ul>
                    </div>
                </div>
                <div id="text-5" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <small>© 2023 MICRONAUT FOUNDATION. ALL RIGHTS RESERVED</small>
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</footer>
</body>
</html>
