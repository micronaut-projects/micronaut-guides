<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'/>
    <title>Creating a ToDo application with Micronaut GraphQL</title>
    <link rel='stylesheet' id='wp-block-library-css' href='https://micronaut.io/wp-includes/css/dist/block-library/style.min.css' type='text/css' media='all'/>
    <link rel='stylesheet' id='fonts-fira-sans-css' href='https://fonts.googleapis.com/css2?family=Fira+Sans%3Awght%40300%3B500&#038;display=swap&#038;ver=5.7' type='text/css' media='all'/>
    <link rel='stylesheet' id='micronaut-style-css' href='https://micronaut.io/wp-content/themes/micronaut/style.min.css' type='text/css' media='all'/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link rel="shortcut icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link href="coderay.css" rel="stylesheet" />
    <link href="guide.css" rel="stylesheet" />
    <script src="guide.js"></script>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://guides.micronaut.io/latest/images/cards/micronauttwittercard.png"/>
    <meta name="twitter:creator" content="@micronautfw"/>
    <meta name="twitter:site" content="@micronautfw"/>
    <meta name="twitter:title" content="Creating a ToDo application with Micronaut GraphQL"/>
    <meta name="twitter:description" content="Build a TODO application with Micronaut GraphQL."/>
</head>
<body class="page-template page-template-page-sidebar page-template-page-sidebar-php page page-parent guide">

<header id="header">

    <div class="container">

        <nav class="navbar navbar-expand-lg navbar-dark">

            <button class="collapsed" type="button" data-toggle="collapse" data-target="#nav" aria-expanded="false">
                <span></span>
            </button>

            <a class="navbar-brand" href="https://micronaut.io">
                <img src="https://micronaut.io/wp-content/uploads/2020/11/MIcronautLogo_Horizontal.svg" alt="Micronaut framework"/>
            </a>

            <div class="collapse navbar-collapse" id="nav">

                <ul class="navbar-nav ml-auto">

                    <li id="menu-item-2865" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2865 nav-item">
                        <a href="https://micronaut.io/download/" class="nav-link">Download</a>
                    </li>
                    <li id="menu-item-2868" class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-22 current_page_item current-menu-ancestor current-menu-parent current_page_parent current_page_ancestor menu-item-has-children menu-item-2872 active dropdown nav-item">
                        <a href="./index.html" class="nav-link dropdown-toggle" data-toggle="dropdown">Learn</a>
                        <ul class="dropdown-menu">
                            <li id="menu-item-2869" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2869">
                                <a href="https://micronaut.io/docs/" class="dropdown-item">User Documentation</a>
                            </li>
                            <li id="menu-item-2870" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2870">
                                <a href="./index.html" class="dropdown-item">Guides</a>
                            </li>
                            <li id="menu-item-2896" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2896">
                                <a href="https://micronaut.io/category/microcast/" class="dropdown-item">Microcasts</a>
                            </li>
                            <li id="menu-item-2897" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2897">
                                <a href="https://micronaut.io/category/webinar/" class="dropdown-item">Webinars</a>
                            </li>
                            <li id="menu-item-2871" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2871">
                                <a href="https://micronaut.io/professional-training/" class="dropdown-item">Professional Training</a>
                            </li>
                        </ul>
                    </li>
                    <li id="menu-item-2878" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2878 dropdown nav-item">
                        <a href="https://micronaut.io/blog/" class="nav-link dropdown-toggle" data-toggle="dropdown">Resources</a>
                        <ul class="dropdown-menu">
                            <li id="menu-item-2879" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2879">
                                <a href="https://micronaut.io/blog/" class="dropdown-item">Blog</a>
                            </li>
                            <li id="menu-item-2881" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2881">
                                <a href="https://micronaut.io/events/" class="dropdown-item">Upcoming Events</a>
                            </li>
                            <li id="menu-item-2880" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2880">
                                <a href="https://micronaut.io/commercial-support/" class="dropdown-item">Commercial Support</a>
                            </li>
                            <li id="menu-item-2882" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2882">
                                <a href="https://micronaut.io/faq/" class="dropdown-item">FAQ</a>
                            </li>
                            <li id="menu-item-2883" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2883">
                                <a href="https://micronaut.io/contact/" class="dropdown-item">Contact</a>
                            </li>
                        </ul>
                    </li>
                    <li id="menu-item-2872" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2878 dropdown nav-item">
                        <a href="https://micronaut.io/foundation/" aria-current="page" class="nav-link dropdown-toggle" data-toggle="dropdown">Foundation</a>
                        <ul class="dropdown-menu">
                            <li id="menu-item-2877" class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-22 current_page_item menu-item-2877 active">
                                <a href="https://micronaut.io/foundation/" aria-current="page" class="dropdown-item">Overview</a>
                            </li>
                            <li id="menu-item-2874" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2874">
                                <a href="https://micronaut.io/foundation/corporate-sponsorship/" class="dropdown-item">Corporate Sponsorship</a>
                            </li>
                            <li id="menu-item-2873" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2873">
                                <a href="https://micronaut.io/foundation/community-sponsorship/" class="dropdown-item">Community Sponsorship</a>
                            </li>
                            <li id="menu-item-2876" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2876">
                                <a href="https://micronaut.io/foundation/sponsors/" class="dropdown-item">Sponsors</a>
                            </li>
                        </ul>
                    </li>
                    <li id="menu-item-2884" class="action menu-item menu-item-type-custom menu-item-object-custom menu-item-2884 nav-item">
                        <a target="_blank" rel="noopener" href="https://micronaut.io/launch/" class="nav-link">Launch</a>
                    </li>
                </ul>
            </div>

        </nav>

    </div>
</header>
<div id="breadcrumbs"><div class="container"><a href="https://micronaut.io/">Home</a> » <a href="./index.html">Guides</a> » <a href="micronaut-graphql-todo.html">Creating a ToDo application with Micronaut GraphQL</a> » <span class="breadcrumb_last" aria-current="page">maven | kotlin</span></div></div><!-- .breadcrumbs -->
<main id="main">
    <div class="container">
        <div class="row">
            <div class="col-md-4">

                <div class="toc">
                    <div class="inner">
                        <h1 class="title title_large first-word-bold first-word-break">Table of Contents</h1>
                        <div class="underline"></div>
                        
<ul class="sectlevel1">
<li><a href="#getting-started">1. Getting Started</a></li>
<li><a href="#what-you-will-need">2. What you will need</a></li>
<li><a href="#solution">3. Solution</a></li>
<li><a href="#writing-the-application">4. Writing the Application</a></li>
<li><a href="#persistence-layer">5. Persistence layer</a>
<ul class="sectlevel2">
<li><a href="#database-migration-with-flyway">5.1. Database Migration with Flyway</a></li>
<li><a href="#entities">5.2. Entities</a></li>
<li><a href="#repositories">5.3. Repositories</a></li>
</ul>
</li>
<li><a href="#graphql">6. GraphQL</a>
<ul class="sectlevel2">
<li><a href="#describe-your-schema">6.1. Describe your schema</a></li>
<li><a href="#data-fetchers">6.2. Data Fetchers</a></li>
<li><a href="#graphql-factory">6.3. GraphQL Factory</a></li>
</ul>
</li>
<li><a href="#test-resources">7. Test Resources</a></li>
<li><a href="#running-the-application">8. Running the Application</a></li>
<li><a href="#test-the-application">9. Test the application</a>
<ul class="sectlevel2">
<li><a href="#manual-smoke-tests">9.1. Manual smoke tests</a></li>
<li><a href="#automated-tests">9.2. Automated tests</a></li>
</ul>
</li>
<li><a href="#graphiql">10. GraphiQL</a></li>
<li><a href="#generate-a-micronaut-application-native-executable-with-graalvm">11. Generate a Micronaut Application Native Executable with GraalVM</a>
<ul class="sectlevel2">
<li><a href="#native-executable-generation">11.1. Native executable generation</a></li>
</ul>
</li>
<li><a href="#next-steps">12. Next steps</a></li>
<li><a href="#help-with-the-micronaut-framework">13. Help with the Micronaut Framework</a></li>
</ul>

                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <h1>Creating a ToDo application with Micronaut GraphQL</h1>
                <div class="underline"></div>
<div class="sect1">
<div class="sectionbody">

<div class="paragraph">
<p>Build a TODO application with Micronaut GraphQL.</p>
</div>
<div class="paragraph">
<p>Authors: Sergio del Amo, Tim Yates</p>
</div>
<div class="paragraph">
<p>Micronaut Version: 3.9.2</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started">1. Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this guide, you will create a Micronaut application written in Kotlin that uses <a href="https://graphql.org/">GraphQL</a> to create a todo application.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>GraphQL is a query language for APIs and a runtime for fulfilling those queries with your existing data. GraphQL provides
a complete and understandable description of the data in your API, gives clients the power to ask for exactly what they
need and nothing more, makes it easier to evolve APIs over time, and enables powerful developer tools.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>You will be using:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A PostgreSQL instance provided by <a href="#test-resources">Test Resources</a> and running in Docker.</p>
</li>
<li>
<p><a href="https://micronaut-projects.github.io/micronaut-data/latest/guide/">Micronaut Data</a> to persist our ToDos to this database.</p>
</li>
<li>
<p><a href="https://micronaut-projects.github.io/micronaut-flyway/latest/guide/">Flyway</a> to handle our database migrations.</p>
</li>
<li>
<p><a href="https://micronaut-projects.github.io/micronaut-graphql/latest/guide/">Micronaut GraphQL</a> to expose our data.</p>
</li>
<li>
<p>Testcontainers to run a PostgreSQL instance for local dev, and tests.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The application will expose a GraphQL endpoint at <code>/graphql</code> for the data to be consumed and modified.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-you-will-need">2. What you will need</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 1.8 or greater installed with <code>JAVA_HOME</code> <a href="https://www.baeldung.com/java-home-on-windows-7-8-10-mac-os-x-linux">configured appropriately</a></p>
</li>
</ul>
</div>
</div>
</div>
</div></div><div class="row"><div class="col-md-12"><div class="sect1">
<h2 id="solution">3. Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create the application step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="micronaut-graphql-todo-maven-kotlin.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-the-application">4. Writing the Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create an application using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mn create-app example.micronaut.micronautguide \
    --features=graphql,data-jdbc,flyway,postgres,graalvm \
    --build=maven
    --lang=kotlin</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous command creates a Micronaut application with the default package <code>example.micronaut</code> in a directory named <code>micronautguide</code>.</p>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add <code>graphql</code>, <code>data-jdbc</code>, <code>flyway</code>, <code>postgres</code>, and <code>graalvm</code> features.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have an existing Micronaut application and want to add the functionality described here, you can <a href="https://micronaut.io/launch?features=graphql&amp;features=data-jdbc&amp;features=flyway&amp;features=postgres&amp;features=graalvm&amp;lang=KOTLIN&amp;build=MAVEN&amp;test=JUNIT&amp;name=micronautguide&amp;type=DEFAULT&amp;package=example.micronaut&amp;activity=diff" target="_blank" rel="noopener">view the dependency and configuration changes from the specified features</a> and apply those changes to your application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://guides.micronaut.io/latest/micronaut-intellij-idea-ide-setup.html">Setup IntelliJ IDEA to develop Micronaut Applications</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="persistence-layer">5. Persistence layer</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="database-migration-with-flyway">5.1. Database Migration with Flyway</h3>
<div class="paragraph">
<p>We need a way to create the database schema. For that, we use <a href="https://micronaut-projects.github.io/micronaut-flyway/latest/guide/">Micronaut integration with Flyway</a>.</p>
</div>
<div class="paragraph">
<p><a href="https://www.flywaydb.org">Flyway</a> automates schema changes, significantly simplifying schema management tasks, such as migrating, rolling back, and reproducing in multiple environments.</p>
</div>
<div class="paragraph">
<p>Add the following snippet to include the necessary dependencies:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>io.micronaut.flyway<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>micronaut-flyway<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;scope&gt;</span>compile<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.flywaydb<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>flyway-mysql<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;scope&gt;</span>runtime<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will enable Flyway in <code>application.yml</code> and configure it to perform migrations on one of the defined data sources.</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">flyway</span>:
  <span class="key">datasources</span>:
    <span class="key">default</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">true </span></span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enable Flyway for the <code>default</code> datasource.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Configuring multiple data sources is as simple as enabling Flyway for each one. You can also specify directories that will be used for migrating each data source. Review the <a href="https://micronaut-projects.github.io/micronaut-flyway/latest/guide/">Micronaut Flyway documentation</a> for additional details.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Flyway migration will be automatically triggered before your Micronaut application starts. Flyway will read migration commands in the <code>resources/db/migration/</code> directory, execute them if necessary, and verify that the configured data source is consistent with them.</p>
</div>
<div class="paragraph">
<p>Create the following migration files with the database schema creation:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/db/migration/V1__schema.sql</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> author <i class="conum" data-value="1"></i><b>(1)</b>
(
    id       <span class="predefined-type">BIGINT</span> <span class="directive">PRIMARY</span> <span class="type">KEY</span> GENERATED <span class="keyword">BY</span> <span class="directive">DEFAULT</span> <span class="keyword">AS</span> IDENTITY,
    username <span class="predefined-type">VARCHAR</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>
);

<span class="class">CREATE</span> <span class="type">TABLE</span> to_do <i class="conum" data-value="2"></i><b>(2)</b>
(
    id        <span class="predefined-type">BIGINT</span> <span class="directive">PRIMARY</span> <span class="type">KEY</span> GENERATED <span class="keyword">BY</span> <span class="directive">DEFAULT</span> <span class="keyword">AS</span> IDENTITY,
    title     <span class="predefined-type">VARCHAR</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    completed <span class="predefined-type">BOOLEAN</span>      <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    author_id <span class="predefined-type">BIGINT</span> <span class="keyword">REFERENCES</span> author (id)
);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Authors will be stored in table separate to the ToDos.  They just have a username.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ToDos have a title, completion status, and a foreign-key reference to the author.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="entities">5.2. Entities</h3>
<div class="paragraph">
<p>Create an Entity class to represent an Author:</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/Author.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import io.micronaut.data.annotation.GeneratedValue
import io.micronaut.data.annotation.GeneratedValue.Type.AUTO
import io.micronaut.data.annotation.Id
import io.micronaut.data.annotation.MappedEntity
import javax.validation.constraints.NotNull

@MappedEntity <i class="conum" data-value="1"></i><b>(1)</b>
class Author(val username: @NotNull String?) {

    @Id <i class="conum" data-value="2"></i><b>(2)</b>
    @GeneratedValue(AUTO)
    var id: Long? = null
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MappedEntity</code> to map the class to the table defined in the schema.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies the ID of an entity</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And another to represent a ToDo:</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/ToDo.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import io.micronaut.data.annotation.GeneratedValue
import io.micronaut.data.annotation.GeneratedValue.Type.AUTO
import io.micronaut.data.annotation.Id
import io.micronaut.data.annotation.MappedEntity

@MappedEntity <i class="conum" data-value="1"></i><b>(1)</b>
class ToDo(var title: String, val authorId: Long) {

    @Id <i class="conum" data-value="2"></i><b>(2)</b>
    @GeneratedValue(AUTO)
    var id: Long? = null

    var completed = false
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MappedEntity</code> to map the class to the table defined in the schema.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Specifies the ID of an entity</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="repositories">5.3. Repositories</h3>
<div class="paragraph">
<p>Create a <a href="https://micronaut-projects.github.io/micronaut-data/latest/guide/#dbcRepositories"><code>JdbcRepository</code></a> for each of our Entity classes.</p>
</div>
<div class="paragraph">
<p>The simplest of these is the <code>ToDoRepository</code> which just requires the default methods:</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/ToDoRepository.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import io.micronaut.data.jdbc.annotation.JdbcRepository
import io.micronaut.data.model.query.builder.sql.Dialect.POSTGRES
import io.micronaut.data.repository.PageableRepository

@JdbcRepository(dialect = POSTGRES) <i class="conum" data-value="1"></i><b>(1)</b>
interface ToDoRepository : PageableRepository&lt;ToDo, Long&gt; <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@JdbcRepository</code> with a specific dialect.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>By extending <code>CrudRepository</code> you enable automatic generation of CRUD (Create, Read, Update, Delete) operations.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then create a Repository for the Authors.  This requires extra finders for this to simplify the GraphQL wiring in the next step:</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/AuthorRepository.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import io.micronaut.data.jdbc.annotation.JdbcRepository
import io.micronaut.data.model.query.builder.sql.Dialect.POSTGRES
import io.micronaut.data.repository.CrudRepository

@JdbcRepository(dialect = POSTGRES) <i class="conum" data-value="1"></i><b>(1)</b>
abstract class AuthorRepository : CrudRepository&lt;Author, Long&gt; { <i class="conum" data-value="2"></i><b>(2)</b>

    abstract fun findByUsername(username: String): Author? <i class="conum" data-value="3"></i><b>(3)</b>

    abstract fun findByIdIn(ids: Collection&lt;Long&gt;): Collection&lt;Author&gt; <i class="conum" data-value="4"></i><b>(4)</b>

    fun findOrCreate(username: String): Author { <i class="conum" data-value="5"></i><b>(5)</b>
        return findByUsername(username) ?: save(Author(username))
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@JdbcRepository</code> with a specific dialect.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>By extending <code>CrudRepository</code> you enable automatic generation of CRUD (Create, Read, Update, Delete) operations.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When creating todos a method is required to search for an exisiting username.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>When GraphQL loads a ToDo, it use this to fetch the authors if they are required in the response.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Find an existing author, or else create a new one when creating a ToDo.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="graphql">6. GraphQL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The initial Micronaut application <code>create-app</code> step already added the GraphQL dependency:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>io.micronaut.graphql<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>micronaut-graphql<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;scope&gt;</span>compile<span class="tag">&lt;/scope&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So the default GraphQL endpoint <code>/graphql</code> is enabled, and extra configuration is not required.</p>
</div>
<div class="sect2">
<h3 id="describe-your-schema">6.1. Describe your schema</h3>
<div class="paragraph">
<p>Create the file <code>schema.graphqls</code>:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/schema.graphqls</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="graphqls">type Query {
    toDos: [ToDo!]! <i class="conum" data-value="1"></i><b>(1)</b>
}

type Mutation {
    createToDo(title: String!, author: String!): ToDo  <i class="conum" data-value="2"></i><b>(2)</b>
    completeToDo(id: ID!): Boolean!  <i class="conum" data-value="3"></i><b>(3)</b>
}

type ToDo { <i class="conum" data-value="4"></i><b>(4)</b>
    id: ID!
    title: String!
    completed: Boolean!
    author: Author!
}

type Author { <i class="conum" data-value="5"></i><b>(5)</b>
    id: ID!
    username: String!
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declare a <code>toDos</code> query function to fetch all the todos as a list.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declare a <code>createToDo</code> mutation function to create and return a new ToDo.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Declare a <code>completeToDo</code> mutation function to mark a ToDo as done (and return a boolean indicating success).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Declare a <code>ToDo</code> type.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Declare an <code>Author</code> type.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="data-fetchers">6.2. Data Fetchers</h3>
<div class="paragraph">
<p>For each query and mutator in the schema, create a <code>DataFetcher</code> which will bind the GraphQL schema to our domain model.
These will execute the appropriate queries in the datastore.</p>
</div>
<div class="sect3">
<h4 id="queries">6.2.1. Queries</h4>
<div class="paragraph">
<p>Create class <code>ToDosDataFetcher</code> to implement the <code>toDos</code> query:</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/ToDosDataFetcher.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import graphql.schema.DataFetcher
import graphql.schema.DataFetchingEnvironment
import jakarta.inject.Singleton

@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
class ToDosDataFetcher(
    private val toDoRepository: ToDoRepository <i class="conum" data-value="2"></i><b>(2)</b>
) : DataFetcher&lt;Iterable&lt;ToDo?&gt;&gt; {

    override fun get(env: DataFetchingEnvironment): Iterable&lt;ToDo?&gt; {
        return toDoRepository.findAll()
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use constructor injection to inject a bean of type <code>ToDoRepository</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mutations">6.2.2. Mutations</h4>
<div class="paragraph">
<p>Create <code>CreateToDoDataFetcher</code> for the creation of ToDos:</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/CreateToDoDataFetcher.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import graphql.schema.DataFetcher
import graphql.schema.DataFetchingEnvironment
import jakarta.inject.Singleton
import javax.transaction.Transactional

@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
open class CreateToDoDataFetcher(
    private val toDoRepository: ToDoRepository,  <i class="conum" data-value="2"></i><b>(2)</b>
    private val authorRepository: AuthorRepository
) : DataFetcher&lt;ToDo&gt; {

    @Transactional
    override fun get(env: DataFetchingEnvironment): ToDo {
        val title = env.getArgument&lt;String&gt;(&quot;title&quot;)
        val username = env.getArgument&lt;String&gt;(&quot;author&quot;)
        val author = authorRepository.findOrCreate(username) <i class="conum" data-value="3"></i><b>(3)</b>
        val toDo = ToDo(title, author.id!!)
        return toDoRepository.save(toDo) <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use constructor injection to inject a bean of type <code>ToDoRepository</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Find the existing author or create a new one.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Persist the new ToDo.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And <code>CompleteToDoDataFetcher</code> to mark ToDos as complete:</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/CompleteToDoDataFetcher.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import graphql.schema.DataFetcher
import graphql.schema.DataFetchingEnvironment
import jakarta.inject.Singleton

@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
class CompleteToDoDataFetcher(
    private val toDoRepository: ToDoRepository <i class="conum" data-value="2"></i><b>(2)</b>
) : DataFetcher&lt;Boolean&gt; {

    override fun get(env: DataFetchingEnvironment): Boolean {
        val id = env.getArgument&lt;String&gt;(&quot;id&quot;).toLong()

        return toDoRepository
            .findById(id) <i class="conum" data-value="3"></i><b>(3)</b>
            .map { todo -&gt; setCompletedAndUpdate(todo!!) }
            .orElse(false)
    }

    private fun setCompletedAndUpdate(todo: ToDo): Boolean {
        todo.completed = true <i class="conum" data-value="4"></i><b>(4)</b>
        toDoRepository.update(todo) <i class="conum" data-value="5"></i><b>(5)</b>
        return true
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use constructor injection to inject a bean of type <code>ToDoRepository</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Find the existing ToDo based on its id.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If found, set completed.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>And update the version in the database.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="wiring">6.2.3. Wiring</h4>
<div class="paragraph">
<p>GraphQL allows data to be fetched on demand.
In this example, a user may request a list of ToDos, but not require the author to be populated.
A method is required to optionally load Authors based on their ID.</p>
</div>
<div class="paragraph">
<p>To do this, register a DataLoader that finds authors based on a collection of ids:</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/AuthorDataLoader.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import io.micronaut.scheduling.TaskExecutors
import jakarta.inject.Named
import jakarta.inject.Singleton
import org.dataloader.MappedBatchLoader
import java.util.concurrent.CompletableFuture
import java.util.concurrent.CompletionStage
import java.util.concurrent.ExecutorService

@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
class AuthorDataLoader(
    private val authorRepository: AuthorRepository,
    @Named(TaskExecutors.IO) val executor: ExecutorService <i class="conum" data-value="2"></i><b>(2)</b>
) : MappedBatchLoader&lt;Long, Author&gt; {

    override fun load(keys: MutableSet&lt;Long&gt;): CompletionStage&lt;Map&lt;Long, Author&gt;&gt; =
        CompletableFuture.supplyAsync({
            authorRepository
                .findByIdIn(keys.toList())
                .associateBy { it.id!! }
        }, executor)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject the <code>IO</code> executor service.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is registered in the DataLoaderRegistry under the key <code>author</code></p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/DataLoaderRegistryFactory.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import io.micronaut.context.annotation.Factory
import io.micronaut.runtime.http.scope.RequestScope
import org.dataloader.DataLoader
import org.dataloader.DataLoaderRegistry
import org.slf4j.LoggerFactory

@Factory <i class="conum" data-value="1"></i><b>(1)</b>
class DataLoaderRegistryFactory {

    companion object {
        private val LOG = LoggerFactory.getLogger(DataLoaderRegistryFactory::class.java)
    }

    @Suppress(&quot;unused&quot;)
    @RequestScope <i class="conum" data-value="2"></i><b>(2)</b>
    fun dataLoaderRegistry(authorDataLoader: AuthorDataLoader): DataLoaderRegistry {
        val dataLoaderRegistry = DataLoaderRegistry()
        dataLoaderRegistry.register(
            &quot;author&quot;,
            DataLoader.newMappedDataLoader(authorDataLoader)
        ) <i class="conum" data-value="3"></i><b>(3)</b>

        LOG.trace(&quot;Created new data loader registry&quot;)

        return dataLoaderRegistry
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A class annotated with the <code>@Factory</code> annotated is a factory. It provides one or more methods annotated with a bean scope annotation (e.g. <code>@Singleton</code>). Read more about <a href="https://docs.micronaut.io/latest/guide/#factories">Bean factories</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This registry has request scope, so a new one will be created for every request.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Register the AuthorDataLoader whenever the loader for <code>"author"</code> is requested.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Add an <code>AuthorDataFetcher</code> which requests and uses this loader to populate a <code>ToDo</code> if the author when required.</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/AuthorDataFetcher.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import graphql.schema.DataFetcher
import graphql.schema.DataFetchingEnvironment
import jakarta.inject.Singleton
import java.util.concurrent.CompletionStage

@Singleton <i class="conum" data-value="1"></i><b>(1)</b>
class AuthorDataFetcher : DataFetcher&lt;CompletionStage&lt;Author&gt;&gt; {

    override fun get(environment: DataFetchingEnvironment): CompletionStage&lt;Author&gt; {
        val toDo: ToDo = environment.getSource()
        val authorDataLoader = environment.getDataLoader&lt;Long, Author&gt;(&quot;author&quot;) <i class="conum" data-value="2"></i><b>(2)</b>
        return authorDataLoader.load(toDo.authorId)
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Uses the author data loader defined above in the Factory.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="graphql-factory">6.3. GraphQL Factory</h3>
<div class="paragraph">
<p>Finally, create a factory class that will bind the GraphQL schema to the code, types and fetchers.</p>
</div>
<div class="listingblock">
<div class="title">src/main/kotlin/example/micronaut/GraphQLFactory.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import graphql.GraphQL
import graphql.schema.idl.*
import graphql.schema.idl.errors.SchemaMissingError
import io.micronaut.context.annotation.Factory
import io.micronaut.core.io.ResourceResolver
import jakarta.inject.Singleton
import java.io.BufferedReader
import java.io.InputStreamReader

@Factory <i class="conum" data-value="1"></i><b>(1)</b>
class GraphQLFactory {

    @Singleton <i class="conum" data-value="2"></i><b>(2)</b>
    fun graphQL(
        resourceResolver: ResourceResolver,
        toDosDataFetcher: ToDosDataFetcher,
        createToDoDataFetcher: CreateToDoDataFetcher,
        completeToDoDataFetcher: CompleteToDoDataFetcher,
        authorDataFetcher: AuthorDataFetcher
    ): GraphQL {
        val schemaParser = SchemaParser()
        val schemaGenerator = SchemaGenerator()

        // Load the schema
        val schemaDefinition = resourceResolver
            .getResourceAsStream(&quot;classpath:schema.graphqls&quot;)
            .orElseThrow { SchemaMissingError() }

        // Parse the schema and merge it into a type registry
        val typeRegistry = TypeDefinitionRegistry()
        typeRegistry.merge(schemaParser.parse(BufferedReader(InputStreamReader(schemaDefinition))))

        // Create the runtime wiring.
        val runtimeWiring = RuntimeWiring.newRuntimeWiring()
            .type(&quot;Query&quot;) { typeWiring: TypeRuntimeWiring.Builder -&gt;  <i class="conum" data-value="3"></i><b>(3)</b>
                typeWiring
                    .dataFetcher(&quot;toDos&quot;, toDosDataFetcher)
            }
            .type(&quot;Mutation&quot;) { typeWiring: TypeRuntimeWiring.Builder -&gt;  <i class="conum" data-value="4"></i><b>(4)</b>
                typeWiring
                    .dataFetcher(&quot;createToDo&quot;, createToDoDataFetcher)
                    .dataFetcher(&quot;completeToDo&quot;, completeToDoDataFetcher)
            }
            .type(&quot;ToDo&quot;) { typeWiring: TypeRuntimeWiring.Builder -&gt;  <i class="conum" data-value="5"></i><b>(5)</b>
                typeWiring
                    .dataFetcher(&quot;author&quot;, authorDataFetcher)
            }
            .build()

        // Create the executable schema.
        val graphQLSchema = schemaGenerator.makeExecutableSchema(typeRegistry, runtimeWiring)

        // Return the GraphQL bean.
        return GraphQL.newGraphQL(graphQLSchema).build()
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A class annotated with the <code>@Factory</code> annotated is a factory. It provides one or more methods annotated with a bean scope annotation (e.g. <code>@Singleton</code>). Read more about <a href="https://docs.micronaut.io/latest/guide/#factories">Bean factories</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Wire up the query behavior.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Wire up each mutators.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Wire up how to populate a ToDo with authors if they are requested.</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test-resources">7. Test Resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the application is started locally&#8201;&#8212;&#8201;either under test or by <a href="#running-the-application">running the application</a>&#8201;&#8212;&#8201;resolution of the datasource URL is detected and the Test Resources service will start a local PostgreSQL docker container, and inject the properties required to use this as the datasource.</p>
</div>
<div class="paragraph">
<p>For more information, see the <a href="https://micronaut-projects.github.io/micronaut-test-resources/snapshot/guide/#modules-databases-jdbc">JDBC section of the Test Resources documentation</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="running-the-application">8. Running the Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To run the application, use the <code>./mvnw mn:run</code> command, which starts the application on port 8080.</p>
</div>
<div class="paragraph">
<p>When the application first runs, you will see in the logs that the migrations have been performed.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test-the-application">9. Test the application</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="manual-smoke-tests">9.1. Manual smoke tests</h3>
<div class="paragraph">
<p>Formulate a GraphQL query to retrieve all the current ToDos (there will be none to start with)</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="error">q</span><span class="error">u</span><span class="error">e</span><span class="error">r</span><span class="error">y</span> {
  <span class="error">t</span><span class="error">o</span><span class="error">D</span><span class="error">o</span><span class="error">s</span> {
    <span class="error">t</span><span class="error">i</span><span class="error">t</span><span class="error">l</span><span class="error">e</span>,
    <span class="error">c</span><span class="error">o</span><span class="error">m</span><span class="error">p</span><span class="error">l</span><span class="error">e</span><span class="error">t</span><span class="error">e</span><span class="error">d</span>,
    <span class="error">a</span><span class="error">u</span><span class="error">t</span><span class="error">h</span><span class="error">o</span><span class="error">r</span> {
       <span class="error">u</span><span class="error">s</span><span class="error">e</span><span class="error">r</span><span class="error">n</span><span class="error">a</span><span class="error">m</span><span class="error">e</span>
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the following cURL request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST 'http://localhost:8080/graphql' \
     -H 'content-type: application/json' \
     --data-binary '{&quot;query&quot;:&quot;{ toDos { title, completed, author { username } } }&quot;}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Response</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">toDos</span><span class="delimiter">&quot;</span></span>:[]}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a ToDo, by issuing a mutation query and return the ID of the newly created ToDo:</p>
</div>
<div class="listingblock">
<div class="title">GraphQL Query</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="error">m</span><span class="error">u</span><span class="error">t</span><span class="error">a</span><span class="error">t</span><span class="error">i</span><span class="error">o</span><span class="error">n</span> {
  <span class="error">c</span><span class="error">r</span><span class="error">e</span><span class="error">a</span><span class="error">t</span><span class="error">e</span><span class="error">T</span><span class="error">o</span><span class="error">D</span><span class="error">o</span><span class="error">(</span><span class="error">t</span><span class="error">i</span><span class="error">t</span><span class="error">l</span><span class="error">e</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Create GraphQL Guide</span><span class="delimiter">&quot;</span></span>, <span class="error">a</span><span class="error">u</span><span class="error">t</span><span class="error">h</span><span class="error">o</span><span class="error">r</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Tim Yates</span><span class="delimiter">&quot;</span></span><span class="error">)</span> {
    <span class="error">i</span><span class="error">d</span>
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which translates to this cURL command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST 'http://localhost:8080/graphql' \
     -H 'content-type: application/json' \
     --data-binary '{&quot;query&quot;:&quot;mutation { createToDo(title:\&quot;Create GraphQL Guide\&quot;, author:\&quot;Tim Yates\&quot;) { id } }&quot;}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Response</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">createToDo</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span>}}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This new ToDo then appears in the list of all ToDos with <code>completed</code> set to false:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST 'http://localhost:8080/graphql' \
     -H 'content-type: application/json' \
     --data-binary '{&quot;query&quot;:&quot;{ toDos { title, completed, author { username } } }&quot;}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Response</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">toDos</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Create GraphQL Guide</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">completed</span><span class="delimiter">&quot;</span></span>:<span class="value">false</span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">author</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Tim Yates</span><span class="delimiter">&quot;</span></span>}}]}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Mark it as completed by using this query with the ID from above:</p>
</div>
<div class="listingblock">
<div class="title">GraphQL query</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><span class="error">m</span><span class="error">u</span><span class="error">t</span><span class="error">a</span><span class="error">t</span><span class="error">i</span><span class="error">o</span><span class="error">n</span> {
  <span class="error">c</span><span class="error">o</span><span class="error">m</span><span class="error">p</span><span class="error">l</span><span class="error">e</span><span class="error">t</span><span class="error">e</span><span class="error">T</span><span class="error">o</span><span class="error">D</span><span class="error">o</span><span class="error">(</span><span class="error">i</span><span class="error">d</span>: <span class="integer">1</span><span class="error">)</span>
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST 'http://localhost:8080/graphql' \
     -H 'content-type: application/json' \
     --data-binary '{&quot;query&quot;:&quot;mutation { completeToDo(id: 1) }&quot;}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Response</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">completeToDo</span><span class="delimiter">&quot;</span></span>:<span class="value">true</span>}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check this has been persisted in our model:</p>
</div>
<div class="listingblock">
<div class="title">Query</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -X POST 'http://localhost:8080/graphql' \
     -H 'content-type: application/json' \
     --data-binary '{&quot;query&quot;:&quot;{ toDos { title, completed } }&quot;}'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Response</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{<span class="key"><span class="delimiter">&quot;</span><span class="content">data</span><span class="delimiter">&quot;</span></span>:{<span class="key"><span class="delimiter">&quot;</span><span class="content">toDos</span><span class="delimiter">&quot;</span></span>:[{<span class="key"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Create GraphQL Guide</span><span class="delimiter">&quot;</span></span>,<span class="key"><span class="delimiter">&quot;</span><span class="content">completed</span><span class="delimiter">&quot;</span></span>:<span class="value">true</span>}]}}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="automated-tests">9.2. Automated tests</h3>
<div class="paragraph">
<p>For testing the application use the Micronaut HTTP Client to send a <code>POST</code> request to the <code>/graphql</code> endpoint.
Create the following class:</p>
</div>
<div class="listingblock">
<div class="title">src/test/kotlin/example/micronaut/GraphQLControllerTest.kt</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="kotlin">package example.micronaut

import io.micronaut.core.type.Argument
import io.micronaut.http.HttpRequest
import io.micronaut.http.HttpResponse
import io.micronaut.http.HttpStatus
import io.micronaut.http.client.HttpClient
import io.micronaut.http.client.annotation.Client
import io.micronaut.test.extensions.junit5.annotation.MicronautTest
import jakarta.inject.Inject
import org.junit.jupiter.api.Assertions
import org.junit.jupiter.api.Assertions.assertEquals
import org.junit.jupiter.api.Assertions.assertTrue
import org.junit.jupiter.api.Assertions.assertFalse
import org.junit.jupiter.api.Test

@MicronautTest <i class="conum" data-value="1"></i><b>(1)</b>
internal class GraphQLControllerTest(@Client(&quot;/&quot;) val client: HttpClient) { <i class="conum" data-value="2"></i><b>(2)</b>

    @Test
    fun testGraphQLController() {
        // when:
        var todos = allTodos

        // then:
        assertTrue(todos.isEmpty())

        // when:
        val id = createToDo(&quot;Test GraphQL&quot;, &quot;Tim Yates&quot;)

        // then: (check it's a UUID)
        assertEquals(1, id)

        // when:
        todos = allTodos

        // then:
        assertEquals(1, todos.size)
        var todo = todos[0]
        assertEquals(&quot;Test GraphQL&quot;, todo[&quot;title&quot;])
        assertFalse(java.lang.Boolean.parseBoolean(todo[&quot;completed&quot;].toString()))
        assertEquals(
            &quot;Tim Yates&quot;,
            (todo[&quot;author&quot;] as Map&lt;*, *&gt;?)!![&quot;username&quot;]
        )

        // when:
        val completed = markAsCompleted(id)

        // then:
        assertTrue(completed)

        // when:
        todos = allTodos

        // then:
        assertEquals(1, todos.size)
        todo = todos[0]
        assertEquals(&quot;Test GraphQL&quot;, todo[&quot;title&quot;])
        assertTrue(java.lang.Boolean.parseBoolean(todo[&quot;completed&quot;].toString()))
        assertEquals(
            &quot;Tim Yates&quot;,
            (todo[&quot;author&quot;] as Map&lt;*, *&gt;?)!![&quot;username&quot;]
        )
    }

    private fun fetch(query: String): HttpResponse&lt;Map&lt;String, Any&gt;&gt; {
        val request: HttpRequest&lt;String&gt; = HttpRequest.POST(&quot;/graphql&quot;, query)
        val response = client.toBlocking().exchange(
            request, Argument.mapOf(Argument.STRING, Argument.OBJECT_ARGUMENT)
        )
        assertEquals(HttpStatus.OK, response.status())
        Assertions.assertNotNull(response.body())
        return response
    }

    private val allTodos: List&lt;Map&lt;String, Any&gt;&gt;
        get() {
            val query = &quot;{\&quot;query\&quot;:\&quot;query { toDos { title, completed, author { id, username } } }\&quot;}&quot;
            val response = fetch(query)
            return (response.body.get()[&quot;data&quot;] as Map&lt;*, *&gt;)[&quot;toDos&quot;] as List&lt;Map&lt;String, Any&gt;&gt;
        }

    private fun createToDo(title: String, author: String): Long {
        val query =
            &quot;{\&quot;query\&quot;: \&quot;mutation { createToDo(title: \\\&quot;$title\\\&quot;, author: \\\&quot;$author\\\&quot;) { id } }\&quot; }&quot;
        val response = fetch(query)
        return ((response.body.get().get(&quot;data&quot;) as Map&lt;*, *&gt;)[&quot;createToDo&quot;] as Map&lt;*, *&gt;?)!![&quot;id&quot;].toString().toLong()
    }

    private fun markAsCompleted(id: Long): Boolean {
        val query = &quot;{\&quot;query\&quot;: \&quot;mutation { completeToDo(id: \\\&quot;$id\\\&quot;) }\&quot; }&quot;
        val response = fetch(query)
        return (response.body.get()[&quot;data&quot;] as Map&lt;String, Any&gt;)[&quot;completeToDo&quot;] as Boolean
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject the <code>HttpClient</code> bean and point it to the embedded server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./mvnw test</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="graphiql">10. GraphiQL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As an extra feature that will help during development, you can enable <a href="https://github.com/graphql/graphiql">GraphiQL</a>.
GraphiQL is the GraphQL integrated development environment, and it executes GraphQL queries.</p>
</div>
<div class="paragraph">
<p>It should only be used for development, so it&#8217;s not enabled by default.
Add the following configuration to enable it:</p>
</div>
<div class="listingblock">
<div class="title">src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">graphql</span>:
  <span class="key">graphiql.enabled</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Start the application again and open <a href="http://localhost:8080/graphiql" class="bare">http://localhost:8080/graphiql</a> in a browser.
GraphQL queries can be executed with integrated auto-completion:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/graphiql-todo.png" alt="graphiql todo"></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="generate-a-micronaut-application-native-executable-with-graalvm">11. Generate a Micronaut Application Native Executable with GraalVM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will use <a href="https://www.graalvm.org/">GraalVM</a>, the polyglot embeddable virtual machine, to generate a native executable of our Micronaut application.</p>
</div>
<div class="paragraph">
<p>Compiling native executables ahead of time with GraalVM improves startup time and reduces the memory footprint of JVM-based applications.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Only Java and Kotlin projects support using GraalVM&#8217;s <code>native-image</code> tool. Groovy relies heavily on reflection, which is only partially supported by GraalVM.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="native-executable-generation">11.1. Native executable generation</h3>
<div class="paragraph">
<p>The easiest way to install GraalVM on Linux or Mac is to use <a href="https://sdkman.io/">SDKMan.io</a>.</p>
</div>
<div class="listingblock">
<div class="title">Java 11</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sdk install java 22.3.r11-grl</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you still use Java 8, use the JDK11 version of GraalVM.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Java 17</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sdk install java 22.3.r17-grl</code></pre>
</div>
</div>
<div class="paragraph">
<p>For installation on Windows, or for manual installation on Linux or Mac, see the <a href="https://www.graalvm.org/22.0/docs/getting-started/">GraalVM Getting Started</a> documentation.</p>
</div>
<div class="paragraph">
<p>After installing GraalVM, install the <code>native-image</code> component, which is not installed by default:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">gu install native-image</code></pre>
</div>
</div>
<div class="paragraph">
<p>To generate a native executable using Maven, run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./mvnw package -Dpackaging=native-image</code></pre>
</div>
</div>
<div class="paragraph">
<p>The native executable is created in the <code>target</code> directory and can be run with <code>target/micronautguide</code>.</p>
</div>
<div class="paragraph">
<p>Start the native executable and execute the same cURL request as before. You can also use the included GraphiQL browser to
execute the queries.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="next-steps">12. Next steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Take a look at the <a href="https://micronaut-projects.github.io/micronaut-graphql/latest/guide/">Micronaut GraphQL documentation</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="help-with-the-micronaut-framework">13. Help with the Micronaut Framework</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://micronaut.io/foundation/">Micronaut Foundation</a> sponsored the creation of this Guide. A variety of <a href="https://micronaut.io/commercial-support/">consulting and support services</a> are available.</p>
</div>

            </div>
        </div>
    </div>
</main>

<footer id="footer">
    <div class="container">

        <div class="row">
            <div class="col-sm-5 footer-left">

                <div id="text-14" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <img class="alignnone size-medium wp-image-3736" src="./images/micronaut_foundation_horizontal_white.svg" alt="Micronaut Foundation"/>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-sm-7 footer-right">

                <ul class="meta">

                    <li id="menu-item-2895" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2895">
                        <a href="https://micronaut.io/brand-guidelines/">Brand Guidelines</a>
                    </li>
                    <li id="menu-item-2894" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2894">
                        <a href="https://micronaut.io/community-guidelines/">Community Guidelines</a>
                    </li>
                    <li id="menu-item-3377" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-privacy-policy menu-item-3377">
                        <a href="https://micronaut.io/privacy-policy/">Privacy Policy</a>
                    </li>

                </ul>

                <div id="nav_menu-2" class="widget widget_nav_menu">
                    <div class="menu-links-container">
                        <ul id="menu-links" class="menu">
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronautpodcast.com"><i class="fa fa-podcast"><span class="sr-only">Podcast</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronaut.io/feed/rss/"><i class="fa fa-feed"><span class="sr-only">Feed</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="mailto:info@micronaut.io"><i class="fas fa-envelope"><span class="sr-only">Mail</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://twitter.com/micronautfw"><i class="fab fa-twitter"><span class="sr-only">Twitter</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://matrix.to/#/#micronautfw_questions:gitter.im"><i class="fab fa-gitter"><span class="sr-only">Gitter</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://github.com/micronaut-projects/"><i class="fab fa-github"><span class="sr-only">GitHub</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.youtube.com/@MicronautFramework"><i class="fab fa-youtube"><span class="sr-only">YouTube</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.linkedin.com/showcase/micronaut"><i class="fab fa-linkedin"><span class="sr-only">LinkedIn</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.twitch.tv/micronautfw"><i class="fab fa-twitch"><span class="sr-only">Twitch</span></i></a></li>
                        </ul>
                    </div>
                </div>
                <div id="text-5" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <small>© 2023 MICRONAUT FOUNDATION. ALL RIGHTS RESERVED</small>
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</footer>
</body>
</html>
