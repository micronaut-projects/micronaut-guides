<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'/>
    <title>Oracle Cloud Streaming and the Micronaut Framework - Event-Driven Applications at Scale</title>
    <link rel='stylesheet' id='wp-block-library-css' href='https://micronaut.io/wp-includes/css/dist/block-library/style.min.css' type='text/css' media='all'/>
    <link rel='stylesheet' id='fonts-fira-sans-css' href='https://fonts.googleapis.com/css2?family=Fira+Sans%3Awght%40300%3B500&#038;display=swap&#038;ver=5.7' type='text/css' media='all'/>
    <link rel='stylesheet' id='micronaut-style-css' href='https://micronaut.io/wp-content/themes/micronaut/style.min.css' type='text/css' media='all'/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link rel="shortcut icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link href="coderay.css" rel="stylesheet" />
    <link href="guide.css" rel="stylesheet" />
    <script src="guide.js"></script>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://guides.micronaut.io/latest/images/cards/micronaut-oracle-cloud-streaming.png"/>
    <meta name="twitter:creator" content="@micronautfw"/>
    <meta name="twitter:site" content="@micronautfw"/>
    <meta name="twitter:title" content="Oracle Cloud Streaming and the Micronaut Framework - Event-Driven Applications at Scale"/>
    <meta name="twitter:description" content="Use Oracle Cloud Streaming to communicate between your Micronaut applications."/>
</head>
<body class="page-template page-template-page-sidebar page-template-page-sidebar-php page page-parent guide">

<header id="header">

    <div class="container">

        <nav class="navbar navbar-expand-lg navbar-dark">

            <button class="collapsed" type="button" data-toggle="collapse" data-target="#nav" aria-expanded="false">
                <span></span>
            </button>

            <a class="navbar-brand" href="https://micronaut.io">
                <img src="https://micronaut.io/wp-content/uploads/2020/11/MIcronautLogo_Horizontal.svg" alt="Micronaut framework"/>
            </a>

            <div class="collapse navbar-collapse" id="nav">

                <ul class="navbar-nav ml-auto">

                    <li id="menu-item-2865" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2865 nav-item">
                        <a href="https://micronaut.io/download/" class="nav-link">Download</a>
                    </li>
                    <li id="menu-item-2868" class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-22 current_page_item current-menu-ancestor current-menu-parent current_page_parent current_page_ancestor menu-item-has-children menu-item-2872 active dropdown nav-item">
                        <a href="./index.html" class="nav-link dropdown-toggle" data-toggle="dropdown">Learn</a>
                        <ul class="dropdown-menu">
                            <li id="menu-item-2869" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2869">
                                <a href="https://micronaut.io/docs/" class="dropdown-item">User Documentation</a>
                            </li>
                            <li id="menu-item-2870" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2870">
                                <a href="./index.html" class="dropdown-item">Guides</a>
                            </li>
                            <li id="menu-item-2896" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2896">
                                <a href="https://micronaut.io/category/microcast/" class="dropdown-item">Microcasts</a>
                            </li>
                            <li id="menu-item-2897" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2897">
                                <a href="https://micronaut.io/category/webinar/" class="dropdown-item">Webinars</a>
                            </li>
                            <li id="menu-item-2871" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2871">
                                <a href="https://micronaut.io/professional-training/" class="dropdown-item">Professional Training</a>
                            </li>
                        </ul>
                    </li>
                    <li id="menu-item-2878" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2878 dropdown nav-item">
                        <a href="https://micronaut.io/blog/" class="nav-link dropdown-toggle" data-toggle="dropdown">Resources</a>
                        <ul class="dropdown-menu">
                            <li id="menu-item-2879" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2879">
                                <a href="https://micronaut.io/blog/" class="dropdown-item">Blog</a>
                            </li>
                            <li id="menu-item-2881" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2881">
                                <a href="https://micronaut.io/events/" class="dropdown-item">Upcoming Events</a>
                            </li>
                            <li id="menu-item-2880" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2880">
                                <a href="https://micronaut.io/commercial-support/" class="dropdown-item">Commercial Support</a>
                            </li>
                            <li id="menu-item-2882" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2882">
                                <a href="https://micronaut.io/faq/" class="dropdown-item">FAQ</a>
                            </li>
                            <li id="menu-item-2883" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2883">
                                <a href="https://micronaut.io/contact/" class="dropdown-item">Contact</a>
                            </li>
                        </ul>
                    </li>
                    <li id="menu-item-2872" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2878 dropdown nav-item">
                        <a href="https://micronaut.io/foundation/" aria-current="page" class="nav-link dropdown-toggle" data-toggle="dropdown">Foundation</a>
                        <ul class="dropdown-menu">
                            <li id="menu-item-2877" class="menu-item menu-item-type-post_type menu-item-object-page current-menu-item page_item page-item-22 current_page_item menu-item-2877 active">
                                <a href="https://micronaut.io/foundation/" aria-current="page" class="dropdown-item">Overview</a>
                            </li>
                            <li id="menu-item-2874" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2874">
                                <a href="https://micronaut.io/foundation/corporate-sponsorship/" class="dropdown-item">Corporate Sponsorship</a>
                            </li>
                            <li id="menu-item-2873" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2873">
                                <a href="https://micronaut.io/foundation/community-sponsorship/" class="dropdown-item">Community Sponsorship</a>
                            </li>
                            <li id="menu-item-2876" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2876">
                                <a href="https://micronaut.io/foundation/sponsors/" class="dropdown-item">Sponsors</a>
                            </li>
                        </ul>
                    </li>
                    <li id="menu-item-2884" class="action menu-item menu-item-type-custom menu-item-object-custom menu-item-2884 nav-item">
                        <a target="_blank" rel="noopener" href="https://micronaut.io/launch/" class="nav-link">Launch</a>
                    </li>
                </ul>
            </div>

        </nav>

    </div>
</header>
<div id="breadcrumbs"><div class="container"><a href="https://micronaut.io/">Home</a> » <a href="./index.html">Guides</a> » <a href="micronaut-oracle-cloud-streaming.html">Oracle Cloud Streaming and the Micronaut Framework - Event-Driven Applications at Scale</a> » <span class="breadcrumb_last" aria-current="page">gradle | groovy</span></div></div><!-- .breadcrumbs -->
<main id="main">
    <div class="container">
        <div class="row">
            <div class="col-md-4">

                <div class="toc">
                    <div class="inner">
                        <h1 class="title title_large first-word-bold first-word-break">Table of Contents</h1>
                        <div class="underline"></div>
                        
<ul class="sectlevel1">
<li><a href="#getting-started">1. Getting Started</a></li>
<li><a href="#what-you-will-need">2. What You Will Need</a></li>
<li><a href="#solution">3. Solution</a></li>
<li><a href="#writing-the-application">4. Writing the Application</a>
<ul class="sectlevel2">
<li><a href="#chess-game-microservice">4.1. chess-game Microservice</a></li>
<li><a href="#chess-listener-microservice">4.2. chess-listener Microservice</a></li>
</ul>
</li>
<li><a href="#kafka">5. Kafka</a>
<ul class="sectlevel2">
<li><a href="#install-kafka">5.1. Install Kafka</a></li>
</ul>
</li>
<li><a href="#running-the-application">6. Running the application</a></li>
<li><a href="#moving-to-oracle-cloud">7. Moving to Oracle Cloud</a>
<ul class="sectlevel2">
<li><a href="#oracle-autonomous-database-atp">7.1. Oracle Autonomous Database (ATP)</a></li>
<li><a href="#oracle-cloud-streaming">7.2. Oracle Cloud Streaming</a></li>
</ul>
</li>
<li><a href="#local-testing-with-cloud-resources">8. Local Testing with Cloud Resources</a></li>
<li><a href="#writing-tests">9. Writing Tests</a>
<ul class="sectlevel2">
<li><a href="#chess-game-tests">9.1. chess-game tests</a></li>
<li><a href="#chess-listener-tests">9.2. chess-listener tests</a></li>
<li><a href="#running-the-tests">9.3. Running the tests</a></li>
</ul>
</li>
<li><a href="#deploy-to-oci">10. Deploy to OCI</a>
<ul class="sectlevel2">
<li><a href="#instance-principal-authentication">10.1. Instance Principal authentication</a></li>
</ul>
</li>
<li><a href="#next-steps">11. Next steps</a></li>
</ul>

                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <h1>Oracle Cloud Streaming and the Micronaut Framework - Event-Driven Applications at Scale</h1>
                <div class="underline"></div>
<div class="sect1">
<div class="sectionbody">

<div class="paragraph">
<p>Use Oracle Cloud Streaming to communicate between your Micronaut applications.</p>
</div>
<div class="paragraph">
<p>Authors: Burt Beckwith</p>
</div>
<div class="paragraph">
<p>Micronaut Version: 3.9.2</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started">1. Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this guide, we will create two Micronaut microservices written in Groovy that will use <a href="https://docs.oracle.com/en-us/iaas/Content/Streaming/Concepts/streamingoverview.htm">Oracle Cloud Streaming</a> to communicate with each other in an asynchronous and decoupled way.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-you-will-need">2. What You Will Need</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE</p>
</li>
<li>
<p>JDK 11 or greater installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
<li>
<p>An Oracle Cloud account (create a free trial account at <a href="https://signup.oraclecloud.com">signup.oraclecloud.com</a>)</p>
</li>
<li>
<p><a href="https://docs.cloud.oracle.com/en-us/iaas/Content/API/SDKDocs/cliinstall.htm">Oracle Cloud CLI</a> installed with local access to Oracle Cloud configured by running <code>oci setup config</code></p>
</li>
<li>
<p><a href="https://www.docker.io/gettingstarted/#h_installation">Docker</a> and <a href="https://docs.docker.com/compose/install/">Docker Compose</a> installed if you will be running Kafka in Docker and for running tests.</p>
</li>
</ul>
</div>
</div>
</div>
</div></div><div class="row"><div class="col-md-12"><div class="sect1">
<h2 id="solution">3. Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create the application step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="micronaut-oracle-cloud-streaming-gradle-groovy.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-the-application">4. Writing the Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The microservices will use Oracle Cloud Streaming and the Kafka API to send and receive messages. The messages will represent chess gameplay events, including game start and end and each move.</p>
</div>
<div class="paragraph">
<p>The microservices are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>chess-game</code> - Has a simple JavaScript and Ajax UI that renders a variable number of chess games that will be auto-played to generate many events</p>
</li>
<li>
<p><code>chess-listener</code> - Receives the chess event messages and persists them to a database</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://guides.micronaut.io/latest/micronaut-intellij-idea-ide-setup.html">Setup IntelliJ IDEA to develop Micronaut Applications</a>.</p>
</div>
<div class="sect2">
<h3 id="chess-game-microservice">4.1. chess-game Microservice</h3>
<div class="paragraph">
<p>Create the <code>chess-game</code> microservice using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mn create-app --features=kafka,graalvm,reactor,testcontainers example.micronaut.chess-game --build=gradle --lang=groovy</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add the <code>kafka</code>, <code>graalvm</code>, <code>reactor</code>, and <code>testcontainers</code> features.</p>
</div>
<div class="paragraph">
<p>The previous command creates a directory named <code>chess-game</code> and a Micronaut application inside it with default package <code>example.micronaut</code>.</p>
</div>
<div class="paragraph">
<p>In addition to the dependencies added by the <code>testcontainers</code> feature, we also need a test dependency for <a href="https://www.testcontainers.org/modules/kafka/">Kafka in Testcontainers</a>, along with one for the <a href="http://www.awaitility.org/">Awaitility</a> library:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">testImplementation(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.testcontainers:kafka</span><span class="delimiter">&quot;</span></span>)
testImplementation(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.awaitility:awaitility:4.2.0</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="dtos">4.1.1. DTOs</h4>
<div class="paragraph">
<p>Create an enum for the chess players:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/groovy/example/micronaut/chess/dto/Player.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut.chess.dto

<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.annotation.JsonValue</span>

<span class="type">enum</span> Player {
    WHITE(<span class="string"><span class="delimiter">'</span><span class="content">w</span><span class="delimiter">'</span></span>),
    BLACK(<span class="string"><span class="delimiter">'</span><span class="content">b</span><span class="delimiter">'</span></span>);

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> color

    Player(<span class="predefined-type">String</span> color) {
        <span class="local-variable">this</span>.color = color
    }

    <span class="annotation">@JsonValue</span>
    <span class="predefined-type">String</span> toString() {
        color
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a <code>GameDTO</code> data-transfer object to represent game data:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/groovy/example/micronaut/chess/dto/GameDTO.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut.chess.dto

<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.annotation.JsonTypeInfo</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.Creator</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.Introspected</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.NonNull</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.Nullable</span>

<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotNull</span>
<span class="keyword">import</span> <span class="include">javax.validation.constraints.Size</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">com.fasterxml.jackson.annotation.JsonTypeInfo.Id.NAME</span>

<span class="annotation">@Introspected</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@JsonTypeInfo</span>(use = NAME, property = <span class="string"><span class="delimiter">'</span><span class="content">_className</span><span class="delimiter">'</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">GameDTO</span> {

    <span class="annotation">@Size</span>(max = <span class="integer">36</span>)
    <span class="annotation">@NotNull</span>
    <span class="annotation">@NonNull</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> id

    <span class="annotation">@Size</span>(max = <span class="integer">255</span>)
    <span class="annotation">@Nullable</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> blackName

    <span class="annotation">@Size</span>(max = <span class="integer">255</span>)
    <span class="annotation">@Nullable</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> whiteName

    <span class="directive">final</span> <span class="type">boolean</span> draw

    <span class="annotation">@Size</span>(max = <span class="integer">1</span>)
    <span class="annotation">@Nullable</span>
    <span class="directive">final</span> Player winner

    <span class="annotation">@Creator</span> <i class="conum" data-value="3"></i><b>(3)</b>
    GameDTO(<span class="annotation">@NonNull</span> <span class="predefined-type">String</span> id,
            <span class="annotation">@Nullable</span> <span class="predefined-type">String</span> blackName,
            <span class="annotation">@Nullable</span> <span class="predefined-type">String</span> whiteName,
            <span class="type">boolean</span> draw,
            <span class="annotation">@Nullable</span> Player winner) {
        <span class="local-variable">this</span>.id = id
        <span class="local-variable">this</span>.blackName = blackName
        <span class="local-variable">this</span>.whiteName = whiteName
        <span class="local-variable">this</span>.draw = draw
        <span class="local-variable">this</span>.winner = winner
    }

    GameDTO(<span class="annotation">@NonNull</span> <span class="predefined-type">String</span> id,
            <span class="annotation">@NonNull</span> <span class="predefined-type">String</span> blackName,
            <span class="annotation">@NonNull</span> <span class="predefined-type">String</span> whiteName) {
        <span class="local-variable">this</span>(id, blackName, whiteName, <span class="predefined-constant">false</span>, <span class="predefined-constant">null</span>)
    }

    GameDTO(<span class="annotation">@NonNull</span> <span class="predefined-type">String</span> id,
            <span class="type">boolean</span> draw,
            <span class="annotation">@Nullable</span> Player winner) {
        <span class="local-variable">this</span>(id, <span class="predefined-constant">null</span>, <span class="predefined-constant">null</span>, draw, winner)
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <a href="https://docs.micronaut.io/latest/api/io/micronaut/core/annotation/Introspected.html"><code>@Introspected</code></a> to generate <code>BeanIntrospection</code> metadata at compilation time. This information can be used, for example, to render the POJO as JSON using Jackson without using reflection.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>@JsonTypeInfo</code> to include the class name without package in the <code>"_className"</code> property</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Annotate with <code>@Creator</code> to indicate the constructor to use when deserializing from JSON</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a <code>GameStateDTO</code> data-transfer object to represent game move data:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/groovy/example/micronaut/chess/dto/GameStateDTO.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut.chess.dto

<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.annotation.JsonTypeInfo</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.Introspected</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.NonNull</span>

<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotNull</span>
<span class="keyword">import</span> <span class="include">javax.validation.constraints.Size</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">com.fasterxml.jackson.annotation.JsonTypeInfo.Id.NAME</span>

<span class="annotation">@Introspected</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@JsonTypeInfo</span>(use = NAME, property = <span class="string"><span class="delimiter">'</span><span class="content">_className</span><span class="delimiter">'</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">GameStateDTO</span> {

    <span class="annotation">@Size</span>(max = <span class="integer">36</span>)
    <span class="annotation">@NotNull</span>
    <span class="annotation">@NonNull</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> id

    <span class="annotation">@Size</span>(max = <span class="integer">36</span>)
    <span class="annotation">@NotNull</span>
    <span class="annotation">@NonNull</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> gameId

    <span class="annotation">@Size</span>(max = <span class="integer">1</span>)
    <span class="annotation">@NotNull</span>
    <span class="annotation">@NonNull</span>
    <span class="directive">final</span> Player player

    <span class="annotation">@Size</span>(max = <span class="integer">100</span>)
    <span class="annotation">@NotNull</span>
    <span class="annotation">@NonNull</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> fen

    <span class="annotation">@NotNull</span>
    <span class="annotation">@NonNull</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> pgn

    <span class="annotation">@Size</span>(max = <span class="integer">10</span>)
    <span class="annotation">@NotNull</span>
    <span class="annotation">@NonNull</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> move

    GameStateDTO(<span class="annotation">@NonNull</span> <span class="predefined-type">String</span> id,
                 <span class="annotation">@NonNull</span> <span class="predefined-type">String</span> gameId,
                 <span class="annotation">@NonNull</span> Player player,
                 <span class="annotation">@NonNull</span> <span class="predefined-type">String</span> move,
                 <span class="annotation">@NonNull</span> <span class="predefined-type">String</span> fen,
                 <span class="annotation">@NonNull</span> <span class="predefined-type">String</span> pgn) {
        <span class="local-variable">this</span>.id = id
        <span class="local-variable">this</span>.gameId = gameId
        <span class="local-variable">this</span>.player = player
        <span class="local-variable">this</span>.move = move
        <span class="local-variable">this</span>.fen = fen
        <span class="local-variable">this</span>.pgn = pgn
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <a href="https://docs.micronaut.io/latest/api/io/micronaut/core/annotation/Introspected.html"><code>@Introspected</code></a> to generate <code>BeanIntrospection</code> metadata at compilation time. This information can be used, for example, to render the POJO as JSON using Jackson without using reflection.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate with <code>@JsonTypeInfo</code> to include the class name without package in the <code>"_className"</code> property</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="gamereporter">4.1.2. GameReporter</h4>
<div class="paragraph">
<p>Create a <code>GameReporter</code> Kafka client to send chess-related messages:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/groovy/example/micronaut/chess/GameReporter.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut.chess

<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.GameDTO</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.GameStateDTO</span>
<span class="keyword">import</span> <span class="include">io.micronaut.configuration.kafka.annotation.KafkaClient</span>
<span class="keyword">import</span> <span class="include">io.micronaut.configuration.kafka.annotation.KafkaKey</span>
<span class="keyword">import</span> <span class="include">io.micronaut.configuration.kafka.annotation.Topic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.NonNull</span>
<span class="keyword">import</span> <span class="include">reactor.core.publisher.Mono</span>

<span class="annotation">@KafkaClient</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">interface</span> GameReporter {

    <span class="annotation">@Topic</span>(<span class="string"><span class="delimiter">'</span><span class="content">chessGame</span><span class="delimiter">'</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="annotation">@NonNull</span>
    Mono&lt;GameDTO&gt; game(<span class="annotation">@NonNull</span> <span class="annotation">@KafkaKey</span> <span class="predefined-type">String</span> gameId,  <i class="conum" data-value="3"></i><b>(3)</b> <i class="conum" data-value="4"></i><b>(4)</b>
                       <span class="annotation">@NonNull</span> GameDTO game)

    <span class="annotation">@Topic</span>(<span class="string"><span class="delimiter">'</span><span class="content">chessGameState</span><span class="delimiter">'</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="annotation">@NonNull</span>
    Mono&lt;GameStateDTO&gt; gameState(<span class="annotation">@NonNull</span> <span class="annotation">@KafkaKey</span> <span class="predefined-type">String</span> gameId,  <i class="conum" data-value="3"></i><b>(3)</b> <i class="conum" data-value="4"></i><b>(4)</b>
                                 <span class="annotation">@NonNull</span> GameStateDTO gameState)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@KafkaClient</code> to declare it as a Kafka message producer; the Micronaut framework will generate the sending code at compile time</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Annotate the method with <code>@Topic</code> and specify the topic name</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>By returning a reactive type, the Micronaut framework will use non-blocking code to send the message</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use the <code>Game</code> primary key as the Kafka partition key</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="gamecontroller">4.1.3. GameController</h4>
<div class="paragraph">
<p>Create a <code>GameController</code> class to contain Ajax endpoints for the front end:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/groovy/example/micronaut/chess/GameController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut.chess

<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.Player</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.GameDTO</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.GameStateDTO</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Controller</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.PathVariable</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Post</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Status</span>
<span class="keyword">import</span> <span class="include">io.micronaut.scheduling.TaskExecutors</span>
<span class="keyword">import</span> <span class="include">io.micronaut.scheduling.annotation.ExecuteOn</span>
<span class="keyword">import</span> <span class="include">reactor.core.publisher.Mono</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.http.HttpStatus.CREATED</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.http.HttpStatus.NO_CONTENT</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.http.MediaType.APPLICATION_FORM_URLENCODED</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.http.MediaType.TEXT_PLAIN</span>

<span class="annotation">@Controller</span>(<span class="string"><span class="delimiter">'</span><span class="content">/game</span><span class="delimiter">'</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@ExecuteOn</span>(TaskExecutors.IO) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">GameController</span> {

    <span class="directive">private</span> <span class="directive">final</span> GameReporter gameReporter

    GameController(GameReporter gameReporter) {
        <span class="local-variable">this</span>.gameReporter = gameReporter
    }

    <span class="annotation">@Post</span>(value = <span class="string"><span class="delimiter">'</span><span class="content">/start</span><span class="delimiter">'</span></span>, <i class="conum" data-value="3"></i><b>(3)</b>
          consumes = APPLICATION_FORM_URLENCODED, <i class="conum" data-value="4"></i><b>(4)</b>
          produces = TEXT_PLAIN) <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="annotation">@Status</span>(CREATED) <i class="conum" data-value="6"></i><b>(6)</b>
    Mono&lt;<span class="predefined-type">String</span>&gt; start(<span class="predefined-type">String</span> b, <i class="conum" data-value="7"></i><b>(7)</b>
                       <span class="predefined-type">String</span> w) {
        GameDTO game = <span class="keyword">new</span> GameDTO(<span class="predefined-type">UUID</span>.randomUUID().toString(), b, w) <i class="conum" data-value="8"></i><b>(8)</b>
        gameReporter.game(game.id, game).map(gameDTO -&gt; game.id) <i class="conum" data-value="9"></i><b>(9)</b>
    }

    <span class="annotation">@Post</span>(value = <span class="string"><span class="delimiter">'</span><span class="content">/move/{gameId}</span><span class="delimiter">'</span></span>, <i class="conum" data-value="10"></i><b>(10)</b>
          consumes = APPLICATION_FORM_URLENCODED) <i class="conum" data-value="11"></i><b>(11)</b>
    <span class="annotation">@Status</span>(CREATED) <i class="conum" data-value="12"></i><b>(12)</b>
    <span class="type">void</span> move(<span class="annotation">@PathVariable</span> <span class="predefined-type">String</span> gameId,
              Player player,
              <span class="predefined-type">String</span> move,
              <span class="predefined-type">String</span> fen,
              <span class="predefined-type">String</span> pgn) {
        GameStateDTO gameState = <span class="keyword">new</span> GameStateDTO(<span class="predefined-type">UUID</span>.randomUUID().toString(),
                gameId, player, move, fen, pgn)
        gameReporter.gameState(gameId, gameState).subscribe() <i class="conum" data-value="13"></i><b>(13)</b>
    }

    <span class="annotation">@Post</span>(<span class="string"><span class="delimiter">'</span><span class="content">/checkmate/{gameId}/{player}</span><span class="delimiter">'</span></span>) <i class="conum" data-value="14"></i><b>(14)</b>
    <span class="annotation">@Status</span>(NO_CONTENT) <i class="conum" data-value="15"></i><b>(15)</b>
    <span class="type">void</span> checkmate(<span class="annotation">@PathVariable</span> <span class="predefined-type">String</span> gameId,
                   <span class="annotation">@PathVariable</span> Player player) {
        GameDTO game = <span class="keyword">new</span> GameDTO(gameId, <span class="predefined-constant">false</span>, player)
        gameReporter.game(gameId, game).subscribe() <i class="conum" data-value="16"></i><b>(16)</b>
    }

    <span class="annotation">@Post</span>(<span class="string"><span class="delimiter">'</span><span class="content">/draw/{gameId}</span><span class="delimiter">'</span></span>) <i class="conum" data-value="17"></i><b>(17)</b>
    <span class="annotation">@Status</span>(NO_CONTENT) <i class="conum" data-value="18"></i><b>(18)</b>
    <span class="type">void</span> draw(<span class="annotation">@PathVariable</span> <span class="predefined-type">String</span> gameId) {
        GameDTO game = <span class="keyword">new</span> GameDTO(gameId, <span class="predefined-constant">true</span>, <span class="predefined-constant">null</span>)
        gameReporter.game(gameId, game).subscribe() <i class="conum" data-value="19"></i><b>(19)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/game</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>It is critical that any blocking I/O operations (such as fetching the data from the database) are offloaded to a separate thread pool that does not block the Event loop.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The method accepts HTTP POST requests to indicate a new game has started</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The method accepts encoded form data (the two players' names)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The response will be plain text and contain the ID of the persisted <code>Game</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Send a <code>"Created"</code> (201) status to indicate a <code>Game</code> was persisted</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Return a reactive type to configure a reactive response</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Assign the game&#8217;s primary key as a UUID</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Use the <code>GameReporter</code> to send a Kafka message with new game data</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>The method accepts HTTP POST requests to indicate a move has occurred</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>The method accepts encoded form data (the move information)</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Send a <code>"Created"</code> (201) status to indicate a <code>GameState</code> was persisted</td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>Use the <code>GameReporter</code> to send a Kafka message with game move data</td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td>The method accepts HTTP POST requests to indicate the game ended with a checkmate</td>
</tr>
<tr>
<td><i class="conum" data-value="15"></i><b>15</b></td>
<td>Send a <code>"No Content"</code> (204) status to indicate success and no response body</td>
</tr>
<tr>
<td><i class="conum" data-value="16"></i><b>16</b></td>
<td>Use the <code>GameReporter</code> to send a Kafka message that the game ended in a checkmate</td>
</tr>
<tr>
<td><i class="conum" data-value="17"></i><b>17</b></td>
<td>The method accepts HTTP POST requests to indicate the game ended with a draw</td>
</tr>
<tr>
<td><i class="conum" data-value="18"></i><b>18</b></td>
<td>Send a <code>"No Content"</code> (204) status to indicate success and no response body</td>
</tr>
<tr>
<td><i class="conum" data-value="19"></i><b>19</b></td>
<td>Use the <code>GameReporter</code> to send a Kafka message that the game ended in a draw</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="development-environment">4.1.4. Development environment</h4>
<div class="paragraph">
<p>Modify the <code>Application</code> class to use <code>dev</code> as a default environment:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The Micronaut framework supports the concept of one or many default environments. A default environment is one that is only applied if no other environments are explicitly specified or deduced.</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/groovy/example/micronaut/Application.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.runtime.Micronaut</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.context.env.Environment.DEVELOPMENT</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">Application</span> {

    <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        Micronaut.build(args)
                .mainClass(Application)
                .defaultEnvironments(DEVELOPMENT)
                .start() 
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Delete the <code>kafka.bootstrap.servers</code> config option from <code>application.yml</code> and move it to <code>application-dev.yml</code>.</p>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/application-dev.yml</code>. The Micronaut framework applies this configuration file only for the <code>dev</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/resources/application-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">kafka</span>:
  <span class="key">bootstrap</span>:
    <span class="key">servers</span>: <span class="string"><span class="content">localhost:9092 </span></span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use local Kafka in the development environment</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="static-resources">4.1.5. Static Resources</h4>
<div class="paragraph">
<p>Update <code>application.yml</code> to add static resource configuration:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">router</span>:
    <span class="key">static-resources</span>:
      <span class="key">default</span>:
        <span class="key">paths</span>: <span class="string"><span class="content">classpath:public </span></span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the Framework to look for static resources in <code>src/main/resources/public</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ui-resources">4.1.6. UI Resources</h4>
<div class="paragraph">
<p>Create <code>index.html</code> with the simple chess game UI:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/resources/public/index.html</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><span class="doctype">&lt;!doctype html&gt;</span>
<span class="tag">&lt;html</span> <span class="attribute-name">lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">en</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;head&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">utf-8</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">http-equiv</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">X-UA-Compatible</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">content</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">IE=edge</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;title&gt;</span>Micronaut Chess Multi<span class="tag">&lt;/title&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">viewport</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">content</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">width=device-width, initial-scale=1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;link</span> <span class="attribute-name">rel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">shortcut icon</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">image/png</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">favicon-32x32.png</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;link</span> <span class="attribute-name">rel</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">stylesheet</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">href</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">integrity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">crossorigin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">anonymous</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;style&gt;</span>
<span class="inline">        <span class="class">.gamesRow</span> {
            <span class="key">width</span>: <span class="float">100%</span>;
            <span class="key">margin</span>: <span class="float">0</span> <span class="value">auto</span>;
        }
        <span class="class">.gameContainer</span> {
            <span class="key">display</span>: <span class="value">inline-block</span>;
        }</span>
    <span class="tag">&lt;/style&gt;</span>
<span class="tag">&lt;/head&gt;</span>
<span class="tag">&lt;body&gt;</span>

<span class="tag">&lt;div</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">counts</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;div&gt;</span>
        <span class="tag">&lt;label</span> <span class="attribute-name">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rowCount</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Rows:<span class="entity">&amp;nbsp;</span><span class="tag">&lt;/label&gt;</span><span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">number</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">min</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rowCount</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;/div&gt;</span>
    <span class="tag">&lt;div&gt;</span>
        <span class="tag">&lt;label</span> <span class="attribute-name">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gamesPerRow</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Games per row:<span class="entity">&amp;nbsp;</span><span class="tag">&lt;/label&gt;</span><span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">number</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">min</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gamesPerRow</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;/div&gt;</span>
    <span class="tag">&lt;div&gt;</span>
        <span class="tag">&lt;label</span> <span class="attribute-name">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playDelay</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Play delay milliseconds:<span class="entity">&amp;nbsp;</span><span class="tag">&lt;/label&gt;</span><span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">number</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">5</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">min</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">playDelay</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;/div&gt;</span>
    <span class="tag">&lt;div&gt;</span>
        <span class="tag">&lt;button</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">startButton</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>START<span class="tag">&lt;/button&gt;</span>
    <span class="tag">&lt;/div&gt;</span>
<span class="tag">&lt;/div&gt;</span>

<span class="tag">&lt;div</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">gamesContainer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/div&gt;</span>

<span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://code.jquery.com/jquery-3.5.1.min.js</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">integrity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">crossorigin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">anonymous</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">integrity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">crossorigin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">anonymous</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">integrity</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sha512-ujGsB4vTyNcSuViwM2DJ0+G2BIViQJl2rVBZBekStznA9Hq96+Wd9+jwu9zlttp0U2/9CYhgR7pOt2j+E6yewg==</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">crossorigin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">anonymous</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">referrerpolicy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">no-referrer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">micronaut-chess.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The HTML page includes the <a href="https://chessboardjs.com/">chessboard.js</a> JavaScript library to create a chess board and the <a href="https://github.com/jhlywa/chess.js">chess.js</a> JavaScript library for chess game logic.</p>
</div>
<div class="paragraph">
<p>Create <code>micronaut-chess.js</code> used by <code>index.html</code> with the JavaScript code:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/resources/public/micronaut-chess.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="js"><span class="keyword">function</span> <span class="function">updateStatus</span>(n, started) {

    <span class="keyword">if</span> (started) {
        onMove(n);
    }

    const game = GAMES[n];
    <span class="keyword">if</span> (game.in_checkmate()) {
        onCheckmate(n);
    }
    <span class="keyword">else</span> <span class="keyword">if</span> (game.in_draw()) {
        onDraw(n);
    }
}

<span class="keyword">function</span> <span class="function">onGameStart</span>(n) {
    <span class="predefined">$</span>.post(<span class="string"><span class="delimiter">'</span><span class="content">/game/start</span><span class="delimiter">'</span></span>, { <span class="key">b</span>: BLACK_NAMES[n], <span class="key">w</span>: WHITE_NAMES[n]}, <span class="keyword">function</span> (data) {
        const gameId = data;
        GAME_IDS[n] = gameId;
        <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#gameId</span><span class="delimiter">'</span></span> + n).text(<span class="string"><span class="delimiter">'</span><span class="content">Game ID: </span><span class="delimiter">'</span></span> + gameId);
        window.setTimeout(<span class="keyword">function</span> () {
            makeRandomMove(n);
        }, <span class="integer">2000</span>); <span class="comment">// delay a bit so the Game is persisted</span>
    });
}

<span class="keyword">function</span> <span class="function">onMove</span>(n) {
    const game = GAMES[n];
    const history = game.history();
    const move = history[history.length - <span class="integer">1</span>];

    <span class="predefined">$</span>.post(<span class="string"><span class="delimiter">'</span><span class="content">/game/move/</span><span class="delimiter">'</span></span> + GAME_IDS[n], {
        <span class="key">player</span>: other(n),
        <span class="key">fen</span>: game.fen(),
        <span class="key">pgn</span>: game.pgn(),
        <span class="key">move</span>: move
    });
}

<span class="keyword">function</span> <span class="function">onCheckmate</span>(n) {
    const winner = other(n);
    <span class="predefined">$</span>.post(<span class="string"><span class="delimiter">'</span><span class="content">/game/checkmate/</span><span class="delimiter">'</span></span> + GAME_IDS[n] + <span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span> + winner);
}

<span class="keyword">function</span> <span class="function">onDraw</span>(n) {
    <span class="predefined">$</span>.post(<span class="string"><span class="delimiter">'</span><span class="content">/game/draw/</span><span class="delimiter">'</span></span> + GAME_IDS[n]);
}

<span class="keyword">function</span> <span class="function">other</span>(n) {
    <span class="keyword">return</span> GAMES[n].turn() === <span class="string"><span class="delimiter">'</span><span class="content">b</span><span class="delimiter">'</span></span> ? <span class="string"><span class="delimiter">'</span><span class="content">w</span><span class="delimiter">'</span></span> : <span class="string"><span class="delimiter">'</span><span class="content">b</span><span class="delimiter">'</span></span>;
}

<span class="keyword">function</span> <span class="function">makeRandomMove</span>(n) {

    const game = GAMES[n];

    <span class="keyword">if</span> (game.game_over()) {
        restart(n);
        <span class="keyword">return</span>;
    }

    const possibleMoves = game.moves();
    const moveIndex = Math.floor(Math.random() * possibleMoves.length);
    game.move(possibleMoves[moveIndex]);
    BOARDS[n].position(game.fen());
    updateStatus(n, <span class="predefined-constant">true</span>);

    window.setTimeout(<span class="keyword">function</span> () {
        makeRandomMove(n);
    }, playDelay);
}

<span class="keyword">function</span> <span class="function">restart</span>(n) {
    BOARDS[n].position(FEN_INITIAL);
    GAMES[n].load(FEN_INITIAL);
    updateStatus(n, <span class="predefined-constant">false</span>);
    onGameStart(n);
}

<span class="keyword">function</span> <span class="function">startGames</span>() {
    <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#counts</span><span class="delimiter">'</span></span>).toggle();

    playDelay = parseInt(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#playDelay</span><span class="delimiter">'</span></span>).val(), <span class="integer">10</span>);

    const rowCount = parseInt(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#rowCount</span><span class="delimiter">'</span></span>).val(), <span class="integer">10</span>);
    const gamesPerRow = parseInt(<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#gamesPerRow</span><span class="delimiter">'</span></span>).val(), <span class="integer">10</span>);
    const hWidth = (window.innerWidth - <span class="integer">50</span>) / gamesPerRow;
    const vWidth = window.innerHeight / rowCount - <span class="integer">50</span>;
    const gameWidth = Math.min(<span class="integer">400</span>, hWidth, vWidth);

    <span class="keyword">for</span> (let r = <span class="integer">0</span>; r &lt; rowCount; r++) {

        const gamesContainer = <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#gamesContainer</span><span class="delimiter">'</span></span>);
        gamesContainer.append(
            <span class="string"><span class="delimiter">'</span><span class="content">&lt;div id=&quot;gamesRow</span><span class="delimiter">'</span></span> + r + <span class="string"><span class="delimiter">'</span><span class="content">&quot; class=&quot;gamesRow&quot;&gt;&lt;/div&gt;</span><span class="delimiter">'</span></span>
        );

        <span class="keyword">for</span> (let c = <span class="integer">0</span>; c &lt; gamesPerRow; c++) {

            const n = r * gamesPerRow + c;

            const gamesRow = <span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#gamesRow</span><span class="delimiter">'</span></span> + r);
            gamesRow.append(
                <span class="string"><span class="delimiter">'</span><span class="content">&lt;div class=&quot;gameContainer&quot; style=&quot;width: </span><span class="delimiter">'</span></span> + gameWidth + <span class="string"><span class="delimiter">'</span><span class="content">px&quot;&gt;</span><span class="delimiter">'</span></span> +
                <span class="string"><span class="delimiter">'</span><span class="content">&lt;div id=&quot;chessboard</span><span class="delimiter">'</span></span> + n + <span class="string"><span class="delimiter">'</span><span class="content">&quot;&gt;&lt;/div&gt;</span><span class="delimiter">'</span></span> +
                <span class="string"><span class="delimiter">'</span><span class="content">&lt;div&gt;&lt;span id=&quot;gameId</span><span class="delimiter">'</span></span> + n + <span class="string"><span class="delimiter">'</span><span class="content">&quot;&gt;&lt;/span&gt;&lt;/div&gt;</span><span class="delimiter">'</span></span> +
                <span class="string"><span class="delimiter">'</span><span class="content">&lt;/div&gt;</span><span class="delimiter">'</span></span>
            );

            GAMES[n] = <span class="keyword">new</span> Chess();
            BLACK_NAMES[n] = <span class="string"><span class="delimiter">'</span><span class="content">b</span><span class="delimiter">'</span></span> + n;
            WHITE_NAMES[n] = <span class="string"><span class="delimiter">'</span><span class="content">w</span><span class="delimiter">'</span></span> + n;

            BOARDS[n] = Chessboard(<span class="string"><span class="delimiter">'</span><span class="content">chessboard</span><span class="delimiter">'</span></span> + n, {
                <span class="key">position</span>: <span class="string"><span class="delimiter">'</span><span class="content">start</span><span class="delimiter">'</span></span>,
                <span class="key">appearSpeed</span>: <span class="integer">0</span>,
                <span class="key">moveSpeed</span>: <span class="integer">0</span>
            });

            updateStatus(n, <span class="predefined-constant">false</span>);
            onGameStart(n);
        }
    }
}

const FEN_INITIAL = <span class="string"><span class="delimiter">'</span><span class="content">rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1</span><span class="delimiter">'</span></span>;
const GAME_IDS = [];
const BOARDS = [];
const BLACK_NAMES = [];
const WHITE_NAMES = [];
const GAMES = [];
let playDelay = <span class="integer">5</span>;

<span class="predefined">$</span>(<span class="string"><span class="delimiter">'</span><span class="content">#startButton</span><span class="delimiter">'</span></span>).on(<span class="string"><span class="delimiter">'</span><span class="content">click</span><span class="delimiter">'</span></span>, startGames);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy these chess piece images to <code>src/main/resources/public/img/chesspieces/wikipedia</code> (the path must be correct because it is hard-coded in <code>chessboard.js</code>):</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/oraclecloudstream/bB.png" alt="bB"></span> <span class="image"><img src="images/oraclecloudstream/bK.png" alt="bK"></span> <span class="image"><img src="images/oraclecloudstream/bN.png" alt="bN"></span> <span class="image"><img src="images/oraclecloudstream/bP.png" alt="bP"></span> <span class="image"><img src="images/oraclecloudstream/bQ.png" alt="bQ"></span> <span class="image"><img src="images/oraclecloudstream/bR.png" alt="bR"></span></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="images/oraclecloudstream/wB.png" alt="wB"></span> <span class="image"><img src="images/oraclecloudstream/wK.png" alt="wK"></span> <span class="image"><img src="images/oraclecloudstream/wN.png" alt="wN"></span> <span class="image"><img src="images/oraclecloudstream/wP.png" alt="wP"></span> <span class="image"><img src="images/oraclecloudstream/wQ.png" alt="wQ"></span> <span class="image"><img src="images/oraclecloudstream/wR.png" alt="wR"></span></p>
</div>
<div class="paragraph">
<p>Right-click each image and save to your local file system, or extract the completed example zip file linked above and get them from there.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="chess-listener-microservice">4.2. chess-listener Microservice</h3>
<div class="paragraph">
<p>Create the <code>chess-listener</code> microservice using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mn create-app --features=kafka,graalvm,data-jdbc,flyway,reactor,testcontainers example.micronaut.chess-listener --build=gradle --lang=groovy</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add the <code>kafka</code>, <code>graalvm</code>, <code>data-jdbc</code>, <code>flyway</code>, <code>reactor</code>, and <code>testcontainers</code> features.</p>
</div>
<div class="paragraph">
<p>The previous command creates a directory named <code>chess-listener</code> and a Micronaut application inside it with default package <code>example.micronaut</code>.</p>
</div>
<div class="paragraph">
<p>In addition to the dependencies added by the <code>testcontainers</code> feature, we also need a test dependency for Kafka and Oracle in Testcontainers, along with one for the <a href="http://www.awaitility.org/">Awaitility</a> library:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">testImplementation(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.testcontainers:kafka</span><span class="delimiter">&quot;</span></span>)
testImplementation(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.testcontainers:oracle-xe</span><span class="delimiter">&quot;</span></span>)
testImplementation(<span class="string"><span class="delimiter">&quot;</span><span class="content">org.awaitility:awaitility:4.2.0</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="flyway">4.2.1. Flyway</h4>
<div class="paragraph">
<p>Enable Flyway database migrations for all environments by adding this configuration to <code>application.yml</code>:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">flyway</span>:
  <span class="key">datasources</span>:
    <span class="key">default</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dtos-2">4.2.2. DTOs</h4>
<div class="paragraph">
<p>The same data transfer objects (<code>GameDTO</code> and <code>GameStateDTO</code>&#8230;&#8203;) as above in the <code>chess-game</code> microservice. In a real application, these would be in a shared library, but to keep things simple, we&#8217;ll just duplicate them.</p>
</div>
</div>
<div class="sect3">
<h4 id="entity-classes">4.2.3. Entity Classes</h4>
<div class="paragraph">
<p>Create a <code>Game</code> entity to represent persistent game data:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/groovy/example/micronaut/chess/entity/Game.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut.chess.entity

<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.Player</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.GameDTO</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.NonNull</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.Nullable</span>
<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotBlank</span>
<span class="keyword">import</span> <span class="include">io.micronaut.data.annotation.DateCreated</span>
<span class="keyword">import</span> <span class="include">io.micronaut.data.annotation.DateUpdated</span>
<span class="keyword">import</span> <span class="include">io.micronaut.data.annotation.Id</span>
<span class="keyword">import</span> <span class="include">io.micronaut.data.annotation.MappedEntity</span>

<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotNull</span>
<span class="keyword">import</span> <span class="include">javax.validation.constraints.Size</span>
<span class="keyword">import</span> <span class="include">java.time.LocalDateTime</span>

<span class="annotation">@MappedEntity</span>(<span class="string"><span class="delimiter">'</span><span class="content">GAME</span><span class="delimiter">'</span></span>)
<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">Game</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@NotNull</span>
    <span class="directive">final</span> <span class="predefined-type">UUID</span> id

    <span class="annotation">@Size</span>(max = <span class="integer">255</span>)
    <span class="annotation">@NotBlank</span>
    <span class="annotation">@NonNull</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> blackName

    <span class="annotation">@Size</span>(max = <span class="integer">255</span>)
    <span class="annotation">@NotBlank</span>
    <span class="annotation">@NonNull</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> whiteName

    <span class="annotation">@DateCreated</span>
    LocalDateTime dateCreated

    <span class="annotation">@DateUpdated</span>
    LocalDateTime dateUpdated

    <span class="type">boolean</span> draw

    <span class="annotation">@Nullable</span>
    <span class="annotation">@Size</span>(max = <span class="integer">1</span>)
    Player winner

    Game(<span class="annotation">@NonNull</span> <span class="predefined-type">UUID</span> id,
         <span class="annotation">@NonNull</span> <span class="predefined-type">String</span> blackName,
         <span class="annotation">@NonNull</span> <span class="predefined-type">String</span> whiteName) {
        <span class="local-variable">this</span>.id = id
        <span class="local-variable">this</span>.blackName = blackName
        <span class="local-variable">this</span>.whiteName = whiteName
    }

    GameDTO toDto() {
        <span class="keyword">new</span> GameDTO(id.toString(), blackName, whiteName, draw, winner)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a <code>GameState</code> entity to represent persistent game move data:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/groovy/example/micronaut/chess/entity/GameState.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut.chess.entity

<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.GameStateDTO</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.NonNull</span>
<span class="keyword">import</span> <span class="include">io.micronaut.data.annotation.DateCreated</span>
<span class="keyword">import</span> <span class="include">io.micronaut.data.annotation.Id</span>
<span class="keyword">import</span> <span class="include">io.micronaut.data.annotation.MappedEntity</span>
<span class="keyword">import</span> <span class="include">io.micronaut.data.annotation.Relation</span>
<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotNull</span>
<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotBlank</span>
<span class="keyword">import</span> <span class="include">javax.validation.constraints.Size</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.Player</span>
<span class="keyword">import</span> <span class="include">java.time.LocalDateTime</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.data.annotation.Relation.Kind.MANY_TO_ONE</span>

<span class="annotation">@MappedEntity</span>(<span class="string"><span class="delimiter">'</span><span class="content">GAME_STATE</span><span class="delimiter">'</span></span>)
<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">GameState</span> {

    <span class="annotation">@Id</span>
    <span class="annotation">@NotNull</span>
    <span class="annotation">@NonNull</span>
    <span class="directive">final</span> <span class="predefined-type">UUID</span> id

    <span class="annotation">@Relation</span>(MANY_TO_ONE)
    <span class="annotation">@NotNull</span>
    <span class="annotation">@NonNull</span>
    <span class="directive">final</span> Game game

    <span class="annotation">@DateCreated</span>
    LocalDateTime dateCreated

    <span class="annotation">@Size</span>(max = <span class="integer">1</span>)
    <span class="annotation">@NotBlank</span>
    <span class="annotation">@NonNull</span>
    <span class="directive">final</span> Player player

    <span class="annotation">@Size</span>(max = <span class="integer">100</span>)
    <span class="annotation">@NotBlank</span>
    <span class="annotation">@NonNull</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> fen

    <span class="annotation">@NotBlank</span>
    <span class="annotation">@NonNull</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> pgn

    <span class="annotation">@Size</span>(max = <span class="integer">10</span>)
    <span class="annotation">@NotBlank</span>
    <span class="annotation">@NonNull</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> move

    <span class="comment">/**
     * @param id the id
     * @param game the game
     * @param player b or w
     * @param move the current move
     * @param fen https://en.wikipedia.org/wiki/Forsyth%E2%80%93Edwards_Notation
     * @param pgn https://en.wikipedia.org/wiki/Portable_Game_Notation
     */</span>
    GameState(<span class="annotation">@NonNull</span> <span class="predefined-type">UUID</span> id,
              <span class="annotation">@NonNull</span> Game game,
              <span class="annotation">@NonNull</span> Player player,
              <span class="annotation">@NonNull</span> <span class="predefined-type">String</span> move,
              <span class="annotation">@NonNull</span> <span class="predefined-type">String</span> fen,
              <span class="annotation">@NonNull</span> <span class="predefined-type">String</span> pgn) {
        <span class="local-variable">this</span>.id = id;
        <span class="local-variable">this</span>.game = game
        <span class="local-variable">this</span>.player = player
        <span class="local-variable">this</span>.move = move
        <span class="local-variable">this</span>.fen = fen
        <span class="local-variable">this</span>.pgn = pgn
    }

    <span class="annotation">@NonNull</span>
    GameStateDTO toDto() {
        <span class="keyword">new</span> GameStateDTO(id.toString(), game.getId().toString(), player, move, fen, pgn)
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="repositories">4.2.4. Repositories</h4>
<div class="paragraph">
<p>Create a "base" <code>GameRepository</code> interface to have access to methods for <code>Game</code> entity persistence:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/groovy/example/micronaut/chess/repository/GameRepository.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut.chess.repository

<span class="keyword">import</span> <span class="include">example.micronaut.chess.entity.Game</span>
<span class="keyword">import</span> <span class="include">io.micronaut.data.repository.CrudRepository</span>

<span class="type">interface</span> GameRepository <span class="directive">extends</span> CrudRepository&lt;Game, <span class="predefined-type">UUID</span>&gt; {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and a <code>H2GameRepository</code> interface that extends <code>GameRepository</code> and specifies the <code>H2</code> dialect to use an in-memory H2 database in the development environment (we&#8217;ll also be creating an Oracle repository):</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/groovy/example/micronaut/chess/repository/H2GameRepository.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut.chess.repository

<span class="keyword">import</span> <span class="include">io.micronaut.context.annotation.Primary</span>
<span class="keyword">import</span> <span class="include">io.micronaut.context.annotation.Requires</span>
<span class="keyword">import</span> <span class="include">io.micronaut.data.jdbc.annotation.JdbcRepository</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.context.env.Environment.DEVELOPMENT</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.data.model.query.builder.sql.Dialect.H2</span>

<span class="annotation">@Primary</span>
<span class="annotation">@JdbcRepository</span>(dialect = H2) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Requires</span>(env = DEVELOPMENT) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="type">interface</span> H2GameRepository <span class="directive">extends</span> GameRepository {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate with <code>@JdbcRepository</code> to make this a Micronaut Data JDBC repository, and specify the <code>H2</code> dialect. The Micronaut framework will generate persistence logic at compile time and use H2-specific SQL.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Restrict the bean to be available only in the development environment</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a "base" <code>GameStateRepository</code> interface to have access to methods for <code>GameState</code> entity persistence:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/groovy/example/micronaut/chess/repository/GameStateRepository.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut.chess.repository

<span class="keyword">import</span> <span class="include">example.micronaut.chess.entity.GameState</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.NonNull</span>
<span class="keyword">import</span> <span class="include">io.micronaut.data.annotation.Join</span>
<span class="keyword">import</span> <span class="include">io.micronaut.data.repository.CrudRepository</span>

<span class="keyword">import</span> <span class="include">javax.validation.constraints.NotNull</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.data.annotation.Join.Type.FETCH</span>

<span class="type">interface</span> GameStateRepository <span class="directive">extends</span> CrudRepository&lt;GameState, <span class="predefined-type">UUID</span>&gt; {
    <span class="annotation">@Override</span>
    <span class="annotation">@NonNull</span>
    <span class="annotation">@Join</span>(value = <span class="string"><span class="delimiter">&quot;</span><span class="content">game</span><span class="delimiter">&quot;</span></span>, type = FETCH) <i class="conum" data-value="1"></i><b>(1)</b>
    Optional&lt;GameState&gt; findById(<span class="annotation">@NotNull</span> <span class="annotation">@NonNull</span> <span class="predefined-type">UUID</span> id)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Override the <code>findById</code> method from <code>CrudRepository</code> to add a <code>@Join</code> annotation. This will configure the SQL query to load <code>Game</code> data when retrieving a <code>GameState</code> to resolve the <code>game</code> property.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Also create a <code>H2GameStateRepository</code> interface that extends <code>GameStateRepository</code>:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/groovy/example/micronaut/chess/repository/H2GameStateRepository.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut.chess.repository

<span class="keyword">import</span> <span class="include">io.micronaut.context.annotation.Primary</span>
<span class="keyword">import</span> <span class="include">io.micronaut.context.annotation.Requires</span>
<span class="keyword">import</span> <span class="include">io.micronaut.data.jdbc.annotation.JdbcRepository</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.context.env.Environment.DEVELOPMENT</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.data.model.query.builder.sql.Dialect.H2</span>

<span class="annotation">@Primary</span>
<span class="annotation">@JdbcRepository</span>(dialect = H2)
<span class="annotation">@Requires</span>(env = DEVELOPMENT)
<span class="type">interface</span> H2GameStateRepository <span class="directive">extends</span> GameStateRepository {
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="gameservice">4.2.5. GameService</h4>
<div class="paragraph">
<p>Create <code>GameService</code> to coordinate transactional persistence using <code>GameRepository</code> and <code>GameStateRepository</code>:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/groovy/example/micronaut/chess/GameService.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut.chess

<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.GameDTO</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.GameStateDTO</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.entity.Game</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.entity.GameState</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.repository.GameRepository</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.repository.GameStateRepository</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">org.slf4j.Logger</span>
<span class="keyword">import</span> <span class="include">org.slf4j.LoggerFactory</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.NonNull</span>
<span class="keyword">import</span> <span class="include">jakarta.inject.Singleton</span>
<span class="keyword">import</span> <span class="include">javax.transaction.Transactional</span>

<span class="annotation">@Singleton</span>
<span class="annotation">@Transactional</span>
<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">GameService</span> {

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> log = LoggerFactory.getLogger(GameService.name)

    <span class="directive">private</span> <span class="directive">final</span> GameRepository gameRepository
    <span class="directive">private</span> <span class="directive">final</span> GameStateRepository gameStateRepository

    GameService(GameRepository gameRepository,
                GameStateRepository gameStateRepository) {
        <span class="local-variable">this</span>.gameRepository = gameRepository
        <span class="local-variable">this</span>.gameStateRepository = gameStateRepository
    }

    <span class="comment">/**
     * Create a new &lt;code&gt;Game&lt;/code&gt; and persist it.
     *
     * @param gameDTO the &lt;code&gt;Game&lt;/code&gt; data
     * @return the game
     */</span>
    Game newGame(GameDTO gameDTO) {
        log.debug(<span class="string"><span class="delimiter">'</span><span class="content">New game {}, black: {}, white: {}</span><span class="delimiter">'</span></span>,
                gameDTO.id, gameDTO.blackName, gameDTO.whiteName)
        Game game = <span class="keyword">new</span> Game(<span class="predefined-type">UUID</span>.fromString(gameDTO.id), gameDTO.blackName, gameDTO.whiteName)
        gameRepository.save game
    }

    <span class="comment">/**
     * Persist a game move as a &lt;code&gt;GameState&lt;/code&gt;.
     *
     * @param gameStateDTO the &lt;code&gt;GameState&lt;/code&gt; data
     */</span>
    <span class="type">void</span> newGameState(GameStateDTO gameStateDTO) {
        Game game = findGame(gameStateDTO.gameId)
        GameState gameState = <span class="keyword">new</span> GameState(
                <span class="predefined-type">UUID</span>.fromString(gameStateDTO.id), game,
                gameStateDTO.player, gameStateDTO.move,
                gameStateDTO.fen, gameStateDTO.pgn)
        gameStateRepository.save gameState
    }

    <span class="comment">/**
     * Record that a game ended in checkmate.
     *
     * @param gameDTO the &lt;code&gt;Game&lt;/code&gt; data
     */</span>
    <span class="type">void</span> checkmate(GameDTO gameDTO) {
        log.debug(<span class="string"><span class="delimiter">'</span><span class="content">Game {} ended with winner: {}</span><span class="delimiter">'</span></span>,
                gameDTO.id, gameDTO.winner)
        Game game = findGame(gameDTO.id)
        game.winner = gameDTO.winner
        gameRepository.update game
    }

    <span class="comment">/**
     * Record that a game ended in a draw.
     *
     * @param gameDTO the &lt;code&gt;Game&lt;/code&gt; data
     */</span>
    <span class="type">void</span> draw(GameDTO gameDTO) {
        log.debug(<span class="string"><span class="delimiter">'</span><span class="content">Game {} ended in a draw</span><span class="delimiter">'</span></span>, gameDTO.id)
        Game game = findGame(gameDTO.id)
        game.draw = <span class="predefined-constant">true</span>
        gameRepository.update game
    }

    <span class="annotation">@NonNull</span>
    <span class="directive">private</span> Game findGame(<span class="predefined-type">String</span> gameId) {
        gameRepository.findById(<span class="predefined-type">UUID</span>.fromString(gameId)).orElseThrow(() -&gt;
                <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Game with id '</span><span class="delimiter">&quot;</span></span> + gameId + <span class="string"><span class="delimiter">&quot;</span><span class="content">' not found</span><span class="delimiter">&quot;</span></span>))
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="chesslistener">4.2.6. ChessListener</h4>
<div class="paragraph">
<p>Create <code>ChessListener</code> Kafka listener to receive messages sent from the <code>chess-game</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/groovy/example/micronaut/chess/ChessListener.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut.chess

<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.GameDTO</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.GameStateDTO</span>
<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.configuration.kafka.annotation.KafkaListener</span>
<span class="keyword">import</span> <span class="include">io.micronaut.configuration.kafka.annotation.Topic</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.configuration.kafka.annotation.OffsetReset.EARLIEST</span>

<span class="annotation">@KafkaListener</span>(offsetReset = EARLIEST) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">ChessListener</span> {

    <span class="directive">private</span> <span class="directive">final</span> GameService gameService

    ChessListener(GameService gameService) { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="local-variable">this</span>.gameService = gameService
    }

    <span class="annotation">@Topic</span>(<span class="string"><span class="delimiter">'</span><span class="content">chessGame</span><span class="delimiter">'</span></span>) <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="type">void</span> onGame(GameDTO gameDTO) {
        <span class="keyword">if</span> (gameDTO.draw) {
            gameService.draw gameDTO <i class="conum" data-value="4"></i><b>(4)</b>
        } <span class="keyword">else</span> <span class="keyword">if</span> (gameDTO.winner) {
            gameService.checkmate gameDTO <i class="conum" data-value="5"></i><b>(5)</b>
        } <span class="keyword">else</span> {
            gameService.newGame gameDTO <i class="conum" data-value="6"></i><b>(6)</b>
        }
    }

    <span class="annotation">@Topic</span>(<span class="string"><span class="delimiter">'</span><span class="content">chessGameState</span><span class="delimiter">'</span></span>) <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="type">void</span> onGameState(GameStateDTO gameState) {
        gameService.newGameState gameState <i class="conum" data-value="7"></i><b>(7)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@KafkaListener</code> to declare it as a Kafka message listener; the Micronaut framework will generate the receiving code at compile time</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Dependency injection for <code>GameService</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Annotate the method with <code>@Topic</code> and specify the topic name</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use <code>GameService</code> to record that the game ended in a draw</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Use <code>GameService</code> to record that the game ended in checkmate</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Use <code>GameService</code> to record that a new game has started</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Use <code>GameService</code> to record that a new game move occurred</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="development-environment-2">4.2.7. Development environment</h4>
<div class="paragraph">
<p>Modify the <code>Application</code> class to use <code>dev</code> as a default environment:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The Micronaut framework supports the concept of one or many default environments. A default environment is one that is only applied if no other environments are explicitly specified or deduced.</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/groovy/example/micronaut/Application.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.runtime.Micronaut</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.context.env.Environment.DEVELOPMENT</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">Application</span> {

    <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        Micronaut.build(args)
                .mainClass(Application)
                .defaultEnvironments(DEVELOPMENT)
                .start()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/application-dev.yml</code>. The Micronaut framework applies this configuration file only for the <code>dev</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/resources/application-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">server</span>:
    <span class="key">port</span>: <span class="string"><span class="content">8081 </span></span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="key">datasources</span>:
  <span class="key">default</span>:
    <span class="key">url</span>: <span class="string"><span class="content">jdbc:h2:mem:devDb;MVCC=TRUE;LOCK_TIMEOUT=10000;DB_CLOSE_ON_EXIT=FALSE </span></span><i class="conum" data-value="2"></i><b>(2)</b>
    <span class="key">driverClassName</span>: <span class="string"><span class="content">org.h2.Driver</span></span>
    <span class="key">username</span>: <span class="string"><span class="content">sa</span></span>
    <span class="key">password</span>: <span class="string"><span class="content">''</span></span>
    <span class="key">schema-generate</span>: <span class="string"><span class="content">none</span></span>
    <span class="key">dialect</span>: <span class="string"><span class="content">H2</span></span>

<span class="key">kafka</span>:
  <span class="key">bootstrap</span>:
    <span class="key">servers</span>: <span class="string"><span class="content">localhost:9092 </span></span><i class="conum" data-value="3"></i><b>(3)</b>

<span class="key">flyway</span>:
  <span class="key">datasources</span>:
    <span class="key">default</span>:
      <span class="key">locations</span>:
        - <span class="string"><span class="content">classpath:db/migration/h2 </span></span><i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Run this microservice on port 8081; <code>chess-game</code> will run on the default port 8080</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use an in-memory H2 database. Delete the <code>datasources</code> block so it&#8217;s only in <code>application-dev.yml</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use local Kafka. Delete the <code>kafka.bootstrap.servers</code> property so it&#8217;s only in <code>application-dev.yml</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configure Flyway to look for migration scripts in <code>src/main/resources/db/migration/h2</code></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="h2-flyway-migration-script">4.2.8. H2 Flyway Migration Script</h4>
<div class="paragraph">
<p>Create a database migration script to create the database tables:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/resources/db/migration/h2/V1__create-schema.sql</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> game (
    id <span class="predefined-type">CHAR</span>(<span class="integer">36</span>) <span class="directive">PRIMARY</span> <span class="type">KEY</span>,
    black_name <span class="predefined-type">VARCHAR</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    white_name <span class="predefined-type">VARCHAR</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    date_created <span class="predefined-type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    date_updated <span class="predefined-type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    draw <span class="predefined-type">BOOLEAN</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    winner <span class="predefined-type">CHAR</span>(<span class="integer">1</span>)
);

<span class="class">CREATE</span> <span class="type">TABLE</span> game_state (
    id <span class="predefined-type">CHAR</span>(<span class="integer">36</span>) <span class="directive">PRIMARY</span> <span class="type">KEY</span>,
    game_id <span class="predefined-type">CHAR</span>(<span class="integer">36</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    date_created <span class="predefined-type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    player <span class="predefined-type">CHAR</span>(<span class="integer">1</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    fen <span class="predefined-type">VARCHAR</span>(<span class="integer">100</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    pgn CLOB <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    move <span class="predefined-type">VARCHAR</span>(<span class="integer">10</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    <span class="type">CONSTRAINT</span> fk_game_state_game <span class="directive">FOREIGN</span> <span class="type">KEY</span> (game_id) <span class="keyword">REFERENCES</span> game(id)
);</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kafka">5. Kafka</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ll use Oracle Cloud Streaming in the "real" application, but for local development, we can use a local Kafka instance.</p>
</div>
<div class="sect2">
<h3 id="install-kafka">5.1. Install Kafka</h3>
<div class="paragraph">
<p>A fast way to start using Kafka is <a href="https://hub.docker.com/r/confluentinc/cp-kafka/">via Docker</a>. Create this <code>docker-compose.yml</code> file:</p>
</div>
<div class="listingblock">
<div class="title">docker/docker-compose.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">version</span>: <span class="string"><span class="content">'2'</span></span>
<span class="key">services</span>:
  <span class="key">zookeeper</span>:
    <span class="key">image</span>: <span class="string"><span class="content">confluentinc/cp-zookeeper</span></span>
    <span class="key">ports</span>:
      - <span class="string"><span class="content">2181:2181 </span></span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="key">environment</span>:
      <span class="key">ZOOKEEPER_CLIENT_PORT</span>: <span class="string"><span class="content">2181</span></span>
      <span class="key">ZOOKEEPER_TICK_TIME</span>: <span class="string"><span class="content">2000</span></span>
  <span class="key">kafka</span>:
    <span class="key">image</span>: <span class="string"><span class="content">confluentinc/cp-kafka</span></span>
    <span class="key">depends_on</span>:
      - <span class="string"><span class="content">zookeeper</span></span>
    <span class="key">ports</span>:
      - <span class="string"><span class="content">9092:9092 </span></span><i class="conum" data-value="2"></i><b>(2)</b>
    <span class="key">environment</span>:
      <span class="key">KAFKA_ZOOKEEPER_CONNECT</span>: <span class="string"><span class="content">zookeeper:2181</span></span>
      <span class="key">KAFKA_ADVERTISED_LISTENERS</span>: <span class="string"><span class="content">PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092</span></span>
      <span class="key">KAFKA_LISTENER_SECURITY_PROTOCOL_MAP</span>: <span class="string"><span class="content">PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT</span></span>
      <span class="key">KAFKA_INTER_BROKER_LISTENER_NAME</span>: <span class="string"><span class="content">PLAINTEXT</span></span>
      <span class="key">KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR</span>: <span class="string"><span class="content">1</span></span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Zookeeper uses port 2181 by default, but change the value if needed</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Kafka uses port 9092 by default, but change the value if needed</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Start Zookeeper and Kafka (use CTRL-C to stop both):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker-compose up</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively you can <a href="https://kafka.apache.org/quickstart">install and run a local Kafka instance</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="running-the-application">6. Running the application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Start the <code>chess-game</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">chess-game</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./gradlew run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>16:35:55.614 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 576ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Start the <code>chess-listener</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./gradlew run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>16:35:55.614 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 623ms. Server Running: http://localhost:8081</code></pre>
</div>
</div>
<div class="paragraph">
<p>Test the app functionality by opening <a href="http://localhost:8080/" class="bare">http://localhost:8080/</a> in a browser. The UI lets you choose one or more chess games that will auto-play with the specified delay between plays. Events (game start and end, player moves) are sent to the server via Ajax and then sent to the <code>chess-listener</code> microservice for processing, analysis, etc.</p>
</div>
<div class="paragraph">
<p>You can, for example, start a single game with a moderately large delay between plays:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/ui1.png" alt="ui1">
</div>
</div>
<div class="paragraph">
<p>A single board is displayed:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/ui2.png" alt="ui2">
</div>
</div>
<div class="paragraph">
<p>Or you can start multiple games with a short delay (or any combination you want):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/ui3.png" alt="ui3">
</div>
</div>
<div class="paragraph">
<p>Multiple simultaneous boards are displayed:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/ui4.png" alt="ui4">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="moving-to-oracle-cloud">7. Moving to Oracle Cloud</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="oracle-autonomous-database-atp">7.1. Oracle Autonomous Database (ATP)</h3>
<div class="paragraph">
<p>Update the <code>chess-listener</code> microservice to support Oracle in addition to the in-memory H2 database.</p>
</div>
<div class="paragraph">
<p>Use the <a href="micronaut-oracle-autonomous-db.html">Oracle Autonomous Database guide</a> to provision an Oracle database at OCI.</p>
</div>
<div class="sect3">
<h4 id="dependencies">7.1.1. Dependencies</h4>
<div class="paragraph">
<p>Add the <code>micronaut-oraclecloud-atp</code> dependency to the <code>chess-listener</code> microservice to support using ATP:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">implementation(<span class="string"><span class="delimiter">&quot;</span><span class="content">io.micronaut.oraclecloud:micronaut-oraclecloud-atp</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration">7.1.2. Configuration</h4>
<div class="paragraph">
<p>Create <code>src/main/resources/application-oraclecloud.yml</code>. The Micronaut framework applies this configuration file only for the <code>oraclecloud</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/resources/application-oraclecloud.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">datasources</span>:
  <span class="key">default</span>:
    <span class="key">ocid</span>: <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="key">walletPassword</span>: <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="key">username</span>: <span class="string"><span class="content">micronautdemo</span></span>
    <span class="key">password</span>: <i class="conum" data-value="3"></i><b>(3)</b>

<span class="key">oci</span>:
  <span class="key">config</span>:
    <span class="key">profile</span>: <span class="string"><span class="content">DEFAULT </span></span><i class="conum" data-value="4"></i><b>(4)</b>

<span class="key">flyway</span>:
  <span class="key">datasources</span>:
    <span class="key">default</span>:
      <span class="key">locations</span>:
        - <span class="string"><span class="content">classpath:db/migration/oracle </span></span><i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set the value of the <code>ocid</code> property with the database OCID unique identifier you saved when creating the database</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the <code>walletPassword</code> property with a password to encrypt the wallet keys (must be at least 8 characters and include at least 1 letter and either 1 numeric or special character)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Set the <code>password</code> property with the <code>micronautdemo</code> schema user password you created</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Change the profile name if you&#8217;re not using the default, and optionally add a value for the path to the config file if necessary as described in the <a href="https://micronaut-projects.github.io/micronaut-oracle-cloud/latest/guide/#config-auth">Authentication section</a> of the Micronaut Oracle Cloud docs</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Configure Flyway to look for migration scripts in <code>src/main/resources/db/migration/oracle</code></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="repositories-2">7.1.3. Repositories</h4>
<div class="paragraph">
<p>Create the <code>OracleGameRepository</code> interface that extends <code>GameRepository</code> and specifies the <code>ORACLE</code> dialect in the <code>oraclecloud</code> environment:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/groovy/example/micronaut/chess/repository/OracleGameRepository.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut.chess.repository

<span class="keyword">import</span> <span class="include">io.micronaut.context.annotation.Primary</span>
<span class="keyword">import</span> <span class="include">io.micronaut.context.annotation.Requires</span>
<span class="keyword">import</span> <span class="include">io.micronaut.data.jdbc.annotation.JdbcRepository</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.context.env.Environment.ORACLE_CLOUD</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.context.env.Environment.TEST</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.data.model.query.builder.sql.Dialect.ORACLE</span>

<span class="annotation">@Primary</span>
<span class="annotation">@JdbcRepository</span>(dialect = ORACLE) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Requires</span>(env = [ORACLE_CLOUD, TEST]) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="type">interface</span> OracleGameRepository <span class="directive">extends</span> GameRepository {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate with <code>@JdbcRepository</code> to make this a Micronaut Data JDBC repository, and specify the <code>ORACLE</code> dialect. The Micronaut framework will generate persistence logic at compile time and use Oracle-specific SQL.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Restrict the bean to be available only in the <code>oraclecloud</code> environment</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the <code>OracleGameStateRepository</code> interface that extends <code>GameStateRepository</code>:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/groovy/example/micronaut/chess/repository/OracleGameStateRepository.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut.chess.repository

<span class="keyword">import</span> <span class="include">io.micronaut.context.annotation.Primary</span>
<span class="keyword">import</span> <span class="include">io.micronaut.context.annotation.Requires</span>
<span class="keyword">import</span> <span class="include">io.micronaut.data.jdbc.annotation.JdbcRepository</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.context.env.Environment.ORACLE_CLOUD</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.context.env.Environment.TEST</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.data.model.query.builder.sql.Dialect.ORACLE</span>

<span class="annotation">@Primary</span>
<span class="annotation">@JdbcRepository</span>(dialect = ORACLE)
<span class="annotation">@Requires</span>(env = [ORACLE_CLOUD, TEST])
<span class="type">interface</span> OracleGameStateRepository <span class="directive">extends</span> GameStateRepository {
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="flyway-2">7.1.4. Flyway</h4>
<div class="paragraph">
<p>Create a database migration script to create the Oracle database tables:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/main/resources/db/migration/oracle/V1__create-schema.sql</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">CREATE</span> <span class="type">TABLE</span> game (
    id <span class="predefined-type">CHAR</span>(<span class="integer">36</span>) <span class="directive">PRIMARY</span> <span class="type">KEY</span>,
    black_name <span class="predefined-type">VARCHAR2</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    white_name <span class="predefined-type">VARCHAR2</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    date_created <span class="predefined-type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    date_updated <span class="predefined-type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    draw NUMBER(<span class="integer">3</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    winner <span class="predefined-type">CHAR</span>(<span class="integer">1</span>)
);

<span class="class">CREATE</span> <span class="type">TABLE</span> game_state (
    id <span class="predefined-type">CHAR</span>(<span class="integer">36</span>) <span class="directive">PRIMARY</span> <span class="type">KEY</span>,
    game_id <span class="predefined-type">CHAR</span>(<span class="integer">36</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    date_created <span class="predefined-type">TIMESTAMP</span> <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    player <span class="predefined-type">CHAR</span>(<span class="integer">1</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    fen <span class="predefined-type">VARCHAR2</span>(<span class="integer">100</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    pgn CLOB <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    move <span class="predefined-type">VARCHAR2</span>(<span class="integer">10</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,
    <span class="type">CONSTRAINT</span> fk_game_state_game <span class="directive">FOREIGN</span> <span class="type">KEY</span> (game_id) <span class="keyword">REFERENCES</span> game(id)
);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="oracle-cloud-streaming">7.2. Oracle Cloud Streaming</h3>
<div class="paragraph">
<p>Up to now, we&#8217;ve been using a local Kafka, but let&#8217;s configure the equivalent infrastructure in OCI. This will involve minimal application changes thanks to the ability to send and receive Cloud Streaming messages using Kafka APIs, and <a href="https://micronaut-projects.github.io/micronaut-kafka/latest/guide/">Micronaut support for Kafka</a>.</p>
</div>
<div class="sect3">
<h4 id="stream-pool-and-streams">7.2.1. Stream Pool and Streams</h4>
<div class="paragraph">
<p>Log in to your Oracle Cloud tenancy and from the Oracle Cloud Menu, select "Analytics &amp; AI" and then "Streaming":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/create.stream.1.png" alt="create.stream.1">
</div>
</div>
<div class="paragraph">
<p>Choose the compartment to create the streams in, then click "Create Stream Pool":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/create.stream.2.png" alt="create.stream.2">
</div>
</div>
<div class="paragraph">
<p>Enter a name for the pool, e.g., "mn-guide-pool", and click "Create":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/create.stream.3.png" alt="create.stream.3">
</div>
</div>
<div class="paragraph">
<p>Click the "Copy" link in the <code>OCID</code> row and save the value for later. Also save the "FQDN" URL. Click "Create Stream":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/create.stream.4.png" alt="create.stream.4">
</div>
</div>
<div class="paragraph">
<p>Create two streams within the pool you created with the Topic names used in the microservices. First create "chessGame":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/create.stream.5.png" alt="create.stream.5">
</div>
</div>
<div class="paragraph">
<p>and then create "chessGameState":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/create.stream.6.png" alt="create.stream.6">
</div>
</div>
</div>
<div class="sect3">
<h4 id="user-and-group">7.2.2. User and Group</h4>
<div class="paragraph">
<p>Create a group for the streams by clicking the Oracle Cloud menu and selecting "Identity &amp; Security" and then click "Groups":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user1.png" alt="user1">
</div>
</div>
<div class="paragraph">
<p>Click "Create Group":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user2.png" alt="user2">
</div>
</div>
<div class="paragraph">
<p>Choose a name and a description, e.g., "mn-guide-streaming-group", and click "Create":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user3.png" alt="user3">
</div>
</div>
<div class="paragraph">
<p>Create a user by clicking the Oracle Cloud menu and selecting "Identity &amp; Security" and then click "Users":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user4.png" alt="user4">
</div>
</div>
<div class="paragraph">
<p>Click "Create User":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user5.png" alt="user5">
</div>
</div>
<div class="paragraph">
<p>Choose a name and a description, e.g., "mn-guide-streaming-user", and click "Create":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user6.png" alt="user6">
</div>
</div>
<div class="paragraph">
<p>Scroll down and click "Add User to Group":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user7.png" alt="user7">
</div>
</div>
<div class="paragraph">
<p>Select the group you created and click "Add":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user8.png" alt="user8">
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll need an auth token to use as the password in the Micronaut Kafka configuration. Click "Auth Tokens" and then "Generate Token":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user9.png" alt="user9">
</div>
</div>
<div class="paragraph">
<p>Enter a name for the token, e.g., "mn-guide-streaming", and click "Generate Token":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user10.png" alt="user10">
</div>
</div>
<div class="paragraph">
<p>Copy the token to the clipboard and save it for later:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/user11.png" alt="user11">
</div>
</div>
<div class="paragraph">
<p>See the <a href="https://docs.oracle.com/en-us/iaas/Content/Functions/Tasks/functionscreatinggroupsusers.htm">Groups and Users docs</a> for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="policy">7.2.3. Policy</h4>
<div class="paragraph">
<p>Create a policy to grant various Streams access to the user and group you created.</p>
</div>
<div class="paragraph">
<p>Open the Oracle Cloud Menu and click "Identity &amp; Security" and then "Policies":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/policy1.png" alt="policy1">
</div>
</div>
<div class="paragraph">
<p>Select the compartment where you created the streams from the dropdown and click "Create Policy":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/policy2.png" alt="policy2">
</div>
</div>
<div class="paragraph">
<p>Choose a name and description, e.g., "mn-guide-streaming-policy", and click "Show Manual Editor". Copy the following and paste it into the "Policy Builder" field, replacing "micronaut-guides" with the name of the compartment you&#8217;re using, and click "Create":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/policy3.png" alt="policy3">
</div>
</div>
</div>
<div class="sect3">
<h4 id="application-configuration">7.2.4. Application configuration</h4>
<div class="paragraph">
<p>Create <code>src/main/resources/application-oraclecloud.yml</code> in the <code>chess-game</code> microservice. Add the following there, and also add it to the <code>application-oraclecloud.yml</code> you already created in the <code>chess-listener</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/main/resources/application-oraclecloud.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">kafka</span>:
  <span class="key">bootstrap</span>:
    <span class="key">servers</span>: <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">security</span>:
    <span class="key">protocol</span>: <span class="string"><span class="content">SASL_SSL</span></span>
  <span class="key">sasl</span>:
    <span class="key">mechanism</span>: <span class="string"><span class="content">PLAIN</span></span>
    <span class="key">jaas</span>:
      <span class="key">config</span>:  <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="key">retries</span>: <span class="string"><span class="content">3</span></span>
  <span class="key">max</span>:
    <span class="key">request</span>:
      <span class="key">size</span>: <span class="string"><span class="content">1048576 </span></span><i class="conum" data-value="3"></i><b>(3)</b>
    <span class="key">partition</span>:
      <span class="key">fetch</span>:
        <span class="key">bytes</span>: <span class="string"><span class="content">1048576 </span></span><i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the "FQDN" URL value you saved earlier here, along with the Kafka port (9092), e.g., <code>cell-1.streaming.us-ashburn-1.oci.oraclecloud.com:9092</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use the value <code>config: org.apache.kafka.common.security.plain.PlainLoginModule required username="&lt;tenancy-name&gt;/&lt;username&gt;/&lt;stream-pool-ocid&gt;" password="&lt;auth-token&gt;";</code>, replacing <code>&lt;tenancy-name&gt;</code> with the name of your tenancy, <code>&lt;username&gt;</code> with the username created above, <code>&lt;stream-pool-ocid&gt;</code> with the OCID of the stream pool you saved earlier, and <code>&lt;auth-token&gt;</code> with the auth token value you saved earlier.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Limit request size to 1MB</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Limit request size to 1MB per partition</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="local-testing-with-cloud-resources">8. Local Testing with Cloud Resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can now start both microservices in the <code>oraclecloud</code> environment to use Cloud Streaming and the ATP database you created:</p>
</div>
<div class="paragraph">
<p>To run each application use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">MICRONAUT_ENVIRONMENTS=oraclecloud ./gradlew run</code></pre>
</div>
</div>
<div class="paragraph">
<p>or if you use Windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">cmd /C &quot;set MICRONAUT_ENVIRONMENTS=oraclecloud &amp;&amp; gradlew run&quot;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-tests">9. Writing Tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ll run Kafka inside a Docker container using <a href="https://www.testcontainers.org/">Testcontainers</a> for both application tests and also run Oracle database inside a Docker container for testing persistence in the <code>chess-listener</code> tests.</p>
</div>
<div class="sect2">
<h3 id="chess-game-tests">9.1. chess-game tests</h3>
<div class="paragraph">
<p>Create a test in the <code>chess-game</code> microservice to verify that Kafka message processing works:</p>
</div>
<div class="listingblock">
<div class="title">chess-game/src/test/groovy/example/micronaut/GameReporterSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.Player</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.GameDTO</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.GameStateDTO</span>
<span class="keyword">import</span> <span class="include">io.micronaut.configuration.kafka.annotation.KafkaListener</span>
<span class="keyword">import</span> <span class="include">io.micronaut.configuration.kafka.annotation.Topic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.type.Argument</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpRequest</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.HttpClient</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.annotation.Client</span>
<span class="keyword">import</span> <span class="include">io.micronaut.test.extensions.spock.annotation.MicronautTest</span>
<span class="keyword">import</span> <span class="include">io.micronaut.test.support.TestPropertyProvider</span>
<span class="keyword">import</span> <span class="include">org.testcontainers.containers.KafkaContainer</span>
<span class="keyword">import</span> <span class="include">org.testcontainers.utility.DockerImageName</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>
<span class="keyword">import</span> <span class="include">spock.util.concurrent.PollingConditions</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.uri.UriBuilder</span>
<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>
<span class="keyword">import</span> <span class="include">java.util.concurrent.ConcurrentLinkedDeque</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.configuration.kafka.annotation.OffsetReset.EARLIEST</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.http.MediaType.APPLICATION_FORM_URLENCODED_TYPE</span>

<span class="annotation">@MicronautTest</span>  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="type">class</span> <span class="class">GameReporterSpec</span> <span class="directive">extends</span> Specification <span class="directive">implements</span> TestPropertyProvider { <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Collection</span>&lt;GameDTO&gt; receivedGames = <span class="keyword">new</span> ConcurrentLinkedDeque&lt;&gt;()
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Collection</span>&lt;GameStateDTO&gt; receivedMoves = <span class="keyword">new</span> ConcurrentLinkedDeque&lt;&gt;()

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> PollingConditions pollingConditions = <span class="keyword">new</span> PollingConditions(<span class="key">timeout</span>: <span class="integer">5</span>)

    <span class="directive">static</span> KafkaContainer kafka = <span class="keyword">new</span> KafkaContainer(
            DockerImageName.parse(<span class="string"><span class="delimiter">'</span><span class="content">confluentinc/cp-kafka:latest</span><span class="delimiter">'</span></span>)) <i class="conum" data-value="4"></i><b>(4)</b>

    <span class="annotation">@Inject</span>
    ChessListener chessListener <i class="conum" data-value="5"></i><b>(5)</b>

    <span class="annotation">@Inject</span>
    <span class="annotation">@Client</span>(<span class="string"><span class="delimiter">'</span><span class="content">/</span><span class="delimiter">'</span></span>)
    HttpClient client <i class="conum" data-value="6"></i><b>(6)</b>

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test game ending in checkmate</span><span class="delimiter">'</span></span>() {

        <span class="key">given</span>:
        <span class="predefined-type">String</span> blackName = <span class="string"><span class="delimiter">'</span><span class="content">b_name</span><span class="delimiter">'</span></span>
        <span class="predefined-type">String</span> whiteName = <span class="string"><span class="delimiter">'</span><span class="content">w_name</span><span class="delimiter">'</span></span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">start game</span><span class="delimiter">'</span></span>
        Optional&lt;<span class="predefined-type">String</span>&gt; result = startGame(blackName, whiteName)
        <span class="predefined-type">String</span> gameId = result.orElseThrow(() -&gt; <span class="keyword">new</span> <span class="exception">RuntimeException</span>(<span class="string"><span class="delimiter">'</span><span class="content">Expected GameDTO id</span><span class="delimiter">'</span></span>))

        <span class="key">then</span>:
        pollingConditions.eventually { <i class="conum" data-value="7"></i><b>(7)</b>
            !receivedGames.empty
        }

        <span class="integer">1</span> == receivedGames.size()
        <span class="integer">0</span> == receivedMoves.size()

        <span class="key">when</span>:
        GameDTO game = receivedGames[<span class="integer">0</span>]

        <span class="key">then</span>:
        gameId == game.id
        blackName == game.blackName
        whiteName == game.whiteName
        !game.draw
        !game.winner

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">make moves</span><span class="delimiter">'</span></span>
        receivedGames.clear()

        makeMove(gameId, Player.WHITE, <span class="string"><span class="delimiter">'</span><span class="content">f3</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">rnbqkbnr/pppppppp/8/8/8/5P2/PPPPP1PP/RNBQKBNR b KQkq - 0 1</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1. f3</span><span class="delimiter">'</span></span>)
        makeMove(gameId, Player.BLACK, <span class="string"><span class="delimiter">'</span><span class="content">e6</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">rnbqkbnr/pppp1ppp/4p3/8/8/5P2/PPPPP1PP/RNBQKBNR w KQkq - 0 2</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1. f3 e6</span><span class="delimiter">'</span></span>)
        makeMove(gameId, Player.WHITE, <span class="string"><span class="delimiter">'</span><span class="content">g4</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">rnbqkbnr/pppp1ppp/4p3/8/6P1/5P2/PPPPP2P/RNBQKBNR b KQkq g3 0 2</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1. f3 e6 2. g4</span><span class="delimiter">'</span></span>)
        makeMove(gameId, Player.BLACK, <span class="string"><span class="delimiter">'</span><span class="content">Qh4#</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">rnb1kbnr/pppp1ppp/4p3/8/6Pq/5P2/PPPPP2P/RNBQKBNR w KQkq - 1 3</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1. f3 e6 2. g4 Qh4#</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>:
        pollingConditions.eventually {
            receivedMoves.size() &gt; <span class="integer">3</span>
        }

        <span class="integer">0</span> == receivedGames.size()
        <span class="integer">4</span> == receivedMoves.size()

        <span class="key">when</span>:
        <span class="predefined-type">List</span>&lt;GameStateDTO&gt; moves = <span class="keyword">new</span> <span class="predefined-type">ArrayList</span>&lt;&gt;(receivedMoves)

        <span class="key">then</span>:
        Player.WHITE == moves[<span class="integer">0</span>].player
        <span class="string"><span class="delimiter">'</span><span class="content">f3</span><span class="delimiter">'</span></span> == moves[<span class="integer">0</span>].move

        Player.BLACK == moves[<span class="integer">1</span>].player
        <span class="string"><span class="delimiter">'</span><span class="content">e6</span><span class="delimiter">'</span></span> == moves[<span class="integer">1</span>].move

        Player.WHITE == moves[<span class="integer">2</span>].player
        <span class="string"><span class="delimiter">'</span><span class="content">g4</span><span class="delimiter">'</span></span> == moves[<span class="integer">2</span>].move

        Player.BLACK == moves[<span class="integer">3</span>].player
        <span class="string"><span class="delimiter">'</span><span class="content">Qh4#</span><span class="delimiter">'</span></span> == moves[<span class="integer">3</span>].move

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">end game</span><span class="delimiter">'</span></span>

        receivedMoves.clear()

        endGame(gameId, Player.BLACK)

        <span class="key">then</span>:
        pollingConditions.eventually {
            !receivedGames.empty
        }

        <span class="integer">1</span> == receivedGames.size()
        <span class="integer">0</span> == receivedMoves.size()

        <span class="key">when</span>:
        game = receivedGames[<span class="integer">0</span>]

        <span class="key">then</span>:
        gameId == game.id
        !game.blackName
        !game.whiteName
        !game.draw
        Player.BLACK == game.winner
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test game ending in draw</span><span class="delimiter">'</span></span>() {

        <span class="key">given</span>:
        <span class="predefined-type">String</span> blackName = <span class="string"><span class="delimiter">'</span><span class="content">b_name</span><span class="delimiter">'</span></span>
        <span class="predefined-type">String</span> whiteName = <span class="string"><span class="delimiter">'</span><span class="content">w_name</span><span class="delimiter">'</span></span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">start game</span><span class="delimiter">'</span></span>
        Optional&lt;<span class="predefined-type">String</span>&gt; result = startGame(blackName, whiteName)
        <span class="predefined-type">String</span> gameId = result.orElseThrow(() -&gt; <span class="keyword">new</span> <span class="exception">RuntimeException</span>(<span class="string"><span class="delimiter">'</span><span class="content">Expected GameDTO id</span><span class="delimiter">'</span></span>))

        <span class="key">then</span>:
        pollingConditions.eventually {
            !receivedGames.empty
        }

        <span class="integer">1</span> == receivedGames.size()
        <span class="integer">0</span> == receivedMoves.size()

        <span class="key">when</span>:
        GameDTO game = receivedGames[<span class="integer">0</span>]

        <span class="key">then</span>:
        gameId == game.id
        blackName == game.blackName
        whiteName == game.whiteName
        !game.draw
        !game.winner

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">make moves</span><span class="delimiter">'</span></span>
        receivedGames.clear()

        makeMove(gameId, Player.WHITE, <span class="string"><span class="delimiter">'</span><span class="content">f3</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">rnbqkbnr/pppppppp/8/8/8/5P2/PPPPP1PP/RNBQKBNR b KQkq - 0 1</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1. f3</span><span class="delimiter">'</span></span>)
        makeMove(gameId, Player.BLACK, <span class="string"><span class="delimiter">'</span><span class="content">e6</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">rnbqkbnr/pppp1ppp/4p3/8/8/5P2/PPPPP1PP/RNBQKBNR w KQkq - 0 2</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1. f3</span><span class="delimiter">'</span></span> +
                <span class="string"><span class="delimiter">'</span><span class="content">Player</span><span class="delimiter">'</span></span>)

        <span class="key">then</span>:
        pollingConditions.eventually {
            receivedMoves.size() &gt; <span class="integer">1</span>
        }

        <span class="integer">0</span> == receivedGames.size()
        <span class="integer">2</span> == receivedMoves.size()

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">end game</span><span class="delimiter">'</span></span>
        receivedMoves.clear()
        endGame(gameId, <span class="predefined-constant">null</span>)

        <span class="key">then</span>:
        <span class="keyword">new</span> PollingConditions().eventually {
            !receivedGames.empty
        }

        <span class="integer">1</span> == receivedGames.size()
        <span class="integer">0</span> == receivedMoves.size()

        <span class="key">when</span>:
        game = receivedGames[<span class="integer">0</span>]

        <span class="key">then</span>:
        gameId == game.id
        !game.blackName
        !game.whiteName
        game.draw
        !game.winner
        Player
    }


    <span class="annotation">@Override</span>
    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; getProperties() {
        kafka.start()
        [<span class="string"><span class="delimiter">'</span><span class="content">kafka.bootstrap.servers</span><span class="delimiter">'</span></span>: kafka.bootstrapServers] <i class="conum" data-value="8"></i><b>(8)</b>
    }

    <span class="type">void</span> cleanup() {
        receivedGames.clear()
        receivedMoves.clear()
    }

    <span class="annotation">@KafkaListener</span>(offsetReset = EARLIEST)
    <span class="directive">static</span> <span class="type">class</span> <span class="class">ChessListener</span> {

        <span class="annotation">@Topic</span>(<span class="string"><span class="delimiter">'</span><span class="content">chessGame</span><span class="delimiter">'</span></span>)
        <span class="type">void</span> onGame(GameDTO game) {
            receivedGames &lt;&lt; game
        }

        <span class="annotation">@Topic</span>(<span class="string"><span class="delimiter">'</span><span class="content">chessGameState</span><span class="delimiter">'</span></span>)
        <span class="type">void</span> onGameState(GameStateDTO gameState) {
            receivedMoves &lt;&lt; gameState
        }
    }

    <span class="directive">private</span> Optional&lt;<span class="predefined-type">String</span>&gt; startGame(<span class="predefined-type">String</span> blackName, <span class="predefined-type">String</span> whiteName) {
        <span class="predefined-type">Map</span> body = [<span class="key">b</span>: blackName, <span class="key">w</span>: whiteName] <i class="conum" data-value="9"></i><b>(9)</b>

        HttpRequest&lt;?&gt; request = HttpRequest.POST(<span class="string"><span class="delimiter">'</span><span class="content">/game/start</span><span class="delimiter">'</span></span>, body)
                .contentType(APPLICATION_FORM_URLENCODED_TYPE)
        <span class="keyword">return</span> client.toBlocking().retrieve(request,
                Argument.of(Optional, <span class="predefined-type">String</span>)) <i class="conum" data-value="10"></i><b>(10)</b>
    }

    <span class="directive">private</span> <span class="type">void</span> makeMove(<span class="predefined-type">String</span> gameId,
                          Player player,
                          <span class="predefined-type">String</span> move,
                          <span class="predefined-type">String</span> fen, <span class="predefined-type">String</span> pgn) {
        <span class="predefined-type">Map</span> body = [<span class="key">player</span>: player, <span class="key">move</span>: move, <span class="key">fen</span>: fen, <span class="key">pgn</span>: pgn]

        HttpRequest&lt;?&gt; request = HttpRequest.POST(<span class="string"><span class="delimiter">'</span><span class="content">/game/move/</span><span class="delimiter">'</span></span> + gameId, body)
                .contentType(APPLICATION_FORM_URLENCODED_TYPE)
        client.toBlocking().exchange(request) <i class="conum" data-value="11"></i><b>(11)</b>
    }

    <span class="directive">private</span> <span class="type">void</span> endGame(<span class="predefined-type">String</span> gameId, Player winner) {
        UriBuilder uriBuilder = UriBuilder.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">/game</span><span class="delimiter">&quot;</span></span>).path(winner == <span class="predefined-constant">null</span> ? <span class="string"><span class="delimiter">&quot;</span><span class="content">draw</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">checkmate</span><span class="delimiter">&quot;</span></span>).path(gameId)
        <span class="keyword">if</span> (winner != <span class="predefined-constant">null</span>) {
            uriBuilder = uriBuilder.path(winner.toString())
        }
        <span class="predefined-type">URI</span> uri = uriBuilder.build()
        HttpRequest&lt;<span class="predefined-type">Object</span>&gt; request = HttpRequest.POST(uri, <span class="predefined-constant">null</span>)
        client.toBlocking().exchange(request) <i class="conum" data-value="12"></i><b>(12)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <code>@Testcontainers</code> annotation to configure automatic container management (not necessary in Spock tests)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Classes that implement <code>TestPropertyProvider</code> must use this annotation to create a single class instance for all tests (not necessary in Spock tests).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Implementing <code>TestPropertyProvider</code> allows the test class to provide application configuration properties, in this case the dynamically allocated Kafka broker port</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The Testcontainer instance for Kafka</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Dependency injection for the <code>ChessListener</code> class declared below, a Kafka listener class that replicates the functionality of the class of the same name in the <code>chess-listener</code> microservice</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Dependency injection for an HTTP client that the Micronaut framework will implement at compile to make calls to <code>GameController</code></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Wait a few seconds for the message to arrive; it should happen very quickly, but the message will be sent on a separate thread</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Configure the Kafka broker port (it will be different unused port each time) so Micronaut Kafka clients and listeners connect to the test broker</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Use a Map to hold form parameter names and values</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Use the <code>HttpClient</code> to send a POST request that indicates a game has started, which will trigger sending a message with Kafka</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Use the <code>HttpClient</code> to send a POST request that indicates a game move has occurred, which will trigger sending a message with Kafka</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Use the <code>HttpClient</code> to send a POST request that indicates a game has ended (in either a draw or checkmate), which will trigger sending a message with Kafka</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="chess-listener-tests">9.2. chess-listener tests</h3>
<div class="paragraph">
<p>Create a test in the <code>chess-listener</code> microservice to verify that Kafka message processing and database persistence works:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/test/groovy/example/micronaut/GameServiceSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.Player</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.GameDTO</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.dto.GameStateDTO</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.entity.Game</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.entity.GameState</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.repository.GameRepository</span>
<span class="keyword">import</span> <span class="include">example.micronaut.chess.repository.GameStateRepository</span>
<span class="keyword">import</span> <span class="include">io.micronaut.configuration.kafka.annotation.KafkaClient</span>
<span class="keyword">import</span> <span class="include">io.micronaut.configuration.kafka.annotation.KafkaKey</span>
<span class="keyword">import</span> <span class="include">io.micronaut.configuration.kafka.annotation.Topic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.test.extensions.spock.annotation.MicronautTest</span>
<span class="keyword">import</span> <span class="include">io.micronaut.test.support.TestPropertyProvider</span>
<span class="keyword">import</span> <span class="include">org.testcontainers.containers.KafkaContainer</span>
<span class="keyword">import</span> <span class="include">org.testcontainers.utility.DockerImageName</span>
<span class="keyword">import</span> <span class="include">reactor.core.publisher.Mono</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>
<span class="keyword">import</span> <span class="include">spock.util.concurrent.PollingConditions</span>

<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>

<span class="annotation">@MicronautTest</span>  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="type">class</span> <span class="class">GameServiceSpec</span> <span class="directive">extends</span> Specification <span class="directive">implements</span> TestPropertyProvider { <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> PollingConditions pollingConditions = <span class="keyword">new</span> PollingConditions(<span class="key">timeout</span>: <span class="integer">30</span>)

    <span class="directive">static</span> KafkaContainer kafka = <span class="keyword">new</span> KafkaContainer(
            DockerImageName.parse(<span class="string"><span class="delimiter">'</span><span class="content">confluentinc/cp-kafka:latest</span><span class="delimiter">'</span></span>)) <i class="conum" data-value="4"></i><b>(4)</b>

    <span class="annotation">@Inject</span>
    GameReporter gameReporter <i class="conum" data-value="5"></i><b>(5)</b>

    <span class="annotation">@Inject</span>
    GameRepository gameRepository

    <span class="annotation">@Inject</span>
    GameStateRepository gameStateRepository

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test game ending in checkmate</span><span class="delimiter">'</span></span>() {
        <span class="key">given</span>:
        <span class="predefined-type">String</span> blackName = <span class="string"><span class="delimiter">'</span><span class="content">b_name</span><span class="delimiter">'</span></span>
        <span class="predefined-type">String</span> whiteName = <span class="string"><span class="delimiter">'</span><span class="content">w_name</span><span class="delimiter">'</span></span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">start game</span><span class="delimiter">'</span></span>

        <span class="predefined-type">UUID</span> gameId = <span class="predefined-type">UUID</span>.randomUUID()
        <span class="predefined-type">String</span> gameIdString = gameId
        GameDTO gameDto = <span class="keyword">new</span> GameDTO(gameIdString, blackName, whiteName)

        gameReporter.game(gameIdString, gameDto).subscribe()

        <span class="key">then</span>:
        pollingConditions.eventually { <i class="conum" data-value="6"></i><b>(6)</b>
            gameRepository.count() &gt; <span class="integer">0</span>
        }

        <span class="integer">1</span> == gameRepository.count()
        <span class="integer">0</span> == gameStateRepository.count()

        <span class="key">when</span>:
        Game game = gameRepository.findById(gameId).orElseThrow(() -&gt;
                <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">'</span><span class="content">Unable to find expected Game</span><span class="delimiter">'</span></span>))

        <span class="key">then</span>:
        gameId == game.id
        blackName == game.blackName
        whiteName == game.whiteName
        !game.draw
        !game.winner

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">make moves</span><span class="delimiter">'</span></span>

        <span class="predefined-type">List</span>&lt;<span class="predefined-type">UUID</span>&gt; gameStateIds = <span class="type">[]</span>

        <span class="predefined-type">UUID</span> gameStateId = makeMove(gameIdString, Player.WHITE, <span class="string"><span class="delimiter">'</span><span class="content">f3</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">rnbqkbnr/pppppppp/8/8/8/5P2/PPPPP1PP/RNBQKBNR b KQkq - 0 1</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1. f3</span><span class="delimiter">'</span></span>)
        gameStateIds &lt;&lt; gameStateId

        gameStateId = makeMove(gameIdString, Player.BLACK, <span class="string"><span class="delimiter">'</span><span class="content">e6</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">rnbqkbnr/pppp1ppp/4p3/8/8/5P2/PPPPP1PP/RNBQKBNR w KQkq - 0 2</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1. f3 e6</span><span class="delimiter">'</span></span>)
        gameStateIds &lt;&lt; gameStateId

        gameStateId = makeMove(gameIdString, Player.WHITE, <span class="string"><span class="delimiter">'</span><span class="content">g4</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">rnbqkbnr/pppp1ppp/4p3/8/6P1/5P2/PPPPP2P/RNBQKBNR b KQkq g3 0 2</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1. f3 e6 2. g4</span><span class="delimiter">'</span></span>)
        gameStateIds &lt;&lt; gameStateId

        gameStateId = makeMove(gameIdString, Player.BLACK, <span class="string"><span class="delimiter">'</span><span class="content">Qh4#</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">rnb1kbnr/pppp1ppp/4p3/8/6Pq/5P2/PPPPP2P/RNBQKBNR w KQkq - 1 3</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1. f3 e6 2. g4 Qh4#</span><span class="delimiter">'</span></span>)
        gameStateIds &lt;&lt; gameStateId

        <span class="key">then</span>:
        pollingConditions.eventually {
            gameStateRepository.count() &gt; <span class="integer">3</span>
        }

        <span class="integer">1</span> == gameRepository.count()
        <span class="integer">4</span> == gameStateRepository.count()

        <span class="key">when</span>:
        <span class="predefined-type">List</span>&lt;GameState&gt; moves = gameStateIds.collect { <span class="predefined-type">UUID</span> id -&gt; gameStateRepository.findById(id).orElse(<span class="predefined-constant">null</span>) }

        <span class="key">then</span>:
        Player.WHITE == moves[<span class="integer">0</span>].player
        <span class="string"><span class="delimiter">'</span><span class="content">f3</span><span class="delimiter">'</span></span> == moves[<span class="integer">0</span>].move

        Player.BLACK == moves[<span class="integer">1</span>].player
        <span class="string"><span class="delimiter">'</span><span class="content">e6</span><span class="delimiter">'</span></span> == moves[<span class="integer">1</span>].move

        Player.WHITE == moves[<span class="integer">2</span>].player
        <span class="string"><span class="delimiter">'</span><span class="content">g4</span><span class="delimiter">'</span></span> == moves[<span class="integer">2</span>].move

        Player.BLACK == moves[<span class="integer">3</span>].player
        <span class="string"><span class="delimiter">'</span><span class="content">Qh4#</span><span class="delimiter">'</span></span> == moves[<span class="integer">3</span>].move

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">end game</span><span class="delimiter">'</span></span>

        gameDto = <span class="keyword">new</span> GameDTO(gameIdString, <span class="predefined-constant">false</span>, Player.BLACK)
        gameReporter.game(gameIdString, gameDto).subscribe()

        <span class="key">then</span>:
        pollingConditions.eventually {
            Game g = gameRepository.findById(gameId).orElse(<span class="predefined-constant">null</span>)
            <span class="keyword">if</span> (!g) <span class="keyword">return</span> <span class="predefined-constant">false</span>
            g.winner
        }

        <span class="integer">1</span> == gameRepository.count()
        <span class="integer">4</span> == gameStateRepository.count()

        <span class="key">when</span>:
        game = gameRepository.findById(gameId).orElseThrow(() -&gt;
                <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">'</span><span class="content">Unable to find expected Game</span><span class="delimiter">'</span></span>))

        <span class="key">then</span>:
        gameId == game.id
        blackName == game.blackName
        whiteName == game.whiteName
        !game.draw
        Player.BLACK == game.winner
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">'</span><span class="content">test game ending in draw</span><span class="delimiter">'</span></span>() {
        <span class="key">given</span>:
        <span class="predefined-type">String</span> blackName = <span class="string"><span class="delimiter">'</span><span class="content">b_name</span><span class="delimiter">'</span></span>
        <span class="predefined-type">String</span> whiteName = <span class="string"><span class="delimiter">'</span><span class="content">w_name</span><span class="delimiter">'</span></span>

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">start game</span><span class="delimiter">'</span></span>

        <span class="predefined-type">UUID</span> gameId = <span class="predefined-type">UUID</span>.randomUUID()
        <span class="predefined-type">String</span> gameIdString = gameId
        GameDTO gameDto = <span class="keyword">new</span> GameDTO(gameIdString, blackName, whiteName)

        gameReporter.game(gameIdString, gameDto).subscribe()

        <span class="key">then</span>:
        pollingConditions.eventually { <i class="conum" data-value="6"></i><b>(6)</b>
            gameRepository.count() &gt; <span class="integer">0</span>
        }

        <span class="integer">1</span> == gameRepository.count()
        <span class="integer">0</span> == gameStateRepository.count()

        <span class="key">when</span>:
        Game game = gameRepository.findById(gameId).orElseThrow(() -&gt;
                <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">'</span><span class="content">Unable to find expected Game</span><span class="delimiter">'</span></span>))

        <span class="key">then</span>:
        gameId == game.id
        blackName == game.blackName
        whiteName == game.whiteName
        !game.draw
        !game.winner

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">make moves</span><span class="delimiter">'</span></span>

        <span class="predefined-type">List</span>&lt;<span class="predefined-type">UUID</span>&gt; gameStateIds = <span class="type">[]</span>

        <span class="predefined-type">UUID</span> gameStateId = makeMove(gameIdString, Player.WHITE, <span class="string"><span class="delimiter">'</span><span class="content">f3</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">rnbqkbnr/pppppppp/8/8/8/5P2/PPPPP1PP/RNBQKBNR b KQkq - 0 1</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1. f3</span><span class="delimiter">'</span></span>)
        gameStateIds &lt;&lt; gameStateId

        gameStateId = makeMove(gameIdString, Player.BLACK, <span class="string"><span class="delimiter">'</span><span class="content">e6</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">rnbqkbnr/pppp1ppp/4p3/8/8/5P2/PPPPP1PP/RNBQKBNR w KQkq - 0 2</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">1. f3 e6</span><span class="delimiter">'</span></span>)
        gameStateIds &lt;&lt; gameStateId

        <span class="key">then</span>:
        pollingConditions.eventually {
            gameStateRepository.count() &gt; <span class="integer">1</span>
        }

        <span class="integer">1</span> == gameRepository.count()
        <span class="integer">2</span> == gameStateRepository.count()

        <span class="key">when</span>:
        <span class="predefined-type">List</span>&lt;GameState&gt; moves = <span class="type">[]</span>
        <span class="keyword">for</span> (<span class="predefined-type">UUID</span> id : gameStateIds) {
            moves &lt;&lt; gameStateRepository.findById(id).orElseThrow(() -&gt;
                    <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">'</span><span class="content">Unable to find expected GameState</span><span class="delimiter">'</span></span>))
        }

        <span class="key">then</span>:
        Player.WHITE == moves[<span class="integer">0</span>].player
        <span class="string"><span class="delimiter">'</span><span class="content">f3</span><span class="delimiter">'</span></span> == moves[<span class="integer">0</span>].move

        Player.BLACK == moves[<span class="integer">1</span>].player
        <span class="string"><span class="delimiter">'</span><span class="content">e6</span><span class="delimiter">'</span></span> == moves[<span class="integer">1</span>].move

        <span class="key">when</span>: <span class="string"><span class="delimiter">'</span><span class="content">end game</span><span class="delimiter">'</span></span>

        gameDto = <span class="keyword">new</span> GameDTO(gameIdString, <span class="predefined-constant">true</span>, <span class="predefined-constant">null</span>)
        gameReporter.game(gameIdString, gameDto).subscribe()

        <span class="key">then</span>:
        pollingConditions.eventually {
            Game g = gameRepository.findById(gameId).orElse(<span class="predefined-constant">null</span>)
            <span class="keyword">if</span> (!g) <span class="keyword">return</span> <span class="predefined-constant">false</span>
            g.draw
        }

        <span class="integer">1</span> == gameRepository.count()
        <span class="integer">2</span> == gameStateRepository.count()

        <span class="key">when</span>:
        game = gameRepository.findById(gameId).orElseThrow(() -&gt;
                <span class="keyword">new</span> <span class="exception">IllegalStateException</span>(<span class="string"><span class="delimiter">'</span><span class="content">Unable to find expected Game</span><span class="delimiter">'</span></span>))

        <span class="key">then</span>:
        gameId == game.id
        blackName == game.blackName
        whiteName == game.whiteName
        game.draw
        !game.winner
    }

    <span class="annotation">@Override</span>
    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; getProperties() {
        kafka.start()
        [<span class="string"><span class="delimiter">'</span><span class="content">kafka.bootstrap.servers</span><span class="delimiter">'</span></span>: kafka.bootstrapServers] <i class="conum" data-value="7"></i><b>(7)</b>
    }

    <span class="type">void</span> cleanup() {
        gameStateRepository.deleteAll()
        gameRepository.deleteAll()
    }

    <span class="annotation">@KafkaClient</span>
    <span class="directive">static</span> <span class="type">interface</span> GameReporter {

        <span class="annotation">@Topic</span>(<span class="string"><span class="delimiter">'</span><span class="content">chessGame</span><span class="delimiter">'</span></span>)
        Mono&lt;GameDTO&gt; game(<span class="annotation">@KafkaKey</span> <span class="predefined-type">String</span> gameId, GameDTO game)

        <span class="annotation">@Topic</span>(<span class="string"><span class="delimiter">'</span><span class="content">chessGameState</span><span class="delimiter">'</span></span>)
        Mono&lt;GameStateDTO&gt; gameState(<span class="annotation">@KafkaKey</span> <span class="predefined-type">String</span> gameId, GameStateDTO gameState)
    }

    <span class="directive">private</span> <span class="predefined-type">UUID</span> makeMove(<span class="predefined-type">String</span> gameId,
                          Player player,
                          <span class="predefined-type">String</span> move,
                          <span class="predefined-type">String</span> fen,
                          <span class="predefined-type">String</span> pgn) {
        <span class="predefined-type">UUID</span> gameStateId = <span class="predefined-type">UUID</span>.randomUUID()
        gameReporter.gameState(gameId, <span class="keyword">new</span> GameStateDTO(gameStateId.toString(),
                gameId, player, move, fen, pgn)).subscribe()
        gameStateId
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the <code>@Testcontainers</code> annotation to configure automatic container management (not necessary in Spock tests)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Classes that implement <code>TestPropertyProvider</code> must use this annotation to create a single class instance for all tests (not necessary in Spock tests).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Implementing <code>TestPropertyProvider</code> allows the test class to provide application configuration properties, in this case the dynamically allocated Kafka broker port</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The Testcontainer instance for Kafka</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Dependency injection for the <code>GameReporter</code> interface declared below, a Kafka producer interface that replicates the functionality of the class of the same name in the <code>chess-game</code> microservice</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Wait a few seconds for the message to arrive; it should happen very quickly, but the message will be sent on a separate thread</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Configure the Kafka broker port (it will be different unused port each time) so Micronaut Kafka clients and listeners connect to the test broker</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create <code>testcontainers.properties</code> in <code>src/test/resources</code> with this content:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/test/resources/testcontainers.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">oracle.container.image=registry.gitlab.com/micronaut-projects/micronaut-graal-tests/oracle-database:18.4.0-xe</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create <code>application-test.yml</code> file in <code>src/test/resources</code> with this content:</p>
</div>
<div class="listingblock">
<div class="title">chess-listener/src/test/resources/application-test.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">datasources</span>:
  <span class="key">default</span>:
    <span class="key">url</span>: <span class="string"><span class="content">jdbc:tc:oracle:thin:@/xe</span></span>
    <span class="key">driverClassName</span>: <span class="string"><span class="content">org.testcontainers.jdbc.ContainerDatabaseDriver</span></span>
    <span class="key">username</span>: <span class="string"><span class="content">system</span></span>
    <span class="key">password</span>: <span class="string"><span class="content">oracle</span></span>
<span class="key">flyway</span>:
  <span class="key">datasources</span>:
    <span class="key">default</span>:
      <span class="key">locations</span>: <span class="string"><span class="content">classpath:db/migration/oracle</span></span>
      <span class="key">baseline-version</span>: <span class="string"><span class="content">0</span></span>
      <span class="key">baseline-on-migrate</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="running-the-tests">9.3. Running the tests</h3>
<div class="paragraph">
<p>To run the tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./gradlew test</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then open <code>build/reports/tests/test/index.html</code> in a browser to see the results.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-to-oci">10. Deploy to OCI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you&#8217;ve verified that the microservices work with the configured cloud resources, you can deploy the microservices to Compute instances and run everything in Oracle Cloud.</p>
</div>
<div class="paragraph">
<p>Follow the steps in <a href="micronaut-oracle-cloud.html">this guide</a> for each service.</p>
</div>
<div class="sect2">
<h3 id="instance-principal-authentication">10.1. Instance Principal authentication</h3>
<div class="paragraph">
<p>The current configuration in <code>application-oraclecloud.yml</code> works when running locally using OCI resources (ATP database and Cloud Streams) but won&#8217;t work when deploying the application because it doesn&#8217;t make sense to install the Oracle Cloud CLI in Compute instances. Instead, we&#8217;ll use <a href="https://micronaut-projects.github.io/micronaut-oracle-cloud/latest/guide/#instance-principals">Instance Principal authentication</a>.</p>
</div>
<div class="paragraph">
<p>To use this, we need to update the config, create a dynamic group, and add policy statements granting permissions.</p>
</div>
<div class="sect3">
<h4 id="dynamic-group">10.1.1. Dynamic Group</h4>
<div class="paragraph">
<p>Create a Dynamic Group by clicking the Oracle Cloud menu and selecting "Identity &amp; Security" and then click "Dynamic Groups":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/dynamicgroup1.png" alt="dynamicgroup1">
</div>
</div>
<div class="paragraph">
<p>Click "Create Dynamic Group":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/dynamicgroup2.png" alt="dynamicgroup2">
</div>
</div>
<div class="paragraph">
<p>Then enter a name and description for the group, e.g., "mn-streaming-guide-dg", and a matching rule, i.e., the logic that will be used to determine group membership. We&#8217;ll make the rule fairly broad - enter <code>ALL {instance.compartment.id = 'ocid1.compartment.oc1..aaaaaxxxxx'}</code> replacing <code>ocid1.compartment.oc1..aaaaaxxxxx</code> with the compartment OCID where you&#8217;re creating your Compute instances and click "Create":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/dynamicgroup3.png" alt="dynamicgroup3">
</div>
</div>
<div class="paragraph">
<p>See the <a href="https://docs.oracle.com/en-us/iaas/Content/Identity/Tasks/managingdynamicgroups.htm">Dynamic Group docs</a> for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="dynamic-group-policy-statements">10.1.2. Dynamic Group Policy Statements</h4>
<div class="paragraph">
<p>Edit the policy you created earlier and add three new policies: one to grant access to Autonomous Database, one to allow sending stream messages, and one to allow receiving stream messages:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/oraclecloudstream/policy4.png" alt="policy4">
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuration-2">10.1.3. Configuration</h4>
<div class="paragraph">
<p>Edit <code>application-oraclecloud.yml</code> in the <code>chess-listener</code> microservice and replace</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">oci</span>:
  <span class="key">config</span>:
    <span class="key">profile</span>: <span class="string"><span class="content">DEFAULT</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">oci</span>:
  <span class="key">config</span>:
    <span class="key">instance-principal</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="next-steps">11. Next steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Read more about <a href="https://micronaut-projects.github.io/micronaut-kafka/latest/guide/">Kafka support</a> in the Micronaut framework.</p>
</div>
<div class="paragraph">
<p>Also see <a href="micronaut-kafka.html">this guide on the Micronaut framework + Kafka</a>.</p>
</div>

            </div>
        </div>
    </div>
</main>

<footer id="footer">
    <div class="container">

        <div class="row">
            <div class="col-sm-5 footer-left">

                <div id="text-14" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <img class="alignnone size-medium wp-image-3736" src="./images/micronaut_foundation_horizontal_white.svg" alt="Micronaut Foundation"/>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-sm-7 footer-right">

                <ul class="meta">

                    <li id="menu-item-2895" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2895">
                        <a href="https://micronaut.io/brand-guidelines/">Brand Guidelines</a>
                    </li>
                    <li id="menu-item-2894" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2894">
                        <a href="https://micronaut.io/community-guidelines/">Community Guidelines</a>
                    </li>
                    <li id="menu-item-3377" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-privacy-policy menu-item-3377">
                        <a href="https://micronaut.io/privacy-policy/">Privacy Policy</a>
                    </li>

                </ul>

                <div id="nav_menu-2" class="widget widget_nav_menu">
                    <div class="menu-links-container">
                        <ul id="menu-links" class="menu">
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronautpodcast.com"><i class="fa fa-podcast"><span class="sr-only">Podcast</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronaut.io/feed/rss/"><i class="fa fa-feed"><span class="sr-only">Feed</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="mailto:info@micronaut.io"><i class="fas fa-envelope"><span class="sr-only">Mail</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://twitter.com/micronautfw"><i class="fab fa-twitter"><span class="sr-only">Twitter</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://matrix.to/#/#micronautfw_questions:gitter.im"><i class="fab fa-gitter"><span class="sr-only">Gitter</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://github.com/micronaut-projects/"><i class="fab fa-github"><span class="sr-only">GitHub</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.youtube.com/@MicronautFramework"><i class="fab fa-youtube"><span class="sr-only">YouTube</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.linkedin.com/showcase/micronaut"><i class="fab fa-linkedin"><span class="sr-only">LinkedIn</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.twitch.tv/micronautfw"><i class="fab fa-twitch"><span class="sr-only">Twitch</span></i></a></li>
                        </ul>
                    </div>
                </div>
                <div id="text-5" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <small>© 2023 MICRONAUT FOUNDATION. ALL RIGHTS RESERVED</small>
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</footer>
</body>
</html>
