common:header.adoc[]

common:requirements.adoc[]

common:completesolution.adoc[]

common:create-app.adoc[]

== Discovery Client

To add the Micronaut Discovery Client to your project, add the following dependency:

dependency:micronaut-discovery-client[groupId=io.micronaut.discovery]

== OAuth 2.0 Dependency

This guide demonstrates configuring OAuth 2.0 integration, so add the following dependency:

dependency:micronaut-security-oauth2[groupId=io.micronaut.security]

== Bootstrap.yml

To enable distributed configuration, create a `src/main/resources/bootstrap.yml` configuration file:

resource:bootstrap.yml[]

<1> We need to set the application name in `bootstrap.yml` instead of `application.yml` so that it is available when reading configuration from distributed sources.
<2> You need to enable `micronaut.config-client.enabled`.
<3> You need to enable the vault config client.
<4> Set the Hashicorp Vault token to access the service.
<5> Set the Hashicorp Vault uri.

== Create Secret

OAuth 2.0 clients have a client id and secret property.
We will save both in Hashicorp Vault.

The client will search for secrets in the following paths:

- `application`
- `application/ENV` (i.e. `application/dev`)
- `APPNAME` (i.e. `micronautguide` as in the bootstrap for this guide)
- `APPNAME/ENV` (i.e. `micronautguide/dev`)

It is also possible to use a custom prefix for the path, but this isn't covered in this guide.

So we have named configuration, we want to set the configuration via the key `micronaut.security.oauth2.clients.companyauthserver.client-id` which we will then be able to access via the name `companyauthserver`.

So, using `micronautguide` as the path, create a Secret in Hashicorp Vault with two key/value pairs:

image::hashicorp-vault-secrets.png[]

== Controller

Create a controller which exposes the value read from AWS Secrets Manager.

source:ClientIdController[]

<1> Specify the name so we get the expected configuration from Hashicorp Vault.

== Logs

Add the following configuration to `src/main/resources/logback.xml` to get a more verbose output when the application starts up:

[source, xml]
----
<logger name="io.micronaut.aws.distributedconfiguration" level="TRACE"/>
----

common:runapp.adoc[]

You should see traces such as:

[source]
----
11:33:07.365 [main] INFO  i.m.context.DefaultBeanContext - Reading bootstrap environment configuration
11:33:07.554 [main] DEBUG i.m.d.v.c.VaultConfigurationClient - Vault server endpoint: http://localhost:8200, secret engine version: V2, secret-engine-name: secret, vault keys path prefix:
11:33:07.554 [main] DEBUG i.m.d.v.c.VaultConfigurationClient - Application name: micronautguide, application profiles: [dev]
11:33:07.900 [main] INFO  i.m.d.c.c.DistributedPropertySourceLocator - Resolved 1 configuration sources from client: compositeConfigurationClient(vault-config-client-v2)
11:33:08.009 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 880ms. Server Running: http://localhost:8080
----

[source, bash]
----
curl localhost:8080
----

[source]
----
secret-client-id
----

common:graal-with-plugins.adoc[]

:exclude-for-languages:groovy

[source, bash]
----
curl localhost:8080
----

[source]
----
secret-client-id
----

:exclude-for-languages:

== Tests

Add a simple test to check that a Hashicorp Vault service with the required secrets does configure the `OauthClientConfiguration` bean successfully:

test:VaultSecretTest[]

common:next.adoc[]

Learn more about https://docs.micronaut.io/latest/guide/index.html#distributedConfiguration[Micronaut Distributed Configuration].

Read about https://www.vaultproject.io/[Hashicorp Vault]

common:helpWithMicronaut.adoc[]
