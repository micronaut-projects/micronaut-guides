= @guideTitle@

@guideIntro@

Authors: @authors@

Micronaut Version: @micronaut@

include::{commondir}/common-gettingStarted.adoc[]

include::{commondir}/common-requirements.adoc[]

include::{commondir}/common-completesolution.adoc[]

== Writing the App

include::{commondir}/common-cli-or-launch.adoc[]

[source,bash]
----
mn create-function-app example.micronaut.micronautguide --features=aws-lambda --build=@build@ --lang=@lang@
----

include::{commondir}/common-build-lang-arguments.adoc[]

If you use https://launch.micronaut.io[Micronaut Launch], select serverless function as application type and add `aws-lambda` feature.

include::{commondir}/common-default-package.adoc[]

include::{commondir}/common-annotationprocessors.adoc[]

include::{commondir}/common-function-delete-sample-code.adoc[]

== Code

=== JSON Web Key Generation

Create an interface to encapsulate the contract to generate a https://datatracker.ietf.org/doc/html/rfc7517[JWK (JSON Web Key)]

source:JsonWebKeyGenerator[]

To generate a JWK, use https://connect2id.com/products/nimbus-jose-jwt[Nimbus JOSE + JWT], an open source Java library to generate JSON Web Tokens (JWT).

Add the following dependency:

dependency:nimbus-jose-jwt[groupId=com.nimbusds,version=@nimbus-jose-jwtVersion@]

Create an implementation of `JsonWebKeyGenerator`

source:RS256JsonWebKeyGenerator[]

<1> Annotate the class with `@Singleton` to register it in the application context.


=== Micronaut AWS Secrets manager dependency

Add the next dependency:

dependency:micronaut-aws-secretsmanager[groupId=io.micronaut.aws,version=@micronaut-aws-secretsmanagerVersion@]

=== Rotation Steps

AWS Secrets Manager define https://docs.aws.amazon.com/secretsmanager/latest/userguide/rotating-secrets-lambda-function-overview.html[several steps] to allow for different rotation scenarios.

Create an enum to encapsulate those steps:

source:SecretsManagerRotationStep[]

=== Handler

Add the following dependency to subscribe to `SecretsManagerRotationEvent`:

dependency:aws-lambda-java-events[groupId=com.amazonaws,version=@aws-lambda-java-eventsVersion@]

Create a Handler which leverage Micronaut's DI engine to inject its collaborators.

source:Handler[]

<1> Use `SecretsManagerRotationEvent` as input.
<2> Inject `JsonWebKeyGenerator` to generate the new JWK
<3> Inject the Jackson Object Mapper to serialize the secret value as a JSON String.
<4> Use `SecretsManagerClient` to push a new secret's value.
<5> Use `KeyValueFetcher` to fetch the current secret contents.

== Lambda

Create a Lambda Function. As a runtime, select Java 11 (Correto).

image::create-function.png[]

=== IAM Role Policies

Add a Policy to the IAM role associated with the Lambda function:

[source, json]
----
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "secretsmanager:GetSecretValue",
                "secretsmanager:DescribeSecret",
                "secretsmanager:PutSecretValue",
                "secretsmanager:UpdateSecretVersionStage"
            ],
            "Resource": "*",
            "Condition": {
                "StringEquals": {
                    "secretsmanager:resource/AllowRotationLambdaArn": "XXXXXX"
                }
            }
        },
        {
            "Sid": "VisualEditor1",
            "Effect": "Allow",
            "Action": "secretsmanager:GetRandomPassword",
            "Resource": "*"
        }
    ]
}
----


=== Resource Based policy

In Lambda (Configuration -> Permissions) add resource-based policy such as:

image::secrets-manager-lambda-invoke-function.png[]

=== Upload Code

include::{commondir}/common-executable-jar.adoc[]

Upload it:

image::upload-function-code.png[]

=== Handler

As Handler, set:

`example.micronaut.Handler`

image::example-micronaut-handler.png[]

You can trigger a rotation immediately within the AWS Console:

image::rotate-secret-immediately.png[]

The lambda function is invoked four times. One per step. Your secret's should rotate successfully.

include::{commondir}/common-next.adoc[]

include::{commondir}/common-helpWithMicronaut.adoc[]