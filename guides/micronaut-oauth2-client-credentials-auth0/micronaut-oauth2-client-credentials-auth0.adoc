include::{commondir}/common-header.adoc[]

include::{commondir}/common-requirements.adoc[]

include::{commondir}/common-completesolution.adoc[]

== Application Diagram

Download the complete solution of the https://guides.micronaut.io/latest/micronaut-microservices-services-discover-consul-@build@-@lang@.html[Consul and Micronaut Framework - Microservices service discovery] guide. You will use the sample app as a starting point. The application contains three microservices:

* `bookcatalogue` - It returns a list of books. It uses a domain consisting of a book name and ISBN.

* `bookinventory` - It exposes an endpoint to check whether a book has sufficient stock to fulfil an order. It uses a domain consisting of a stock level and ISBN.

* `bookrecommendation` - It consumes previous services and exposes and endpoint which recommends book names which are in stock.

The `bookcatalogue` service consumes endpoints exposed by the other services. The following image illustrates the original application flow:

image::flow.svg[]

A request to `bookrecommendation` (`http://localhost:8080/books[http://localhost:8080/books^]`) triggers several requests through our microservices mesh.

In this guide, you are going to secure the communication between the Microservices. You will use client credentials flow and obtain an access token from an Auth0 authorization server. 

image::flow-client-credentials-auth0.svg[]

== OAuth 2.0

To provide authentication, sign in to your https://auth0.com[Auth0] account.

Create an Application

image::auth0-create-application.png[]

You can obtain the application's domain, client id and secret in the Auth0 console. 

image::auth0-clientid-clientsecret.png[]

Go to `Applications -> APIs` and copy the API Audience:

image::auth0-applications-apis.png[]

In the API Settings, authorize the application in the _Machine to Machine Applications_ tab:

image::auth0-machine-to-machine-applications.png[]

== Writing the application

include::{commondir}/common-annotationprocessors.adoc[]

=== Dependencies

Modify every application (`bookinventory`, `bookinventory` and `bookrecommendation`). Add https://micronaut-projects.github.io/micronaut-security/latest/guide/index.html#jwt[Micronaut JWT] and https://micronaut-projects.github.io/micronaut-security/latest/guide/#oauth[Micronaut OAuth 2.0] dependencies: 

:dependencies:

dependency:micronaut-security-oauth2[groupId=io.micronaut.security]
dependency:micronaut-security-jwt[groupId=io.micronaut.security]

:dependencies:

=== Changes to Book Inventory Service

Annotate the Controller's method with `@Secured`:

source:BooksController[app=bookinventory]

callout:secured-is-authenticated[number=1]

To validate the tokens issued by Auth0, configure https://micronaut-projects.github.io/micronaut-security/latest/guide/#jwks[Validation with remote JKWS]:

resource:application.yml[app=bookinventory,tag=oauth2]

You can obtain the JWKS url in the https://micronautguides.eu.auth0.com/.well-known/openid-configuration[`.well-known/openid-configuration`] endpoint.

=== Changes to Book Catalogue Service

Annotate the Controller's method with `@Secured`:

source:BooksController[app=bookcatalogue]

callout:secured-is-authenticated[number=1]

To validate the tokens issued by Auth0, configure https://micronaut-projects.github.io/micronaut-security/latest/guide/#jwks[Validation with remote JKWS]:

resource:application.yml[app=bookcatalogue,tag=oauth2]

You can obtain the JWKS url in the https://micronautguides.eu.auth0.com/.well-known/openid-configuration[`.well-known/openid-configuration`] endpoint.

=== Changes to Book Recommendations Service

==== Books Controller Security

The `GET /books` in the `booksrecommendation` service is open.

Annotate the Controller's method with `@Secured`:

source:BooksController[app=bookrecommendation]

callout:secured-anonymous[number=1]

==== Configuration of HTTP Services URLs

Modify `application-dev.yml` to point the declarative HTTP Clients to the other microservices urls.  


resource:application-dev.yml[app=bookrecommendation,tag=httpservices]

=== Configuration

Add the following OAuth2 Configuration:

resource:application.yml[app=bookrecommendation,tag=oauth2]

callout:oauth2-client-name[number=1,arg0=auth0]
<2> Client ID. See previous screenshot.
<3> Client Secret. See previous screenshot.
<4> Specify https://micronaut-projects.github.io/micronaut-security/latest/api/index.html[GrantType#CLIENT_CREDENTIALS]`client-credentials` as grant type for this OAuth 2.0 client.
<5> Specify the token endpoint URL. `issuer` URL. You can obtain the token endpoint url in the https://micronautguides.eu.auth0.com/.well-known/openid-configuration[`.well-known/openid-configuration`].
<6> Specify https://micronaut-projects.github.io/micronaut-security/latest/api/index.html[AuthenticationMethod#CLIENT_SECRET_POST] as the authentication method. It means the client id and client secret are specified in the body of the HTTP Request sent to the token endpoint.
<7> Propagate the access token obtained from Auth0 to requests sent to the services `bookinventory` and `bookcatalogue`. It uses the https://micronaut-projects.github.io/micronaut-security/latest/api/index.html[Client Credentials HTTP Client Filter].

The previous configuration uses several placeholders with default values. You will need to setup `OAUTH_CLIENT_ID`, `OAUTH_CLIENT_SECRET` and `OAUTH_TOKEN_URL` environment variables of your Auth0 application.

[soruce, bash]
----
export OAUTH_CLIENT_ID=XXXXXXXXXX
export OAUTH_CLIENT_SECRET=YYYYYYYYYY
export OAUTH_TOKEN_URL=https://micronautguides.eu.auth0.com/oauth/token
----

==== Auth0 API Identifier as Audience in Token Request

https://auth0.com/docs/authorization/flows/call-your-api-using-the-client-credentials-flow[Auth0 requires the API Identifier with an audience key in the token endpoint request] for the Client Credentials Flow.

Set the api configuration via Configuration:

resource:application.yml[tag=auth0,app=bookrecommendation]

Create an interface to fetch configuration value: 

source:Auth0Configuration[app=bookrecommendation]

callout:configuration-properties[number=1]

==== ClientCredentialsClient replacement

To include the `audience` key in the request, replace the bean of type `ClientCredentialsClient` qualified by a Name qualifier with value `auth0`. Use a common pattern in Micronaut Applications. I like to call it Extend, Replace Override. You extend from a class the framework ships, you annotate it with `@Replaces` and you override a method to fulfil your application needs.

source:Auth0ClientCredentials[app=bookrecommendation]

callout:at-named[number=1]
<2> https://docs.micronaut.io/latest/guide/#replaces[Replace] the bean of type `ClientCrdentialsClient`
callout:singleton[number=3]
<4> Extend from the class you need to modify its behaviour slightly. 
<5> `auth0` matches the value in `application.yml` which you used to configure the OAuth 2.0 client. 
<6> Retrieve the API Key identifier, you set in configuration

include::{commondir}/common-runapp.adoc[]

image::auth0video.gif[]

include::{commondir}/common-graal-with-plugins.adoc[]

:exclude-for-languages:groovy

After you execute the native image, navigate to localhost:8080 and authenticate with Auth0.

:exclude-for-languages:

== Next steps

Read https://micronaut-projects.github.io/micronaut-security/latest/guide/#oauth[Micronaut OAuth 2.0 documentation] to learn more.

include::{commondir}/common-helpWithMicronaut.adoc[]
