common:header.adoc[]

common:requirements.adoc[]

common:requirements-oci.adoc[]

common:completesolution.adoc[]

== Application Diagram

Download the complete solution of the guideLink:micronaut-microservices-services-discover-consul[Consul and Micronaut Framework - Microservices Service Discovery] guide. You will use the sample app as a starting point. The application contains three microservices:

* `bookcatalogue` - Returns a list of books. It uses a domain consisting of a book name and an ISBN.

* `bookinventory` - Exposes an endpoint to check whether a book has sufficient stock to fulfil an order. It uses a domain with a stock level and an ISBN.

* `bookrecommendation` - Uses the other services and exposes an endpoint that recommends book names that are in stock.

The `bookrecommendation` service consumes endpoints exposed by the other services. The following image illustrates the original application flow:

image::flow.svg[]

A request to `bookrecommendation` (`http://localhost:8080/books`) triggers several requests through our microservices mesh.

In this guide, you will secure the communication between the microservices. You will use a client credentials flow and obtain an access token from an `Oracle Cloud Identity Domain` authorization server.

image::flow-client-credentials-oracle-identity-domain.svg[]

== Configure OpenID Connect at Oracle Cloud Infrastructure

You will use the Oracle Cloud console to create an OAuth 2.0 "Confidential Application" to demonstrate using https://datatracker.ietf.org/doc/html/rfc6749#section-4.4[Client Credentials Grant] with MicronautÂ® and Oracle Cloud Infrastructure.

image::oci-identity-domain.png[]

=== Create an OCI Domain

image::oci-create-domain.png[]

Log in to your Oracle Cloud Infrastructure tenancy as an admin (or as a user with sufficient permissions to create users and applications).

In the Oracle Cloud Console, open the navigation menu, click Identity & Security. Under Identity, click Domains.

- Click Create domain.
- Enter a Display name, for example, "micronaut_guide_domain", and a short Description, then select the `Free` Domain type.
- Enter the domain administrator first and last name, and a valid email address. Click Next then Create.
- Open the email sent to the email address you specified and click the link to set the password for the user.

Log in as the domain administrator to verify the password. Then log out and back in as an Oracle Cloud Infrastructure admin.

=== Create an integrated application

- Click **Integrated applications** in the navigation menu.

- Click the button **Add application** to add a new application.

- Select **Confidential Application** and click **Launch workflow**

image::oci-add-integrated-application.png[]

image::oci-confidential-application.png[]

=== Edit Oauth Configuration

image::oci-edit-oauth-configuration.png[]

image::oci-enable-client-credentials.png[]

=== Obtain client id and client secret

You can obtain the application's domain, client id, and secret in the Oracle Cloud Identity Domain console.

image::oci-client-id-client-secret.png[]

=== Activate

Activate the app:

image::oci-integrated-application-activate.png[]

=== Enable Signing Certificate Access

image::oci-edit-domain-settings.png[]

image::oci-access-signing-certificate.png[]

Make the signing certificate available to your application for https://jwt.io/[JSON Web Tokens (JWT)] validation without being authenticated.

- In the Identity domain console, in the **Navigation Drawer**, click **Settings**, and then click **Domain Settings**.

- Check the **Configure client access** to enable clients to access the tenant signing certificate without logging in to Oracle Identity Cloud Service.

- Click **Save changes** to save the domain settings.

If you skip these steps, you will see errors like the following for valid logins because Micronaut Security cannot retrieve the JSON Web Key (JWK) to validate the JWT:

```
JWT signature validation failed for provider [oci]
Exception loading JWK from https://idcs-12bzlaba1124141.identity.oraclecloud.com/admin/v1/SigningCert/jwk
Server returned HTTP response code: 401
```

== Writing the application

https://guides.micronaut.io/latest/micronaut-intellij-idea-ide-setup.html[Setup IntelliJ IDEA to develop Micronaut Applications].

=== Dependencies

Update the build for all three applications (`bookinventory`, `bookinventory`, and `bookrecommendation`); add https://micronaut-projects.github.io/micronaut-security/latest/guide/#jwt[Micronaut JWT] and https://micronaut-projects.github.io/micronaut-security/latest/guide/#oauth[Micronaut OAuth 2.0] dependencies:

:dependencies:

dependency:micronaut-security-oauth2[groupId=io.micronaut.security]
dependency:micronaut-security-jwt[groupId=io.micronaut.security]

:dependencies:

=== Changes to Book Inventory service

Annotate the `stock` method with `@Secured`:

source:BooksController[app=bookinventory]

callout:secured-is-authenticated[]

To validate the tokens issued by Oracle Cloud Identity Domain, configure https://micronaut-projects.github.io/micronaut-security/latest/guide/#jwks[Validation with Remote JWKS]:

common:yaml-dependency.adoc[]

resource:application.yml[app=bookinventory,tag=oauth2]

You can add `/.well-known/openid-configuration` to your Oracle Cloud Identity Domain URL to obtain the OpenID Connect configuration.
For example, if your domain is `\https://idcs-12bzlaba1124141.identity.oraclecloud.com`, you can obtain the OpenID Connect configuration with `\https://idcs-12bzlaba1124141.identity.oraclecloud.com/.well-known/openid-configuration`.
The `jwks_uri` entry contains the URL of the JWKS endpoint.

image::oci-domain-url.png[]

=== Changes to Book Catalogue service

Annotate the `index` method with `@Secured`:

source:BooksController[app=bookcatalogue]

callout:secured-is-authenticated[]

To validate the tokens issued by Oracle Cloud Identity Domain, configure https://micronaut-projects.github.io/micronaut-security/latest/guide/#jwks[Validation with Remote JWKS]:

resource:application.yml[app=bookcatalogue,tag=oauth2]

You can obtain the JWKS URL in the https://idcs-12bzlaba1124141.identity.oraclecloud.com/.well-known/openid-configuration[`.well-known/openid-configuration`] endpoint.

=== Changes to Book Recommendations service

==== Books Controller Security

The `GET /books` endpoint in the `booksrecommendation` service is open.

Annotate the `index` method with `@Secured`:

source:BookController[app=bookrecommendation]

callout:secured-anonymous[]

==== Configuration of HTTP Services URLs

Modify `application-dev.yml` to configure microservice URLs for the declarative HTTP clients:

resource:application-dev.yml[app=bookrecommendation,tag=httpservices]

=== Configuration

Add the following OAuth2 configuration:

resource:application.yml[app=bookrecommendation,tag=oauth2]

<1> OAuth 2.0 client name.
<2> Client id. See previous screenshot.
<3> Client secret. See previous screenshot.
<4> Specify grant type https://micronaut-projects.github.io/micronaut-security/latest/api/[GrantType#CLIENT_CREDENTIALS] `client-credentials` for this client.
<5> Specify the token endpoint URL. You can obtain the token endpoint URL from https://idcs-12bzlaba1124141.identity.oraclecloud.com/.well-known/openid-configuration[`.well-known/openid-configuration`].
<6> Specify authentication method https://micronaut-projects.github.io/micronaut-security/latest/api/[AuthenticationMethod#CLIENT_SECRET_POST]. For this method, the client id and client secret are specified in the body of the HTTP request sent to the token endpoint.
<7> Client Credentials request in Oracle Cloud Identity domain requires you to set a https://docs.oracle.com/en/cloud/paas/identity-cloud/uaids/access-all-resources.html[scope]. Use the most restrictive scope possible.
<8> Propagate the access token obtained from Oracle Cloud Identity Domain to requests sent to the services `bookinventory` and `bookcatalogue`. This uses the https://micronaut-projects.github.io/micronaut-security/latest/api/[Micronaut Client Credentials HTTP Client Filter].

The previous configuration uses several placeholders with default values. You will need to set up `OAUTH_CLIENT_ID`, `OAUTH_CLIENT_SECRET`, and `OAUTH_TOKEN_URL` environment variables in your Oracle Cloud Identity Domain application.

[source, bash]
----
export OAUTH_CLIENT_ID=XXXXXXXXXX
export OAUTH_CLIENT_SECRET=YYYYYYYYYY
export OAUTH_TOKEN_URL=https://idcs-12bzlaba1124141.identity.oraclecloud.com/oauth2/v1/token
----

== Running the Application

=== Run the `bookcatalogue` microservice

:exclude-for-build:maven

To run the application, execute `./gradlew run`.

:exclude-for-build:

:exclude-for-build:gradle

To run the application, execute `./mvnw mn:run`.

:exclude-for-build:

[source,bash]
----
...
14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8081
----

=== Run the `bookinventory` microservice

:exclude-for-build:maven

To run the application, execute `./gradlew run`.

:exclude-for-build:

:exclude-for-build:gradle

To run the application, execute `./mvnw mn:run`.

:exclude-for-build:

[source,bash]
----
...
14:31:13.104 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 506ms. Server Running: http://localhost:8082
----

=== Run the `bookrecommendation` microservice

:exclude-for-build:maven

To run the application, execute `./gradlew run`.

:exclude-for-build:

:exclude-for-build:gradle

To run the application, execute `./mvnw mn:run`.

:exclude-for-build:

[source,bash]
----
...
14:31:57.389 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 523ms. Server Running: http://localhost:8080
----

You can run a cURL command to test the whole application:

[source,bash]
----
curl http://localhost:8080/books
----

[source,json]
----
[{"name":"Building Microservices"}]
----

common:graal-with-plugins.adoc[]

:exclude-for-languages:groovy

Run the native executables and execute a cURL command to test the whole application:

[source,bash]
----
curl http://localhost:8080/books
----

[source, json]
----
[{"name":"Building Microservices"}]
----

:exclude-for-languages:

== Next Steps

Read https://micronaut-projects.github.io/micronaut-security/latest/guide/#oauth[Micronaut OAuth 2.0 Documentation] to learn more.

common:helpWithMicronaut.adoc[]
