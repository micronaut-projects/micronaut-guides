include::{commondir}/common-header.adoc[]

include::{commondir}/common-requirements.adoc[]

* An https://aws.amazon.com/cognito/[Amazon Cognito] account. 

include::{commondir}/common-completesolution.adoc[]

== Application Diagram

Download the complete solution of the https://guides.micronaut.io/latest/micronaut-microservices-services-discover-consul-@build@-@lang@.html[Consul and Micronaut Framework - Microservices service discovery] guide. You will use the sample app as a starting point. The application contains three microservices:

* `bookcatalogue` - It returns a list of books. It uses a domain consisting of a book name and ISBN.

* `bookinventory` - It exposes an endpoint to check whether a book has sufficient stock to fulfil an order. It uses a domain consisting of a stock level and ISBN.

* `bookrecommendation` - It consumes previous services and exposes and endpoint which recommends book names which are in stock.

The `bookcatalogue` service consumes endpoints exposed by the other services. The following image illustrates the original application flow:

image::flow.svg[]

A request to `bookrecommendation` (`http://localhost:8080/books`) triggers several requests through our microservices mesh.

In this guide, you are going to secure the communication between the Microservices. You will use client credentials flow and obtain an access token from an `Amazon Cognito` authorization server. 

image::flow-client-credentials-cognito.svg[]

== OAuth 2.0

include::{commondir}/common-cognito.adoc[]

=== Resource Server

https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pools-define-resource-servers.html[Define a Resource Server for the User Pool]

image::aws-cognito-resource-server.png[]

In the `App Client Settings` define `Client credentails` as the selected OAuth 2.0 flow and check the custom scope which you created in the previous step: 

image::aws-cognito-app-client-settings-client-credentials-custom-scopes.png[]

=== Add a domain

image::aws-cognito-domain.png[]

== Writing the application

include::{commondir}/common-annotationprocessors.adoc[]

=== Dependencies

Modify every application (`bookinventory`, `bookinventory` and `bookrecommendation`). Add https://micronaut-projects.github.io/micronaut-security/latest/guide/index.html#jwt[Micronaut JWT] and https://micronaut-projects.github.io/micronaut-security/latest/guide/#oauth[Micronaut OAuth 2.0] dependencies: 

:dependencies:

dependency:micronaut-security-oauth2[groupId=io.micronaut.security]
dependency:micronaut-security-jwt[groupId=io.micronaut.security]

:dependencies:

=== Changes to Book Inventory Service

Annotate the Controller's method with `@Secured`:

source:BooksController[app=bookinventory]

callout:secured-is-authenticated[number=1]

To validate the tokens issued by Amazon Cognito, configure https://micronaut-projects.github.io/micronaut-security/latest/guide/#jwks[Validation with remote JKWS]:

resource:application.yml[app=bookinventory,tag=oauth2]

You can obtain the JWKS url in the `\https://cognito-idp.${COGNITO_REGION}.amazonaws.com/${COGNITO_POOL_ID}/.well-known/openid-configuration` endpoint.

=== Changes to Book Catalogue Service

Annotate the Controller's method with `@Secured`:

source:BooksController[app=bookcatalogue]

callout:secured-is-authenticated[number=1]

To validate the tokens issued by Cognito, configure https://micronaut-projects.github.io/micronaut-security/latest/guide/#jwks[Validation with remote JKWS]:

resource:application.yml[app=bookcatalogue,tag=oauth2]

You can obtain the JWKS url in the `\https://cognito-idp.${COGNITO_REGION}.amazonaws.com/${COGNITO_POOL_ID}/.well-known/openid-configuration` endpoint.

=== Changes to Book Recommendations Service

==== Books Controller Security

The `GET /books` in the `booksrecommendation` service is open.

Annotate the Controller's method with `@Secured`:

source:BookController[app=bookrecommendation]

callout:secured-anonymous[number=1]

==== Configuration of HTTP Services URLs

Modify `application-dev.yml` to point the declarative HTTP Clients to the other microservices urls.  


resource:application-dev.yml[app=bookrecommendation,tag=httpservices]

=== Configuration

Add the following OAuth2 Configuration:

resource:application.yml[app=bookrecommendation,tag=oauth2]


<1> OAuth 2.0 Client name.
<2> Client ID. See previous screenshot.
<3> Client Secret. See previous screenshot.
<4> Specify https://micronaut-projects.github.io/micronaut-security/latest/api/index.html[GrantType#CLIENT_CREDENTIALS] as grant type for this OAuth 2.0 client.
<5> Specify the token endpoint URL. You can obtain the token endpoint url in the `\https://cognito-idp.${COGNITO_REGION}.amazonaws.com/${COGNITO_POOL_ID}/.well-known/openid-configuration` OpenID auto configuration endpoint.
<6> Specify https://micronaut-projects.github.io/micronaut-security/latest/api/index.html[AuthenticationMethod#CLIENT_SECRET_BASIC] as the authentication method. It means that basic authentication with client id as username and client secret as password is used for the HTTP Request sent to the token endpoint.
<7> Propagate the access token obtained from Amazon Cognito to requests sent to the services `bookinventory` and `bookcatalogue`. It uses the https://micronaut-projects.github.io/micronaut-security/latest/api/index.html[Micronaut Client Credentials HTTP Client Filter].
<8> Request the custom scope which you set in Amazon Cognito Resource Groups.

The previous configuration uses several placeholders with default values. You will need to setup `OAUTH_CLIENT_ID`, `OAUTH_CLIENT_SECRET` and `OAUTH_TOKEN_URL` environment variables of your Amazon Cognito application.

== Running the application

=== Run `bookcatalogue` microservice


[source, bash]
----
export COGNITO_REGION=us-east-1
export COGNITO_POOL_ID=us-east-1_blablabla
----

:exclude-for-build:maven

To run the application execute `./gradlew run`.

:exclude-for-build:

:exclude-for-build:gradle

To run the application execute `./mvnw mn:run`.

:exclude-for-build:

[source,bash]
----
...
14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8081
----

=== Run `bookinventory` microservice

[source, bash]
----
export COGNITO_REGION=us-east-1
export COGNITO_POOL_ID=us-east-1_blablabla
----

:exclude-for-build:maven

To run the application execute `./gradlew run`.

:exclude-for-build:

:exclude-for-build:gradle

To run the application execute `./mvnw mn:run`.

:exclude-for-build:

[source,bash]
----
...
14:31:13.104 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 506ms. Server Running: http://localhost:8082
----

=== Run `bookrecommendation` microservice

[source, bash]
----
export OAUTH_CLIENT_ID=XXXXXXXXXX
export OAUTH_CLIENT_SECRET=YYYYYYYYYY
export OAUTH_TOKEN_URL=https://micronautguide.auth.us-east-1.amazoncognito.com/oauth2/token
----


:exclude-for-build:maven

To run the application execute `./gradlew run`.

:exclude-for-build:

:exclude-for-build:gradle

To run the application execute `./mvnw mn:run`.

:exclude-for-build:

[source,bash]
----
...
14:31:57.389 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 523ms. Server Running: http://localhost:8080
----

You can run a cURL command to test the whole application:

[source,bash]
----
$ curl http://localhost:8080/books
[{"name":"Building Microservices"}]
----

include::{commondir}/common-graal-with-plugins.adoc[]

:exclude-for-languages:groovy

Run the native images and execute a cURL command to test the whole application:

[source,bash]
----
$ curl http://localhost:8080/books
[{"name":"Building Microservices"}]
----

:exclude-for-languages:

== Next steps

Read https://micronaut-projects.github.io/micronaut-security/latest/guide/#oauth[Micronaut OAuth 2.0 documentation] to learn more.

include::{commondir}/common-helpWithMicronaut.adoc[]
