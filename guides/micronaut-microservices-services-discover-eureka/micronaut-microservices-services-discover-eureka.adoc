= @guideTitle@

@guideIntro@

Authors: @authors@

Micronaut Version: @micronaut@

== Getting started

In this guide, we will create three microservices and register them with https://github.com/Netflix/eureka[Netflix Eureka] service discovery. You will discover how Micronaut eases Eureka integration.

include::{commondir}/common-requirements.adoc[]

include::{commondir}/common-completesolution.adoc[]

== Writing the App

Let's describe the microservices:

* `bookcatalogue` - It returns a list of books. It uses a domain consisting of a book name and ISBN.

* `bookinventory` - It exposes an endpoint to check whether a book has sufficient stock to fulfil an order.  It uses a domain consisting of a stock level and ISBN.

* `bookrecommendation` - It consumes previous services and exposes and endpoint which recommends book names which are in stock.

Initially we will hard-code the addresses where the different services are in the `bookcatalogue` service.

image::hardcoded.svg[]

As shown in the previous image, the `bookcatalogue` hardcodes references to its collaborators.

In the second part of this guide we will use a discovery service.

The services register when they start up:

image::discovery-service-registration.svg[]

When a service wants to do a request to other service, it uses the discovery service to retrieve the address.

image::discovery-service-flow.svg[]

include::{commondir}/common-annotationprocessors.adoc[]

=== Catalogue Microservice

Create the `bookcatalogue` microservice:

[source,bash]
----
mn create-app example.micronaut.bookcatalogue --build=@build@ --lang=@lang@
----

The previous command creates a directory named `bookcatalogue` and a Micronaut application inside it.

source:BooksController[app=bookcatalogue]

<1> The class is defined as a controller with the @api@/io/micronaut/http/annotation/Controller.html[@Controller] annotation mapped to the path `/books`
<2> The `@Get` annotation maps the index method to `/books` requests that use an HTTP GET.

The previous controller responds a `Publisher<Book>`. Create the `Book` POJO:

source:Book[app=bookcatalogue]

Write a test:

test:BooksControllerTest[app=bookcatalogue]

<1> Annotate the class with `@MicronautTest` to let Micronaut starts the embedded server and inject the beans. More info: https://micronaut-projects.github.io/micronaut-test/latest/guide/index.html[https://micronaut-projects.github.io/micronaut-test/latest/guide/index.html].
<2> Inject the `HttpClient` bean in the application context.
<3> It is easy to create HTTP requests with a fluid API.
<4> Parse easily JSON into Java objects.

Edit `application.yml`

resource:application.yml[app=bookcatalogue,tag=mn]

<1> Configure the application name. The name will be use by the discovery service.

include::{commondir}/common-default-dev-environment-application.adoc[]

source:Application[app=bookcatalogue]

include::{commondir}/common-default-dev-environment-application-dev-yaml.adoc[]

resource:application-dev.yml[app=bookcatalogue]

<1> Configure the application to listen on port 8081

Create a file named `application-test.yml` which is used in the test environment:

testResource:application-test.yml[app=bookcatalogue]

Run the unit test:

:exclude-for-build:maven

[source, bash]
----
bookcatalogue $ ./gradlew test
----

:exclude-for-build:

:exclude-for-build:gradle

[source, bash]
----
bookcatalogue $ ./mvnw test
----

:exclude-for-build:

=== Inventory Microservice

Create the `bookinventory` microservice:

[source,bash]
----
mn create-app example.micronaut.bookinventory --build=@build@ --lang=@lang@
----

The previous command creates a directory named `bookinventory` and a Micronaut application inside it.

Create a Controller:

source:BooksController[app=bookinventory]

<1> The class is defined as a controller with the @api@/io/micronaut/http/annotation/Controller.html[@Controller] annotation mapped to the path `/books`
<2> By default a Micronaut's response uses `application/json` as `Content-Type`. We are returning a String not a JSON object. Because of that, we set it to `text/plain`.
<3> The `@Get` annotation maps the index method to `/books/stock/{isbn}` requests that use an HTTP GET.

The previous controller uses a POJO:

source:BookInventory[app=bookinventory]

Write a test:

test:BooksControllerTest[app=bookinventory]

Edit `application.yml`

resource:application.yml[app=bookinventory,tag=mn]

<1> Configure the application name. The name will be used later in the guide.

include::{commondir}/common-default-dev-environment-application.adoc[]

source:Application[app=bookinventory]

include::{commondir}/common-default-dev-environment-application-dev-yaml.adoc[]

resource:application-dev.yml[app=bookinventory]

<1> Configure the application to listen on port 8082

Create a file named `application-test.yml` which is used in the test environment:

testResource:application-test.yml[app=bookinventory]

Run the unit test:

:exclude-for-build:maven

[source, bash]
----
bookinventory $ ./gradlew test
----

:exclude-for-build:

:exclude-for-build:gradle

[source, bash]
----
bookinventory $ ./mvnw test
----

:exclude-for-build:

=== Recommendation Microservice

Create the `bookrecommendation` microservice:

[source,bash]
----
mn create-app example.micronaut.bookrecommendation --build=@build@ --lang=@lang@
----

The previous command creates a directory named `bookrecommendation` and a Micronaut application inside it.

Create an interface to map operations with `bookcatalogue`, and a Micronaut Declarative HTTP Client to consume it.

source:BookCatalogueOperations[app=bookrecommendation]

source:BookCatalogueClient[app=bookrecommendation,tags=packageandimports|harcoded|clazz]

<1> Use `@Client` to use https://docs.micronaut.io/latest/guide/index.html#clientAnnotation[declarative HTTP Clients]

The client returns a POJO. Create it in the `bookrecommendation`:

source:Book[app=bookrecommendation]

Create an interface to map operations with `bookinventory`, and a Micronaut Declarative HTTP Client to consume it.

source:BookInventoryOperations[app=bookrecommendation]

source:BookCatalogueClient[app=bookrecommendation,tags=packageandimports|harcoded|clazz]

<1> Use `@Client` to use https://docs.micronaut.io/latest/guide/index.html#clientAnnotation[declarative HTTP Clients]

Create a Controller which injects both clients.

source:BookController[app=bookrecommendation]

<1> The class is defined as a controller with the @api@/io/micronaut/http/annotation/Controller.html[@Controller] annotation mapped to the path `/books`
<2> Constructor injection
<3> The `@Get` annotation maps the index method to `/books` requests that use an HTTP GET.

The previous controller returns a `Publisher<BookRecommendation>`. Create the `BookRecommendation` POJO:

source:BookRecommendation[app=bookrecommendation]

`BookCatalogueClient` and `BookInventoryClient` will fail to consume the `bookcatalogue` and `bookinventory` during the tests phase.

Using the https://docs.micronaut.io/latest/guide/index.html#clientFallback[@Fallback] annotation you can declare a fallback implementation of a client that will be picked up and used once all possible retries have been exhausted

Create `@Fallback` alternatives in the `test` classpath.

test:BookInventoryClientStub[app=bookrecommendation]

<1> Make this fallback class to be effective only when the Micronaut environment __TEST__ is active
<2> Here we arbitrarily decided that if everything else fails, that book's `stock` would be true
<3> Similarly, we decided that other book's `stock` method would be false
<4> Finally, any other book will have their `stock` method return an empty value

test:BookCatalogueClientStub[app=bookrecommendation]

Write a test:

test:BookControllerTest[app=bookrecommendation]

Edit `application.yml`

resource:application.yml[app=bookrecommendation,tag=mn]

<1> Configure the application name. The name will be used later in the guide.

include::{commondir}/common-default-dev-environment-application.adoc[]

source:Application[app=bookrecommendation]

include::{commondir}/common-default-dev-environment-application-dev-yaml.adoc[]

resource:application-dev.yml[app=bookrecommendation]

<1> Configure the application to listen on port 8080

Create a file named `application-test.yml` which is used in the test environment:

testResource:application-test.yml[app=bookrecommendation]

Run the unit test:

:exclude-for-build:maven

[source, bash]
----
bookinventory $ ./gradlew test
----

:exclude-for-build:

:exclude-for-build:gradle

[source, bash]
----
bookinventory $ ./mvnw test
----

:exclude-for-build:

=== Running the application

Run `bookcatalogue` microservice:

:exclude-for-build:maven

To run the application execute `./gradlew run`.

:exclude-for-build:

:exclude-for-build:gradle

To run the application execute `./mvnw mn:run`.

:exclude-for-build:

[source,bash]
----
...
14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8081
----

Run `bookinventory` microservice:

:exclude-for-build:maven

To run the application execute `./gradlew run`.

:exclude-for-build:

:exclude-for-build:gradle

To run the application execute `./mvnw mn:run`.

:exclude-for-build:

[source,bash]
----
...
14:31:13.104 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 506ms. Server Running: http://localhost:8082
----

Run `bookrecommendation` microservice:

:exclude-for-build:maven

To run the application execute `./gradlew run`.

:exclude-for-build:

:exclude-for-build:gradle

To run the application execute `./mvnw mn:run`.

:exclude-for-build:

[source,bash]
----
...
14:31:57.389 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 523ms. Server Running: http://localhost:8080
----

You can run a cURL command to test the whole application:

[source,bash]
----
$ curl http://localhost:8080/books
[{"name":"Building Microservices"}]
----

== Eureka and Micronaut

https://github.com/Netflix/eureka[Netflix Eureka]:

____
Eureka is a REST (Representational State Transfer) based service that is primarily used in the AWS cloud for locating services for the purpose of load balancing and failover of middle-tier servers.
____

=== Eureka Server

https://cloud.spring.io/spring-cloud-netflix/[Spring-Cloud-Netflix] provides a very neat way to bootstrap Eureka.
To bring up Eureka server using Spring-Cloud-Netflix:

* Clone the https://github.com/spring-cloud-samples/eureka[sample Eureka server application].
* Run this project as a Spring Boot application (e.g. import into IDE and run main method, or use `mvn spring-boot:run` or `./gradlew bootRun`). It will start up on port 8761 and serve the Eureka API from `/eureka`.

=== Book Catalogue

Add `discovery-client` dependency.

dependency:micronaut-discovery-client[groupId=io.micronaut.discovery]

Append to `bookcatalogue` service `application.yml` the following snippet:

resource:application.yml[app=bookcatalogue,tag=eureka]

Previous configuration registers a Micronaut application with Eureka with minimal configuration. Discover a more complete list of configuration options at @api@/io/micronaut/discovery/eureka/EurekaConfiguration.html[EurekaConfiguration].

Disable Eureka registration in tests:

testResource:application-test.yml[app=bookcatalogue,tag=eureka]

=== Book Inventory

Add `discovery-client` dependency.

dependency:micronaut-discovery-client[groupId=io.micronaut.discovery]

Also, append to `bookinventory`.`application.yml` the following snippet:

resource:application.yml[app=bookinventory,tag=eureka]

Disable Eureka registration in tests:

testResource:application-test.yml[app=bookinventory,tag=eureka]

=== Book Recommendation

Add `discovery-client` dependency.

dependency:micronaut-discovery-client[groupId=io.micronaut.discovery]

Also, append to `bookrecommendation`.`application.yml` the following snippet:

resource:application.yml[app=bookrecommendation,tag=eureka]

Modify `BookInventoryClient` and `BookCatalogueClient` to use the service id instead of a harcoded ip.

source:BookCatalogueClient[app=bookrecommendation,tags=packageandimports|eureka|clazz]

<1> Use the configuration value `micronaut.application.name` used in `bookcatalogue` as service `id`.

source:BookInventoryClient[app=bookrecommendation,tags=packageandimports|eureka|clazz]

<1> Use the configuration value `micronaut.application.name` used in `bookinventory` as service `id`.

Disable Eureka registration in tests:

testResource:application-test.yml[app=bookrecommendation,tag=eureka]

=== Running the App

Run `bookcatalogue` microservice:

:exclude-for-build:maven

To run the application execute `./gradlew run`.

:exclude-for-build:

:exclude-for-build:gradle

To run the application execute `./mvnw mn:run`.

:exclude-for-build:

[source,bash]
----
...
14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8081
----

Run `bookinventory` microservice:

:exclude-for-build:maven

To run the application execute `./gradlew run`.

:exclude-for-build:

:exclude-for-build:gradle

To run the application execute `./mvnw mn:run`.

:exclude-for-build:

[source,bash]
----
...
14:31:13.104 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 506ms. Server Running: http://localhost:8082
----

Run `bookrecommendation` microservice:

:exclude-for-build:maven

To run the application execute `./gradlew run`.

:exclude-for-build:

:exclude-for-build:gradle

To run the application execute `./mvnw mn:run`.

:exclude-for-build:

[source,bash]
----
...
14:31:57.389 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 523ms. Server Running: http://localhost:8080
----

You can run a cURL command to test the whole application:

[source,bash]
----
$ curl http://localhost:8080/books
[{"name":"Building Microservices"}]
----

Open http://localhost:8761[http://localhost:8761] in your browser.

You will see the services registered in Eureka:

image::eurekaui.png[]

You can run a cURL command to test the whole application:

[source, bash]
----
$ curl http://localhost:8080/books
[{"name":"Building Microservices"}]
----

include::{commondir}/common-graal-with-plugins.adoc[]

:exclude-for-languages:groovy

Start the native images for the three microservices and run the same `curl` request as before to check that everything works with GraalVM.

:exclude-for-languages:

== Next steps

Read more about https://docs.micronaut.io/latest/guide/index.html#serviceDiscoveryEureka[Eureka Support] inside Micronaut.

include::{commondir}/common-helpWithMicronaut.adoc[]

