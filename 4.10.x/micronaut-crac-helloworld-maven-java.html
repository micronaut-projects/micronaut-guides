<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'/>
    <title>Micronaut CRaC</title>
    <link rel='stylesheet' id='wp-block-library-css' href='https://micronaut.io/wp-includes/css/dist/block-library/style.min.css' type='text/css' media='all'/>
    <link rel='stylesheet' id='fonts-fira-sans-css' href='https://fonts.googleapis.com/css2?family=Fira+Sans%3Awght%40300%3B500&#038;display=swap&#038;ver=5.7' type='text/css' media='all'/>
    <link rel='stylesheet' id='micronaut-style-css' href='https://micronaut.io/wp-content/themes/micronaut/style.min.css' type='text/css' media='all'/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link rel="shortcut icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link rel="alternate" type="application/rss+xml" title="Micronaut Guides RSS Feed" href="https://guides.micronaut.io/latest/rss.xml" />
    <link rel="alternate" type="application/json" title="Micronaut Guides JSON Feed" href="https://guides.micronaut.io/latest/feed.json" />
    <link href="coderay.css" rel="stylesheet" />
    <link href="rouge-github.css" rel="stylesheet" />
    <link href="guide.css" rel="stylesheet" />
    <script src="lunr.js"></script>
    <script src="guide.js"></script>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://guides.micronaut.io/latest/images/cards/micronauttwittercard.png"/>
    <meta name="twitter:creator" content="@micronautfw"/>
    <meta name="twitter:site" content="@micronautfw"/>
    <meta name="twitter:title" content="Micronaut CRaC"/>
    <meta name="twitter:description" content="Learn how to start using CRaC with a Micronaut Application"/>
</head>
<body class="page-template page-template-page-sidebar page-template-page-sidebar-php page page-parent guide">

<header id="header">

    <div class="container">

        <nav class="navbar navbar-expand-lg navbar-dark">

            <button class="collapsed" type="button" data-toggle="collapse" data-target="#nav" aria-expanded="false">
                <span></span>
            </button>

            <a class="navbar-brand" href="https://micronaut.io">
                <img src="https://micronaut.io/wp-content/uploads/2020/11/MIcronautLogo_Horizontal.svg" alt="Micronaut framework"/>
            </a>

            <div class="collapse navbar-collapse" id="nav">

                <ul class="navbar-nav ml-auto">

                    <li id="menu-item-2865" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2865 nav-item"><a href="https://micronaut.io/download/" class="nav-link">Download</a></li>
                    <li id="menu-item-2868" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-2868 dropdown nav-item"><a href="https://micronaut.io/learn/" class="nav-link dropdown-toggle" data-toggle="dropdown">Learn</a><ul class="dropdown-menu">
                        <li id="menu-item-4943" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4943"><a href="https://micronaut.io/learn/" class="dropdown-item">Overview</a></li>
                        <li id="menu-item-5111" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-5111"><a href="https://docs.micronaut.io/index.html" class="dropdown-item">User Documentaton</a></li>
                        <li id="menu-item-4510" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4510"><a href="https://micronaut.io/guides/" class="dropdown-item">Guides</a></li>
                        <li id="menu-item-2896" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2896"><a href="https://micronaut.io/category/microcast/" class="dropdown-item">Microcasts</a></li>
                        <li id="menu-item-2897" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2897"><a href="https://micronaut.io/category/webinar/" class="dropdown-item">Webinars</a></li>
                        <li id="menu-item-2871" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2871"><a href="https://micronaut.io/professional-training/" class="dropdown-item">Professional Training</a></li>
                        <li id="menu-item-6526" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-6526"><a href="https://micronaut-projects.github.io/micronaut-guides-mn3/latest/" class="dropdown-item">Guides for Micronaut Framework 3</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2878" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2878 dropdown nav-item"><a href="https://micronaut.io/resources/" class="nav-link dropdown-toggle" data-toggle="dropdown">Resources</a><ul class="dropdown-menu">
                        <li id="menu-item-4999" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4999"><a href="https://micronaut.io/upcoming-events/" class="dropdown-item">Upcoming Events</a></li>
                        <li id="menu-item-2879" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2879"><a href="https://micronaut.io/blog/" class="dropdown-item">Blog</a></li>
                        <li id="menu-item-6478" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6478"><a href="https://micronaut.io/category/release-announcements/" class="dropdown-item">Releases</a></li>
                        <li id="menu-item-6715" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6715"><a href="https://micronaut.io/category/security-announcements/" class="dropdown-item">Security Announcements</a></li>
                        <li id="menu-item-4499" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-4499"><a href="https://micronautpodcast.com/" class="dropdown-item">Podcast</a></li>
                        <li id="menu-item-5798" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5798"><a href="https://micronaut.io/support/" class="dropdown-item">Commercial Support</a></li>
                        <li id="menu-item-4186" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4186"><a href="https://micronaut.io/resources/community-support/" class="dropdown-item">Community Support</a></li>
                        <li id="menu-item-2882" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2882"><a href="https://micronaut.io/faq/" class="dropdown-item">FAQ</a></li>
                        <li id="menu-item-2883" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2883"><a href="https://micronaut.io/contact/" class="dropdown-item">Contact</a></li>
                        <li id="menu-item-6479" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6479"><a href="https://micronaut.io/micronaut-success-stories/" class="dropdown-item">Micronaut Success Stories</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2872" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2872 dropdown nav-item"><a href="https://micronaut.io/foundation/" class="nav-link dropdown-toggle" data-toggle="dropdown">Foundation</a><ul class="dropdown-menu">
                        <li id="menu-item-2877" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2877"><a href="https://micronaut.io/foundation/" class="dropdown-item">Overview</a></li>
                        <li id="menu-item-2874" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2874"><a href="https://micronaut.io/foundation/corporate-sponsorship/" class="dropdown-item">Corporate Sponsorship</a></li>
                        <li id="menu-item-2873" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2873"><a href="https://micronaut.io/foundation/community-sponsorship/" class="dropdown-item">Community Sponsorship</a></li>
                        <li id="menu-item-2876" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2876"><a href="https://micronaut.io/foundation/sponsors/" class="dropdown-item">Sponsors</a></li>
                        <li id="menu-item-3838" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-3838"><a href="https://micronaut.io/meeting-minutes/" class="dropdown-item">Meeting Minutes</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2884" class="action menu-item menu-item-type-custom menu-item-object-custom menu-item-2884 nav-item"><a target="_blank" rel="noopener" href="https://micronaut.io/launch/" class="nav-link">Launch</a></li>

                </ul>

            </div>

        </nav>

    </div>
</header>

<div style="background: #fff;padding-top: 20px;padding-bottom: 20px;">
    <div class="container" style="clear: both;">
        <fieldset style="float: right;">
            <input type="search" id="search-form-query"/>
            <input type="submit" onclick="search()" value="Search">
            <input type="submit" onclick="resetSearch()" value="Reset">
        </fieldset>
    </div>
    <div class="container" style="clear: both;margin-top: -20px;">
        <div class="guide-list" id="searchResults">
        </div>
    </div>
</div>
<div id="breadcrumbs"><div class="container"><a href="https://micronaut.io/">Home</a> » <a href="./index.html">Guides</a> » <a href="micronaut-crac-helloworld.html">Micronaut CRaC</a> » <span class="breadcrumb_last" aria-current="page">maven | java</span></div></div><!-- .breadcrumbs -->
<main id="main">
    <div class="container">
        <div class="row">
            <div class="col-md-4">

                <div class="toc">
                    <div class="inner">
                        <h1 class="title title_large first-word-bold first-word-break">Table of Contents</h1>
                        <div class="underline"></div>
                        
<ul class="sectlevel1">
<li><a href="#getting-started">1. Getting Started</a></li>
<li><a href="#what-is-coordinated-restore-at-checkpoint-crac">2. What is Coordinated Restore at Checkpoint (CRaC)?</a></li>
<li><a href="#what-you-will-need">3. What you will need</a></li>
<li><a href="#solution">4. Solution</a></li>
<li><a href="#writing-the-application">5. Writing the Application</a></li>
<li><a href="#micronaut-crac-dependency">6. Micronaut CRaC Dependency</a></li>
<li><a href="#create-resources">7. Create Resources</a></li>
<li><a href="#checkpoint-simulator">8. Checkpoint Simulator</a></li>
<li><a href="#refreshable-beans-and-crac">9. Refreshable beans and CRaC</a></li>
<li><a href="#eagerly-initialize-singletons">10. Eagerly initialize Singletons</a></li>
<li><a href="#info-endpoint">11. Info endpoint</a></li>
<li><a href="#next-steps">12. Next Steps</a></li>
<li><a href="#license">13. License</a></li>
</ul>

                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <h1>Micronaut CRaC</h1>
                <div class="underline"></div>
<div class="sect1">
<div class="sectionbody">

<div class="paragraph">
<p>Learn how to start using CRaC with a Micronaut Application</p>
</div>
<div class="paragraph">
<p>Authors: Sergio del Amo</p>
</div>
<div class="paragraph">
<p>Micronaut Version: 4.9.1</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started">1. Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this guide, we will create a Micronaut application written in Java.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-is-coordinated-restore-at-checkpoint-crac">2. What is <a href="https://docs.azul.com/core/crac/crac-introduction">Coordinated Restore at Checkpoint (CRaC)</a>?</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Coordinated Restore at Checkpoint (CRaC) is a JDK project that can start projects - on Linux - with shorter time to first transaction and less time and resources to achieve full code speed. CRaC effectively takes a snapshot of the Java process when it is fully warmed up, then uses that snapshot to launch any number of JVMs from this captured state</p>
</div>
</blockquote>
</div>
</div>
</div>
</div></div><div class="row"><div class="col-md-12"><div class="sect1">
<h2 id="what-you-will-need">3. What you will need</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE (e.g. <a href="https://guides.micronaut.io/latest/micronaut-intellij-idea-ide-setup.html">IntelliJ IDEA</a>)</p>
</li>
<li>
<p>JDK 21 or greater installed with <code>JAVA_HOME</code> <a href="https://www.baeldung.com/java-home-on-windows-7-8-10-mac-os-x-linux">configured appropriately</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="solution">4. Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create the application step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="micronaut-crac-helloworld-maven-java.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-the-application">5. Writing the Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Create an application using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">mn create-app example.micronaut.micronautguide <span class="se">\</span>
    <span class="nt">--features</span><span class="o">=</span>crac,management <span class="se">\</span>
    <span class="nt">--build</span><span class="o">=</span>maven <span class="se">\</span>
    <span class="nt">--lang</span><span class="o">=</span>java <span class="se">\</span>
    <span class="nt">--test</span><span class="o">=</span>junit</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle with the <a href="https://docs.gradle.org/current/userguide/kotlin_dsl.html">Kotlin DSL</a> is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.<br/> If you don&#8217;t specify the <code>--test</code> argument, JUnit is used for Java and Kotlin, and Spock is used for Groovy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous command creates a Micronaut application with the default package <code>example.micronaut</code> in a directory named <code>micronautguide</code>.</p>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add <code>crac</code>, and <code>management</code> features.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have an existing Micronaut application and want to add the functionality described here, you can view the dependency and configuration changes from the specified features, and apply those changes to your application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://micronaut.io/launch?features=crac&amp;features=management&amp;lang=JAVA&amp;build=MAVEN&amp;test=JUNIT&amp;name=micronautguide&amp;type=DEFAULT&amp;package=example.micronaut&amp;activity=diff" target="_blank" rel="noopener">Diff</a></p>
</div>
<div class="paragraph">
<p><a href="https://guides.micronaut.io/latest/micronaut-intellij-idea-ide-setup.html">Setup IntelliJ IDEA to develop Micronaut Applications</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="micronaut-crac-dependency">6. Micronaut CRaC Dependency</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Add the Micronaut CRaC dependency:</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.micronaut.crac<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>micronaut-crac<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It has a transitive dependency to <a href="https://github.com/CRaC/org.crac">org.crac:crac</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-resources">7. Create Resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One limitation of CRaC is that you cannot have open files or sockets when a checkpoint is created.
To support this with Micronaut CRaC, you will write resources to close files and connections, dump cache, etc.</p>
</div>
<div class="paragraph">
<p>You will use the Micronaut CRaC API <code>OrderedResource</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">OrderedResource</span> <span class="kd">extends</span> <span class="n">org</span><span class="o">.</span><span class="na">crac</span><span class="o">.</span><span class="na">Resource</span><span class="o">,</span> <span class="n">io</span><span class="o">.</span><span class="na">micronaut</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">order</span><span class="o">.</span><span class="na">Ordered</span> <span class="o">{</span> <span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Micronaut CRaC automatically registers beans of type <code>OrderedResource</code> in the CRaC Context.</p>
</div>
<div class="paragraph">
<p>You could create such a bean:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/LoggingResource.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.crac.OrderedResource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jakarta.inject.Singleton</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.crac.Context</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.crac.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>

<span class="nd">@Singleton</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggingResource</span> <span class="kd">implements</span> <span class="nc">OrderedResource</span>  <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Logger</span> <span class="no">LOG</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">LoggingResource</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">beforeCheckpoint</span><span class="o">(</span><span class="nc">Context</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Resource</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="no">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"before checkpoint"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterRestore</span><span class="o">(</span><span class="nc">Context</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Resource</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="no">LOG</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"after restore"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>jakarta.inject.Singleton</code> to designate a class as a singleton.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="checkpoint-simulator">8. Checkpoint Simulator</h2>
<div class="sectionbody">
<div class="paragraph">
<p>CRaC only works with Linux.
To ease testing and development in operating systems which don&#8217;t support CRaC, Micronaut CRaC includes the <a href="https://micronaut-projects.github.io/micronaut-crac/latest/guide/#checkpointSimulator"><code>CheckpointSimulator</code> API</a>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>With CRaC, you run your application to a point and then "checkpoint" it. This calls the app to close all its sockets and file handles, and then dumps the memory to disk. When it restarts from this snapshot, it calls the app again to say it’s been restored, and one can re-open files and network connections.</p>
</div>
<div class="paragraph">
<p>The simulator allows you to synthesise these two calls (before checkpoint and after restore), so that under a test you can check your service works again after it was closed and recreated.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Given a controller such as:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/HelloWorldController.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Get</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="nd">@Controller</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="kd">class</span> <span class="nc">HelloWorldController</span> <span class="o">{</span>

    <span class="nd">@Get</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">index</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span> <span class="s">"Hello World"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the method to an HTTP GET request.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To simplify testing, we create a utility class that allows you to run a test scenario before and after the checkpoint.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/example/micronaut/CheckpointTestUtils.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.context.ApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.crac.test.CheckpointSimulator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.client.BlockingHttpClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.client.HttpClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.runtime.server.EmbeddedServer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.function.Function</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CheckpointTestUtils</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">(</span><span class="nc">Function</span><span class="o">&lt;</span><span class="nc">BlockingHttpClient</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">testScenario</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">EmbeddedServer</span> <span class="n">server</span> <span class="o">=</span> <span class="nc">ApplicationContext</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">EmbeddedServer</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">CheckpointSimulator</span> <span class="n">checkpointSimulator</span> <span class="o">=</span>
                    <span class="n">server</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">().</span><span class="na">getBean</span><span class="o">(</span><span class="nc">CheckpointSimulator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="n">testApp</span><span class="o">(</span><span class="n">server</span><span class="o">,</span> <span class="n">testScenario</span><span class="o">);</span>

            <span class="n">checkpointSimulator</span><span class="o">.</span><span class="na">runBeforeCheckpoint</span><span class="o">();</span>
            <span class="n">server</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
            <span class="n">checkpointSimulator</span><span class="o">.</span><span class="na">runAfterRestore</span><span class="o">();</span>
            <span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
            <span class="n">testApp</span><span class="o">(</span><span class="n">server</span><span class="o">,</span> <span class="n">testScenario</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Object</span> <span class="nf">testApp</span><span class="o">(</span><span class="nc">EmbeddedServer</span> <span class="n">embeddedServer</span><span class="o">,</span> <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">BlockingHttpClient</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">clientConsumer</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">HttpClient</span> <span class="n">httpClient</span> <span class="o">=</span> <span class="n">embeddedServer</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">().</span><span class="na">createBean</span><span class="o">(</span><span class="nc">HttpClient</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">embeddedServer</span><span class="o">.</span><span class="na">getURL</span><span class="o">()))</span> <span class="o">{</span>
            <span class="nc">BlockingHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">httpClient</span><span class="o">.</span><span class="na">toBlocking</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">clientConsumer</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">client</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You could write a test for the previous controller:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/example/micronaut/HelloWorldControllerTest.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.core.type.Argument</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.client.BlockingHttpClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">jupiter</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">jupiter</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">HelloWorldControllerTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">emulateCheckpoint</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">CheckpointTestUtils</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">testHelloWorld</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">Void</span> <span class="nf">testHelloWorld</span><span class="o">(</span><span class="nc">BlockingHttpClient</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">HttpResponse</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">exchange</span><span class="o">(</span><span class="nc">HttpRequest</span><span class="o">.</span><span class="na">GET</span><span class="o">(</span><span class="s">"/"</span><span class="o">),</span> <span class="nc">Argument</span><span class="o">.</span><span class="na">mapOf</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">getStatus</span><span class="o">());</span>
        <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">bodyOptional</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
        <span class="n">assertTrue</span><span class="o">(</span><span class="n">bodyOptional</span><span class="o">.</span><span class="na">isPresent</span><span class="o">());</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span> <span class="s">"Hello World"</span><span class="o">),</span> <span class="n">bodyOptional</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="refreshable-beans-and-crac">9. Refreshable beans and CRaC</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Micronaut CRaC ships with several built-in beans of type <code>OrderedResource</code>. One of them is the <a href="https://micronaut-projects.github.io/micronaut-crac/latest/api/io/micronaut/crac/resources/RefreshEventResource.html"><code>RefreshEventResource</code></a>.  <code>RefreshEventResource</code>
emits a <code>RefreshEvent</code>, causing beans in the <code>@Refreshable</code> scope to be invalidated before a checkpoint.</p>
</div>
<div class="paragraph">
<p>Given a controller such as:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/TimeController.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.annotation.Get</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.runtime.context.scope.Refreshable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.format.DateTimeFormatter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="nd">@Refreshable</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nd">@Controller</span><span class="o">(</span><span class="s">"/time"</span><span class="o">)</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="kd">class</span> <span class="nc">TimeController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">time</span><span class="o">;</span>

    <span class="nc">TimeController</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">time</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">format</span><span class="o">(</span><span class="nc">DateTimeFormatter</span><span class="o">.</span><span class="na">ISO_DATE_TIME</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Get</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">index</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="s">"time"</span><span class="o">,</span> <span class="n">time</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>@Refreshable</code> scope is a custom scope that allows a bean&#8217;s state to be refreshed via the <a href="https://docs.micronaut.io/latest/guide/#refreshEndpoint">/refresh</a> endpoint.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/time</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the method to an HTTP GET request.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following test verifies the <code>TimeController</code> is invalidated prior to a checkpoint.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/example/micronaut/TimeControllerTest.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.context.ApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.core.type.Argument</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.crac.test.CheckpointSimulator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpStatus</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.client.BlockingHttpClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.runtime.server.EmbeddedServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">jupiter</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">jupiter</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertNotEquals</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">jupiter</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">TimeControllerTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">emulateCheckpoint</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">(</span><span class="nc">EmbeddedServer</span> <span class="n">server</span> <span class="o">=</span> <span class="nc">ApplicationContext</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">EmbeddedServer</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
            <span class="nc">CheckpointSimulator</span> <span class="n">checkpointSimulator</span> <span class="o">=</span>
                    <span class="n">server</span><span class="o">.</span><span class="na">getApplicationContext</span><span class="o">().</span><span class="na">getBean</span><span class="o">(</span><span class="nc">CheckpointSimulator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
            <span class="nc">Object</span> <span class="n">time</span> <span class="o">=</span> <span class="nc">CheckpointTestUtils</span><span class="o">.</span><span class="na">testApp</span><span class="o">(</span><span class="n">server</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">testTime</span><span class="o">);</span>
            <span class="n">assertEquals</span><span class="o">(</span><span class="n">time</span><span class="o">,</span> <span class="nc">CheckpointTestUtils</span><span class="o">.</span><span class="na">testApp</span><span class="o">(</span><span class="n">server</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">testTime</span><span class="o">));</span>
            <span class="n">checkpointSimulator</span><span class="o">.</span><span class="na">runBeforeCheckpoint</span><span class="o">();</span>
            <span class="n">server</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
            <span class="n">checkpointSimulator</span><span class="o">.</span><span class="na">runAfterRestore</span><span class="o">();</span>
            <span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
            <span class="n">assertNotEquals</span><span class="o">(</span><span class="n">time</span><span class="o">,</span> <span class="nc">CheckpointTestUtils</span><span class="o">.</span><span class="na">testApp</span><span class="o">(</span><span class="n">server</span><span class="o">,</span> <span class="k">this</span><span class="o">::</span><span class="n">testTime</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">testTime</span><span class="o">(</span><span class="nc">BlockingHttpClient</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">HttpResponse</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">exchange</span><span class="o">(</span><span class="nc">HttpRequest</span><span class="o">.</span><span class="na">GET</span><span class="o">(</span><span class="s">"/time"</span><span class="o">),</span> <span class="nc">Argument</span><span class="o">.</span><span class="na">mapOf</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span> <span class="n">response</span><span class="o">.</span><span class="na">getStatus</span><span class="o">());</span>
        <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="n">bodyOptional</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
        <span class="n">assertTrue</span><span class="o">(</span><span class="n">bodyOptional</span><span class="o">.</span><span class="na">isPresent</span><span class="o">());</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">bodyOptional</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">body</span><span class="o">.</span><span class="na">keySet</span><span class="o">().</span><span class="na">size</span><span class="o">()</span> <span class="o">);</span>
        <span class="n">assertTrue</span><span class="o">(</span><span class="n">body</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="s">"time"</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">body</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"time"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="eagerly-initialize-singletons">10. Eagerly initialize Singletons</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When you use CRaC, you should use <a href="https://docs.micronaut.io/latest/guide/#eagerInit">eager initialization</a> to ensure the application is fully loaded before the checkpoint is taken.</p>
</div>
<div class="paragraph">
<p>Modify your application class:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/example/micronaut/Application.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.core.annotation.NonNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.context.ApplicationContextBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.context.ApplicationContextConfigurer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.context.annotation.ContextConfigurer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.runtime.Micronaut</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Application</span> <span class="o">{</span>

    <span class="nd">@ContextConfigurer</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Configurer</span> <span class="kd">implements</span> <span class="nc">ApplicationContextConfigurer</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">ApplicationContextBuilder</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">builder</span><span class="o">.</span><span class="na">eagerInitSingletons</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Micronaut</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">Application</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can test eager initialization:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/example/micronaut/Clock.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jakarta.inject.Singleton</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>

<span class="nd">@Singleton</span>
<span class="kd">class</span> <span class="nc">Clock</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">LocalDateTime</span> <span class="n">now</span><span class="o">;</span>

    <span class="nc">Clock</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">now</span> <span class="o">=</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nc">LocalDateTime</span> <span class="nf">getNow</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">now</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/test/java/example/micronaut/EagerlyInitializedTest.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.context.ApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">jupiter</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">EagerlyInitializedTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">singletonsAreEagerlyInitialized</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="nc">ApplicationContext</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
        <span class="n">sleep</span><span class="o">(</span><span class="mi">5_000</span><span class="o">);</span>
        <span class="n">assertTrue</span><span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">Clock</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">getNow</span><span class="o">().</span><span class="na">isBefore</span><span class="o">(</span><span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">minusSeconds</span><span class="o">(</span><span class="mi">3</span><span class="o">)));</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="info-endpoint">11. Info endpoint</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The info endpoint includes a <code>crac</code> section, which shows the restore time and uptime since restore, both in milliseconds.</p>
</div>
<div class="paragraph">
<p>To expose the <a href="https://docs.micronaut.io/latest/guide/#infoEndpoint">info endpoint</a>, you need the following dependency on your classpath.</p>
</div>
<div class="listingblock">
<div class="title">pom.xml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>io.micronaut<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>micronaut-management<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following test verifies the <code>crac</code> section is present in the info endpoint.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/example/micronaut/InfoEndpointTest.java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="kn">package</span> <span class="nn">example.micronaut</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.micronaut.context.annotation.Property</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.core.type.Argument</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.core.util.StringUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.HttpRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.client.HttpClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.http.client.annotation.Client</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.micronaut.test.extensions.junit5.annotation.MicronautTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.jupiter.api.Test</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">jupiter</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertDoesNotThrow</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">jupiter</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">jupiter</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">Assertions</span><span class="o">.</span><span class="na">assertNotNull</span><span class="o">;</span>

<span class="nd">@Property</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"endpoints.info.enabled"</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">TRUE</span><span class="o">)</span>
<span class="nd">@Property</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"endpoints.info.sensitive"</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nc">StringUtils</span><span class="o">.</span><span class="na">FALSE</span><span class="o">)</span>
<span class="nd">@MicronautTest</span>
<span class="kd">class</span> <span class="nc">InfoEndpointTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kt">void</span> <span class="nf">cracInformationIsExposedInTheInfoEndpointExposed</span><span class="o">(</span><span class="nd">@Client</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span> <span class="nc">HttpClient</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;&gt;</span> <span class="n">json</span> <span class="o">=</span> <span class="n">assertDoesNotThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">client</span><span class="o">.</span><span class="na">toBlocking</span><span class="o">().</span><span class="na">retrieve</span><span class="o">(</span><span class="nc">HttpRequest</span><span class="o">.</span><span class="na">GET</span><span class="o">(</span><span class="s">"/info"</span><span class="o">),</span> <span class="nc">Argument</span><span class="o">.</span><span class="na">mapOf</span><span class="o">(</span><span class="nc">Argument</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="nc">Argument</span><span class="o">.</span><span class="na">mapOf</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">))));</span>
        <span class="n">assertNotNull</span><span class="o">(</span><span class="n">json</span><span class="o">);</span>
        <span class="n">assertEquals</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"crac"</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"restore-time"</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">,</span> <span class="s">"uptime-since-restore"</span><span class="o">,</span> <span class="o">-</span><span class="mi">1</span><span class="o">)),</span> <span class="n">json</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The previous test shows -1 since the application has yet to be restored.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="next-steps">12. Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Explore more features with <a href="https://micronaut.io/guides/">Micronaut Guides</a>.</p>
</div>
<div class="paragraph">
<p>Learn more about:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://micronaut-projects.github.io/micronaut-crac/latest/guide/" class="bare">https://micronaut-projects.github.io/micronaut-crac/latest/guide/</a>[Micronaut CRaC (Coordinated Restore at checkpoint)</p>
</li>
<li>
<p><a href="https://docs.azul.com/core/crac/crac-introduction">CRaC Introduction</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="license">13. License</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All guides are released with an <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache license 2.0 license</a> for the code and a <a href="https://creativecommons.org/licenses/by/4.0/deed.en">Creative Commons Attribution 4.0</a> license for the writing and media (images&#8230;&#8203;).
</td>
</tr>
</table>
</div>

            </div>
        </div>
    </div>
</main>

<footer id="footer">
    <div class="container">

        <div class="row">
            <div class="col-sm-5 footer-left">

                <div id="text-14" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <a href="https://micronaut.io/foundation/"><img class="alignnone size-medium wp-image-3736" src="./images/micronaut_foundation_horizontal_white.svg" alt="Micronaut Foundation"/></a>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-sm-7 footer-right">

                <ul class="meta">

                    <li id="menu-item-2895" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2895">
                        <a href="https://micronaut.io/brand-guidelines/">Brand Guidelines</a>
                    </li>
                    <li id="menu-item-2894" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2894">
                        <a href="https://micronaut.io/community-guidelines/">Community Guidelines</a>
                    </li>
                    <li id="menu-item-3377" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-privacy-policy menu-item-3377">
                        <a href="https://micronaut.io/privacy-policy/">Privacy Policy</a>
                    </li>

                </ul>

                <div id="nav_menu-2" class="widget widget_nav_menu">
                    <div class="menu-links-container">
                        <ul id="menu-links" class="menu">
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronautpodcast.com"><i class="fa fa-podcast"><span class="sr-only">Podcast</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronaut.io/feed/rss/"><i class="fa fa-feed"><span class="sr-only">Feed</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="mailto:info@micronaut.io"><i class="fas fa-envelope"><span class="sr-only">Mail</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://twitter.com/micronautfw"><i class="fab fa-twitter"><span class="sr-only">Twitter</span></i></a></li>
                            <li id="menu-item-6740" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-6740"><a href="https://fosstodon.org/@micronaut"><i class="fab fa-mastodon"><span class="sr-only">Mastodon</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://discord.gg/9xRFsHv98T"><i class="fab fa-discord"><span class="sr-only">Discord</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://github.com/micronaut-projects/"><i class="fab fa-github"><span class="sr-only">GitHub</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.youtube.com/@MicronautFramework"><i class="fab fa-youtube"><span class="sr-only">YouTube</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.linkedin.com/showcase/micronaut"><i class="fab fa-linkedin"><span class="sr-only">LinkedIn</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.twitch.tv/micronautfw"><i class="fab fa-twitch"><span class="sr-only">Twitch</span></i></a></li>
                        </ul>
                    </div>
                </div>
                <div id="text-5" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <small>Guides are licensed under <a href="https://creativecommons.org/licenses/by/4.0/deed.en">CC BY 4.0</a> for the writing/media and <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache.2.0</a> for the code</small>
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</footer>
</body>
</html>
