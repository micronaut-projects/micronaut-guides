<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name='robots' content='index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1'/>
    <title>Consul and the Micronaut Framework - Microservices Service Discovery</title>
    <link rel='stylesheet' id='wp-block-library-css' href='https://micronaut.io/wp-includes/css/dist/block-library/style.min.css' type='text/css' media='all'/>
    <link rel='stylesheet' id='fonts-fira-sans-css' href='https://fonts.googleapis.com/css2?family=Fira+Sans%3Awght%40300%3B500&#038;display=swap&#038;ver=5.7' type='text/css' media='all'/>
    <link rel='stylesheet' id='micronaut-style-css' href='https://micronaut.io/wp-content/themes/micronaut/style.min.css' type='text/css' media='all'/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link rel="shortcut icon" href="https://micronaut.io/wp-content/uploads/2021/02/favicon.ico" type="image/png">
    <link rel="alternate" type="application/rss+xml" title="Micronaut Guides RSS Feed" href="https://guides.micronaut.io/latest/rss.xml" />
    <link rel="alternate" type="application/json" title="Micronaut Guides JSON Feed" href="https://guides.micronaut.io/latest/feed.json" />
    <link href="coderay.css" rel="stylesheet" />
    <link href="guide.css" rel="stylesheet" />
    <script src="lunr.js"></script>
    <script src="guide.js"></script>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://guides.micronaut.io/latest/images/cards/micronaut-microservices-services-discover-consul.png"/>
    <meta name="twitter:creator" content="@micronautfw"/>
    <meta name="twitter:site" content="@micronautfw"/>
    <meta name="twitter:title" content="Consul and the Micronaut Framework - Microservices Service Discovery"/>
    <meta name="twitter:description" content="Use Consul service discovery to expose your Micronaut applications."/>
</head>
<body class="page-template page-template-page-sidebar page-template-page-sidebar-php page page-parent guide">

<header id="header">

    <div class="container">

        <nav class="navbar navbar-expand-lg navbar-dark">

            <button class="collapsed" type="button" data-toggle="collapse" data-target="#nav" aria-expanded="false">
                <span></span>
            </button>

            <a class="navbar-brand" href="https://micronaut.io">
                <img src="https://micronaut.io/wp-content/uploads/2020/11/MIcronautLogo_Horizontal.svg" alt="Micronaut framework"/>
            </a>

            <div class="collapse navbar-collapse" id="nav">

                <ul class="navbar-nav ml-auto">

                    <li id="menu-item-2865" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2865 nav-item"><a href="https://micronaut.io/download/" class="nav-link">Download</a></li>
                    <li id="menu-item-2868" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-has-children menu-item-2868 dropdown nav-item"><a href="https://micronaut.io/learn/" class="nav-link dropdown-toggle" data-toggle="dropdown">Learn</a><ul class="dropdown-menu">
                        <li id="menu-item-4943" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4943"><a href="https://micronaut.io/learn/" class="dropdown-item">Overview</a></li>
                        <li id="menu-item-5111" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-5111"><a href="https://docs.micronaut.io/index.html" class="dropdown-item">User Documentaton</a></li>
                        <li id="menu-item-4510" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4510"><a href="https://micronaut.io/guides/" class="dropdown-item">Guides</a></li>
                        <li id="menu-item-2896" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2896"><a href="https://micronaut.io/category/microcast/" class="dropdown-item">Microcasts</a></li>
                        <li id="menu-item-2897" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-2897"><a href="https://micronaut.io/category/webinar/" class="dropdown-item">Webinars</a></li>
                        <li id="menu-item-2871" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2871"><a href="https://micronaut.io/professional-training/" class="dropdown-item">Professional Training</a></li>
                        <li id="menu-item-6526" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-6526"><a href="https://micronaut-projects.github.io/micronaut-guides-mn3/latest/" class="dropdown-item">Guides for Micronaut Framework 3</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2878" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2878 dropdown nav-item"><a href="https://micronaut.io/resources/" class="nav-link dropdown-toggle" data-toggle="dropdown">Resources</a><ul class="dropdown-menu">
                        <li id="menu-item-4999" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4999"><a href="https://micronaut.io/upcoming-events/" class="dropdown-item">Upcoming Events</a></li>
                        <li id="menu-item-2879" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2879"><a href="https://micronaut.io/blog/" class="dropdown-item">Blog</a></li>
                        <li id="menu-item-6478" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6478"><a href="https://micronaut.io/category/release-announcements/" class="dropdown-item">Releases</a></li>
                        <li id="menu-item-6715" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6715"><a href="https://micronaut.io/category/security-announcements/" class="dropdown-item">Security Announcements</a></li>
                        <li id="menu-item-4499" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-4499"><a href="https://micronautpodcast.com/" class="dropdown-item">Podcast</a></li>
                        <li id="menu-item-5798" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-5798"><a href="https://micronaut.io/support/" class="dropdown-item">Commercial Support</a></li>
                        <li id="menu-item-4186" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-4186"><a href="https://micronaut.io/resources/community-support/" class="dropdown-item">Community Support</a></li>
                        <li id="menu-item-2882" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2882"><a href="https://micronaut.io/faq/" class="dropdown-item">FAQ</a></li>
                        <li id="menu-item-2883" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2883"><a href="https://micronaut.io/contact/" class="dropdown-item">Contact</a></li>
                        <li id="menu-item-6479" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-6479"><a href="https://micronaut.io/micronaut-success-stories/" class="dropdown-item">Micronaut Success Stories</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2872" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-has-children menu-item-2872 dropdown nav-item"><a href="https://micronaut.io/foundation/" class="nav-link dropdown-toggle" data-toggle="dropdown">Foundation</a><ul class="dropdown-menu">
                        <li id="menu-item-2877" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2877"><a href="https://micronaut.io/foundation/" class="dropdown-item">Overview</a></li>
                        <li id="menu-item-2874" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2874"><a href="https://micronaut.io/foundation/corporate-sponsorship/" class="dropdown-item">Corporate Sponsorship</a></li>
                        <li id="menu-item-2873" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2873"><a href="https://micronaut.io/foundation/community-sponsorship/" class="dropdown-item">Community Sponsorship</a></li>
                        <li id="menu-item-2876" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2876"><a href="https://micronaut.io/foundation/sponsors/" class="dropdown-item">Sponsors</a></li>
                        <li id="menu-item-3838" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-3838"><a href="https://micronaut.io/meeting-minutes/" class="dropdown-item">Meeting Minutes</a></li>
                    </ul>
                    </li>
                    <li id="menu-item-2884" class="action menu-item menu-item-type-custom menu-item-object-custom menu-item-2884 nav-item"><a target="_blank" rel="noopener" href="https://micronaut.io/launch/" class="nav-link">Launch</a></li>

                </ul>

            </div>

        </nav>

    </div>
</header>

<div style="background: #fff;padding-top: 20px;padding-bottom: 20px;">
    <div class="container" style="clear: both;">
        <fieldset style="float: right;">
            <input type="search" id="search-form-query"/>
            <input type="submit" onclick="search()" value="Search">
            <input type="submit" onclick="resetSearch()" value="Reset">
        </fieldset>
    </div>
    <div class="container" style="clear: both;margin-top: -20px;">
        <div class="guide-list" id="searchResults">
        </div>
    </div>
</div>
<div id="breadcrumbs"><div class="container"><a href="https://micronaut.io/">Home</a> » <a href="./index.html">Guides</a> » <a href="micronaut-microservices-services-discover-consul.html">Consul and the Micronaut Framework - Microservices Service Discovery</a> » <span class="breadcrumb_last" aria-current="page">maven | groovy</span></div></div><!-- .breadcrumbs -->
<main id="main">
    <div class="container">
        <div class="row">
            <div class="col-md-4">

                <div class="toc">
                    <div class="inner">
                        <h1 class="title title_large first-word-bold first-word-break">Table of Contents</h1>
                        <div class="underline"></div>
                        
<ul class="sectlevel1">
<li><a href="#getting-started">1. Getting Started</a></li>
<li><a href="#what-you-will-need">2. What you will need</a></li>
<li><a href="#solution">3. Solution</a></li>
<li><a href="#writing-the-app">4. Writing the App</a>
<ul class="sectlevel2">
<li><a href="#catalogue-microservice">4.1. Catalogue Microservice</a></li>
<li><a href="#inventory-microservice">4.2. Inventory Microservice</a></li>
<li><a href="#recommendation-microservice">4.3. Recommendation Microservice</a></li>
<li><a href="#running-the-application">4.4. Running the application</a></li>
</ul>
</li>
<li><a href="#consul-and-the-micronaut-framework">5. Consul and the Micronaut framework</a>
<ul class="sectlevel2">
<li><a href="#install-consul-via-docker">5.1. Install Consul via Docker</a></li>
<li><a href="#book-catalogue">5.2. Book Catalogue</a></li>
<li><a href="#book-inventory">5.3. Book Inventory</a></li>
<li><a href="#book-recommendation">5.4. Book Recommendation</a></li>
<li><a href="#running-the-app">5.5. Running the App</a></li>
</ul>
</li>
<li><a href="#next-steps">6. Next Steps</a></li>
<li><a href="#help-with-the-micronaut-framework">7. Help with the Micronaut Framework</a></li>
<li><a href="#license">8. License</a></li>
</ul>

                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <h1>Consul and the Micronaut Framework - Microservices Service Discovery</h1>
                <div class="underline"></div>
<div class="sect1">
<div class="sectionbody">

<div class="paragraph">
<p>Use Consul service discovery to expose your Micronaut applications.</p>
</div>
<div class="paragraph">
<p>Authors: Sergio del Amo</p>
</div>
<div class="paragraph">
<p>Micronaut Version: 4.9.1</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-started">1. Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this guide, we will create three microservices and register them with <a href="https://www.consul.io">Consul</a> Service discovery.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Consul is a distributed service mesh to connect, secure, and configure services across any runtime platform and public or private cloud</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>You will discover how the Micronaut framework eases Consul integration.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-you-will-need">2. What you will need</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To complete this guide, you will need the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some time on your hands</p>
</li>
<li>
<p>A decent text editor or IDE (e.g. <a href="https://guides.micronaut.io/latest/micronaut-intellij-idea-ide-setup.html">IntelliJ IDEA</a>)</p>
</li>
<li>
<p>JDK 21 or greater installed with <code>JAVA_HOME</code> <a href="https://www.baeldung.com/java-home-on-windows-7-8-10-mac-os-x-linux">configured appropriately</a></p>
</li>
</ul>
</div>
</div>
</div>
</div></div><div class="row"><div class="col-md-12"><div class="sect1">
<h2 id="solution">3. Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We recommend that you follow the instructions in the next sections and create the application step by step. However, you can go right to the <strong>completed example</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="micronaut-microservices-services-discover-consul-maven-groovy.zip">Download</a> and unzip the source</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-the-app">4. Writing the App</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s describe the microservices you will build through the guide.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>bookcatalogue</code> - It returns a list of books. It uses a domain consisting of a book name and ISBN.</p>
</li>
<li>
<p><code>bookinventory</code> - It exposes an endpoint to check whether a book has sufficient stock to fulfil an order.  It uses a domain consisting of a stock level and ISBN.</p>
</li>
<li>
<p><code>bookrecommendation</code> - It consumes previous services and exposes an endpoint which recommends book names which are in stock.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Initially we will hard-code the addresses where the different services are in the <code>bookcatalogue</code> service.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/hardcoded.svg" alt="hardcoded">
</div>
</div>
<div class="paragraph">
<p>As shown in the previous image, the <code>bookcatalogue</code> hardcodes references to its collaborators.</p>
</div>
<div class="paragraph">
<p>In the second part of this guide we will use a discovery service.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>About <em>registration patterns</em></p>
</div>
<div class="paragraph">
<p>We will use a <strong>self‑registration pattern</strong>. Thus, each service instance is responsible for registering and
deregistering itself with the service registry.
Also, if required, a service instance sends heartbeat requests to prevent its registration from expiring.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Services register when they start up:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/discovery-service-registration.svg" alt="discovery service registration">
</div>
</div>
<div class="paragraph">
<p>We will use <strong>client‑side service discovery</strong>, clients query the service registry,
select an available instance, and make a request.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/discovery-service-flow.svg" alt="discovery service flow">
</div>
</div>
<div class="paragraph">
<p><a href="https://guides.micronaut.io/latest/micronaut-intellij-idea-ide-setup.html">Setup IntelliJ IDEA to develop Micronaut Applications</a>.</p>
</div>
<div class="sect2">
<h3 id="catalogue-microservice">4.1. Catalogue Microservice</h3>
<div class="paragraph">
<p>Create the <code>bookcatalogue</code> microservice using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mn create-app --features=discovery-consul,management,graalvm example.micronaut.bookcatalogue --build=maven --lang=groovy</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle with the <a href="https://docs.gradle.org/current/userguide/kotlin_dsl.html">Kotlin DSL</a> is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.<br/> If you don&#8217;t specify the <code>--test</code> argument, JUnit is used for Java and Kotlin, and Spock is used for Groovy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add the <code>discovery-consul</code>, <code>management</code>, and <code>graalvm</code> features.</p>
</div>
<div class="paragraph">
<p>The previous command creates a directory named <code>bookcatalogue</code> and a Micronaut application inside it with default package <code>example.micronaut</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have an existing Micronaut application and want to add the functionality described here, you can view the dependency and configuration changes from the specified features, and apply those changes to your application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://micronaut.io/launch?features=yaml&amp;features=discovery-consul&amp;features=management&amp;features=serialization-jackson&amp;lang=GROOVY&amp;build=MAVEN&amp;test=SPOCK&amp;name=bookcatalogue&amp;type=DEFAULT&amp;package=example.micronaut&amp;activity=diff" target="_blank" rel="noopener">Diff</a></p>
</div>
<div class="paragraph">
<p>Create a <code>BooksController</code> class to handle incoming HTTP requests into the <code>bookcatalogue</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/src/main/groovy/example/micronaut/BooksController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Controller</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>

<span class="annotation">@CompileStatic</span>
<span class="annotation">@Controller</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">class</span> <span class="class">BooksController</span> {

    <span class="annotation">@Get</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; index() {
        [
            <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1491950358</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Building Microservices</span><span class="delimiter">&quot;</span></span>),
            <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1680502395</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Release It!</span><span class="delimiter">&quot;</span></span>),
            <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">0321601912</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Continuous Delivery:</span><span class="delimiter">&quot;</span></span>)
        ]
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>index</code> method to an HTTP GET request on <code>/books</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous controller responds a <code>List&lt;Book&gt;</code>. Create the <code>Book</code> POJO:</p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/src/main/groovy/example/micronaut/Book.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">groovy.transform.EqualsAndHashCode</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.Creator</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.NonNull</span>
<span class="keyword">import</span> <span class="include">io.micronaut.serde.annotation.Serdeable</span>

<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotBlank</span>

<span class="annotation">@CompileStatic</span>
<span class="annotation">@EqualsAndHashCode</span>
<span class="annotation">@Serdeable</span>
<span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@NonNull</span>
    <span class="annotation">@NotBlank</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> isbn

    <span class="annotation">@NonNull</span>
    <span class="annotation">@NotBlank</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> name

    <span class="annotation">@Creator</span>
    <span class="predefined-type">Book</span>(<span class="annotation">@NonNull</span> <span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> isbn,
         <span class="annotation">@NonNull</span> <span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.isbn = isbn
        <span class="local-variable">this</span>.name = name
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Write a test:</p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/src/test/groovy/example/micronaut/BooksControllerSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">io.micronaut.core.type.Argument</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpRequest</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.HttpClient</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.annotation.Client</span>
<span class="keyword">import</span> <span class="include">io.micronaut.test.extensions.spock.annotation.MicronautTest</span>
<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@MicronautTest</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">class</span> <span class="class">BooksControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="annotation">@Inject</span>
    <span class="annotation">@Client</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>)
    HttpClient client <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">it is possible to retrieve books</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>:
        HttpRequest request = HttpRequest.GET(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; books = client.toBlocking().retrieve(request, Argument.listOf(<span class="predefined-type">Book</span>)) <i class="conum" data-value="4"></i><b>(4)</b>

        <span class="key">then</span>:
        books.size() == <span class="integer">3</span>
        books.contains(<span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1491950358</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Building Microservices</span><span class="delimiter">&quot;</span></span>))
        books.contains(<span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1680502395</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Release It!</span><span class="delimiter">&quot;</span></span>))
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Annotate the class with <code>@MicronautTest</code> so the Micronaut framework will initialize the application context and the embedded server. <a href="https://micronaut-projects.github.io/micronaut-test/latest/guide/">More info</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject the <code>HttpClient</code> bean and point it to the embedded server.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creating HTTP Requests is easy thanks to the Micronaut framework fluid API.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Parse easily JSON into Java objects.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Edit <code>application.yml</code></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<a href="https://micronaut.io/2023/02/19/micronaut-framework-4-0-and-snakeyaml-transitive-dependency/">Since Micronaut Framework 4.0, to use YAML configuration, you have to add the YAML dependency</a>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">bookcatalogue </span></span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the application name. The application name will be used by the discovery service.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Modify the <code>Application</code> class to use <code>dev</code> as a default environment:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The Micronaut framework supports the concept of one or many default environments. A default environment is one that is only applied if no other environments are explicitly specified or deduced.</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/src/main/groovy/example/micronaut/Application.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.runtime.Micronaut</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.context.env.Environment.DEVELOPMENT</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">Application</span> {

    <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        Micronaut.build(args)
                .mainClass(Application)
                .defaultEnvironments(DEVELOPMENT)
                .start()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/application-dev.yml</code>. The Micronaut framework applies this configuration file only for the <code>dev</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/src/main/resources/application-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">server</span>:
    <span class="key">port</span>: <span class="string"><span class="content">8081 </span></span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the application to listen on port 8081</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <code>application-test.yml</code> which is used in the test environment:</p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/src/test/resources/application-test.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">consul</span>:
  <span class="key">client</span>:
    <span class="key">registration</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">false</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the unit test:</p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./mvnw test</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="inventory-microservice">4.2. Inventory Microservice</h3>
<div class="paragraph">
<p>Create the <code>bookinventory</code> microservice using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mn create-app --features=discovery-consul,management,graalvm example.micronaut.bookinventory --build=maven --lang=groovy</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle with the <a href="https://docs.gradle.org/current/userguide/kotlin_dsl.html">Kotlin DSL</a> is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.<br/> If you don&#8217;t specify the <code>--test</code> argument, JUnit is used for Java and Kotlin, and Spock is used for Groovy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add the <code>discovery-consul</code>, <code>management</code>, and <code>graalvm</code> features.</p>
</div>
<div class="paragraph">
<p>The previous command creates a directory named <code>bookinventory</code> and a Micronaut application inside it with default package <code>example.micronaut</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have an existing Micronaut application and want to add the functionality described here, you can view the dependency and configuration changes from the specified features, and apply those changes to your application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://micronaut.io/launch?features=yaml&amp;features=discovery-consul&amp;features=management&amp;features=serialization-jackson&amp;lang=GROOVY&amp;build=MAVEN&amp;test=SPOCK&amp;name=bookinventory&amp;type=DEFAULT&amp;package=example.micronaut&amp;activity=diff" target="_blank" rel="noopener">Diff</a></p>
</div>
<div class="paragraph">
<p>Create a Controller:</p>
</div>
<div class="listingblock">
<div class="title">bookinventory/src/main/groovy/example/micronaut/BooksController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Controller</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Produces</span>

<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotBlank</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.http.MediaType.TEXT_PLAIN</span>

<span class="annotation">@CompileStatic</span>
<span class="annotation">@Controller</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">class</span> <span class="class">BooksController</span> {

    <span class="annotation">@Produces</span>(TEXT_PLAIN) <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/stock/{isbn}</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="predefined-type">Boolean</span> stock(<span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> isbn) {
        bookInventoryByIsbn(isbn).map(bi -&gt; bi.stock &gt; <span class="integer">0</span>).orElse(<span class="predefined-constant">null</span>)
    }

    <span class="directive">private</span> Optional&lt;BookInventory&gt; bookInventoryByIsbn(<span class="predefined-type">String</span> isbn) {
        <span class="keyword">if</span> (isbn == <span class="string"><span class="delimiter">&quot;</span><span class="content">1491950358</span><span class="delimiter">&quot;</span></span>) {
            <span class="keyword">return</span> Optional.of(<span class="keyword">new</span> BookInventory(isbn, <span class="integer">4</span>))
        }
        <span class="keyword">if</span> (isbn == <span class="string"><span class="delimiter">&quot;</span><span class="content">1680502395</span><span class="delimiter">&quot;</span></span>) {
            <span class="keyword">return</span> Optional.of(<span class="keyword">new</span> BookInventory(isbn, <span class="integer">0</span>))
        }
        Optional.empty()
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/books</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>By default, <code>Content-Type</code> of a controller response is <code>application/json</code> : override this with <code>text/plain</code> since we are returning a String, not a JSON object.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>index</code> method to an HTTP GET request on <code>/books/stock/{isbn}</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the POJO used by the controller:</p>
</div>
<div class="listingblock">
<div class="title">bookinventory/src/main/groovy/example/micronaut/BookInventory.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">groovy.transform.EqualsAndHashCode</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.NonNull</span>
<span class="keyword">import</span> <span class="include">io.micronaut.serde.annotation.Serdeable</span>

<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotBlank</span>

<span class="annotation">@CompileStatic</span>
<span class="annotation">@EqualsAndHashCode</span>
<span class="annotation">@Serdeable</span>
<span class="type">class</span> <span class="class">BookInventory</span> {

    <span class="annotation">@NonNull</span>
    <span class="annotation">@NotBlank</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> isbn

    <span class="directive">final</span> <span class="type">int</span> stock

    BookInventory(<span class="annotation">@NonNull</span> <span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> isbn,
                  <span class="type">int</span> stock) {
        <span class="local-variable">this</span>.isbn = isbn
        <span class="local-variable">this</span>.stock = stock
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Write a test:</p>
</div>
<div class="listingblock">
<div class="title">bookinventory/src/test/groovy/example/micronaut/BooksControllerSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpRequest</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpResponse</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.HttpClient</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.annotation.Client</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.exceptions.HttpClientResponseException</span>
<span class="keyword">import</span> <span class="include">io.micronaut.test.extensions.spock.annotation.MicronautTest</span>
<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.http.HttpStatus.NOT_FOUND</span>
<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.http.HttpStatus.OK</span>

<span class="annotation">@MicronautTest</span>
<span class="type">class</span> <span class="class">BooksControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="annotation">@Inject</span>
    <span class="annotation">@Client</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>)
    HttpClient httpClient

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">for a book with inventory true is returned</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>:
        HttpResponse&lt;<span class="predefined-type">Boolean</span>&gt; rsp = httpClient.toBlocking().exchange(
                HttpRequest.GET(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books/stock/1491950358</span><span class="delimiter">&quot;</span></span>), <span class="predefined-type">Boolean</span>)

        <span class="key">then</span>:
        rsp.status() == OK
        rsp.body()
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">for an invalid ISBN 404 is returned</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>:
        httpClient.toBlocking().exchange(HttpRequest.GET(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books/stock/XXXXX</span><span class="delimiter">&quot;</span></span>), <span class="predefined-type">Boolean</span>)

        <span class="key">then</span>:
        HttpClientResponseException e = thrown()
        e.response.status == NOT_FOUND
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit <code>application.yml</code></p>
</div>
<div class="listingblock">
<div class="title">bookinventory/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">bookinventory </span></span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the application name. The name will be used later in the guide.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Modify the <code>Application</code> class to use <code>dev</code> as a default environment:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The Micronaut framework supports the concept of one or many default environments. A default environment is one that is only applied if no other environments are explicitly specified or deduced.</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="title">bookinventory/src/main/groovy/example/micronaut/Application.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.runtime.Micronaut</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.context.env.Environment.DEVELOPMENT</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">Application</span> {

    <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        Micronaut.build(args)
                .mainClass(Application)
                .defaultEnvironments(DEVELOPMENT)
                .start()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/application-dev.yml</code>. The Micronaut framework applies this configuration file only for the <code>dev</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">bookinventory/src/main/resources/application-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">server</span>:
    <span class="key">port</span>: <span class="string"><span class="content">8082 </span></span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the application to listen on port 8082</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <code>application-test.yml</code> which is used in the test environment:</p>
</div>
<div class="listingblock">
<div class="title">bookinventory/src/test/resources/application-test.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">consul</span>:
  <span class="key">client</span>:
    <span class="key">registration</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">false</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the unit test:</p>
</div>
<div class="listingblock">
<div class="title">bookinventory</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./mvnw test</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="recommendation-microservice">4.3. Recommendation Microservice</h3>
<div class="paragraph">
<p>Create the <code>bookrecommendation</code> microservice using the <a href="https://docs.micronaut.io/latest/guide/#cli">Micronaut Command Line Interface</a> or with <a href="https://launch.micronaut.io">Micronaut Launch</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mn create-app --features=discovery-consul,management,reactor,graalvm example.micronaut.bookrecommendation --build=maven --lang=groovy</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you don&#8217;t specify the <code>--build</code> argument, Gradle with the <a href="https://docs.gradle.org/current/userguide/kotlin_dsl.html">Kotlin DSL</a> is used as the build tool. <br/> If you don&#8217;t specify the <code>--lang</code> argument, Java is used as the language.<br/> If you don&#8217;t specify the <code>--test</code> argument, JUnit is used for Java and Kotlin, and Spock is used for Groovy.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you use Micronaut Launch, select Micronaut Application as application type and add the <code>discovery-consul</code>, <code>management</code>, <code>reactor</code>, and <code>graalvm</code> features.</p>
</div>
<div class="paragraph">
<p>The previous command creates a directory named <code>bookrecommendation</code> and a Micronaut application inside it with default package <code>example.micronaut</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have an existing Micronaut application and want to add the functionality described here, you can view the dependency and configuration changes from the specified features, and apply those changes to your application.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><a href="https://micronaut.io/launch?features=yaml&amp;features=discovery-consul&amp;features=management&amp;features=reactor&amp;features=serialization-jackson&amp;features=http-client&amp;features=retry&amp;lang=GROOVY&amp;build=MAVEN&amp;test=SPOCK&amp;name=bookrecommendation&amp;type=DEFAULT&amp;package=example.micronaut&amp;activity=diff" target="_blank" rel="noopener">Diff</a></p>
</div>
<div class="paragraph">
<p>Create an interface to map operations with <code>bookcatalogue</code>, and a Micronaut Declarative HTTP Client to consume it.</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/groovy/example/micronaut/BookCatalogueOperations.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">org.reactivestreams.Publisher</span>

<span class="type">interface</span> BookCatalogueOperations {
    Publisher&lt;<span class="predefined-type">Book</span>&gt; findAll()
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/groovy/example/micronaut/BookCatalogueClient.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut


<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.annotation.Client</span>
<span class="keyword">import</span> <span class="include">io.micronaut.retry.annotation.Recoverable</span>
<span class="keyword">import</span> <span class="include">org.reactivestreams.Publisher</span>

<span class="annotation">@Client</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8081</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Recoverable</span>(api = BookCatalogueOperations)

<span class="type">interface</span> BookCatalogueClient <span class="directive">extends</span> BookCatalogueOperations {

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books</span><span class="delimiter">&quot;</span></span>)
    Publisher&lt;<span class="predefined-type">Book</span>&gt; findAll()
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The client returns a POJO. Create it in the <code>bookrecommendation</code>:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/groovy/example/micronaut/Book.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">groovy.transform.EqualsAndHashCode</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.NonNull</span>
<span class="keyword">import</span> <span class="include">io.micronaut.serde.annotation.Serdeable</span>

<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotBlank</span>

<span class="annotation">@CompileStatic</span>
<span class="annotation">@EqualsAndHashCode</span>
<span class="annotation">@Serdeable</span>
<span class="type">class</span> <span class="class">Book</span> {

    <span class="annotation">@NonNull</span>
    <span class="annotation">@NotBlank</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> isbn

    <span class="annotation">@NonNull</span>
    <span class="annotation">@NotBlank</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> name

    <span class="predefined-type">Book</span>(<span class="annotation">@NonNull</span> <span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> isbn,
         <span class="annotation">@NonNull</span> <span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.isbn = isbn
        <span class="local-variable">this</span>.name = name
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create an interface to map operations with <code>bookinventory</code>, and a Micronaut Declarative HTTP Client to consume it.</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/groovy/example/micronaut/BookInventoryOperations.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.NonNull</span>
<span class="keyword">import</span> <span class="include">reactor.core.publisher.Mono</span>

<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotBlank</span>

<span class="type">interface</span> BookInventoryOperations {
    Mono&lt;<span class="predefined-type">Boolean</span>&gt; stock(<span class="annotation">@NonNull</span> <span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> isbn)
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/groovy/example/micronaut/BookInventoryClient.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut


<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.NonNull</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Consumes</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.annotation.Client</span>
<span class="keyword">import</span> <span class="include">io.micronaut.retry.annotation.Recoverable</span>
<span class="keyword">import</span> <span class="include">reactor.core.publisher.Mono</span>

<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotBlank</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.http.MediaType.TEXT_PLAIN</span>

<span class="annotation">@Client</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">http://localhost:8082</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Recoverable</span>(api = BookInventoryOperations)

<span class="type">interface</span> BookInventoryClient <span class="directive">extends</span> BookInventoryOperations {

    <span class="annotation">@Consumes</span>(TEXT_PLAIN)
    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books/stock/{isbn}</span><span class="delimiter">&quot;</span></span>)
    Mono&lt;<span class="predefined-type">Boolean</span>&gt; stock(<span class="annotation">@NonNull</span> <span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> isbn)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use <code>@Client</code> to use <a href="https://docs.micronaut.io/latest/guide/#clientAnnotation">declarative HTTP Clients</a>. You can annotate interfaces or abstract classes. You can use the <code>id</code> member to provide a service identifier or specify the URL directly as the annotation&#8217;s value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a Controller which injects both clients.</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/groovy/example/micronaut/BookController.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Controller</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>
<span class="keyword">import</span> <span class="include">org.reactivestreams.Publisher</span>
<span class="keyword">import</span> <span class="include">reactor.core.publisher.Flux</span>

<span class="annotation">@CompileStatic</span>
<span class="annotation">@Controller</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="type">class</span> <span class="class">BookController</span> {

    <span class="directive">private</span> <span class="directive">final</span> BookCatalogueOperations bookCatalogueOperations
    <span class="directive">private</span> <span class="directive">final</span> BookInventoryOperations bookInventoryOperations

    BookController(BookCatalogueOperations bookCatalogueOperations,
                   BookInventoryOperations bookInventoryOperations) { <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="local-variable">this</span>.bookCatalogueOperations = bookCatalogueOperations
        <span class="local-variable">this</span>.bookInventoryOperations = bookInventoryOperations
    }

    <span class="annotation">@Get</span> <i class="conum" data-value="3"></i><b>(3)</b>
    Publisher&lt;BookRecommendation&gt; index() {
        Flux.from(bookCatalogueOperations.findAll())
                .flatMap(b -&gt; Flux.from(bookInventoryOperations.stock(b.isbn))
                        .filter(<span class="predefined-type">Boolean</span>::booleanValue)
                        .map(rsp -&gt; b)
                ).map(book -&gt; <span class="keyword">new</span> BookRecommendation(book.name))
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The class is defined as a controller with the <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Controller.html">@Controller</a> annotation mapped to the path <code>/books</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Clients are injected via constructor injection</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <a href="https://docs.micronaut.io/latest/api/io/micronaut/http/annotation/Get.html">@Get</a> annotation maps the <code>index</code> method to an HTTP GET request on <code>/books</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The previous controller returns a <code>Publisher&lt;BookRecommendation&gt;</code>. Create the <code>BookRecommendation</code> POJO:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/groovy/example/micronaut/BookRecommendation.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">groovy.transform.EqualsAndHashCode</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.NonNull</span>
<span class="keyword">import</span> <span class="include">io.micronaut.serde.annotation.Serdeable</span>

<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotBlank</span>

<span class="annotation">@CompileStatic</span>
<span class="annotation">@EqualsAndHashCode</span>
<span class="annotation">@Serdeable</span>
<span class="type">class</span> <span class="class">BookRecommendation</span> {

    <span class="annotation">@NonNull</span>
    <span class="annotation">@NotBlank</span>
    <span class="directive">final</span> <span class="predefined-type">String</span> name

    BookRecommendation(<span class="annotation">@NonNull</span> <span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.name = name
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>BookCatalogueClient</code> and <code>BookInventoryClient</code> will fail to consume the <code>bookcatalogue</code> and <code>bookinventory</code> during the tests phase.</p>
</div>
<div class="paragraph">
<p>Using the <a href="https://docs.micronaut.io/latest/guide/#clientFallback">@Fallback</a> annotation you can declare a fallback implementation of a client that will be picked up and used once all possible retries have been exhausted</p>
</div>
<div class="paragraph">
<p>Create <code>@Fallback</code> alternatives in the <code>test</code> classpath.</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/test/groovy/example/micronaut/BookInventoryClientStub.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">io.micronaut.context.annotation.Requires</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.NonNull</span>
<span class="keyword">import</span> <span class="include">io.micronaut.retry.annotation.Fallback</span>
<span class="keyword">import</span> <span class="include">jakarta.inject.Singleton</span>
<span class="keyword">import</span> <span class="include">reactor.core.publisher.Mono</span>

<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotBlank</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.context.env.Environment.TEST</span>

<span class="annotation">@Requires</span>(env = TEST) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Fallback</span>
<span class="annotation">@Singleton</span>
<span class="type">class</span> <span class="class">BookInventoryClientStub</span> <span class="directive">implements</span> BookInventoryOperations {

    <span class="annotation">@Override</span>
    Mono&lt;<span class="predefined-type">Boolean</span>&gt; stock(<span class="annotation">@NonNull</span> <span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> isbn) {
        <span class="keyword">if</span> (isbn == <span class="string"><span class="delimiter">&quot;</span><span class="content">1491950358</span><span class="delimiter">&quot;</span></span>) {
            <span class="keyword">return</span> Mono.just(<span class="predefined-constant">true</span>) <i class="conum" data-value="2"></i><b>(2)</b>
        }
        <span class="keyword">if</span> (isbn == <span class="string"><span class="delimiter">&quot;</span><span class="content">1680502395</span><span class="delimiter">&quot;</span></span>) {
            <span class="keyword">return</span> Mono.just(<span class="predefined-constant">false</span>) <i class="conum" data-value="3"></i><b>(3)</b>
        }
        Mono.empty() <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Make this fallback class to be effective only when the Micronaut environment <em>TEST</em> is active</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Here we arbitrarily decided that if everything else fails, that book&#8217;s <code>stock</code> would be true</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Similarly, we decided that other book&#8217;s <code>stock</code> method would be false</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Finally, any other book will have their <code>stock</code> method return an empty value</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/test/groovy/example/micronaut/BookCatalogueClientStub.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">io.micronaut.context.annotation.Requires</span>
<span class="keyword">import</span> <span class="include">io.micronaut.retry.annotation.Fallback</span>
<span class="keyword">import</span> <span class="include">jakarta.inject.Singleton</span>
<span class="keyword">import</span> <span class="include">org.reactivestreams.Publisher</span>
<span class="keyword">import</span> <span class="include">reactor.core.publisher.Flux</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.context.env.Environment.TEST</span>

<span class="annotation">@Requires</span>(env = TEST)
<span class="annotation">@Fallback</span>
<span class="annotation">@Singleton</span>
<span class="type">class</span> <span class="class">BookCatalogueClientStub</span> <span class="directive">implements</span> BookCatalogueOperations {

    <span class="annotation">@Override</span>
    Publisher&lt;<span class="predefined-type">Book</span>&gt; findAll() {
        <span class="predefined-type">Book</span> buildingMicroservices = <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1491950358</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Building Microservices</span><span class="delimiter">&quot;</span></span>)
        <span class="predefined-type">Book</span> releaseIt = <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">1680502395</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Release It!</span><span class="delimiter">&quot;</span></span>)
        Flux.just(buildingMicroservices, releaseIt)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Write a test:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/test/groovy/example/micronaut/BookControllerSpec.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">io.micronaut.http.HttpRequest</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.HttpClient</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.annotation.Client</span>
<span class="keyword">import</span> <span class="include">io.micronaut.test.extensions.spock.annotation.MicronautTest</span>
<span class="keyword">import</span> <span class="include">jakarta.inject.Inject</span>
<span class="keyword">import</span> <span class="include">io.micronaut.core.type.Argument</span>
<span class="keyword">import</span> <span class="include">spock.lang.IgnoreIf</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>

<span class="annotation">@MicronautTest</span>
<span class="type">class</span> <span class="class">BookControllerSpec</span> <span class="directive">extends</span> Specification {

    <span class="annotation">@Inject</span>
    <span class="annotation">@Client</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>)
    HttpClient client

    <span class="annotation">@IgnoreIf</span>({env[<span class="string"><span class="delimiter">'</span><span class="content">CI</span><span class="delimiter">'</span></span>] <span class="keyword">as</span> <span class="type">boolean</span>})
    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">retrieve books</span><span class="delimiter">&quot;</span></span>() {
        <span class="key">when</span>:
        <span class="predefined-type">List</span>&lt;BookRecommendation&gt; books = client.toBlocking().retrieve(HttpRequest.GET(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books</span><span class="delimiter">&quot;</span></span>), Argument.listOf(BookRecommendation))

        <span class="key">then</span>:
        books.size() == <span class="integer">1</span>
        books[<span class="integer">0</span>].name == <span class="string"><span class="delimiter">&quot;</span><span class="content">Building Microservices</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit <code>application.yml</code></p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">application</span>:
    <span class="key">name</span>: <span class="string"><span class="content">bookrecommendation </span></span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the application name. The name will be used later in the guide.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Modify the <code>Application</code> class to use <code>dev</code> as a default environment:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The Micronaut framework supports the concept of one or many default environments. A default environment is one that is only applied if no other environments are explicitly specified or deduced.</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/groovy/example/micronaut/Application.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut

<span class="keyword">import</span> <span class="include">groovy.transform.CompileStatic</span>
<span class="keyword">import</span> <span class="include">io.micronaut.runtime.Micronaut</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.context.env.Environment.DEVELOPMENT</span>

<span class="annotation">@CompileStatic</span>
<span class="type">class</span> <span class="class">Application</span> {

    <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        Micronaut.build(args)
                .mainClass(Application)
                .defaultEnvironments(DEVELOPMENT)
                .start()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create <code>src/main/resources/application-dev.yml</code>. The Micronaut framework applies this configuration file only for the <code>dev</code> environment.</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/resources/application-dev.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">micronaut</span>:
  <span class="key">server</span>:
    <span class="key">port</span>: <span class="string"><span class="content">8080 </span></span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the application to listen on port 8080</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a file named <code>application-test.yml</code> which is used in the test environment:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/test/resources/application-test.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">consul</span>:
  <span class="key">client</span>:
    <span class="key">registration</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">false</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the unit test:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./mvnw test</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="running-the-application">4.4. Running the application</h3>
<div class="paragraph">
<p>Run <code>bookcatalogue</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./mvnw mn:run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8081</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run <code>bookinventory</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">bookinventory</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./mvnw mn:run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>14:31:13.104 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 506ms. Server Running: http://localhost:8082</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run <code>bookrecommendation</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./mvnw mn:run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>14:31:57.389 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 523ms. Server Running: http://localhost:8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can run a cURL command to test the whole application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl http://localhost:8080/books</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">[{<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Building Microservices</span><span class="delimiter">&quot;</span></span>}]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="consul-and-the-micronaut-framework">5. Consul and the Micronaut framework</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="install-consul-via-docker">5.1. Install Consul via Docker</h3>
<div class="paragraph">
<p>The quickest way to start using <a href="https://hub.docker.com/_/consul/">Consul is via Docker</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker run -p 8500:8500 consul</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively you can <a href="https://www.consul.io/docs/install">install and run a local Consul instance</a>.</p>
</div>
<div class="paragraph">
<p>The following screenshots show how to install/run Consul via <a href="https://kitematic.com">Kitematic</a>, a UI for Docker.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/kitematic-consul-1.png" alt="kitematic consul 1">
</div>
</div>
<div class="paragraph">
<p>Configure ports:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/kitematic-consul-2.png" alt="kitematic consul 2">
</div>
</div>
</div>
<div class="sect2">
<h3 id="book-catalogue">5.2. Book Catalogue</h3>
<div class="paragraph">
<p>Append to <code>bookcatalogue</code> service <code>application.yml</code> the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">consul</span>:
  <span class="key">client</span>:
    <span class="key">registration</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">defaultZone</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">${CONSUL_HOST:localhost}:${CONSUL_PORT:8500}</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This configuration registers a Micronaut application with Consul with minimal configuration. Discover a more complete list of configuration options at <a href="https://micronaut-projects.github.io/micronaut-discovery-client/latest/api/io/micronaut/discovery/consul/ConsulConfiguration.html">ConsulConfiguration</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="book-inventory">5.3. Book Inventory</h3>
<div class="paragraph">
<p>Modify the <code>application.yml</code> of the <code>bookinventory</code> application with the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">bookinventory/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">consul</span>:
  <span class="key">client</span>:
    <span class="key">registration</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">defaultZone</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">${CONSUL_HOST:localhost}:${CONSUL_PORT:8500}</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="book-recommendation">5.4. Book Recommendation</h3>
<div class="paragraph">
<p>Append to <code>bookrecommendation</code>.<code>application.yml</code> the following snippet:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/resources/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">consul</span>:
  <span class="key">client</span>:
    <span class="key">registration</span>:
      <span class="key">enabled</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">defaultZone</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">${CONSUL_HOST:localhost}:${CONSUL_PORT:8500}</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Modify <code>BookInventoryClient</code> and <code>BookCatalogueClient</code> to use the service id instead of a hard-coded URL.</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/groovy/example/micronaut/BookCatalogueClient.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut


<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.annotation.Client</span>
<span class="keyword">import</span> <span class="include">io.micronaut.retry.annotation.Recoverable</span>
<span class="keyword">import</span> <span class="include">org.reactivestreams.Publisher</span>

<span class="annotation">@Client</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">bookcatalogue</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Recoverable</span>(api = BookCatalogueOperations)

<span class="type">interface</span> BookCatalogueClient <span class="directive">extends</span> BookCatalogueOperations {

    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books</span><span class="delimiter">&quot;</span></span>)
    Publisher&lt;<span class="predefined-type">Book</span>&gt; findAll()
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the configuration value <code>micronaut.application.name</code> used in <code>bookcatalogue</code> as service <code>id</code>.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">bookrecommendation/src/main/groovy/example/micronaut/BookInventoryClient.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> example.micronaut


<span class="keyword">import</span> <span class="include">io.micronaut.core.annotation.NonNull</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Consumes</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.annotation.Get</span>
<span class="keyword">import</span> <span class="include">io.micronaut.http.client.annotation.Client</span>
<span class="keyword">import</span> <span class="include">io.micronaut.retry.annotation.Recoverable</span>
<span class="keyword">import</span> <span class="include">reactor.core.publisher.Mono</span>

<span class="keyword">import</span> <span class="include">jakarta.validation.constraints.NotBlank</span>

<span class="keyword">import</span> <span class="include">static</span> <span class="include">io.micronaut.http.MediaType.TEXT_PLAIN</span>

<span class="annotation">@Client</span>(id = <span class="string"><span class="delimiter">&quot;</span><span class="content">bookinventory</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@Recoverable</span>(api = BookInventoryOperations)

<span class="type">interface</span> BookInventoryClient <span class="directive">extends</span> BookInventoryOperations {

    <span class="annotation">@Consumes</span>(TEXT_PLAIN)
    <span class="annotation">@Get</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/books/stock/{isbn}</span><span class="delimiter">&quot;</span></span>)
    Mono&lt;<span class="predefined-type">Boolean</span>&gt; stock(<span class="annotation">@NonNull</span> <span class="annotation">@NotBlank</span> <span class="predefined-type">String</span> isbn)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the configuration value <code>micronaut.application.name</code> used in <code>bookinventory</code> as service <code>id</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="running-the-app">5.5. Running the App</h3>
<div class="paragraph">
<p>Run <code>bookcatalogue</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">bookcatalogue</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./gradlew run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>14:28:34.034 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 499ms. Server Running: http://localhost:8081
14:28:34.084 [nioEventLoopGroup-1-3] INFO  i.m.d.registration.AutoRegistration - Registered service [bookcatalogue] with Consul</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run <code>bookinventory</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">bookinventory</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./gradlew run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>14:31:13.104 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 506ms. Server Running: http://localhost:8082
14:31:13.154 [nioEventLoopGroup-1-3] INFO  i.m.d.registration.AutoRegistration - Registered service [bookinventory] with Consul</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run <code>bookrecommendation</code> microservice:</p>
</div>
<div class="listingblock">
<div class="title">bookrecommendation</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./gradlew run</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>14:31:57.389 [main] INFO  io.micronaut.runtime.Micronaut - Startup completed in 523ms. Server Running: http://localhost:8080
14:31:57.439 [nioEventLoopGroup-1-3] INFO  i.m.d.registration.AutoRegistration - Registered service [bookrecommendation] with Consul</code></pre>
</div>
</div>
<div class="paragraph">
<p>Consul comes with a HTML UI. Open <a href="http://localhost:8500/ui" class="bare">http://localhost:8500/ui</a> in your browser.</p>
</div>
<div class="paragraph">
<p>You will see the services registered in Consul:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/consului.png" alt="consului">
</div>
</div>
<div class="paragraph">
<p>You can run a cURL command to test the whole application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl http://localhost:8080/books</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">[{<span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Building Microservices</span><span class="delimiter">&quot;</span></span>}]</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="next-steps">6. Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Read more about <a href="https://docs.micronaut.io/latest/guide/#distributedConfigurationConsul">Consul support</a> in the Micronaut framework.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="help-with-the-micronaut-framework">7. Help with the Micronaut Framework</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <a href="https://micronaut.io/foundation/">Micronaut Foundation</a> sponsored the creation of this Guide. A variety of <a href="https://micronaut.io/commercial-support/">consulting and support services</a> are available.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="license">8. License</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All guides are released with an <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache license 2.0 license</a> for the code and a <a href="https://creativecommons.org/licenses/by/4.0/deed.en">Creative Commons Attribution 4.0</a> license for the writing and media (images&#8230;&#8203;).
</td>
</tr>
</table>
</div>

            </div>
        </div>
    </div>
</main>

<footer id="footer">
    <div class="container">

        <div class="row">
            <div class="col-sm-5 footer-left">

                <div id="text-14" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <a href="https://micronaut.io/foundation/"><img class="alignnone size-medium wp-image-3736" src="./images/micronaut_foundation_horizontal_white.svg" alt="Micronaut Foundation"/></a>
                        </p>
                    </div>
                </div>
            </div>
            <div class="col-sm-7 footer-right">

                <ul class="meta">

                    <li id="menu-item-2895" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2895">
                        <a href="https://micronaut.io/brand-guidelines/">Brand Guidelines</a>
                    </li>
                    <li id="menu-item-2894" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2894">
                        <a href="https://micronaut.io/community-guidelines/">Community Guidelines</a>
                    </li>
                    <li id="menu-item-3377" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-privacy-policy menu-item-3377">
                        <a href="https://micronaut.io/privacy-policy/">Privacy Policy</a>
                    </li>

                </ul>

                <div id="nav_menu-2" class="widget widget_nav_menu">
                    <div class="menu-links-container">
                        <ul id="menu-links" class="menu">
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronautpodcast.com"><i class="fa fa-podcast"><span class="sr-only">Podcast</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="https://micronaut.io/feed/rss/"><i class="fa fa-feed"><span class="sr-only">Feed</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom "><a href="mailto:info@micronaut.io"><i class="fas fa-envelope"><span class="sr-only">Mail</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://twitter.com/micronautfw"><i class="fab fa-twitter"><span class="sr-only">Twitter</span></i></a></li>
                            <li id="menu-item-6740" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-6740"><a href="https://fosstodon.org/@micronaut"><i class="fab fa-mastodon"><span class="sr-only">Mastodon</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://discord.gg/9xRFsHv98T"><i class="fab fa-discord"><span class="sr-only">Discord</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://github.com/micronaut-projects/"><i class="fab fa-github"><span class="sr-only">GitHub</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.youtube.com/@MicronautFramework"><i class="fab fa-youtube"><span class="sr-only">YouTube</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.linkedin.com/showcase/micronaut"><i class="fab fa-linkedin"><span class="sr-only">LinkedIn</span></i></a></li>
                            <li class="menu-item menu-item-type-custom menu-item-object-custom"><a href="https://www.twitch.tv/micronautfw"><i class="fab fa-twitch"><span class="sr-only">Twitch</span></i></a></li>
                        </ul>
                    </div>
                </div>
                <div id="text-5" class="widget widget_text">
                    <div class="textwidget">
                        <p>
                            <small>Guides are licensed under <a href="https://creativecommons.org/licenses/by/4.0/deed.en">CC BY 4.0</a> for the writing/media and <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache.2.0</a> for the code</small>
                        </p>
                    </div>
                </div>

            </div>
        </div>
    </div>
</footer>
</body>
</html>
